<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="æœ¯è¯­ host clusterï¼švirtual cluster ä¸­çš„å®¿ä¸» k8s é›†ç¾¤ï¼Œæ‰¿è½½äº†æ‰€æœ‰çš„è®¡ç®—èµ„æºã€‚ä¹Ÿä¼šè¢«å«åš super clusterã€‚ virtual clusterï¼švirtual cluster ä¸­çš„ç§Ÿæˆ· k8s é›†ç¾¤ï¼Œé€šå¸¸ç®€å†™ vcã€‚ä¹Ÿä¼šè¢«å«åš tenant clusterã€‚ vClusterï¼šk8s virtual cluster çš„å®ç°ä¹‹ä¸€ï¼Œå³æœ¬æ–‡ä¸­è¦ä»‹ç»çš„æ–¹æ¡ˆã€‚ é¡¹ç›®ç®€ä»‹ k8s çš„å¤šç§ŸåŠŸèƒ½ k8s è‡ªèº«åœ¨å¤šç§Ÿçš„èƒ½åŠ›ä¸Šæ”¯æŒè¾ƒå·®ï¼Œæä¾›äº† namespace çº§åˆ«çš„éš”ç¦»ï¼Œä¸åŒçš„ç§Ÿæˆ·ä½¿ç”¨ä¸åŒçš„ namespaceï¼Œä½†è¯¥éš”ç¦»åŠŸèƒ½è¾ƒå¼±ã€‚å¾ˆå¤šç»„ä»¶éƒ¨ç½²åœ¨åŒä¸€ä¸ª workload ä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š\n"><title>k8s virtual cluster æ–¹æ¡ˆ - vCluster</title><link rel=canonical href=/post/k8s-virtual-cluster-%E6%96%B9%E6%A1%88-vcluster/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="k8s virtual cluster æ–¹æ¡ˆ - vCluster"><meta property='og:description' content="æœ¯è¯­ host clusterï¼švirtual cluster ä¸­çš„å®¿ä¸» k8s é›†ç¾¤ï¼Œæ‰¿è½½äº†æ‰€æœ‰çš„è®¡ç®—èµ„æºã€‚ä¹Ÿä¼šè¢«å«åš super clusterã€‚ virtual clusterï¼švirtual cluster ä¸­çš„ç§Ÿæˆ· k8s é›†ç¾¤ï¼Œé€šå¸¸ç®€å†™ vcã€‚ä¹Ÿä¼šè¢«å«åš tenant clusterã€‚ vClusterï¼šk8s virtual cluster çš„å®ç°ä¹‹ä¸€ï¼Œå³æœ¬æ–‡ä¸­è¦ä»‹ç»çš„æ–¹æ¡ˆã€‚ é¡¹ç›®ç®€ä»‹ k8s çš„å¤šç§ŸåŠŸèƒ½ k8s è‡ªèº«åœ¨å¤šç§Ÿçš„èƒ½åŠ›ä¸Šæ”¯æŒè¾ƒå·®ï¼Œæä¾›äº† namespace çº§åˆ«çš„éš”ç¦»ï¼Œä¸åŒçš„ç§Ÿæˆ·ä½¿ç”¨ä¸åŒçš„ namespaceï¼Œä½†è¯¥éš”ç¦»åŠŸèƒ½è¾ƒå¼±ã€‚å¾ˆå¤šç»„ä»¶éƒ¨ç½²åœ¨åŒä¸€ä¸ª workload ä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š\n"><meta property='og:url' content='/post/k8s-virtual-cluster-%E6%96%B9%E6%A1%88-vcluster/'><meta property='og:site_name' content='404é¢‘é“'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-11-29T20:23:05+00:00'><meta property='article:modified_time' content='2023-11-29T20:23:05+00:00'><meta name=twitter:title content="k8s virtual cluster æ–¹æ¡ˆ - vCluster"><meta name=twitter:description content="æœ¯è¯­ host clusterï¼švirtual cluster ä¸­çš„å®¿ä¸» k8s é›†ç¾¤ï¼Œæ‰¿è½½äº†æ‰€æœ‰çš„è®¡ç®—èµ„æºã€‚ä¹Ÿä¼šè¢«å«åš super clusterã€‚ virtual clusterï¼švirtual cluster ä¸­çš„ç§Ÿæˆ· k8s é›†ç¾¤ï¼Œé€šå¸¸ç®€å†™ vcã€‚ä¹Ÿä¼šè¢«å«åš tenant clusterã€‚ vClusterï¼šk8s virtual cluster çš„å®ç°ä¹‹ä¸€ï¼Œå³æœ¬æ–‡ä¸­è¦ä»‹ç»çš„æ–¹æ¡ˆã€‚ é¡¹ç›®ç®€ä»‹ k8s çš„å¤šç§ŸåŠŸèƒ½ k8s è‡ªèº«åœ¨å¤šç§Ÿçš„èƒ½åŠ›ä¸Šæ”¯æŒè¾ƒå·®ï¼Œæä¾›äº† namespace çº§åˆ«çš„éš”ç¦»ï¼Œä¸åŒçš„ç§Ÿæˆ·ä½¿ç”¨ä¸åŒçš„ namespaceï¼Œä½†è¯¥éš”ç¦»åŠŸèƒ½è¾ƒå¼±ã€‚å¾ˆå¤šç»„ä»¶éƒ¨ç½²åœ¨åŒä¸€ä¸ª workload ä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š\n"><link rel="shortcut icon" href=/images/avatar.jpeg></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_16fb6c03614f4da2.jpeg width=300 height=280 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ“¡</span></figure><div class=site-meta><h1 class=site-name><a href=/>404é¢‘é“</a></h1><h2 class=site-description>å­¦ä¹ ç¬”è®°</h2></div></header><ol class=menu-social><li><a href=https://github.com/kuring target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#k8s-çš„å¤šç§ŸåŠŸèƒ½>k8s çš„å¤šç§ŸåŠŸèƒ½</a></li><li><a href=#vcluster-ä»‹ç»>vCluster ä»‹ç»</a></li></ol><ol><li><a href=#k8s-é›†ç¾¤å‡†å¤‡>k8s é›†ç¾¤å‡†å¤‡</a></li><li><a href=#å®‰è£…-vcluster>å®‰è£… vcluster</a></li><li><a href=#éªŒè¯-service>éªŒè¯ service</a></li><li><a href=#éªŒè¯-ingress>éªŒè¯ Ingress</a></li><li><a href=#é”€æ¯>é”€æ¯</a></li></ol><ol><li><a href=#ç»„ä»¶>ç»„ä»¶</a><ol><li><a href=#controller-plane>controller plane</a></li><li><a href=#syncer>syncer</a><ol><li><a href=#k8s-node-åŒæ­¥>k8s node åŒæ­¥</a></li></ol></li></ol></li><li><a href=#pod-è°ƒåº¦>pod è°ƒåº¦</a></li><li><a href=#ç½‘ç»œ>ç½‘ç»œ</a><ol><li><a href=#service-ç½‘ç»œ>Service ç½‘ç»œ</a></li><li><a href=#ingress-ç½‘ç»œ>Ingress ç½‘ç»œ</a></li><li><a href=#dns-è§£æ>DNS è§£æ</a></li><li><a href=#networkpolicy>NetworkPolicy</a></li></ol></li><li><a href=#å­˜å‚¨>å­˜å‚¨</a></li><li><a href=#å¯è§‚æµ‹æ€§>å¯è§‚æµ‹æ€§</a><ol><li><a href=#monitoring>monitoring</a></li><li><a href=#logging>logging</a></li></ol></li><li><a href=#å®‰å…¨>å®‰å…¨</a><ol><li><a href=#éš”ç¦»æ¨¡å¼>éš”ç¦»æ¨¡å¼</a></li></ol></li><li><a href=#virtual-cluster-é›†ç¾¤çš„åˆ›å»º>virtual cluster é›†ç¾¤çš„åˆ›å»º</a></li><li><a href=#virtual-cluster-é›†ç¾¤å¯¹å¤–æš´éœ²æ–¹æ³•>virtual cluster é›†ç¾¤å¯¹å¤–æš´éœ²æ–¹æ³•</a><ol><li><a href=#è·å–-kubeconfig>è·å– kubeconfig</a><ol><li><a href=#vcluster-connect-å‘½ä»¤>vcluster connect å‘½ä»¤</a></li><li><a href=#host-cluster-secret-ä¸­è·å–åˆ°-kubeconfig>host cluster secret ä¸­è·å–åˆ° kubeconfig</a></li></ol></li><li><a href=#vc-é›†ç¾¤ä¸­çš„-apiserver-çš„æš´éœ²åœ°å€>vc é›†ç¾¤ä¸­çš„ apiserver çš„æš´éœ²åœ°å€</a></li></ol></li><li><a href=#é«˜å¯ç”¨è®¾è®¡>é«˜å¯ç”¨è®¾è®¡</a><ol><li><a href=#control-plane-é«˜å¯ç”¨>control plane é«˜å¯ç”¨</a></li><li><a href=#å¤‡ä»½ä¸æ¢å¤>å¤‡ä»½ä¸æ¢å¤</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/k8s-virtual-cluster-%E6%96%B9%E6%A1%88-vcluster/>k8s virtual cluster æ–¹æ¡ˆ - vCluster</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2023-11-29T20:23:05Z>2023-11-29</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 11 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=æœ¯è¯­>æœ¯è¯­</h1><ul><li>host clusterï¼švirtual cluster ä¸­çš„å®¿ä¸» k8s é›†ç¾¤ï¼Œæ‰¿è½½äº†æ‰€æœ‰çš„è®¡ç®—èµ„æºã€‚ä¹Ÿä¼šè¢«å«åš super clusterã€‚</li><li>virtual clusterï¼švirtual cluster ä¸­çš„ç§Ÿæˆ· k8s é›†ç¾¤ï¼Œé€šå¸¸ç®€å†™ vcã€‚ä¹Ÿä¼šè¢«å«åš tenant clusterã€‚</li><li>vClusterï¼šk8s virtual cluster çš„å®ç°ä¹‹ä¸€ï¼Œå³æœ¬æ–‡ä¸­è¦ä»‹ç»çš„æ–¹æ¡ˆã€‚</li></ul><h1 id=é¡¹ç›®ç®€ä»‹>é¡¹ç›®ç®€ä»‹</h1><h2 id=k8s-çš„å¤šç§ŸåŠŸèƒ½>k8s çš„å¤šç§ŸåŠŸèƒ½</h2><p><img src=https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-compare.png loading=lazy alt=image.png>
k8s è‡ªèº«åœ¨å¤šç§Ÿçš„èƒ½åŠ›ä¸Šæ”¯æŒè¾ƒå·®ï¼Œæä¾›äº† namespace çº§åˆ«çš„éš”ç¦»ï¼Œä¸åŒçš„ç§Ÿæˆ·ä½¿ç”¨ä¸åŒçš„ namespaceï¼Œä½†è¯¥éš”ç¦»åŠŸèƒ½è¾ƒå¼±ã€‚å¾ˆå¤šç»„ä»¶éƒ¨ç½²åœ¨åŒä¸€ä¸ª workload ä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š</p><ol><li>ä½¿ç”¨å…¨å±€å¯¹è±¡å­˜åœ¨å†²çªï¼Œæ¯”å¦‚ CRDã€‚</li><li>å­˜åœ¨è¯¸å¤šå®‰å…¨æ€§é—®é¢˜ï¼Œæ¯”å¦‚å¤šä¸ªç§Ÿæˆ·ä¹‹é—´çš„ pod å®Œå…¨å¯ä»¥äº’è®¿ï¼Œæ²¡æœ‰ä»»ä½•éš”ç¦»æœºåˆ¶ã€‚</li><li>ä¸åŒç»„ä»¶å¯¹äº k8s çš„ç‰ˆæœ¬ä¸ç»Ÿä¸€ã€‚</li></ol><p>ä¸ºäº†è§£å†³å¤šç§Ÿçš„é—®é¢˜ï¼Œæœ€ç®€å•çš„æ€è·¯å°±æ˜¯ä½¿ç”¨å¤š k8s é›†ç¾¤ï¼Œä¸šç•Œçš„ KubeFed v2ã€karmadaã€clusternetã€OCM ç­‰å‡ä¸ºå¤š k8s é›†ç¾¤çš„å®ç°ã€‚ä½†å¤š k8s é›†ç¾¤å› ä¸ºå­˜åœ¨ç‹¬ç«‹çš„æ§åˆ¶é¢å’Œè®¡ç®—èµ„æºï¼Œå­˜åœ¨èµ„æºæ¶ˆè€—è¿‡å¤šçš„é—®é¢˜ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªä¸­é—´æ€è·¯ä¸ºä»…åš k8s çš„æ§åˆ¶é¢éš”ç¦»ï¼Œè®¡ç®—èµ„æºä»ç„¶å…±äº«ï¼Œå³ pod ä¹Ÿå¯ä»¥è§£å†³å¾ˆå¤šçš„å¤šç§Ÿéš”ç¦»é—®é¢˜ã€‚k8s çš„æ§åˆ¶é¢éš”ç¦»åˆå­˜åœ¨ä¸¤ä¸ªä¸»è¦æ–¹æ¡ˆï¼š</p><ol><li>ç‹¬ç«‹çš„ kube-apiserver å’Œ etcdã€kube-controller-managerï¼Œ kube-scheduler å…±äº« host clusterã€‚è¯¥æ–¹æ¡ˆä¸­æœ‰ç‹¬ç«‹çš„ kube-apiserver ç»„ä»¶ï¼Œè¿™é‡Œçš„ etcd å¯ä»¥è¢« sqlliteã€mysql ç­‰å­˜å‚¨å–ä»£ã€‚è¯¥æ–¹æ¡ˆç»Ÿç§°ä¸º virtual clusterï¼Œç®€ç§°ä¸º vcã€‚</li><li>ç‹¬ç«‹çš„ proxy apiserverï¼Œkube-apiserverã€kube-controller-managerã€kube-scheduler å…±äº« host clusterã€‚è®¿é—® k8s çš„è¯·æ±‚å…ˆåˆ° proxy apiserverï¼Œproxy apiserver è½¬å‘åˆ° host cluster çš„ kube-apiserverã€‚å¯ä»¥åœ¨ proxy apiserver ä¸­æä¾›ç‹¬ç«‹çš„ RBAC æœºåˆ¶ï¼Œå®ç°ä¸€å®šç¨‹åº¦çš„éš”ç¦»ã€‚è¯¥æ–¹æ¡ˆåœ¨å¼€æºä¸­æœªçœ‹åˆ°å…·ä½“çš„å®ç°ã€‚</li></ol><h2 id=vcluster-ä»‹ç»>vCluster ä»‹ç»</h2><p><a class=link href=https://github.com/loft-sh/vcluster target=_blank rel=noopener>vCluster</a> ä¸º virtual cluster çš„å¼€æºå®ç°ä¹‹ä¸€ï¼Œç”± Loft Labs æä¾›ï¼ŒGithub Star 3.7Kï¼Œä»£ç è¡Œæ•° 4 ä¸‡è¡Œã€‚é™¤äº†å¼€æºç‰ˆæœ¬å¤–ï¼Œè¿˜æä¾›äº†å•†ä¸šç‰ˆæœ¬ vCluster PROã€‚</p><p>vCluster è®¾è®¡åŸåˆ™ï¼š</p><ol><li>æœ€å°åŒ–èµ„æºå ç”¨ã€‚åœ¨å®ç°ä¸Šä½¿ç”¨äº†å• pod çš„ k3s ä½œä¸º k8s çš„æ§åˆ¶é¢ã€‚</li><li>å¤ç”¨ host cluster çš„è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºã€‚</li><li>é™ä½å¯¹ host cluster çš„è¯·æ±‚ã€‚</li><li>ç®€å•çµæ´»ã€‚</li><li>ä¸éœ€è¦ host cluster çš„ç®¡ç†å‘˜æƒé™ã€‚</li><li>vCluster å¤šä¸ª namespace ä¸‹çš„å¯¹è±¡æ˜ å°„åˆ° host cluster çš„åŒä¸€ä¸ª namespace ä¸‹ã€‚åŒæ—¶ä¹Ÿå¯ä»¥æ”¯æŒ vCluster çš„ä¸€ä¸ª namespace å¯¹åº” host cluster çš„ä¸€ä¸ª namespaceã€‚</li><li>æ˜“æ¸…ç†ã€‚</li></ol><h1 id=getting-started>Getting Started</h1><h2 id=k8s-é›†ç¾¤å‡†å¤‡>k8s é›†ç¾¤å‡†å¤‡</h2><p>k8s é›†ç¾¤è¿™é‡Œä½¿ç”¨äº† kind æ–¹æ¡ˆï¼Œkind é…ç½® kind.conf å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kind.x-k8s.io/v1alpha4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># å¦‚æœéœ€è¦ ingressï¼Œåˆ™éœ€è¦æŒ‡å®šè¯¥å‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubeadmConfigPatches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    kind: InitConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>    nodeRegistration:
</span></span></span><span class=line><span class=cl><span class=sd>      kubeletExtraArgs:
</span></span></span><span class=line><span class=cl><span class=sd>        node-labels: &#34;ingress-ready=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extraPortMappings</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPort</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># æŒ‡å®š k8s ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸æŒ‡å®š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># image: kindest/node:v1.23.17</span><span class=w>
</span></span></span><span class=line><span class=cl>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>worker</span><span class=w>
</span></span></span><span class=line><span class=cl>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>worker</span><span class=w>
</span></span></span><span class=line><span class=cl>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>worker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiServerPort</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ <code>kind create cluster --config kind.conf</code> å³å¯åˆ›å»º k8s é›†ç¾¤ï¼ŒåŒ…å«äº†ä¸€ä¸ª control-plane èŠ‚ç‚¹ï¼Œä¸‰ä¸ª worker èŠ‚ç‚¹ã€‚</p><h2 id=å®‰è£…-vcluster>å®‰è£… vcluster</h2><p>vCluster æä¾›äº†ä½¿ç”¨ vcluster cliã€helm å’Œ kubectl ä¸‰ç§å®‰è£…æ–¹å¼ï¼Œä½¿ç”¨ vcluster cli æœ€ä¸ºç®€å•ï¼Œå…¶åº•å±‚åŒæ ·é‡‡ç”¨ helm chart çš„æ–¹å¼éƒ¨ç½²ï¼Œä¸‹é¢é‡‡ç”¨ vcluster cli çš„æ–¹å¼è¿›è¡Œå®‰è£…ã€‚
å®‰è£… vcluster cli å·¥å…·ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>curl -L -o vcluster &#34;https://github.com/loft-sh/vcluster/releases/latest/download/vcluster-darwin-arm64&#34; &amp;&amp; sudo install -c -m 0755 vcluster /usr/local/bin &amp;&amp; rm -f vcluster</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ–è€…æ‰§è¡Œ <code>brew install vcluster</code>å®‰è£… vcluster å‘½ä»¤è¡Œå·¥å…·ã€‚</p><p>æ‰§è¡Œå‘½ä»¤ <code>vcluster create my-vcluster</code> åˆ›å»º virtual clusterã€‚ä¼šåœ¨ host cluster ä¸Šåˆ›å»º namespace <code>vcluster-my-vcluster</code>ï¼Œè¯¥ namespace ä¸‹åˆ›å»ºå¦‚ä¸‹å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get all -n vcluster-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                                                       READY   STATUS    RESTARTS        AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>pod/coredns-68559449b6-l5whx-x-kube-system-x-my-vcluster   1/1     Running   2 (5m45s ago)   3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>pod/my-vcluster-0                                          1/1     Running   2 (5m45s ago)   3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                                              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                         AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>service/kube-dns-x-kube-system-x-my-vcluster      ClusterIP   10.96.67.119   &lt;none&gt;        53/UDP,53/TCP,9153/TCP          3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>service/my-vcluster                               NodePort    10.96.214.58   &lt;none&gt;        443:30540/TCP,10250:31621/TCP   3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>service/my-vcluster-headless                      ClusterIP   None           &lt;none&gt;        443/TCP                         3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>service/my-vcluster-node-vcluster-control-plane   ClusterIP   10.96.69.115   &lt;none&gt;        10250/TCP                       3d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                           READY   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>statefulset.apps/my-vcluster   1/1     3d</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨è¯¥ namespace ä¸‹åˆ›å»ºäº† coredns å’Œ StatefulSet my-vclusterã€‚æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„ coredns ç»„ä»¶ï¼Œç”¨æ¥åšåŸŸåè§£æã€‚my-vcluster ä¸º vCluster çš„ç®¡æ§é¢ç»„ä»¶ï¼ŒåŒ…æ‹¬äº† k8s controller plane å’Œ syncer ç»„ä»¶ã€‚</p><p>æ‰§è¡Œ <code>vcluster connect my-vcluster</code> åä¼šåœ¨æœ¬åœ°å¯åŠ¨ä»£ç†ï¼Œå¹¶è‡ªåŠ¨åˆ‡æ¢æœ¬åœ°çš„ kubeconfig contextï¼Œå°† context åˆ‡æ¢åˆ° virtual clusterã€‚æ‰§è¡Œ kubectl å‘½ä»¤å³å¯è¿æ¥åˆ°å¯¹åº”çš„ k8s é›†ç¾¤ã€‚virtual cluster é›†ç¾¤ä¸­çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get all -A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAMESPACE     NAME                           READY   STATUS    RESTARTS      AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>kube-system   pod/coredns-68559449b6-jg2bs   1/1     Running   1 (20m ago)   51m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAMESPACE     NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>kube-system   service/kube-dns     ClusterIP   10.96.120.59   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   51m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>default       service/kubernetes   ClusterIP   10.96.35.53    &lt;none&gt;        443/TCP                  51m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAMESPACE     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>kube-system   deployment.apps/coredns   1/1     1            1           51m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAMESPACE     NAME                                 DESIRED   CURRENT   READY   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>kube-system   replicaset.apps/coredns-68559449b6   1         1         1       51m</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ virtual cluster å¯ä»¥çœ‹åˆ°ä»…åŒ…å«äº† coredns ç»„ä»¶ã€‚</p><p>åœ¨ virtual cluster å’Œåœ¨ host cluster ä¸­çš„ node ä¿¡æ¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get node -o wide</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME               STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker3   Ready    &lt;none&gt;   51m   v1.27.3   10.96.118.228   &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.76-linuxkit   containerd://1.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get node -o wide --context kind-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                     STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-control-plane   Ready    control-plane   86m   v1.27.3   172.19.0.3    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.76-linuxkit   containerd://1.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker          Ready    &lt;none&gt;          85m   v1.27.3   172.19.0.2    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.76-linuxkit   containerd://1.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker2         Ready    &lt;none&gt;          85m   v1.27.3   172.19.0.5    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.76-linuxkit   containerd://1.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker3         Ready    &lt;none&gt;          85m   v1.27.3   172.19.0.4    &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.76-linuxkit   containerd://1.7.1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°åœ¨ virtual cluster å’Œ host cluster ä¸­çš„ node åå­—ç›¸åŒï¼Œè¿™æ˜¯å› ä¸º node åœ¨ vCluster ä¸­å¹¶æ²¡æœ‰åšéš”ç¦»ï¼Œè€Œæ˜¯ä» host cluster ä¸­åšäº†åŒæ­¥ã€‚ä½† virtual cluster ä¸­çš„ node èŠ‚ç‚¹ä»…åŒ…å« pod åœ¨ host cluster ä¸­å·²ç»ä½¿ç”¨çš„ node èŠ‚ç‚¹ï¼Œæœªä½¿ç”¨çš„èŠ‚ç‚¹å¹¶ä¸ä¼šåœ¨ virtual cluster ä¸Šã€‚
åŒæ—¶å¯ä»¥çœ‹åˆ° vc å’Œ host cluster ä¸­çš„ node ip åœ°å€å¹¶ä¸ç›¸åŒï¼Œvc ä¸­çš„ node ip åœ°å€è·Ÿ host cluster ä¸­çš„å¯¹åº” service clusterip ç›¸åŒï¼Œåœ¨ host cluster ä¸­çš„å¯¹åº” service åå­—ä¸º <code>$vClusterName-node-$hostClusterNodeName</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get svc --context kind-vcluster -n vcluster-my-vcluster my-vcluster-node-vcluster-worker3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>my-vcluster-node-vcluster-worker3   ClusterIP   10.96.118.228   &lt;none&gt;        10250/TCP   3h54m</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ virtual cluster ä¸­åˆ›å»º k8s å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># åœ¨ virtual cluster åˆ›å»º namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl create ns demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>namespace/demo-nginx created</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c># åˆ›å»º Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl create deployment nginx-deployment -n demo-nginx --image=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c># åœ¨ virtual cluster ä¸Šåˆ›å»ºå‡ºäº† pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get pod -n demo-nginx -o wide</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE                     NOMINATED NODE   READINESS GATES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>nginx-deployment-66fb7f764c-dn59g   1/1     Running   0          11m   10.244.0.7   vcluster-control-plane   &lt;none&gt;           &lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c># ç”±äº pod è°ƒåº¦äº† host cluster æ–°èŠ‚ç‚¹ï¼Œåœ¨ virtual cluster ä¸­å¯ä»¥çœ‹åˆ°æ–°çš„ k8s nodeï¼Œk8s node ä¸ºåˆšåˆšåˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME               STATUS   ROLES    AGE     VERSION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker2   Ready    &lt;none&gt;   2m45s   v1.27.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>vcluster-worker3   Ready    &lt;none&gt;   57m     v1.27.3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ host cluster ä¸­çœ‹åˆ°å¦‚ä¸‹å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># åœ¨ host cluster ä¸Šå¹¶æ²¡æœ‰å¯¹åº”çš„ namespace demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get ns --context kind-vcluster demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>Error from server (NotFound)</span><span class=p>:</span><span class=w> </span><span class=l>namespaces &#34;demo-nginx&#34; not found</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c># åœ¨ host cluster ä¸Šå¹¶æ²¡æœ‰å¯¹åº”çš„ deployment nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get deploy -A --context kind-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAMESPACE            NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>ingress-nginx        ingress-nginx-controller   1/1     1            1           90m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>kube-system          coredns                    2/2     2            2           91m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>local-path-storage   local-path-provisioner     1/1     1            1           91m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c># ä½†åœ¨ host cluster ä¸Šå´çœ‹åˆ°äº†å¯¹åº”çš„ podï¼Œä½äº vcluster ç»Ÿä¸€çš„ namespace vcluster-my-vcluster ä¹‹ä¸‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>$ kubectl get pod -n vcluster-my-vcluster --context kind-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME                                                           READY   STATUS    RESTARTS      AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>coredns-68559449b6-jg2bs-x-kube-system-x-my-vcluster           1/1     Running   1 (26m ago)   57m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>my-vcluster-0                                                  1/1     Running   1 (26m ago)   86m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>nginx-deployment-66fb7f764c-sffqt-x-demo-nginx-x-my-vcluster   1/1     Running   0             2m22s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ä»… pod åœ¨ host cluster ä¸­åŒæ­¥å­˜åœ¨ï¼Œè€Œ namespaceã€deployment è¿™äº›å¯¹è±¡ä»…å­˜åœ¨äº virtual cluster ä¸­ã€‚åœ¨ virtual cluster ä¸­åˆ›å»ºçš„å¤šä¸ªä¸åŒ namespace pod ä»…ä¼šå­˜åœ¨äº host cluster çš„åŒä¸€ä¸ª namespace ä¸‹ã€‚</p><h2 id=éªŒè¯-service>éªŒè¯ service</h2><p>åœ¨ virtual cluster ä¸­åˆ›å»º service å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>IPv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilyPolicy</span><span class=p>:</span><span class=w> </span><span class=l>SingleStack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ virtual cluster ä¸­åŒ…å«å¦‚ä¸‹çš„ Service å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get svc -n demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>NAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=l>nginx   ClusterIP   10.96.239.53   &lt;none&gt;        80/TCP    2m11s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ host cluster ä¸­ä¼šåŒæ­¥åˆ›å»ºå¦‚ä¸‹çš„ Service å¯¹è±¡ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-uid</span><span class=p>:</span><span class=w> </span><span class=l>5ab7aa9c-90b6-46f9-a162-9ea9ca9826f3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-28T09:32:22Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/label-my-vcluster-x-a172cedcae</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/label-my-vcluster-x-d9125f8911</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-x-demo-nginx-x-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>vcluster-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ownerReferences</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>463a503e-d889-49a7-94e0-0cba5299dd47</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;12344&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>fc9ea383-996e-471c-9c27-ee1c22fec7a3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=m>10.96.239.53</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>10.96.239.53</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>internalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>IPv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilyPolicy</span><span class=p>:</span><span class=w> </span><span class=l>SingleStack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/label-my-vcluster-x-a172cedcae</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ° host cluster ä¸­çš„ service çš„ ClusterIP è·Ÿ virutal cluster ä¸€è‡´ï¼Œä½† spec.selector å­—æ®µå·²ç»è¢« syncer ä¿®æ”¹ï¼Œä»¥ä¾¿å¯ä»¥åŒ¹é…åˆ°æ­£ç¡®çš„ podã€‚</p><h2 id=éªŒè¯-ingress>éªŒè¯ Ingress</h2><p>é»˜è®¤æƒ…å†µä¸‹ Ingress ä¸ä¼šåŒæ­¥åˆ° host clusterï¼Œéœ€è¦é€šè¿‡å¼€å…³çš„æ–¹å¼å¯åŠ¨ã€‚åˆ›å»ºæ–‡ä»¶ values.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>sync</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingresses</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ‰§è¡Œ <code>vcluster create my-vcluster --upgrade -f values.yaml</code> å³å¯ä¿®æ”¹ç°åœ¨ vcluster é›†ç¾¤é…ç½®ã€‚</p><p>åœ¨ virtual cluster ä¸­åˆ›å»ºå¦‚ä¸‹çš„ Ingress å¯¹è±¡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>nginx.aa.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>ImplementationSpecific</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŸ¥çœ‹ host cluster ä¸­çš„ Ingress ä¿¡æ¯å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl get ingress --context kind-vcluster -n vcluster-my-vcluster -o yaml nginx-x-demo-nginx-x-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/object-uid</span><span class=p>:</span><span class=w> </span><span class=l>4b8034a6-1513-4ccd-b80a-66807d862b4e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-28T10:07:52Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/label-my-vcluster-x-a172cedcae</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/managed-by</span><span class=p>:</span><span class=w> </span><span class=l>my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vcluster.loft.sh/namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-x-demo-nginx-x-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>vcluster-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ownerReferences</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>controller</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>463a503e-d889-49a7-94e0-0cba5299dd47</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;16292&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>1d0de02b-5aad-4858-a8cf-2caa345ca85b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>nginx.aa.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-x-demo-nginx-x-my-vcluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>ImplementationSpecific</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ° Ingress ä¸­å¯¹åº”çš„ Service åå­—å·²ç»ä¿®æ”¹äº† host cluster ä¸­å¯¹åº”çš„ Service åå­—ã€‚</p><h2 id=é”€æ¯>é”€æ¯</h2><p>åœ¨ä½¿ç”¨å®Œæˆåæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯é”€æ¯ virtual clusterï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># åˆ‡æ¢æœ¬åœ°çš„ context</span>
</span></span><span class=line><span class=cl>vcluster disconnect
</span></span><span class=line><span class=cl><span class=c1># åˆ é™¤ vcluster</span>
</span></span><span class=line><span class=cl>vcluster delete my-vcluster
</span></span></code></pre></td></tr></table></div></div><h1 id=æ¶æ„>æ¶æ„</h1><p><img src=https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-arch.png loading=lazy alt=image.png></p><h2 id=ç»„ä»¶>ç»„ä»¶</h2><p>æ•´ä¸ªæ¶æ„ä¸­ï¼Œæœ‰ä¸¤å¤§æ ¸å¿ƒç»„ä»¶ï¼šk8s Control Plane å’Œ syncerã€‚å…¶ä¸­ StatefulSet my-vcluster ä¸­å®¹å™¨ syncerï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨è¯¥å®¹å™¨ä¸­åŒæ—¶å¯åŠ¨äº† k3s å®¹å™¨ä½œä¸º vCluster æ§åˆ¶å¹³é¢å’Œ vCluster çš„ syncer è¿›ç¨‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it --context kind-vcluster -n vcluster-my-vcluster my-vcluster-0 -- ps -ef
</span></span><span class=line><span class=cl>Defaulted container <span class=s2>&#34;syncer&#34;</span> out of: syncer, vcluster <span class=o>(</span>init<span class=o>)</span>
</span></span><span class=line><span class=cl>PID   USER     TIME  COMMAND
</span></span><span class=line><span class=cl>    <span class=m>1</span> root      2:57 /vcluster start --name<span class=o>=</span>my-vcluster --kube-config<span class=o>=</span>/data/k3s
</span></span><span class=line><span class=cl>   <span class=m>17</span> root     18:35 /k3s-binary/k3s server
</span></span><span class=line><span class=cl>   <span class=m>46</span> root      0:00 ps -ef
</span></span></code></pre></td></tr></table></div></div><h3 id=controller-plane>controller plane</h3><p>æ§åˆ¶å¹³é¢é»˜è®¤ä½¿ç”¨ k3sï¼Œå­˜å‚¨ä½¿ç”¨ sqlliteï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ etcdã€mysqlã€postgresqlã€‚k8s å‘è¡Œç‰ˆä¹Ÿå¯ä»¥ä½¿ç”¨ k0sã€Vanillaï¼ˆæ ‡å‡† k8sï¼‰ã€ç¬¬ä¸‰æ–¹é•œåƒç­‰ã€‚æ§åˆ¶å¹³é¢ç”±å¦‚ä¸‹å‡ ä¸ªç»„ä»¶ç»„æˆï¼š</p><ol><li>k8s apiserverã€‚</li><li>æ•°æ®å­˜å‚¨ï¼Œæ¯”å¦‚ sqlliteã€etcd ç­‰ã€‚</li><li>kube-controller-manager</li><li>kube-schedulerï¼šå¯é€‰ç»„ä»¶ï¼Œé»˜è®¤ä½¿ç”¨ host cluster è°ƒåº¦å™¨ã€‚</li></ol><blockquote><p>åœ¨ Pro ç‰ˆæœ¬ä¸­ï¼Œå…è®¸æ§åˆ¶é¢è·Ÿ pod éƒ¨ç½²åœ¨ä¸åŒçš„ host clusterã€‚</p></blockquote><h3 id=syncer>syncer</h3><p>virtual cluster ä¸­å¹¶ä¸åŒ…å«å®é™…çš„è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œsyncer çš„èŒè´£ä¸ºå°†å¯¹è±¡ä» virtual cluster åŒæ­¥åˆ° host clusterï¼Œä¹Ÿæœ‰å°‘éƒ¨åˆ†å¯¹è±¡éœ€è¦ä» host cluster åŒæ­¥åˆ° virtual clusterã€‚
vCluster å°† k8s å¯¹è±¡åˆ’åˆ†ä¸º low level å’Œ high levelï¼Œå…¶ä¸­ high level çš„å¯¹è±¡ä»…å­˜åœ¨äº virtual cluster ä¸­ï¼Œæ¯”å¦‚ Deploymentã€CRD ç­‰å¯¹è±¡ã€‚low level çš„å¯¹è±¡ä¼šé€šè¿‡ syncer æ¨¡å—åŒæ­¥åˆ° host cluster ä¸Šï¼ŒåŒ…æ‹¬ Podã€ConfigMapã€Secret ç­‰ã€‚low level çš„å¯¹è±¡åœ¨ virutal cluster ä¸ºå¤šä¸ª namespaceï¼Œä½†å‡ä¼šæ˜ å°„åˆ° host cluster çš„ä¸€ä¸ª namespace ä¸‹ã€‚å¦å¤–ï¼ŒvCluster ä¹Ÿæ”¯æŒå°† virtual cluster çš„å¤šä¸ª namespace æ˜ å°„åˆ° host cluster çš„å¤šä¸ª namespaceï¼Œè¯¥ç‰¹æ€§ç›®å‰å¤„äº alpha çŠ¶æ€ã€‚
vCluster å¯ä»¥é€šè¿‡<a class=link href=https://www.vcluster.com/docs/syncer/other_resources/config_syntax target=_blank rel=noopener>é…ç½®çš„æ–¹å¼</a>æ¥å®šåˆ¶èµ„æºçš„åŒæ­¥ï¼Œæ›´å¤æ‚çš„åŒæ­¥è§„åˆ™æä¾›äº†<a class=link href=https://www.vcluster.com/docs/advanced-topics/plugins-overview target=_blank rel=noopener>æ’ä»¶æœºåˆ¶</a>å®ç°ã€‚
vCluster é»˜è®¤æ”¯æŒçš„åŒæ­¥èµ„æºåˆ—è¡¨ï¼š<a class=link href=https://www.vcluster.com/docs/syncer/core_resources target=_blank rel=noopener>https://www.vcluster.com/docs/syncer/core_resources</a>ã€‚</p><p>å·²ç»åˆ›å»ºå®Œæˆçš„ syncer é…ç½®ï¼Œå¯ä»¥é€šè¿‡ <code>vcluster create my-vcluster --upgrade -f values.yaml</code> çš„æ–¹å¼ä¿®æ”¹ï¼Œè¯¥å‘½ä»¤ä¼šè°ƒç”¨ helm updateï¼Œhelm update å‘½ä»¤æœ€ç»ˆä¼šä¿®æ”¹ StatefulSet syncer çš„é…ç½®ï¼Œå¹¶è§¦å‘ pod çš„é‡å¯ã€‚</p><h4 id=k8s-node-åŒæ­¥>k8s node åŒæ­¥</h4><p>æ”¯æŒå¤šç§ node çš„åŒæ­¥è¡Œä¸ºï¼Œé€šè¿‡ä¿®æ”¹ syncer çš„å¯åŠ¨å‚æ•°ï¼š</p><ol><li>Fake Nodeï¼šé»˜è®¤è¡Œä¸ºã€‚æ ¹æ® pod ä¸­çš„ spec.nodeName åˆ›å»º Fake Nodeã€‚Fake Node ä¸º syncer æœåŠ¡è‡ªåŠ¨åˆ›å»ºã€‚å¦‚æœæ²¡æœ‰ pod è°ƒåº¦åˆ° Fake Node ä¸Šï¼Œåˆ™ Fake Node ä¼šè‡ªåŠ¨åˆ é™¤ã€‚</li><li>Real Nodeï¼šæ ¹æ® pod ä¸­çš„ spec.nodeName åˆ›å»º Real Nodeï¼ŒReal Node çš„ä¿¡æ¯ä» host cluster åŒæ­¥ã€‚å¦‚æœæ²¡æœ‰ pod è°ƒåº¦åˆ° Real Node ä¸Šï¼Œåˆ™ Real Node ä¼šè‡ªåŠ¨åˆ é™¤ã€‚</li><li>Real Node Allï¼šåŒæ­¥ host cluster çš„æ‰€æœ‰ node åˆ° virtual clusterã€‚å¦‚æœè¦ä½¿ç”¨ DaemonSetï¼Œéœ€è¦ä½¿ç”¨è¯¥æ¨¡å¼ã€‚</li><li>Real Nodes Label Selectorï¼šä»…åŒæ­¥ label selector åŒ¹é…çš„ host node åˆ° virtual cluster ä¸­ã€‚</li><li>Real Nodes + Label Selectorï¼šä»…åŒæ­¥åŒ…å«åœ¨ pod spec.nodeName ä¸” Label selector å¯ä»¥é€‰ä¸­çš„ host cluster node åˆ° virtual cluster ä¸­ã€‚</li></ol><h2 id=pod-è°ƒåº¦>pod è°ƒåº¦</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œvirtual cluster ä¸­çš„ pod è°ƒåº¦ä¼šä½¿ç”¨ host cluster çš„è°ƒåº¦ï¼Œä½†å­˜åœ¨å¦‚ä¸‹çš„é—®é¢˜ï¼š</p><ol><li>åœ¨ virtual cluster node ä¸Šçš„ label å¯¹äº pod è°ƒåº¦ä¸ä¼šç”Ÿæ•ˆã€‚</li><li>draitã€trait å‘½ä»¤å¯¹äº virtual cluster ä¸Šçš„ pod æ²¡æœ‰å½±å“ã€‚</li><li>virtual cluster ä¸­ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨ä¸ç”Ÿæ•ˆã€‚</li></ol><p>åŸºäºä¸Šè¿°é™åˆ¶ï¼ŒvCluster æ”¯æŒå¦‚ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š</p><ol><li>æ”¯æŒåœ¨ virtual cluster ä¸­ä½¿ç”¨ç‹¬ç«‹çš„è°ƒåº¦å™¨ã€‚å¯ä»¥ç»™ virtual cluster ä¸Šçš„ node å¢åŠ æ ‡ç­¾ã€æ±¡ç‚¹ç­‰ä¿¡æ¯ï¼Œpod çš„è°ƒåº¦åœ¨ virtual cluster ä¸­çš„è°ƒåº¦å™¨å®ç°ï¼Œsyncer ç»„ä»¶ä»…å°†å·²ç»è°ƒåº¦å®Œæˆçš„ pod åŒæ­¥åˆ° host clusterã€‚</li><li>ä»ç„¶å¤ç”¨ host cluster è°ƒåº¦å™¨ï¼Œä½†åšäº†éƒ¨åˆ†åŠŸèƒ½çš„å¢å¼ºï¼šåœ¨ syncer æœåŠ¡ä¸­æŒ‡å®šä»…åŒæ­¥éƒ¨åˆ† host node åˆ° virtual cluster ä¸­ï¼Œè¿™æ · pod å°±ä»…ä¼šè°ƒåº¦åˆ° host cluster çš„ç‰¹å®š node ä¸Šã€‚</li></ol><h2 id=ç½‘ç»œ>ç½‘ç»œ</h2><p>virutal cluster ä¸­æ— ç‹¬ç«‹çš„ pod ç½‘ç»œå’Œ service ç½‘ç»œï¼Œå®Œå…¨å¤ç”¨ host cluster çš„ç½‘ç»œã€‚</p><h3 id=service-ç½‘ç»œ>Service ç½‘ç»œ</h3><ol><li>ä¼šä» virtual cluster åŒæ­¥åˆ° host clusterï¼Œä¸¤è€…çš„ clusterip ä¸€è‡´ã€‚</li><li>å…è®¸å°†ä¸€äº› host cluster ä¸­çš„ service åŒæ­¥åˆ° virtual cluster ä¸­ï¼ŒåŒæ—¶æŒ‡å®šservice çš„åå­—ã€‚</li><li>å…è®¸å°† virtual cluster ä¸­çš„ service åŒæ­¥åˆ° host cluster ä¸­ï¼ŒåŒæ—¶æŒ‡å®šservice çš„åå­—ã€‚</li></ol><h3 id=ingress-ç½‘ç»œ>Ingress ç½‘ç»œ</h3><p>å…è®¸å°† virtual cluster ä¸­çš„ Ingress åŒæ­¥åˆ° host clusterï¼Œä»¥ä¾¿å¤ç”¨ host cluster ä¸­çš„ Ingress Controllerã€‚</p><h3 id=dns-è§£æ>DNS è§£æ</h3><p>åœ¨ virtual cluster ä¸­éƒ¨ç½²äº†å•ç‹¬çš„ coredns ç»„ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ vritual cluster ä¸­çš„åŸŸåä»…èƒ½è§£æå†…éƒ¨çš„åŸŸåï¼Œä¸èƒ½è§£æ host cluster ä¸Šçš„åŸŸåã€‚å¯ä»¥é€šè¿‡å¼€å…³çš„æ–¹å¼ï¼Œå°† virtual cluster ä¸­çš„åŸŸåè§£æè½¬å‘åˆ° host cluster çš„ corednsã€‚</p><blockquote><p>åœ¨ PRO ç‰ˆæœ¬ä¸­ï¼Œcoredns ç»„ä»¶å¯ä»¥é›†æˆåˆ° syncer ç»„ä»¶å†…éƒ¨ï¼Œä»¥ä¾¿èŠ‚çœèµ„æºã€‚</p></blockquote><h3 id=networkpolicy>NetworkPolicy</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œvcluster ä¸­ä¼šå¿½ç•¥ virtual cluster ä¸­çš„ NetworkPolicy èµ„æºã€‚å¯ä»¥é€šè¿‡å¼€å…³çš„æ–¹å¼æ‰“å¼€è¯¥é…ç½®ï¼Œå³å¯å°† NetworkPolicy è§„åˆ™åŒæ­¥åˆ° host clusterã€‚</p><h2 id=å­˜å‚¨>å­˜å‚¨</h2><p><img src=https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-pv.png loading=lazy alt=image.png>
é»˜è®¤æƒ…å†µä¸‹ï¼Œhost StorageClass ä¸ä¼šåŒæ­¥åˆ° vcï¼Œå¯ä»¥é€šè¿‡å¼€å…³çš„æ–¹å¼æ‰“å¼€åŒæ­¥ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼Œpv ä¸ä¼šä» vc åŒæ­¥åˆ° host clusterï¼Œå¯ä»¥é€šè¿‡å¼€å…³çš„æ–¹å¼æ‰“å¼€ã€‚</p><h2 id=å¯è§‚æµ‹æ€§>å¯è§‚æµ‹æ€§</h2><h3 id=monitoring>monitoring</h3><p>metrics-server ç”¨æ¥ç›‘æ§ k8s çš„ Deploymentã€StatefulSet ç­‰å¯¹è±¡ï¼Œmetrics-server å¯ä»¥å¤ç”¨ host cluster ä¸­çš„ï¼Œä½†éœ€è¦å¯ç”¨ metrics server proxy åŠŸèƒ½ã€‚ä¹Ÿå¯ä»¥åœ¨ vc ä¸­å•ç‹¬éƒ¨ç½²ä¸€å¥— metrics serverã€‚
åœ¨ vc é›†ç¾¤ä¸­ï¼Œç”±äºæ¯ä¸ª k8s node çš„ ip åœ°å€ä¸º host cluster ä¸­çš„ service clusteripï¼Œåœ¨ vc ä¸­ç½‘ç»œæ˜¯å¯è¾¾çš„ï¼Œå¯ä»¥è·å–åˆ°å¯¹åº”çš„ç›‘æ§ä¿¡æ¯ã€‚</p><h3 id=logging>logging</h3><p>éœ€è¦ç”¨åˆ°Hostpath Mapperç»„ä»¶ï¼Œè¯¥ç»„ä»¶ä¸º DaemonSet çš„å½¢å¼ã€‚åç»­å³å¯ä»¥éƒ¨ç½² loki ç­‰ç»„ä»¶ã€‚</p><h2 id=å®‰å…¨>å®‰å…¨</h2><h3 id=éš”ç¦»æ¨¡å¼>éš”ç¦»æ¨¡å¼</h3><p>åœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š<code>--isolate</code>ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹å¯¹ workload åšäº†å¤šç§é™åˆ¶ã€‚</p><ol><li>å¯¹ vcluster pod çš„ Pod Security åšé™åˆ¶ï¼Œä¸ç¬¦åˆè§„èŒƒçš„ pod ä¸ä¼šåŒæ­¥åˆ° host clusterã€‚</li><li>å¯ä»¥å¯¹ vc ä¸­ pod çš„æ€»èµ„æºé‡åšé™åˆ¶ã€‚</li><li>åœ¨ host cluster ä¸Šé€šè¿‡ NetworkPolicy åšéš”ç¦»ã€‚</li></ol><h2 id=virtual-cluster-é›†ç¾¤çš„åˆ›å»º>virtual cluster é›†ç¾¤çš„åˆ›å»º</h2><p>ç›®å‰ä»…èƒ½é€šè¿‡ vcluster cliã€helm çš„æ–¹å¼æ¥åˆ›å»ºï¼Œåº•å±‚å‡ä¸º helm chart çš„æ–¹å¼æ¥ç®¡ç†ï¼Œç¼ºå°‘æœåŠ¡åŒ–åŠŸèƒ½ã€‚</p><h2 id=virtual-cluster-é›†ç¾¤å¯¹å¤–æš´éœ²æ–¹æ³•>virtual cluster é›†ç¾¤å¯¹å¤–æš´éœ²æ–¹æ³•</h2><h3 id=è·å–-kubeconfig>è·å– kubeconfig</h3><h4 id=vcluster-connect-å‘½ä»¤>vcluster connect å‘½ä»¤</h4><p>è¯¥å‘½ä»¤å¯ä»¥ä¿®æ”¹æœ¬åœ°çš„ kubeconfig æ–‡ä»¶ï¼Œå¹¶å°† context åˆ‡æ¢ä¸º virtual cluster contextã€‚é»˜è®¤ä¸º virutual cluster çš„ç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥æŒ‡å®šä½¿ç”¨ç‰¹å®šçš„ ServiceAccountã€‚</p><h4 id=host-cluster-secret-ä¸­è·å–åˆ°-kubeconfig>host cluster secret ä¸­è·å–åˆ° kubeconfig</h4><p>åœ¨ host cluster ä¸­ï¼Œåœ¨ vc çš„ namespace ä¸‹ï¼Œå­˜åœ¨ä¸€ä¸ªä»¥ <code>vc-</code> å¼€å¤´çš„ Secretï¼Œè¯¥ Secret ä¸­ä¿å­˜äº† kubeconfig å®Œæ•´ä¿¡æ¯ã€‚</p><h3 id=vc-é›†ç¾¤ä¸­çš„-apiserver-çš„æš´éœ²åœ°å€>vc é›†ç¾¤ä¸­çš„ apiserver çš„æš´éœ²åœ°å€</h3><p>å¯ä»¥åœ¨ syncer å¯åŠ¨çš„æ—¶å€™æŒ‡å®šè·å–çš„ kubeconfig ä¸­çš„ endpoint åœ°å€ã€‚endpoint åœ°å€å³ä¸º vc é›†ç¾¤ä¸­çš„ kube-apiserver çš„åœ°å€ï¼Œè¯¥ kube-apiserver çš„åœ°å€å¯ä»¥é€šè¿‡ host cluster ä¸­çš„ Ingressã€LoadBalancer Serviceã€NodePort Service ç­‰æ–¹å¼å¯¹å¤–æš´éœ²ã€‚</p><h2 id=é«˜å¯ç”¨è®¾è®¡>é«˜å¯ç”¨è®¾è®¡</h2><h3 id=control-plane-é«˜å¯ç”¨>control plane é«˜å¯ç”¨</h3><p>k3s å¯ä»¥æ”¯æŒé«˜å¯ç”¨æ¶æ„ï¼Œåœ¨åˆ›å»º vc çš„æ—¶å€™é€šè¿‡æŒ‡å®šçš„å‰¯æœ¬çš„æ–¹å¼æ¥è®¾ç½®é«˜å¯ç”¨ã€‚å…¶ä»–çš„ k8s å‘è¡Œç‰ˆåŒæ ·ç±»ä¼¼çš„å®ç°ã€‚</p><h3 id=å¤‡ä»½ä¸æ¢å¤>å¤‡ä»½ä¸æ¢å¤</h3><p>vCluster æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¯¹äº vc é›†ç¾¤çš„æ•°æ®å¤‡ä»½ä¸æ¢å¤åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é€šç”¨çš„ velero æ–¹å¼å®ç°å¤‡ä»½ä¸æ¢å¤åŠŸèƒ½ã€‚</p><h1 id=æ€»ç»“>æ€»ç»“</h1><p>æœªåšç½‘ç»œéš”ç¦»ï¼Œå®¹å™¨ç½‘ç»œå’Œ service ç½‘ç»œä»ç„¶åœ¨åŒä¸€ä¸ªå¹³é¢ï¼Œè¦æƒ³ç›¸äº’éš”ç¦»ï¼Œå¿…é¡»ä½¿ç”¨ NetworkPolicyã€‚</p><h1 id=å…¶ä»–>å…¶ä»–</h1><ol><li>è·å– helm chart åˆ°æœ¬åœ°</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm repo add lofts https://charts.loft.sh/
</span></span><span class=line><span class=cl>helm fetch lofts/vcluster
</span></span><span class=line><span class=cl><span class=sb>``</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer></footer></article><script src=https://giscus.app/client.js data-repo=kuring/kuring.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=" data-category=Announcements data-category-id=DIC_kwDOEOr4W84CdeTU data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2013 -
2026 kuring</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>