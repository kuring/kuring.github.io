<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ç¬¬ä¸€éé˜…è¯»unpv3åï¼Œå¯¹ä¹¦ä¸­è®²è¿°çš„å†…å®¹æœ‰äº†å¤§ä½“çš„è®¤è¯†ï¼Œä½†å¯¹ä¹¦ä¸­çš„å…·ä½“ç»†èŠ‚åœ°æ–¹å´æ˜¯æ—©å·²å¿˜è®°ã€‚é‡æ–°é˜…è¯»unpv3ï¼Œè¿™æ¬¡ä¸å¸Œæœ›ä»ç„¶æ˜¯é˜…åå³å¿˜ï¼Œäºæ˜¯é€šè¿‡ç¼–å†™ä»£ç çš„æ–¹å¼å¯¹ä¹¦ä¸­çš„ä¾‹å­å’Œæ³¨æ„äº‹é¡¹åŠ æ·±ç†è§£ã€‚\n"><title>UNIXç½‘ç»œç¼–ç¨‹è¯»ä¹¦ç¬”è®°</title><link rel=canonical href=/post/linux_unp/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="UNIXç½‘ç»œç¼–ç¨‹è¯»ä¹¦ç¬”è®°"><meta property='og:description' content="ç¬¬ä¸€éé˜…è¯»unpv3åï¼Œå¯¹ä¹¦ä¸­è®²è¿°çš„å†…å®¹æœ‰äº†å¤§ä½“çš„è®¤è¯†ï¼Œä½†å¯¹ä¹¦ä¸­çš„å…·ä½“ç»†èŠ‚åœ°æ–¹å´æ˜¯æ—©å·²å¿˜è®°ã€‚é‡æ–°é˜…è¯»unpv3ï¼Œè¿™æ¬¡ä¸å¸Œæœ›ä»ç„¶æ˜¯é˜…åå³å¿˜ï¼Œäºæ˜¯é€šè¿‡ç¼–å†™ä»£ç çš„æ–¹å¼å¯¹ä¹¦ä¸­çš„ä¾‹å­å’Œæ³¨æ„äº‹é¡¹åŠ æ·±ç†è§£ã€‚\n"><meta property='og:url' content='/post/linux_unp/'><meta property='og:site_name' content='404é¢‘é“'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='linux è¯»ä¹¦ç¬”è®°'><meta property='article:published_time' content='2014-12-22T00:00:00+00:00'><meta property='article:modified_time' content='2014-12-22T00:00:00+00:00'><meta name=twitter:title content="UNIXç½‘ç»œç¼–ç¨‹è¯»ä¹¦ç¬”è®°"><meta name=twitter:description content="ç¬¬ä¸€éé˜…è¯»unpv3åï¼Œå¯¹ä¹¦ä¸­è®²è¿°çš„å†…å®¹æœ‰äº†å¤§ä½“çš„è®¤è¯†ï¼Œä½†å¯¹ä¹¦ä¸­çš„å…·ä½“ç»†èŠ‚åœ°æ–¹å´æ˜¯æ—©å·²å¿˜è®°ã€‚é‡æ–°é˜…è¯»unpv3ï¼Œè¿™æ¬¡ä¸å¸Œæœ›ä»ç„¶æ˜¯é˜…åå³å¿˜ï¼Œäºæ˜¯é€šè¿‡ç¼–å†™ä»£ç çš„æ–¹å¼å¯¹ä¹¦ä¸­çš„ä¾‹å­å’Œæ³¨æ„äº‹é¡¹åŠ æ·±ç†è§£ã€‚\n"><link rel="shortcut icon" href=/images/avatar.jpeg></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_16fb6c03614f4da2.jpeg width=300 height=280 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ“¡</span></figure><div class=site-meta><h1 class=site-name><a href=/>404é¢‘é“</a></h1><h2 class=site-description>å­¦ä¹ ç¬”è®°</h2></div></header><ol class=menu-social><li><a href=https://github.com/kuring target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äºæˆ‘</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#åœ-ç­‰ç‰ˆæœ¬>åœ-ç­‰ç‰ˆæœ¬</a></li><li><a href=#forkç‰ˆæœ¬>forkç‰ˆæœ¬</a></li><li><a href=#é˜»å¡å¼ioçš„selectç‰ˆæœ¬>é˜»å¡å¼I/Oçš„selectç‰ˆæœ¬</a></li><li><a href=#éé˜»å¡å¼ioçš„selectç‰ˆæœ¬>éé˜»å¡å¼I/Oçš„selectç‰ˆæœ¬</a></li></ol><ol><li><a href=#forkç‰ˆæœ¬-1>forkç‰ˆæœ¬</a></li><li><a href=#selectç‰ˆæœ¬>selectç‰ˆæœ¬</a></li><li><a href=#pollç‰ˆæœ¬>pollç‰ˆæœ¬</a></li><li><a href=#å¤šçº¿ç¨‹ç‰ˆæœ¬>å¤šçº¿ç¨‹ç‰ˆæœ¬</a></li></ol><ol><li><a href=#udpå®¢æˆ·ç«¯ç¨‹åº>UDPå®¢æˆ·ç«¯ç¨‹åº</a></li><li><a href=#udpæœåŠ¡ç«¯ç¨‹åº>UDPæœåŠ¡ç«¯ç¨‹åº</a></li><li><a href=#udpæœåŠ¡ç«¯ä¿¡å·é©±åŠ¨å¼ioç‰ˆæœ¬>UDPæœåŠ¡ç«¯ä¿¡å·é©±åŠ¨å¼I/Oç‰ˆæœ¬</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/linux_unp/>UNIXç½‘ç»œç¼–ç¨‹è¯»ä¹¦ç¬”è®°</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2014-12-22T00:00:00Z>2014-12-22</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 16 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>ç¬¬ä¸€éé˜…è¯»unpv3åï¼Œå¯¹ä¹¦ä¸­è®²è¿°çš„å†…å®¹æœ‰äº†å¤§ä½“çš„è®¤è¯†ï¼Œä½†å¯¹ä¹¦ä¸­çš„å…·ä½“ç»†èŠ‚åœ°æ–¹å´æ˜¯æ—©å·²å¿˜è®°ã€‚é‡æ–°é˜…è¯»unpv3ï¼Œè¿™æ¬¡ä¸å¸Œæœ›ä»ç„¶æ˜¯é˜…åå³å¿˜ï¼Œäºæ˜¯é€šè¿‡ç¼–å†™ä»£ç çš„æ–¹å¼å¯¹ä¹¦ä¸­çš„ä¾‹å­å’Œæ³¨æ„äº‹é¡¹åŠ æ·±ç†è§£ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿå°†ä¹¦ä¸­çš„å¾ˆå¤šç»†èŠ‚é—®é¢˜ç†è§£æ¸…æ¥šå¹¶ä¸”ä¾¿äºè®°å¿†ï¼Œæœ¬æ–‡é‡‡ç”¨äº†ç¼–å†™ä¹¦ä¸­ä»£ç å¹¶è¿è¡Œçš„æ–¹å¼ï¼Œå¹¶å°†ä¹¦ä¸­å®¹æ˜“å‡ºé”™å’Œæ„æƒ³ä¸åˆ°çš„é—®é¢˜è®°åœ¨ä»£ç ä¸­ã€‚</p><p>æœ¬æ–‡çš„ä»£ç å®ä¾‹å¹¶æœªå®Œå…¨æŒ‰ç…§ä¹¦ä¸­çš„ä»£ç å®ä¾‹ï¼Œæœ¬ç€å•ä¸ªæ–‡ä»¶å³èƒ½ç¼–è¯‘é€šè¿‡å¹¶è¿è¡Œçš„åŸåˆ™ï¼Œæœ¬æ–‡å¯¹äºå¾ˆå¤šç³»ç»Ÿè°ƒç”¨å¹¶æœªåšé˜²å¾¡å¼ç¼–ç¨‹å¤„ç†ã€‚é’ˆå¯¹æ¯ä¸ªç‰ˆæœ¬çš„ç¨‹åºä¸­ç¼ºç‚¹å’Œæ³¨æ„äº‹é¡¹åœ¨ä»£ç ä¸­å·²ç»è¿›è¡Œäº†æ ‡æ³¨ã€‚</p><p>é‰´äºé«˜æ€§èƒ½çš„epollæœºåˆ¶å‡ºç°æ¯”è¾ƒæ™šï¼Œæ™šäºunpçš„ç¼–å†™æ—¶é—´ï¼Œä¹¦ä¸­å¹¶æœªåšä»‹ç»ã€‚</p><h1 id=tcpå®¢æˆ·ç«¯ç¨‹åº>TCPå®¢æˆ·ç«¯ç¨‹åº</h1><p>å®¢æˆ·ç«¯å‡½æ•°æ‰§è¡Œæ•ˆç‡æƒ…å†µï¼šselectéé˜»å¡å¼I/Oç‰ˆæœ¬>çº¿ç¨‹åŒ–ç‰ˆæœ¬>forkç‰ˆæœ¬>selecté˜»å¡å¼I/Oç‰ˆæœ¬>åœç­‰ç‰ˆæœ¬ï¼Œåœç­‰ç‰ˆæœ¬çš„æ‰§è¡Œæ•ˆç‡éå¸¸ä½ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®ä½¿ç”¨ã€‚</p><p>å…¶ä¸­pollå’Œselectæœºåˆ¶åŸºæœ¬ç±»ä¼¼ï¼Œä¹¦ä¸­å¹¶æœªç»™å‡ºpollç‰ˆæœ¬ã€‚</p><h2 id=åœ-ç­‰ç‰ˆæœ¬>åœ-ç­‰ç‰ˆæœ¬</h2><p>æœ€å¸¸è§„çš„å®ç°æ€è·¯ï¼Œä½†æ•ˆç‡éå¸¸ä½ï¼Œä¸”å½“ç¨‹åºé˜»å¡åœ¨è¯»å–è¦å‘é€å†…å®¹æ—¶ï¼Œç¨‹åºæ˜¯æ— æ³•æ”¶åˆ°æœåŠ¡ç«¯çš„çŠ¶æ€å˜åŒ–ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * åœ-ç­‰ç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * è¯¥ç‰ˆæœ¬ç¼ºé™·ä¸ºå½“æœåŠ¡ç«¯å‘ç”ŸæŸäº›äº‹ä»¶æ—¶ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä»ç„¶é˜»å¡äºfgetsè°ƒç”¨ä¸­
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE 4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_cli</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>sendline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>recvline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nf>fgets</span><span class=p>(</span><span class=n>sendline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* å½“é˜»å¡åœ¨fgetså‡½æ•°æ—¶å°†æœåŠ¡å™¨è¿›ç¨‹å…³é—­æ—¶è™½ç„¶ç»™å®¢æˆ·ç«¯å‘é€äº†FINä¿¡å·ï¼Œå®¢æˆ·ç«¯å¹¶ä¸ä¼šçŸ¥é“ï¼Œ
</span></span></span><span class=line><span class=cl><span class=cm>		 * æœåŠ¡ç«¯å…³é—­æ—¶ç¬¬ä¸€æ¬¡è°ƒç”¨writeæœåŠ¡å™¨ä¼šè¿”å›RSTï¼Œ
</span></span></span><span class=line><span class=cl><span class=cm>		 * å½“ä¸€ä¸ªè¿›ç¨‹å‘æŸä¸ªæ”¶åˆ°RSTçš„å¥—æ¥å­—æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå†…æ ¸ä¼šå‘è¯¥è¿›ç¨‹å‘é€ä¸€ä¸ªSIGPIPEä¿¡å·
</span></span></span><span class=line><span class=cl><span class=cm>		 * è¯¥é—®é¢˜éœ€è¦ä½¿ç”¨I/Oå¤ç”¨æŠ€æœ¯æ¥è§£å†³ï¼Œæˆ–è€…ä½¿ç”¨forkå¤„ç†çš„æ–¹å¼æ¥è§£å†³
</span></span></span><span class=line><span class=cl><span class=cm>		 * */</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>sendline</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>sendline</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;str_cli: server terminated prematurely</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// å‘æ ‡å‡†è¾“å‡ºå†™å†…å®¹ï¼Œæ—¢å¯ä»¥ä½¿ç”¨writeä¹Ÿå¯ä»¥ä½¿ç”¨fputs
</span></span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// ä½¿ç”¨fputsæ—¶éœ€è¦æ³¨æ„å°†recvlineæ•°ç»„æœ‰æ•ˆå†…å®¹çš„åé¢ä¸€ä½è®¾ç½®ä¸º&#39;\0&#39;
</span></span></span><span class=line><span class=cl><span class=c1>//		recvline[n] = &#39;\0&#39;;
</span></span></span><span class=line><span class=cl><span class=c1>//		fputs(recvline, stdout);
</span></span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span>	<span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage: tcpcli &lt;IPaddress&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å½“ä¸€ä¸ªè¿›ç¨‹å‘æŸä¸ªæ”¶åˆ°RSTçš„å¥—æ¥å­—æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå†…æ ¸ä¼šå‘è¯¥è¿›ç¨‹å‘é€ä¸€ä¸ªSIGPIPEä¿¡å·
</span></span></span><span class=line><span class=cl>	<span class=c1>// æœ€å¥½çš„æ–¹å¼æ˜¯å¿½ç•¥æ­¤ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼Œå¹¶åœ¨ç¨‹åºä¸‹é¢å¤„ç†è¯¥å¼‚å¸¸æƒ…å†µ
</span></span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>str_cli</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=n>sockfd</span><span class=p>);</span>		<span class=cm>/* do it all */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=forkç‰ˆæœ¬>forkç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * é˜»å¡å¼I/Oçš„forkç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE 4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å³ä½¿æœåŠ¡ç«¯å·²ç»é€€å‡ºï¼Œå­è¿›ç¨‹çš„readæ–¹æ³•ä»ç„¶èƒ½å¤Ÿæ„ŸçŸ¥åˆ°å¹¶ä¸”é€€å‡ºwhileå¾ªç¯ï¼Œå¹¶ç»™çˆ¶è¿›ç¨‹å‘é€SIGTERM,çˆ¶è¿›ç¨‹å¯¹è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼ä¸ºé€€å‡º
</span></span></span><span class=line><span class=cl><span class=cm> * ä¼˜ç‚¹ï¼šä»£ç é‡æ¯”è¾ƒå°‘ï¼Œæ¯ä¸ªè¿›ç¨‹åªå¤„ç†2ä¸ªI/Oæµï¼Œä»ä¸€ä¸ªå¤åˆ¶åˆ°å¦ä¸€ä¸ª
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_cli</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>sendline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>recvline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>pid_t</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// child process : server -&gt; stdout
</span></span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>recvline</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=nf>fputs</span><span class=p>(</span><span class=n>recvline</span><span class=p>,</span> <span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>kill</span><span class=p>(</span><span class=nf>getppid</span><span class=p>(),</span> <span class=n>SIGTERM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// parent process : stdin -&gt; server
</span></span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nf>fgets</span><span class=p>(</span><span class=n>sendline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>sendline</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>sendline</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>shutdown</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>SHUT_WR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>pause</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span>	<span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage: tcpcli &lt;IPaddress&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å½“ä¸€ä¸ªè¿›ç¨‹å‘æŸä¸ªæ”¶åˆ°RSTçš„å¥—æ¥å­—æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå†…æ ¸ä¼šå‘è¯¥è¿›ç¨‹å‘é€ä¸€ä¸ªSIGPIPEä¿¡å·
</span></span></span><span class=line><span class=cl>	<span class=c1>// æœ€å¥½çš„æ–¹å¼æ˜¯å¿½ç•¥æ­¤ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼Œå¹¶åœ¨ç¨‹åºä¸‹é¢å¤„ç†è¯¥å¼‚å¸¸æƒ…å†µ
</span></span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;connect error...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>str_cli</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=n>sockfd</span><span class=p>);</span>		<span class=cm>/* do it all */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=é˜»å¡å¼ioçš„selectç‰ˆæœ¬>é˜»å¡å¼I/Oçš„selectç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * é˜»å¡å¼I/Oçš„selectç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE 4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ç¼ºç‚¹ï¼šä½¿ç”¨äº†é˜»å¡å¼I/Oï¼Œå¦‚æœåœ¨å‘å¥—æ¥å­—è°ƒç”¨writeå‘é€ç»™æœåŠ¡å™¨æ—¶ï¼Œå¥—æ¥å­—ç¼“å†²åŒºå·²æ»¡ï¼Œwriteè°ƒç”¨ä¼šé˜»å¡ï¼Œä»è€Œå½±å“äº†åç»­çš„å¥—æ¥å­—ç¼“å†²åŒºçš„è¯»å–
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_cli</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>maxfdp1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fd_set</span> <span class=n>rset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>sendline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>recvline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>stdineof</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;</span> <span class=p>;)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// select
</span></span></span><span class=line><span class=cl>		<span class=nf>FD_SET</span><span class=p>(</span><span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>FD_SET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>maxfdp1</span> <span class=o>=</span> <span class=p>(</span><span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>sockfd</span> <span class=o>?</span> <span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>:</span> <span class=n>sockfd</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>select</span><span class=p>(</span><span class=n>maxfdp1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// socket
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>stdineof</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>else</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;str_cli: server terminated prematurely</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>recvline</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=nf>fputs</span><span class=p>(</span><span class=n>recvline</span><span class=p>,</span> <span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//			write(STDOUT_FILENO, recvline, n);
</span></span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// input
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// æ­¤å¤„ä¸èƒ½ä½¿ç”¨fgetså‡½æ•°ï¼Œè¯¥å‡½æ•°å¸¦æœ‰ç¼“å†²åŒºåŠŸèƒ½ï¼Œselectè·Ÿå¸¦æœ‰ç¼“å†²åŒºçš„cå‡½æ•°æ··åˆä½¿ç”¨æœ‰é—®é¢˜
</span></span></span><span class=line><span class=cl><span class=c1>//			if (fgets(sendline, MAXLINE, fp) == NULL)
</span></span></span><span class=line><span class=cl><span class=c1>//			{
</span></span></span><span class=line><span class=cl><span class=c1>//				return ;
</span></span></span><span class=line><span class=cl><span class=c1>//			}
</span></span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>),</span> <span class=n>sendline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>stdineof</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nf>shutdown</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>SHUT_WR</span><span class=p>);</span>	<span class=c1>// å…³é—­å†™
</span></span></span><span class=line><span class=cl>				<span class=nf>FD_CLR</span><span class=p>(</span><span class=nf>fileno</span><span class=p>(</span><span class=n>fp</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>sendline</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span>	<span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage: tcpcli &lt;IPaddress&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;connect error...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>str_cli</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=n>sockfd</span><span class=p>);</span>		<span class=cm>/* do it all */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=éé˜»å¡å¼ioçš„selectç‰ˆæœ¬>éé˜»å¡å¼I/Oçš„selectç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * éé˜»å¡å¼I/Oçš„selectç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE 4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define max(a,b) ( ((a)&gt;(b)) ? (a):(b) )
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ä¼˜ç‚¹ï¼šé€Ÿåº¦æ˜¯æœ€å¿«çš„ï¼Œå¯ä»¥é˜²æ­¢è¿›ç¨‹åœ¨åšä»»ä½•å·¥ä½œæ—¶å‘ç”Ÿé˜»å¡
</span></span></span><span class=line><span class=cl><span class=cm> * ç¼ºç‚¹ï¼šåŒæ—¶ç®¡ç†4ä¸ªä¸åŒçš„I/Oæµï¼Œæ¯ä¸ªæµéƒ½æ˜¯éé˜»å¡çš„ï¼Œéœ€è¦è€ƒè™‘åˆ°4ä¸ªæµçš„éƒ¨åˆ†è¯»å’Œéƒ¨åˆ†å†™é—®é¢˜ã€‚ç¼–ç é‡æ˜¯æœ€å¤šçš„ï¼Œéœ€è¦å¼•å…¥ç¼“å†²åŒºç®¡ç†æœºåˆ¶ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_cli</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// å°†socketã€æ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºæè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡æ–¹å¼
</span></span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>val</span> <span class=o>=</span> <span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_GETFL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>val</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>val</span> <span class=o>=</span> <span class=nf>fcntl</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>F_GETFL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>val</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>val</span> <span class=o>=</span> <span class=nf>fcntl</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>F_GETFL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>val</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>to</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>fr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>toiptr</span><span class=p>,</span> <span class=o>*</span><span class=n>tooptr</span><span class=p>,</span> <span class=o>*</span><span class=n>friptr</span><span class=p>,</span> <span class=o>*</span><span class=n>froptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>toiptr</span> <span class=o>=</span> <span class=n>tooptr</span> <span class=o>=</span> <span class=n>to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>friptr</span> <span class=o>=</span> <span class=n>froptr</span> <span class=o>=</span> <span class=n>fr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>stdineof</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>maxfdp1</span> <span class=o>=</span> <span class=nf>max</span><span class=p>(</span><span class=nf>max</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>STDOUT_FILENO</span><span class=p>),</span> <span class=n>sockfd</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fd_set</span> <span class=n>rset</span><span class=p>,</span> <span class=n>wset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;</span> <span class=p>;)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>wset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>stdineof</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>toiptr</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>to</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>FD_SET</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>friptr</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>fr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>FD_SET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>tooptr</span> <span class=o>!=</span> <span class=n>toiptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>FD_SET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>froptr</span> <span class=o>!=</span> <span class=n>friptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>FD_SET</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>select</span><span class=p>(</span><span class=n>maxfdp1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>	<span class=c1>// selectå‡½æ•°ä»ç„¶æ˜¯é˜»å¡çš„
</span></span></span><span class=line><span class=cl>		<span class=c1>// æ ‡å‡†è¾“å…¥
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>toiptr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>to</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>]</span> <span class=o>-</span> <span class=n>toiptr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// å¯¹äºéé˜»å¡å¼IOï¼Œå¦‚æœæ“ä½œä¸èƒ½æ»¡è¶³ï¼Œç›¸åº”ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›EWOULDBLOCKé”™è¯¯
</span></span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read error on stdin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;EOF on stdin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>stdineof</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>tooptr</span> <span class=o>==</span> <span class=n>toiptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>shutdown</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>SHUT_WR</span><span class=p>);</span>	<span class=c1>// ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®è¦å‘é€ï¼Œå…³é—­socket
</span></span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;read %d bytes from stdin</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>toiptr</span> <span class=o>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nf>FD_SET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// ä»å¥—æ¥å­—è¯»
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>friptr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>]</span> <span class=o>-</span> <span class=n>friptr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read error on socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;EOF on socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>stdineof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>else</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;server terminated prematurely</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;read %d bytes from socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>friptr</span> <span class=o>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=nf>FD_SET</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// æ ‡å‡†è¾“å‡º
</span></span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=n>friptr</span> <span class=o>-</span> <span class=n>froptr</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>nwritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>nwritten</span> <span class=o>=</span> <span class=nf>write</span><span class=p>(</span><span class=n>STDOUT_FILENO</span><span class=p>,</span> <span class=n>froptr</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write error to stdout</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;wrote %d bytes to stdout</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nwritten</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>froptr</span> <span class=o>+=</span> <span class=n>nwritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>froptr</span> <span class=o>==</span> <span class=n>friptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>froptr</span> <span class=o>=</span> <span class=n>friptr</span> <span class=o>=</span> <span class=n>fr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// å‘socketå†™
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=n>toiptr</span> <span class=o>-</span> <span class=n>tooptr</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>nwritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>nwritten</span> <span class=o>=</span> <span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>tooptr</span><span class=p>,</span> <span class=n>n</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write error to socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;wrote %d bytes to socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nwritten</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>tooptr</span> <span class=o>+=</span> <span class=n>nwritten</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>tooptr</span> <span class=o>==</span> <span class=n>toiptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>toiptr</span> <span class=o>=</span> <span class=n>tooptr</span> <span class=o>=</span> <span class=n>to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=n>stdineof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nf>shutdown</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>SHUT_WR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * connectçš„éé˜»å¡ç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * è¿æ¥å»ºç«‹æˆåŠŸæ—¶ï¼Œæè¿°ç¬¦å˜ä¸ºå¯å†™ï¼›è¿æ¥å»ºç«‹é”™è¯¯æ—¶ï¼Œæè¿°ç¬¦å˜ä¸ºå³å¯è¯»åˆå¯å†™
</span></span></span><span class=line><span class=cl><span class=cm> * ä¼˜ç‚¹ï¼š
</span></span></span><span class=line><span class=cl><span class=cm> * 1ã€é˜»å¡å¼çš„connectè°ƒç”¨ä¼šæ¶ˆè€—CPUæ—¶é—´ï¼Œéé˜»å¡å¼connectå¯ä»¥å……åˆ†åˆ©ç”¨CPUæ—¶é—´ï¼Œåœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­å¯ä»¥å¤„ç†å…¶ä»–å·¥ä½œ
</span></span></span><span class=line><span class=cl><span class=cm> * 2ã€å¯ä»¥åŒæ—¶å»ºç«‹å¤šä¸ªè¿æ¥ï¼Œæµè§ˆå™¨ä¸­ä¼šç”¨åˆ°æ­¤æŠ€æœ¯
</span></span></span><span class=line><span class=cl><span class=cm> * 3ã€é˜»å¡å¼connectçš„å‡½æ•°è¶…æ—¶è¿‡é•¿ï¼Œå¯ä»¥é€šè¿‡è¯¥å‡½æ•°è®¾ç½®è¶…æ—¶æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm> * 4ã€é˜»å¡å¼çš„å¥—æ¥å­—è°ƒç”¨connectæ—¶ï¼Œåœ¨TCPçš„ä¸‰æ¬¡æ¡æ‰‹å®Œæˆä¹‹å‰è¢«æŸäº›ä¿¡å·ä¸­æ–­æ—¶å¹¶ä¸”connectæœªè®¾ç½®å†…æ ¸è‡ªåŠ¨é‡å¯çš„æ ‡å¿—æ—¶ï¼Œconnectå°†è¿”å›EINTRé”™è¯¯
</span></span></span><span class=line><span class=cl><span class=cm> * å½“å†æ¬¡è°ƒç”¨connectç­‰å¾…æœªå®Œæˆçš„è¿æ¥æ—¶å°†ä¼šè¿”å›EADDRINUSEé”™è¯¯
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>connect_nonb</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>saptr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>salen</span><span class=p>,</span> <span class=kt>int</span> <span class=n>nsec</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// å°†å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡çŠ¶æ€
</span></span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_GETFL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>flags</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>error</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>saptr</span><span class=p>,</span> <span class=n>salen</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// è¿æ¥æœªæˆåŠŸå»ºç«‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿”å›EINPROGRESSé”™è¯¯ï¼Œè¡¨ç¤ºæ“ä½œæ­£åœ¨å¤„ç†
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=n>EINPROGRESS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// EINPROGRESSè¡¨ç¤ºè¿æ¥å»ºç«‹å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯å°šæœªå®Œæˆ
</span></span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// å½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨ä¸€å°ä¸»æœºä¸Šæ—¶ä¼šç«‹å³å»ºç«‹è¿æ¥
</span></span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å½“ä»£ç æ‰§è¡Œåˆ°å¦‚ä¸‹è¿‡ç¨‹ä¸­æ—¶ï¼Œconnectæ­£åœ¨å»ºç«‹è¿æ¥ï¼Œå¯ä»¥åœ¨æ­¤ä½ç½®æ‰§è¡Œä¸šåŠ¡ç›¸å…³ä»£ç 
</span></span></span><span class=line><span class=cl>	<span class=c1>// å½“ç„¶çœŸæ­£ä½¿ç”¨æ—¶ï¼Œåœ¨æ­¤ä½ç½®åŠ å…¥å…¶ä»–ä»£ç å¹¶ä¸åˆé€‚ï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µé‡æ–°è°ƒæ•´ä»£ç 
</span></span></span><span class=line><span class=cl>	<span class=c1>// å¯ä»¥å‚ç…§ä¹¦ä¸­çš„webå®¢æˆ·ç¨‹åºä¾‹å­
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>fd_set</span> <span class=n>rset</span><span class=p>,</span> <span class=n>wset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>FD_SET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>wset</span> <span class=o>=</span> <span class=n>rset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>timeval</span> <span class=n>tval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>tval</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=n>nsec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>tval</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>select</span><span class=p>(</span><span class=n>sockfd</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>nsec</span> <span class=o>?</span> <span class=o>&amp;</span><span class=nl>tval</span> <span class=p>:</span> <span class=nb>NULL</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// å‘ç”Ÿè¶…æ—¶
</span></span></span><span class=line><span class=cl>		<span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>errno</span> <span class=o>=</span> <span class=n>ETIMEDOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å½“è¿æ¥å»ºç«‹æˆåŠŸæ—¶sockfdå˜ä¸ºå¯å†™ï¼Œå½“è¿æ¥å»ºç«‹å¤±è´¥æ—¶sockfdå˜ä¸ºå³å¯è¯»åˆå¯å†™
</span></span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>)</span> <span class=o>||</span> <span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>wset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=c1>// éå¯ç§»æ¤æ€§å‡½æ•°ï¼Œè¿æ¥å»ºç«‹æˆåŠŸè¿”å›0ï¼Œè¿æ¥å»ºç«‹å¤±è´¥å°†é”™è¯¯å€¼è¿”å›ç»™error
</span></span></span><span class=line><span class=cl>		<span class=c1>// è¿æ¥å»ºç«‹å¤±è´¥æ—¶ï¼Œæœ‰è¿”å›-1å’Œè¿”å›0çš„æƒ…å†µ
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>getsockopt</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_ERROR</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>error</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// solarisè¿æ¥å»ºç«‹å¤±è´¥è¿”å›-1
</span></span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;select error:sockfd not set&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nl>done</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=c1>// æ¢å¤å¥—æ¥å­—çš„æ–‡ä»¶çŠ¶æ€æ ‡å¿—
</span></span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>errno</span> <span class=o>=</span> <span class=n>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span>	<span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage: tcpcli &lt;IPaddress&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å½“ä¸€ä¸ªè¿›ç¨‹å‘æŸä¸ªæ”¶åˆ°RSTçš„å¥—æ¥å­—æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå†…æ ¸ä¼šå‘è¯¥è¿›ç¨‹å‘é€ä¸€ä¸ªSIGPIPEä¿¡å·
</span></span></span><span class=line><span class=cl>	<span class=c1>// æœ€å¥½çš„æ–¹å¼æ˜¯å¿½ç•¥æ­¤ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼Œå¹¶åœ¨ç¨‹åºä¸‹é¢å¤„ç†è¯¥å¼‚å¸¸æƒ…å†µ
</span></span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//connect(sockfd, (struct sockaddr*)&amp;servaddr, sizeof(servaddr));
</span></span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>connect_nonb</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>),</span> <span class=mi>50</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket connect error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>str_cli</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=n>sockfd</span><span class=p>);</span>		<span class=cm>/* do it all */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=tcpæœåŠ¡ç«¯ç¨‹åº>TCPæœåŠ¡ç«¯ç¨‹åº</h1><p>æœåŠ¡å™¨ç¨‹åºè¦å¤„ç†å¤§é‡å¹¶å‘ï¼Œåœ¨è®¾è®¡æ—¶æ›´è¦æ³¨é‡æ•ˆç‡ã€‚</p><h2 id=forkç‰ˆæœ¬-1>forkç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * forkç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * PPC(Process per Connection)æ¨¡å‹
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>sig_chld</span><span class=p>(</span><span class=kt>int</span> <span class=n>signo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>signo</span> <span class=o>!=</span> <span class=n>SIGIO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>stat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* æ­¤å¤„ä¸å¯ä»¥ä½¿ç”¨waitå‡½æ•°ï¼Œå½“å¤šä¸ªSIGCHLDä¿¡å·åŒæ—¶å‘å‡ºæ—¶ä¼šå› ä¸ºä¿¡å·è¦†ç›–è€Œå‡ºç°åƒµå°¸è¿›ç¨‹çš„æƒ…å†µ
</span></span></span><span class=line><span class=cl><span class=cm>	pid_t pid = wait(&amp;stat);
</span></span></span><span class=line><span class=cl><span class=cm>	printf(&#34;child %d terminated\n&#34;, pid);	// éå¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°ï¼Œæ­¤å¤„ä¸åº”è¯¥è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=cm>	*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* ä½¿ç”¨éé˜»å¡çš„å‚æ•°WNOHANGæ¥å¾ªç¯å¤„ç†ä¿¡å·ï¼Œé¿å…ä¿¡å·ä¸¢å¤±é—®é¢˜ */</span>
</span></span><span class=line><span class=cl>	<span class=kt>pid_t</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>((</span><span class=n>pid</span> <span class=o>=</span> <span class=nf>waitpid</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>stat</span><span class=p>,</span> <span class=n>WNOHANG</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;child %d terminated</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_echo</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>ssize_t</span>	<span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>again</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>errno</span> <span class=o>==</span> <span class=n>EINTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>again</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;str_echo: read error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * forkç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * ç¼ºç‚¹ï¼š
</span></span></span><span class=line><span class=cl><span class=cm> * 		1.forkéœ€è¦å°†çˆ¶è¿›ç¨‹çš„å†…å­˜æ˜ åƒå¤åˆ¶åˆ°å­è¿›ç¨‹ï¼Œå¹¶åœ¨å­è¿›ç¨‹ä¸­å¤åˆ¶æ‰€æœ‰çš„æè¿°ç¬¦ï¼Œå°½ç®¡ç°åœ¨çš„æ“ä½œç³»ç»Ÿå·²ç»éƒ½å®ç°äº†å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä½†æ˜¯è€—æ—¶ä»ç„¶æ¯”è¾ƒå¤š
</span></span></span><span class=line><span class=cl><span class=cm> * 		2.çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´éœ€è¦IPCæœºåˆ¶è¿›è¡Œé€šä¿¡ï¼Œä»å­è¿›ç¨‹è¿”å›ä¿¡æ¯åˆ°çˆ¶è¿›ç¨‹æ¯”è¾ƒéº»çƒ¦
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGCHLD</span><span class=p>,</span> <span class=n>sig_chld</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>listenfd</span><span class=p>,</span> <span class=n>connfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>pid_t</span> <span class=n>childpid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>cliaddr</span><span class=p>,</span> <span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// socket
</span></span></span><span class=line><span class=cl>    <span class=n>listenfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>listenfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// bind
</span></span></span><span class=line><span class=cl>    <span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen
</span></span></span><span class=line><span class=cl>    <span class=c1>// å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•°ä¸º20
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>listen</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;listen error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=p>;</span> <span class=p>;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=kt>socklen_t</span> <span class=n>clilen</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=c1>// å¤„ç†acceptè¢«ä¿¡å·ä¸­æ–­æ—¶è¿”å›EINTRé”™è¯¯
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>connfd</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>clilen</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>==</span> <span class=n>EINTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;accept error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>childpid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=cm>/* child process */</span>
</span></span><span class=line><span class=cl>			<span class=nf>close</span><span class=p>(</span><span class=n>listenfd</span><span class=p>);</span> <span class=cm>/* close listening socket */</span>
</span></span><span class=line><span class=cl>			<span class=nf>str_echo</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span> <span class=cm>/* process the request */</span>
</span></span><span class=line><span class=cl>			<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>close</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span> <span class=cm>/* parent closes connected socket */</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=selectç‰ˆæœ¬>selectç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * selectç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * ç¼ºç‚¹ï¼š
</span></span></span><span class=line><span class=cl><span class=cm> * 		1. æœ‰æœ€å¤§å¹¶å‘æ•°é™åˆ¶ï¼Œä¸€ä¸ªè¿›ç¨‹æœ€å¤šæ‰“å¼€FD_SETSIZEä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ŒFD_SETSIZEå¾€å¾€æ˜¯1024æˆ–2048å­—èŠ‚
</span></span></span><span class=line><span class=cl><span class=cm> * 		2. selectæ¯æ¬¡è°ƒç”¨éƒ½ä¼šçº¿æ€§æ‰«æå…¨éƒ¨çš„FDé›†åˆï¼Œè¿™æ ·æ•ˆç‡å°±ä¼šå‘ˆç°çº¿æ€§ä¸‹é™ï¼ŒæŠŠFD_SETSIZEæ”¹å¤§çš„åæœå°±æ˜¯æ‰€æœ‰FDå¤„ç†éƒ½æ…¢æ…¢æ¥
</span></span></span><span class=line><span class=cl><span class=cm> * 		3. å†…æ ¸/ç”¨æˆ·ç©ºé—´å†…å­˜æ‹·è´é—®é¢˜ï¼Œå†…æ ¸æŠŠFDæ¶ˆæ¯é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´é‡‡å–äº†å†…å­˜æ‹·è´æ–¹æ³•
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/select.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ä½¿ç”¨selectçš„éœ€è¦ç»´æŠ¤clientæ•°ç»„å’Œallsetçš„æè¿°ç¬¦é›†
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>cliaddr</span><span class=p>,</span> <span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// socket
</span></span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>listenfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>listenfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish socket...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// bind
</span></span></span><span class=line><span class=cl>    <span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish bind...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen
</span></span></span><span class=line><span class=cl>    <span class=c1>// å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•°ä¸º20
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>listen</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;listen error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish listening...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>maxfd</span> <span class=o>=</span> <span class=n>listenfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>maxi</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>client</span><span class=p>[</span><span class=n>FD_SETSIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>FD_SETSIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>fd_set</span> <span class=n>allset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>FD_ZERO</span><span class=p>(</span><span class=o>&amp;</span><span class=n>allset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>FD_SET</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>allset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=p>;</span> <span class=p>;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=n>fd_set</span> <span class=n>rset</span> <span class=o>=</span> <span class=n>allset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=kt>int</span> <span class=n>nready</span> <span class=o>=</span> <span class=nf>select</span><span class=p>(</span><span class=n>maxfd</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    	<span class=p>{</span>
</span></span><span class=line><span class=cl>    		<span class=c1>// è®¾ç½®clientæ•°ç»„
</span></span></span><span class=line><span class=cl>    		<span class=kt>socklen_t</span> <span class=n>clilen</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    		<span class=c1>// è°ƒç”¨selectæ—¶æœ‰ä¸ªé—®é¢˜ï¼Œè§ä¹¦ä¸­16.6èŠ‚
</span></span></span><span class=line><span class=cl>    		<span class=c1>// å¦‚æœè°ƒç”¨acceptæ—¶å®¢æˆ·ç«¯å·²ç»å…³é—­è¿æ¥ï¼Œæ­¤æ—¶acceptä¼šé˜»å¡å¹¶ç›´åˆ°æ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥
</span></span></span><span class=line><span class=cl>    		<span class=c1>// ä¸ºäº†è§£å†³è¯¥é—®é¢˜å¯ä»¥å°†å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡å†è°ƒç”¨accept
</span></span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>connfd</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>clilen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;accept one client:%d...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>connfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>FD_SETSIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>connfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nf>FD_SET</span><span class=p>(</span><span class=n>connfd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>allset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>FD_SETSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;too many clients&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>connfd</span> <span class=o>&gt;</span> <span class=n>maxfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>maxfd</span> <span class=o>=</span> <span class=n>connfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=n>maxi</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>maxi</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>nready</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=c1>// æ£€æµ‹æ‰€æœ‰å®¢æˆ·ç«¯çš„æ•°æ®
</span></span></span><span class=line><span class=cl>    	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;=</span><span class=n>maxi</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    	<span class=p>{</span>
</span></span><span class=line><span class=cl>    		<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    		<span class=p>{</span>
</span></span><span class=line><span class=cl>    			<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    		<span class=p>}</span>
</span></span><span class=line><span class=cl>    		<span class=k>if</span> <span class=p>(</span><span class=nf>FD_ISSET</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>rset</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    		<span class=p>{</span>
</span></span><span class=line><span class=cl>    			<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    			<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;start reading form one client...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    			<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>buf</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=nf>close</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    				<span class=nf>FD_CLR</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>allset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    				<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>    			<span class=k>else</span>
</span></span><span class=line><span class=cl>    			<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=nf>write</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>    			<span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>nready</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    			<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>    		<span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=pollç‰ˆæœ¬>pollç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * pollç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * pollç‰ˆæœ¬çš„è§£å†³äº†selectæ–‡ä»¶æè¿°ç¬¦é™åˆ¶é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶å…·å¤‡selectçš„ç¼ºç‚¹ä¸­çš„2å’Œ3
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;poll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stropts.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define OPEN_MAX 1024  </span><span class=c1>// è¯¥å®å·²ç»ä»limit.hä¸­ç§»é™¤ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æè¿°ç¬¦æ•°ç›®
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ä½¿ç”¨selectçš„ç¼ºç‚¹ä¸ºéœ€è¦ç»´æŠ¤clientæ•°ç»„
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>cliaddr</span><span class=p>,</span> <span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// socket
</span></span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>listenfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>listenfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish socket...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// bind
</span></span></span><span class=line><span class=cl>    <span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish bind...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen
</span></span></span><span class=line><span class=cl>    <span class=c1>// å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•°ä¸º20
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>listen</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;listen error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;finish listening...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pollfd</span> <span class=n>client</span><span class=p>[</span><span class=n>OPEN_MAX</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=n>listenfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>events</span> <span class=o>=</span> <span class=n>POLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>OPEN_MAX</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>maxi</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>	<span class=c1>// å½“å‰clientæ­£åœ¨ä½¿ç”¨çš„æœ€å¤§ä¸‹æ ‡
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=p>;</span> <span class=p>;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=kt>int</span> <span class=n>nready</span> <span class=o>=</span> <span class=nf>poll</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>maxi</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>revents</span> <span class=o>&amp;</span> <span class=n>POLLIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    	<span class=p>{</span>
</span></span><span class=line><span class=cl>    		<span class=c1>// è®¾ç½®clientæ•°ç»„
</span></span></span><span class=line><span class=cl>    		<span class=kt>socklen_t</span> <span class=n>clilen</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>connfd</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>clilen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;accept one client:%d...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>connfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>OPEN_MAX</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=n>connfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>OPEN_MAX</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;too many clients&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>events</span> <span class=o>=</span> <span class=n>POLLIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=n>maxi</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>maxi</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>nready</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=c1>// æ£€æµ‹æ‰€æœ‰å®¢æˆ·ç«¯çš„æ•°æ®
</span></span></span><span class=line><span class=cl>    	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;=</span><span class=n>maxi</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    	<span class=p>{</span>
</span></span><span class=line><span class=cl>    		<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    		<span class=p>{</span>
</span></span><span class=line><span class=cl>    			<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    		<span class=p>}</span>
</span></span><span class=line><span class=cl>    		<span class=k>if</span> <span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>revents</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>POLLIN</span> <span class=o>|</span> <span class=n>POLLERR</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    		<span class=p>{</span>
</span></span><span class=line><span class=cl>    			<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    			<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;start reading form one client...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    			<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>==</span> <span class=n>ECONNRESET</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    				<span class=p>{</span>
</span></span><span class=line><span class=cl>    					<span class=nf>close</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    					<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    				<span class=p>}</span>
</span></span><span class=line><span class=cl>    				<span class=k>else</span>
</span></span><span class=line><span class=cl>    				<span class=p>{</span>
</span></span><span class=line><span class=cl>    					<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read client error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    					<span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>    			<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    			<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;client %d close</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    				<span class=nf>close</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    				<span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>    			<span class=k>else</span>
</span></span><span class=line><span class=cl>    			<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=nf>write</span><span class=p>(</span><span class=n>client</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>fd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>    			<span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>nready</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    			<span class=p>{</span>
</span></span><span class=line><span class=cl>    				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    			<span class=p>}</span>
</span></span><span class=line><span class=cl>    		<span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=å¤šçº¿ç¨‹ç‰ˆæœ¬>å¤šçº¿ç¨‹ç‰ˆæœ¬</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span><span class=lnt>99
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å¤šçº¿ç¨‹ç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=cm> * TPC(Thread Per Connection)æ¨¡å‹
</span></span></span><span class=line><span class=cl><span class=cm> * çº¿ç¨‹çš„å¼€é”€è™½ç„¶æ¯”è¿›ç¨‹å°ï¼Œä½†æ˜¯ä»ç„¶æœ‰æ¯”è¾ƒå¤§å¼€é”€ï¼Œå› æ­¤å¹¶å‘æ•°ä¸æ˜¯å¾ˆé«˜
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>str_echo</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>ssize_t</span>	<span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>again</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span> <span class=p>(</span><span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>errno</span> <span class=o>==</span> <span class=n>EINTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>goto</span> <span class=n>again</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;str_echo: read error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>doit</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>pthread_detach</span><span class=p>(</span><span class=nf>pthread_self</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=nf>str_echo</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>close</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;close socket...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>listenfd</span><span class=p>,</span> <span class=n>connfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>cliaddr</span><span class=p>,</span> <span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// socket
</span></span></span><span class=line><span class=cl>    <span class=n>listenfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>listenfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;socket error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// bind
</span></span></span><span class=line><span class=cl>    <span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen
</span></span></span><span class=line><span class=cl>    <span class=c1>// å¥—æ¥å­—æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•°ä¸º20
</span></span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>listen</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=mi>20</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;listen error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=p>;</span> <span class=p>;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=kt>socklen_t</span> <span class=n>clilen</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=c1>// å¤„ç†acceptè¢«ä¿¡å·ä¸­æ–­æ—¶è¿”å›EINTRé”™è¯¯
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>connfd</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>clilen</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>==</span> <span class=n>EINTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;accept error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;receive new client...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>pthread_t</span> <span class=n>tid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tid</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>doit</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>connfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=udp>UDP</h1><p>ç”±äºudpæ¯”è¾ƒç®€å•ï¼Œä¹¦ä¸­å¹¶æœªå°†udpåè®®å½“åšé‡ç‚¹æ¥è®²è§£ã€‚</p><h2 id=udpå®¢æˆ·ç«¯ç¨‹åº>UDPå®¢æˆ·ç«¯ç¨‹åº</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// sendtoã€recvfromæ–¹å¼
</span></span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dg_cli</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>pservaddr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>servlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>sendline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>recvline</span><span class=p>[</span><span class=n>MAXLINE</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>preply_addr</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>servlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nf>fgets</span><span class=p>(</span><span class=n>sendline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>sendto</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>sendline</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>sendline</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=n>pservaddr</span><span class=p>,</span> <span class=n>servlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>servlen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>recvfrom</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>preply_addr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ä¸ºäº†é˜²æ­¢æ¥æ”¶åˆ°å…¶ä»–è¿›ç¨‹çš„æ•°æ®ï¼Œé€šè¿‡æ¡ä»¶åˆ¤æ–­å»é™¤
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>!=</span> <span class=n>servlen</span> <span class=o>||</span> <span class=nf>memcmp</span><span class=p>(</span><span class=n>pservaddr</span><span class=p>,</span> <span class=n>preply_addr</span><span class=p>,</span> <span class=n>len</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;reply from others (!ignore)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>recvline</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>fputs</span><span class=p>(</span><span class=n>recvline</span><span class=p>,</span> <span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// connectã€writeã€readæ–¹å¼
</span></span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dg_cli2</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>pservaddr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>servlen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>sendline</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span> <span class=n>recvline</span><span class=p>[</span><span class=n>MAXLINE</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>connect</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=n>pservaddr</span><span class=p>,</span> <span class=n>servlen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nf>fgets</span><span class=p>(</span><span class=n>sendline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>write</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>sendline</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>sendline</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>recvline</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>recvline</span><span class=p>[</span><span class=n>n</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>fputs</span><span class=p>(</span><span class=n>recvline</span><span class=p>,</span> <span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;usage: tcpcli &lt;IPaddress&gt;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>servaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>inet_pton</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_DGRAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>dg_cli2</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=udpæœåŠ¡ç«¯ç¨‹åº>UDPæœåŠ¡ç«¯ç¨‹åº</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dg_echo</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>pcliaddr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>clilen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=n>mesg</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;;)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>socklen_t</span> <span class=n>len</span> <span class=o>=</span> <span class=n>clilen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=nf>bzero</span><span class=p>(</span><span class=n>mesg</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>=</span> <span class=nf>recvfrom</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>mesg</span><span class=p>,</span> <span class=n>MAXLINE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>  <span class=n>pcliaddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>len</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>close</span><span class=p>(</span><span class=n>sockfd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;recvfrom error, error=%m</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;recv %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mesg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>sendto</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>mesg</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>pcliaddr</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_DGRAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>servaddr</span><span class=p>,</span> <span class=n>cliaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>dg_echo</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=udpæœåŠ¡ç«¯ä¿¡å·é©±åŠ¨å¼ioç‰ˆæœ¬>UDPæœåŠ¡ç«¯ä¿¡å·é©±åŠ¨å¼I/Oç‰ˆæœ¬</h2><p>ä¿¡å·é©±åŠ¨å¼I/Oï¼šè¿›ç¨‹æ‰§è¡ŒI/Oç³»ç»Ÿè°ƒç”¨å‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªI/Oæ“ä½œï¼Œå†…æ ¸å¯åŠ¨I/Oæ“ä½œåç«‹å³è¿”å›åˆ°è¿›ç¨‹ã€‚è¿›ç¨‹åœ¨I/Oæ“ä½œå‘ç”ŸæœŸé—´ç»§ç»­æ‰§è¡Œã€‚å½“æ“ä½œå®Œæˆæˆ–é‡åˆ°é”™è¯¯æ—¶ï¼Œå†…æ ¸ä»¥è¿›ç¨‹åœ¨I/Oç³»ç»Ÿè°ƒç”¨ä¸­æŒ‡å®šçš„æ–¹å¼é€šçŸ¥è¿›ç¨‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * ä¿¡å·é©±åŠ¨å¼I/Oåœ¨TCPå¥—æ¥å­—ç”¨é€”ä¸å¤§ï¼Œè¯¥ä¿¡å·äº§ç”Ÿçš„è¿‡äºé¢‘ç¹ï¼Œå®ƒçš„å‡ºç°å¹¶æœªæŒ‡ç¤ºå‘ç”Ÿçš„äº‹æƒ…
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;netinet/in.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/socket.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;strings.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define SERV_PORT 9877
</span></span></span><span class=line><span class=cl><span class=cp>#define MAXLINE		4096	</span><span class=cm>/* max text line length */</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>sockfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define MAXDG 4096
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>dg_data</span><span class=p>;</span>				<span class=c1>// å®é™…æ•°æ®
</span></span></span><span class=line><span class=cl>	<span class=kt>size_t</span> <span class=n>dg_len</span><span class=p>;</span>				<span class=c1>// å®é™…æ•°æ®é•¿åº¦
</span></span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>dg_sa</span><span class=p>;</span>		<span class=c1>// åŒ…å«å®¢æˆ·ç«¯åœ°å€
</span></span></span><span class=line><span class=cl>	<span class=kt>socklen_t</span> <span class=n>dg_salen</span><span class=p>;</span>			<span class=c1>// å®¢æˆ·ç«¯åœ°å€é•¿åº¦
</span></span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>DG</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define QSIZE 8
</span></span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>DG</span> <span class=n>dg</span><span class=p>[</span><span class=n>QSIZE</span><span class=p>];</span>			<span class=c1>// å­˜æ”¾æ•°æ®çš„ç¯å½¢ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>long</span> <span class=n>cntread</span><span class=p>[</span><span class=n>QSIZE</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1>// éœ€è¦å¤„ç†çš„ä¸‹ä¸€ä¸ªæ•°æ®å…ƒç´ çš„ä¸‹æ ‡
</span></span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>iget</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// å­˜æ”¾æ•°æ®å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®
</span></span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>iput</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>nqueue</span><span class=p>;</span>				<span class=c1>// é˜Ÿåˆ—ä¸­çš„æ•°æ®ä¸ªæ•°
</span></span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>socklen_t</span> <span class=n>clilen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>sig_hup</span><span class=p>(</span><span class=kt>int</span> <span class=n>signo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>QSIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;cntread[%d = %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>cntread</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>sig_io</span><span class=p>(</span><span class=kt>int</span> <span class=n>signo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>nread</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ä¸ºäº†è§£å†³éå®æ—¶ä¿¡å·ä¸æ’é˜Ÿé—®é¢˜ï¼Œé‡‡ç”¨å¾ªç¯è¯»å–æ–¹å¼
</span></span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>nread</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
</span></span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>nread</span> <span class=o>&gt;=</span> <span class=n>QSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;receive overflow</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>DG</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>dg</span><span class=p>[</span><span class=n>iput</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>ptr</span><span class=o>-&gt;</span><span class=n>dg_salen</span> <span class=o>=</span> <span class=n>clilen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>ssize_t</span> <span class=n>len</span> <span class=o>=</span> <span class=nf>recvfrom</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>dg_data</span><span class=p>,</span> <span class=n>MAXDG</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ptr</span><span class=o>-&gt;</span><span class=n>dg_sa</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>dg_salen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>errno</span> <span class=o>==</span> <span class=n>EWOULDBLOCK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;recvfrom error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>ptr</span><span class=o>-&gt;</span><span class=n>dg_len</span> <span class=o>=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>nread</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>nqueue</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>iput</span> <span class=o>&gt;=</span> <span class=n>QSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>iput</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>cntread</span><span class=p>[</span><span class=n>nread</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dg_echo</span><span class=p>(</span><span class=kt>int</span> <span class=n>sockfd_arg</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>pcliaddr</span><span class=p>,</span> <span class=kt>socklen_t</span> <span class=n>clilen_arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>sockfd</span> <span class=o>=</span> <span class=n>sockfd_arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>clilen</span> <span class=o>=</span> <span class=n>clilen_arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>QSIZE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>dg</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>dg_data</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>MAXDG</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>dg</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>dg_sa</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>clilen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>dg</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>dg_salen</span> <span class=o>=</span> <span class=n>clilen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>iget</span> <span class=o>=</span> <span class=n>iput</span> <span class=o>=</span> <span class=n>nqueue</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGHUP</span><span class=p>,</span> <span class=n>sig_hup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åœ¨å¯åŠ¨ä¿¡å·I/Oå‰è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°
</span></span></span><span class=line><span class=cl>	<span class=nf>signal</span><span class=p>(</span><span class=n>SIGIO</span><span class=p>,</span> <span class=n>sig_io</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// è®¾ç½®æ¥æ”¶ä¿¡å·é€šçŸ¥çš„è¿›ç¨‹ï¼Œè®©æœ¬è¿›ç¨‹æ¥æ”¶SIGIOä¿¡å·
</span></span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_SETOWN</span><span class=p>,</span> <span class=nf>getpid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ä¸ºäº†èƒ½å¤Ÿåœ¨å¾—åˆ°I/Oäº‹ä»¶åé‡å¤æ‰§è¡ŒI/Oæ“ä½œï¼Œéœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡æ–¹å¼
</span></span></span><span class=line><span class=cl>	<span class=c1>// O_ASYNCè¡¨ç¤ºåœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šä½¿ç”¨ä¿¡å·é©±åŠ¨I/O
</span></span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_GETFL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>fcntl</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>F_SETFL</span><span class=p>,</span> <span class=n>flags</span> <span class=o>|</span> <span class=n>O_ASYNC</span> <span class=o>|</span> <span class=n>O_NONBLOCK</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>sigset_t</span> <span class=n>zeromask</span><span class=p>,</span> <span class=n>newmask</span><span class=p>,</span> <span class=n>oldmask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>zeromask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>newmask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>oldmask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// è®¾ç½®æ–°çš„ä¿¡å·æ©ç ï¼Œé˜»å¡SIGIOä¿¡å·
</span></span></span><span class=line><span class=cl>	<span class=nf>sigaddset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>newmask</span><span class=p>,</span> <span class=n>SIGIO</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>newmask</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldmask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(;</span> <span class=p>;)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span> <span class=p>(</span><span class=n>nqueue</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// æŒ‚èµ·è¿›ç¨‹ç›´åˆ°æ”¶åˆ°ä»»ä½•ä¿¡å·ï¼Œè¯¥å‡½æ•°è¿”å›åSIGIOç»§ç»­è¢«é˜»å¡
</span></span></span><span class=line><span class=cl>			<span class=nf>sigsuspend</span><span class=p>(</span><span class=o>&amp;</span><span class=n>zeromask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// è§£é™¤SIGIOçš„é˜»å¡
</span></span></span><span class=line><span class=cl>		<span class=nf>sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldmask</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>sendto</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=n>dg</span><span class=p>[</span><span class=n>iget</span><span class=p>].</span><span class=n>dg_data</span><span class=p>,</span> <span class=n>dg</span><span class=p>[</span><span class=n>iget</span><span class=p>].</span><span class=n>dg_len</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dg</span><span class=p>[</span><span class=n>iget</span><span class=p>].</span><span class=n>dg_sa</span><span class=p>,</span> <span class=n>dg</span><span class=p>[</span><span class=n>iget</span><span class=p>].</span><span class=n>dg_salen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>iget</span> <span class=o>&gt;=</span> <span class=n>QSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>iget</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ä¸ºäº†èƒ½å¤Ÿä¿®æ”¹nqueueçš„å€¼ï¼Œé˜»å¡SIGIOä¿¡å·
</span></span></span><span class=line><span class=cl>		<span class=nf>sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>newmask</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>oldmask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>nqueue</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>sockfd</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>SOCK_DGRAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>servaddr</span><span class=p>,</span> <span class=n>cliaddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>bzero</span><span class=p>(</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>servaddr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>SERV_PORT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>bind</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span>  <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>servaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>servaddr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bind error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>dg_echo</span><span class=p>(</span><span class=n>sockfd</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cliaddr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>cliaddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=ç›¸å…³ä¸‹è½½>ç›¸å…³ä¸‹è½½</h1><p>æœ¬æ–‡ä¸­çš„å®ä¾‹ï¼Œä»£ç é‡‡ç”¨eclipse CDTç¼–å†™ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥eclipseä¸­è¿è¡Œã€‚</p><p><a class=link href=http://pan.baidu.com/s/1o6zCNOm target=_blank rel=noopener>ä¸‹è½½å®ä¾‹</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/linux-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>Linux è¯»ä¹¦ç¬”è®°</a></section></footer></article><script src=https://giscus.app/client.js data-repo=kuring/kuring.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=" data-category=Announcements data-category-id=DIC_kwDOEOr4W84CdeTU data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2013 -
2025 kuring</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>