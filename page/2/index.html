<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/2/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">240</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-CSI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-CSI/" class="post-title-link" itemprop="url">k8s CSI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-23 22:56:40" itemprop="dateCreated datePublished" datetime="2023-11-23T22:56:40+00:00">2023-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI</a>：Container Storage Interface (CSI)</p>
<p>Volume 的三个阶段：</p>
<ol>
<li>Provision and Delete：负责卷的创建以及销毁。</li>
<li>Attaching and Detaching：将卷设备挂载到本地或者从本地卸载。</li>
<li>Mount and Umount：将 Attaching 的块设备以目录形式挂载到 pod中，或者从 pod 中卸载块设备。</li>
</ol>
<h1 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h1><p>CSI 插件分为三个部分：</p>
<ol>
<li>CSI Identity：用来获取 CSI 的身份信息</li>
<li>CSI Controller</li>
<li>CSI Node</li>
</ol>
<p>参考 k8s 官方的 hostpath 项目：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/csi-driver-host-path">https://github.com/kubernetes-csi/csi-driver-host-path</a></p>
<p>为了方便开发，在每个阶段 k8s 官方均实现了对应的 SideCarSet 容器。要想研发，仅需要实现 grpc server，又 SideCarSet 容器调用自研的容器。</p>
<p>自研的容器需要实现如下的接口即可。</p>
<h2 id="CSI-Identity"><a href="#CSI-Identity" class="headerlink" title="CSI Identity"></a>CSI Identity</h2><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Identity</span> &#123;</span><br><span class="line">  <span class="comment">// 返回插件名字以及版本号</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginInfo(GetPluginInfoRequest) <span class="keyword">returns</span> (GetPluginInfoResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回插件的包含的功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginCapabilities(GetPluginCapabilitiesRequest) <span class="keyword">returns</span> (GetPluginCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Probe (ProbeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ProbeResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>External provisioner 会调用该接口。</p>
<h2 id="CSI-Controller"><a href="#CSI-Controller" class="headerlink" title="CSI Controller"></a>CSI Controller</h2><p>实现 Volume 中的 Provisioning and Deleting 和 Attaching and Detaching 两个阶段的功能。只有块存储 CSI 插件才需要 Attach 功能。<br>该部分以中心化组件的方式部署，比如 Deployment。Provision 功能对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-provisioner">external-provisioner</a>，Attach 对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-attacher">external-attacher</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Controller</span> &#123;</span><br><span class="line">  <span class="comment">// Provisioning， External provisioner调用</span></span><br><span class="line">  <span class="comment">// hostPath 实现中会调用 fallocate 实现</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateVolume (CreateVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Deleting， External provisioner调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteVolume (DeleteVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Attaching, 只有块设备才需要实现，比如云盘，由External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerPublishVolume (ControllerPublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerPublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Detaching，External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ValidateVolumeCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListVolumes (ListVolumesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListVolumesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetCapacity (GetCapacityRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetCapacityResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetCapabilities (ControllerGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateSnapshot (CreateSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteSnapshot (DeleteSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListSnapshots (ListSnapshotsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListSnapshotsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerExpandVolume (ControllerExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetVolume (ControllerGetVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerModifyVolume (ControllerModifyVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerModifyVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CSI-Node"><a href="#CSI-Node" class="headerlink" title="CSI Node"></a>CSI Node</h2><p>实现 Volume 中的Mount 和 Umount 阶段，由 kubelet 负责调用。<br>该部分以 DaemonSet 的形式部署在每个 k8s node 上，对应的 SidecarSet 容器为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/node-driver-registrar">node-driver-registrer</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="comment">// 针对块存储类型，将块设备格式化后先挂载到一个临时全局目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeStageVolume (NodeStageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeStageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnstageVolume (NodeUnstageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnstageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是块存储设备，在执行完 NodeStageVolume 后，使用 linux 的 bind mount 技术将全局目录挂载到pod 中的对应目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodePublishVolume (NodePublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodePublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnpublishVolume (NodeUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetVolumeStats (NodeGetVolumeStatsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetVolumeStatsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeExpandVolume(NodeExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetCapabilities (NodeGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetInfo (NodeGetInfoRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetInfoResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>协议：<a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/PXE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/PXE/" class="post-title-link" itemprop="url">PXE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-12 20:12:55" itemprop="dateCreated datePublished" datetime="2023-10-12T20:12:55+00:00">2023-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>重装过电脑操作系统的同学大概知道操作系统的安装流程如下：</p>
<ol>
<li>在 BIOS 中将系统设置为光驱&#x2F;USB开机优先模式</li>
<li>以DVD或者 U 盘中的操作系统开机，进入到装机界面</li>
<li>完成一系列的装机初始化，比如磁盘分区、语言选择等</li>
<li>重启进入新安装的操作系统</li>
</ol>
<p>以上过程必须要手工才能完成，安装一台电脑还可以，但如果要大批量安装一批机器就不适用了。为此，Intel 公司研发了 PXE(Pre-boot Execution Environment) 技术，可以通过网络的方式批量安装操作系统。</p>
<p>PXE 基于 C&#x2F;S 架构，分为PXE client 和PXE server，其中 PXE client 为要安装操作系统的机器，PXE server 用来提供安装操作系统必须的镜像等信息。要想实现从网络上安装操作系统，必须要解决如下几个问题：</p>
<ol>
<li>因为还没有安装操作系统，此时并不存在 ip 地址，在装机之前必须要获取到一个 ip 地址。</li>
<li>安装操作系统需要的 boot loader 和操作系统镜像如何获取。</li>
</ol>
<p>为了解决 PXE client 的 ip 地址问题，PXE 中采用了 DHCP 协议来给 client 分配 ip 地址，这就要求 PXE server 必须要运行 dhcp server。为了解决 PXE server 可以提供 boot loader 和操作系统基线，PXE server 通过 tftp 协议的方式对 client 提供服务。</p>
<p>client 端需要 DHCP client 和 tftp client 的功能，为此 PXE 协议中将该功能以硬件的方式内置在网卡 ROM 中。当启动时，BIOS 会加载内置在网卡中的 ROM，从而该机器具备了 DHCP client 和 tftp client 的功能。</p>
<p>优点：</p>
<ol>
<li>规模化：可以批量实现多台服务器的安装</li>
<li>自动化：可以自动化安装</li>
<li>远程实现：不用本地的光盘来安装 OS</li>
</ol>
<p>客户机的前提条件：</p>
<ol>
<li>网络必须要支持 PXE 协议</li>
<li>主板支持网络引导，一般在 BIOS 中可以配置</li>
</ol>
<p>服务端：</p>
<ol>
<li>DHCP 服务，用来给客户机分配 ip 地址</li>
<li>TFTP 服务：用来提供操作系统文件的下载</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/tcp-fast-open/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/tcp-fast-open/" class="post-title-link" itemprop="url">TCP Fast Open</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 23:46:40" itemprop="dateCreated datePublished" datetime="2023-09-30T23:46:40+00:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/tcp_fast_open.webp"></p>
<p>TCP Fast Open（TFO）是一种TCP协议的扩展，旨在加快建立TCP连接的速度和降低延迟。传统的TCP连接需要进行三次握手（SYN-SYN&#x2F;ACK-ACK）才能建立连接，而TFO允许在第一个数据包中携带连接建立的请求。</p>
<p>TFO的工作原理如下：</p>
<ol>
<li>客户端在首次建立TCP连接时，在发送的SYN包中插入一个加密的Cookie。这个Cookie由服务器生成并发送给客户端。</li>
<li>当客户端发送带有TFO Cookie的SYN包到服务器时，服务器会验证Cookie的有效性。</li>
<li>如果Cookie有效，服务器会立即发送带有SYN+ACK标志的数据包，这样客户端就可以立即发送数据而无需等待ACK响应。</li>
<li>客户端收到带有SYN+ACK标志的数据包后，发送带有ACK标志的数据包，建立完整的TCP连接。</li>
</ol>
<h1 id="相关内核参数"><a href="#相关内核参数" class="headerlink" title="相关内核参数"></a>相关内核参数</h1><h2 id="net-ipv4-tcp-fastopen"><a href="#net-ipv4-tcp-fastopen" class="headerlink" title="net.ipv4.tcp_fastopen"></a><code>net.ipv4.tcp_fastopen</code></h2><p>支持如下值：</p>
<ul>
<li>0：关闭</li>
<li>1: 作为客户端可以使用 TFO 功能</li>
<li>2: 作为服务端可以使用 TFO 功能</li>
<li>3: 作为客户端和服务端均可使用 TFO</li>
</ul>
<h2 id="net-ipv4-tcp-fastopen-key"><a href="#net-ipv4-tcp-fastopen-key" class="headerlink" title="net.ipv4.tcp_fastopen_key"></a><code>net.ipv4.tcp_fastopen_key</code></h2><p>用来产生 TFO 的 Cookie。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-service/" class="post-title-link" itemprop="url">k8s 集群内 dns 规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-12 12:05:42" itemprop="dateCreated datePublished" datetime="2023-09-12T12:05:42+00:00">2023-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="zone-设置"><a href="#zone-设置" class="headerlink" title="zone 设置"></a>zone 设置</h1><p>DNS 记录的 zone 信息为全局配置，配置地方包括 kubelet 和 coredns 两部分。</p>
<h2 id="kubelet-的启动参数"><a href="#kubelet-的启动参数" class="headerlink" title="kubelet 的启动参数"></a>kubelet 的启动参数</h2><ol>
<li>通过 kubelet 的 yaml 配置文件的 clusterDomain 字段。</li>
<li>通过 kubelet 的参数 <code>--cluster-domain</code>。</li>
</ol>
<p>设置了 kubelet 的启动参数后，会设置容器的 &#x2F;etc&#x2F;resolv.conf 中的 search 域为如下格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local tbsite.net</span><br><span class="line">nameserver 10.181.48.10</span><br><span class="line">options ndots:5 single-request-reopen</span><br></pre></td></tr></table></figure>

<p>其中 search 域中的 cluster.local 为 kubelet 的配置。</p>
<h2 id="coredns-的配置文件"><a href="#coredns-的配置文件" class="headerlink" title="coredns 的配置文件"></a>coredns 的配置文件</h2><p>coredns controller 需要 watch k8s 集群中的 pod 和 service，将其进行注册，因此 coredns 需要知道集群的 zone 配置。该配置信息位于 coredns 的配置文件 ConfigMap kube-system&#x2F;coredns 中，默认的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Corefile: |</span><br><span class="line">  .:53 &#123;</span><br><span class="line">      errors</span><br><span class="line">      health &#123;</span><br><span class="line">         lameduck 5s</span><br><span class="line">      &#125;</span><br><span class="line">      ready</span><br><span class="line">      kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">         pods insecure</span><br><span class="line">         fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">         ttl 30</span><br><span class="line">      &#125;</span><br><span class="line">      prometheus :9153</span><br><span class="line">      forward . /etc/resolv.conf &#123;</span><br><span class="line">         max_concurrent 1000</span><br><span class="line">      &#125;</span><br><span class="line">      cache 30</span><br><span class="line">      loop</span><br><span class="line">      reload</span><br><span class="line">      loadbalance</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中 cluster.local 为对应的 k8s zone。</p>
<h1 id="域名注册"><a href="#域名注册" class="headerlink" title="域名注册"></a>域名注册</h1><p>在 k8s 中，Service 和 Pod 对象会创建 DNS 记录，用于 k8s 集群内部的域名解析。</p>
<h2 id="Pod-域名注册"><a href="#Pod-域名注册" class="headerlink" title="Pod 域名注册"></a>Pod 域名注册</h2><p>规则一：</p>
<p>每个 k8s pod 都会创建 DNS 记录： <code>&lt;pod_ip&gt;.&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>。其中 <pod_ip> 为 pod ip 地址，但需要将 ip 地址中的 <code>.</code> 转换为 <code>-</code>。</p>
<p>比如 pod nginx-deployment-57d84f57dc-cpgkc 会创建 A 记录 <code>10-244-3-8.default.pod.cluster.local</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide nginx-deployment-57d84f57dc-cpgkc -o wide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-57d84f57dc-cpgkc   1/1     Running   0          2m59s   10.244.3.8   vc-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>规则二：</p>
<p>pod 如何同时指定了 <code>spec.hostname</code> 和 <code>spec.subdomain</code>，则会创建 A 记录：<code>&lt;hostname&gt;.&lt;subdomain&gt;.&lt;namespace&gt;.svc.cluster.local</code>，而不是 <code>&lt;pod_ip&gt;.&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>。对于 Statefulset 类型的 pod 会自动设置 <code>spec.hostname</code> 为 pod 的名字，<code>spec.subdomain</code> 为 StatefulSet 的 <code>spec.serviceName</code>。</p>
<p>比如 pod nginx-statefulset-0 会创建 A 记录 <code>nginx-statefulset-0.nginx.default.svc.cluster.local</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod nginx-statefulset-0 -o wide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-statefulset-0   1/1     Running   0          62m   10.244.3.7   vc-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Deployment-x2F-DaemonSet-管理的-pod"><a href="#Deployment-x2F-DaemonSet-管理的-pod" class="headerlink" title="Deployment&#x2F;DaemonSet 管理的 pod"></a>Deployment&#x2F;DaemonSet 管理的 pod</h3><p>使用 Deployment&#x2F;DaemonSet 拉起的 pod，k8s 会创建额外的 DNS 记录：<code>&lt;pod_ip&gt;.&lt;deployment-name/daemonset-name&gt;.&lt;namespace&gt;.svc.&lt;cluster-domain&gt;</code>。</p>
<h2 id="Service-域名注册"><a href="#Service-域名注册" class="headerlink" title="Service 域名注册"></a>Service 域名注册</h2><h3 id="普通-Service"><a href="#普通-Service" class="headerlink" title="普通 Service"></a>普通 Service</h3><p>除了 headless service 之外的其他 service 会在 DNS 中生成 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 的 A 或者 AAAA 记录，A 记录指向 ClusterIP。</p>
<p>headless service 会在 DNS 中生成 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 的 A 或者 AAAA 记录，但指向的为 pod ip 地址集合。</p>
<p>k8s 在 pod 的 &#x2F;etc&#x2F;resolv.conf 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.32.0.10</span><br><span class="line">search &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<p>对于跟 pod 同一个 namespace 下的 service，要访问可以直接使用 service 名字接口。跟 pod 不在同一个 namespace 下的 service，访问 service 必须为 <code>service name.service namespace</code>。</p>
<h3 id="ExternalName-Service"><a href="#ExternalName-Service" class="headerlink" title="ExternalName Service"></a>ExternalName Service</h3><p>service 的 <code>spec.type</code> 为 <code>ExternalName</code>，该种类型的服务会向 dns 中注册 CNAME 记录，CNAME 记录指向 externalName 字段。例子如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">  namespace: prod</span><br><span class="line">spec:</span><br><span class="line">  type: ExternalName</span><br><span class="line">  externalName: my.database.example.com</span><br></pre></td></tr></table></figure>

<p>当访问 <code>my-service.prod.svc.cluster.local</code> 时，DNS 服务会返回 CNAME 记录，指向地址为 <code>my.database.example.com</code>。</p>
<h3 id="externalIPs-字段"><a href="#externalIPs-字段" class="headerlink" title="externalIPs 字段"></a>externalIPs 字段</h3><p>可以针对所有类型的 Service 生效，用来配置多个外部的 ip 地址（该 ip 地址不是 k8s 分配），kube-proxy 会设置该 ip 地址的规则，确保在 k8s 集群内部访问该 ip 地址时，可以路由到后端的 pod。效果就跟访问普通的 ClusterIP 类型 Service 没有区别。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 49152</span><br><span class="line">  externalIPs:</span><br><span class="line">    - 198.51.100.32</span><br></pre></td></tr></table></figure>

<p>当在集群内部访问 <code>198.51.100.32:80</code> 时，流量会被 kube-proxy 路由到当前 Service 的 Endpoint。</p>
<p>该字段存在中间人攻击的风险，不推荐使用。<a target="_blank" rel="noopener" href="https://sysdig.com/blog/detect-cve-2020-8554-using-falco/">Detect CVE-2020-8554 – Unpatched Man-In-The-Middle (MITM) Attack in Kubernetes</a></p>
<h3 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h3><p>翻译成中文又叫无头 Service，显式的将 Service <code>spec.clusterIP</code> 设置为 <code>&quot;None&quot;</code>，表示该 Service 为 Headless Service。此时，该 Service 不会分配 clusterIP。因为没有 clusterIP，因此 kube-proxy 并不会处理该 service。</p>
<p>Headless Service 按照是否配置了 <code>spec.selector</code> 在实现上又有不同的区分。</p>
<p>未配置 <code>spec.selector</code> 的 Service，不会创建 EndpointSlice 对象，但是会注册如下的记录：</p>
<ul>
<li>对于 ExternalName Service，配置 CNAME 记录。</li>
<li>对于非 ExternalName Service，配置 A&#x2F;AAAA 记录，指向 EndPoint 的所有 ip 地址。如果未配置 Endpoint，但配置了 externalIPs 字段，则指向 externalIPs。</li>
</ul>
<p>配置 <code>spec.selector</code> 的 Service，会创建 EndpointSlice 对象，并修改 DNS 配置返回 A 或者 AAAA 记录，指向 pod 的集合。</p>
<h1 id="域名查询"><a href="#域名查询" class="headerlink" title="域名查询"></a>域名查询</h1><p>待补充</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/">k8s 官方 Service 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/">k8s 官方 Service 与 Pod 的 DNS</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dns/blob/master/docs/specification.md">Kubernetes DNS-Based Service Discovery</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/json-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/json-patch/" class="post-title-link" itemprop="url">json patch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-01-29 17:04:14" itemprop="dateCreated datePublished" datetime="2023-01-29T17:04:14+00:00">2023-01-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="json-patch"><a href="#json-patch" class="headerlink" title="json patch"></a>json patch</h1><p>该规范定义在 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6902/">RFC 6902</a>，定义了修改 json 格式的规范，同时还可以配合 http patch 请求一起使用，实例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PATCH /my/data HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> example.org</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">326</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json-patch+json</span><br><span class="line">If-Match<span class="punctuation">:</span> <span class="string">&quot;abc123&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remove&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bar&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">42</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;move&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/d&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;copy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/d&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/e&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>支持add、remove、replace、move、copy和 test 六个patch动作。</p>
<h2 id="协议规范"><a href="#协议规范" class="headerlink" title="协议规范"></a>协议规范</h2><h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><p>格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>规范：</p>
<ol>
<li>如果原始 json 中不存在 key “&#x2F;hello”，则会全新创建 key。</li>
<li>如果原始 json 存在 key “&#x2F;hello”，则会直接覆盖；即使”&#x2F;hello”为数组，也不会在原先的基础上追加，而是直接强制覆盖；</li>
</ol>
<p>原始 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;123&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行后结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;world&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><p>用来删除某个 key，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remove&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>用来替换某个 key，跟 add 动作的差异是，如果 key 不存在，则不会创建 key。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">42</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果原始 json 格式为: <code>&#123;&#125;</code>，执行完成后，输出 json 格式仍然为：<code>&#123;&#125;</code>。</p>
<h3 id="move"><a href="#move" class="headerlink" title="move"></a>move</h3><p>用来修改 key 的名称，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;move&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果 key 不存在，则不做任何修改。</p>
<h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p>用来复制某个 key，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;copy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果原始 key 不存在，则不复制；如果目标 key 已经存在，则仍然会复制。</p>
<p>原始 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;hello2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行完成后的 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hello2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p>用来测试 key 对应的 value 是否相等，该操作并不常用</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ul>
<li><a target="_blank" rel="noopener" href="https://json-patch-builder-online.github.io/">JSON Patch Builder Online</a> 在线工具，可根据原始 json 和 patch 完成后的 json，产生 json patch</li>
<li><a target="_blank" rel="noopener" href="https://jsonpatch.me/">jsonpatch.me</a> 在线工具，可根据原始 json 和 json patch，产生 patch 完成后的 json</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上述协议可以发现如下缺点：</p>
<ol>
<li>对于数组的处理不是太理想，如果要删除数组中的某个元素，或者在数组中追加某个元素，则无法表达。</li>
<li>该协议对于人类并不友好。</li>
</ol>
<h1 id="json-merge-patch"><a href="#json-merge-patch" class="headerlink" title="json merge patch"></a>json merge patch</h1><p>定义在 <a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc7386">RFC 7386</a>，由于patch 能力比较有限，使用场景较少。</p>
<p>同样可以配合 http patch 方法一起使用，http 请求如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PATCH /target HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> example.org</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/merge-patch+json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="string">&quot;z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;f&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>下面结合具体的实例来说明 json merge patch 的功能。<br>原始 json 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Goodbye!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;givenName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;familyName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Doe&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span> <span class="string">&quot;example&quot;</span><span class="punctuation">,</span> <span class="string">&quot;sample&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This will be unchanged&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>patch json 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+01-123-456-7890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;familyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;example&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中 null 用来表示该 key 需要删除。对于数组类型，则直接覆盖数组中的值。<br>patch 完成后的 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;givenName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;example&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This will be unchanged&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+01-123-456-7890&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过上述实例可以发现如下的功能缺陷：</p>
<ol>
<li>如果某个 json 的 key 对应的值为 null，则无法表达，即不可以将某个 key 对应的value 设置为 null。</li>
<li>对于数组的处理非常弱，是直接对数组中所有元素的替换。</li>
</ol>
<h1 id="k8s-strategic-merge-patch"><a href="#k8s-strategic-merge-patch" class="headerlink" title="k8s strategic merge patch"></a>k8s strategic merge patch</h1><p>该协议的资料较少，官方参考资料只有两篇文章，最好结合着 k8s 的代码才能完全理解：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/">Update API Objects in Place Using kubectl patch</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md">Strategic Merge Patch</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podspec-v1-core">Pod Spec 定义</a></li>
</ul>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>无论是 json patch，还是 json merge patch 协议，对于数组元素的支持都不够友好。<br>比如对于如下的 json：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec<span class="punctuation">:</span></span><br><span class="line">  containers<span class="punctuation">:</span></span><br><span class="line">    - name<span class="punctuation">:</span> nginx</span><br><span class="line">      image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<p>期望能够 patch 如下的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec<span class="punctuation">:</span></span><br><span class="line">  containers<span class="punctuation">:</span></span><br><span class="line">    - name<span class="punctuation">:</span> log-tailer</span><br><span class="line">      image<span class="punctuation">:</span> log-tailer<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<p>从而可以实现 containers中包含两个元素的情况，无论是 json patch 还是 json merge patch，其行为是对数组元素的直接替换，不能实现追加的功能。</p>
<h2 id="协议规范-1"><a href="#协议规范-1" class="headerlink" title="协议规范"></a>协议规范</h2><p>为了解决 json merge patch 的功能缺陷，strategic merge patch 通过如下两种方式来扩展功能：</p>
<ol>
<li>json merge patch 的 json 语法增强，增加一些额外的指令</li>
<li>通过增强原始 json 的 struct 结构实现，跟 golang 语言强绑定，通过 golang 中的 struct tag 机制实现。这样的好处是不用再扩充 json merge patch 的 json 格式了。支持如下 struct tag：<ol>
<li>patchStrategy： 指定策略指令，支持：replace、merge 和 delete。默认的行为为 replace，保持跟 json merge patch 的兼容性。</li>
<li>patchMergeKey: 数组一个子 map 元素的主键，类似于关系型数据库中一行记录的主键。</li>
</ol>
</li>
</ol>
<p>支持如下指令：</p>
<ol>
<li>replace</li>
<li>merge</li>
<li>delete</li>
</ol>
<h3 id="replace-1"><a href="#replace-1" class="headerlink" title="replace"></a>replace</h3><p>支持 go struct tag 和 在 json patch 中增加指令两种方式。<br>replace 是默认的指令模式，对于数组而言会直接全部替换数组内容。</p>
<p>如下指令用来表示，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$patch<span class="punctuation">:</span> replace  # recursive and applies to all fields of the map it&#x27;s in</span><br><span class="line">containers<span class="punctuation">:</span></span><br><span class="line">- name<span class="punctuation">:</span> nginx</span><br><span class="line">  image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p>删除数组中的特定元素，下面例子可以删除数组中包含 name: log-tailer 的元素。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">containers<span class="punctuation">:</span></span><br><span class="line">  - name<span class="punctuation">:</span> nginx</span><br><span class="line">    image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br><span class="line">  - $patch<span class="punctuation">:</span> delete</span><br><span class="line">    name<span class="punctuation">:</span> log-tailer  # merge key and value goes here</span><br></pre></td></tr></table></figure>
<p>删除 map 的特定 key，如下实例可以删除 map 中的 key rollingUpdate。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rollingUpdate<span class="punctuation">:</span></span><br><span class="line">  $patch<span class="punctuation">:</span> delete</span><br></pre></td></tr></table></figure>
<h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p>该指令仅支持 go struct tag 模式，格式为：<code>$deleteFromPrimitiveList/&lt;keyOfPrimitiveList&gt;: [a primitive list]</code>。</p>
<h4 id="deleteFromPrimitiveList"><a href="#deleteFromPrimitiveList" class="headerlink" title="deleteFromPrimitiveList"></a>deleteFromPrimitiveList</h4><p>删除数组中的某个元素<br>go struct 定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Finalizers []<span class="type">string</span> <span class="string">`json:&quot;finalizers,omitempty&quot; patchStrategy:&quot;merge&quot; protobuf:&quot;bytes,14,rep,name=finalizers&quot;`</span></span><br></pre></td></tr></table></figure>
<p>原始 yaml 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br></pre></td></tr></table></figure>
<p>patch yaml 如下，用来表示删除finalizers中的所有元素 b 和 c</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The directive includes the prefix $deleteFromPrimitiveList and</span></span><br><span class="line"><span class="comment"># followed by a &#x27;/&#x27; and the name of the list.</span></span><br><span class="line"><span class="comment"># The values in this list will be deleted after applying the patch.</span></span><br><span class="line"><span class="string">$deleteFromPrimitiveList/finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>最终得到结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<h4 id="setElementOrder"><a href="#setElementOrder" class="headerlink" title="setElementOrder"></a>setElementOrder</h4><p>用于数组中的元素排序</p>
<h5 id="简单数组排序例子"><a href="#简单数组排序例子" class="headerlink" title="简单数组排序例子"></a>简单数组排序例子</h5><p>原始内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>设置排序顺序：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The directive includes the prefix $setElementOrder and</span></span><br><span class="line"><span class="comment"># followed by a &#x27;/&#x27; and the name of the list.</span></span><br><span class="line"><span class="string">$setElementOrder/finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<p>最终得到排序顺序：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<h5 id="map-类型数组排序例子"><a href="#map-类型数组排序例子" class="headerlink" title="map 类型数组排序例子"></a>map 类型数组排序例子</h5><p>其中 patchMergeKey 为 name 字段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>patch 指令的格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># each map in the list should only include the mergeKey</span></span><br><span class="line"><span class="string">$setElementOrder/containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<p>最终获得结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>
<h4 id="retainKeys"><a href="#retainKeys" class="headerlink" title="retainKeys"></a>retainKeys</h4><p>用来清理 map 结构中的 key，并指定保留的 key<br>原始内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="attr">foo:</span> <span class="string">a</span></span><br><span class="line">  <span class="attr">other:</span> <span class="string">b</span></span><br></pre></td></tr></table></figure>
<p>patch 内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="attr">retainKeys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">another</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bar</span></span><br><span class="line">  <span class="attr">another:</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">bar:</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>最终结果，可以看到 foo 和 other 因为不在保留列表中已经被清楚了。同时新增加了字段 another 和 bar，新增加的是字段是直接 patch 的结果，同时这两个字段也在保留的列表内。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="comment"># Field foo and other have been cleared w/o explicitly set them to null.</span></span><br><span class="line">  <span class="attr">another:</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">bar:</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>

<h1 id="strategic-merge-patch-在-k8s-中应用"><a href="#strategic-merge-patch-在-k8s-中应用" class="headerlink" title="strategic merge patch 在 k8s 中应用"></a>strategic merge patch 在 k8s 中应用</h1><p>kubectl patch 命令通过–type 参数提供了几种 patch 方法。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--type=&#x27;strategic&#x27;<span class="punctuation">:</span> The type of patch being provided; one of <span class="punctuation">[</span>json merge strategic<span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ol>
<li>json：即支持 json patch 协议，例子：<code>kubectl patch pod valid-pod --type=&#39;json&#39; -p=&#39;[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;:&quot;newimage&quot;&#125;]</code></li>
<li>merge：对应的为 json merge patch 协议。</li>
<li>stategic：k8s 特有的 patch 协议，在 json merge patch 协议基础上的扩展，可以解决 json merge patch 的缺点。</li>
</ol>
<p>对于 k8s 的 CRD 对象，由于不存在 go struct tag，因此无法使用 stategic merge patch。</p>
<p>TODO：待补充具体例子</p>
<h1 id="kubectl-patch、replace、apply之间的区别"><a href="#kubectl-patch、replace、apply之间的区别" class="headerlink" title="kubectl patch、replace、apply之间的区别"></a>kubectl patch、replace、apply之间的区别</h1><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>kubectl patch 命令的实现比较简单，直接调用 kube-apiserver 的接口在 server 端实现 patch 操作。</p>
<h2 id="replace-2"><a href="#replace-2" class="headerlink" title="replace"></a>replace</h2><p>如果该命令使用 –force&#x3D;true 参数，则会先删除对象，然后再提交，相当于是全新创建。</p>
<h2 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h2><p>apply 的实现相对比较复杂，逻辑也比较绕，可以实现 map 结构中的字段增删改操作，数组中数据的增删改操作。实现上会将多份数据进行merge 后提交，数据包含：</p>
<ol>
<li>要重新 apply 的 yaml</li>
<li>对象的annotation kubectl.kubernetes.io&#x2F;last-applied-configuration 包含的内容</li>
<li>运行时的 k8s 对象</li>
</ol>
<p>具体的操作步骤：</p>
<ol>
<li>要重新 apply 的 yaml 跟annotation kubectl.kubernetes.io&#x2F;last-applied-configuration 包含的内容比较，获取到要删除的字段。</li>
<li>要重新 apply 的 yaml 跟运行时的 k8s 对象进行比较，获取到要增加的字段。</li>
<li>上述两个结果再进行一次 merge 操作，最终调用 kube-apiserver 的接口实现 patch 操作。</li>
</ol>
<p>为什么一定需要用到kubectl.kubernetes.io&#x2F;last-applied-configuration的数据呢？<br>在 yaml 对象提交到 k8s 后，k8s 会自动增加一些字段，也可以通过额外的方式修改对象增加一些字段。如果 patch 内容仅跟运行时结果比较，会导致一些运行时的k8s 自动增加的字段或者手工更新的字段被删除掉。</p>
<table>
<thead>
<tr>
<th>试验</th>
<th>上次提交 last-applied-configuration</th>
<th>运行时</th>
<th>patch 内容</th>
<th>结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody><tr>
<td>试验一</td>
<td>label1: first</td>
<td>label1: first</td>
<td>label2: second</td>
<td>label2: second</td>
<td>1. patch 内容跟上次内容比较，发现要删除字段 label1<br>2. patch 内容跟运行时比较，发现新增加了字段 label2  <br>3. 最终 label1 被删除，仅保留 label2</td>
</tr>
<tr>
<td>试验二</td>
<td>label1: first</td>
<td>label1: first <br>label2: second</td>
<td>label1: first</td>
<td>label1: first <br>label2: second</td>
<td>1. patch 内容跟上次内容比较，发现结果无变化<br>2. patch 内容跟运行时比较，发现要新增加字段 label2<br>3. 最终新增加字段 label2</td>
</tr>
</tbody></table>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6902/">json patch RFC 规范</a></li>
<li><a target="_blank" rel="noopener" href="https://jsonpatch.com/">https://jsonpatch.com/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubeadm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubeadm/" class="post-title-link" itemprop="url">使用 kubeadm 安装 k8s 集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-07 00:07:20" itemprop="dateCreated datePublished" datetime="2022-12-07T00:07:20+00:00">2022-12-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文将通过 kubeadm 实现单 master 节点模式和集群模式两种部署方式。</p>
<h2 id="所有节点均需初始化操作"><a href="#所有节点均需初始化操作" class="headerlink" title="所有节点均需初始化操作"></a>所有节点均需初始化操作</h2><p>所有节点均需做的操作。</p>
<h3 id="主机准备"><a href="#主机准备" class="headerlink" title="主机准备"></a>主机准备</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernets.conf &lt;&lt;EOF</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure>


<h3 id="安装containerd"><a href="#安装containerd" class="headerlink" title="安装containerd"></a>安装containerd</h3><p>由于 dockerd 从 k8s 1.24 版本开始不再支持，这里选择 containerd。</p>
<h4 id="手工安装"><a href="#手工安装" class="headerlink" title="手工安装"></a>手工安装</h4><p>安装 containerd，containerd 的版本可以从这里获取 <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/releases">https://github.com/containerd/containerd/releases</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.6.11/containerd-1.6.11-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvf /usr/local containerd-1.6.11-linux-amd64.tar.gz</span><br><span class="line">wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -P /usr/local/lib/systemd/system/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure>

<p>安装 runc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64</span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure>

<h4 id="yum-源安装"><a href="#yum-源安装" class="headerlink" title="yum 源安装"></a>yum 源安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo     https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install containerd.io -y</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure>

<p>通过 yum 安装的containerd 没有启用 cri，在其配置文件 &#x2F;etc&#x2F;containerd&#x2F;config.toml 中包含了 <code>disabled_plugins = [&quot;cri&quot;]</code> 配置，需要将配置信息注释后并重启 containerd。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/disabled_plugins/#disabled_plugins/&#x27;  /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>

<h3 id="安装-kubeadm-x2F-kubelet-x2F-kubectl"><a href="#安装-kubeadm-x2F-kubelet-x2F-kubectl" class="headerlink" title="安装 kubeadm&#x2F;kubelet&#x2F;kubectl"></a>安装 kubeadm&#x2F;kubelet&#x2F;kubectl</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># Set SELinux in permissive mode (effectively disabling it)</span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<h2 id="单-master-节点模式"><a href="#单-master-节点模式" class="headerlink" title="单 master 节点模式"></a>单 master 节点模式</h2><table>
<thead>
<tr>
<th>节点</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>172.21.115.190<br/></td>
<td>master 节点</td>
</tr>
</tbody></table>
<h3 id="kubeadm-初始化"><a href="#kubeadm-初始化" class="headerlink" title="kubeadm 初始化"></a>kubeadm 初始化</h3><p>创建文件 kubeadm-config.yaml，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.25.4</span><br><span class="line">---</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">cgroupDriver: systemd</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm-config.yaml</span><br><span class="line">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; cluster.yaml</span><br><span class="line">kubeadm init --config cluster.yaml</span><br></pre></td></tr></table></figure>

<p>接下来初始化 kubeconfig 文件，这样即可通过 kubectl 命令来访问 k8s 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>


<h3 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h3><p>刚部署完成的节点处于NotReady 的状态，原因是因为还没有安装网络插件。</p>
<h4 id="cilim-网络插件"><a href="#cilim-网络插件" class="headerlink" title="cilim 网络插件"></a>cilim 网络插件</h4><p>cilim 网络插件比较火爆，下面介绍其安装步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 安装 cilium 客户端</span><br><span class="line">CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)</span><br><span class="line">CLI_ARCH=amd64</span><br><span class="line">if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then CLI_ARCH=arm64; fi</span><br><span class="line">curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/$&#123;CILIUM_CLI_VERSION&#125;/cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz&#123;,.sha256sum&#125;</span><br><span class="line">sha256sum --check cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz.sha256sum</span><br><span class="line">sudo tar xzvfC cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz /usr/local/bin</span><br><span class="line">rm cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz&#123;,.sha256sum&#125;</span><br><span class="line"></span><br><span class="line"># 网络插件初始化</span><br><span class="line">cilium install</span><br></pre></td></tr></table></figure>

<p>在安装完网络插件后，node 节点即可变为 ready 状态。</p>
<p>查看环境中包含如下的 pod:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get pod  -A</span><br><span class="line">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   cilium-7zj7t                     1/1     Running   0          82s</span><br><span class="line">kube-system   cilium-operator-bc4d5b54-kvqqx   1/1     Running   0          82s</span><br><span class="line">kube-system   coredns-565d847f94-hrm9b         1/1     Running   0          14m</span><br><span class="line">kube-system   coredns-565d847f94-z5kwr         1/1     Running   0          14m</span><br><span class="line">kube-system   etcd-k8s002                      1/1     Running   0          14m</span><br><span class="line">kube-system   kube-apiserver-k8s002            1/1     Running   0          14m</span><br><span class="line">kube-system   kube-controller-manager-k8s002   1/1     Running   0          14m</span><br><span class="line">kube-system   kube-proxy-bhpqr                 1/1     Running   0          14m</span><br><span class="line">kube-system   kube-scheduler-k8s002            1/1     Running   0          14m</span><br></pre></td></tr></table></figure>

<h4 id="k8s-自带的-bridge-插件"><a href="#k8s-自带的-bridge-插件" class="headerlink" title="k8s 自带的 bridge 插件"></a>k8s 自带的 bridge 插件</h4><p>在单节点的场景下，pod 不需要跨节点通讯，k8s 自带的 bridge 插件也可以满足单节点内的 pod 相互通讯，类似于 docker 的 bridge 网络模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line">cat &gt; /etc/cni/net.d/10-mynet.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">  &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class="line">  &quot;isGateway&quot;: true,</span><br><span class="line">  &quot;ipMasq&quot;: true,</span><br><span class="line">  &quot;ipam&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">    &quot;subnet&quot;: &quot;172.19.0.0/24&quot;,</span><br><span class="line">    &quot;routes&quot;: [</span><br><span class="line">      &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>如果 k8s 节点已经部署完成，需要重启下 kubelet 进程该配置即可生效。</p>
<h3 id="添加其他节点"><a href="#添加其他节点" class="headerlink" title="添加其他节点"></a>添加其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.21.115.189:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:457fba2c4181a5b02d2a4f202dfe20f9ce5b9f2274bf40b6d25a8a8d4a7ce440 </span><br></pre></td></tr></table></figure>

<p>此时即可以将节点添加到 k8s 集群中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get node </span><br><span class="line">NAME     STATUS   ROLES           AGE   VERSION</span><br><span class="line">k8s002   Ready    control-plane   79m   v1.25.4</span><br><span class="line">k8s003   Ready    &lt;none&gt;          35s   v1.25.4</span><br></pre></td></tr></table></figure>

<h3 id="节点清理"><a href="#节点清理" class="headerlink" title="节点清理"></a>节点清理</h3><h4 id="清理普通节点"><a href="#清理普通节点" class="headerlink" title="清理普通节点"></a>清理普通节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;node name&gt; --delete-emptydir-data --force --ignore-daemonsets</span><br><span class="line">kubeadm reset </span><br><span class="line"># 清理 iptabels 规则</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="清理-control-plan-节点"><a href="#清理-control-plan-节点" class="headerlink" title="清理 control plan 节点"></a>清理 control plan 节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<h2 id="集群模式部署"><a href="#集群模式部署" class="headerlink" title="集群模式部署"></a>集群模式部署</h2><p>待补充，参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">Creating Highly Available Clusters with kubeadm | Kubernetes</a></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">Bootstrapping clusters with kubeadm</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/knowledge-share-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/knowledge-share-16/" class="post-title-link" itemprop="url">技术分享第16期</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-23 16:09:08" itemprop="dateCreated datePublished" datetime="2022-07-23T16:09:08+00:00">2022-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/header-16.jpg"></p>
<p>题图为望京傍晚的天气，夕阳尽情散发着落山前的最后余光，层次分明的云朵映射在建筑物的上熠熠生辉。上班族结束了一天紧张的工作，朝着地铁站的方向奔向自己的家，这才是城市生活该有的模样。不过可惜的是，对于很多打工族而言，一天的工作还远未结束，晚饭后仍要坐在灯火通明的写字楼内或为生活或为梦想挥霍着自己的时光。</p>
<h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><h2 id="kaniko"><a href="#kaniko" class="headerlink" title="kaniko"></a><a target="_blank" rel="noopener" href="https://github.com/GoogleContainerTools/kaniko">kaniko</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/kaniko.png"></p>
<p>Google开源的一款可以在容器内部通过Dockerfile构建docker镜像的工具。</p>
<p>我们知道<code>docker build</code>命令可以根据Dockerfile构建出docker镜像，但该操作实际上是由docker daemon进程完成。如果<code>docker build</code>命令在docker容器中执行，由于容器中并没有docker daemon进程，因此直接执行<code>docker build</code>肯定会失败。</p>
<p>kaniko则重新实现了Dockerfile构建镜像的功能，使得构建镜像不再依赖docker daemon。随着gitops的技术普及，CI工具也正逐渐on k8s部署，kaniko正好可以在k8s的环境中根据Dockerfile完成镜像的打包过程，并将镜像推送到镜像仓库中。</p>
<h2 id="arc42"><a href="#arc42" class="headerlink" title="arc42"></a><a target="_blank" rel="noopener" href="https://arc42.org/overview">arc42</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/arc42-overview-V8.png"></p>
<p>技术人员在写架构文档的时候，遇到最多的问题是该如何组织技术文档的结构，arc42 提供了架构文档的模板，将架构文档分为了 12 个章节，每个章节又包含了多个子章节，用来帮助技术人员更好的编写架构文档。</p>
<p>相关链接：<a target="_blank" rel="noopener" href="https://topic.atatech.org/articles/205083?spm=ata.21736010.0.0.18c23b50NAifwr#tF1lZkHm">https://topic.atatech.org/articles/205083?spm=ata.21736010.0.0.18c23b50NAifwr#tF1lZkHm</a></p>
<h2 id="Carina"><a href="#Carina" class="headerlink" title="Carina"></a><a target="_blank" rel="noopener" href="https://github.com/carina-io/carina/blob/main/README_zh.md">Carina</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/carina.png"></p>
<p>国内云厂商博云发起的一款基于 Kubernetes CSI 标准实现的存储插件，用来管理本地的存储资源，支持本地磁盘的整盘或者LVM方案来管理存储。同时，还包含了Raid管理、磁盘限速、容灾转移等高级特性。</p>
<p>相关链接：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/-435K5O780NS2gkuLvSr5g">一篇看懂 Carina 全貌</a></p>
<h2 id="kube-capacity"><a href="#kube-capacity" class="headerlink" title="kube-capacity"></a><a target="_blank" rel="noopener" href="https://github.com/robscott/kube-capacity">kube-capacity</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/kube-capacity.png"></p>
<p>k8s的命令行工具kubectl用来查看集群的整体资源情况往往操作会比较复杂，可能需要多条命令配合在一起才能拿得到想要的结果。kube-capacity命令行工具用来快速查看集群中的资源使用情况，包括node、pod维度。</p>
<p>相关链接：<a target="_blank" rel="noopener" href="https://able8.medium.com/check-kubernetes-resource-reqeusts-limits-and-utilization-with-kube-capacity-cli-b00bf2f4acc9">Check Kubernetes Resource Requests, Limits, and Utilization with Kube-capacity CLI</a></p>
<h2 id="Kubeprober"><a href="#Kubeprober" class="headerlink" title="Kubeprober"></a><a target="_blank" rel="noopener" href="https://k.erda.cloud/">Kubeprober</a></h2><p>在k8s集群运维的过程中，诊断能力非常重要，可用来快速的定位发现问题。Kubeprober为一款定位为k8s多集群的诊断框架，提供了非常好的扩展性来接入诊断项，诊断结果可以通过grafana来统一展示。</p>
<p>社区里类似的解决方案还有Kubehealthy和Kubeeye。</p>
<p>相关链接：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Wte75OfQ7Ihzlm4th-pNYA">用更云原生的方式做诊断｜大规模 K8s 集群诊断利器深度解析</a></p>
<h2 id="Open-Policy-Agent"><a href="#Open-Policy-Agent" class="headerlink" title="Open Policy Agent"></a><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/">Open Policy Agent</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/opa.png"></p>
<p>OPA为一款开源的基于Rego语言的通用策略引擎，CNCF的毕业项目，可以用来实现一些基于策略的安全防护。比如在k8s中，要求pod的镜像必须为某个特定的registry，用户可以编写策略，一旦pod创建，OPA的gatekeeper组件通过webhook的方式来执行策略校验，一旦校验失败从而会导致pod创建失败。</p>
<p>比如 <a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/180803.html?spm=ata.21736010.0.0.3d7e50fddLMBB9">阿里云的ACK的gatekeeper</a> 就是基于OPA的实现。</p>
<h2 id="docker-squash"><a href="#docker-squash" class="headerlink" title="docker-squash"></a><a target="_blank" rel="noopener" href="https://github.com/goldmann/docker-squash">docker-squash</a></h2><p>docker-squash为一款docker镜像压缩工具。在使用Dockerfile来构建镜像时，会产生很多的docker镜像层，当Dockerfile中的命令过多时，会产生大量的docker镜像层，从而导致docker镜像过大。该工具可以将镜像进行按照层合并压缩，从而减小镜像的体积。</p>
<h2 id="FlowUs"><a href="#FlowUs" class="headerlink" title="FlowUs"></a><a target="_blank" rel="noopener" href="https://flowus.cn/">FlowUs</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/flowus.jpg"></p>
<p>FlowUs为国内研发的一款在线编辑器，支持文档、表格和网盘功能，该软件可以实现笔记、项目管理、共享文件等功能，跟蚂蚁集团的产品《<a target="_blank" rel="noopener" href="https://www.yuque.com/">语雀</a>》功能比较类似。但相比语雀做的好的地方在于，FlowUs通过”块编辑器“的方式，在FlowUs看来所有的文档形式都是”块“，作者可以在文档中随意放置各种类型的”块“，在同一个文档中即可以有功能完善的表格，也可以有网盘。而语雀要实现一个相对完整的表格，需要新建一种表格类型的文档，类似于Word和Excel。</p>
<h2 id="k8tz"><a href="#k8tz" class="headerlink" title="k8tz"></a><a target="_blank" rel="noopener" href="https://github.com/k8tz/k8tz">k8tz</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/k8tz.png"></p>
<p>k8s中的pod默认的时区跟pod的镜像有关，跟pod宿主机所在的时区没有关系。很多情况下，用户都期望pod里看到的时区能够跟宿主机的保持一致。用户的一种实现方式是将宿主机的时区文件挂载到pod中，但需要修改pod的yaml文件。本工具可以通过webhook的方式自动化将宿主机的时区文件挂载到pod中。</p>
<h1 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h1><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4ufpUSq2Qn_QV5vIJcPgqg">中美云巨头歧路，中国云未来增长点在哪？</a></li>
</ol>
<p>文章结合全球的云计算行业，对国内的云计算行业做了非常透彻的分析。”全球云，看中美；中美云，看六大云“，推荐阅读。</p>
<ol start="2">
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/F0KoDD9er7MNKYo-5POfsA">程序员必备的思维能力：结构化思维</a></li>
</ol>
<p>结构化思维不仅对于程序员，对于职场中的很多职业都非常重要，无论是沟通、汇报、晋升，还是写代码结构化思维都非常重要。本文深度剖析了金字塔原理以及如何应用，非常值得一读。文章的作者将公众号的文章整理为了《程序员底层思维》一书，推荐大家阅读。</p>
<ol start="3">
<li><a target="_blank" rel="noopener" href="https://github.com/ruanyf/document-style-guide">中文技术文档的写作规范</a></li>
</ol>
<p>阮一峰老师的中文技术文档写作规范，写技术文档的同学可以参考。</p>
<h1 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h1><ol>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/35794819/">《程序员的底层思维》</a></li>
</ol>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/dicengsiwei.jpg"></p>
<p>通过书名中的“程序员”来看有点初级，但实际上书中的内容适合所有软件行业的从业者，甚至同样适合于其他行业的从业者，因为底层思维本来就是共性的东西，万变不离其宗。作者曾在阿里巴巴有过很长一段工作经历，书中结合着工作中的实践经验介绍了16种思维能力，讲解浅显易懂，部分内容上升到了哲学的角度来讲解。</p>
<p>作为软件行业从业者的我，实际上书中的大部分思维能力在工作中都有应用，但却没有形成理论来总结。阅读本书，有助于对工作的内容进行总结，找到工作的理论基础。另一方面，有了书中的理论总结，也可以更好的指导工作。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ipv6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ipv6/" class="post-title-link" itemprop="url">ipv6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-14 10:24:00" itemprop="dateCreated datePublished" datetime="2022-07-14T10:24:00+00:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ipv6的优势"><a href="#ipv6的优势" class="headerlink" title="ipv6的优势"></a>ipv6的优势</h2><ol>
<li>拥有更大的地址空间。</li>
<li>点对点通讯更方便。由于ipv6地址足够多，可以不再使用NAT功能，避免NAT场景下的各种坑。</li>
<li>ip配置方便。每台机器都有一个唯一48位的mac地址，如果再增加一个80位的网段前缀即可组成ipv6地址。因此，在分配ip地址的时候，只需要获取到网段前缀即可获取到完整的ipv6地址了。</li>
<li>局域网内更安全。去掉了arp协议，而是采用Neighbor Discovery协议。</li>
</ol>
<h2 id="ipv6的数据包格式"><a href="#ipv6的数据包格式" class="headerlink" title="ipv6的数据包格式"></a>ipv6的数据包格式</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/ipv6-header.png"></p>
<p>分为报头、扩展报头和上层协议数据单元（PDU）三部分组成。</p>
<h3 id="报头"><a href="#报头" class="headerlink" title="报头"></a>报头</h3><p>固定为40个字节，相比于 ipv4 的可变长度报文更简洁。</p>
<ul>
<li><p>版本：固定为4bit，固定值6。</p>
</li>
<li><p>业务流类别：8bit，用来表明数据流的通讯类别或者优先级。</p>
</li>
<li><p>流标签：20bit，标记ipv6路由器需要特殊处理的数据流，目的是为了让路由器对于同一批数据报文能够按照同样的逻辑来处理。目前该字段的应用场景较少。</p>
</li>
<li><p>净荷长度：16bit，扩展头和上次协议数据单元的字节数，不包含报头的固定 40 字节。</p>
</li>
<li><p>下一个头：8bit，每个字段值有固定含义，用来表示上层协议。如果上层协议为 tcp，那么该字段的值为 4。</p>
</li>
<li><p>跳限制：8bit，即跳数限制，等同于ipv4中的ttl值。</p>
</li>
<li><p>源ip地址：128bit</p>
</li>
<li><p>目的ip地址：128bit</p>
</li>
</ul>
<h3 id="扩展报头"><a href="#扩展报头" class="headerlink" title="扩展报头"></a>扩展报头</h3><p>扩展报头的长度任意</p>
<h2 id="ipv6地址"><a href="#ipv6地址" class="headerlink" title="ipv6地址"></a>ipv6地址</h2><h3 id="地址表示方法"><a href="#地址表示方法" class="headerlink" title="地址表示方法"></a>地址表示方法</h3><ol>
<li>采用16进制表示法，共128位，分为8组，每组16位，每组用4个16进制表示。各组之间使用<code>:</code>分割。例如：1080:0:0:0:8:800:200C:417A。</li>
<li>地址中出现连续的0，可以使用<code>::</code>来代替连续的0，一个地址中只能出现一次连续的0。例如上述地址可以表示为：1080::8:800:200C:417A。本地的回环地址可使用 <code>::1</code> 表示。</li>
<li>如果ipv6的前面地址全部为0，可能存在包含ipv4地址的场景，可以使用ipv4的十进制表示方法。例如：0:0:0:0:0:0:61.1.133.1或者::61.1.133.1。</li>
</ol>
<p>ip地址结构包含了64位的网络地址和64位的主机地址，其中64位的网络地址又分为了48位的全球网络标识符和16位的本地子网标识符。</p>
<h3 id="网段表示方法"><a href="#网段表示方法" class="headerlink" title="网段表示方法"></a>网段表示方法</h3><p>在ipv6中同样有网段的概念，如 2001:0:0:CD30::&#x2F;60 ，其中前60位为前缀长度，后面的所有位表示接口 ID，使用 <code>::</code> 表示，但前面的两个0不能使用 <code>::</code> 表示。</p>
<h3 id="地址分类"><a href="#地址分类" class="headerlink" title="地址分类"></a>地址分类</h3><p>包括了如下地址类型，但跟 ipv4 不同的地方在于没有广播地址。</p>
<h4 id="单播地址"><a href="#单播地址" class="headerlink" title="单播地址"></a>单播地址</h4><p>单播地址又可以分为如下类型：</p>
<h5 id="链路本地地址（LLA）"><a href="#链路本地地址（LLA）" class="headerlink" title="链路本地地址（LLA）"></a>链路本地地址（LLA）</h5><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/ipv6-lla.jpg"></p>
<p>类似于 ipv4 的私网地址段，但比 ipv4 的私网地址段范围更小，仅可以用于本地子网内通讯，不可被路由。以<code>fe80::/10</code>开头的地址段。设备要想支持 ipv6，必须要有链路本地地址，且只能设置一个。</p>
<p>在设备启动时，通常该地址会自动设置，也可以手动设置。自动生成的地址通常会根据 mac 地址有关，因为每个设备的 mac 地址都是唯一的。</p>
<h5 id="公网单播地址（GUA）"><a href="#公网单播地址（GUA）" class="headerlink" title="公网单播地址（GUA）"></a>公网单播地址（GUA）</h5><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/ipv6-uga.jpg"></p>
<p>类似于 ipv4 的公网地址。</p>
<p>地址范围：<code>2000::3</code> - <code>3fff::/16</code>，即以 2 或者 3 开头，用总 ipv6 地址空间的1&#x2F;8。</p>
<p>通常情况下，公网路由前缀为 48 位，子网 id 为 16 位，接口 id 为 64 位。</p>
<h5 id="本地唯一单播地址（ULA）"><a href="#本地唯一单播地址（ULA）" class="headerlink" title="本地唯一单播地址（ULA）"></a>本地唯一单播地址（ULA）</h5><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/ipv6-ula.jpg"></p>
<p>范围：<code>fc00::/7</code>，当前唯一有效的前缀为<code>fd00::/8</code>。只能在私网内部使用，不能在公网上路由。</p>
<p>其全网 id 的部分采用伪随机算法，可以尽最大可可能确保全局的唯一性，从而在两个网络进行并网的时候减少地址冲突的概率。</p>
<h5 id="loopback地址"><a href="#loopback地址" class="headerlink" title="loopback地址"></a>loopback地址</h5><p>即 <code>::1</code>，等同于 ipv4 的 <code>127.0.0.1/8</code></p>
<h5 id="未指定单播地址"><a href="#未指定单播地址" class="headerlink" title="未指定单播地址"></a>未指定单播地址</h5><p>即 <code>::</code>。</p>
<h4 id="多播地址（Multicast）"><a href="#多播地址（Multicast）" class="headerlink" title="多播地址（Multicast）"></a>多播地址（Multicast）</h4><p>又叫组播地址，标识一组节点，目的为组播地址的流量会转发到组内的所有节点，类似于 ipv4 的广播地址。地址范围：<code>FF00::/8</code>。</p>
<h4 id="任意播地址（Anycast）"><a href="#任意播地址（Anycast）" class="headerlink" title="任意播地址（Anycast）"></a>任意播地址（Anycast）</h4><p>标识一组节点，所有节点的接口分配相同的 ip 地址，目的为组播地址的流量会转发到组内的就近节点。任意播地址没有固定的前缀。</p>
<h2 id="DNS服务和ipv6"><a href="#DNS服务和ipv6" class="headerlink" title="DNS服务和ipv6"></a>DNS服务和ipv6</h2><h3 id="双栈请求域名请求顺序"><a href="#双栈请求域名请求顺序" class="headerlink" title="双栈请求域名请求顺序"></a>双栈请求域名请求顺序</h3><p>在开启ipv4&#x2F;ipv6双栈的情况下，域名解析会同时发出A&#x2F;AAAA请求，发出请求的先后顺序由&#x2F;etc&#x2F;resolv.conf的option中的inet6选项决定。</p>
<h3 id="ipv6与-x2F-etc-x2F-hosts文件"><a href="#ipv6与-x2F-etc-x2F-hosts文件" class="headerlink" title="ipv6与  &#x2F;etc&#x2F;hosts文件"></a>ipv6与  &#x2F;etc&#x2F;hosts文件</h3><p>通常在&#x2F;etc&#x2F;hosts文件中包含了如下的回环地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::1             localhost6.localdomain6 localhost6</span><br></pre></td></tr></table></figure>



<h3 id="检测域名是否支持ipv6"><a href="#检测域名是否支持ipv6" class="headerlink" title="检测域名是否支持ipv6"></a>检测域名是否支持ipv6</h3><h4 id="dig-aaaa方法"><a href="#dig-aaaa方法" class="headerlink" title="dig aaaa方法"></a>dig aaaa方法</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">dig</span> <span class="string">aaaa</span>  <span class="string">ipv6.google.com.hk</span></span><br><span class="line"></span><br><span class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.10</span><span class="number">.6</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">aaaa</span> <span class="string">ipv6.google.com.hk</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">global options:</span> <span class="string">+cmd</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">Got answer:</span></span><br><span class="line"><span class="string">;;</span> <span class="string">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">50248</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">rd</span> <span class="string">ra;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">6</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">;</span> <span class="attr">EDNS: version:</span> <span class="number">0</span><span class="string">,</span> <span class="string">flags:;</span> <span class="attr">udp:</span> <span class="number">4000</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">QUESTION SECTION:</span></span><br><span class="line"><span class="string">;ipv6.google.com.hk.</span>		<span class="string">IN</span>	<span class="string">AAAA</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">ANSWER SECTION:</span></span><br><span class="line"><span class="string">ipv6.google.com.hk.</span>	<span class="number">21600</span>	<span class="string">IN</span>	<span class="string">CNAME</span>	<span class="string">ipv6.google.com.</span></span><br><span class="line"><span class="string">ipv6.google.com.</span>	<span class="number">21600</span>	<span class="string">IN</span>	<span class="string">CNAME</span>	<span class="string">ipv6.l.google.com.</span></span><br><span class="line"><span class="string">ipv6.l.google.com.</span>	<span class="number">300</span>	<span class="string">IN</span>	<span class="string">AAAA</span>	<span class="number">2607</span><span class="string">:f8b0:4003:c0b::71</span></span><br><span class="line"><span class="string">ipv6.l.google.com.</span>	<span class="number">300</span>	<span class="string">IN</span>	<span class="string">AAAA</span>	<span class="number">2607</span><span class="string">:f8b0:4003:c0b::64</span></span><br><span class="line"><span class="string">ipv6.l.google.com.</span>	<span class="number">300</span>	<span class="string">IN</span>	<span class="string">AAAA</span>	<span class="number">2607</span><span class="string">:f8b0:4003:c0b::65</span></span><br><span class="line"><span class="string">ipv6.l.google.com.</span>	<span class="number">300</span>	<span class="string">IN</span>	<span class="string">AAAA</span>	<span class="number">2607</span><span class="string">:f8b0:4003:c0b::8b</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">Query time:</span> <span class="number">83</span> <span class="string">msec</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">30.30</span><span class="number">.30</span><span class="number">.30</span><span class="comment">#53(30.30.30.30)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Mon</span> <span class="string">Jun</span> <span class="number">20</span> <span class="number">10</span><span class="string">:45:37</span> <span class="string">CST</span> <span class="number">2022</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">MSG SIZE  rcvd:</span> <span class="number">209</span></span><br></pre></td></tr></table></figure>

<h4 id="使用网站测试"><a href="#使用网站测试" class="headerlink" title="使用网站测试"></a>使用网站测试</h4><p>使用该网址，将域名更换为对应的域名：<a target="_blank" rel="noopener" href="http://ipv6-test.com/validate.php?url=http://www.microsoft.com">http://ipv6-test.com/validate.php?url=http://www.microsoft.com</a></p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/ipv6-check.png"></p>
<h2 id="启用ipv6"><a href="#启用ipv6" class="headerlink" title="启用ipv6"></a>启用ipv6</h2><p>ipv6特性可以设置在整个系统级别或者单个网卡上，默认启用。</p>
<h3 id="系统级别"><a href="#系统级别" class="headerlink" title="系统级别"></a>系统级别</h3><p>系统级别可以通过内核参数 net.ipv6.conf.all.disable_ipv6 来查看是否启用，如果输出结果为0，说明启用。可以修改该内核参数的值来开启或者关闭系统级别的ipv6特性。</p>
<p>也可以通过修改grub的内核参数来选择开启或者关闭，在  &#x2F;etc&#x2F;default&#x2F;grub 中GRUB_CMDLINE_LINUX追加如下内容，其中xxxxx代表当前已经有的参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">GRUB_CMDLINE_LINUX=&quot;xxxxx</span> <span class="string">ipv6.disable=1&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="网卡级别"><a href="#网卡级别" class="headerlink" title="网卡级别"></a>网卡级别</h3><p>可以通过 <code>ifconfig ethx</code> 命令来查看网卡信息，如果其中包含了inet6，则说明该网卡启用了ipv6特性。</p>
<p>也可以通过 <code>sysctl net.ipv6.conf.ethx.disable_ipv6</code> 来查看网卡是否启用。其中ethx为对应的网卡名称。</p>
<h3 id="nginx支持ipv6"><a href="#nginx支持ipv6" class="headerlink" title="nginx支持ipv6"></a>nginx支持ipv6</h3><p>默认情况下，nginx不支持ipv6，要支持ipv6，需要在编译的时候指定 –with-ipv6 选项。</p>
<p>在编译完成后，通过nginx -V 查看需要包含 –with-ipv6 选项。</p>
<h2 id="配置-ipv6"><a href="#配置-ipv6" class="headerlink" title="配置 ipv6"></a>配置 ipv6</h2><p>ifconfig  eth0  inet6 add 2607:f8b0:4003:c0b::71</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/87556?spm=a2c6h.13813017.content3.1.7de919b7VnWCcD">Linux有问必答：如何在Linux下禁用IPv6</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/12-factors-app/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/12-factors-app/" class="post-title-link" itemprop="url">12要素应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-01 22:21:10" itemprop="dateCreated datePublished" datetime="2022-07-01T22:21:10+00:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>2012 年，Heroku 创始人 Adam Wiggins 发布十二要素应用宣言，又被称为微服务十二要素。</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><h3 id="基准代码"><a href="#基准代码" class="headerlink" title="基准代码"></a>基准代码</h3><ol>
<li>一个应用一个代码仓库，不要出现一个代码仓库对应多个应用的情况</li>
<li>如果多个应用共享一份代码，那么需要将该代码拆分为独立的类库</li>
</ol>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>规范：</p>
<ol>
<li>应用必须通过配置显式声明出所有的依赖项，即使依赖的工具在所有的操作系统上都存在。比如 python 可以使用 pip 的 requirements.txt 文件声明出所有的依赖包及其版本信息。</li>
<li>在运行时需要通过隔离手段确保应用不会调用未显式声明的依赖项。比如 python 应用可以通过virtualenv 技术来确保隔离性。</li>
</ol>
<p>优点：</p>
<ol>
<li>简化开发者的环境配置，通过构建命令即可安装所有的依赖项。</li>
</ol>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>规范：</p>
<ol>
<li>代码和配置单独管理，不要将配置放到代码仓库中管理。</li>
<li>配置传递给应用的方式之一为配置文件，另外一种为环境变量。</li>
</ol>
<h3 id="后端服务"><a href="#后端服务" class="headerlink" title="后端服务"></a>后端服务</h3><p>规范：</p>
<ol>
<li>后端服务分为本地服务和第三方服务，对应用而言都是后端服务，不应该区别对待。</li>
</ol>
<h3 id="构建、发布和运行"><a href="#构建、发布和运行" class="headerlink" title="构建、发布和运行"></a>构建、发布和运行</h3><p>规范：</p>
<ol>
<li>严格区分从代码到部署的三个阶段：构建编译打包代码；将构建结果和部署需要的配置放到环境中；指定发布版本，在环境中启动应用。</li>
<li>每个发布版本必须对应一个唯一的 id 标识。</li>
</ol>
<p>反模式：</p>
<ol>
<li>不可以直接修改环境中的代码，可能会导致非常难同步会构建步骤。</li>
</ol>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>规范：</p>
<ol>
<li>应用的进程需要持久化的数据一定要保存到后端服务中，保持应用进程的无状态。</li>
<li>本地的内存和磁盘可以作为应用的缓存数据。</li>
<li>反对使用基于 session 的粘滞技术（某一个用户的请求通过一致性 hash 等技术请求到同一个后端服务，而后端服务将用户数据缓存在内存中），推荐将用户数据缓存到Redis 等分布式缓存中。很多互联网公司都会采用 session 粘滞技术，都违背了这一原则。</li>
</ol>
<h3 id="端口绑定"><a href="#端口绑定" class="headerlink" title="端口绑定"></a>端口绑定</h3><p>要求应用自己通过监听端口的方式来对外提供服务。</p>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>规范：</p>
<ol>
<li>允许通过多进程或者多线程的方式来处理高并发</li>
<li>应用不需要守护进程或者写入 PID 文件，可以借助如 systemd 等工具来实现。</li>
</ol>
<h3 id="易处理"><a href="#易处理" class="headerlink" title="易处理"></a>易处理</h3><p>规范：</p>
<ol>
<li>进程启动速度尽可能快，以便于更好的支持弹性伸缩、部署应用。</li>
<li>进程在接收到SIGTERM 信号后需要优雅停止。比如对于 nginx 而言，要等到处理完所有的连接后才可以退出。</li>
<li>进程要能够处理各种异常情况。</li>
</ol>
<h3 id="开发环境与生产环境等价"><a href="#开发环境与生产环境等价" class="headerlink" title="开发环境与生产环境等价"></a>开发环境与生产环境等价</h3><p>核心就只有一点，尽可能保证开发环境与生产环境的一致性。</p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>规范：</p>
<ol>
<li>应用程序将日志直接输出到标准输出，标准输出的内容由日志收集程序消费。</li>
</ol>
<p>反模式：</p>
<ol>
<li>现实中应用程序将日志直接写到了日志文件，并且自己来管理日志文件。</li>
</ol>
<h3 id="管理进程"><a href="#管理进程" class="headerlink" title="管理进程"></a>管理进程</h3><p>规范：</p>
<ol>
<li>仅需要执行一次的进程，跟普通的进程一样的管理思路，比如版本、执行环境等。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://12factor.net/zh_cn/">12要素应用</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/cri/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/cri/" class="post-title-link" itemprop="url">Container Runtime Interface(CRI)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-29 22:20:52" itemprop="dateCreated datePublished" datetime="2022-06-29T22:20:52+00:00">2022-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-22 12:05:12" itemprop="dateModified" datetime="2024-03-22T12:05:12+00:00">2024-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>CRI为k8s提供的kubelet扩展接口，用来支持多种容器运行时。CRI协议为protobuf格式，kubelet作为客户端，容器运行时作为服务端，两者通过gRpc协议通讯。下面主要解读 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/cri-api/blob/c75ef5b/pkg/apis/runtime/v1/api.proto">CRI的协议定义</a></p>
<h2 id="spec解读"><a href="#spec解读" class="headerlink" title="spec解读"></a>spec解读</h2><h3 id="RuntimeService"><a href="#RuntimeService" class="headerlink" title="RuntimeService"></a>RuntimeService</h3><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/cri-api-to-construct.png" alt="https://github.com/kata-containers/kata-containers/blob/main/docs/design/arch-images/api-to-construct.png"></p>
<p>包括了Pod和容器相关的操作。</p>
<p>Pod相关的操作包括：</p>
<ol>
<li>启：RunPodSandbox</li>
<li>停：StopPodSandbox</li>
<li>删：RemovePodSandbox</li>
<li>查：PodSandboxStatus、ListPodSandbox、ListPodSandboxStats、PodSandboxStats</li>
</ol>
<p>容器相关的操作：</p>
<ol>
<li>增、启：CreateContainer、StartContainer</li>
<li>停：StopContainer</li>
<li>删：RemoveContainer</li>
<li>查：ListContainers、ContainerStatus、</li>
<li>改：UpdateContainerResources</li>
<li>控：ReopenContainerLog、ExecSync、Exec、Attach、PortForward</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime service defines the public APIs for remote container runtimes</span></span><br><span class="line">service RuntimeService <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// Version returns the runtime name, runtime version, and runtime API version.</span></span><br><span class="line">    rpc Version(VersionRequest) returns (VersionResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure</span></span><br><span class="line">    <span class="comment">// the sandbox is in the ready state on success.</span></span><br><span class="line">    rpc RunPodSandbox(RunPodSandboxRequest) returns (RunPodSandboxResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// StopPodSandbox stops any running process that is part of the sandbox and</span></span><br><span class="line">    <span class="comment">// reclaims network resources (e.g., IP addresses) allocated to the sandbox.</span></span><br><span class="line">    <span class="comment">// If there are any running containers in the sandbox, they must be forcibly</span></span><br><span class="line">    <span class="comment">// terminated.</span></span><br><span class="line">    <span class="comment">// This call is idempotent, and must not return an error if all relevant</span></span><br><span class="line">    <span class="comment">// resources have already been reclaimed. kubelet will call StopPodSandbox</span></span><br><span class="line">    <span class="comment">// at least once before calling RemovePodSandbox. It will also attempt to</span></span><br><span class="line">    <span class="comment">// reclaim resources eagerly, as soon as a sandbox is not needed. Hence,</span></span><br><span class="line">    <span class="comment">// multiple StopPodSandbox calls are expected.</span></span><br><span class="line"></span><br><span class="line">    rpc StopPodSandbox(StopPodSandboxRequest) returns (StopPodSandboxResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// RemovePodSandbox removes the sandbox. If there are any running containers</span></span><br><span class="line">    <span class="comment">// in the sandbox, they must be forcibly terminated and removed.</span></span><br><span class="line">    <span class="comment">// This call is idempotent, and must not return an error if the sandbox has</span></span><br><span class="line">    <span class="comment">// already been removed.</span></span><br><span class="line"></span><br><span class="line">    rpc RemovePodSandbox(RemovePodSandboxRequest) returns (RemovePodSandboxResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="comment">// PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not</span></span><br><span class="line">    <span class="comment">// present, returns an error.</span></span><br><span class="line"></span><br><span class="line">    rpc PodSandboxStatus(PodSandboxStatusRequest) returns (PodSandboxStatusResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ListPodSandbox returns a list of PodSandboxes.</span></span><br><span class="line">    rpc ListPodSandbox(ListPodSandboxRequest) returns (ListPodSandboxResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// CreateContainer creates a new container in specified PodSandbox</span></span><br><span class="line">    rpc CreateContainer(CreateContainerRequest) returns (CreateContainerResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// StartContainer starts the container.</span></span><br><span class="line">    rpc StartContainer(StartContainerRequest) returns (StartContainerResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// StopContainer stops a running container with a grace period (i.e., timeout).</span></span><br><span class="line">    <span class="comment">// This call is idempotent, and must not return an error if the container has</span></span><br><span class="line">    <span class="comment">// already been stopped.</span></span><br><span class="line">    <span class="comment">// The runtime must forcibly kill the container after the grace period is</span></span><br><span class="line">    <span class="comment">// reached.</span></span><br><span class="line">    rpc StopContainer(StopContainerRequest) returns (StopContainerResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// RemoveContainer removes the container. If the container is running, the</span></span><br><span class="line">    <span class="comment">// container must be forcibly removed.</span></span><br><span class="line">    <span class="comment">// This call is idempotent, and must not return an error if the container has</span></span><br><span class="line">    <span class="comment">// already been removed.</span></span><br><span class="line"></span><br><span class="line">    rpc RemoveContainer(RemoveContainerRequest) returns (RemoveContainerResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ListContainers lists all containers by filters.</span></span><br><span class="line">    rpc ListContainers(ListContainersRequest) returns (ListContainersResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ContainerStatus returns status of the container. If the container is not</span></span><br><span class="line">    <span class="comment">// present, returns an error.</span></span><br><span class="line">    rpc ContainerStatus(ContainerStatusRequest) returns (ContainerStatusResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UpdateContainerResources updates ContainerConfig of the container.</span></span><br><span class="line">    rpc UpdateContainerResources(UpdateContainerResourcesRequest) returns (UpdateContainerResourcesResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ReopenContainerLog asks runtime to reopen the stdout/stderr log file</span></span><br><span class="line">    <span class="comment">// for the container. This is often called after the log file has been</span></span><br><span class="line">    <span class="comment">// rotated. If the container is not running, container runtime can choose</span></span><br><span class="line">    <span class="comment">// to either create a new log file and return nil, or return an error.</span></span><br><span class="line">    <span class="comment">// Once it returns error, new container log file MUST NOT be created.</span></span><br><span class="line">    rpc ReopenContainerLog(ReopenContainerLogRequest) returns (ReopenContainerLogResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ExecSync runs a command in a container synchronously.</span></span><br><span class="line">    rpc ExecSync(ExecSyncRequest) returns (ExecSyncResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exec prepares a streaming endpoint to execute a command in the container.</span></span><br><span class="line">    rpc Exec(ExecRequest) returns (ExecResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach prepares a streaming endpoint to attach to a running container.</span></span><br><span class="line">    rpc Attach(AttachRequest) returns (AttachResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// PortForward prepares a streaming endpoint to forward ports from a PodSandbox.</span></span><br><span class="line">    rpc PortForward(PortForwardRequest) returns (PortForwardResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ContainerStats returns stats of the container. If the container does not</span></span><br><span class="line">    <span class="comment">// exist, the call returns an error.</span></span><br><span class="line">    rpc ContainerStats(ContainerStatsRequest) returns (ContainerStatsResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ListContainerStats returns stats of all running containers.</span></span><br><span class="line">    rpc ListContainerStats(ListContainerStatsRequest) returns (ListContainerStatsResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// PodSandboxStats returns stats of the pod sandbox. If the pod sandbox does not</span></span><br><span class="line">    <span class="comment">// exist, the call returns an error.</span></span><br><span class="line">    rpc PodSandboxStats(PodSandboxStatsRequest) returns (PodSandboxStatsResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ListPodSandboxStats returns stats of the pod sandboxes matching a filter.</span></span><br><span class="line">    rpc ListPodSandboxStats(ListPodSandboxStatsRequest) returns (ListPodSandboxStatsResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UpdateRuntimeConfig updates the runtime configuration based on the given request.</span></span><br><span class="line">    rpc UpdateRuntimeConfig(UpdateRuntimeConfigRequest) returns (UpdateRuntimeConfigResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status returns the status of the runtime.</span></span><br><span class="line">    rpc Status(StatusRequest) returns (StatusResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ImageService"><a href="#ImageService" class="headerlink" title="ImageService"></a>ImageService</h3><p>跟镜像相关的操作，包括了</p>
<ol>
<li>增：PullImage</li>
<li>查：ListImages、ImageStatus和ImageFsInfo</li>
<li>删：RemoveImage</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ImageService defines the public APIs for managing images.</span></span><br><span class="line">service ImageService <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ListImages lists existing images.</span></span><br><span class="line">    rpc ListImages(ListImagesRequest) returns (ListImagesResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ImageStatus returns the status of the image. If the image is not</span></span><br><span class="line">    <span class="comment">// present, returns a response with ImageStatusResponse.Image set to</span></span><br><span class="line">    <span class="comment">// nil.</span></span><br><span class="line">    rpc ImageStatus(ImageStatusRequest) returns (ImageStatusResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// PullImage pulls an image with authentication config.</span></span><br><span class="line">    rpc PullImage(PullImageRequest) returns (PullImageResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// RemoveImage removes the image.</span></span><br><span class="line">    <span class="comment">// This call is idempotent, and must not return an error if the image has</span></span><br><span class="line">    <span class="comment">// already been removed.</span></span><br><span class="line">    rpc RemoveImage(RemoveImageRequest) returns (RemoveImageResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ImageFSInfo returns information of the filesystem that is used to store images.</span></span><br><span class="line">    rpc ImageFsInfo(ImageFsInfoRequest) returns (ImageFsInfoResponse) <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="CRI-CLI"><a href="#CRI-CLI" class="headerlink" title="CRI CLI"></a>CRI CLI</h2><p>CRI 自带了命令行工具 crictl。</p>
<p>Linux 下安装脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VERSION=&quot;v1.26.0&quot; # check latest version in /releases page</span><br><span class="line">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz</span><br><span class="line">sudo tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin</span><br><span class="line">rm -f crictl-$VERSION-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
