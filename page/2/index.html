<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/2/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">243</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/watch-tv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/watch-tv/" class="post-title-link" itemprop="url">我要看电视 - 投影仪和电视盒子选型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-17 11:20:50" itemprop="dateCreated datePublished" datetime="2024-02-17T11:20:50+00:00">2024-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>去年装修的时候预留了投影仪和幕布的位置，搬家已经有几个月的时间了，最近开始考虑安装投影仪。作为技术男，已经有多年不看电视，在决策前自然要考察下市场，了解下当前的技术，综合考虑多种技术因素。</p>
<h1 id="投影仪的选型"><a href="#投影仪的选型" class="headerlink" title="投影仪的选型"></a>投影仪的选型</h1><p>家装投影仪分为了两大阵营：</p>
<ol>
<li>以传统厂商为代表的 3LCD 阵营。典型的厂家为爱普生、明基。优点为清晰度高、对比度高。缺点为噪音大、灯泡寿命短、个头偏大。</li>
<li>以国产新势力厂商为代表的 DLP 阵营。典型厂家为极米、当贝、坚果，无论其市场分布，还是技术形态，都像极了新能源领域的新势力”蔚小理“。优点为自带 android 系统、更加人性化、寿命长。缺点为亮度低。</li>
</ol>
<p>我的需求优先级依次如下：</p>
<ol>
<li>亮度高，抛开亮度和对比度谈体验就本末倒置了，电视的最基本需求就是看得见，看得清楚。</li>
<li>最好不要带 android 系统，时间长了肯定会卡，不希望跟 android 系统绑定。</li>
<li>开机不要有广告。</li>
</ol>
<p>经过对比后，选择了爱普生的 3LCD 投影仪，亮度完全满足需求，即使在白天不拉窗帘的情况下，清晰度也完全足够。选择了其优点，自然要忍受其缺点，噪音大也并没有大到不能忍受，一般播放片源后就可以将风扇的声音盖住，在投影仪旁实测噪音在 40 分贝左右。灯泡寿命短的缺点暂时忽略，毕竟官方说明灯泡的寿命在三年到六年之间，而且更换灯泡的费用并不高。</p>
<h1 id="电视盒子的选型"><a href="#电视盒子的选型" class="headerlink" title="电视盒子的选型"></a>电视盒子的选型</h1><p>有了投影仪后，还缺一个电视盒子用于提供视频源，电视盒子的选择比投影仪更加丰富。</p>
<h2 id="Apple-TV"><a href="#Apple-TV" class="headerlink" title="Apple TV"></a>Apple TV</h2><p>第一优先级考虑为地表最强电视盒子 Apple TV，无论其流畅度、清晰度、用户体验都堪称完美。主要的优点：</p>
<ol>
<li>强大的 Infuse 软件用来查看蓝光光源、杜比视界，绝对不是 1080P 的片源可以比的。</li>
<li>苹果一如既往丝滑般的体验。无论是操作系统，还是遥控器，其用户体验都能吊打一众安卓盒子。</li>
<li>可在 Netflix、Disney+、Apple TV+ 追剧。要想在设备上播放 Netflix，是需要授权的，国内的电视盒子一概不支持。</li>
<li>无广告。</li>
</ol>
<p>虽然想体验一把最好的看电视体验，但存在如下两个问题导致我最终放弃了 Apple TV：</p>
<ol>
<li>无法看国内的”爱优腾“。投影仪的主要使用方并非我自己，而更多的是家人，没有国内的”爱优腾“，查看片源过于复杂，使用体验将大打折扣。</li>
<li>Netflix 和 Disney+ 并非强需求。Apple TV 用来追剧非常方便，但我个人并没有太多的时间用来追剧，而且还需要魔法，追剧还需要付费，使用成本整体并不低。</li>
</ol>
<h2 id="国产电视盒子"><a href="#国产电视盒子" class="headerlink" title="国产电视盒子"></a>国产电视盒子</h2><p>网上可以买到各式各样的电视盒子，当贝、小米、腾讯极光等，整体特点：</p>
<ol>
<li>均基于 Android TV 系统，又叠加了自己的桌面应用。</li>
<li>厂商均不靠硬件赚钱，而是靠 VIP 会员赚钱，因此所有的电视盒子均需要充值 VIP，没有了 VIP 也就剩下一个盒子了，基本上看不了多少片源。</li>
<li>各种开机广告、开屏广告满天飞。</li>
</ol>
<p>下单销量排名靠前的当贝盒子后，体验一番后，大失所望。虽然如宣传的一般没有了开机广告，但进入系统后没有 VIP 寸步难行，每个视频右下角都会带一个灰色的 VIP logo。我的选择逻辑，既然”爱优腾“的会员在所难免，毕竟还有手机端 app 看视频的需求，再买一个盒子 VIP 的意义何在。如果盒子 VIP 不买，那盒子自身系统提供的片源很多就是个摆设。实在无法容忍，遂退之。</p>
<p>国产的电视盒子没有一个能打的，整个产品的定位全跑偏了。如果能有一个干净、用户体验好的电视盒子可以给到用户，哪怕卖得贵一点（毕竟就要靠卖硬件赚钱了），我相信也是有市场的。</p>
<h2 id="树莓派"><a href="#树莓派" class="headerlink" title="树莓派"></a>树莓派</h2><p>看了下 Android TV 的原生系统后，更加符合自己的需求，干净清爽，而且还可以刷 Google 服务包，用来安装 Google 全家桶应用。所以就开始考虑自己刷机使用 Android TV。要想刷机必须先有盒子，盒子的选型有如下几个：</p>
<ol>
<li>国产电视盒子。可在国产电视盒子的硬件上刷 Android TV 系统。</li>
<li>其他 Arm 架构的盒子。比如非常流行的斐讯 N1 盒子，曾经用于挖矿，现在却在软路由领域焕发出了新的生机。</li>
<li>开发版。最为流行的树莓派，还有友善 NanoPi 开发版、Banana Pi，均为基于 ARM 架构。</li>
</ol>
<p>我最终选择了树莓派 5 作为电视盒子，主要考虑如下：</p>
<ol>
<li>性能强大，用来作为电视盒子性能是过剩的。</li>
<li>可玩性强。即使作为电视盒子翻车了，还可以用来作为小型服务器，跑 Home Assiant、TeslaMate 等应用，甚至可以作为 NAS 使用。</li>
<li>用户基数大。自己踩到的坑更容易找到解决方案。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>投影仪完成后，且电视盒子也选好了，接下来将另起一篇文章讲解下我的树莓派刷 Android TV 系统的折腾经历，自己选择的路线，查再多的资料，刷再多的机，也要折腾成功。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ax6000-clash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ax6000-clash/" class="post-title-link" itemprop="url">红米路由器 AX6000 科学上网</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-11 01:12:10" itemprop="dateCreated datePublished" datetime="2024-02-11T01:12:10+00:00">2024-02-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在上篇文章《红米路由器 AX6000 解锁 SSH》中，解锁了红米路由器 AX6000 的 SSH 功能，本文在此基础上安装 clash，用来科学上网。</p>
<h1 id="安装-clash"><a href="#安装-clash" class="headerlink" title="安装 clash"></a>安装 clash</h1><p>通过 ssh 命令连接到红米路由器，执行如下 shell 命令，即可下载并安装 clash 软件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/openclash &amp;&amp; cd /data/openclash</span><br><span class="line">export url=&#x27;https://raw.fastgit.org/juewuy/ShellClash/master&#x27;</span><br><span class="line">curl -kfsSl $url/install.sh &gt; install.sh</span><br><span class="line">sh install.sh</span><br></pre></td></tr></table></figure>

<p>会出现如下的提示：<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-1.png" alt="image.png"><br>install.sh 会将 ShellCrash 安装到 &#x2F;data&#x2F;ShellCrash 目录下。</p>
<h1 id="clash-配置"><a href="#clash-配置" class="headerlink" title="clash 配置"></a>clash 配置</h1><p>在安装完 clash 后，输入 clash 命令即可对 clash 进行管理，该操作有点类似于打客户电话的操作。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-2.png" alt="image.png"></p>
<h1 id="clash-UI"><a href="#clash-UI" class="headerlink" title="clash UI"></a>clash UI</h1><p>通过上述 clash 命令可以安装 clash UI，可以通过网址 <a target="_blank" rel="noopener" href="http://192.168.31.1:9999/ui">http://192.168.31.1:9999/ui</a> 访问。UI 的功能较 clash 的客户端更为简单，但也可以弥补上述 clash 命令的很多不足之处。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-ui.png" alt="image.png"></p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=e90UWDpAlxA">https://www.youtube.com/watch?v=e90UWDpAlxA</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ax6000-ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ax6000-ssh/" class="post-title-link" itemprop="url">红米路由器 AX6000 解锁 SSH</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-11 00:20:15" itemprop="dateCreated datePublished" datetime="2024-02-11T00:20:15+00:00">2024-02-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>半年前购买了红米路由器 AX6000，用起来一直非常稳定。因为最近在折腾树莓派，准备将红米路由器上开启 SSH 的功能。最早是准备将路由器刷成 <a target="_blank" rel="noopener" href="https://openwrt.org/toh/xiaomi/redmi_ax6000">OpenWRT 系统</a>，当一旦路由器能够开启 SSH 功能后，刷 OpenWRT 系统的必要性就不是太大了。</p>
<blockquote>
<p>声明：本文下面操作步骤均为从网络上获取的现有操作步骤。</p>
</blockquote>
<p>在电脑的浏览器上登录红米路由器的管理页面，红米路由器管理页面为：<a target="_blank" rel="noopener" href="https://miwifi.com/">https://miwifi.com/</a>，或者 <a target="_blank" rel="noopener" href="http://192.168.31.1/">http://192.168.31.1/</a>。如果本地设置过其他的 DNS 服务器，需要使用 ip 地址的形式访问。<br>登录后可以获取到当前红米路由器的版本，我的已经是最新的 1.0.67，该版本的固件可以支持开启 SSH 协议。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/ax6000-version.png" alt="image.png"><br>在登录红米路由器管理页面后，查看浏览器的地址栏，<code>https://miwifi.com/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/web/home#router</code>，可以看到参数 stok <code>5e55c58e949d5419c001bce8288e5a27</code> 即我们需要用到该值。需要注意的是参数 stok 在每次登录时均会发生改变。</p>
<p>用浏览器打开下面的网址，其中 stok 为上面步骤获取到的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/api/misystem/set_sys_time?timezone=%20%27%20%3B%20zz%3D%24%28dd%20if%3D%2Fdev%2Fzero%20bs%3D1%20count%3D2%202%3E%2Fdev%2Fnull%29%20%3B%20printf%20%27%A5%5A%25c%25c%27%20%24zz%20%24zz%20%7C%20mtd%20write%20-%20crash%20%3B%20</span><br></pre></td></tr></table></figure>
<p>浏览器如果返回<code>&#123;&quot;code&quot;:0&#125;</code>，说明该步骤执行成功。</p>
<p>在浏览器执行路由器重启操作，返回 <code>&#123;&quot;code&quot;:0&#125;</code>，说明该步骤执行成功，此时路由器会发生重启。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20</span><br></pre></td></tr></table></figure>

<p>重新登录红米路由器，获取到新的 stok 值 221bcd3ba09b3e4597b0308cc1df18a2。<br>在浏览器继续访问如下的地址，用来开启 telnet，成功后仍然返回 <code>&#123;&quot;code&quot;:0&#125;</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=221bcd3ba09b3e4597b0308cc1df18a2/api/misystem/set_sys_time?timezone=%20%27%20%3B%20bdata%20set%20telnet_en%3D1%20%3B%20bdata%20set%20ssh_en%3D1%20%3B%20bdata%20set%20uart_en%3D1%20%3B%20bdata%20commit%20%3B%20</span><br></pre></td></tr></table></figure>

<p>再继续执行重启命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=221bcd3ba09b3e4597b0308cc1df18a2/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20</span><br></pre></td></tr></table></figure>

<p>在重启完成后，路由器的 telnet 服务已经开启。在终端中执行 <code>telnet 192.168.31.1</code> 即可远程连接到小米路由器，而且不需要密码。</p>
<p>在终端中执行如下的命令，用来设置 root 密码，开启并固化 ssh 服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 修改 root 密码</span><br><span class="line">echo -e &#x27;wangss19881.\nwangss19881.&#x27; | passwd root</span><br><span class="line"></span><br><span class="line"># 开启 ssh 服务</span><br><span class="line">nvram set ssh_en=1</span><br><span class="line">nvram set telnet_en=1</span><br><span class="line">nvram set uart_en=1</span><br><span class="line">nvram set boot_wait=on</span><br><span class="line">nvram commit</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s/channel=.*/channel=&quot;debug&quot;/g&#x27; /etc/init.d/dropbear</span><br><span class="line">/etc/init.d/dropbear restart</span><br><span class="line"></span><br><span class="line"># 设置 ssh 服务开机自启动</span><br><span class="line">mkdir /data/auto_ssh</span><br><span class="line">cd /data/auto_ssh</span><br><span class="line">curl -O https://fastly.jsdelivr.net/gh/lemoeo/AX6S@main/auto_ssh.sh</span><br><span class="line">chmod +x auto_ssh.sh</span><br><span class="line">uci set firewall.auto_ssh=include</span><br><span class="line">uci set firewall.auto_ssh.type=&#x27;script&#x27;</span><br><span class="line">uci set firewall.auto_ssh.path=&#x27;/data/auto_ssh/auto_ssh.sh&#x27;</span><br><span class="line">uci set firewall.auto_ssh.enabled=&#x27;1&#x27;</span><br><span class="line">uci commit firewall</span><br><span class="line"></span><br><span class="line"># 设置时区</span><br><span class="line">uci set system.@system[0].timezone=&#x27;CST-8&#x27;</span><br><span class="line">uci set system.@system[0].webtimezone=&#x27;CST-8&#x27;</span><br><span class="line">uci set system.@system[0].timezoneindex=&#x27;2.84&#x27;</span><br><span class="line">uci commit</span><br><span class="line"></span><br><span class="line"># 关闭开发模式</span><br><span class="line">mtd erase crash</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>在终端中执行 <code>ssh -o HostkeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa  root@192.168.31.1</code>即可 ssh 连接到路由器。</p>
<p>进入到系统后我们可以看到系统为基于 Linux 5.4 内核版本的 XiaoQiang 系统，至于名字为什么叫 XiaoQiang 我还不得而知。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# uname -a</span><br><span class="line">Linux XiaoQiang 5.4.150 #0 SMP Mon Jan 30 09:23:25 2023 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p>整个磁盘分区的使用情况如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">/dev/root                15.5M     15.5M         0 100% /</span><br><span class="line">tmpfs                   240.0M      9.9M    230.1M   4% /tmp</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /data</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /userdisk</span><br><span class="line">/dev/root                15.5M     15.5M         0 100% /userdisk/data</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/config</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/datacenterconfig</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/smartcontroller</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/parentalctl</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/smartvpn</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/ppp</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/crontabs</span><br><span class="line">tmpfs                   512.0K     12.0K    500.0K   2% /dev</span><br></pre></td></tr></table></figure>

<p>使用 top 命令查看整体的系统负载情况，cpu 利用率还是非常低。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mem: 325692K used, 165808K free, 11208K shrd, 12652K buff, 76388K cached</span><br><span class="line">CPU:  0.3% usr  1.3% sys  0.0% nic 97.8% idle  0.0% io  0.0% irq  0.4% sirq</span><br><span class="line">Load average: 1.05 1.06 1.12 2/147 28107</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=u5Qg4zqj_V0">https://www.youtube.com/watch?v=u5Qg4zqj_V0</a><br><a target="_blank" rel="noopener" href="https://uzbox.com/tech/openwrt/ax6000.html">https://uzbox.com/tech/openwrt/ax6000.html</a><br><a target="_blank" rel="noopener" href="https://github.com/kjfx/AX6000/releases/tag/RedmiAX6000">https://github.com/kjfx/AX6000/releases/tag/RedmiAX6000</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/vcluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/vcluster/" class="post-title-link" itemprop="url">k8s virtual cluster 方案 - vCluster</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-29 20:23:05" itemprop="dateCreated datePublished" datetime="2023-11-29T20:23:05+00:00">2023-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ul>
<li>host cluster：virtual cluster 中的宿主 k8s 集群，承载了所有的计算资源。也会被叫做 super cluster。</li>
<li>virtual cluster：virtual cluster 中的租户 k8s 集群，通常简写 vc。也会被叫做 tenant cluster。</li>
<li>vCluster：k8s virtual cluster 的实现之一，即本文中要介绍的方案。</li>
</ul>
<h1 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h1><h2 id="k8s-的多租功能"><a href="#k8s-的多租功能" class="headerlink" title="k8s 的多租功能"></a>k8s 的多租功能</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-compare.png" alt="image.png"><br>k8s 自身在多租的能力上支持较差，提供了 namespace 级别的隔离，不同的租户使用不同的 namespace，但该隔离功能较弱。很多组件部署在同一个 workload 会存在诸多问题：</p>
<ol>
<li>使用全局对象存在冲突，比如 CRD。</li>
<li>存在诸多安全性问题，比如多个租户之间的 pod 完全可以互访，没有任何隔离机制。</li>
<li>不同组件对于 k8s 的版本不统一。</li>
</ol>
<p>为了解决多租的问题，最简单的思路就是使用多 k8s 集群，业界的 KubeFed v2、karmada、clusternet、OCM 等均为多 k8s 集群的实现。但多 k8s 集群因为存在独立的控制面和计算资源，存在资源消耗过多的问题。</p>
<p>还有一个中间思路为仅做 k8s 的控制面隔离，计算资源仍然共享，即 pod 也可以解决很多的多租隔离问题。k8s 的控制面隔离又存在两个主要方案：</p>
<ol>
<li>独立的 kube-apiserver 和 etcd、kube-controller-manager， kube-scheduler 共享 host cluster。该方案中有独立的 kube-apiserver 组件，这里的 etcd 可以被 sqllite、mysql 等存储取代。该方案统称为 virtual cluster，简称为 vc。</li>
<li>独立的 proxy apiserver，kube-apiserver、kube-controller-manager、kube-scheduler 共享 host cluster。访问 k8s 的请求先到 proxy apiserver，proxy apiserver 转发到 host cluster 的 kube-apiserver。可以在 proxy apiserver 中提供独立的 RBAC 机制，实现一定程度的隔离。该方案在开源中未看到具体的实现。</li>
</ol>
<h2 id="vCluster-介绍"><a href="#vCluster-介绍" class="headerlink" title="vCluster 介绍"></a>vCluster 介绍</h2><p><a target="_blank" rel="noopener" href="https://github.com/loft-sh/vcluster">vCluster</a> 为 virtual cluster 的开源实现之一，由 Loft Labs 提供，Github Star 3.7K，代码行数 4 万行。除了开源版本外，还提供了商业版本 vCluster PRO。</p>
<p>vCluster 设计原则：</p>
<ol>
<li>最小化资源占用。在实现上使用了单 pod 的 k3s 作为 k8s 的控制面。</li>
<li>复用 host cluster 的计算、存储和网络资源。</li>
<li>降低对 host cluster 的请求。</li>
<li>简单灵活。</li>
<li>不需要 host cluster 的管理员权限。</li>
<li>vCluster 多个 namespace 下的对象映射到 host cluster 的同一个 namespace 下。同时也可以支持 vCluster 的一个 namespace 对应 host cluster 的一个 namespace。</li>
<li>易清理。</li>
</ol>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><h2 id="k8s-集群准备"><a href="#k8s-集群准备" class="headerlink" title="k8s 集群准备"></a>k8s 集群准备</h2><p>k8s 集群这里使用了 kind 方案，kind 配置 kind.conf 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">vcluster</span></span><br><span class="line"><span class="attr">nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="comment"># 如果需要 ingress，则需要指定该参数</span></span><br><span class="line">  <span class="attr">kubeadmConfigPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">    kind: InitConfiguration</span></span><br><span class="line"><span class="string">    nodeRegistration:</span></span><br><span class="line"><span class="string">      kubeletExtraArgs:</span></span><br><span class="line"><span class="string">        node-labels: &quot;ingress-ready=true&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">extraPortMappings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="comment"># 指定 k8s 版本，默认不指定</span></span><br><span class="line">  <span class="comment"># image: kindest/node:v1.23.17</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">apiServerPort:</span> <span class="number">6443</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>kind create cluster --config kind.conf</code> 即可创建 k8s 集群，包含了一个 control-plane 节点，三个 worker 节点。</p>
<h2 id="安装-vcluster"><a href="#安装-vcluster" class="headerlink" title="安装 vcluster"></a>安装 vcluster</h2><p>vCluster 提供了使用 vcluster cli、helm 和 kubectl 三种安装方式，使用 vcluster cli 最为简单，其底层同样采用 helm chart 的方式部署，下面采用 vcluster cli 的方式进行安装。<br>安装 vcluster cli 工具：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-L</span> <span class="string">-o</span> <span class="string">vcluster</span> <span class="string">&quot;https://github.com/loft-sh/vcluster/releases/latest/download/vcluster-darwin-arm64&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">sudo</span> <span class="string">install</span> <span class="string">-c</span> <span class="string">-m</span> <span class="number">0755 </span><span class="string">vcluster</span> <span class="string">/usr/local/bin</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">vcluster</span></span><br></pre></td></tr></table></figure>
<p>或者执行 <code>brew install vcluster</code>安装 vcluster 命令行工具。</p>
<p>执行命令 <code>vcluster create my-vcluster</code> 创建 virtual cluster。会在 host cluster 上创建 namespace <code>vcluster-my-vcluster</code>，该 namespace 下创建如下对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                                                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">pod/coredns-68559449b6-l5whx-x-kube-system-x-my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span> <span class="string">(5m45s</span> <span class="string">ago)</span>   <span class="string">3d</span></span><br><span class="line"><span class="string">pod/my-vcluster-0</span>                                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span> <span class="string">(5m45s</span> <span class="string">ago)</span>   <span class="string">3d</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                                              <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                         <span class="string">AGE</span></span><br><span class="line"><span class="string">service/kube-dns-x-kube-system-x-my-vcluster</span>      <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.67</span><span class="number">.119</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>          <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster</span>                               <span class="string">NodePort</span>    <span class="number">10.96</span><span class="number">.214</span><span class="number">.58</span>   <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">:30540/TCP,10250:31621/TCP</span>   <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster-headless</span>                      <span class="string">ClusterIP</span>   <span class="string">None</span>           <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                         <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster-node-vcluster-control-plane</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.69</span><span class="number">.115</span>   <span class="string">&lt;none&gt;</span>        <span class="number">10250</span><span class="string">/TCP</span>                       <span class="string">3d</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">statefulset.apps/my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">3d</span></span><br></pre></td></tr></table></figure>
<p>可以看到在该 namespace 下创建了 coredns 和 StatefulSet my-vcluster。每个租户有独立的 coredns 组件，用来做域名解析。my-vcluster 为 vCluster 的管控面组件，包括了 k8s controller plane 和 syncer 组件。</p>
<p>执行  <code>vcluster connect my-vcluster</code> 后会在本地启动代理，并自动切换本地的 kubeconfig context，将 context 切换到 virtual cluster。执行 kubectl 命令即可连接到对应的 k8s 集群。virtual cluster 集群中的信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all</span> <span class="string">-A</span></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">pod/coredns-68559449b6-jg2bs</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(20m</span> <span class="string">ago)</span>   <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                 <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                  <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">service/kube-dns</span>     <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.120</span><span class="number">.59</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>   <span class="string">51m</span></span><br><span class="line"><span class="string">default</span>       <span class="string">service/kubernetes</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.35</span><span class="number">.53</span>    <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                  <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">deployment.apps/coredns</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                                 <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">replicaset.apps/coredns-68559449b6</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="string">51m</span></span><br></pre></td></tr></table></figure>
<p>在 virtual cluster 可以看到仅包含了 coredns 组件。</p>
<p>在 virtual cluster 和在 host cluster 中的 node 信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">STATUS</span>   <span class="string">ROLES</span>    <span class="string">AGE</span>   <span class="string">VERSION</span>   <span class="string">INTERNAL-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">OS-IMAGE</span>                         <span class="string">KERNEL-VERSION</span>     <span class="string">CONTAINER-RUNTIME</span></span><br><span class="line"><span class="string">vcluster-worker3</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">51m</span>   <span class="string">v1.27.3</span>   <span class="number">10.96</span><span class="number">.118</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">STATUS</span>   <span class="string">ROLES</span>           <span class="string">AGE</span>   <span class="string">VERSION</span>   <span class="string">INTERNAL-IP</span>   <span class="string">EXTERNAL-IP</span>   <span class="string">OS-IMAGE</span>                         <span class="string">KERNEL-VERSION</span>     <span class="string">CONTAINER-RUNTIME</span></span><br><span class="line"><span class="string">vcluster-control-plane</span>   <span class="string">Ready</span>    <span class="string">control-plane</span>   <span class="string">86m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.3</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker</span>          <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker2</span>         <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.5</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker3</span>         <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.4</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br></pre></td></tr></table></figure>
<p>可以看到在 virtual cluster 和 host cluster 中的 node 名字相同，这是因为 node 在 vCluster 中并没有做隔离，而是从 host cluster 中做了同步。但 virtual cluster 中的 node 节点仅包含 pod 在 host cluster 中已经使用的 node 节点，未使用的节点并不会在 virtual cluster 上。<br>同时可以看到 vc 和 host cluster 中的 node ip 地址并不相同，vc 中的 node ip 地址跟 host cluster 中的对应 service clusterip 相同，在 host cluster 中的对应 service 名字为 <code>$vClusterName-node-$hostClusterNodeName</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">my-vcluster-node-vcluster-worker3</span></span><br><span class="line"><span class="string">NAME</span>                                <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>     <span class="string">AGE</span></span><br><span class="line"><span class="string">my-vcluster-node-vcluster-worker3</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.118</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>        <span class="number">10250</span><span class="string">/TCP</span>   <span class="string">3h54m</span></span><br></pre></td></tr></table></figure>

<p>在 virtual cluster 中创建 k8s 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 virtual cluster 创建 namespace</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">namespace/demo-nginx</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Deployment</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">deployment</span> <span class="string">nginx-deployment</span> <span class="string">-n</span> <span class="string">demo-nginx</span> <span class="string">--image=nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 virtual cluster 上创建出了 pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">demo-nginx</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>                                <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                     <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">nginx-deployment-66fb7f764c-dn59g</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">11m</span>   <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span>   <span class="string">vcluster-control-plane</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于 pod 调度了 host cluster 新节点，在 virtual cluster 中可以看到新的 k8s node，k8s node 为刚刚创建</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">STATUS</span>   <span class="string">ROLES</span>    <span class="string">AGE</span>     <span class="string">VERSION</span></span><br><span class="line"><span class="string">vcluster-worker2</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">2m45s</span>   <span class="string">v1.27.3</span></span><br><span class="line"><span class="string">vcluster-worker3</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">57m</span>     <span class="string">v1.27.3</span></span><br></pre></td></tr></table></figure>
<p>在 host cluster 中看到如下对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 host cluster 上并没有对应的 namespace demo-nginx</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">ns</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(NotFound):</span> <span class="string">namespaces</span> <span class="string">&quot;demo-nginx&quot;</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 host cluster 上并没有对应的 deployment nginx-deployment</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-A</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAMESPACE</span>            <span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">ingress-nginx</span>        <span class="string">ingress-nginx-controller</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">90m</span></span><br><span class="line"><span class="string">kube-system</span>          <span class="string">coredns</span>                    <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">91m</span></span><br><span class="line"><span class="string">local-path-storage</span>   <span class="string">local-path-provisioner</span>     <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">91m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但在 host cluster 上却看到了对应的 pod，位于 vcluster 统一的 namespace vcluster-my-vcluster 之下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                                                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">coredns-68559449b6-jg2bs-x-kube-system-x-my-vcluster</span>           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(26m</span> <span class="string">ago)</span>   <span class="string">57m</span></span><br><span class="line"><span class="string">my-vcluster-0</span>                                                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(26m</span> <span class="string">ago)</span>   <span class="string">86m</span></span><br><span class="line"><span class="string">nginx-deployment-66fb7f764c-sffqt-x-demo-nginx-x-my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">2m22s</span></span><br></pre></td></tr></table></figure>
<p>可以看到仅 pod 在 host cluster 中同步存在，而 namespace、deployment 这些对象仅存在于 virtual cluster 中。在 virtual cluster 中创建的多个不同 namespace pod 仅会存在于 host cluster 的同一个 namespace 下。</p>
<h2 id="验证-service"><a href="#验证-service" class="headerlink" title="验证 service"></a>验证 service</h2><p>在 virtual cluster 中创建 service 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>
<p>在 virtual cluster 中包含如下的 Service 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">-n</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">2m11s</span></span><br></pre></td></tr></table></figure>
<p>在 host cluster 中会同步创建如下的 Service 对象，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-uid:</span> <span class="string">5ab7aa9c-90b6-46f9-a162-9ea9ca9826f3</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-28T09:32:22Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-d9125f8911:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">463a503e-d889-49a7-94e0-0cba5299dd47</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;12344&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">fc9ea383-996e-471c-9c27-ee1c22fec7a3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 host cluster 中的 service 的 ClusterIP 跟 virutal cluster 一致，但 spec.selector 字段已经被 syncer 修改，以便可以匹配到正确的 pod。</p>
<h2 id="验证-Ingress"><a href="#验证-Ingress" class="headerlink" title="验证 Ingress"></a>验证 Ingress</h2><p>默认情况下 Ingress 不会同步到 host cluster，需要通过开关的方式启动。创建文件 values.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sync:</span></span><br><span class="line">  <span class="attr">ingresses:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>vcluster create my-vcluster --upgrade -f values.yaml</code> 即可修改现在 vcluster 集群配置。</p>
<p>在 virtual cluster 中创建如下的 Ingress 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.aa.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br></pre></td></tr></table></figure>
<p>查看 host cluster 中的 Ingress 信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">ingress</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-uid:</span> <span class="string">4b8034a6-1513-4ccd-b80a-66807d862b4e</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-28T10:07:52Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">463a503e-d889-49a7-94e0-0cba5299dd47</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;16292&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1d0de02b-5aad-4858-a8cf-2caa345ca85b</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.aa.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostname:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>
<p>可以看到 Ingress 中对应的 Service 名字已经修改了 host cluster 中对应的 Service 名字。</p>
<h2 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h2><p>在使用完成后执行如下命令即可销毁 virtual cluster：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换本地的 context</span></span><br><span class="line">vcluster disconnect</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 vcluster</span></span><br><span class="line">vcluster delete my-vcluster</span><br></pre></td></tr></table></figure>

<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-arch.png" alt="image.png"></p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>整个架构中，有两大核心组件：k8s Control Plane 和 syncer。其中 StatefulSet my-vcluster 中容器 syncer，默认情况下在该容器中同时启动了 k3s 容器作为 vCluster 控制平面和 vCluster 的 syncer 进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it --context kind-vcluster -n vcluster-my-vcluster my-vcluster-0 -- ps -ef</span></span><br><span class="line">Defaulted container &quot;syncer&quot; out of: syncer, vcluster (init)</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      2:57 /vcluster start --name=my-vcluster --kube-config=/data/k3s</span><br><span class="line">   17 root     18:35 /k3s-binary/k3s server</span><br><span class="line">   46 root      0:00 ps -ef</span><br></pre></td></tr></table></figure>

<h3 id="controller-plane"><a href="#controller-plane" class="headerlink" title="controller plane"></a>controller plane</h3><p>控制平面默认使用 k3s，存储使用 sqllite，也可以使用 etcd、mysql、postgresql。k8s 发行版也可以使用 k0s、Vanilla（标准 k8s）、第三方镜像等。控制平面由如下几个组件组成：</p>
<ol>
<li>k8s apiserver。</li>
<li>数据存储，比如 sqllite、etcd 等。</li>
<li>kube-controller-manager</li>
<li>kube-scheduler：可选组件，默认使用 host cluster 调度器。</li>
</ol>
<blockquote>
<p>在 Pro 版本中，允许控制面跟 pod 部署在不同的 host cluster。</p>
</blockquote>
<h3 id="syncer"><a href="#syncer" class="headerlink" title="syncer"></a>syncer</h3><p>virtual cluster 中并不包含实际的计算、存储和网络资源，syncer 的职责为将对象从 virtual cluster 同步到 host cluster，也有少部分对象需要从 host cluster 同步到 virtual cluster。<br>vCluster 将 k8s 对象划分为 low level 和 high level，其中 high level 的对象仅存在于 virtual cluster 中，比如 Deployment、CRD 等对象。low level 的对象会通过 syncer 模块同步到 host cluster 上，包括 Pod、ConfigMap、Secret 等。low level 的对象在 virutal cluster 为多个 namespace，但均会映射到 host cluster 的一个 namespace 下。另外，vCluster 也支持将 virtual cluster 的多个 namespace 映射到 host cluster 的多个 namespace，该特性目前处于 alpha 状态。<br>vCluster 可以通过<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/syncer/other_resources/config_syntax">配置的方式</a>来定制资源的同步，更复杂的同步规则提供了<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/advanced-topics/plugins-overview">插件机制</a>实现。<br>vCluster 默认支持的同步资源列表：<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/syncer/core_resources">https://www.vcluster.com/docs/syncer/core_resources</a>。</p>
<p>已经创建完成的 syncer 配置，可以通过 <code>vcluster create my-vcluster --upgrade -f values.yaml</code> 的方式修改，该命令会调用 helm update，helm update 命令最终会修改 StatefulSet syncer 的配置，并触发 pod 的重启。</p>
<h4 id="k8s-node-同步"><a href="#k8s-node-同步" class="headerlink" title="k8s node 同步"></a>k8s node 同步</h4><p>支持多种 node 的同步行为，通过修改 syncer 的启动参数：</p>
<ol>
<li>Fake Node：默认行为。根据 pod 中的 spec.nodeName 创建 Fake Node。Fake Node 为 syncer 服务自动创建。如果没有 pod 调度到 Fake Node 上，则 Fake Node 会自动删除。</li>
<li>Real Node：根据 pod 中的 spec.nodeName 创建 Real Node，Real Node 的信息从 host cluster 同步。如果没有 pod 调度到 Real Node 上，则 Real Node 会自动删除。</li>
<li>Real Node All：同步 host cluster 的所有 node 到 virtual cluster。如果要使用 DaemonSet，需要使用该模式。</li>
<li>Real Nodes Label Selector：仅同步 label selector 匹配的 host node 到 virtual cluster 中。</li>
<li>Real Nodes + Label Selector：仅同步包含在 pod spec.nodeName 且 Label selector 可以选中的 host cluster node 到 virtual cluster 中。</li>
</ol>
<h2 id="pod-调度"><a href="#pod-调度" class="headerlink" title="pod 调度"></a>pod 调度</h2><p>默认情况下，virtual cluster 中的 pod 调度会使用 host cluster 的调度，但存在如下的问题：</p>
<ol>
<li>在 virtual cluster node 上的 label 对于 pod 调度不会生效。</li>
<li>drait、trait 命令对于 virtual cluster 上的 pod 没有影响。</li>
<li>virtual cluster 中使用自定义调度器不生效。</li>
</ol>
<p>基于上述限制，vCluster 支持如下两种方案：</p>
<ol>
<li>支持在 virtual cluster 中使用独立的调度器。可以给 virtual cluster 上的 node 增加标签、污点等信息，pod 的调度在 virtual cluster 中的调度器实现，syncer 组件仅将已经调度完成的 pod 同步到 host cluster。</li>
<li>仍然复用 host cluster 调度器，但做了部分功能的增强：在 syncer 服务中指定仅同步部分 host node 到 virtual cluster 中，这样 pod 就仅会调度到 host cluster 的特定 node 上。</li>
</ol>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>virutal cluster 中无独立的 pod 网络和 service 网络，完全复用 host cluster 的网络。</p>
<h3 id="Service-网络"><a href="#Service-网络" class="headerlink" title="Service 网络"></a>Service 网络</h3><ol>
<li>会从 virtual cluster 同步到 host cluster，两者的 clusterip 一致。</li>
<li>允许将一些 host cluster 中的 service 同步到 virtual cluster 中，同时指定service 的名字。</li>
<li>允许将 virtual cluster 中的 service 同步到 host cluster 中，同时指定service 的名字。</li>
</ol>
<h3 id="Ingress-网络"><a href="#Ingress-网络" class="headerlink" title="Ingress 网络"></a>Ingress 网络</h3><p>允许将 virtual cluster 中的 Ingress 同步到 host cluster，以便复用 host cluster 中的 Ingress Controller。</p>
<h3 id="DNS-解析"><a href="#DNS-解析" class="headerlink" title="DNS 解析"></a>DNS 解析</h3><p>在 virtual cluster 中部署了单独的 coredns 组件，默认情况下，在 vritual cluster 中的域名仅能解析内部的域名，不能解析 host cluster 上的域名。可以通过开关的方式，将 virtual cluster 中的域名解析转发到 host cluster 的 coredns。</p>
<blockquote>
<p>在 PRO 版本中，coredns 组件可以集成到 syncer 组件内部，以便节省资源。</p>
</blockquote>
<h3 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h3><p>默认情况下，vcluster 中会忽略 virtual cluster 中的 NetworkPolicy 资源。可以通过开关的方式打开该配置，即可将 NetworkPolicy 规则同步到 host cluster。</p>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-pv.png" alt="image.png"><br>默认情况下，host StorageClass 不会同步到 vc，可以通过开关的方式打开同步。<br>默认情况下，pv 不会从 vc 同步到 host cluster，可以通过开关的方式打开。</p>
<h2 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h2><h3 id="monitoring"><a href="#monitoring" class="headerlink" title="monitoring"></a>monitoring</h3><p>metrics-server 用来监控 k8s 的 Deployment、StatefulSet 等对象，metrics-server 可以复用 host cluster 中的，但需要启用 metrics server proxy 功能。也可以在 vc 中单独部署一套 metrics server。<br>在 vc 集群中，由于每个 k8s node 的 ip 地址为 host cluster 中的 service clusterip，在 vc 中网络是可达的，可以获取到对应的监控信息。</p>
<h3 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h3><p>需要用到Hostpath Mapper组件，该组件为 DaemonSet 的形式。后续即可以部署 loki 等组件。</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h3 id="隔离模式"><a href="#隔离模式" class="headerlink" title="隔离模式"></a>隔离模式</h3><p>在启动的时候指定<code>--isolate</code>，在该模式下对 workload 做了多种限制。</p>
<ol>
<li>对 vcluster pod 的 Pod Security 做限制，不符合规范的 pod 不会同步到 host cluster。</li>
<li>可以对 vc 中 pod 的总资源量做限制。</li>
<li>在 host cluster 上通过 NetworkPolicy 做隔离。</li>
</ol>
<h2 id="virtual-cluster-集群的创建"><a href="#virtual-cluster-集群的创建" class="headerlink" title="virtual cluster 集群的创建"></a>virtual cluster 集群的创建</h2><p>目前仅能通过 vcluster cli、helm 的方式来创建，底层均为 helm chart 的方式来管理，缺少服务化功能。</p>
<h2 id="virtual-cluster-集群对外暴露方法"><a href="#virtual-cluster-集群对外暴露方法" class="headerlink" title="virtual cluster 集群对外暴露方法"></a>virtual cluster 集群对外暴露方法</h2><h3 id="获取-kubeconfig"><a href="#获取-kubeconfig" class="headerlink" title="获取 kubeconfig"></a>获取 kubeconfig</h3><h4 id="vcluster-connect-命令"><a href="#vcluster-connect-命令" class="headerlink" title="vcluster connect 命令"></a>vcluster connect 命令</h4><p>该命令可以修改本地的 kubeconfig 文件，并将 context 切换为 virtual cluster context。默认为 virutual cluster 的管理员权限，可以指定使用特定的 ServiceAccount。</p>
<h4 id="host-cluster-secret-中获取到-kubeconfig"><a href="#host-cluster-secret-中获取到-kubeconfig" class="headerlink" title="host cluster secret 中获取到 kubeconfig"></a>host cluster secret 中获取到 kubeconfig</h4><p>在 host cluster 中，在 vc 的 namespace 下，存在一个以 <code>vc-</code> 开头的 Secret，该 Secret 中保存了 kubeconfig 完整信息。</p>
<h3 id="vc-集群中的-apiserver-的暴露地址"><a href="#vc-集群中的-apiserver-的暴露地址" class="headerlink" title="vc 集群中的 apiserver 的暴露地址"></a>vc 集群中的 apiserver 的暴露地址</h3><p>可以在 syncer 启动的时候指定获取的 kubeconfig 中的 endpoint 地址。endpoint 地址即为 vc 集群中的 kube-apiserver 的地址，该 kube-apiserver 的地址可以通过 host cluster 中的 Ingress、LoadBalancer Service、NodePort Service 等方式对外暴露。</p>
<h2 id="高可用设计"><a href="#高可用设计" class="headerlink" title="高可用设计"></a>高可用设计</h2><h3 id="control-plane-高可用"><a href="#control-plane-高可用" class="headerlink" title="control plane 高可用"></a>control plane 高可用</h3><p>k3s 可以支持高可用架构，在创建 vc 的时候通过指定的副本的方式来设置高可用。其他的 k8s 发行版同样类似的实现。</p>
<h3 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h3><p>vCluster 本身并没有提供对于 vc 集群的数据备份与恢复功能，可以通过通用的 velero 方式实现备份与恢复功能。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>未做网络隔离，容器网络和 service 网络仍然在同一个平面，要想相互隔离，必须使用 NetworkPolicy。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ol>
<li>获取 helm chart 到本地</li>
</ol>
<pre><code class="shell">helm repo add lofts https://charts.loft.sh/
helm fetch lofts/vcluster
``
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-CSI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-CSI/" class="post-title-link" itemprop="url">k8s CSI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-23 22:56:40" itemprop="dateCreated datePublished" datetime="2023-11-23T22:56:40+00:00">2023-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI</a>：Container Storage Interface (CSI)</p>
<p>Volume 的三个阶段：</p>
<ol>
<li>Provision and Delete：负责卷的创建以及销毁。</li>
<li>Attaching and Detaching：将卷设备挂载到本地或者从本地卸载。</li>
<li>Mount and Umount：将 Attaching 的块设备以目录形式挂载到 pod中，或者从 pod 中卸载块设备。</li>
</ol>
<h1 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h1><p>CSI 插件分为三个部分：</p>
<ol>
<li>CSI Identity：用来获取 CSI 的身份信息</li>
<li>CSI Controller</li>
<li>CSI Node</li>
</ol>
<p>参考 k8s 官方的 hostpath 项目：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/csi-driver-host-path">https://github.com/kubernetes-csi/csi-driver-host-path</a></p>
<p>为了方便开发，在每个阶段 k8s 官方均实现了对应的 SideCarSet 容器。要想研发，仅需要实现 grpc server，又 SideCarSet 容器调用自研的容器。</p>
<p>自研的容器需要实现如下的接口即可。</p>
<h2 id="CSI-Identity"><a href="#CSI-Identity" class="headerlink" title="CSI Identity"></a>CSI Identity</h2><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Identity</span> &#123;</span><br><span class="line">  <span class="comment">// 返回插件名字以及版本号</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginInfo(GetPluginInfoRequest) <span class="keyword">returns</span> (GetPluginInfoResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回插件的包含的功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginCapabilities(GetPluginCapabilitiesRequest) <span class="keyword">returns</span> (GetPluginCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Probe (ProbeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ProbeResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>External provisioner 会调用该接口。</p>
<h2 id="CSI-Controller"><a href="#CSI-Controller" class="headerlink" title="CSI Controller"></a>CSI Controller</h2><p>实现 Volume 中的 Provisioning and Deleting 和 Attaching and Detaching 两个阶段的功能。只有块存储 CSI 插件才需要 Attach 功能。<br>该部分以中心化组件的方式部署，比如 Deployment。Provision 功能对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-provisioner">external-provisioner</a>，Attach 对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-attacher">external-attacher</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Controller</span> &#123;</span><br><span class="line">  <span class="comment">// Provisioning， External provisioner调用</span></span><br><span class="line">  <span class="comment">// hostPath 实现中会调用 fallocate 实现</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateVolume (CreateVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Deleting， External provisioner调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteVolume (DeleteVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Attaching, 只有块设备才需要实现，比如云盘，由External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerPublishVolume (ControllerPublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerPublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Detaching，External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ValidateVolumeCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListVolumes (ListVolumesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListVolumesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetCapacity (GetCapacityRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetCapacityResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetCapabilities (ControllerGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateSnapshot (CreateSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteSnapshot (DeleteSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListSnapshots (ListSnapshotsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListSnapshotsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerExpandVolume (ControllerExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetVolume (ControllerGetVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerModifyVolume (ControllerModifyVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerModifyVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CSI-Node"><a href="#CSI-Node" class="headerlink" title="CSI Node"></a>CSI Node</h2><p>实现 Volume 中的Mount 和 Umount 阶段，由 kubelet 负责调用。<br>该部分以 DaemonSet 的形式部署在每个 k8s node 上，对应的 SidecarSet 容器为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/node-driver-registrar">node-driver-registrer</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="comment">// 针对块存储类型，将块设备格式化后先挂载到一个临时全局目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeStageVolume (NodeStageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeStageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnstageVolume (NodeUnstageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnstageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是块存储设备，在执行完 NodeStageVolume 后，使用 linux 的 bind mount 技术将全局目录挂载到pod 中的对应目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodePublishVolume (NodePublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodePublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnpublishVolume (NodeUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetVolumeStats (NodeGetVolumeStatsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetVolumeStatsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeExpandVolume(NodeExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetCapabilities (NodeGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetInfo (NodeGetInfoRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetInfoResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>协议：<a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/PXE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/PXE/" class="post-title-link" itemprop="url">PXE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-12 20:12:55" itemprop="dateCreated datePublished" datetime="2023-10-12T20:12:55+00:00">2023-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>重装过电脑操作系统的同学大概知道操作系统的安装流程如下：</p>
<ol>
<li>在 BIOS 中将系统设置为光驱&#x2F;USB开机优先模式</li>
<li>以DVD或者 U 盘中的操作系统开机，进入到装机界面</li>
<li>完成一系列的装机初始化，比如磁盘分区、语言选择等</li>
<li>重启进入新安装的操作系统</li>
</ol>
<p>以上过程必须要手工才能完成，安装一台电脑还可以，但如果要大批量安装一批机器就不适用了。为此，Intel 公司研发了 PXE(Pre-boot Execution Environment) 技术，可以通过网络的方式批量安装操作系统。</p>
<p>PXE 基于 C&#x2F;S 架构，分为PXE client 和PXE server，其中 PXE client 为要安装操作系统的机器，PXE server 用来提供安装操作系统必须的镜像等信息。要想实现从网络上安装操作系统，必须要解决如下几个问题：</p>
<ol>
<li>因为还没有安装操作系统，此时并不存在 ip 地址，在装机之前必须要获取到一个 ip 地址。</li>
<li>安装操作系统需要的 boot loader 和操作系统镜像如何获取。</li>
</ol>
<p>为了解决 PXE client 的 ip 地址问题，PXE 中采用了 DHCP 协议来给 client 分配 ip 地址，这就要求 PXE server 必须要运行 dhcp server。为了解决 PXE server 可以提供 boot loader 和操作系统基线，PXE server 通过 tftp 协议的方式对 client 提供服务。</p>
<p>client 端需要 DHCP client 和 tftp client 的功能，为此 PXE 协议中将该功能以硬件的方式内置在网卡 ROM 中。当启动时，BIOS 会加载内置在网卡中的 ROM，从而该机器具备了 DHCP client 和 tftp client 的功能。</p>
<p>优点：</p>
<ol>
<li>规模化：可以批量实现多台服务器的安装</li>
<li>自动化：可以自动化安装</li>
<li>远程实现：不用本地的光盘来安装 OS</li>
</ol>
<p>客户机的前提条件：</p>
<ol>
<li>网络必须要支持 PXE 协议</li>
<li>主板支持网络引导，一般在 BIOS 中可以配置</li>
</ol>
<p>服务端：</p>
<ol>
<li>DHCP 服务，用来给客户机分配 ip 地址</li>
<li>TFTP 服务：用来提供操作系统文件的下载</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/tcp-fast-open/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/tcp-fast-open/" class="post-title-link" itemprop="url">TCP Fast Open</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 23:46:40" itemprop="dateCreated datePublished" datetime="2023-09-30T23:46:40+00:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/tcp_fast_open.webp"></p>
<p>TCP Fast Open（TFO）是一种TCP协议的扩展，旨在加快建立TCP连接的速度和降低延迟。传统的TCP连接需要进行三次握手（SYN-SYN&#x2F;ACK-ACK）才能建立连接，而TFO允许在第一个数据包中携带连接建立的请求。</p>
<p>TFO的工作原理如下：</p>
<ol>
<li>客户端在首次建立TCP连接时，在发送的SYN包中插入一个加密的Cookie。这个Cookie由服务器生成并发送给客户端。</li>
<li>当客户端发送带有TFO Cookie的SYN包到服务器时，服务器会验证Cookie的有效性。</li>
<li>如果Cookie有效，服务器会立即发送带有SYN+ACK标志的数据包，这样客户端就可以立即发送数据而无需等待ACK响应。</li>
<li>客户端收到带有SYN+ACK标志的数据包后，发送带有ACK标志的数据包，建立完整的TCP连接。</li>
</ol>
<h1 id="相关内核参数"><a href="#相关内核参数" class="headerlink" title="相关内核参数"></a>相关内核参数</h1><h2 id="net-ipv4-tcp-fastopen"><a href="#net-ipv4-tcp-fastopen" class="headerlink" title="net.ipv4.tcp_fastopen"></a><code>net.ipv4.tcp_fastopen</code></h2><p>支持如下值：</p>
<ul>
<li>0：关闭</li>
<li>1: 作为客户端可以使用 TFO 功能</li>
<li>2: 作为服务端可以使用 TFO 功能</li>
<li>3: 作为客户端和服务端均可使用 TFO</li>
</ul>
<h2 id="net-ipv4-tcp-fastopen-key"><a href="#net-ipv4-tcp-fastopen-key" class="headerlink" title="net.ipv4.tcp_fastopen_key"></a><code>net.ipv4.tcp_fastopen_key</code></h2><p>用来产生 TFO 的 Cookie。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-service/" class="post-title-link" itemprop="url">k8s 集群内 dns 规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-12 12:05:42" itemprop="dateCreated datePublished" datetime="2023-09-12T12:05:42+00:00">2023-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="zone-设置"><a href="#zone-设置" class="headerlink" title="zone 设置"></a>zone 设置</h1><p>DNS 记录的 zone 信息为全局配置，配置地方包括 kubelet 和 coredns 两部分。</p>
<h2 id="kubelet-的启动参数"><a href="#kubelet-的启动参数" class="headerlink" title="kubelet 的启动参数"></a>kubelet 的启动参数</h2><ol>
<li>通过 kubelet 的 yaml 配置文件的 clusterDomain 字段。</li>
<li>通过 kubelet 的参数 <code>--cluster-domain</code>。</li>
</ol>
<p>设置了 kubelet 的启动参数后，会设置容器的 &#x2F;etc&#x2F;resolv.conf 中的 search 域为如下格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local tbsite.net</span><br><span class="line">nameserver 10.181.48.10</span><br><span class="line">options ndots:5 single-request-reopen</span><br></pre></td></tr></table></figure>

<p>其中 search 域中的 cluster.local 为 kubelet 的配置。</p>
<h2 id="coredns-的配置文件"><a href="#coredns-的配置文件" class="headerlink" title="coredns 的配置文件"></a>coredns 的配置文件</h2><p>coredns controller 需要 watch k8s 集群中的 pod 和 service，将其进行注册，因此 coredns 需要知道集群的 zone 配置。该配置信息位于 coredns 的配置文件 ConfigMap kube-system&#x2F;coredns 中，默认的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Corefile: |</span><br><span class="line">  .:53 &#123;</span><br><span class="line">      errors</span><br><span class="line">      health &#123;</span><br><span class="line">         lameduck 5s</span><br><span class="line">      &#125;</span><br><span class="line">      ready</span><br><span class="line">      kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">         pods insecure</span><br><span class="line">         fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">         ttl 30</span><br><span class="line">      &#125;</span><br><span class="line">      prometheus :9153</span><br><span class="line">      forward . /etc/resolv.conf &#123;</span><br><span class="line">         max_concurrent 1000</span><br><span class="line">      &#125;</span><br><span class="line">      cache 30</span><br><span class="line">      loop</span><br><span class="line">      reload</span><br><span class="line">      loadbalance</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中 cluster.local 为对应的 k8s zone。</p>
<h1 id="域名注册"><a href="#域名注册" class="headerlink" title="域名注册"></a>域名注册</h1><p>在 k8s 中，Service 和 Pod 对象会创建 DNS 记录，用于 k8s 集群内部的域名解析。</p>
<h2 id="Pod-域名注册"><a href="#Pod-域名注册" class="headerlink" title="Pod 域名注册"></a>Pod 域名注册</h2><p>规则一：</p>
<p>每个 k8s pod 都会创建 DNS 记录： <code>&lt;pod_ip&gt;.&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>。其中 <pod_ip> 为 pod ip 地址，但需要将 ip 地址中的 <code>.</code> 转换为 <code>-</code>。</p>
<p>比如 pod nginx-deployment-57d84f57dc-cpgkc 会创建 A 记录 <code>10-244-3-8.default.pod.cluster.local</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide nginx-deployment-57d84f57dc-cpgkc -o wide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deployment-57d84f57dc-cpgkc   1/1     Running   0          2m59s   10.244.3.8   vc-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>规则二：</p>
<p>pod 如何同时指定了 <code>spec.hostname</code> 和 <code>spec.subdomain</code>，则会创建 A 记录：<code>&lt;hostname&gt;.&lt;subdomain&gt;.&lt;namespace&gt;.svc.cluster.local</code>，而不是 <code>&lt;pod_ip&gt;.&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>。对于 Statefulset 类型的 pod 会自动设置 <code>spec.hostname</code> 为 pod 的名字，<code>spec.subdomain</code> 为 StatefulSet 的 <code>spec.serviceName</code>。</p>
<p>比如 pod nginx-statefulset-0 会创建 A 记录 <code>nginx-statefulset-0.nginx.default.svc.cluster.local</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod nginx-statefulset-0 -o wide</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-statefulset-0   1/1     Running   0          62m   10.244.3.7   vc-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Deployment-x2F-DaemonSet-管理的-pod"><a href="#Deployment-x2F-DaemonSet-管理的-pod" class="headerlink" title="Deployment&#x2F;DaemonSet 管理的 pod"></a>Deployment&#x2F;DaemonSet 管理的 pod</h3><p>使用 Deployment&#x2F;DaemonSet 拉起的 pod，k8s 会创建额外的 DNS 记录：<code>&lt;pod_ip&gt;.&lt;deployment-name/daemonset-name&gt;.&lt;namespace&gt;.svc.&lt;cluster-domain&gt;</code>。</p>
<h2 id="Service-域名注册"><a href="#Service-域名注册" class="headerlink" title="Service 域名注册"></a>Service 域名注册</h2><h3 id="普通-Service"><a href="#普通-Service" class="headerlink" title="普通 Service"></a>普通 Service</h3><p>除了 headless service 之外的其他 service 会在 DNS 中生成 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 的 A 或者 AAAA 记录，A 记录指向 ClusterIP。</p>
<p>headless service 会在 DNS 中生成 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 的 A 或者 AAAA 记录，但指向的为 pod ip 地址集合。</p>
<p>k8s 在 pod 的 &#x2F;etc&#x2F;resolv.conf 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.32.0.10</span><br><span class="line">search &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<p>对于跟 pod 同一个 namespace 下的 service，要访问可以直接使用 service 名字接口。跟 pod 不在同一个 namespace 下的 service，访问 service 必须为 <code>service name.service namespace</code>。</p>
<h3 id="ExternalName-Service"><a href="#ExternalName-Service" class="headerlink" title="ExternalName Service"></a>ExternalName Service</h3><p>service 的 <code>spec.type</code> 为 <code>ExternalName</code>，该种类型的服务会向 dns 中注册 CNAME 记录，CNAME 记录指向 externalName 字段。例子如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">  namespace: prod</span><br><span class="line">spec:</span><br><span class="line">  type: ExternalName</span><br><span class="line">  externalName: my.database.example.com</span><br></pre></td></tr></table></figure>

<p>当访问 <code>my-service.prod.svc.cluster.local</code> 时，DNS 服务会返回 CNAME 记录，指向地址为 <code>my.database.example.com</code>。</p>
<h3 id="externalIPs-字段"><a href="#externalIPs-字段" class="headerlink" title="externalIPs 字段"></a>externalIPs 字段</h3><p>可以针对所有类型的 Service 生效，用来配置多个外部的 ip 地址（该 ip 地址不是 k8s 分配），kube-proxy 会设置该 ip 地址的规则，确保在 k8s 集群内部访问该 ip 地址时，可以路由到后端的 pod。效果就跟访问普通的 ClusterIP 类型 Service 没有区别。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 49152</span><br><span class="line">  externalIPs:</span><br><span class="line">    - 198.51.100.32</span><br></pre></td></tr></table></figure>

<p>当在集群内部访问 <code>198.51.100.32:80</code> 时，流量会被 kube-proxy 路由到当前 Service 的 Endpoint。</p>
<p>该字段存在中间人攻击的风险，不推荐使用。<a target="_blank" rel="noopener" href="https://sysdig.com/blog/detect-cve-2020-8554-using-falco/">Detect CVE-2020-8554 – Unpatched Man-In-The-Middle (MITM) Attack in Kubernetes</a></p>
<h3 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h3><p>翻译成中文又叫无头 Service，显式的将 Service <code>spec.clusterIP</code> 设置为 <code>&quot;None&quot;</code>，表示该 Service 为 Headless Service。此时，该 Service 不会分配 clusterIP。因为没有 clusterIP，因此 kube-proxy 并不会处理该 service。</p>
<p>Headless Service 按照是否配置了 <code>spec.selector</code> 在实现上又有不同的区分。</p>
<p>未配置 <code>spec.selector</code> 的 Service，不会创建 EndpointSlice 对象，但是会注册如下的记录：</p>
<ul>
<li>对于 ExternalName Service，配置 CNAME 记录。</li>
<li>对于非 ExternalName Service，配置 A&#x2F;AAAA 记录，指向 EndPoint 的所有 ip 地址。如果未配置 Endpoint，但配置了 externalIPs 字段，则指向 externalIPs。</li>
</ul>
<p>配置 <code>spec.selector</code> 的 Service，会创建 EndpointSlice 对象，并修改 DNS 配置返回 A 或者 AAAA 记录，指向 pod 的集合。</p>
<h1 id="域名查询"><a href="#域名查询" class="headerlink" title="域名查询"></a>域名查询</h1><p>待补充</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/">k8s 官方 Service 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/">k8s 官方 Service 与 Pod 的 DNS</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dns/blob/master/docs/specification.md">Kubernetes DNS-Based Service Discovery</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/json-patch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/json-patch/" class="post-title-link" itemprop="url">json patch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-01-29 17:04:14" itemprop="dateCreated datePublished" datetime="2023-01-29T17:04:14+00:00">2023-01-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="json-patch"><a href="#json-patch" class="headerlink" title="json patch"></a>json patch</h1><p>该规范定义在 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6902/">RFC 6902</a>，定义了修改 json 格式的规范，同时还可以配合 http patch 请求一起使用，实例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PATCH /my/data HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> example.org</span><br><span class="line">Content-Length<span class="punctuation">:</span> <span class="number">326</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json-patch+json</span><br><span class="line">If-Match<span class="punctuation">:</span> <span class="string">&quot;abc123&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remove&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span> <span class="string">&quot;bar&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">42</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;move&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/d&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;copy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/d&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/e&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>支持add、remove、replace、move、copy和 test 六个patch动作。</p>
<h2 id="协议规范"><a href="#协议规范" class="headerlink" title="协议规范"></a>协议规范</h2><h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><p>格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;add&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>规范：</p>
<ol>
<li>如果原始 json 中不存在 key “&#x2F;hello”，则会全新创建 key。</li>
<li>如果原始 json 存在 key “&#x2F;hello”，则会直接覆盖；即使”&#x2F;hello”为数组，也不会在原先的基础上追加，而是直接强制覆盖；</li>
</ol>
<p>原始 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;123&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行后结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;world&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><p>用来删除某个 key，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;remove&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h3 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h3><p>用来替换某个 key，跟 add 动作的差异是，如果 key 不存在，则不会创建 key。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">42</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果原始 json 格式为: <code>&#123;&#125;</code>，执行完成后，输出 json 格式仍然为：<code>&#123;&#125;</code>。</p>
<h3 id="move"><a href="#move" class="headerlink" title="move"></a>move</h3><p>用来修改 key 的名称，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;move&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果 key 不存在，则不做任何修改。</p>
<h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p>用来复制某个 key，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;copy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/hello2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果原始 key 不存在，则不复制；如果目标 key 已经存在，则仍然会复制。</p>
<p>原始 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;hello2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行完成后的 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hello2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p>用来测试 key 对应的 value 是否相等，该操作并不常用</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/a/b/c&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;foo&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ul>
<li><a target="_blank" rel="noopener" href="https://json-patch-builder-online.github.io/">JSON Patch Builder Online</a> 在线工具，可根据原始 json 和 patch 完成后的 json，产生 json patch</li>
<li><a target="_blank" rel="noopener" href="https://jsonpatch.me/">jsonpatch.me</a> 在线工具，可根据原始 json 和 json patch，产生 patch 完成后的 json</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上述协议可以发现如下缺点：</p>
<ol>
<li>对于数组的处理不是太理想，如果要删除数组中的某个元素，或者在数组中追加某个元素，则无法表达。</li>
<li>该协议对于人类并不友好。</li>
</ol>
<h1 id="json-merge-patch"><a href="#json-merge-patch" class="headerlink" title="json merge patch"></a>json merge patch</h1><p>定义在 <a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc7386">RFC 7386</a>，由于patch 能力比较有限，使用场景较少。</p>
<p>同样可以配合 http patch 方法一起使用，http 请求如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PATCH /target HTTP/<span class="number">1.1</span></span><br><span class="line">Host<span class="punctuation">:</span> example.org</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/merge-patch+json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="string">&quot;z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;f&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>下面结合具体的实例来说明 json merge patch 的功能。<br>原始 json 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Goodbye!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;givenName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;familyName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Doe&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span> <span class="string">&quot;example&quot;</span><span class="punctuation">,</span> <span class="string">&quot;sample&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This will be unchanged&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>patch json 格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+01-123-456-7890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;familyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;example&quot;</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中 null 用来表示该 key 需要删除。对于数组类型，则直接覆盖数组中的值。<br>patch 完成后的 json 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;givenName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;example&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;This will be unchanged&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;phoneNumber&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+01-123-456-7890&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过上述实例可以发现如下的功能缺陷：</p>
<ol>
<li>如果某个 json 的 key 对应的值为 null，则无法表达，即不可以将某个 key 对应的value 设置为 null。</li>
<li>对于数组的处理非常弱，是直接对数组中所有元素的替换。</li>
</ol>
<h1 id="k8s-strategic-merge-patch"><a href="#k8s-strategic-merge-patch" class="headerlink" title="k8s strategic merge patch"></a>k8s strategic merge patch</h1><p>该协议的资料较少，官方参考资料只有两篇文章，最好结合着 k8s 的代码才能完全理解：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/">Update API Objects in Place Using kubectl patch</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md">Strategic Merge Patch</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podspec-v1-core">Pod Spec 定义</a></li>
</ul>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>无论是 json patch，还是 json merge patch 协议，对于数组元素的支持都不够友好。<br>比如对于如下的 json：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec<span class="punctuation">:</span></span><br><span class="line">  containers<span class="punctuation">:</span></span><br><span class="line">    - name<span class="punctuation">:</span> nginx</span><br><span class="line">      image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<p>期望能够 patch 如下的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec<span class="punctuation">:</span></span><br><span class="line">  containers<span class="punctuation">:</span></span><br><span class="line">    - name<span class="punctuation">:</span> log-tailer</span><br><span class="line">      image<span class="punctuation">:</span> log-tailer<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<p>从而可以实现 containers中包含两个元素的情况，无论是 json patch 还是 json merge patch，其行为是对数组元素的直接替换，不能实现追加的功能。</p>
<h2 id="协议规范-1"><a href="#协议规范-1" class="headerlink" title="协议规范"></a>协议规范</h2><p>为了解决 json merge patch 的功能缺陷，strategic merge patch 通过如下两种方式来扩展功能：</p>
<ol>
<li>json merge patch 的 json 语法增强，增加一些额外的指令</li>
<li>通过增强原始 json 的 struct 结构实现，跟 golang 语言强绑定，通过 golang 中的 struct tag 机制实现。这样的好处是不用再扩充 json merge patch 的 json 格式了。支持如下 struct tag：<ol>
<li>patchStrategy： 指定策略指令，支持：replace、merge 和 delete。默认的行为为 replace，保持跟 json merge patch 的兼容性。</li>
<li>patchMergeKey: 数组一个子 map 元素的主键，类似于关系型数据库中一行记录的主键。</li>
</ol>
</li>
</ol>
<p>支持如下指令：</p>
<ol>
<li>replace</li>
<li>merge</li>
<li>delete</li>
</ol>
<h3 id="replace-1"><a href="#replace-1" class="headerlink" title="replace"></a>replace</h3><p>支持 go struct tag 和 在 json patch 中增加指令两种方式。<br>replace 是默认的指令模式，对于数组而言会直接全部替换数组内容。</p>
<p>如下指令用来表示，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$patch<span class="punctuation">:</span> replace  # recursive and applies to all fields of the map it&#x27;s in</span><br><span class="line">containers<span class="punctuation">:</span></span><br><span class="line">- name<span class="punctuation">:</span> nginx</span><br><span class="line">  image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p>删除数组中的特定元素，下面例子可以删除数组中包含 name: log-tailer 的元素。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">containers<span class="punctuation">:</span></span><br><span class="line">  - name<span class="punctuation">:</span> nginx</span><br><span class="line">    image<span class="punctuation">:</span> nginx<span class="number">-1.0</span></span><br><span class="line">  - $patch<span class="punctuation">:</span> delete</span><br><span class="line">    name<span class="punctuation">:</span> log-tailer  # merge key and value goes here</span><br></pre></td></tr></table></figure>
<p>删除 map 的特定 key，如下实例可以删除 map 中的 key rollingUpdate。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rollingUpdate<span class="punctuation">:</span></span><br><span class="line">  $patch<span class="punctuation">:</span> delete</span><br></pre></td></tr></table></figure>
<h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p>该指令仅支持 go struct tag 模式，格式为：<code>$deleteFromPrimitiveList/&lt;keyOfPrimitiveList&gt;: [a primitive list]</code>。</p>
<h4 id="deleteFromPrimitiveList"><a href="#deleteFromPrimitiveList" class="headerlink" title="deleteFromPrimitiveList"></a>deleteFromPrimitiveList</h4><p>删除数组中的某个元素<br>go struct 定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Finalizers []<span class="type">string</span> <span class="string">`json:&quot;finalizers,omitempty&quot; patchStrategy:&quot;merge&quot; protobuf:&quot;bytes,14,rep,name=finalizers&quot;`</span></span><br></pre></td></tr></table></figure>
<p>原始 yaml 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br></pre></td></tr></table></figure>
<p>patch yaml 如下，用来表示删除finalizers中的所有元素 b 和 c</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The directive includes the prefix $deleteFromPrimitiveList and</span></span><br><span class="line"><span class="comment"># followed by a &#x27;/&#x27; and the name of the list.</span></span><br><span class="line"><span class="comment"># The values in this list will be deleted after applying the patch.</span></span><br><span class="line"><span class="string">$deleteFromPrimitiveList/finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>最终得到结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<h4 id="setElementOrder"><a href="#setElementOrder" class="headerlink" title="setElementOrder"></a>setElementOrder</h4><p>用于数组中的元素排序</p>
<h5 id="简单数组排序例子"><a href="#简单数组排序例子" class="headerlink" title="简单数组排序例子"></a>简单数组排序例子</h5><p>原始内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>设置排序顺序：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The directive includes the prefix $setElementOrder and</span></span><br><span class="line"><span class="comment"># followed by a &#x27;/&#x27; and the name of the list.</span></span><br><span class="line"><span class="string">$setElementOrder/finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<p>最终得到排序顺序：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">finalizers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<h5 id="map-类型数组排序例子"><a href="#map-类型数组排序例子" class="headerlink" title="map 类型数组排序例子"></a>map 类型数组排序例子</h5><p>其中 patchMergeKey 为 name 字段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>patch 指令的格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># each map in the list should only include the mergeKey</span></span><br><span class="line"><span class="string">$setElementOrder/containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br></pre></td></tr></table></figure>
<p>最终获得结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">b</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">a</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure>
<h4 id="retainKeys"><a href="#retainKeys" class="headerlink" title="retainKeys"></a>retainKeys</h4><p>用来清理 map 结构中的 key，并指定保留的 key<br>原始内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="attr">foo:</span> <span class="string">a</span></span><br><span class="line">  <span class="attr">other:</span> <span class="string">b</span></span><br></pre></td></tr></table></figure>
<p>patch 内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="attr">retainKeys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">another</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bar</span></span><br><span class="line">  <span class="attr">another:</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">bar:</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>
<p>最终结果，可以看到 foo 和 other 因为不在保留列表中已经被清楚了。同时新增加了字段 another 和 bar，新增加的是字段是直接 patch 的结果，同时这两个字段也在保留的列表内。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">union:</span></span><br><span class="line">  <span class="comment"># Field foo and other have been cleared w/o explicitly set them to null.</span></span><br><span class="line">  <span class="attr">another:</span> <span class="string">d</span></span><br><span class="line">  <span class="attr">bar:</span> <span class="string">c</span></span><br></pre></td></tr></table></figure>

<h1 id="strategic-merge-patch-在-k8s-中应用"><a href="#strategic-merge-patch-在-k8s-中应用" class="headerlink" title="strategic merge patch 在 k8s 中应用"></a>strategic merge patch 在 k8s 中应用</h1><p>kubectl patch 命令通过–type 参数提供了几种 patch 方法。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--type=&#x27;strategic&#x27;<span class="punctuation">:</span> The type of patch being provided; one of <span class="punctuation">[</span>json merge strategic<span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ol>
<li>json：即支持 json patch 协议，例子：<code>kubectl patch pod valid-pod --type=&#39;json&#39; -p=&#39;[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/containers/0/image&quot;, &quot;value&quot;:&quot;newimage&quot;&#125;]</code></li>
<li>merge：对应的为 json merge patch 协议。</li>
<li>stategic：k8s 特有的 patch 协议，在 json merge patch 协议基础上的扩展，可以解决 json merge patch 的缺点。</li>
</ol>
<p>对于 k8s 的 CRD 对象，由于不存在 go struct tag，因此无法使用 stategic merge patch。</p>
<p>TODO：待补充具体例子</p>
<h1 id="kubectl-patch、replace、apply之间的区别"><a href="#kubectl-patch、replace、apply之间的区别" class="headerlink" title="kubectl patch、replace、apply之间的区别"></a>kubectl patch、replace、apply之间的区别</h1><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>kubectl patch 命令的实现比较简单，直接调用 kube-apiserver 的接口在 server 端实现 patch 操作。</p>
<h2 id="replace-2"><a href="#replace-2" class="headerlink" title="replace"></a>replace</h2><p>如果该命令使用 –force&#x3D;true 参数，则会先删除对象，然后再提交，相当于是全新创建。</p>
<h2 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h2><p>apply 的实现相对比较复杂，逻辑也比较绕，可以实现 map 结构中的字段增删改操作，数组中数据的增删改操作。实现上会将多份数据进行merge 后提交，数据包含：</p>
<ol>
<li>要重新 apply 的 yaml</li>
<li>对象的annotation kubectl.kubernetes.io&#x2F;last-applied-configuration 包含的内容</li>
<li>运行时的 k8s 对象</li>
</ol>
<p>具体的操作步骤：</p>
<ol>
<li>要重新 apply 的 yaml 跟annotation kubectl.kubernetes.io&#x2F;last-applied-configuration 包含的内容比较，获取到要删除的字段。</li>
<li>要重新 apply 的 yaml 跟运行时的 k8s 对象进行比较，获取到要增加的字段。</li>
<li>上述两个结果再进行一次 merge 操作，最终调用 kube-apiserver 的接口实现 patch 操作。</li>
</ol>
<p>为什么一定需要用到kubectl.kubernetes.io&#x2F;last-applied-configuration的数据呢？<br>在 yaml 对象提交到 k8s 后，k8s 会自动增加一些字段，也可以通过额外的方式修改对象增加一些字段。如果 patch 内容仅跟运行时结果比较，会导致一些运行时的k8s 自动增加的字段或者手工更新的字段被删除掉。</p>
<table>
<thead>
<tr>
<th>试验</th>
<th>上次提交 last-applied-configuration</th>
<th>运行时</th>
<th>patch 内容</th>
<th>结果</th>
<th>结果分析</th>
</tr>
</thead>
<tbody><tr>
<td>试验一</td>
<td>label1: first</td>
<td>label1: first</td>
<td>label2: second</td>
<td>label2: second</td>
<td>1. patch 内容跟上次内容比较，发现要删除字段 label1<br>2. patch 内容跟运行时比较，发现新增加了字段 label2  <br>3. 最终 label1 被删除，仅保留 label2</td>
</tr>
<tr>
<td>试验二</td>
<td>label1: first</td>
<td>label1: first <br>label2: second</td>
<td>label1: first</td>
<td>label1: first <br>label2: second</td>
<td>1. patch 内容跟上次内容比较，发现结果无变化<br>2. patch 内容跟运行时比较，发现要新增加字段 label2<br>3. 最终新增加字段 label2</td>
</tr>
</tbody></table>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6902/">json patch RFC 规范</a></li>
<li><a target="_blank" rel="noopener" href="https://jsonpatch.com/">https://jsonpatch.com/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubeadm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubeadm/" class="post-title-link" itemprop="url">使用 kubeadm 安装 k8s 集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-07 00:07:20" itemprop="dateCreated datePublished" datetime="2022-12-07T00:07:20+00:00">2022-12-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-19 15:13:35" itemprop="dateModified" datetime="2024-06-19T15:13:35+00:00">2024-06-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文将通过 kubeadm 实现单 master 节点模式和集群模式两种部署方式。</p>
<h2 id="所有节点均需初始化操作"><a href="#所有节点均需初始化操作" class="headerlink" title="所有节点均需初始化操作"></a>所有节点均需初始化操作</h2><p>所有节点均需做的操作。</p>
<h3 id="主机准备"><a href="#主机准备" class="headerlink" title="主机准备"></a>主机准备</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/kubernets.conf &lt;&lt;EOF</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure>


<h3 id="安装containerd"><a href="#安装containerd" class="headerlink" title="安装containerd"></a>安装containerd</h3><p>由于 dockerd 从 k8s 1.24 版本开始不再支持，这里选择 containerd。</p>
<h4 id="手工安装"><a href="#手工安装" class="headerlink" title="手工安装"></a>手工安装</h4><p>安装 containerd，containerd 的版本可以从这里获取 <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/releases">https://github.com/containerd/containerd/releases</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.6.11/containerd-1.6.11-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvf /usr/local containerd-1.6.11-linux-amd64.tar.gz</span><br><span class="line">wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -P /usr/local/lib/systemd/system/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure>

<p>安装 runc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64</span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure>

<h4 id="yum-源安装"><a href="#yum-源安装" class="headerlink" title="yum 源安装"></a>yum 源安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo     https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install containerd.io -y</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure>

<p>通过 yum 安装的containerd 没有启用 cri，在其配置文件 &#x2F;etc&#x2F;containerd&#x2F;config.toml 中包含了 <code>disabled_plugins = [&quot;cri&quot;]</code> 配置，需要将配置信息注释后并重启 containerd。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/disabled_plugins/#disabled_plugins/&#x27;  /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>

<h3 id="安装-kubeadm-x2F-kubelet-x2F-kubectl"><a href="#安装-kubeadm-x2F-kubelet-x2F-kubectl" class="headerlink" title="安装 kubeadm&#x2F;kubelet&#x2F;kubectl"></a>安装 kubeadm&#x2F;kubelet&#x2F;kubectl</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># Set SELinux in permissive mode (effectively disabling it)</span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">sudo systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>

<h2 id="单-master-节点模式"><a href="#单-master-节点模式" class="headerlink" title="单 master 节点模式"></a>单 master 节点模式</h2><table>
<thead>
<tr>
<th>节点</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>172.21.115.190<br/></td>
<td>master 节点</td>
</tr>
</tbody></table>
<h3 id="kubeadm-初始化"><a href="#kubeadm-初始化" class="headerlink" title="kubeadm 初始化"></a>kubeadm 初始化</h3><p>创建文件 kubeadm-config.yaml，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.25.4</span><br><span class="line">---</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">cgroupDriver: systemd</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm-config.yaml</span><br><span class="line">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; cluster.yaml</span><br><span class="line">kubeadm init --config cluster.yaml</span><br></pre></td></tr></table></figure>

<p>接下来初始化 kubeconfig 文件，这样即可通过 kubectl 命令来访问 k8s 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>


<h3 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h3><p>刚部署完成的节点处于NotReady 的状态，原因是因为还没有安装网络插件。</p>
<h4 id="cilim-网络插件"><a href="#cilim-网络插件" class="headerlink" title="cilim 网络插件"></a>cilim 网络插件</h4><p>cilim 网络插件比较火爆，下面介绍其安装步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 安装 cilium 客户端</span><br><span class="line">CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)</span><br><span class="line">CLI_ARCH=amd64</span><br><span class="line">if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ]; then CLI_ARCH=arm64; fi</span><br><span class="line">curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/$&#123;CILIUM_CLI_VERSION&#125;/cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz&#123;,.sha256sum&#125;</span><br><span class="line">sha256sum --check cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz.sha256sum</span><br><span class="line">sudo tar xzvfC cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz /usr/local/bin</span><br><span class="line">rm cilium-linux-$&#123;CLI_ARCH&#125;.tar.gz&#123;,.sha256sum&#125;</span><br><span class="line"></span><br><span class="line"># 网络插件初始化</span><br><span class="line">cilium install</span><br></pre></td></tr></table></figure>

<p>在安装完网络插件后，node 节点即可变为 ready 状态。</p>
<p>查看环境中包含如下的 pod:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get pod  -A</span><br><span class="line">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   cilium-7zj7t                     1/1     Running   0          82s</span><br><span class="line">kube-system   cilium-operator-bc4d5b54-kvqqx   1/1     Running   0          82s</span><br><span class="line">kube-system   coredns-565d847f94-hrm9b         1/1     Running   0          14m</span><br><span class="line">kube-system   coredns-565d847f94-z5kwr         1/1     Running   0          14m</span><br><span class="line">kube-system   etcd-k8s002                      1/1     Running   0          14m</span><br><span class="line">kube-system   kube-apiserver-k8s002            1/1     Running   0          14m</span><br><span class="line">kube-system   kube-controller-manager-k8s002   1/1     Running   0          14m</span><br><span class="line">kube-system   kube-proxy-bhpqr                 1/1     Running   0          14m</span><br><span class="line">kube-system   kube-scheduler-k8s002            1/1     Running   0          14m</span><br></pre></td></tr></table></figure>

<h4 id="k8s-自带的-bridge-插件"><a href="#k8s-自带的-bridge-插件" class="headerlink" title="k8s 自带的 bridge 插件"></a>k8s 自带的 bridge 插件</h4><p>在单节点的场景下，pod 不需要跨节点通讯，k8s 自带的 bridge 插件也可以满足单节点内的 pod 相互通讯，类似于 docker 的 bridge 网络模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line">cat &gt; /etc/cni/net.d/10-mynet.conf &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;mynet&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;bridge&quot;,</span><br><span class="line">  &quot;bridge&quot;: &quot;cni0&quot;,</span><br><span class="line">  &quot;isGateway&quot;: true,</span><br><span class="line">  &quot;ipMasq&quot;: true,</span><br><span class="line">  &quot;ipam&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">    &quot;subnet&quot;: &quot;172.19.0.0/24&quot;,</span><br><span class="line">    &quot;routes&quot;: [</span><br><span class="line">      &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>如果 k8s 节点已经部署完成，需要重启下 kubelet 进程该配置即可生效。</p>
<h3 id="添加其他节点"><a href="#添加其他节点" class="headerlink" title="添加其他节点"></a>添加其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.21.115.189:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:457fba2c4181a5b02d2a4f202dfe20f9ce5b9f2274bf40b6d25a8a8d4a7ce440 </span><br></pre></td></tr></table></figure>

<p>此时即可以将节点添加到 k8s 集群中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get node </span><br><span class="line">NAME     STATUS   ROLES           AGE   VERSION</span><br><span class="line">k8s002   Ready    control-plane   79m   v1.25.4</span><br><span class="line">k8s003   Ready    &lt;none&gt;          35s   v1.25.4</span><br></pre></td></tr></table></figure>

<h3 id="节点清理"><a href="#节点清理" class="headerlink" title="节点清理"></a>节点清理</h3><h4 id="清理普通节点"><a href="#清理普通节点" class="headerlink" title="清理普通节点"></a>清理普通节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;node name&gt; --delete-emptydir-data --force --ignore-daemonsets</span><br><span class="line">kubeadm reset </span><br><span class="line"># 清理 iptabels 规则</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="清理-control-plan-节点"><a href="#清理-control-plan-节点" class="headerlink" title="清理 control plan 节点"></a>清理 control plan 节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<h2 id="集群模式部署"><a href="#集群模式部署" class="headerlink" title="集群模式部署"></a>集群模式部署</h2><p>待补充，参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">Creating Highly Available Clusters with kubeadm | Kubernetes</a></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/">Bootstrapping clusters with kubeadm</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
