<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/12/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/12/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/12/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">227</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/pushd-popd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/pushd-popd/" class="post-title-link" itemprop="url">pushd和popd命令的用法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-08-10 18:09:56" itemprop="dateCreated datePublished" datetime="2018-08-10T18:09:56+00:00">2018-08-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pushd和popd命令的用法"><a href="#pushd和popd命令的用法" class="headerlink" title="pushd和popd命令的用法"></a>pushd和popd命令的用法</h1><p>在编写shell的时候，经常会在目录之间进行切换，如果使用cd命令经常会切换错误，pushd和popd使用栈的方式来管理目录。</p>
<h2 id="dirs"><a href="#dirs" class="headerlink" title="dirs"></a>dirs</h2><p>用于显示当前目录栈中的所有记录。</p>
<h2 id="pushd"><a href="#pushd" class="headerlink" title="pushd"></a>pushd</h2><p>将目录加入到栈顶部，并将当前目录切换到该目录。若不加任何参数，该命令用于将栈顶的两个目录进行对调。</p>
<h2 id="popd"><a href="#popd" class="headerlink" title="popd"></a>popd</h2><p>删除目录栈中的目录。若不加任何参数，则会首先删除目录栈顶的目录，并将当前目录切换到栈顶下面的目录。</p>
<p>命令格式：<code>pushd  [-N | +N]   [-n]</code></p>
<ul>
<li><code>+N</code> 将第N个目录删除（从左边数起，数字从0开始）</li>
<li><code>-N</code> 将第N个目录删除（从右边数起，数字从0开始）</li>
<li><code>-n</code> 将目录出栈时，不切换目录</li>
</ul>
<h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]# mkdir /tmp/dir&#123;1,2,3,4&#125;</span><br><span class="line">[root@localhost tmp]# pushd /tmp/dir1</span><br><span class="line">/tmp/dir1 /tmp</span><br><span class="line">[root@localhost dir1]# pushd /tmp/dir2</span><br><span class="line">/tmp/dir2 /tmp/dir1 /tmp</span><br><span class="line">[root@localhost dir2]# pushd /tmp/dir3</span><br><span class="line">/tmp/dir3 /tmp/dir2 /tmp/dir1 /tmp</span><br><span class="line">[root@localhost dir3]# pushd /tmp/dir4</span><br><span class="line">/tmp/dir4 /tmp/dir3 /tmp/dir2 /tmp/dir1 /tmp</span><br><span class="line"># dirs的显示内容跟pushd完成后的输出一致</span><br><span class="line">[root@localhost dir4]# dirs</span><br><span class="line">/tmp/dir4 /tmp/dir3 /tmp/dir2 /tmp/dir1 /tmp</span><br><span class="line"></span><br><span class="line">[root@localhost dir4]# popd</span><br><span class="line">/tmp/dir3 /tmp/dir2 /tmp/dir1 /tmp</span><br><span class="line"></span><br><span class="line"># 带有数字比较容易出错</span><br><span class="line">[root@localhost dir3]# popd +1</span><br><span class="line">/tmp/dir3 /tmp/dir1 /tmp</span><br><span class="line"></span><br><span class="line"># 清除目录栈</span><br><span class="line">[root@localhost dir3]# dirs -c</span><br><span class="line">[root@localhost dir3]# dirs</span><br><span class="line">/tmp/dir3</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/overlayfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/overlayfs/" class="post-title-link" itemprop="url">理解OverlayFS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-07-28 21:30:25" itemprop="dateCreated datePublished" datetime="2018-07-28T21:30:25+00:00">2018-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="docker-image结构"><a href="#docker-image结构" class="headerlink" title="docker image结构"></a>docker image结构</h2><p>docker可以通过命令<code>docker image inspect $&#123;image&#125;</code>来查看image的详细信息，其中包含了所使用的底层文件系统及各层的信息。</p>
<p>docker container的存储结构分为了只读层、init层和可读写层。</p>
<p>只读层跟docker image的层次结构恰好对应，主要包含操作系统的文件、配置、目录等信息，不包含操作系统镜像。</p>
<p>init层在只读层和读写层中间，用来专门存放&#x2F;etc&#x2F;hosts &#x2F;etc&#x2F;resolv.conf等信息，这些文件往往需要在启动的时候写入一些指定值，但不期望<code>docker commit</code>命令对其进行提交。</p>
<p>可读写层为容器在运行中可以进行写入的层。</p>
<h2 id="overlay"><a href="#overlay" class="headerlink" title="overlay"></a>overlay</h2><p><img src="https://arkingc.github.io/img/in-post/post-docker-filesystem/overlay_constructs.jpg" alt="image"></p>
<p>采用了两层结构，lowerdir为镜像层，只读。upperdir为容器层。</p>
<p>每层都会在&#x2F;var&#x2F;run&#x2F;docker&#x2F;overlay创建一个文件夹，文件夹中为实际层的内容，文件采用硬链接的方式链接到真实层中的文件，每一层都包含该层该拥有的所有文件，而该文件的真实存储可能是采用硬链接的方式链接到上层中的真实文件，因此比较耗费inode。</p>
<p>创建一个容器时，会新增两个目录，一个为读写层，一个为初始层。初始层中保存了容器初始化时的环境信息，如hostname、hosts文件等。读写层用于记录容器的所有改动。</p>
<h2 id="overlay2"><a href="#overlay2" class="headerlink" title="overlay2"></a>overlay2</h2><p>为了规避overlay消耗inode节点过多的问题，overlay2采用在每层中增加lower文件的方式来记录所有底层的信息，类似于链表的形式。</p>
<p><code>docker pull ubuntu</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost runc]# docker pull ubuntu</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/ubuntu</span><br><span class="line">c64513b74145: Pull complete</span><br><span class="line">01b8b12bad90: Pull complete</span><br><span class="line">c5d85cf7a05f: Pull complete</span><br><span class="line">b6b268720157: Pull complete</span><br><span class="line">e12192999ff1: Pull complete</span><br><span class="line">Digest: sha256:3f119dc0737f57f704ebecac8a6d8477b0f6ca1ca0332c7ee1395ed2c6a82be7</span><br><span class="line">Status: Downloaded newer image for ubuntu:latest</span><br></pre></td></tr></table></figure>

<p>会在&#x2F;var&#x2F;run&#x2F;docker&#x2F;overlay2目录下创建如下文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost overlay2]# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- 664ae13f1c21402385076025d68476eb8d1cc4be6c6a218b24bd55217ac62672    // 第0层</span><br><span class="line">|   |-- diff</span><br><span class="line">|   `-- link    // MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|-- 783ad02709b67ac47b55198e9659c4592f0972334987ab97f42fd10f1784cbba    // 第2层</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- link    // HXATFASQ4E2JBG434DUEN54EZZ</span><br><span class="line">|   |-- lower   // l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|   |-- merged</span><br><span class="line">|   `-- work</span><br><span class="line">|-- 89f7a20dda3d868840e20d9e8f1bfe20c5cca51c27b07825f100da0f474672f6    // 第3层</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- link    // 5PHT7S3MCZTTQOXVPA4CKJRRFD</span><br><span class="line">|   |-- lower   // l/HXATFASQ4E2JBG434DUEN54EZZ:l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|   |-- merged</span><br><span class="line">|   `-- work</span><br><span class="line">|-- backingFsBlockDev</span><br><span class="line">|-- bad073a2d1f79a03af6caa0b3f51a22e6762cebbc0c30e45458fe6c1ff266f68    // 第4层</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- link    // QMKHIPSDT4JTPE4FLT7QGJ33ND</span><br><span class="line">|   |-- lower   // l/5PHT7S3MCZTTQOXVPA4CKJRRFD:l/HXATFASQ4E2JBG434DUEN54EZZ:l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|   |-- merged</span><br><span class="line">|   `-- work</span><br><span class="line">|-- cb40b5b47c699050305676b35b1cea1ce08b38604dd68243c4be48934125b1a3    // 第1层</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- link    // WUZC5WSTQTPJUJ4KFAYCUT5IPD</span><br><span class="line">|   |-- lower   // l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|   |-- merged</span><br><span class="line">|   `-- work</span><br><span class="line">`-- l</span><br><span class="line">    |-- 5PHT7S3MCZTTQOXVPA4CKJRRFD -&gt; ../89f7a20dda3d868840e20d9e8f1bfe20c5cca51c27b07825f100da0f474672f6/diff</span><br><span class="line">    |-- HXATFASQ4E2JBG434DUEN54EZZ -&gt; ../783ad02709b67ac47b55198e9659c4592f0972334987ab97f42fd10f1784cbba/diff</span><br><span class="line">    |-- MZUEUOFHBNVTRCJYJEG7QY4VWT -&gt; ../664ae13f1c21402385076025d68476eb8d1cc4be6c6a218b24bd55217ac62672/diff</span><br><span class="line">    |-- QMKHIPSDT4JTPE4FLT7QGJ33ND -&gt; ../bad073a2d1f79a03af6caa0b3f51a22e6762cebbc0c30e45458fe6c1ff266f68/diff</span><br><span class="line">    `-- WUZC5WSTQTPJUJ4KFAYCUT5IPD -&gt; ../cb40b5b47c699050305676b35b1cea1ce08b38604dd68243c4be48934125b1a3/diff</span><br></pre></td></tr></table></figure>

<p>l目录下为超链接，缩短后的目录，为了避免mount时超出页大小限制。</p>
<p>每一层中的diff文件夹包含实际内容。</p>
<p>每一层中都有一个link文件，内容为l目录中的超链接，超链接实际指向当前层目录中的diff文件夹。</p>
<p>除去最底层的目录外，其余每一层中包含一个lower文件，包含了该层的所有更底层名称和顺序，可以根据该文件构建出整个镜像的层次结构。</p>
<p>work目录用于OverlayFS内部使用。</p>
<p>最底层只有link文件，无lower文件，因此664ae13f1c21402385076025d68476eb8d1cc4be6c6a218b24bd55217ac62672为最底层。</p>
<p>以上五层为lower，只读。</p>
<p>当使用<code>docker run -it ubuntu:latest /bin/bash</code>启动一个容器后，在overlay2目录下会多出两个文件夹。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost overlay2]# tree -L 1 0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init 0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08 l</span><br><span class="line">0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init</span><br><span class="line">|-- diff</span><br><span class="line">|-- link    // ZJVMGTB2IOJ6QF57TYM5O7EWXW</span><br><span class="line">|-- lower   // l/QMKHIPSDT4JTPE4FLT7QGJ33ND:l/5PHT7S3MCZTTQOXVPA4CKJRRFD:l/HXATFASQ4E2JBG434DUEN54EZZ:l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|-- merged</span><br><span class="line">`-- work</span><br><span class="line">0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08</span><br><span class="line">|-- diff</span><br><span class="line">|-- link</span><br><span class="line">|-- lower   // l/ZJVMGTB2IOJ6QF57TYM5O7EWXW:l/QMKHIPSDT4JTPE4FLT7QGJ33ND:l/5PHT7S3MCZTTQOXVPA4CKJRRFD:l/HXATFASQ4E2JBG434DUEN54EZZ:l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:l/MZUEUOFHBNVTRCJYJEG7QY4VWT</span><br><span class="line">|-- merged</span><br><span class="line">`-- work</span><br><span class="line">l</span><br><span class="line">|-- 5PHT7S3MCZTTQOXVPA4CKJRRFD -&gt; ../89f7a20dda3d868840e20d9e8f1bfe20c5cca51c27b07825f100da0f474672f6/diff</span><br><span class="line">|-- AOLYGFOHIAHWU5CBAJFULNAXI7 -&gt; ../0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08/diff</span><br><span class="line">|-- HXATFASQ4E2JBG434DUEN54EZZ -&gt; ../783ad02709b67ac47b55198e9659c4592f0972334987ab97f42fd10f1784cbba/diff</span><br><span class="line">|-- MZUEUOFHBNVTRCJYJEG7QY4VWT -&gt; ../664ae13f1c21402385076025d68476eb8d1cc4be6c6a218b24bd55217ac62672/diff</span><br><span class="line">|-- QMKHIPSDT4JTPE4FLT7QGJ33ND -&gt; ../bad073a2d1f79a03af6caa0b3f51a22e6762cebbc0c30e45458fe6c1ff266f68/diff</span><br><span class="line">|-- WUZC5WSTQTPJUJ4KFAYCUT5IPD -&gt; ../cb40b5b47c699050305676b35b1cea1ce08b38604dd68243c4be48934125b1a3/diff</span><br><span class="line">`-- ZJVMGTB2IOJ6QF57TYM5O7EWXW -&gt; ../0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init/diff</span><br></pre></td></tr></table></figure>

<p><code>0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init</code>用于存放容器初始化时的信息，通过下面查看更直观。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost overlay2]# tree 0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init</span><br><span class="line">0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08-init</span><br><span class="line">|-- diff</span><br><span class="line">|   |-- dev</span><br><span class="line">|   |   `-- console</span><br><span class="line">|   `-- etc</span><br><span class="line">|       |-- hostname</span><br><span class="line">|       |-- hosts</span><br><span class="line">|       |-- mtab -&gt; /proc/mounts</span><br><span class="line">|       `-- resolv.conf</span><br><span class="line">|-- link</span><br><span class="line">|-- lower</span><br><span class="line">|-- merged</span><br><span class="line">`-- work</span><br><span class="line">    `-- work</span><br></pre></td></tr></table></figure>

<p><code>0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08</code>的直接底层为init层，更详细的目录结构如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost overlay2]# tree -L 2  0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08</span><br><span class="line">0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08</span><br><span class="line">|-- diff</span><br><span class="line">|-- link</span><br><span class="line">|-- lower</span><br><span class="line">|-- merged</span><br><span class="line">|   |-- bin</span><br><span class="line">|   |-- boot</span><br><span class="line">|   |-- dev</span><br><span class="line">|   |-- etc</span><br><span class="line">|   |-- home</span><br><span class="line">|   |-- lib</span><br><span class="line">|   |-- lib64</span><br><span class="line">|   |-- media</span><br><span class="line">|   |-- mnt</span><br><span class="line">|   |-- opt</span><br><span class="line">|   |-- proc</span><br><span class="line">|   |-- root</span><br><span class="line">|   |-- run</span><br><span class="line">|   |-- sbin</span><br><span class="line">|   |-- srv</span><br><span class="line">|   |-- sys</span><br><span class="line">|   |-- tmp</span><br><span class="line">|   |-- usr</span><br><span class="line">|   `-- var</span><br><span class="line">`-- work</span><br><span class="line">    `-- work</span><br></pre></td></tr></table></figure>

<p>merged文件夹中内容较多，为overlay2的直接挂载点，对容器的修改会反应到该目录中。例如在容器中增加&#x2F;root&#x2F;hello.txt文件，在merged目录下会增加root&#x2F;hello.txt文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost overlay2]# mount  | grep overlay2</span><br><span class="line">/dev/mapper/centos-root on /var/lib/docker/overlay2 type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">overlay on /var/lib/docker/overlay2/0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08/merged type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/ZJVMGTB2IOJ6QF57TYM5O7EWXW:/var/lib/docker/overlay2/l/QMKHIPSDT4JTPE4FLT7QGJ33ND:/var/lib/docker/overlay2/l/5PHT7S3MCZTTQOXVPA4CKJRRFD:/var/lib/docker/overlay2/l/HXATFASQ4E2JBG434DUEN54EZZ:/var/lib/docker/overlay2/l/WUZC5WSTQTPJUJ4KFAYCUT5IPD:/var/lib/docker/overlay2/l/MZUEUOFHBNVTRCJYJEG7QY4VWT,upperdir=/var/lib/docker/overlay2/0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08/diff,workdir=/var/lib/docker/overlay2/0326c1da0af912a6ea5efda77b65b04e796993e0f111ed8f262c55b2716f1c08/work)</span><br></pre></td></tr></table></figure>

<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">Use the OverlayFS storage driver</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2017/05/05/docker-filesystem-overlay/">Docker存储驱动—Overlay&#x2F;Overlay2「译」</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/golang-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/golang-interview/" class="post-title-link" itemprop="url">Golang面试题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-07-27 20:25:38" itemprop="dateCreated datePublished" datetime="2018-07-27T20:25:38+00:00">2018-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文绝大多数题目来源于网络，部分题目为原创。</p>
<h2 id="slice相关"><a href="#slice相关" class="headerlink" title="slice相关"></a>slice相关</h2><h3 id="以下代码有什么问题，说明原因"><a href="#以下代码有什么问题，说明原因" class="headerlink" title="以下代码有什么问题，说明原因"></a>以下代码有什么问题，说明原因</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pase_student</span><span class="params">()</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*student)</span><br><span class="line">	stus := []student&#123;</span><br><span class="line">		&#123;Name: <span class="string">&quot;zhou&quot;</span>, Age: <span class="number">24</span>&#125;,</span><br><span class="line">		&#123;Name: <span class="string">&quot;li&quot;</span>, Age: <span class="number">23</span>&#125;,</span><br><span class="line">		&#123;Name: <span class="string">&quot;wang&quot;</span>, Age: <span class="number">22</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, stu := <span class="keyword">range</span> stus &#123;</span><br><span class="line">		m[stu.Name] = &amp;stu</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次遍历的时候stu变量为值拷贝，stu变量的地址未改变，即&amp;stu未改变，遍历结束后stu指向stus中的最后一个元素。</p>
<p>使用<code>reflect.TypeOf(str)</code>打印出的类型为main.student，如果使用<code>stu.Age += 10</code>这样的语法是不会修改stus中的值的。</p>
<p>可修改为如下形式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, _ := <span class="keyword">range</span> stus &#123;</span><br><span class="line">    m[stus[i].Name] = &amp;stus[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="有一个slice-of-object-遍历slice修改name为指定的值"><a href="#有一个slice-of-object-遍历slice修改name为指定的值" class="headerlink" title="有一个slice of object, 遍历slice修改name为指定的值"></a>有一个slice of object, 遍历slice修改name为指定的值</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type foo struct &#123;</span><br><span class="line"> name string</span><br><span class="line"> value string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func mutate(s []foo, name string) &#123;</span><br><span class="line">// TODO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>意在考察range遍历的时候是值拷贝，以及slice的内部数据结构，slice的数据结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct    Slice</span><br><span class="line">&#123;    // must not move anything</span><br><span class="line">    byte*    array;        // actual data</span><br><span class="line">    uintgo    len;        // number of elements</span><br><span class="line">    uintgo    cap;        // allocated number of elements</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行append函数后会返回一个新的Slice对象，新的Slice对象跟旧Slice对象共用相同的数据存储，但是len的值并不相同。</p>
<p>该题目中，可以通过下面的方式来修改值:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// range方式</span><br><span class="line">for i, _ := range s &#123;</span><br><span class="line">	s[i].name = name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// for i形式</span><br><span class="line">for i:=0; i&lt;len(s); i++ &#123;</span><br><span class="line">  s[i].name = name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="从slice中找到一个元素匹配name，并将该元素的指针添加到一个新的slice中，返回新slice"><a href="#从slice中找到一个元素匹配name，并将该元素的指针添加到一个新的slice中，返回新slice" class="headerlink" title="从slice中找到一个元素匹配name，并将该元素的指针添加到一个新的slice中，返回新slice"></a>从slice中找到一个元素匹配name，并将该元素的指针添加到一个新的slice中，返回新slice</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func find(s []foo, name string) []*foo &#123;</span><br><span class="line">// TODO</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仍旧是考察range是值拷贝的用法，此处使用for i 循环即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func find(s []foo, name string) []*foo &#123;</span><br><span class="line">	res := []*foo&#123;&#125;</span><br><span class="line"></span><br><span class="line">	for i := 0; i &lt; len(s); i++ &#123;</span><br><span class="line">		if s[i].name == name &#123;</span><br><span class="line">			res = append(res, &amp;(s[i]))</span><br><span class="line">			break</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="下面输出什么内容"><a href="#下面输出什么内容" class="headerlink" title="下面输出什么内容"></a>下面输出什么内容</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">func m(s []int) &#123;</span><br><span class="line">	s[0] = -1</span><br><span class="line">	s = append(s, 4)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	s1 := []int&#123;1, 2, 3&#125;</span><br><span class="line">	m(s1)</span><br><span class="line">	s2 := make([]int, 3, 6)</span><br><span class="line">	m(s2)</span><br><span class="line">	s2 = append(s2, 7)</span><br><span class="line">	s3 := [3]int&#123;1, 2, 3&#125;</span><br><span class="line">	fmt.Println(s1)</span><br><span class="line">	fmt.Println(s2)</span><br><span class="line">	fmt.Println(s3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>slice的函数传递为值拷贝方式，在函数m中对下标为0的元素的修改会直接修改原slice中的值，因为slice中的指针指向的地址是相同的。</p>
<p>append之后的slice虽然可能是在原数组上增加了元素，但原slice中的len字段并没有变化。</p>
<p>make([]int, 3, 6)虽然指定了slice的cap，但对于append没有影响，还是会在slice中最后一个元素的下一个位置增加新元素。</p>
<p>数组由于是值拷贝，对新数组的修改不会影响到原数组。</p>
<p>输出内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[-1 2 3]</span><br><span class="line">[-1 0 0 7]</span><br><span class="line">[1 2 3]</span><br></pre></td></tr></table></figure>

<h3 id="下面输出什么内容-1"><a href="#下面输出什么内容-1" class="headerlink" title="下面输出什么内容"></a>下面输出什么内容</h3><p>该题目为我自己想出来的，非来自于互联网，意在考察对slice和append函数的理解。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func f() &#123;</span><br><span class="line">	s1 := make([]int, 2, 8)</span><br><span class="line">	fmt.Println(s1)</span><br><span class="line">	s2 := append(s1, 4)</span><br><span class="line">	fmt.Println(s2)</span><br><span class="line">	s3 := append(s1, 5)</span><br><span class="line">	fmt.Println(s3)</span><br><span class="line">	fmt.Println(s2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下，在执行第二个append后，第一个append在内存中增加的元素4会被5覆盖掉。执行结果可以通过<code>fmt.Println(s1, cap(s1), &amp;s1[0])</code>的形式将第一个元素的内存地址打印出来查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[0 0 4]</span><br><span class="line">[0 0 5]</span><br><span class="line">[0 0 5]</span><br></pre></td></tr></table></figure>

<h2 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h2><h3 id="以下代码输出内容："><a href="#以下代码输出内容：" class="headerlink" title="以下代码输出内容："></a>以下代码输出内容：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;runtime&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	runtime.GOMAXPROCS(1)</span><br><span class="line">	go func() &#123;</span><br><span class="line">		fmt.Println(1)</span><br><span class="line">	&#125;()</span><br><span class="line">	for &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不会有任何输出</p>
<h2 id="下面输出的内容"><a href="#下面输出的内容" class="headerlink" title="下面输出的内容"></a>下面输出的内容</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> People <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *People)</span></span> ShowA() &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;showA&quot;</span>)</span><br><span class="line">    p.ShowB()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *People)</span></span> ShowB() &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;showB&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Teacher <span class="keyword">struct</span> &#123;</span><br><span class="line">    People</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Teacher)</span></span> ShowB() &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;teacher showB&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    t := Teacher&#123;&#125;</span><br><span class="line">    t.ShowA()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">showA</span><br><span class="line">showB</span><br></pre></td></tr></table></figure>

<p>有点出乎意料，可以举个反例，如果ShowA()方法会调用到Teacher类型的ShowB()方法，假设People和Teacher并不在同一个包中时，编译一定会出现错误。</p>
<p>Go中没有继承机制，只有组合机制。</p>
<h2 id="下面代码会触发异常吗？请详细说明"><a href="#下面代码会触发异常吗？请详细说明" class="headerlink" title="下面代码会触发异常吗？请详细说明"></a>下面代码会触发异常吗？请详细说明</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	runtime.GOMAXPROCS(1)</span><br><span class="line">	int_chan := make(chan int, 1)</span><br><span class="line">	string_chan := make(chan string, 1)</span><br><span class="line">	int_chan &lt;- 1</span><br><span class="line">	string_chan &lt;- &quot;hello&quot;</span><br><span class="line">	select &#123;</span><br><span class="line">	case value := &lt;-int_chan:</span><br><span class="line">		fmt.Println(value)</span><br><span class="line">	case value := &lt;-string_chan:</span><br><span class="line">		panic(value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会间歇性触发异常，select会随机选择。</p>
<h2 id="以下代码能编译过去吗？为什么？"><a href="#以下代码能编译过去吗？为什么？" class="headerlink" title="以下代码能编译过去吗？为什么？"></a>以下代码能编译过去吗？为什么？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type People interface &#123;</span><br><span class="line">	Speak(string) string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Student struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">func (stu *Student) Speak(think string) (talk string) &#123;</span><br><span class="line">	if think == &quot;bitch&quot; &#123;</span><br><span class="line">		talk = &quot;You are a good boy&quot;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		talk = &quot;hi&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var peo People = Student&#123;&#125;</span><br><span class="line">	think := &quot;bitch&quot;</span><br><span class="line">	fmt.Println(peo.Speak(think))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不能编译过去，提示<code>Stduent does not implement People (Speak method has pointer receiver)</code>，将Speak定义更改为<code>func (stu Stduent) Speak(think string) (talk string)</code>即可编译通过。</p>
<p>main的调用方式更改为如下也可以编译通过<code>var peo People = new(Stduent)</code>。</p>
<p><code>func (stu *Stduent) Speak(think string) (talk string)</code>是<code>*Student</code>类型的方法，不是<code>Stduent</code>类型的方法。</p>
<h2 id="下面输出什么"><a href="#下面输出什么" class="headerlink" title="下面输出什么"></a>下面输出什么</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  &quot;fmt&quot;</span><br><span class="line">  &quot;time&quot;</span><br><span class="line">  &quot;runtime&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  runtime.GOMAXPROCS(1)</span><br><span class="line">  arr := [10000]int&#123;&#125;</span><br><span class="line">  for i:=0; i&lt;len(arr); i++ &#123;</span><br><span class="line">    arr[i] = i</span><br><span class="line">  &#125;</span><br><span class="line">  for _, a := range arr &#123;</span><br><span class="line">    go func() &#123;</span><br><span class="line">      fmt.Println(a)</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line">  for &#123;</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一直输出9999.涉及到goroutine的切换时机，仅系统调用或者有函数调用的情况下才会切换goroutine，for循环情况下一直没有系统调用或函数切换发生，需要等到for循环结束后才会启动新的goroutine。</p>
<h2 id="以下代码打印出来什么内容，说出为什么。。。"><a href="#以下代码打印出来什么内容，说出为什么。。。" class="headerlink" title="以下代码打印出来什么内容，说出为什么。。。"></a>以下代码打印出来什么内容，说出为什么。。。</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type People interface &#123;</span><br><span class="line">	Show()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Student struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">func (stu *Student) Show() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func live() People &#123;</span><br><span class="line">	var stu *Student</span><br><span class="line">	return stu</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	if live() == nil &#123;</span><br><span class="line">		fmt.Println(&quot;AAAAAAA&quot;)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		fmt.Println(&quot;BBBBBBB&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印<code>BBBBBBB</code>。</p>
<h2 id="byte与rune的关系"><a href="#byte与rune的关系" class="headerlink" title="byte与rune的关系"></a>byte与rune的关系</h2><ul>
<li>byte alias for uint8</li>
<li>rune alias for uint32，用来表示unicode</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    // range遍历为rune类型，输出int32</span><br><span class="line">    for _, w:=range &quot;123&quot; &#123;</span><br><span class="line">        fmt.Printf(&quot;%T&quot;, w)</span><br><span class="line">    &#125;</span><br><span class="line">    // 取数组为byte类型，输出uint8</span><br><span class="line">    fmt.Printf(&quot;%T&quot;, &quot;123&quot;[0])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="写出打印的结果"><a href="#写出打印的结果" class="headerlink" title="写出打印的结果"></a>写出打印的结果</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> People <span class="keyword">struct</span> &#123;</span><br><span class="line">	name <span class="type">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	js := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">		&quot;name&quot;:&quot;11&quot;</span></span><br><span class="line"><span class="string">	&#125;`</span></span><br><span class="line">	<span class="keyword">var</span> p People</span><br><span class="line">	p.name = <span class="string">&quot;123&quot;</span></span><br><span class="line">	err := json.Unmarshal([]<span class="type">byte</span>(js), &amp;p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;err: &quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;people: &quot;</span>, p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果为people:  {123}</p>
<h2 id="下面函数有什么问题？"><a href="#下面函数有什么问题？" class="headerlink" title="下面函数有什么问题？"></a>下面函数有什么问题？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func funcMui(x,y int)(sum int,error)&#123;</span><br><span class="line">    return x+y,nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数返回值命名 在函数有多个返回值时，只要有一个返回值有指定命名，其他的也必须有命名。 如果返回值有有多个返回值必须加上括号； 如果只有一个返回值并且有命名也需要加上括号； 此处函数第一个返回值有sum名称，第二个为命名，所以错误。</p>
<h2 id="以下函数输出什么"><a href="#以下函数输出什么" class="headerlink" title="以下函数输出什么"></a>以下函数输出什么</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	println(DeferFunc1(1))</span><br><span class="line">	println(DeferFunc2(1))</span><br><span class="line">	println(DeferFunc3(1))</span><br><span class="line">	println(DeferFunc4(1))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func DeferFunc1(i int) (t int) &#123;</span><br><span class="line">	t = i</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		t += 3</span><br><span class="line">	&#125;()</span><br><span class="line">	return t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func DeferFunc2(i int) int &#123;</span><br><span class="line">	t := i</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		t += 3</span><br><span class="line">	&#125;()</span><br><span class="line">	return t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func DeferFunc3(i int) (t int) &#123;</span><br><span class="line">	defer func() &#123;</span><br><span class="line">		t += i</span><br><span class="line">	&#125;()</span><br><span class="line">	return 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func DeferFunc4(i int) (t int) &#123;</span><br><span class="line">	t = 10</span><br><span class="line">	return 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为: <code>4 1 3 2</code></p>
<p>return语句不是一个原子指令，分为两个阶段，执行return后面的表达式和返回表达式的结果。defer函数在返回表达式之前执行。</p>
<ol>
<li>执行return后的表达式给返回值赋值</li>
<li>调用defer函数</li>
<li>空的return</li>
</ol>
<p>DeferFunc1在第一步执行表达式后t&#x3D;1，执行defer后t&#x3D;4，返回值为4</p>
<p>DeferFunc2在第一步执行表达式后t&#x3D;1，执行defer后t&#x3D;4，返回值为第一步表达式的结果1</p>
<p>DeferFunc3在第一步表达式为t&#x3D;2，执行defer后t&#x3D;3，返回值为t&#x3D;3</p>
<p>DeferFunc4在第一步执行表达式后t&#x3D;2，返回值为t&#x3D;2</p>
<h2 id="是否可以编译通过？如果通过，输出什么？"><a href="#是否可以编译通过？如果通过，输出什么？" class="headerlink" title="是否可以编译通过？如果通过，输出什么？"></a>是否可以编译通过？如果通过，输出什么？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	sn1 := struct &#123;</span><br><span class="line">		age  int</span><br><span class="line">		name string</span><br><span class="line">	&#125;&#123;age: 11, name: &quot;qq&quot;&#125;</span><br><span class="line"></span><br><span class="line">	sn2 := struct &#123;</span><br><span class="line">		age  int</span><br><span class="line">		name string</span><br><span class="line">	&#125;&#123;age: 11, name: &quot;qq&quot;&#125;</span><br><span class="line"></span><br><span class="line">	sn3 := struct &#123;</span><br><span class="line">		name string</span><br><span class="line">		age  int</span><br><span class="line">	&#125;&#123;age: 11, name: &quot;qq&quot;&#125;</span><br><span class="line"></span><br><span class="line">	if sn1 == sn2 &#123;</span><br><span class="line">		fmt.Println(&quot;sn1 == sn2&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if sn1 == sn3 &#123;</span><br><span class="line">		fmt.Println(&quot;sn1 == sn3&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sm1 := struct &#123;</span><br><span class="line">		age int</span><br><span class="line">		m   map[string]string</span><br><span class="line">	&#125;&#123;age: 11, m: map[string]string&#123;&quot;a&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">	sm2 := struct &#123;</span><br><span class="line">		age int</span><br><span class="line">		m   map[string]string</span><br><span class="line">	&#125;&#123;age: 11, m: map[string]string&#123;&quot;a&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">	if sm1 == sm2 &#123;</span><br><span class="line">		fmt.Println(&quot;sm1 == sm2&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体比较 进行结构体比较时候，只有相同类型的结构体才可以比较，结构体是否相同不但与属性类型个数有关，还与属性顺序相关。</p>
<p>还有一点需要注意的是结构体是相同的，但是结构体属性中有不可以比较的类型，如map,slice。 如果该结构属性都是可以比较的，那么就可以使用“&#x3D;&#x3D;”进行比较操作。</p>
<h2 id="是否可以编译通过？如果通过，输出什么？-1"><a href="#是否可以编译通过？如果通过，输出什么？-1" class="headerlink" title="是否可以编译通过？如果通过，输出什么？"></a>是否可以编译通过？如果通过，输出什么？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func Foo(x interface&#123;&#125;) &#123;</span><br><span class="line">	if x == nil &#123;</span><br><span class="line">		fmt.Println(&quot;empty interface&quot;)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(&quot;non-empty interface&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var x *int = nil</span><br><span class="line">	Foo(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出“non-empty interface”</p>
<h2 id="交替打印数字和字母"><a href="#交替打印数字和字母" class="headerlink" title="交替打印数字和字母"></a>交替打印数字和字母</h2><p>使用两个 goroutine 交替打印序列，一个 goroutine 打印数字， 另外一个 goroutine 打印字母， 最终效果为: <code>12AB34CD56EF78GH910IJ1112KL1314MN1516OP1718QR1920ST2122UV2324WX2526YZ2728</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	number, letter := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">	wait := <span class="built_in">new</span>(sync.WaitGroup)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">		num := <span class="number">1</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			&lt;-number</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%d%d&quot;</span>, num, num+<span class="number">1</span>)</span><br><span class="line">			num += <span class="number">2</span></span><br><span class="line">			letter &lt;- <span class="literal">true</span></span><br><span class="line">			<span class="keyword">if</span> num &gt; <span class="number">28</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		wait.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">		begin := <span class="string">&#x27;A&#x27;</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			&lt;- letter</span><br><span class="line">			<span class="keyword">if</span> begin &lt; <span class="string">&#x27;Z&#x27;</span> &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;%c%c&quot;</span>, begin, begin+<span class="number">1</span>)</span><br><span class="line">				begin+=<span class="number">2</span></span><br><span class="line">				number &lt;- <span class="literal">true</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		wait.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	number &lt;- <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	wait.Add(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	wait.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="struct类型的方法调用"><a href="#struct类型的方法调用" class="headerlink" title="struct类型的方法调用"></a>struct类型的方法调用</h2><p>假设T类型的方法上接收器既有T类型的，又有<em>T指针类型的，那么就不可以在不能寻址的T值上调用</em>T接收器的方法。</p>
<p>请看代码,试问能正常编译通过吗？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Lili <span class="keyword">struct</span>&#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Lili *Lili)</span></span> fmtPointer()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;poniter&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Lili Lili)</span></span> fmtReference()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;reference&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    li := Lili&#123;&#125;</span><br><span class="line">    li.fmtPointer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能正常编译通过，并输出”poniter”</p>
<p>请接着看以下的代码，试问能编译通过？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> Lili <span class="keyword">struct</span>&#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Lili *Lili)</span></span> fmtPointer()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;poniter&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Lili Lili)</span></span> fmtReference()&#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;reference&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Lili&#123;&#125;.fmtPointer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不能编译通过。<br>“cannot call pointer method on Lili literal”<br>“cannot take the address of Lili literal”</p>
<p>其实在第一个代码示例中，main主函数中的“li”是一个变量，li的虽然是类型Lili，但是li是可以寻址的，&amp;li的类型是<em>Lili，因此可以调用</em>Lili的方法。</p>
<h2 id="golang-context包的用法"><a href="#golang-context包的用法" class="headerlink" title="golang context包的用法"></a>golang context包的用法</h2><ol>
<li>goroutine之间的传值</li>
<li>goroutine之间的控制</li>
</ol>
<h2 id="在单核cpu的情况下，下面输出什么内容？"><a href="#在单核cpu的情况下，下面输出什么内容？" class="headerlink" title="在单核cpu的情况下，下面输出什么内容？"></a>在单核cpu的情况下，下面输出什么内容？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;sync&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">	for _, i:=range []int&#123;1, 2, 3, 4, 5&#125; &#123;</span><br><span class="line">		wg.Add(1)</span><br><span class="line">		go func() &#123;</span><br><span class="line">			defer wg.Done()</span><br><span class="line">			fmt.Println(i)</span><br><span class="line">		&#125; ()</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>考察golang的runtime机制，goroutine的切换时机只有在有系统调用或者函数调用时才会发生，本例子中的for循环结束之前不会发生goroutine的切换，所以最终输出结果为5.</p>
<h2 id="下面输出什么-1"><a href="#下面输出什么-1" class="headerlink" title="下面输出什么"></a>下面输出什么</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type People interface &#123;</span><br><span class="line">	Speak(string) string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Stduent struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">func (stu *Stduent) Speak(think string) (talk string) &#123;</span><br><span class="line">	if think == &quot;bitch&quot; &#123;</span><br><span class="line">		talk = &quot;You are a good boy&quot;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		talk = &quot;hi&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var peo People = Stduent&#123;&#125;</span><br><span class="line">	think := &quot;bitch&quot;</span><br><span class="line">	fmt.Println(peo.Speak(think))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译不通过，仅<code>*Student</code>实现了People接口，更改为<code>var peo People = &amp;Student&#123;&#125;</code>即可编译通过。</p>
<h2 id="下面输出什么-2"><a href="#下面输出什么-2" class="headerlink" title="下面输出什么"></a>下面输出什么</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">const cl = 100</span><br><span class="line"></span><br><span class="line">var bl = 123</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	println(&amp;bl, bl)</span><br><span class="line">	println(&amp;cl, cl)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译失败，常量cl通常在预处理阶段会直接展开，无法取其地址。</p>
<h2 id="以下代码是否存在问题，请解释你的判断和理由"><a href="#以下代码是否存在问题，请解释你的判断和理由" class="headerlink" title="以下代码是否存在问题，请解释你的判断和理由"></a>以下代码是否存在问题，请解释你的判断和理由</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &quot;sync&quot;</span><br><span class="line"></span><br><span class="line">func f(m sync.Mutex) &#123;</span><br><span class="line">   m.Lock()</span><br><span class="line">   defer m.Unlock()</span><br><span class="line"></span><br><span class="line">   // Do something...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mutex对象不能被值拷贝,后续传递需要使用指针的形式</p>
<h2 id="以下代码输出是什么-解释一下"><a href="#以下代码输出是什么-解释一下" class="headerlink" title="以下代码输出是什么 解释一下"></a>以下代码输出是什么 解释一下</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func    main()  &#123;</span><br><span class="line">    case1()</span><br><span class="line">    case2()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func    case1() &#123;</span><br><span class="line">   s1   :=  make([]string,  1,  20)</span><br><span class="line">   s1[0]    =   &quot;hello&quot;</span><br><span class="line">   p1   :=  &amp;s1[0]</span><br><span class="line">   s1   =   append(s1,  &quot;world&quot;)</span><br><span class="line">   *p1  =   &quot;hello2&quot;</span><br><span class="line">   fmt.Printf(&quot;value    of  p1  is  %s, value   of  s1[0]   is  %s  \n&quot;,    *p1,    s1[0])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func    case2() &#123;</span><br><span class="line">   s1   :=  make([]string)</span><br><span class="line">   s1[0]    =   &quot;hello&quot;</span><br><span class="line">   p1   :=  &amp;s1[0]</span><br><span class="line">   s1   =   append(s1,  &quot;world&quot;)</span><br><span class="line">   *p1  =   &quot;hello2&quot;</span><br><span class="line">   fmt.Printf(&quot;value    of  p1  is  %s, value   of  s1[0]   is  %s  \n&quot;,    *p1,    s1[0])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本题意在考察string和slice的数据结构，string的数据结构如下：</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/golang_string.png" alt="http://research.swtch.com/godata2.png"></p>
<p>case1的内存结构变化情况如下：</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/golang_interview_1.jpeg"></p>
<p>case2由于s1默认长度为0，直接使用s1[0]复制会出现panic错误。</p>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26972862">golang 面试题
</a></li>
<li><a target="_blank" rel="noopener" href="https://yushuangqi.com/blog/2017/golang-mian-shi-ti-da-an-yujie-xi.html?from=groupmessage&isappinstalled=0">Go面试题答案与解析</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35058068">golang面试笔试题(第二版)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lifei6671/interview-go">interview-go</a></li>
<li><a target="_blank" rel="noopener" href="https://goquiz.github.io/">Awesome Go Interview Questions and Answers
</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.51cto.com/qiangmzsx/1957477">Golang面试题解析（二）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.wtnull.com/v/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Golang%E9%9D%A2%E8%AF%95%E9%A2%98%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89.html">Golang面试题解析（三）</a></li>
<li><a target="_blank" rel="noopener" href="https://i6448038.github.io/2018/07/18/golang-mistakes/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io">golang错题集</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/resolve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/resolve/" class="post-title-link" itemprop="url">resolve.conf配置文件解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-04-24 20:55:32" itemprop="dateCreated datePublished" datetime="2018-04-24T20:55:32+00:00">2018-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一直以来对&#x2F;etc&#x2F;resolv.conf配置文件中的search和domain字段的含义不是很理解，这里重新学习记录一下。</p>
<h1 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h1><p>修改&#x2F;resolv.conf配置文件的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure>

<p>可以看到该nameserver是生效的，但是访问map域名是不生效的，因为没有map这个域名.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@localhost ~]$ ping map.baidu.com</span><br><span class="line">PING map.n.shifen.com (119.75.222.71) 56(84) bytes of data.</span><br><span class="line">64 bytes from 119.75.222.71: icmp_seq=1 ttl=63 time=4.22 ms</span><br><span class="line"></span><br><span class="line">[vagrant@localhost ~]$ ping map</span><br><span class="line">ping: unknown host map</span><br></pre></td></tr></table></figure>

<h1 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h1><p>修改文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line"></span><br><span class="line">search baidu.com google.com</span><br></pre></td></tr></table></figure>
<p>此时可以ping通map域名，解析到了跟map.baidu.com相同的域名.如果map.baidu.com的域名没有解析到，会继续解析map.google.com的域名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@localhost ~]$ ping map</span><br><span class="line">PING map.n.shifen.com (112.80.248.48) 56(84) bytes of data.</span><br><span class="line">64 bytes from 112.80.248.48: icmp_seq=1 ttl=63 time=28.6 ms</span><br></pre></td></tr></table></figure>

<p>domain的作用跟search类似，作为search的默认值，因为search可以使用多个域.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/google-autheticator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/google-autheticator/" class="post-title-link" itemprop="url">google autheticator应用现状</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-02-27 22:34:17" itemprop="dateCreated datePublished" datetime="2018-02-27T22:34:17+00:00">2018-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>通过使用Google的登陆二步验证（即Google Authenticator服务），我们在登陆时需要输入额外由手机客户端生成的一次性密码。大大提高登陆的安全性。</p>
<p>实现Google Authenticator功能需要服务器端和客户端的支持。服务器端负责密钥的生成、验证一次性密码是否正确。客户端记录密钥后生成一次性密码。</p>
<p>google实现了基于时间的TOTP算法（Time-based One-time Password），客户端实现包括了android和ios。</p>
<p>算法为公开算法，google没有提供服务端的实现，各个语言都有单独的实现。自己系统使用可以直接使用网上的代码。</p>
<p>linux下有libpam-google-authenticator模块，可以使用yum或者源码编译安装，github上有源码，编译出来的为so文件，可以加到sshd的配置文件中，用于给sshd提供二次认证机制。</p>
<p>客户端和服务端存在时间差的问题，google authenticator的超时时间为30s，服务端可以使用两个30s的时间来验证，包括当前和上一个30s。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/gitment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/gitment/" class="post-title-link" itemprop="url">hexo添加gitment评论系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-02-22 22:57:06" itemprop="dateCreated datePublished" datetime="2018-02-22T22:57:06+00:00">2018-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>曾经使用多说和网易云评论作为博客的评论系统，不幸都相继倒闭后，博客就一直没有评论系统。虽博客的访问量可以忽略不计，但本着折腾和好奇的原则，还是折腾一下gitment。</p>
<h1 id="更新hexo-theme-next主题"><a href="#更新hexo-theme-next主题" class="headerlink" title="更新hexo-theme-next主题"></a>更新hexo-theme-next主题</h1><p>最新版本的next主题已经默认支持gitment，需要将next主题升级到最新版本。</p>
<p>我的hexo-theme-next使用单独的git项目进行管理，git地址为：<a target="_blank" rel="noopener" href="https://github.com/kuring/hexo-theme-next%E3%80%82%E6%8E%A5%E4%B8%8B%E6%9D%A5%E9%9C%80%E8%A6%81%E5%B0%86fork%E5%87%BA%E6%9D%A5%E7%9A%84git%E9%A1%B9%E7%9B%AE%E8%B7%9Fnext%E7%9A%84git%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E5%90%8C%E6%AD%A5%E3%80%82">https://github.com/kuring/hexo-theme-next。接下来需要将fork出来的git项目跟next的git项目进行同步。</a></p>
<ol>
<li><p>在本地创建名字为upstream的remote，指向地址为：<code>git remote add upstream https://github.com/theme-next/hexo-theme-next.git</code></p>
</li>
<li><p>拉取next项目到本地分支，本地的分支，执行<code>git fetch upstream</code></p>
</li>
<li><p>将upsteam&#x2F;master分支合并到master分支上</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br><span class="line"></span><br><span class="line"># 由于修改了_config.yml文件，存在冲突，合并失败</span><br><span class="line">lvkai@osx:~/blog/kuring/themes/hexo-theme-next% git merge upstream/master                                                                                                128 ↵</span><br><span class="line">Removing source/css/_common/components/third-party/gentie.styl</span><br><span class="line">Removing layout/_third-party/comments/gentie.swig</span><br><span class="line">Auto-merging _config.yml</span><br><span class="line">CONFLICT (content): Merge conflict in _config.yml</span><br><span class="line">Removing README.en.md</span><br><span class="line">Automatic merge failed; fix conflicts and then commit the result.</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>解决冲突后提交并将master分支push到github仓库</li>
</ol>
<h1 id="注册gitment"><a href="#注册gitment" class="headerlink" title="注册gitment"></a>注册gitment</h1><p>前往：<a target="_blank" rel="noopener" href="https://github.com/settings/profile">https://github.com/settings/profile</a></p>
<p>Developer settings -&gt; Register a new application</p>
<p>在界面中输入如下内容：</p>
<p><img src="/images/gitment-1.png" alt="image"></p>
<p>获取到Client ID和Client Secret.</p>
<h1 id="新建github-repo"><a href="#新建github-repo" class="headerlink" title="新建github repo"></a>新建github repo</h1><p>创建新的github项目：<a target="_blank" rel="noopener" href="https://github.com/kuring/gitment-comments">https://github.com/kuring/gitment-comments</a></p>
<h1 id="在next主题中设置gitment"><a href="#在next主题中设置gitment" class="headerlink" title="在next主题中设置gitment"></a>在next主题中设置gitment</h1><p>next主题的配置文件为theme&#x2F;next&#x2F;_config.yml，修改其中的gitment设置如下，</p>
<ol>
<li>client_id为在github中注册所获取到的client id</li>
<li>client_secret为在github中注册所获取到的client secret</li>
<li>github_repo为上面新创建的github repo名称</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Gitment</span><br><span class="line"># Introduction: https://imsun.net/posts/gitment-introduction/</span><br><span class="line">gitment:</span><br><span class="line">  enable: true</span><br><span class="line">  mint: true # RECOMMEND, A mint on Gitment, to support count, language and proxy_gateway</span><br><span class="line">  count: true # Show comments count in post meta area</span><br><span class="line">  lazy: false # Comments lazy loading with a button</span><br><span class="line">  cleanly: false # Hide &#x27;Powered by ...&#x27; on footer, and more</span><br><span class="line">  language: # Force language, or auto switch by theme</span><br><span class="line">  github_user: kuring # MUST HAVE, Your Github ID</span><br><span class="line">  github_repo: gitment-comments # MUST HAVE, The repo you use to store Gitment comments</span><br><span class="line">  client_id: xxx # MUST HAVE, Github client id for the Gitment</span><br><span class="line">  client_secret: xxxx # EITHER this or proxy_gateway, Github access secret token for the Gitment</span><br><span class="line">  proxy_gateway: # Address of api proxy, See: https://github.com/aimingoo/intersect</span><br><span class="line">  redirect_protocol: # Protocol of redirect_uri with force_redirect_protocol when mint enabled</span><br></pre></td></tr></table></figure>

<p>执行<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</code>重新生成页面并在本地运行，可以看到gitment组件已经可以显示了，但是提示<code>Error: Comments Not Initialized</code>错误，点击login，然后允许认证，即可消除该错误。</p>
<p>在界面上添加评论后，可以在github repo的issuse中看到，整个搭建完毕。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/iptables/" class="post-title-link" itemprop="url">iptables基础知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-01-31 23:25:12" itemprop="dateCreated datePublished" datetime="2018-01-31T23:25:12+00:00">2018-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><h2 id="netfilter与iptables的关系"><a href="#netfilter与iptables的关系" class="headerlink" title="netfilter与iptables的关系"></a>netfilter与iptables的关系</h2><p>linux在内核中对数据包过滤和修改的模块为netfilter，netfilter模块本身并不对数据包进行过滤，只是允许将过滤数据包或修改数据包的函数hook到内核网络协议栈的适当位置。</p>
<img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/Netfilter-packet-flow.svg">

<p>iptables是用户态的工具，用于向netfilter中添加规则从而实现报文的过滤和修改等功能，工作在ip层。ebtables工作在数据链路层，用于处理以太网帧。</p>
<p>图中绿色代表iptables的表，可以看到有部分位于了数据链路层，之所以产生这种奇怪的架构，原因是bridge_nf模块，因为bridge工作在数据链路层，不一定会经过网络层，但仍然需要iptables的功能。详细信息可以在<a target="_blank" rel="noopener" href="http://ebtables.netfilter.org/br_fw_ia/br_fw_ia.html">ebtables&#x2F;iptables interaction on a Linux-based bridge</a>中了解。</p>
<p>概念：tables -&gt; chains -&gt; rules</p>
<h1 id="iptabels介绍"><a href="#iptabels介绍" class="headerlink" title="iptabels介绍"></a>iptabels介绍</h1><h2 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h2><p>每个表都由一组内置的链，还可以添加用户自定义链，只是用户自定义链没有钩子可以触发，需要从其他链通过<code>-j</code>即JUMP进行触发。</p>
<ul>
<li>INPUT 链：发往本机的报文</li>
<li>OUTPUT 链：由本机发出的报文</li>
<li>FORWARD 链：经由本机转发的报文</li>
<li>PREROUTING 链：报文到达本机，进行路由决策之前</li>
<li>POSTROUTING 链：报文由本机发出，进行路由决策之后</li>
</ul>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/iptables1.png" alt="image"></p>
<p>从chain的角度考虑数据包的流向：</p>
<ul>
<li>到本机某进程的报文：PREROUTING -&gt; INPUT</li>
<li>由本机转发的报文：PREROUTING -&gt; FORWARD -&gt; POSTROUTING</li>
<li>由本机某进程发出的报文：OUTPUT -&gt; POSTROUTING</li>
</ul>
<p>当一个网络包进入一台机器的时候，首先拿下 MAC 头看看，是不是我的。如果是，则拿下 IP 头来。得到目标 IP 之后呢，就开始进行路由判断。在路由判断之前，这个节点我们称为 PREROUTING。如果发现 IP 是我的，包就应该是我的，就发给上面的传输层，这个节点叫作 INPUT。如果发现 IP 不是我的，就需要转发出去，这个节点称为 FORWARD。如果是我的，上层处理完毕完毕后，一般会返回一个处理结果，这个处理结果会发出去，这个节点称为 OUTPUT，无论是 FORWARD 还是 OUTPUT，都是路由判断之后发生的，最后一个节点是 POSTROUTING。</p>
<h2 id="table"><a href="#table" class="headerlink" title="table"></a>table</h2><p>有了chain的概念后，为了便于chain中rule的管理，又引入了table的概念，用于存放相同功能的rule，不同功能的rule放到不同的table中。</p>
<p>包括：filter nat mangle raw</p>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>默认表，管理本机数据包的进出，用于实现包的过滤，对应内核模块iptables_filter</p>
<p>input：想要进入linux主机的包<br>output：linux主机要发送的包<br>forward：传递包到后端计算机，与nat table关联较多</p>
<h3 id="nat"><a href="#nat" class="headerlink" title="nat"></a>nat</h3><p>管理后端主机进出，与linux主机没有关系，与linux后的主机有关</p>
<p>prerouting：进行路由判断之前的规则(dnat&#x2F;redirect)<br>postrouting：路由判断之后执行的规则(snat&#x2F;masquerade)<br>output：与发出去的包有关</p>
<h3 id="mangle"><a href="#mangle" class="headerlink" title="mangle"></a>mangle</h3><p>较少使用，用于拆解报文，修改数据包，并重新封装。</p>
<h3 id="raw"><a href="#raw" class="headerlink" title="raw"></a>raw</h3><p>raw表的主要作用是允许我们给某些特定的数据包打上标记。</p>
<h2 id="rule"><a href="#rule" class="headerlink" title="rule"></a>rule</h2><p>包含了匹配条件和处理动作。</p>
<p>匹配条件包括：source ip、destination ip、source port、destination port</p>
<p>处理动作包括：</p>
<ul>
<li>accept: 将包交给协议栈</li>
<li>drop：直接丢弃数据包，不给任何回应</li>
<li>reject：拒绝数据包通过，并给一个响应信息，客户端会收到拒绝消息</li>
<li>queue: 交个某个用户态进程处理</li>
<li>dnat：目的地址转换</li>
<li>snat：源地址转换，必须要指定SNAT地址，即–to-source参数，可以是单个ip，也可以是网段。用在POSTROUTING链上。</li>
<li>masquerade: 源地址伪装，跟snat类似，不需要指定SNAT地址，会自动从服务器上获取SNAT的ip地址。如果有多个网卡的情况下，会使用路由选择算法。</li>
<li>mark: 对数据包进行打标签操作</li>
</ul>
<h2 id="table-filter-rule的关系"><a href="#table-filter-rule的关系" class="headerlink" title="table filter rule的关系"></a>table filter rule的关系</h2><p>这三者之间的关系还是相当的绕。</p>
<h3 id="链中的规则存在的表"><a href="#链中的规则存在的表" class="headerlink" title="链中的规则存在的表"></a>链中的规则存在的表</h3><p>chain中存放了rule，某些chain中注定不包含某些rule。例如prerouting链中的rule仅存在于nat raw mangle三张表中。</p>
<p>prerouting链中的规则存在的表：raw mangle nat<br>input链中的规则存在的表：mangle filter nat<br>forward链中的规则存在的表：mangle filter<br>output链中的规则存在的表：raw mangle filter nat<br>postrouting链中的规则存在的表：mangle nat</p>
<h3 id="表中的规则可以被哪些链使用"><a href="#表中的规则可以被哪些链使用" class="headerlink" title="表中的规则可以被哪些链使用"></a>表中的规则可以被哪些链使用</h3><p>raw表中的规则可以被链使用：prerouting output</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/iptables2.png" alt="image"></p>
<p>表的名字为小写，链的名字为大写</p>
<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>iptables 查询默认的表为filter，默认会列出表中所有链的规则</p>
<ul>
<li>-t 用于指定要操作的表，支持raw mangle filter nat，省略-t选项，默认使用filter表</li>
<li>-L 列出rule</li>
<li>-v 可查看更详细的信息</li>
<li>-n 规则中以ip地址的形式进行显示</li>
<li>–line-number 显示规则的编号</li>
<li>-x 包的计数以精确数字显示</li>
</ul>
<p><code>iptables -t filter -L</code>：从表的角度查询规则，用于查看filter表中的所有规则</p>
<p><code>iptables -L INPUT</code>: 从链的角度查询规则，用于查看INPUT链中的所有规则</p>
<p><code>iptables -vL INPUT</code>: 从链的角度查询规则，用于查看INPUT链中的所有规则，可查看更详细信息，包含了规则的匹配信息</p>
<p><code>iptables -nvL</code>：以精确数字显示</p>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><ul>
<li>-F: 清空规则</li>
<li>-I: 表示插入规则</li>
<li>-A: 表示以追加的方式插入规则</li>
<li><code>--dport</code>: 目的端口</li>
<li><code>--sport</code>: 源端口</li>
<li>-s: 源ip</li>
<li>-d: 目的ip</li>
<li><code>--match-set</code>：匹配ipset</li>
</ul>
<p><code>iptables -F INPUT</code>：清空filter表中的INPUT链中的所有规则。</p>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><ul>
<li>-D: 删除规则，<code>iptables -D 链名 规则编号</code>，其中规则编号可以通过<code>--line-number</code>查看到。</li>
<li>-F: 清空规则，<code>iptables -F 链名 -t 表名</code></li>
<li>-X: 删除链 <code>iptables -X 链名 -t 表名</code></li>
</ul>
<h2 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h2><p>开启trace功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># centos7 系统下有效，centos6下内核模块为ipt_LOG</span><br><span class="line">$ modprobe nf_log_ipv4</span><br><span class="line"></span><br><span class="line"># 用来验证module是否加载成功</span><br><span class="line">$ sysctl net.netfilter.nf_log.2</span><br></pre></td></tr></table></figure>

<p>要开启icmp协议的追踪，执行如下的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A OUTPUT -p icmp -m comment --comment &quot;TRACE&quot; -j TRACE</span><br><span class="line">iptables -t raw -A PREROUTING -p icmp -m comment --comment &quot;TRACE&quot; -j TRACE</span><br></pre></td></tr></table></figure>

<p>可以通过如下的命令看到插入的iptabels规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -nvL --line-number</span><br></pre></td></tr></table></figure>

<p>追踪日志最终会在&#x2F;var&#x2F;log&#x2F;message或者&#x2F;var&#x2F;log&#x2F;kern下看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Feb  6 11:22:04 c43k09006.cloud.k09.am17 kernel: TRACE: raw:PREROUTING:policy:3 IN=docker0 OUT= PHYSIN=bond0.9 MAC=02:42:30:fb:43:94:5c:c9:99:de:c4:8b:08:00 SRC=10.45.8.10 DST=10.45.4.99 LEN=84 TOS=0x00 PREC=0x00 TTL=62 ID=25550 DF PROTO=ICMP TYPE=0 CODE=0 ID=24191 SEQ=2</span><br></pre></td></tr></table></figure>

<p>格式这块的含义如下：</p>
<p>“TRACE: tablename:chainname:type:rulenum “ where type can be “rule” for plain rule, “return” for implicit rule at the end of a user defined chain and “policy” for the policy of the built in chains.</p>
<p>环境清理，删除刚刚创建的规则即可，其中1为规则的编号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 可以通过此来查询之前创建的规则编号</span><br><span class="line">iptables -t raw --line-number -nvL</span><br><span class="line"># 删除规则</span><br><span class="line">iptables -t raw -D PREROUTING 1</span><br><span class="line">iptables -t raw -D OUTPUT 1</span><br></pre></td></tr></table></figure>

<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="试验1-基本规则管理"><a href="#试验1-基本规则管理" class="headerlink" title="试验1 基本规则管理"></a>试验1 基本规则管理</h2><h3 id="插入规则"><a href="#插入规则" class="headerlink" title="插入规则"></a>插入规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># 清空filter表中的input链规则</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -F INPUT</span><br><span class="line"></span><br><span class="line"># 查看filter表中的详细规则，此时从其他机器上ping该ip是通的</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> </span><br><span class="line"># 增加规则，拒绝192.168.33.1上的请求</span><br><span class="line"># -I：表示插入</span><br><span class="line"># INPUT为要插入的链</span><br><span class="line"># -s：表示源ip地址</span><br><span class="line"># -j：表示要执行的动作</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT -s 192.168.33.1 -j DROP</span><br><span class="line"></span><br><span class="line"># 再次查询filter表中的规则，此时192.168.33.1上的报文已经不通</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 107 packets, 6170 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 56 packets, 4355 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line"># appent一条接收192.168.33.1的请求规则</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -A INPUT -s 192.168.33.1 -j ACCEPT</span><br><span class="line"># 新增加的序号为2，192.168.33.1的包匹配到1后就停止往下走，因此192.168.33.1还是ping不通当前主机</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line-number</span><br><span class="line">Chain INPUT (policy ACCEPT 65 packets, 3572 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        9   756 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">2        0     0 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line"></span><br><span class="line"># 插入一条ACCEPT rule，此时192.168.33.1可以ping通当前主机，新插入的规则优先</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT -s 192.168.33.1 -j ACCEPT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line-number</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">2       10   840 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">3        0     0 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line"></span><br><span class="line"># 新插入一条accept 192.168.33.2的规则，插入位置为2，可以看到插入到2的位置了</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT 2 -s 192.168.33.2 -j ACCEPT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line-number</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        1    84 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">2        0     0 ACCEPT     all  --  *      *       192.168.33.2         0.0.0.0/0</span><br><span class="line">3       10   840 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">4        0     0 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br></pre></td></tr></table></figure>

<h3 id="删除规则"><a href="#删除规则" class="headerlink" title="删除规则"></a>删除规则</h3><p>接下在上面实验的基础上测试删除规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 删除刚刚创建的规则2</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -D INPUT 2</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line-number</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        1    84 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">2       10   840 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line">3        0     0 ACCEPT     all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line"></span><br><span class="line"># 删除source为192.168.33.1，动作为ACCEPT的规则，实际此时执行一次命令仅能删除一条</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -D INPUT -s 192.168.33.1 -j ACCEPT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 13 packets, 736 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1       11   936 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br></pre></td></tr></table></figure>

<h3 id="修改规则"><a href="#修改规则" class="headerlink" title="修改规则"></a>修改规则</h3><p>在上面实验的基础上修改规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 将规则动作从REJECT更改为REJECT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -R INPUT 1 -s 192.168.33.1 -j REJECT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 REJECT     all  --  *      *       192.168.33.1         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"># 每个链都有一个默认规则，当前INPUT链中的默认为ACCEPT</span><br><span class="line"># 以下可以修改INPUT链的默认规则为DROP，远程连接慎用，不要问我为什么</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -P INPUT DROP</span><br></pre></td></tr></table></figure>

<h3 id="保存规则"><a href="#保存规则" class="headerlink" title="保存规则"></a>保存规则</h3><p>防火墙的所有修改都是临时的，重启系统后会失效。iptables会读取&#x2F;etc&#x2F;sysconfig&#x2F;iptables中的规则。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># iptables-save命令仅会打印当前的规则，需要使用重定向当前规则到文件中</span><br><span class="line">[root@localhost system]# iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line"># 可以从规则文件中载入规则</span><br><span class="line">[root@localhost system]# iptables-restore &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<h2 id="实验二-各类匹配条件的使用"><a href="#实验二-各类匹配条件的使用" class="headerlink" title="实验二 各类匹配条件的使用"></a>实验二 各类匹配条件的使用</h2><h3 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 可一次性插入两条规则</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT -s 192.168.33.1,192.168.33.2 -j DROP</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 31 packets, 1744 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 DROP       all  --  *      *       192.168.33.2         0.0.0.0/0</span><br><span class="line">2        0     0 DROP       all  --  *      *       192.168.33.1         0.0.0.0/0</span><br><span class="line"></span><br><span class="line"># 可指定ip网段</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -F INPUT</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT -s 192.168.33.0/24 -j DROP</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 7 packets, 388 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 DROP       all  --  *      *       192.168.33.0/24      0.0.0.0/0</span><br><span class="line"></span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -I INPUT ! -s 192.168.33.0/24 -j DROP</span><br><span class="line">[vagrant@localhost ~]$ sudo iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 19 packets, 1048 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 DROP       all  --  *      *      !10.0.2.0/24          0.0.0.0/0</span><br></pre></td></tr></table></figure>

<h3 id="协议类型"><a href="#协议类型" class="headerlink" title="协议类型"></a>协议类型</h3><p>使用-p来指定协议类型，支持tcp udp icmp等，不指定时默认匹配所有协议</p>
<h3 id="网卡接口"><a href="#网卡接口" class="headerlink" title="网卡接口"></a>网卡接口</h3><p><code>-i</code>来指定从某个网卡进入的流量，仅使用于PREROUTING INPUT FORWARD三条链。</p>
<p><code>-o</code>来指定从某个网络流出的流量，仅适用于FORWARD OUTPUT POSTROUTING三条链。</p>
<h2 id="实验三-扩展模块"><a href="#实验三-扩展模块" class="headerlink" title="实验三 扩展模块"></a>实验三 扩展模块</h2><h3 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h3><p>使用了扩展模块tcp udp，默认可以省略</p>
<p><code>--dport</code>来匹配报文的目的端口，使用时必须指定协议，即<code>-p</code>选项。<br><code>--sport</code>来匹配报文的源端口，使用时必须指定协议，即<code>-p</code>选项。</p>
<p>端口可以指定范围，例如22:25表示22-25之间的所有端口，22,25表示22和25端口，还可以配合起来使用，比如22,80:88表示22和80-88之间的端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 可以指定目的端口的范围</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -I INPUT -s 192.168.33.1 -p tcp --dport 22:25 -j REJECT</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 70 packets, 4024 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 REJECT     tcp  --  *      *       192.168.33.1         0.0.0.0/0            tcp dpts:22:25 reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>

<h3 id="iprange扩展模块"><a href="#iprange扩展模块" class="headerlink" title="iprange扩展模块"></a>iprange扩展模块</h3><p>iprange扩展模块可以指定一段连续的ip地址范围。</p>
<p><code>--src-range</code>和<code>--dst-range</code>用来指定源地址和目的范围。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vagrant]# iptables -t filter -I INPUT -m iprange --src-range 192.168.33.1-192.168.33.10 -j DROP</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 17 packets, 968 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            source IP range 192.168.33.1-192.168.33.10</span><br></pre></td></tr></table></figure>

<h3 id="string扩展模块"><a href="#string扩展模块" class="headerlink" title="string扩展模块"></a>string扩展模块</h3><p>匹配报文中包含的字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 匹配报文中包含XXOO的报文</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -I INPUT -m string --algo bm --string &quot;XXOO&quot; -j REJECT</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -nvL INPUT --line</span><br><span class="line">Chain INPUT (policy ACCEPT 15 packets, 852 bytes)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  &quot;XXOO&quot; ALGO name bm TO 65535 reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>

<h3 id="其他扩展"><a href="#其他扩展" class="headerlink" title="其他扩展"></a>其他扩展</h3><p>time扩展用来根据时间段进行匹配</p>
<p>connlimit用来对ip的并发连接数进行限制</p>
<p>limit模块限制单位时间内进出包的数量</p>
<p>tcp扩展中可以使用<code>--tcp-flags</code>可根据tcp flag进行匹配</p>
<p>state扩展可根据tcp的连接状态进行匹配</p>
<h2 id="实验四-自定义链"><a href="#实验四-自定义链" class="headerlink" title="实验四 自定义链"></a>实验四 自定义链</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># 创建自定义链 IN_WEB</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -N IN_WEB</span><br><span class="line">[root@localhost vagrant]# iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 31 packets, 1780 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 16 packets, 1216 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> </span><br><span class="line">[root@localhost vagrant]# iptables -t filter -I IN_WEB -s 192.168.33.1 -j REJECT</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -I IN_WEB -s 192.168.33.2 -j REJECT</span><br><span class="line"></span><br><span class="line">[root@localhost vagrant]# iptables -t filter -nvL IN_WEB --line</span><br><span class="line">Chain IN_WEB (0 references)</span><br><span class="line">num   pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">1        0     0 REJECT     all  --  *      *       192.168.33.2         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line">2        0     0 REJECT     all  --  *      *       192.168.33.1         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"># 将IN_WEB自定义链添加到INPUT链上</span><br><span class="line">[root@localhost vagrant]# iptables -t filter -I INPUT -p tcp --dport 80 -j IN_WEB</span><br><span class="line"># 可以看到INPUT链中多出了IN_WEB链</span><br><span class="line">[root@localhost vagrant]# iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 35 packets, 2012 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 IN_WEB     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 18 packets, 1408 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain IN_WEB (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 REJECT     all  --  *      *       192.168.33.2         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line">    0     0 REJECT     all  --  *      *       192.168.33.1         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"># 重新定义自定链名字    </span><br><span class="line">[root@localhost vagrant]# iptables -E IN_WEB WEB</span><br><span class="line">[root@localhost vagrant]# iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 39 packets, 2244 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 WEB        tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 20 packets, 1520 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain WEB (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 REJECT     all  --  *      *       192.168.33.2         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line">    0     0 REJECT     all  --  *      *       192.168.33.1         0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line">    </span><br><span class="line"># 由于iptables有自定义链，不能删除</span><br><span class="line">[root@localhost vagrant]# iptables -X WEB</span><br><span class="line">iptables: Too many links.</span><br><span class="line"># 将INPUT链引用的WEB链删除</span><br><span class="line">[root@localhost vagrant]# iptables -D INPUT 1</span><br><span class="line"># 此时仍不能删除自定义链，因为自定义链删除，需要上面没有任何规则</span><br><span class="line">[root@localhost vagrant]# iptables -X WEB</span><br><span class="line">iptables: Directory not empty.</span><br><span class="line"></span><br><span class="line"># 先清空自定义链的规则后可以删除</span><br><span class="line">[root@localhost vagrant]# iptables -F WEB</span><br><span class="line">[root@localhost vagrant]# iptables -X WEB</span><br></pre></td></tr></table></figure>


<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.zsythink.net/archives/tag/iptables/page/2/">iptables详解系列</a></li>
<li><a target="_blank" rel="noopener" href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html#ACCEPTTARGET">Iptables Tutorial 1.2.2</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/docker-registry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/docker-registry/" class="post-title-link" itemprop="url">docker私有仓库搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-12-07 18:44:59" itemprop="dateCreated datePublished" datetime="2017-12-07T18:44:59+00:00">2017-12-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>为了其他主机可访问docker registry，必须采用https协议。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/docker_registry/certs</span><br><span class="line">signdomain=103-17-184-lg-201-k08</span><br><span class="line">openssl req -nodes -subj &quot;/C=CN/ST=BeiJing/L=BeiJing/CN=$signdomain&quot; -newkey rsa:4096 -keyout ~/docker_registry/certs/$signdomain.key -out ~/docker_registry/certs/$signdomain.csr</span><br><span class="line">openssl x509 -req -days 3650 -in ~/docker_registry/certs/$signdomain.csr -signkey ~/docker_registry/certs/$signdomain.key -out ~/docker_registry/certs/$signdomain.crt</span><br></pre></td></tr></table></figure>

<p>从docker hub拉取registry镜像，并启动镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 --restart=always --name registry \</span><br><span class="line">  -v /data/docker_registry:/var/lib/registry \</span><br><span class="line">  -v /home/worker/docker_registry/certs:/certs \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/103-17-184-lg-201-k08.yidian.com.crt \</span><br><span class="line">  -e REGISTRY_HTTP_TLS_KEY=/certs/103-17-184-lg-201-k08.yidian.com.key \</span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure>

<p>停止registry镜像并删除的命令为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop registry &amp;&amp; docker rm -v registry</span><br></pre></td></tr></table></figure>

<p>下载最新的centos7镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos:7.3.1611</span><br></pre></td></tr></table></figure>

<p>将centos7镜像增加tag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker tag centos:7.3.1611 103-17-184-lg-201-k08.yidian.com:5000/centos:7.3</span><br><span class="line"></span><br><span class="line"># 可以看到列表中会多出一个镜像</span><br><span class="line">[root@103-17-184-lg-201-k08 data]# docker images</span><br><span class="line">REPOSITORY                                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/registry                             2                   047218491f8c        4 weeks ago         33.17 MB</span><br><span class="line">103-17-184-lg-201-k08.yidian.com:5000/centos   7.3                 67591570dd29        3 months ago        191.8 MB</span><br><span class="line">docker.io/centos                               7.3.1611            67591570dd29        3 months ago        191.8 MB</span><br></pre></td></tr></table></figure>

<p>docker push命令仅支持https协议，签名已经启动了自签名的https协议的registry，为了能够让docker能够信任registry，需要在&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;目录下增加相应的crt文件，增加后的目录结构为&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;103-17-184-lg-201-k08.yidian.com:5000&#x2F;103-17-184-lg-201-k08.yidian.com.crt，添加完成后需要重启docker服务。</p>
<p>将image push到registry</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 103-17-184-lg-201-k08.yidian.com:5000/centos:7.3 </span><br></pre></td></tr></table></figure>

<h1 id="api"><a href="#api" class="headerlink" title="api"></a>api</h1><ul>
<li>列出images：<a target="_blank" rel="noopener" href="https://10.103.17.184:5000/v2/_catalog">https://10.103.17.184:5000/v2/_catalog</a></li>
<li>列出image的tags：<a target="_blank" rel="noopener" href="https://10.103.17.184:5000/v2/centos/tags/list">https://10.103.17.184:5000/v2/centos/tags/list</a></li>
</ul>
<p>可以直接通过curl命令来访问api：<code>curl --cacert 103-17-184-lg-201-k08.yidian.com.crt -v https://103-17-184-lg-201-k08.yidian.com:5000/v2</code></p>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ul>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/registry/">registry</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/fengzheng/p/5168951.html">docker创建私有仓库</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">Docker Registry</a>（官方教程）</li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/spec/api/">Registry API</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/yum-build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/yum-build/" class="post-title-link" itemprop="url">yum源搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-12-07 12:10:19" itemprop="dateCreated datePublished" datetime="2017-12-07T12:10:19+00:00">2017-12-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>某些情况下需要搭建自己的yum源，比如维持特定的软件包版本等，只需要从网上下载合适的rpm包，即可构建yum源。</p>
<h1 id="repodata数据"><a href="#repodata数据" class="headerlink" title="repodata数据"></a>repodata数据</h1><p>创建&#x2F;data&#x2F;yum.repo目录用来存放rpm包。</p>
<p>可以使用yumdownloader命令来下载rpm包到本地，并且不安装。这里以安装mesos为例，在&#x2F;data&#x2F;yum.repo目录下执行<code>yumdownloader mesos</code>即可下载mesos的rpm包到本地。</p>
<p>安装createrepo：<code>yum install createrepo</code>，用来根据rpm包产生对应的包信息。</p>
<p>每加入一个rpm包需要更新下repo的信息，执行<code>createrepo --update /data/yum.repo</code>。会自动产生repodata目录。</p>
<h1 id="搭建web服务"><a href="#搭建web服务" class="headerlink" title="搭建web服务"></a>搭建web服务</h1><p>需要对外提供web服务，通常会使用nginx或者apache来对外提供服务，这里使用python SimpleHTTPServer来对外提供服务，执行<code>cd /data/yum.repo &amp;&amp; python -m SimpleHTTPServer 1080</code>。</p>
<h1 id="客户端的repo文件设置"><a href="#客户端的repo文件设置" class="headerlink" title="客户端的repo文件设置"></a>客户端的repo文件设置</h1><p>安装yum优先级插件，用来设置yum源的优先级: <code>yum install -y yum-plugin-priorities</code></p>
<p>每个需要使用该yum源的客户端需要在&#x2F;etc&#x2F;yum.repo.d&#x2F;目录下增加devops.repo文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[devops]</span><br><span class="line">name=dev-ops</span><br><span class="line">baseurl=http://10.103.17.184:1080/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">priority=1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/grafana-upgrade/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/grafana-upgrade/" class="post-title-link" itemprop="url">grafana升级</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-13 00:22:51" itemprop="dateCreated datePublished" datetime="2017-09-13T00:22:51+00:00">2017-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-21 09:46:33" itemprop="dateModified" datetime="2023-06-21T09:46:33+00:00">2023-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本次grafana的升级从版本3.1.1，变更为4.4.3，涉及到一个大的版本跨度。同时之前在使用的存储为sqlite，趁着这次升级更改为mysql。</p>
<h1 id="grafana升级"><a href="#grafana升级" class="headerlink" title="grafana升级"></a>grafana升级</h1><p>直接从官网下载对应的4.4.3版本的二进制包，修改部分配置即可，该部分没任何难度。</p>
<h1 id="sqlite-to-mysql"><a href="#sqlite-to-mysql" class="headerlink" title="sqlite to mysql"></a>sqlite to mysql</h1><p>由于grafana使用的表结构在3.1.1到4.4.3之间有变更，不能直接将3.1.1版本的sqlite中的数据导入到4.4.3的mysql中。我的方法为先使用3.1.1版grafana将数据从sqlite导入到mysql中，然后再升级grafana的版本，grafana可以自动修改表结构。</p>
<p>在的mysql中创建grafana的数据库，并修改数据库的编码为utf-8.</p>
<p>修改grafana 3.1.1配置文件conf&#x2F;defaults.ini如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[database]</span><br><span class="line"># You can configure the database connection by specifying type, host, name, user and password</span><br><span class="line"># as separate properties or as on string using the url property.</span><br><span class="line"></span><br><span class="line"># Either &quot;mysql&quot;, &quot;postgres&quot; or &quot;sqlite3&quot;, it&#x27;s your choice</span><br><span class="line">type = mysql</span><br><span class="line">host = xx.xx.xx.xx:3306</span><br><span class="line">name = grafana</span><br><span class="line">user = dev</span><br><span class="line"># If the password contains # or ; you have to wrap it with triple quotes. Ex &quot;&quot;&quot;#password;&quot;&quot;&quot;</span><br><span class="line">password = dev</span><br></pre></td></tr></table></figure>

<p>启动grafana后会自动在grafana数据库中创建相应的表结构，接下来就是将sqlite中的数据导入到mysql中。</p>
<p>在data目录下增加如下脚本sqlitedump.sh，并执行<code>sh sqlitedump.sh grafana.db &gt; grafana.sql</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">DB=$1</span><br><span class="line">TABLES=$(sqlite3 $DB .tables | grep -v migration_log)</span><br><span class="line">for t in $TABLES; do</span><br><span class="line">    echo &quot;TRUNCATE TABLE $t;&quot;</span><br><span class="line">done</span><br><span class="line">for t in $TABLES; do</span><br><span class="line">    echo -e &quot;.mode insert $t\nselect * from $t;&quot;</span><br><span class="line">done | sqlite3 $DB</span><br></pre></td></tr></table></figure>

<p>然后将grafana.sql导入到新创建的mysql。</p>
<p>将grafana 3.1.1版本停掉，将grafana 4.4.3版本的配置指向到mysql数据库，启动grafana 4.4.3后，mysql中的表结构会自动变更。</p>
<p>至此，grafana的升级完成。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
