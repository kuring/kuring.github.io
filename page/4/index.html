<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/4/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">235</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/knowledge-share-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/knowledge-share-15/" class="post-title-link" itemprop="url">技术分享第15期</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-19 22:45:32" itemprop="dateCreated datePublished" datetime="2022-03-19T22:45:32+00:00">2022-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/knowledage-15.jpg"></p>
<p>题图为周末的公园露营区。一周前曾经下过一场雪，地上覆盖着厚厚的一层雪，而一星期过后，上面却扎满了帐篷。城市里的人们，在捂了一个冬季后，终于迎来了阳光明媚的春天。虽内心充满着诗和远方，疫情之下，能约上三五好友，在草地上吃上一顿野餐，亦或在帐篷里美美的睡上一觉已是一件很奢侈的事情。</p>
<h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><h2 id="1-Submariner"><a href="#1-Submariner" class="headerlink" title="1. Submariner"></a>1. <a target="_blank" rel="noopener" href="https://www.rancher.cn/submariner/">Submariner</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/how-it-works-submariner.svg"></p>
<p>Rancher开源的一款k8s集群之间的容器网络打通的工具。k8s社区的网络插件中以overlay的网络插件居多，因为overlay的网络对底层物理网络几乎很少有依赖，通常会采用vxlan、IPIP等协议来实现。虽然overlay的网络插件用起来比较方便，但是两个k8s集群的容器网络通常是无法直接通讯，在多k8s集群的应用场景下比较受限。Submariner提供了容器网络的互通方案。 </p>
<h2 id="2-k8e"><a href="#2-k8e" class="headerlink" title="2. k8e"></a>2. <a target="_blank" rel="noopener" href="https://github.com/xiaods/k8e">k8e</a></h2><p>k8e为Kubernetes Easy的简写。社区里有k3s和k0s项目来提供了k8s精简版，本项目在k3s的基础之上又进一步进行了裁剪，移除了一些边缘场景的特性。</p>
<h2 id="3-Rancher-Desktop"><a href="#3-Rancher-Desktop" class="headerlink" title="3. Rancher Desktop"></a>3. <a target="_blank" rel="noopener" href="https://rancherdesktop.io/">Rancher Desktop</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/rancher-desktop.png"></p>
<p>k8s的发行版SUSE Rancher提供的k8s的桌面客户端，目前已经发布了1.0.0版本。</p>
<h2 id="4-nginx-config"><a href="#4-nginx-config" class="headerlink" title="4. nginx config"></a>4. <a target="_blank" rel="noopener" href="https://nginxconfig.io/">nginx config</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/nginx-config.jpg"></p>
<p>Nginx作为最流行的负载均衡配置软件之一，有自己的一套配置语法。DigitalOcean提供的nginx config工具可以通过UI直接进行配置，并最终可以一键生成nginx的配置文件。</p>
<h2 id="5-mizu"><a href="#5-mizu" class="headerlink" title="5. mizu"></a>5. <a target="_blank" rel="noopener" href="https://github.com/up9inc/mizu">mizu</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/mizu-ui.png"></p>
<p>一款部署在k8s上的流量分析工具，可以认为是k8s版的tcpdump + wireshark。底层的实现也是基于libpcap抓包的方式，可以支持解析HTTP、Redis、Kafka等协议。</p>
<h2 id="6-kube-bench"><a href="#6-kube-bench" class="headerlink" title="6. kube-bench"></a>6. <a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kube-bench">kube-bench</a></h2><p>互联网安全中心（Center for Internet Security）针对k8s版本提供了一套安全检查的规范，<a target="_blank" rel="noopener" href="https://learn.cisecurity.org/benchmarks">约有200多页的pdf文档</a>，本项目为针对该规范的实现。仅需要向k8s环境中提交一个job，即可得到最终的安全结果。很多公有云厂商也有自己的实现，比如<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/207760.html">阿里云ACK的实现</a>。</p>
<h2 id="7-virtual-kubelet"><a href="#7-virtual-kubelet" class="headerlink" title="7. virtual-kubelet"></a>7. <a target="_blank" rel="noopener" href="https://github.com/virtual-kubelet/virtual-kubelet">virtual-kubelet</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/virtual-kubelet.svg"></p>
<p>virtual kubelet服务通过在k8s集群上创建虚拟node，当一个pod调度到虚拟node时，virtual kubelet组件以插件的形式提供了不同的实现，可以将pod创建在k8s集群之外。比如，在阿里云的场景下，可以将pod创建到弹性容器实例ECI上面，从而达到弹性的目的。该项目除了用于公有云一些弹性的场景外，还常用于边缘计算的场景。</p>
<h2 id="8-cloudevents"><a href="#8-cloudevents" class="headerlink" title="8. cloudevents"></a>8. <a target="_blank" rel="noopener" href="https://cloudevents.io/">cloudevents</a></h2><p>CloudEvents定义了一种通用的方式描述事件数据的规范，由CNCF的Serverless工作组提出。阿里云的事件总线EventBridge基于此规范提供了比较好商业化产品。</p>
<p>相关链接：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SdpMLCaRSGsFnm08PjBxEA">EventBridge 事件总线及 EDA 架构解析</a></p>
<h2 id="9-kubectl-who-can"><a href="#9-kubectl-who-can" class="headerlink" title="9. kubectl-who-can"></a>9. <a target="_blank" rel="noopener" href="https://github.com/aquasecurity/kubectl-who-can">kubectl-who-can</a></h2><p>在k8s系统中，通常会通过RBAC的机制来配置某个账号拥有某种权限，但如果反过来要查询某个权限被哪些账号所拥有，就会麻烦很多。</p>
<p>该工具是一个k8s的命令行小工具，可以用来解决上述需求。比如查询拥有创建namespace权限的ServiceAccount有哪些，可以直接执行 <code>kubectl-who-can create namespace</code>。</p>
<h2 id="10-kyverno"><a href="#10-kyverno" class="headerlink" title="10. kyverno"></a>10. <a target="_blank" rel="noopener" href="https://kyverno.io/">kyverno</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/kyverno-architecture.png"></p>
<p>Kyverno是一款基于k8s的策略引擎工具，通过抽象CRD ClusterPolicy的方式来声明策略，在运行时通过webhook的技术来执行策略。相比于opa &amp; gatekeeper，更加k8s化，但却没有编程语言的灵活性。目前该项目为CNCF的孵化项目。</p>
<h1 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h1><h2 id="1-进击的Kubernetes调度系统"><a href="#1-进击的Kubernetes调度系统" class="headerlink" title="1. 进击的Kubernetes调度系统"></a>1. <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766273">进击的Kubernetes调度系统</a></h2><p>该系列一共三篇文档，分别讲解了如下内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766273">第一篇</a>：k8s 1.16版本引入的Scheduling Framework</li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766275">第二篇</a>：阿里云ACK服务基于Scheduling Framework实现的Gang scheduling</li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/770336">第三篇</a>：阿里云ACK服务基于Scheduling Framework实现的支持批任务的Binpack Scheduling</li>
</ul>
<h2 id="2-中国的云计算革命尚未开始"><a href="#2-中国的云计算革命尚未开始" class="headerlink" title="2. 中国的云计算革命尚未开始"></a>2. <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TXB5lkRCW6MTUbEkby5R-w">中国的云计算革命尚未开始</a></h2><p>作者通过工业革命时代的电气化道路做类似，认为当前云计算的阶段仍然比较初级，并且首先要解决的是人的问题，而不是技术本身。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/aliyun-product/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/aliyun-product/" class="post-title-link" itemprop="url">阿里云产品分析（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-19 22:19:24" itemprop="dateCreated datePublished" datetime="2022-03-19T22:19:24+00:00">2022-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>阿里云上有众多的云产品，本文主要分析云产品的功能以及应用场景。</p>
<h1 id="容器与中间件"><a href="#容器与中间件" class="headerlink" title="容器与中间件"></a>容器与中间件</h1><p>该部分领域与我的工作重合度较高，为重点研究领域。</p>
<h2 id="事件总线EventBridge"><a href="#事件总线EventBridge" class="headerlink" title="事件总线EventBridge"></a>事件总线EventBridge</h2><p>很多服务会产生输出供下游的服务来消费，最常见的解决办法是数据生产者通过rpc调用的方式将消息发送给数据消费者。但假如消费者的数量不止一处，该模式下就需要数据生产者将数据重复发送给多个消费者，该方式对于生产者可配置的灵活性要求非常高。</p>
<p>为了解决上述问题，将生产者和消费者解耦，解决办法就是引入一个中间层，这也是软件架构中最常见的解决复杂问题的方法。引入的中间层即为消息队列类的服务，比如Kafka。生成者仅负责生产数据到消息队列，消费者负责从消息队列消费数据，且可以存在多个消费者。生成者和消费者根本不用关心彼此，仅需要跟消息队列进行交互就可以了。</p>
<p>阿里云上的某个产品新增加了一个新的操作，比如ECS主机完成了一次快照操作，都会产生事件。如果有服务要消费事件，可以使用该产品。</p>
<p>阿里云上的很多产品会将新产生的事件发送到事件总线，另外也支持自定义事件源，通过编程的方式将事件推送到事件源上。</p>
<p>数据的消费模块跟通常的消息队列有所不同，这里的数据消费需要由事件总线产品主动推送消息到对应的服务，具体要推送到哪些服务，则需要在创建总线的时候配置，该功能即消息路由。支持的消费端包括钉钉、消息队列、Serverless服务、HTTP Server等。可以看到数据的消费端除了HTTP Server外，基本不需要额外开发一个服务，也是阿里云的一些其他云产品。</p>
<p>消息的规范完成遵循云原生社区CNCF的CloudEvent规则。</p>
<p>相关链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloudevents.io/">CloudEvents规范</a></li>
</ul>
<h2 id="弹性容器实例ECI"><a href="#弹性容器实例ECI" class="headerlink" title="弹性容器实例ECI"></a>弹性容器实例ECI</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/aliyun/eci.jpg"></p>
<p>该产品的功能比较简单，相当于提供了管控页面来创建k8s的pod，具体pod部署在哪里用户不需要关心，提供了非常好的弹性能力，充分发挥了云的优势。</p>
<p>具体在实现层面，实际上会以pod的形式部署在阿里云维护的公共k8s集群中，且容器的网络在用户指定的vpc中。</p>
<p>除了给用户提供直接创建容器实例外，还有很大一部分功能是给Serverless Kubernetes（ASK）和容器服务（ACK）来提供弹性扩缩容的功能。</p>
<h2 id="企业级分布式应用服务EDAS"><a href="#企业级分布式应用服务EDAS" class="headerlink" title="企业级分布式应用服务EDAS"></a>企业级分布式应用服务EDAS</h2><p>提供了应用托管和微服务的治理能力。</p>
<p>在应用托管方面支持应用发布到虚拟机和k8s两种方式。</p>
<p>微服务治理方面支持了Spring Cloud、Dubbo、HSF三种微服务框架。</p>
<h2 id="Serverless应用引擎SAE"><a href="#Serverless应用引擎SAE" class="headerlink" title="Serverless应用引擎SAE"></a>Serverless应用引擎SAE</h2><p>提供了类似于knative的serving功能，可以支持应用的托管，用户不需要关心底层的服务器资源，可以自动将用户的应用部署在托管的k8s集群中，且具备秒级的弹性扩缩容的功能。</p>
<h2 id="Serverless工作流SWF"><a href="#Serverless工作流SWF" class="headerlink" title="Serverless工作流SWF"></a>Serverless工作流SWF</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/work-theory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/work-theory/" class="post-title-link" itemprop="url">工作中经常用到的理论或法则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-19 00:23:24" itemprop="dateCreated datePublished" datetime="2022-03-19T00:23:24+00:00">2022-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="软件工程"><a href="#软件工程" class="headerlink" title="软件工程"></a>软件工程</h1><h2 id="康威定律"><a href="#康威定律" class="headerlink" title="康威定律"></a>康威定律</h2><p>任何一个组织在设计一个系统的时候，这个系统的结构与这个组织的沟通结构是一致的。<br>工作了这么些年对此深有感触，即“组织架构决定软件架构”。</p>
<h2 id="布鲁克定律"><a href="#布鲁克定律" class="headerlink" title="布鲁克定律"></a>布鲁克定律</h2><p>在一个已经延期的项目中增加人手只会让项目延期更长。<br>我个人不是特别认可此定律，该定律肯定是项目而定的，这要看项目的协作复杂程度，如果是体力劳动居多的项目，那么堆人还是特别好使的。</p>
<h2 id="帕金森定律"><a href="#帕金森定律" class="headerlink" title="帕金森定律"></a>帕金森定律</h2><p>一项工作会占用掉所有用来完成它的时间。即如果不给一个项目设置截止日期，那么该项目就永远完成不了。安排多少时间，就会有多少工作。</p>
<h2 id="冰山谬论"><a href="#冰山谬论" class="headerlink" title="冰山谬论"></a>冰山谬论</h2><p>一款新软件的开发成本只占管理层预算的总成本的25%左右。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="黄金圈法则"><a href="#黄金圈法则" class="headerlink" title="黄金圈法则"></a>黄金圈法则</h2><p>著名的营销顾问西蒙斯.涅克提出了一个“黄金圈”理论：三个同心圆，最里面的一个是Why,中间一层是How，最外面一层是What。</p>
<p>大多数人的思维方式是想做什么（what）和怎么做（how），不太考虑为什么这么做（why）。</p>
<p>本理论提倡的思维方式为：</p>
<ol>
<li>Why：最内层——为什么，做一件事的原因或目的，也可以说是理念和宗旨，属于战略层面；</li>
<li>How：中间层——怎么做，针对这个目的或理念的计划，也即如何去做好这件事情，属于战术层面；</li>
<li>What：最外层——是什么，最终得到什么，或者要做哪些具体的事，这基本是事情的表象，主要是执行层面的东西。</li>
</ol>
<p>该法则在软件行业的述职晋升等场景下非常适用。</p>
<ol>
<li>Why：描述为什么做这个项目？</li>
<li>How：做这个项目遇到的挑战有哪些，是怎么解决的。挑战和解决方法可以一一对应起来。</li>
<li>What：项目的最终结果，最好有具体的可以量化的指标。</li>
</ol>
<h2 id="SWOT分析法"><a href="#SWOT分析法" class="headerlink" title="SWOT分析法"></a>SWOT分析法</h2><p>常见的战略分析方法，对研究对象进行全面、系统、准确的研究。</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/swot.jpeg"></p>
<h2 id="金字塔原理"><a href="#金字塔原理" class="headerlink" title="金字塔原理"></a>金字塔原理</h2><p>参见《<a href="http://kuring.me/post/minto-pyramid/">金字塔原理总结</a>》</p>
<p>成功的面试 &#x3D; 把握正确清晰的用人标准 + 挖掘真实匹配的应聘者信息 &#x3D; 以素质模型去“发问” + 用STAR方式去“追问”</p>
<h2 id="STAR行为面试法"><a href="#STAR行为面试法" class="headerlink" title="STAR行为面试法"></a>STAR行为面试法</h2><p>STAR是业界公认的最为有效的面试方法之一，为背景（Situation）、任务（Task）、行为（Action）、结果（Result）的缩写。该方法不仅用于面试的场合，也会用于述职、晋升答辩等场景。</p>
<p>任务（Task）描述在事情里的担任的角色和负责的任务。</p>
<p>行为（Action）是最关键部分，要了解做了什么，展现出了哪些能力。</p>
<p>结果（Result）部分通常需要虚实结合，且重点在实，围绕效率、效果、质量和成本四个维度量化评估。</p>
<p>STAR方法同样适用于述职汇报或者晋升中。</p>
<h2 id="奥克姆剃刀理论"><a href="#奥克姆剃刀理论" class="headerlink" title="奥克姆剃刀理论"></a>奥克姆剃刀理论</h2><p>如无必要，勿增实体。</p>
<h2 id="马斯洛需求层次理论"><a href="#马斯洛需求层次理论" class="headerlink" title="马斯洛需求层次理论"></a>马斯洛需求层次理论</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/masiluo.png"></p>
<p>心理学中重要理论，将人类的需求分为五个层级：</p>
<ol>
<li>生理</li>
<li>安全</li>
<li>社交</li>
<li>尊重</li>
<li>自我实现</li>
</ol>
<p>人类的需求为逐步递进的，在满足了基本需求后，就会去实现更高的需求和目标。</p>
<p>在工作中，经常会用类似马斯洛需求层次理论中的金字塔结构来解释一些其他的有递进关系的场景 ，比如一个软件产品的设计目标。</p>
<h2 id="SMART-原则"><a href="#SMART-原则" class="headerlink" title="SMART 原则"></a>SMART 原则</h2><p>确定目标的五原则，通常用在绩效考核中。</p>
<ol>
<li>S（Special）：目标必须是具体的</li>
<li>M（Measurable）：目标必须是可衡量的</li>
<li>A（Attainable）：目标必须是可实现的</li>
<li>R（Relevant）：与其他的目标有一定的相关性</li>
<li>T（Time-bound）：目标必须有完成的期限</li>
</ol>
<h1 id="常见名词"><a href="#常见名词" class="headerlink" title="常见名词"></a>常见名词</h1><p>ROI：投入产出比</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-pod-errors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-pod-errors/" class="post-title-link" itemprop="url">k8s pod异常状态分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-17 15:54:47" itemprop="dateCreated datePublished" datetime="2022-03-17T15:54:47+00:00">2022-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pod状态"><a href="#pod状态" class="headerlink" title="pod状态"></a>pod状态</h1><h2 id="1-前置检查"><a href="#1-前置检查" class="headerlink" title="1. 前置检查"></a>1. 前置检查</h2><p>在排查异常状态的pod错误之前，可以先检查一下node状态，执行<code>kubectl get node</code>查看是否所有的node状态都正常。</p>
<h2 id="2-pod状态为CrashLoopBackOff"><a href="#2-pod状态为CrashLoopBackOff" class="headerlink" title="2. pod状态为CrashLoopBackOff"></a>2. pod状态为CrashLoopBackOff</h2><p>如果pod状态为CrashLoopBackOff状态，查看pod日志来定位原因，或者describe pod看一下。</p>
<h2 id="3-pod状态为Pending"><a href="#3-pod状态为Pending" class="headerlink" title="3. pod状态为Pending"></a>3. pod状态为Pending</h2><p>pod状态为Pending状态，说明调度失败，通常跟污点、标签、cpu、内存、磁盘等资源相关。</p>
<p>可以通过<code>kubectl describe pod -n &#123;NAMESPACE&#125; &#123;POD_NAME&#125;</code>，可以在最后的Event部分找到原因。</p>
<h2 id="4-pod状态为Init-0-x2F-1"><a href="#4-pod状态为Init-0-x2F-1" class="headerlink" title="4. pod状态为Init:0&#x2F;1"></a>4. pod状态为Init:0&#x2F;1</h2><p>有些pod会有Init Containers，这些container是在pod的containers执行之前先执行。如果Init Container出现未执行完成的情况，此时pod处于Init状态。</p>
<p>通过<code>kubectl get pod -n &#123;NAMESPACE&#125; &#123;POD_NAME&#125; -o yaml</code> 找到pod的Init Containers，并找到其中的name字段。执行<code>kubectl logs -n &#123;NAMESPACE&#125; &#123;POD_NAME&#125; -c &#123;INIT_CONTAINER_NAME&#125;</code>可以查看Init Container的日志来分析原因。</p>
<h2 id="5-pod状态为Terminating"><a href="#5-pod状态为Terminating" class="headerlink" title="5. pod状态为Terminating"></a>5. pod状态为Terminating</h2><p>pod处于此种状态的原因大致可分为：<br>1、pod或其控制器被删除。<br>解决方法：查看pod控制器类型和控制器名称，查看其控制器是否正常。如果正常pod将会被重建，如果pod没有被重建，查看controller-manager是否正常。<br>2、pod所在节点状态NotReady导致。<br>解决方法：检查该节点的网络，cpu，内存，磁盘空间等资源是否正常。检查该节点的kubelet、docker服务是否正常。检查该节点的网络插件pod是否正常。</p>
<p>最常见的pod处于Terminating状态的解决办法为强制删除 <code>kubectl delete pods -n $&#123;namespace&#125; $&#123;name&#125; --grace-period=0 --force</code></p>
<h2 id="6-pod状态为Evicted"><a href="#6-pod状态为Evicted" class="headerlink" title="6. pod状态为Evicted"></a>6. pod状态为Evicted</h2><p>pod处于Evicted的原因大致可分为：<br>1、kubelet服务启动时存在驱逐限制当节点资源可用量达到指定阈值（magefs.available&lt;15%,memory.available&lt;300Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5%）<br>会优先驱逐Qos级别低的pod以保障Qos级别高的pod可用。<br>解决方法：增加节点资源或将被驱逐的pod迁移到其他空闲资源充足的节点上。<br>2、pod所在节点上被打上了NoExecute的污点，此种污点会将该节点上无法容忍此污点的pod进行驱逐。<br>解决方法：查看该节点上的NoExecute污点是否必要。或者pod是否可以迁移到其他节点。<br>3、pod所在的节点为NotReady状态</p>
<p>通常可以通过<code>kubectl describe pods $&#123;pod&#125; -n $&#123;namespace&#125;</code>的底部的Events信息来找到一些问题的原因。例如下面例子中可以看到DiskPressure信息，说明跟磁盘相关。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="string">Type</span>     <span class="string">Reason</span>     <span class="string">Age</span>        <span class="string">From</span>                 <span class="string">Message</span></span><br><span class="line">  <span class="string">----</span>     <span class="string">------</span>     <span class="string">----</span>       <span class="string">----</span>                 <span class="string">-------</span></span><br><span class="line">  <span class="string">Warning</span>  <span class="string">Evicted</span>    <span class="string">61s</span>        <span class="string">kubelet,</span> <span class="attr">acs.deploy  The node had condition:</span> [<span class="string">DiskPressure</span>]<span class="string">.</span></span><br><span class="line">  <span class="string">Normal</span>   <span class="string">Scheduled</span>  <span class="string">&lt;invalid&gt;</span>  <span class="string">default-scheduler</span>    <span class="string">Successfully</span> <span class="string">assigned</span> <span class="string">ark-system/bridge-console-bridge-console-554d57bb87-nh2vd</span> <span class="string">to</span> <span class="string">acs.deploy</span></span><br></pre></td></tr></table></figure>
<p>或者根据pod的Message字段来找到原因</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Name:           tiller-deploy-7f6456894f-22vgr</span><br><span class="line">Namespace:      kube-system</span><br><span class="line">Priority:       0</span><br><span class="line">Node:           a36e04001.cloud.e04.amtest17/</span><br><span class="line">Start Time:     Mon, 08 Jun 2020 12:17:26 +0800</span><br><span class="line">Labels:         app=helm</span><br><span class="line">                name=tiller</span><br><span class="line">                pod-template-hash=7f6456894f</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line">Status:         Failed</span><br><span class="line">Reason:         Evicted</span><br><span class="line">Message:        Pod The node had condition: [DiskPressure].</span><br></pre></td></tr></table></figure>
<p>由于pod驱逐的原因排查跟时间点相关，需要根据pod被驱逐的时间来分析当时的状态。<br>4、批量删除状态Evicted的pod，此操作会删除集群里面所有状态为Evicted的pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ns=`kubectl get ns | awk &#x27;NR&gt;1 &#123;print $1&#125;&#x27;`</span><br><span class="line">for i in $ns;do  kubectl get pods -n $i  | grep Evicted| awk &#x27;&#123;print $1&#125;&#x27; | xargs  kubectl delete pods -n $i ;done</span><br></pre></td></tr></table></figure>
<h2 id="7-pod状态为Unknown"><a href="#7-pod状态为Unknown" class="headerlink" title="7. pod状态为Unknown"></a>7. pod状态为Unknown</h2><p>通常该状态为pod对应节点的为NotReady，通过查看 kubectl get node 来查看node是否为NotReady。</p>
<h2 id="8-pod为running，但是Not-Ready状态"><a href="#8-pod为running，但是Not-Ready状态" class="headerlink" title="8. pod为running，但是Not Ready状态"></a>8. pod为running，但是Not Ready状态</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">argo-ui-56f4d67b69-8gshr</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">0</span>          <span class="string">10h</span></span><br></pre></td></tr></table></figure>
<p>类似上面这种状态，此时说明pod的readiness健康检查没过导致的，需要先从pod的健康检查本身来排查问题。可以通过 <code>kubectl get pods -n $&#123;namespace&#125; $&#123;name&#125; -o yaml</code> 找到pod的健康检查部分，关键字为readiness，然后进入pod中执行对应的健康检查命令来测试健康检查的准确性。</p>
<p>例如readiness的配置如下，需要进入pod中执行<code>curl http://127.0.0.1/api/status</code>，也可以在pod对应的node节点上执行<code>curl [http://$&#123;pod_ip&#125;/api/status](http://127.0.0.1/api/status)</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/api/status</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="9-pod为ContainerCreating状态"><a href="#9-pod为ContainerCreating状态" class="headerlink" title="9. pod为ContainerCreating状态"></a>9. pod为ContainerCreating状态</h2><p>通过<code>kubectl describe pods -n $&#123;namespace&#125; $&#123;name&#125;</code>的Events部分来分析原因，可能的原因如下：</p>
<ul>
<li>网络分配ip地址失败</li>
</ul>
<h2 id="10-Init-CrashLoopBackOff"><a href="#10-Init-CrashLoopBackOff" class="headerlink" title="10. Init:CrashLoopBackOff"></a>10. Init:CrashLoopBackOff</h2><ol>
<li>通过<code>kubectl get pod -n &#123;NAMESPACE&#125; &#123;POD_NAME&#125; -o yaml</code> 找到pod的Init Containers，并找到其中的name字段。</li>
<li>执行<code>kubectl logs -n &#123;NAMESPACE&#125; &#123;POD_NAME&#125; -c &#123;INIT_CONTAINER_NAME&#125;</code>可以查看Init Container的日志来分析原因。</li>
</ol>
<h2 id="11-PodInitializing"><a href="#11-PodInitializing" class="headerlink" title="11. PodInitializing"></a>11. PodInitializing</h2><p>需要查看initContainer的日志</p>
<h2 id="12-MatchNodeSelector"><a href="#12-MatchNodeSelector" class="headerlink" title="12. MatchNodeSelector"></a>12. MatchNodeSelector</h2><p>查看pod的status信息可以看到如下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">status:</span><br><span class="line">  message: Pod Predicate MatchNodeSelector failed</span><br><span class="line">  phase: Failed</span><br><span class="line">  reason: MatchNodeSelector</span><br><span class="line">  startTime: &quot;2022-03-15T05:07:57Z&quot;</span><br></pre></td></tr></table></figure>

<p>说明该pod没有调度成功，在predicate的MatchNodeSelector阶段失败了，没有匹配上node节点。</p>
<p>在k8s 1.21之前的版本，存在bug，节点重启后可能遇到过问题，将pod delete后重新调度可以解决。<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/92067">https://github.com/kubernetes/kubernetes/issues/92067</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/412618.html#section-7gv-3tf-paf">常见的Pod异常状态及处理方式</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/grafana-dashboard-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/grafana-dashboard-k8s/" class="post-title-link" itemprop="url">用来排查k8s问题的常用grafana dashboard</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-14 23:09:31" itemprop="dateCreated datePublished" datetime="2022-03-14T23:09:31+00:00">2022-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>排查k8s上问题通常需要监控的配合，而k8s上的监控标准为prometheus，prometheus的dashboard最通用的为grafana。本文用来记录排查k8s问题时经常遇到的dashboard，dashboard监控的数据来源包括node-exporter、metrics-server、kube-state-metrics等最场景。</p>
<h2 id="node-top监控"><a href="#node-top监控" class="headerlink" title="node top监控"></a>node top监控</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/grafana-dashboard1.jpg"></p>
<p><a target="_blank" rel="noopener" href="https://kuring.oss-cn-beijing.aliyuncs.com/files/node%20top%E7%9B%91%E6%8E%A7-1647271172485.json">下载链接</a></p>
<h2 id="node上的pod监控"><a href="#node上的pod监控" class="headerlink" title="node上的pod监控"></a>node上的pod监控</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/grafana-dashboard2.jpg"></p>
<p><a target="_blank" rel="noopener" href="https://kuring.oss-cn-beijing.aliyuncs.com/files/node%E4%B8%8A%E7%9A%84pod-1647271326652.json">下载链接</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/proxy-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/proxy-server/" class="post-title-link" itemprop="url">正向代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-12 20:42:50" itemprop="dateCreated datePublished" datetime="2022-03-12T20:42:50+00:00">2022-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>正向代理通常用在远程访问某个环境中的。常见的正向代理工具包括squid、nginx、3proxy。</p>
<h2 id="squid"><a href="#squid" class="headerlink" title="squid"></a>squid</h2><p>老牌的正向代理工具。</p>
<p>安装：yum install squid &amp;&amp; systemctl start squid</p>
<p>squid默认会监听在3128端口号。</p>
<p>缺点：如果修改了本地的&#x2F;etc&#x2F;hosts文件，则需要重启squid后才可以更新。</p>
<h2 id="3proxy"><a href="#3proxy" class="headerlink" title="3proxy"></a>3proxy</h2><p>官方并没有提供yum的安装方式，比较简单的运行方式是以docker的形式。</p>
<p>执行如下的命令，即可开启3128端口作为http代理，3129端口作为sock5代理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/3proxy</span><br><span class="line">cat &gt; /etc/3proxy/3proxy.cfg &lt;&lt;EOF</span><br><span class="line">log /var/log/3proxy.log D</span><br><span class="line">logformat &quot;- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T&quot;</span><br><span class="line">rotate 7</span><br><span class="line">auth none</span><br><span class="line">flush</span><br><span class="line">allow somepu</span><br><span class="line">maxconn 200</span><br><span class="line"></span><br><span class="line"># starting HTTP proxy with disabled NTLM auth ( -n )</span><br><span class="line">proxy -p3128 -n</span><br><span class="line"></span><br><span class="line"># starting SOCKS proxy</span><br><span class="line">socks -p3129 -n</span><br><span class="line">EOF</span><br><span class="line">docker run -d --restart=always -p 3128:3128 -p 3129:3129 --net=host -v /var/log:/var/log -v /etc/3proxy/3proxy.cfg:/etc/3proxy/3proxy.cfg --name 3proxy 3proxy/3proxy</span><br></pre></td></tr></table></figure>

<h2 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h2><h3 id="终端设置代理"><a href="#终端设置代理" class="headerlink" title="终端设置代理"></a>终端设置代理</h3><p>shell支持如下的代理环境变量:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=http://localhost:1080</span><br><span class="line">export https_proxy=http://localhost:1080</span><br></pre></td></tr></table></figure>

<p>如果是 socks5 代理同样可以使用上述两个环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=socks5://localhost:1080</span><br><span class="line">export https_proxy=socks5://localhost:1080</span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/3proxy/3proxy">https://github.com/3proxy/3proxy</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ssh/" class="post-title-link" itemprop="url">ssh协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-12 17:55:00" itemprop="dateCreated datePublished" datetime="2022-03-12T17:55:00+00:00">2022-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ssh命令常用参数"><a href="#ssh命令常用参数" class="headerlink" title="ssh命令常用参数"></a>ssh命令常用参数</h2><p>指定私钥连接：<code>ssh -i ~/.ssh/id_rsa ido@192.168.1.111 -p 7744</code></p>
<h2 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h2><p>用来两台主机之间的ssh免密操作，步骤比较简单，主要实现如下两个操作：</p>
<ol>
<li>生成公钥和私钥</li>
<li>将公钥copy到要免密登录的服务器</li>
</ol>
<h3 id="生成公钥和私钥"><a href="#生成公钥和私钥" class="headerlink" title="生成公钥和私钥"></a>生成公钥和私钥</h3><p>执行 <code>ssh-keygen -b 4096 -t rsa</code> 即可在 ~&#x2F;.ssh&#x2F;目录下生成两个文件id_rsa和id_rsa.pub，其中id_rsa为私钥文件，id_rsa.pub为公钥文件。</p>
<h3 id="将公钥copy到要免密登录的服务器"><a href="#将公钥copy到要免密登录的服务器" class="headerlink" title="将公钥copy到要免密登录的服务器"></a>将公钥copy到要免密登录的服务器</h3><p>执行 <code>ssh-copy-id $user@$ip</code> 即可将本地的公钥文件放到放到要免密登录服务器的 $HOME&#x2F;.ssh&#x2F;authorized_keys 文件中。至此，免密登录的配置就完成了。</p>
<h2 id="ssh隧道"><a href="#ssh隧道" class="headerlink" title="ssh隧道"></a>ssh隧道</h2><p>动态端口转发：执行 <code>ssh root@xxxx -ND 127.0.0.1:1080</code> 即可在本机的1080端口开启一个ssh隧道。</p>
<h2 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h2><p>rsync的常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzP --delete $local_idr  $user@$remote:$remote_dir</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/OpenKruise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/OpenKruise/" class="post-title-link" itemprop="url">OpenKruise调研</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 21:14:34" itemprop="dateCreated datePublished" datetime="2022-03-08T21:14:34+00:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>OpenKruise是阿里云开源的一系列基于k8s的扩展组件的集合，其中包含了像增强版的workload、sidecar容器管理、高可用性防护等特性，包含了很多的“黑科技”。</p>
<p>如果k8s的kube-controller-manager组件可以提供非常强的扩展能力，可以实现自定义的Deployment、StatefulSet的controller，而不是使用原生的kube-controller-manager的功能，类似于实现自定义的调度器扩展功能。那么很有可能OpenKruise的实现方案就不再会采用CRD扩展的方式，而是直接在原生的Deployment、StatefulSet等对象上通过annotation的方式来实现。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>可以直接使用helm的方式安装</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">repo</span> <span class="string">add</span> <span class="string">openkruise</span> <span class="string">https://openkruise.github.io/charts/</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">kruise</span> <span class="string">openkruise/kruise</span> <span class="string">--version</span> <span class="number">1.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>安装完成后，可以看到在kruise-system下创建了一个DeamonSet和一个Deployment。并且安装了很多的CRD和webhook组件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kruise-system</span></span><br><span class="line"><span class="string">NAME</span>                                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-controller-manager-67878b65d-cv6f4</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-controller-manager-67878b65d-jrmnd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-ktwvv</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-nf84r</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-rjs26</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-vghw4</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">crd</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">kruise.io</span></span><br><span class="line"><span class="string">advancedcronjobs.apps.kruise.io</span>                           <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">broadcastjobs.apps.kruise.io</span>                              <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">clonesets.apps.kruise.io</span>                                  <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">containerrecreaterequests.apps.kruise.io</span>                  <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">daemonsets.apps.kruise.io</span>                                 <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">imagepulljobs.apps.kruise.io</span>                              <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">nodeimages.apps.kruise.io</span>                                 <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">podunavailablebudgets.policy.kruise.io</span>                    <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">resourcedistributions.apps.kruise.io</span>                      <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">sidecarsets.apps.kruise.io</span>                                <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">statefulsets.apps.kruise.io</span>                               <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">uniteddeployments.apps.kruise.io</span>                          <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">workloadspreads.apps.kruise.io</span>                            <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">validatingwebhookconfigurations</span> <span class="string">kruise-validating-webhook-configuration</span> </span><br><span class="line"><span class="string">NAME</span>                                      <span class="string">WEBHOOKS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-validating-webhook-configuration</span>   <span class="number">17</span>         <span class="string">17m</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">mutatingwebhookconfigurations</span> <span class="string">kruise-mutating-webhook-configuration</span> </span><br><span class="line"><span class="string">NAME</span>                                    <span class="string">WEBHOOKS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-mutating-webhook-configuration</span>   <span class="number">11</span>         <span class="string">17m</span></span><br></pre></td></tr></table></figure>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><table>
<thead>
<tr>
<th>大类</th>
<th>子类</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>通用工作负载</td>
<td>CloneSet</td>
<td>定位是用来代替k8s的Deployment，但做了很多能力的增强。增强的功能点：<br>1. 支持声明pvc，给pod来申请pv。当pod销毁后，pvc会同步销毁。<br>2. 指定pod来进行缩容。<br>3. 流式扩容，可以指定扩容的步长等更高级的库容特性。<br >4. 分批灰度。<br>5. 通过partition回滚。<br>6. 控制pod的升级顺序。<br>7. 发布暂停。<br>8. 原地升级自动镜像预热。<br>9. 生命周期钩子。pod的多个声明周期之间可以读取finalizer，如果finalizer中有指定的值，则controller会停止。该行为作为k8s的一种hook方式，用户可以自定义controller来控制finalizer的行为。</td>
</tr>
<tr>
<td>通用工作负载</td>
<td>Advanced StatefulSet</td>
<td>用来取代k8s原生的StatefulSet，很多增强特性跟CloneSet比较类似。<br>1. 原地升级。<br>2. 升级顺序增强。<br>3. 发布暂停。<br>4. 原地升级自动预热。<br>5. 序号跳过。StatefulSet创建的pod的后缀会从0开始依次累加，可以指定某个特定的序号跳过。<br>6. 流式扩容。</td>
</tr>
<tr>
<td>通用工作负载</td>
<td>Advanced DaemonSet</td>
<td>用来取代k8s原生的DaemonSet。1. 热升级<br>2. 暂停升级<br></td>
</tr>
<tr>
<td>任务工作负载</td>
<td>BroadcastJob</td>
<td>agent类型的job，每个节点上都会执行</td>
</tr>
<tr>
<td>任务工作负载</td>
<td>AdvancedCronJob</td>
<td>原生的CronJob的扩展版本，可以周期性创建BroadcastJob。</td>
</tr>
<tr>
<td>Sidecar容器管理</td>
<td>SidecarSet</td>
<td>用来管理Sidecar容器，其最核心的功能是支持在pod不重启的情况下Sidecar容器的热升级</td>
</tr>
<tr>
<td>多区域管理</td>
<td>WorkloadSpread</td>
<td>将workload按照不同的策略来打散，随着k8s功能不断完善，部分功能k8s已经具备。支持Deployment、ReplicaSet、CloneSet。</td>
</tr>
<tr>
<td>多区域管理</td>
<td>UnitedDeployment</td>
<td>k8s集群内可能存在不同种类型的node，该特性通过UnitedDeployment对象来管理将一个workload的不同pod分发到不同类型的节点上，并且可以指定不同类型节点的pod副本数。</td>
</tr>
<tr>
<td>增强运维</td>
<td>重启一个pod中的某个容器</td>
<td>该特性依赖于kurise-daemon组件实现，通过将容器进程停掉，kubelet检测到容器停掉后会自动将容器拉起。停掉容器的方式跟kubelet实现一致。</td>
</tr>
<tr>
<td>增强运维</td>
<td>镜像预热</td>
<td>通过ImagePullJob CR提供操作入口，底层的实现通过调用CRI的pod image接口实现</td>
</tr>
<tr>
<td>增强运维</td>
<td>控制pod中容器的启动顺序</td>
<td>kruise创建一个ConfigMap，并在pod中注入来挂载该ConfigMap，每个容器使用ConfigMap中的不同key。kruise依次往CM中增加key来实现控制容器启动顺序的目的。</td>
</tr>
<tr>
<td>增强运维</td>
<td>资源分发ResourceDestribution</td>
<td>可以跨namespace来分发CM、Secret，保证每个namespace下均有</td>
</tr>
<tr>
<td>应用安全防护</td>
<td>资源删除防护</td>
<td>通过webhook技术实现</td>
</tr>
<tr>
<td>应用安全防护</td>
<td>PodUnavailableBudget</td>
<td>通过webhook实现的k8s原生的pdb能力的增强，覆盖pdb不具备的场景</td>
</tr>
</tbody></table>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://openkruise.io/zh/docs/installation">https://openkruise.io/zh/docs/installation</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0YulmrteQSARXHa2NOBLeA">如何基于 OpenKruise 打破原生 Kubernetes 中的容器运行时操作局限？</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ack/" class="post-title-link" itemprop="url">阿里云容器服务ack技术调研（个人笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 19:54:17" itemprop="dateCreated datePublished" datetime="2022-03-08T19:54:17+00:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>阿里云容器服务是阿里云公有云基于Kubernetes企业级服务，在社区的Kubernetes版本基础上有能力增强， 本文用于调研社区增强功能，记录解决的问题、以及实现方法。ACK集群的增强功能有一部分是基于Kubernetes的api的prodiver实现，另外一部分是基于Kubernetes增加的额外组件，其中很多都已经开源，可以看到<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/196039.html">开源软件</a>列表。</p>
<p>ACK的一些组件列表可以参见：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/277412.html">组件概述</a></p>
<h1 id="产品形态"><a href="#产品形态" class="headerlink" title="产品形态"></a>产品形态</h1><ul>
<li>专有版Kubernetes：master和worker阶段均需要创建</li>
<li>托管版Kubernetes：只需要创建worker节点，master节点通过ack托管</li>
<li>Serverless Kubernetes：master节点和worker节点均不需要自己创建</li>
</ul>
<h1 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>节点</td>
<td>节点自动扩缩容</td>
<td>完全利用k8s的autoscaler实现，提供了白屏的配置功能。<a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md?spm=a2c4g.11186623.0.0.5e09135f2AAa2u&file=FAQ.md">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md?spm=a2c4g.11186623.0.0.5e09135f2AAa2u&file=FAQ.md</a></td>
</tr>
<tr>
<td></td>
<td>节点资源变配</td>
<td>master和worker节点的资源变配，通过调用ecs的变配规格接口来实现。</td>
</tr>
<tr>
<td>节点池</td>
<td></td>
<td>将节点进行了分组，同一个分组内的节点可以统一来管理。比如，可以统一设置标签污点、设置期望节点数。通过节点池实现，节点池跟弹性伸缩组为一对一关系。</td>
</tr>
</tbody></table>
<h1 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h1><table>
<thead>
<tr>
<th>类型</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>调度层</td>
<td>hpa</td>
<td>基于k8s的hpa功能实现</td>
</tr>
<tr>
<td></td>
<td>自定义指标的hpa</td>
<td>基于<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/prometheus-adapter">prometheus-adapter</a>实现的自定义指标监控</td>
</tr>
<tr>
<td></td>
<td>vpa</td>
<td>适用于大型单体应用。k8s的vpa功能实现，基于cluster-autoscaler实现</td>
</tr>
<tr>
<td></td>
<td>CronHPA</td>
<td>定期对pod进行伸缩，组件已开源：<a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/kubernetes-cronhpa-controller">kubernetes-cronhpa-controller</a></td>
</tr>
<tr>
<td></td>
<td>ElasticWorkload</td>
<td></td>
</tr>
<tr>
<td>资源层</td>
<td>节点自动伸缩</td>
<td>k8s的node自动伸缩，基于社区的cluster-autoscaler实现</td>
</tr>
<tr>
<td></td>
<td>使用ECI弹性调度</td>
<td>通过virtual-kubelet实现，将ECI抽象为k8s的node节点</td>
</tr>
</tbody></table>
<h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>详细描述</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td>基于Alibaba Cloud Linux 2支持等保2.0三级加固</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于Alibaba Cloud Linux 2支持CIS安全加固</td>
<td></td>
</tr>
<tr>
<td>基础设施</td>
<td>使用阿里云KMS提供Secret的落盘加密功能</td>
<td>在默认情况下，k8s的Secret是基于base64转码后明文存储的，存在一定的安全风险。<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/#ensuring-all-secrets-are-encrypted">k8s提供了使用外部的KMS provider来对Secret的数据进行加密的功能</a>，apiserver和provider之间的通讯协议采用<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v1beta1/service.proto">grpc接口</a>。Secret中的数据在经过KMS provider加密后存储在etcd中。ACK借助阿里云的秘钥管理服务（KMS）提供了provider实现，该<a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/ack-kms-plugin?spm=a2c4g.11186623.0.0.1cf429ecKKZx1J">provider完全开源</a>。</td>
</tr>
<tr>
<td></td>
<td>为pod动态配置阿里云产品白名单</td>
<td>ack-kubernetes-webhook-injector组件会自动将pod ip添加到阿里云产品的白名单中。</td>
</tr>
<tr>
<td></td>
<td>k8s审计日志白屏化展示</td>
<td></td>
</tr>
<tr>
<td></td>
<td>安全巡检功能</td>
<td>基于CIS Kubernetes基线的实现，用来校验k8s的安全性</td>
</tr>
<tr>
<td>容器</td>
<td>配置容器安全策略</td>
<td>基于opa实现的策略引擎，可以根据预置的规则对k8s中创建的资源进行校验，校验不通过会返回失败</td>
</tr>
<tr>
<td></td>
<td>通过巡检来检查集群中存在的安全隐患的pod</td>
<td>无</td>
</tr>
</tbody></table>
<h1 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h1><table>
<thead>
<tr>
<th>大类</th>
<th>功能项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>日志</td>
<td>日志采集功能基于logtail实现，可以采集容器日志</td>
<td>类似于开源组件log-pilot，仅需要配置环境变量，即可对日志进行收集。也可以通过AliyunLogConfig CR旁路的对日志采集进行配置。</td>
</tr>
<tr>
<td>日志</td>
<td>coredns日志</td>
<td>收集coredns日志</td>
</tr>
<tr>
<td>监控</td>
<td>基于arms产品支持应用性能监控</td>
<td></td>
</tr>
<tr>
<td>监控</td>
<td>基于ahas产品实现的架构感知监控</td>
<td></td>
</tr>
<tr>
<td>监控</td>
<td>node节点异常监控</td>
<td>npd将节点异常信息产生k8s的event</td>
</tr>
<tr>
<td>监控</td>
<td>k8s event监控</td>
<td>kube-eventer收集k8s的event</td>
</tr>
</tbody></table>
<h1 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h1><p>Container OS：为容器场景而生的操作系统，操作系统镜像大大精简，提供了安全加固能力，不支持单个软件包的升级，软件包只能跟操作系统一起原子升级。<br>安全容器katacontainer</p>
<h1 id="容器-amp-镜像"><a href="#容器-amp-镜像" class="headerlink" title="容器&amp;镜像"></a>容器&amp;镜像</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>镜像</td>
<td>容器镜像服务ACR</td>
<td>使用公有云的容器镜像服务ACR</td>
</tr>
<tr>
<td></td>
<td>验证容器镜像</td>
<td>基于开源组件kritis的kritis-validation-hook组件通过webhook的方式对镜像进行验证，确保镜像安全</td>
</tr>
</tbody></table>
<h1 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>解决问题</th>
<th>适用场景</th>
<th>具体实现</th>
</tr>
</thead>
<tbody><tr>
<td>pod调度</td>
<td>使用Descheduler组件对Pod进行调度优化</td>
<td>k8s的调度为静态的，可以确保在pod调度时为最优的，但当集群运行一段时间后，集群中资源水位会发生变化，此处无法保证整个集群是最优的。</td>
<td></td>
<td>使用社区的开源组件Descheduler对pod进行重新调度</td>
</tr>
<tr>
<td>cpu调度</td>
<td>cpu拓扑感知调度</td>
<td>k8s的cpu manager特性解决的是pod调度到同一个节点上后，通过cpuset来隔离pod的cpu争抢。但却缺乏集群级别的资源视角，从而无法做到全局最优。该特性解决cpu密集型的pod调度到同一个节点上后的争抢问题，允许不是Guaranteed级别的pod实现cpuset特性。</td>
<td>cpu敏感型应用</td>
<td>通过调度器扩展来实现pod的cpu优化调度。ack-slo-manager agent负责实现每台机器上的绑核策略。</td>
</tr>
<tr>
<td></td>
<td>cpu Brust策略优化容器性能</td>
<td>k8s的cpu limit机制会在特定的时间段内将进程可以使用的时间片进行限制。但该特性不太适合一些突发类的应用，会导致这类应用在想要cpu的时间不够用，但不想用的时候却有空闲的时间片。</td>
<td>cpu突发型应用</td>
<td>ack通过slo-manager实现cpu brust的优化，该组件会监控容器的cpu throtteld状态，并且动态调整容器中的cgroup cfs quota限制。每个节点上会部署一个resource-controller的组件来动态修改pod的cgroup配置。</td>
</tr>
<tr>
<td></td>
<td>动态调整pod的资源上限</td>
<td>k8s中要想修改pod的limit配置，只能修改pod的yaml，此时一定会导致pod重建。对于想调整pod的limit限制，却又不想重启pod的场景。</td>
<td></td>
<td>通过一个Cgroups的CR来对pod使用的cpu、内存以及磁盘的上限进行动态调整，但并不会修改pod的yaml配置，因此不会导致pod的重建。每个节点上会部署一个resource-controller的组件来动态修改pod的cgroup配置。</td>
</tr>
<tr>
<td></td>
<td>通过控制L3 cache和MBA提高不同优先级任务的隔离能力</td>
<td>不同优先级的任务调度到同一台机器上存在L3 Cache和内存带宽的资源争抢的问题</td>
<td>cpu敏感型应用</td>
<td>底层利用Intel的<a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/architecture-and-technology/resource-director-technology.html?spm=a2c4g.11186623.0.0.77dc7ccaJFCP94">RDT技术</a>来实现，该技术可以跟踪和控制同一台机器上同时运行的多个应用程序的共享资源情况，比如L3 Cache、内存带宽。每个节点上会部署一个resource-controller的组件来应用RDT的控制。</td>
</tr>
<tr>
<td></td>
<td>控制动态水位提高不同优先级pod的资源利用效率</td>
<td>为了充分利用机器资源，通常将不同优先级的pod部署在同一个节点上，pod的优先级往往随着时间段而有所变化。在白天的时候，在线业务pod优先级高；晚上离线任务优先级高。该特定可以调整一个节点上pod可以使用的资源上限。</td>
<td>在线业务pod和离线业务pod混部</td>
<td>通过ConfigMap来配置一台机器上的在线业务和离线业务可以使用的资源比例。通过Cronjob的方式来修改ConfigMap的配置，从而达到变配的效果。</td>
</tr>
<tr>
<td></td>
<td>动态资源超卖</td>
<td>一台机器上的pod在设计request和limit的时候总会预留一部分buffer，如果将所有pod的buffer加起来就非常多，从而导致机器的资源利用率很难上去。</td>
<td>pod预留buffer</td>
<td>引入了reclaimed资源来解决，未完全理解实现。文档：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/412172.html">动态资源超卖</a></td>
</tr>
<tr>
<td>gpu调度</td>
<td>GPU拓扑感知调度</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>共享GPU调度</td>
<td>GPU核共享</td>
<td></td>
<td></td>
</tr>
<tr>
<td>FPGA调度</td>
<td>暂未深入研究</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>任务调度</td>
<td>Gang scheduling</td>
<td>Coscheduling将N个pod调度到M个节点上同时运行，需要部分pod同时启动该批处理任务即可运行。如果允许的部分pod为N时，则退化为Gang Scheduling。该场景要求pod要同时创建。</td>
<td>批处理任务</td>
<td>基于Scheduling Framework实现的自定义调度器，核心机制是借助了Permit插件的pod延迟绑定功能，等到同一个group下的pod都创建后再调度。参考文章：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766275">支持批任务的Coscheduling&#x2F;Gang scheduling</a></td>
</tr>
<tr>
<td></td>
<td>Binpack scheduling</td>
<td>k8s默认的调度策略会将pod优先分配到空闲的节点上，但这样集群中的节点会存在资源碎片化的问题。Binpack调度策略会优先将节点的资源用完。</td>
<td>减少资源碎片化，尤其是GPU场景</td>
<td>基于Scheduling Framework实现的自定义调度器。参考文章：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/770336">支持批任务的Binpack Scheduling</a></td>
</tr>
<tr>
<td></td>
<td>Capacity Scheduling</td>
<td>k8s支持的namespace ResourceQuota特性可以设置一个namespace下的pod可以使用的资源上限，但不够灵活。比如一个namespace下资源耗尽，另外一个namespace还有额外的资源，但这部分资源却不能给资源耗尽的namespace使用。</td>
<td>namespace ResourceQuota特性增强</td>
<td>使用ElasticQuotaTree的方式来定义每个namespace下可以使用的资源最小值和资源上限，配合Scheduling Framework扩展来实现。</td>
</tr>
<tr>
<td>弹性调度</td>
<td>ECI弹性调度</td>
<td>充分利用ECI的弹性功能，解决k8s的node资源不够灵活的问题。</td>
<td>将pod调度到ECI</td>
<td>virtual kubelet技术将ECI抽象为k8s的node，并将pod指向调度到该node。调度到该node的pod最终会在ECI拉起容器。</td>
</tr>
<tr>
<td></td>
<td>自定义资源的优先级调度</td>
<td>k8s的调度器的策略采用固定的算法，会将所有node一视同仁，并不能针对某种类型的节点采用不同的策略。</td>
<td>自定义基于node调度策略</td>
<td>引入CRD ResourcePolicy用来定义节点调度的优先级。</td>
</tr>
<tr>
<td>负载感知调度</td>
<td>负载感知调度</td>
<td>在pod调度时，参考node节点历史的负载信息，优先将pod调度到负载较低的节点上，避免出现单个节点负载过高的情况。</td>
<td>避免node的资源使用率不均</td>
<td>通过调度器扩展实现，pod要开启该特性需要增加特性的annotation。</td>
</tr>
</tbody></table>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>容器网络</td>
<td>terway网络</td>
<td>基于ENI实现，支持ipvlan模式，基于ipvlan和eBPF实现。NetworkPolicy基于eBPF实现。</td>
</tr>
<tr>
<td></td>
<td>terway网络的Hubble组件</td>
<td>基于eBPF实现的网络流量可视化</td>
</tr>
<tr>
<td></td>
<td>为pod挂载独立公网ip</td>
<td>pod声明annotation k8s.aliyun.com&#x2F;pod-with-eip:”true”</td>
</tr>
<tr>
<td>Service网络</td>
<td>ccm跨集群部署服务</td>
<td>同一个vip可以挂载到两个k8s集群内部的Service</td>
</tr>
<tr>
<td>Ingress</td>
<td>基于Nginx Ingress实现灰度发布</td>
<td>扩展Nginx Ingress实现</td>
</tr>
<tr>
<td></td>
<td>通过AHAS支持流控特性</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于Nginx Ingress实现流量复制</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于ALB实现了ALB Ingress</td>
<td>数据面直接使用ALB的七层负载均衡功能</td>
</tr>
<tr>
<td>DNS</td>
<td>引入kubernetes项目中的addon组件NodeLocal DNSCache来增加cache层</td>
<td><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns">NodeLocal DNS Cache</a> nodelocal dns cache位于kubernetes项目中，以DaemonSet的方式运行在k8s集群中</td>
</tr>
<tr>
<td></td>
<td>ExternalDNS服务</td>
<td>用来将DNS注册到外部的公共域名服务器</td>
</tr>
<tr>
<td></td>
<td>使用DNSTAP Analyser诊断异常</td>
<td>s使用CoreDNS DNSTAP Analyser组件来接收coredns的DNS解析报文格式dnstap协议，并最终可以输出到sls对异常的DNS解析报文进行分析。</td>
</tr>
</tbody></table>
<h1 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h1><p>存储为ACK的一大亮点，借助云的丰富存储类型，通过k8s的CSI插件机制提供了块存储、文件存储、对象存储OSS和本地存储的支持。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/220839/1645347493244-2af51b21-0150-48e4-a15e-0585d5a59852.png#clientId=ub8a97252-9d7b-4&from=paste&height=916&id=ufabccb6c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=916&originWidth=2458&originalType=binary&ratio=1&size=143128&status=done&style=none&taskId=uf542f250-6209-4734-8564-306faaaaca5&width=2458" alt="image.png"></p>
<h2 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h2><ol>
<li>LVM数据卷功能，基于lvm来动态创建pv</li>
<li>QuotaPath，基于ext4的quota特性实现的本地存储的quota隔离功能</li>
<li>内存数据卷</li>
<li>持久化内存技术</li>
</ol>
<h2 id="云盘存储卷"><a href="#云盘存储卷" class="headerlink" title="云盘存储卷"></a>云盘存储卷</h2><ol>
<li>支持云盘的在线扩容，k8s 1.16版本之前可以手工扩容磁盘，但是pvc保持必变。在k8s 1.16之后，在pvc修改后，可以自动完成云盘的扩容。</li>
<li>可根据磁盘的使用水位支持云盘的自动扩容，该功能通过额外的组件storage-operator来实现，策略存放到了额外的CRD StorageAutoScalerPolicy。跟k8s的hpa和vpa功能相比，该功能没有自动缩容的功能。</li>
<li>使用k8s的存储快照功能实现了存储快照。k8s定义了VolumeSnapshotContent（类似pv）、VolumeSnapshot（类似pvc）和VolumeSnapshotClass（类似StorageClass）三个类型来实现打快照功能，快照的恢复则借助pvc的spec.dataSource字段实现。</li>
<li>加密云盘功能，同样借助云上能力实现。使用时，仅需要在StorageClass的parameters参数中指定加密参数即可。</li>
</ol>
<h1 id="Serverless-Kubernetes（ASK）"><a href="#Serverless-Kubernetes（ASK）" class="headerlink" title="Serverless Kubernetes（ASK）"></a>Serverless Kubernetes（ASK）</h1><p>适用场景：</p>
<ol>
<li>业务要求高弹性，如互联网在线服务存在波峰波谷特别明显</li>
</ol>
<p>ACK提供了k8s以及k8s的管理功能，其中k8s的master节点需要单独创建和维护，每个k8s集群使用的资源是完全独立的。在ASK中，用户仅需要创建k8s集群，而不需要关心k8s集群的核心组件具体是怎么创建的。</p>
<p>在实际上，k8s的核心组件如etcd、kube-apiserver、kube-scheduler、kube-controller-manager可能是以pod的形式运行在另外的k8s集群之上，即所谓的k8s on k8s（KOK）的方案。而且这部分组件是多个k8s集群混部的，对用户完全屏蔽了实现细节，用户仅需要聚焦在如何使用k8s即可。</p>
<p>对于k8s的node节点，用户同样不需要创建，可以认为k8s的节点资源是无限多的。ask采用了virtual kubelet的技术创建了一个虚拟的k8s node节点 <code>virtual-kubelet-$&#123;region&#125;-$&#123;zone&#125;</code>，整个k8s集群仅有一个节点。因为只有一个k8s节点，实际上k8s的管控作用会大大弱化，尤其是kube-scheduler，因为只有一个k8s节点，不存在pod调度的问题。</p>
<p>用户创建的pod资源，实际上会部署在阿里云产品弹性容器实例ECI上。新创建ask集群完成后，再到ECI上即可看到有默认的容器创建出来。ECI了创建容器的功能，给用户暴露的功能是跟k8s无关的，而ask相当于是给用户提供了以k8s的方式来创建容器。</p>
<p>ask还集成了knative，用户可以使用knative的Serving和Eventing的功能来实现社区通用的serverless服务。</p>
<p>相关链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/3zxbdvx2LmeAjt74xqhVbw">全新的网关能力增强</a></li>
</ul>
<h1 id="分布式云容器平台ACK-One"><a href="#分布式云容器平台ACK-One" class="headerlink" title="分布式云容器平台ACK One"></a>分布式云容器平台ACK One</h1><p>ack one提供了两个相对独立的功能，一个是第三方k8s集群的注册，另外一个是k8s多集群的管理和应用发布。两个功能的入口也未统一，其中一个是在ack界面，另外一个是在分布式云容器平台ack one。</p>
<p>第三方k8s集群的注册，允许用户将自己的k8s集群注册到ack上，可以从ack上来管理用户的k8s集群，而且可以部署一些ack自己的组件到用户的k8s集群上面。需要在用户的k8s集群部署一个ack-cluster-agent的服务，在用户的k8s集群跟ack可达的情况下，即可完成用户k8s集群的托管。</p>
<p>k8s多集群的管理功能，底层直接使用了kubevela项目，实现了k8s多集群的管理、多集群的应用发布功能。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>集群成本分析</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/huge-page/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/huge-page/" class="post-title-link" itemprop="url">大页内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-07 18:20:17" itemprop="dateCreated datePublished" datetime="2022-03-07T18:20:17+00:00">2022-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="大页内存介绍"><a href="#大页内存介绍" class="headerlink" title="大页内存介绍"></a>大页内存介绍</h2><p>一个操作系统上一台机器的物理内存是有限的，而操作系统上却运行着大量的进程，为了对进程屏蔽物理内存的差异，操作系统引入了虚拟内存的概念。Linux系统中虚拟内存是按照页的方式来进行管理的，每个页的默认大小为4K。如果物理内存非常大，就会导致虚拟内存和物理内存映射的页表（TLB）非常大。为了减少页表，一个可行的方法为增加页的大小。<br>​</p>
<p>可以通过如下命令来查看默认页大小：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">getconf</span> <span class="string">PAGE_SIZE</span></span><br><span class="line"><span class="number">4096</span></span><br></pre></td></tr></table></figure>
<p>在对内存要求特别严格的场景下，比如很多数据库的场景，都有巨页的需求，比如将页设置为1GB，甚至几十GB。<br>​</p>
<p>通常在大页内存的场景下，会将Linux的swap功能关闭，避免当页换出时导致的性能下降。<br>​</p>
<p>在Linux中Huge Page有2MB和1GB两种规则，其中2MB适用于GB级别的内存，1GB适用于TB级别的内存。<br>​</p>
<p>大页内存可以分为静态大页和透明大页两类。</p>
<ul>
<li>静态大页需要用户自行控制大页的分配、释放和使用。但该方式需要事先配置大页内存的量，因此用起来不够灵活。配置可以在系统启动的时候配置hugepages（页数量）和hugepagesz（页大小）两个参数。也可以使用修改内核参数的方式来预留。</li>
<li>透明大页由操作系统的后台内核线程khugepaged控制大页的分配、释放和使用。</li>
</ul>
<h2 id="静态大页内存操作"><a href="#静态大页内存操作" class="headerlink" title="静态大页内存操作"></a>静态大页内存操作</h2><p>预留大页内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 20 &gt;  /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</span><br></pre></td></tr></table></figure>
<p>可以通过&#x2F;proc&#x2F;meminfo文件系统看到大页内存的使用情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/meminfo | grep Huge</span></span><br><span class="line">AnonHugePages:   2037760 kB</span><br><span class="line">HugePages_Total:      20 # 预先分配的大页数量</span><br><span class="line">HugePages_Free:       20 # 空闲大页数量</span><br><span class="line">HugePages_Rsvd:        0 </span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>
<p>挂载hugetlb文件系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t hugetlbfs none /mnt/huge</span><br></pre></td></tr></table></figure>
<p>在应用程序中mmap映射hugetlb文件系统即可使用，对内存的操作类似于访问文件。</p>
<h2 id="透明大页内存操作（待补充）"><a href="#透明大页内存操作（待补充）" class="headerlink" title="透明大页内存操作（待补充）"></a>透明大页内存操作（待补充）</h2><p>cat &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</p>
<h2 id="大页内存在k8s的支持情况"><a href="#大页内存在k8s的支持情况" class="headerlink" title="大页内存在k8s的支持情况"></a>大页内存在k8s的支持情况</h2><p>HugePage是k8s 1.9版本中引入的特性，1.10变为beta版本，1.23版本stable版本。k8s大于1.10版本该feature默认开启。</p>
<p>在节点上配置了大页内存后，kubelet会自动感知到大页内存的配置，会修改node配置。会在hugepages-2Mi中有对应的大页内存容量，memory字段会去掉对应的大页内存量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">allocatable:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;15&quot;</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">  <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">  <span class="attr">hugepages-2Mi:</span> <span class="string">40Mi</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">63998924Ki</span></span><br><span class="line">  <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line"><span class="attr">capacity:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;16&quot;</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">  <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">  <span class="attr">hugepages-2Mi:</span> <span class="string">40Mi</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">64756684Ki</span></span><br><span class="line">  <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br></pre></td></tr></table></figure>
<p>pod在使用大页内存的时候，需要以volume的方式挂载到pod中，pod对大页内存的使用跟普通文件系统相同。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
