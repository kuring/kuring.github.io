<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/4/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">232</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/grafana-dashboard-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/grafana-dashboard-k8s/" class="post-title-link" itemprop="url">用来排查k8s问题的常用grafana dashboard</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-14 23:09:31" itemprop="dateCreated datePublished" datetime="2022-03-14T23:09:31+00:00">2022-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>排查k8s上问题通常需要监控的配合，而k8s上的监控标准为prometheus，prometheus的dashboard最通用的为grafana。本文用来记录排查k8s问题时经常遇到的dashboard，dashboard监控的数据来源包括node-exporter、metrics-server、kube-state-metrics等最场景。</p>
<h2 id="node-top监控"><a href="#node-top监控" class="headerlink" title="node top监控"></a>node top监控</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/grafana-dashboard1.jpg"></p>
<p><a target="_blank" rel="noopener" href="https://kuring.oss-cn-beijing.aliyuncs.com/files/node%20top%E7%9B%91%E6%8E%A7-1647271172485.json">下载链接</a></p>
<h2 id="node上的pod监控"><a href="#node上的pod监控" class="headerlink" title="node上的pod监控"></a>node上的pod监控</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/grafana-dashboard2.jpg"></p>
<p><a target="_blank" rel="noopener" href="https://kuring.oss-cn-beijing.aliyuncs.com/files/node%E4%B8%8A%E7%9A%84pod-1647271326652.json">下载链接</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/proxy-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/proxy-server/" class="post-title-link" itemprop="url">正向代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-12 20:42:50" itemprop="dateCreated datePublished" datetime="2022-03-12T20:42:50+00:00">2022-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>正向代理通常用在远程访问某个环境中的。常见的正向代理工具包括squid、nginx、3proxy。</p>
<h2 id="squid"><a href="#squid" class="headerlink" title="squid"></a>squid</h2><p>老牌的正向代理工具。</p>
<p>安装：yum install squid &amp;&amp; systemctl start squid</p>
<p>squid默认会监听在3128端口号。</p>
<p>缺点：如果修改了本地的&#x2F;etc&#x2F;hosts文件，则需要重启squid后才可以更新。</p>
<h2 id="3proxy"><a href="#3proxy" class="headerlink" title="3proxy"></a>3proxy</h2><p>官方并没有提供yum的安装方式，比较简单的运行方式是以docker的形式。</p>
<p>执行如下的命令，即可开启3128端口作为http代理，3129端口作为sock5代理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/3proxy</span><br><span class="line">cat &gt; /etc/3proxy/3proxy.cfg &lt;&lt;EOF</span><br><span class="line">log /var/log/3proxy.log D</span><br><span class="line">logformat &quot;- +_L%t.%. %N.%p %E %U %C:%c %R:%r %O %I %h %T&quot;</span><br><span class="line">rotate 7</span><br><span class="line">auth none</span><br><span class="line">flush</span><br><span class="line">allow somepu</span><br><span class="line">maxconn 200</span><br><span class="line"></span><br><span class="line"># starting HTTP proxy with disabled NTLM auth ( -n )</span><br><span class="line">proxy -p3128 -n</span><br><span class="line"></span><br><span class="line"># starting SOCKS proxy</span><br><span class="line">socks -p3129 -n</span><br><span class="line">EOF</span><br><span class="line">docker run -d --restart=always -p 3128:3128 -p 3129:3129 --net=host -v /var/log:/var/log -v /etc/3proxy/3proxy.cfg:/etc/3proxy/3proxy.cfg --name 3proxy 3proxy/3proxy</span><br></pre></td></tr></table></figure>

<h2 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h2><h3 id="终端设置代理"><a href="#终端设置代理" class="headerlink" title="终端设置代理"></a>终端设置代理</h3><p>shell支持如下的代理环境变量:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=http://localhost:1080</span><br><span class="line">export https_proxy=http://localhost:1080</span><br></pre></td></tr></table></figure>

<p>如果是 socks5 代理同样可以使用上述两个环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=socks5://localhost:1080</span><br><span class="line">export https_proxy=socks5://localhost:1080</span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/3proxy/3proxy">https://github.com/3proxy/3proxy</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ssh/" class="post-title-link" itemprop="url">ssh协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-12 17:55:00" itemprop="dateCreated datePublished" datetime="2022-03-12T17:55:00+00:00">2022-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ssh命令常用参数"><a href="#ssh命令常用参数" class="headerlink" title="ssh命令常用参数"></a>ssh命令常用参数</h2><p>指定私钥连接：<code>ssh -i ~/.ssh/id_rsa ido@192.168.1.111 -p 7744</code></p>
<h2 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h2><p>用来两台主机之间的ssh免密操作，步骤比较简单，主要实现如下两个操作：</p>
<ol>
<li>生成公钥和私钥</li>
<li>将公钥copy到要免密登录的服务器</li>
</ol>
<h3 id="生成公钥和私钥"><a href="#生成公钥和私钥" class="headerlink" title="生成公钥和私钥"></a>生成公钥和私钥</h3><p>执行 <code>ssh-keygen -b 4096 -t rsa</code> 即可在 ~&#x2F;.ssh&#x2F;目录下生成两个文件id_rsa和id_rsa.pub，其中id_rsa为私钥文件，id_rsa.pub为公钥文件。</p>
<h3 id="将公钥copy到要免密登录的服务器"><a href="#将公钥copy到要免密登录的服务器" class="headerlink" title="将公钥copy到要免密登录的服务器"></a>将公钥copy到要免密登录的服务器</h3><p>执行 <code>ssh-copy-id $user@$ip</code> 即可将本地的公钥文件放到放到要免密登录服务器的 $HOME&#x2F;.ssh&#x2F;authorized_keys 文件中。至此，免密登录的配置就完成了。</p>
<h2 id="ssh隧道"><a href="#ssh隧道" class="headerlink" title="ssh隧道"></a>ssh隧道</h2><p>动态端口转发：执行 <code>ssh root@xxxx -ND 127.0.0.1:1080</code> 即可在本机的1080端口开启一个ssh隧道。</p>
<h2 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h2><p>rsync的常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzP --delete $local_idr  $user@$remote:$remote_dir</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/OpenKruise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/OpenKruise/" class="post-title-link" itemprop="url">OpenKruise调研</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 21:14:34" itemprop="dateCreated datePublished" datetime="2022-03-08T21:14:34+00:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>OpenKruise是阿里云开源的一系列基于k8s的扩展组件的集合，其中包含了像增强版的workload、sidecar容器管理、高可用性防护等特性，包含了很多的“黑科技”。</p>
<p>如果k8s的kube-controller-manager组件可以提供非常强的扩展能力，可以实现自定义的Deployment、StatefulSet的controller，而不是使用原生的kube-controller-manager的功能，类似于实现自定义的调度器扩展功能。那么很有可能OpenKruise的实现方案就不再会采用CRD扩展的方式，而是直接在原生的Deployment、StatefulSet等对象上通过annotation的方式来实现。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>可以直接使用helm的方式安装</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">repo</span> <span class="string">add</span> <span class="string">openkruise</span> <span class="string">https://openkruise.github.io/charts/</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">kruise</span> <span class="string">openkruise/kruise</span> <span class="string">--version</span> <span class="number">1.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<p>安装完成后，可以看到在kruise-system下创建了一个DeamonSet和一个Deployment。并且安装了很多的CRD和webhook组件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kruise-system</span></span><br><span class="line"><span class="string">NAME</span>                                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-controller-manager-67878b65d-cv6f4</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-controller-manager-67878b65d-jrmnd</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-ktwvv</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-nf84r</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-rjs26</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"><span class="string">kruise-daemon-vghw4</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">92s</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">crd</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">kruise.io</span></span><br><span class="line"><span class="string">advancedcronjobs.apps.kruise.io</span>                           <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">broadcastjobs.apps.kruise.io</span>                              <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">clonesets.apps.kruise.io</span>                                  <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">containerrecreaterequests.apps.kruise.io</span>                  <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">daemonsets.apps.kruise.io</span>                                 <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">imagepulljobs.apps.kruise.io</span>                              <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">nodeimages.apps.kruise.io</span>                                 <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">podunavailablebudgets.policy.kruise.io</span>                    <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">resourcedistributions.apps.kruise.io</span>                      <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">sidecarsets.apps.kruise.io</span>                                <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">statefulsets.apps.kruise.io</span>                               <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">uniteddeployments.apps.kruise.io</span>                          <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"><span class="string">workloadspreads.apps.kruise.io</span>                            <span class="number">2022-03-05T13:21:39Z</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">validatingwebhookconfigurations</span> <span class="string">kruise-validating-webhook-configuration</span> </span><br><span class="line"><span class="string">NAME</span>                                      <span class="string">WEBHOOKS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-validating-webhook-configuration</span>   <span class="number">17</span>         <span class="string">17m</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span>  <span class="string">get</span> <span class="string">mutatingwebhookconfigurations</span> <span class="string">kruise-mutating-webhook-configuration</span> </span><br><span class="line"><span class="string">NAME</span>                                    <span class="string">WEBHOOKS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kruise-mutating-webhook-configuration</span>   <span class="number">11</span>         <span class="string">17m</span></span><br></pre></td></tr></table></figure>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><table>
<thead>
<tr>
<th>大类</th>
<th>子类</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>通用工作负载</td>
<td>CloneSet</td>
<td>定位是用来代替k8s的Deployment，但做了很多能力的增强。增强的功能点：<br>1. 支持声明pvc，给pod来申请pv。当pod销毁后，pvc会同步销毁。<br>2. 指定pod来进行缩容。<br>3. 流式扩容，可以指定扩容的步长等更高级的库容特性。<br >4. 分批灰度。<br>5. 通过partition回滚。<br>6. 控制pod的升级顺序。<br>7. 发布暂停。<br>8. 原地升级自动镜像预热。<br>9. 生命周期钩子。pod的多个声明周期之间可以读取finalizer，如果finalizer中有指定的值，则controller会停止。该行为作为k8s的一种hook方式，用户可以自定义controller来控制finalizer的行为。</td>
</tr>
<tr>
<td>通用工作负载</td>
<td>Advanced StatefulSet</td>
<td>用来取代k8s原生的StatefulSet，很多增强特性跟CloneSet比较类似。<br>1. 原地升级。<br>2. 升级顺序增强。<br>3. 发布暂停。<br>4. 原地升级自动预热。<br>5. 序号跳过。StatefulSet创建的pod的后缀会从0开始依次累加，可以指定某个特定的序号跳过。<br>6. 流式扩容。</td>
</tr>
<tr>
<td>通用工作负载</td>
<td>Advanced DaemonSet</td>
<td>用来取代k8s原生的DaemonSet。1. 热升级<br>2. 暂停升级<br></td>
</tr>
<tr>
<td>任务工作负载</td>
<td>BroadcastJob</td>
<td>agent类型的job，每个节点上都会执行</td>
</tr>
<tr>
<td>任务工作负载</td>
<td>AdvancedCronJob</td>
<td>原生的CronJob的扩展版本，可以周期性创建BroadcastJob。</td>
</tr>
<tr>
<td>Sidecar容器管理</td>
<td>SidecarSet</td>
<td>用来管理Sidecar容器，其最核心的功能是支持在pod不重启的情况下Sidecar容器的热升级</td>
</tr>
<tr>
<td>多区域管理</td>
<td>WorkloadSpread</td>
<td>将workload按照不同的策略来打散，随着k8s功能不断完善，部分功能k8s已经具备。支持Deployment、ReplicaSet、CloneSet。</td>
</tr>
<tr>
<td>多区域管理</td>
<td>UnitedDeployment</td>
<td>k8s集群内可能存在不同种类型的node，该特性通过UnitedDeployment对象来管理将一个workload的不同pod分发到不同类型的节点上，并且可以指定不同类型节点的pod副本数。</td>
</tr>
<tr>
<td>增强运维</td>
<td>重启一个pod中的某个容器</td>
<td>该特性依赖于kurise-daemon组件实现，通过将容器进程停掉，kubelet检测到容器停掉后会自动将容器拉起。停掉容器的方式跟kubelet实现一致。</td>
</tr>
<tr>
<td>增强运维</td>
<td>镜像预热</td>
<td>通过ImagePullJob CR提供操作入口，底层的实现通过调用CRI的pod image接口实现</td>
</tr>
<tr>
<td>增强运维</td>
<td>控制pod中容器的启动顺序</td>
<td>kruise创建一个ConfigMap，并在pod中注入来挂载该ConfigMap，每个容器使用ConfigMap中的不同key。kruise依次往CM中增加key来实现控制容器启动顺序的目的。</td>
</tr>
<tr>
<td>增强运维</td>
<td>资源分发ResourceDestribution</td>
<td>可以跨namespace来分发CM、Secret，保证每个namespace下均有</td>
</tr>
<tr>
<td>应用安全防护</td>
<td>资源删除防护</td>
<td>通过webhook技术实现</td>
</tr>
<tr>
<td>应用安全防护</td>
<td>PodUnavailableBudget</td>
<td>通过webhook实现的k8s原生的pdb能力的增强，覆盖pdb不具备的场景</td>
</tr>
</tbody></table>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://openkruise.io/zh/docs/installation">https://openkruise.io/zh/docs/installation</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0YulmrteQSARXHa2NOBLeA">如何基于 OpenKruise 打破原生 Kubernetes 中的容器运行时操作局限？</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ack/" class="post-title-link" itemprop="url">阿里云容器服务ack技术调研（个人笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-08 19:54:17" itemprop="dateCreated datePublished" datetime="2022-03-08T19:54:17+00:00">2022-03-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>阿里云容器服务是阿里云公有云基于Kubernetes企业级服务，在社区的Kubernetes版本基础上有能力增强， 本文用于调研社区增强功能，记录解决的问题、以及实现方法。ACK集群的增强功能有一部分是基于Kubernetes的api的prodiver实现，另外一部分是基于Kubernetes增加的额外组件，其中很多都已经开源，可以看到<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/196039.html">开源软件</a>列表。</p>
<p>ACK的一些组件列表可以参见：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/277412.html">组件概述</a></p>
<h1 id="产品形态"><a href="#产品形态" class="headerlink" title="产品形态"></a>产品形态</h1><ul>
<li>专有版Kubernetes：master和worker阶段均需要创建</li>
<li>托管版Kubernetes：只需要创建worker节点，master节点通过ack托管</li>
<li>Serverless Kubernetes：master节点和worker节点均不需要自己创建</li>
</ul>
<h1 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>节点</td>
<td>节点自动扩缩容</td>
<td>完全利用k8s的autoscaler实现，提供了白屏的配置功能。<a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md?spm=a2c4g.11186623.0.0.5e09135f2AAa2u&file=FAQ.md">https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md?spm=a2c4g.11186623.0.0.5e09135f2AAa2u&file=FAQ.md</a></td>
</tr>
<tr>
<td></td>
<td>节点资源变配</td>
<td>master和worker节点的资源变配，通过调用ecs的变配规格接口来实现。</td>
</tr>
<tr>
<td>节点池</td>
<td></td>
<td>将节点进行了分组，同一个分组内的节点可以统一来管理。比如，可以统一设置标签污点、设置期望节点数。通过节点池实现，节点池跟弹性伸缩组为一对一关系。</td>
</tr>
</tbody></table>
<h1 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h1><table>
<thead>
<tr>
<th>类型</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>调度层</td>
<td>hpa</td>
<td>基于k8s的hpa功能实现</td>
</tr>
<tr>
<td></td>
<td>自定义指标的hpa</td>
<td>基于<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/prometheus-adapter">prometheus-adapter</a>实现的自定义指标监控</td>
</tr>
<tr>
<td></td>
<td>vpa</td>
<td>适用于大型单体应用。k8s的vpa功能实现，基于cluster-autoscaler实现</td>
</tr>
<tr>
<td></td>
<td>CronHPA</td>
<td>定期对pod进行伸缩，组件已开源：<a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/kubernetes-cronhpa-controller">kubernetes-cronhpa-controller</a></td>
</tr>
<tr>
<td></td>
<td>ElasticWorkload</td>
<td></td>
</tr>
<tr>
<td>资源层</td>
<td>节点自动伸缩</td>
<td>k8s的node自动伸缩，基于社区的cluster-autoscaler实现</td>
</tr>
<tr>
<td></td>
<td>使用ECI弹性调度</td>
<td>通过virtual-kubelet实现，将ECI抽象为k8s的node节点</td>
</tr>
</tbody></table>
<h1 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>详细描述</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td>基于Alibaba Cloud Linux 2支持等保2.0三级加固</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于Alibaba Cloud Linux 2支持CIS安全加固</td>
<td></td>
</tr>
<tr>
<td>基础设施</td>
<td>使用阿里云KMS提供Secret的落盘加密功能</td>
<td>在默认情况下，k8s的Secret是基于base64转码后明文存储的，存在一定的安全风险。<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/#ensuring-all-secrets-are-encrypted">k8s提供了使用外部的KMS provider来对Secret的数据进行加密的功能</a>，apiserver和provider之间的通讯协议采用<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/storage/value/encrypt/envelope/v1beta1/service.proto">grpc接口</a>。Secret中的数据在经过KMS provider加密后存储在etcd中。ACK借助阿里云的秘钥管理服务（KMS）提供了provider实现，该<a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/ack-kms-plugin?spm=a2c4g.11186623.0.0.1cf429ecKKZx1J">provider完全开源</a>。</td>
</tr>
<tr>
<td></td>
<td>为pod动态配置阿里云产品白名单</td>
<td>ack-kubernetes-webhook-injector组件会自动将pod ip添加到阿里云产品的白名单中。</td>
</tr>
<tr>
<td></td>
<td>k8s审计日志白屏化展示</td>
<td></td>
</tr>
<tr>
<td></td>
<td>安全巡检功能</td>
<td>基于CIS Kubernetes基线的实现，用来校验k8s的安全性</td>
</tr>
<tr>
<td>容器</td>
<td>配置容器安全策略</td>
<td>基于opa实现的策略引擎，可以根据预置的规则对k8s中创建的资源进行校验，校验不通过会返回失败</td>
</tr>
<tr>
<td></td>
<td>通过巡检来检查集群中存在的安全隐患的pod</td>
<td>无</td>
</tr>
</tbody></table>
<h1 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h1><table>
<thead>
<tr>
<th>大类</th>
<th>功能项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>日志</td>
<td>日志采集功能基于logtail实现，可以采集容器日志</td>
<td>类似于开源组件log-pilot，仅需要配置环境变量，即可对日志进行收集。也可以通过AliyunLogConfig CR旁路的对日志采集进行配置。</td>
</tr>
<tr>
<td>日志</td>
<td>coredns日志</td>
<td>收集coredns日志</td>
</tr>
<tr>
<td>监控</td>
<td>基于arms产品支持应用性能监控</td>
<td></td>
</tr>
<tr>
<td>监控</td>
<td>基于ahas产品实现的架构感知监控</td>
<td></td>
</tr>
<tr>
<td>监控</td>
<td>node节点异常监控</td>
<td>npd将节点异常信息产生k8s的event</td>
</tr>
<tr>
<td>监控</td>
<td>k8s event监控</td>
<td>kube-eventer收集k8s的event</td>
</tr>
</tbody></table>
<h1 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h1><p>Container OS：为容器场景而生的操作系统，操作系统镜像大大精简，提供了安全加固能力，不支持单个软件包的升级，软件包只能跟操作系统一起原子升级。<br>安全容器katacontainer</p>
<h1 id="容器-amp-镜像"><a href="#容器-amp-镜像" class="headerlink" title="容器&amp;镜像"></a>容器&amp;镜像</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>镜像</td>
<td>容器镜像服务ACR</td>
<td>使用公有云的容器镜像服务ACR</td>
</tr>
<tr>
<td></td>
<td>验证容器镜像</td>
<td>基于开源组件kritis的kritis-validation-hook组件通过webhook的方式对镜像进行验证，确保镜像安全</td>
</tr>
</tbody></table>
<h1 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>解决问题</th>
<th>适用场景</th>
<th>具体实现</th>
</tr>
</thead>
<tbody><tr>
<td>pod调度</td>
<td>使用Descheduler组件对Pod进行调度优化</td>
<td>k8s的调度为静态的，可以确保在pod调度时为最优的，但当集群运行一段时间后，集群中资源水位会发生变化，此处无法保证整个集群是最优的。</td>
<td></td>
<td>使用社区的开源组件Descheduler对pod进行重新调度</td>
</tr>
<tr>
<td>cpu调度</td>
<td>cpu拓扑感知调度</td>
<td>k8s的cpu manager特性解决的是pod调度到同一个节点上后，通过cpuset来隔离pod的cpu争抢。但却缺乏集群级别的资源视角，从而无法做到全局最优。该特性解决cpu密集型的pod调度到同一个节点上后的争抢问题，允许不是Guaranteed级别的pod实现cpuset特性。</td>
<td>cpu敏感型应用</td>
<td>通过调度器扩展来实现pod的cpu优化调度。ack-slo-manager agent负责实现每台机器上的绑核策略。</td>
</tr>
<tr>
<td></td>
<td>cpu Brust策略优化容器性能</td>
<td>k8s的cpu limit机制会在特定的时间段内将进程可以使用的时间片进行限制。但该特性不太适合一些突发类的应用，会导致这类应用在想要cpu的时间不够用，但不想用的时候却有空闲的时间片。</td>
<td>cpu突发型应用</td>
<td>ack通过slo-manager实现cpu brust的优化，该组件会监控容器的cpu throtteld状态，并且动态调整容器中的cgroup cfs quota限制。每个节点上会部署一个resource-controller的组件来动态修改pod的cgroup配置。</td>
</tr>
<tr>
<td></td>
<td>动态调整pod的资源上限</td>
<td>k8s中要想修改pod的limit配置，只能修改pod的yaml，此时一定会导致pod重建。对于想调整pod的limit限制，却又不想重启pod的场景。</td>
<td></td>
<td>通过一个Cgroups的CR来对pod使用的cpu、内存以及磁盘的上限进行动态调整，但并不会修改pod的yaml配置，因此不会导致pod的重建。每个节点上会部署一个resource-controller的组件来动态修改pod的cgroup配置。</td>
</tr>
<tr>
<td></td>
<td>通过控制L3 cache和MBA提高不同优先级任务的隔离能力</td>
<td>不同优先级的任务调度到同一台机器上存在L3 Cache和内存带宽的资源争抢的问题</td>
<td>cpu敏感型应用</td>
<td>底层利用Intel的<a target="_blank" rel="noopener" href="https://www.intel.cn/content/www/cn/zh/architecture-and-technology/resource-director-technology.html?spm=a2c4g.11186623.0.0.77dc7ccaJFCP94">RDT技术</a>来实现，该技术可以跟踪和控制同一台机器上同时运行的多个应用程序的共享资源情况，比如L3 Cache、内存带宽。每个节点上会部署一个resource-controller的组件来应用RDT的控制。</td>
</tr>
<tr>
<td></td>
<td>控制动态水位提高不同优先级pod的资源利用效率</td>
<td>为了充分利用机器资源，通常将不同优先级的pod部署在同一个节点上，pod的优先级往往随着时间段而有所变化。在白天的时候，在线业务pod优先级高；晚上离线任务优先级高。该特定可以调整一个节点上pod可以使用的资源上限。</td>
<td>在线业务pod和离线业务pod混部</td>
<td>通过ConfigMap来配置一台机器上的在线业务和离线业务可以使用的资源比例。通过Cronjob的方式来修改ConfigMap的配置，从而达到变配的效果。</td>
</tr>
<tr>
<td></td>
<td>动态资源超卖</td>
<td>一台机器上的pod在设计request和limit的时候总会预留一部分buffer，如果将所有pod的buffer加起来就非常多，从而导致机器的资源利用率很难上去。</td>
<td>pod预留buffer</td>
<td>引入了reclaimed资源来解决，未完全理解实现。文档：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/412172.html">动态资源超卖</a></td>
</tr>
<tr>
<td>gpu调度</td>
<td>GPU拓扑感知调度</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>共享GPU调度</td>
<td>GPU核共享</td>
<td></td>
<td></td>
</tr>
<tr>
<td>FPGA调度</td>
<td>暂未深入研究</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>任务调度</td>
<td>Gang scheduling</td>
<td>Coscheduling将N个pod调度到M个节点上同时运行，需要部分pod同时启动该批处理任务即可运行。如果允许的部分pod为N时，则退化为Gang Scheduling。该场景要求pod要同时创建。</td>
<td>批处理任务</td>
<td>基于Scheduling Framework实现的自定义调度器，核心机制是借助了Permit插件的pod延迟绑定功能，等到同一个group下的pod都创建后再调度。参考文章：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766275">支持批任务的Coscheduling&#x2F;Gang scheduling</a></td>
</tr>
<tr>
<td></td>
<td>Binpack scheduling</td>
<td>k8s默认的调度策略会将pod优先分配到空闲的节点上，但这样集群中的节点会存在资源碎片化的问题。Binpack调度策略会优先将节点的资源用完。</td>
<td>减少资源碎片化，尤其是GPU场景</td>
<td>基于Scheduling Framework实现的自定义调度器。参考文章：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/770336">支持批任务的Binpack Scheduling</a></td>
</tr>
<tr>
<td></td>
<td>Capacity Scheduling</td>
<td>k8s支持的namespace ResourceQuota特性可以设置一个namespace下的pod可以使用的资源上限，但不够灵活。比如一个namespace下资源耗尽，另外一个namespace还有额外的资源，但这部分资源却不能给资源耗尽的namespace使用。</td>
<td>namespace ResourceQuota特性增强</td>
<td>使用ElasticQuotaTree的方式来定义每个namespace下可以使用的资源最小值和资源上限，配合Scheduling Framework扩展来实现。</td>
</tr>
<tr>
<td>弹性调度</td>
<td>ECI弹性调度</td>
<td>充分利用ECI的弹性功能，解决k8s的node资源不够灵活的问题。</td>
<td>将pod调度到ECI</td>
<td>virtual kubelet技术将ECI抽象为k8s的node，并将pod指向调度到该node。调度到该node的pod最终会在ECI拉起容器。</td>
</tr>
<tr>
<td></td>
<td>自定义资源的优先级调度</td>
<td>k8s的调度器的策略采用固定的算法，会将所有node一视同仁，并不能针对某种类型的节点采用不同的策略。</td>
<td>自定义基于node调度策略</td>
<td>引入CRD ResourcePolicy用来定义节点调度的优先级。</td>
</tr>
<tr>
<td>负载感知调度</td>
<td>负载感知调度</td>
<td>在pod调度时，参考node节点历史的负载信息，优先将pod调度到负载较低的节点上，避免出现单个节点负载过高的情况。</td>
<td>避免node的资源使用率不均</td>
<td>通过调度器扩展实现，pod要开启该特性需要增加特性的annotation。</td>
</tr>
</tbody></table>
<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><table>
<thead>
<tr>
<th>大类</th>
<th>特性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>容器网络</td>
<td>terway网络</td>
<td>基于ENI实现，支持ipvlan模式，基于ipvlan和eBPF实现。NetworkPolicy基于eBPF实现。</td>
</tr>
<tr>
<td></td>
<td>terway网络的Hubble组件</td>
<td>基于eBPF实现的网络流量可视化</td>
</tr>
<tr>
<td></td>
<td>为pod挂载独立公网ip</td>
<td>pod声明annotation k8s.aliyun.com&#x2F;pod-with-eip:”true”</td>
</tr>
<tr>
<td>Service网络</td>
<td>ccm跨集群部署服务</td>
<td>同一个vip可以挂载到两个k8s集群内部的Service</td>
</tr>
<tr>
<td>Ingress</td>
<td>基于Nginx Ingress实现灰度发布</td>
<td>扩展Nginx Ingress实现</td>
</tr>
<tr>
<td></td>
<td>通过AHAS支持流控特性</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于Nginx Ingress实现流量复制</td>
<td></td>
</tr>
<tr>
<td></td>
<td>基于ALB实现了ALB Ingress</td>
<td>数据面直接使用ALB的七层负载均衡功能</td>
</tr>
<tr>
<td>DNS</td>
<td>引入kubernetes项目中的addon组件NodeLocal DNSCache来增加cache层</td>
<td><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns">NodeLocal DNS Cache</a> nodelocal dns cache位于kubernetes项目中，以DaemonSet的方式运行在k8s集群中</td>
</tr>
<tr>
<td></td>
<td>ExternalDNS服务</td>
<td>用来将DNS注册到外部的公共域名服务器</td>
</tr>
<tr>
<td></td>
<td>使用DNSTAP Analyser诊断异常</td>
<td>s使用CoreDNS DNSTAP Analyser组件来接收coredns的DNS解析报文格式dnstap协议，并最终可以输出到sls对异常的DNS解析报文进行分析。</td>
</tr>
</tbody></table>
<h1 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h1><p>存储为ACK的一大亮点，借助云的丰富存储类型，通过k8s的CSI插件机制提供了块存储、文件存储、对象存储OSS和本地存储的支持。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/220839/1645347493244-2af51b21-0150-48e4-a15e-0585d5a59852.png#clientId=ub8a97252-9d7b-4&from=paste&height=916&id=ufabccb6c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=916&originWidth=2458&originalType=binary&ratio=1&size=143128&status=done&style=none&taskId=uf542f250-6209-4734-8564-306faaaaca5&width=2458" alt="image.png"></p>
<h2 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h2><ol>
<li>LVM数据卷功能，基于lvm来动态创建pv</li>
<li>QuotaPath，基于ext4的quota特性实现的本地存储的quota隔离功能</li>
<li>内存数据卷</li>
<li>持久化内存技术</li>
</ol>
<h2 id="云盘存储卷"><a href="#云盘存储卷" class="headerlink" title="云盘存储卷"></a>云盘存储卷</h2><ol>
<li>支持云盘的在线扩容，k8s 1.16版本之前可以手工扩容磁盘，但是pvc保持必变。在k8s 1.16之后，在pvc修改后，可以自动完成云盘的扩容。</li>
<li>可根据磁盘的使用水位支持云盘的自动扩容，该功能通过额外的组件storage-operator来实现，策略存放到了额外的CRD StorageAutoScalerPolicy。跟k8s的hpa和vpa功能相比，该功能没有自动缩容的功能。</li>
<li>使用k8s的存储快照功能实现了存储快照。k8s定义了VolumeSnapshotContent（类似pv）、VolumeSnapshot（类似pvc）和VolumeSnapshotClass（类似StorageClass）三个类型来实现打快照功能，快照的恢复则借助pvc的spec.dataSource字段实现。</li>
<li>加密云盘功能，同样借助云上能力实现。使用时，仅需要在StorageClass的parameters参数中指定加密参数即可。</li>
</ol>
<h1 id="Serverless-Kubernetes（ASK）"><a href="#Serverless-Kubernetes（ASK）" class="headerlink" title="Serverless Kubernetes（ASK）"></a>Serverless Kubernetes（ASK）</h1><p>适用场景：</p>
<ol>
<li>业务要求高弹性，如互联网在线服务存在波峰波谷特别明显</li>
</ol>
<p>ACK提供了k8s以及k8s的管理功能，其中k8s的master节点需要单独创建和维护，每个k8s集群使用的资源是完全独立的。在ASK中，用户仅需要创建k8s集群，而不需要关心k8s集群的核心组件具体是怎么创建的。</p>
<p>在实际上，k8s的核心组件如etcd、kube-apiserver、kube-scheduler、kube-controller-manager可能是以pod的形式运行在另外的k8s集群之上，即所谓的k8s on k8s（KOK）的方案。而且这部分组件是多个k8s集群混部的，对用户完全屏蔽了实现细节，用户仅需要聚焦在如何使用k8s即可。</p>
<p>对于k8s的node节点，用户同样不需要创建，可以认为k8s的节点资源是无限多的。ask采用了virtual kubelet的技术创建了一个虚拟的k8s node节点 <code>virtual-kubelet-$&#123;region&#125;-$&#123;zone&#125;</code>，整个k8s集群仅有一个节点。因为只有一个k8s节点，实际上k8s的管控作用会大大弱化，尤其是kube-scheduler，因为只有一个k8s节点，不存在pod调度的问题。</p>
<p>用户创建的pod资源，实际上会部署在阿里云产品弹性容器实例ECI上。新创建ask集群完成后，再到ECI上即可看到有默认的容器创建出来。ECI了创建容器的功能，给用户暴露的功能是跟k8s无关的，而ask相当于是给用户提供了以k8s的方式来创建容器。</p>
<p>ask还集成了knative，用户可以使用knative的Serving和Eventing的功能来实现社区通用的serverless服务。</p>
<p>相关链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/3zxbdvx2LmeAjt74xqhVbw">全新的网关能力增强</a></li>
</ul>
<h1 id="分布式云容器平台ACK-One"><a href="#分布式云容器平台ACK-One" class="headerlink" title="分布式云容器平台ACK One"></a>分布式云容器平台ACK One</h1><p>ack one提供了两个相对独立的功能，一个是第三方k8s集群的注册，另外一个是k8s多集群的管理和应用发布。两个功能的入口也未统一，其中一个是在ack界面，另外一个是在分布式云容器平台ack one。</p>
<p>第三方k8s集群的注册，允许用户将自己的k8s集群注册到ack上，可以从ack上来管理用户的k8s集群，而且可以部署一些ack自己的组件到用户的k8s集群上面。需要在用户的k8s集群部署一个ack-cluster-agent的服务，在用户的k8s集群跟ack可达的情况下，即可完成用户k8s集群的托管。</p>
<p>k8s多集群的管理功能，底层直接使用了kubevela项目，实现了k8s多集群的管理、多集群的应用发布功能。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>集群成本分析</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/huge-page/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/huge-page/" class="post-title-link" itemprop="url">大页内存</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-07 18:20:17" itemprop="dateCreated datePublished" datetime="2022-03-07T18:20:17+00:00">2022-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="大页内存介绍"><a href="#大页内存介绍" class="headerlink" title="大页内存介绍"></a>大页内存介绍</h2><p>一个操作系统上一台机器的物理内存是有限的，而操作系统上却运行着大量的进程，为了对进程屏蔽物理内存的差异，操作系统引入了虚拟内存的概念。Linux系统中虚拟内存是按照页的方式来进行管理的，每个页的默认大小为4K。如果物理内存非常大，就会导致虚拟内存和物理内存映射的页表（TLB）非常大。为了减少页表，一个可行的方法为增加页的大小。<br>​</p>
<p>可以通过如下命令来查看默认页大小：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">getconf</span> <span class="string">PAGE_SIZE</span></span><br><span class="line"><span class="number">4096</span></span><br></pre></td></tr></table></figure>
<p>在对内存要求特别严格的场景下，比如很多数据库的场景，都有巨页的需求，比如将页设置为1GB，甚至几十GB。<br>​</p>
<p>通常在大页内存的场景下，会将Linux的swap功能关闭，避免当页换出时导致的性能下降。<br>​</p>
<p>在Linux中Huge Page有2MB和1GB两种规则，其中2MB适用于GB级别的内存，1GB适用于TB级别的内存。<br>​</p>
<p>大页内存可以分为静态大页和透明大页两类。</p>
<ul>
<li>静态大页需要用户自行控制大页的分配、释放和使用。但该方式需要事先配置大页内存的量，因此用起来不够灵活。配置可以在系统启动的时候配置hugepages（页数量）和hugepagesz（页大小）两个参数。也可以使用修改内核参数的方式来预留。</li>
<li>透明大页由操作系统的后台内核线程khugepaged控制大页的分配、释放和使用。</li>
</ul>
<h2 id="静态大页内存操作"><a href="#静态大页内存操作" class="headerlink" title="静态大页内存操作"></a>静态大页内存操作</h2><p>预留大页内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 20 &gt;  /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</span><br></pre></td></tr></table></figure>
<p>可以通过&#x2F;proc&#x2F;meminfo文件系统看到大页内存的使用情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /proc/meminfo | grep Huge</span></span><br><span class="line">AnonHugePages:   2037760 kB</span><br><span class="line">HugePages_Total:      20 # 预先分配的大页数量</span><br><span class="line">HugePages_Free:       20 # 空闲大页数量</span><br><span class="line">HugePages_Rsvd:        0 </span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>
<p>挂载hugetlb文件系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t hugetlbfs none /mnt/huge</span><br></pre></td></tr></table></figure>
<p>在应用程序中mmap映射hugetlb文件系统即可使用，对内存的操作类似于访问文件。</p>
<h2 id="透明大页内存操作（待补充）"><a href="#透明大页内存操作（待补充）" class="headerlink" title="透明大页内存操作（待补充）"></a>透明大页内存操作（待补充）</h2><p>cat &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</p>
<h2 id="大页内存在k8s的支持情况"><a href="#大页内存在k8s的支持情况" class="headerlink" title="大页内存在k8s的支持情况"></a>大页内存在k8s的支持情况</h2><p>HugePage是k8s 1.9版本中引入的特性，1.10变为beta版本，1.23版本stable版本。k8s大于1.10版本该feature默认开启。</p>
<p>在节点上配置了大页内存后，kubelet会自动感知到大页内存的配置，会修改node配置。会在hugepages-2Mi中有对应的大页内存容量，memory字段会去掉对应的大页内存量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">allocatable:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;15&quot;</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">  <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">  <span class="attr">hugepages-2Mi:</span> <span class="string">40Mi</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">63998924Ki</span></span><br><span class="line">  <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line"><span class="attr">capacity:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;16&quot;</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">  <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">  <span class="attr">hugepages-2Mi:</span> <span class="string">40Mi</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">64756684Ki</span></span><br><span class="line">  <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br></pre></td></tr></table></figure>
<p>pod在使用大页内存的时候，需要以volume的方式挂载到pod中，pod对大页内存的使用跟普通文件系统相同。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/nandubeigui/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/nandubeigui/" class="post-title-link" itemprop="url">《南渡北归》读后感</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-01 00:48:29" itemprop="dateCreated datePublished" datetime="2022-03-01T00:48:29+00:00">2022-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自己断断续续花了几个月的时间，终于将《南渡北归》读完了。当我知道这本书的时候，迅速被这本书的内容给吸引住了。早高峰上班的地铁上基本全部花在了该书上，晚上躺在床上后临睡前也在刷该书，困的睁不开眼的时候再倒头就睡。</p>
<p>中学的历史课本上，在讲解中国近现代史的时候实际上带有了比较浓厚的党的特色，过分的强调了自我，而对于当时的国民政府的描述相对较少。受限于篇幅的限制，历史课本对于历史人物提的也比较少一些。知识分子在中国历史上乘井喷状爆发的有两个阶段春秋时期和民国时期，本书以民国时期我们耳熟能详的知识分子们为主角，比如胡适、陈寅恪、梅贻琦、闻一多，讲解了大师们在乱世中颠沛流离的经历，以及错综复杂的人物关系。</p>
<p>《南渡北归》实际分为了《南渡》、《北归》和《离别》三部曲，全书100多万字，四大名著字数最多的《水浒传》也不过才96万字，本书可以算得上一步巨著了。之所以有那么多字数，其中有一部分篇幅是大师们的一些书信资料，真正属于作者的有效字数应该跟《水浒传》不相上下。</p>
<p>《南渡》主要讲解了卢沟桥事变抗日战争爆发后，北平各学府的师生们纷纷南下，先是辗转到长沙成立了长沙临时联合大学。但不久长沙沦陷，又分几路辗转到云南昆明组建西南联合大学，像李政道、杨振宁在这里完成了部分学业。但在昆明好景不长，时常有敌机轰炸，师生们天天”跑警报“。后一部分又逃亡了四川宜宾长江边上的李庄镇，很多大师们在李庄镇度过了非常难忘的一段回忆。比如林徽因、梁思永，很多时候都是在病床上度过，又受限于当地的环境，无药可医。</p>
<p>《北归》发生在了抗日战争结束，国民政府开始组织知识分子纷纷回到北平的旧时学府，回到一别多年的故乡。可是好景不长，国共内战爆发，北平沦陷。紧接着一大批的知识分子们又开始了新一轮的逃亡，很大一部分逃亡了台湾岛，另外一部分留在了大陆。这一不同的选择，直接决定了不同的人生命运。</p>
<p>《离别》是读起来最为伤感的一部，大师们纷纷陨落。逃亡台湾的如傅斯年、胡适、梅贻琦等虽然过得并不富裕，谈不上悲惨，但也算在台湾开辟了一番事业，名扬千古。但逃亡台湾的知识分子，在大陆却成了千古罪人。如大陆掀起了一股非常大的反胡热潮，以至于连胡适的儿子胡思杜都登报公开批判远在海峡对岸的父亲。可惜的是，思想觉悟足够高的儿子仍然在被批斗至自杀身亡。留在大陆的知识分子的命运却大相径庭，政治觉悟高者如郭沫若风生水起。但大部分的知识分子在”三反“、”文革“运动中都遭到了残酷的迫害，被红卫兵逼迫自杀者也不在少数。当年的红卫兵如今也就其八十岁的样子，我特别想采访一番当时他们是在什么情况下怀着怎样的心情什么动力来做出如此伤天害理之事，而且自己还理直气壮。</p>
<p>寒门难出贵子。民国时期但凡叫上名字的大师们大都出生在名门望族，而且往往一家不止出一位大师级人物，甚至有很多家族是世交。随便举几个例子，如周树人、周作人兄弟，虽然后来两兄弟完全走上了不同的人生道路。曾国藩的后人至少五代以内都有各种英才，如在民国时期活跃的曾宝荪、曾约农、曾昭燏、曾昭抡等。梁启超的两个儿子梁思成和梁思永兄弟，分别在建筑学和考古学方向有非常高的建树。不过也正是因为出生在名门望族，因为家庭出身的问题，也往往在后来的迫害中是最惨烈的。 </p>
<p>傅斯年在书中简直被作者推崇之至，甚至可以说是崇拜。关于傅斯年，作者描绘最多的字眼是胖子、高血压蹭蹭往上窜、活跃于政学两界、学术大鳄、气场强大、胡适的打手、思维清晰、擅长处理棘手问题。傅斯年毕业于大学，曾经领导过五四运动，出国留学后曾经担任了多年的史语所所长一职，也曾代理过北京大学校长一职。国共内战爆发后，随史语所一起逃亡台湾，在台湾期间，担任台湾大学校长，1950年突发脑淤血去世，后葬于台湾大学的”傅园“内为后世铭记。</p>
<p>另外一个对外印象比较深刻的人物是陈寅恪。清末著名诗人陈三立之子，同梁启超、王国维、赵元任并称为”清华国学四大导师“。国共内战北平失手后，陈寅恪从北京辗转逃亡岭南大学，后岭南大学跟中山大学合并，任教于中山大学。书中罗列了陈寅恪的多首诗，诗文引经据典，读起来相当晦涩，没点文化底蕴根本无法领会其中奥妙，可见大师功底之深。晚年在双目失明的情况下，完成了80多万字的巨著《柳如是别传》，非常人能所及。</p>
<p>本书描述的这段历史，实际上也就发生了一百年的时间，但却有非常多的历史是无法考证的。读史书其实想了解一个真实的历史，但本书的作者却带有了比较浓厚的个人感情色彩，比如对傅斯年推崇之至，对闻一多的评价却非常差。另外，作者有一丝错误的政治倾向，此书能够在大陆出版也算是一个奇迹了。读此书本着了解历史真相的态度，但却不可全信。</p>
<p>民国时期的知识分子大都有记录日志的好习惯，日记确实是一种非常好的自我反省和自我成长的好方式，可惜这么好的成长方式在现代的社会中却在逐渐消失，更多的会出现在小学生的课后作业中。另一方面，日记作为了非常好的一种史学参考资料，日记不会说谎，是作者的最真实的内心流露。过去发生的事情可以被人遗忘，但文字永存。由于没有长途电话这么高科技的产品，朋友之间的往来很多都是以书信的形式，如林徽因跟美国好友费慰梅就有大量的书信往来，这些书信也成为了非常好的史学资料。书信在当代早已成为了过去时，取而代之的是更为便捷的聊天app，无论身处何地对方永远在线，想聊天几乎没有了任何代价。</p>
<p>如果你有时间，此书值得一读。另外，再推荐一个关于昆明西南联合大学的纪录片《九零后》，针对超过16位超过90岁高龄的专家学者的口述，有助于了解当时那段历史。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/karmada/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/karmada/" class="post-title-link" itemprop="url">k8s多集群管理方案 - karmada</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 20:16:25" itemprop="dateCreated datePublished" datetime="2022-02-22T20:16:25+00:00">2022-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>华为云开源的多云容器编排项目，目前为CNCF沙箱项目。Karmada是基于<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/kubernetes-sigs/kubefed">kubefed v2</a>进行修改的一个项目，因此里面很多概念都是取自kubefed v2。</p>
<p>Karmada相对于kubefed v2的最大优点：<strong>完全兼容k8s的API</strong>。karmada提供了一个一套独立的karmada-apiserver，跟kube-apiserver是兼容的，使用方在调用的时候只需要访问karmada-apiserver就可以了。</p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karmada-arch.png"><br>有三个组件构建：</p>
<ul>
<li>karmada api server，用来给其他的组件提供rest api</li>
<li>karmada controller manager</li>
<li>karmada scheduler</li>
</ul>
<p>karmada会新建一个ETCD，用来存储karmada的API对象。</p>
<p>karmada controller manager内部包含了多个controller的功能，会通过karmada apiserver来watch karmada对象，并通过调用各个子集群的apiserver来创建标准的k8s对象，包含了如下的controller对象：</p>
<ol>
<li>Cluster Controller：用来管理子集群的声明周期</li>
<li>Policy Controller：监听PropagationPolicy对象，通过resourceSelector找到匹配中的资源，并创建ResourceBinding对象。</li>
<li>Binding Controller：监听ResourceBinding对象，并创建每个集群的Work对象。</li>
<li>Execution Controller：监听Work对象，一旦Work对象场景后，会在子集群中创建Work关联的k8s对象。</li>
</ol>
<h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><h2 id="karmada-aggregated-apiserver"><a href="#karmada-aggregated-apiserver" class="headerlink" title="karmada-aggregated-apiserver"></a>karmada-aggregated-apiserver</h2><p>在karmada-apiserver上注册的api信息</p>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><p>用来存放karmada的元数据信息</p>
<h1 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h1><h2 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h2><p>需要使用kamada-apiserver来查询</p>
<details>
<summary>unfold me to see the yaml</summary>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cluster.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">karmada.io/cluster-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">member1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">apiEndpoint:</span> <span class="string">https://172.18.0.3:6443</span></span><br><span class="line">  <span class="attr">impersonatorSecretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">member1-impersonator</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-cluster</span></span><br><span class="line">  <span class="attr">secretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">member1</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-cluster</span></span><br><span class="line">  <span class="attr">syncMode:</span> <span class="string">Push</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">	<span class="comment"># 支持的api列表</span></span><br><span class="line">  <span class="attr">apiEnablements:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mutatingwebhookconfigurations</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">validatingwebhookconfigurations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">customresourcedefinitions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">apiservices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ControllerRevision</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">controllerrevisions</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">daemonsets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">deployments</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">authentication.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">TokenReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">tokenreviews</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">LocalSubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">localsubjectaccessreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SelfSubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">selfsubjectaccessreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SelfSubjectRulesReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">selfsubjectrulesreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">subjectaccessreviews</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">batch/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cronjobs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">jobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">certificates.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">certificatesigningrequests</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">coordination.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Lease</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">leases</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">discovery.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpointslices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">discovery.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpointslices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">events.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">events.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">FlowSchema</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">flowschemas</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">prioritylevelconfigurations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingressclasses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">runtimeclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">node.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">runtimeclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">policy/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">podsecuritypolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">clusterrolebindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">clusterroles</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rolebindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">roles</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">priorityclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSIDriver</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csidrivers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSINode</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csinodes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">storageclasses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">VolumeAttachment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volumeattachments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">storage.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSIStorageCapacity</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csistoragecapacities</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Binding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">bindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ComponentStatus</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">componentstatuses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">limitranges</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nodes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">persistentvolumes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodTemplate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">podtemplates</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">replicationcontrollers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">resourcequotas</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">serviceaccounts</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-02-21T08:27:56Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">cluster</span> <span class="string">is</span> <span class="string">healthy</span> <span class="string">and</span> <span class="string">ready</span> <span class="string">to</span> <span class="string">accept</span> <span class="string">workloads</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ClusterReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">kubernetesVersion:</span> <span class="string">v1.22.0</span></span><br><span class="line">  <span class="attr">nodeSummary:</span></span><br><span class="line">    <span class="attr">readyNum:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">totalNum:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">resourceSummary:</span></span><br><span class="line">    <span class="attr">allocatable:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">      <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">      <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">      <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">32192720Ki</span></span><br><span class="line">      <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">    <span class="attr">allocated:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">950m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">290Mi</span></span><br><span class="line">      <span class="attr">pods:</span> <span class="string">&quot;9&quot;</span></span><br></pre></td></tr></table></figure>
</details>

<h2 id="PropagationPolicy"><a href="#PropagationPolicy" class="headerlink" title="PropagationPolicy"></a>PropagationPolicy</h2><p>应用发布策略</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: policy.karmada.io/v1alpha1</span><br><span class="line">kind: PropagationPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-propagation</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  placement:</span><br><span class="line">    clusterAffinity:</span><br><span class="line">      clusterNames:</span><br><span class="line">      - member1</span><br><span class="line">      - member2</span><br><span class="line">    replicaScheduling:</span><br><span class="line">      replicaDivisionPreference: Weighted·</span><br><span class="line">      replicaSchedulingType: Divided</span><br><span class="line">      weightPreference:</span><br><span class="line">        staticWeightList:</span><br><span class="line">        - targetCluster:</span><br><span class="line">            clusterNames:</span><br><span class="line">            - member1</span><br><span class="line">          weight: <span class="number">1</span></span><br><span class="line">        - targetCluster:</span><br><span class="line">            clusterNames:</span><br><span class="line">            - member2</span><br><span class="line">          weight: <span class="number">1</span></span><br><span class="line">  resourceSelectors:</span><br><span class="line">  - apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx</span><br><span class="line">    namespace: default</span><br></pre></td></tr></table></figure>
<h2 id="ClusterPropagationPolicy"><a href="#ClusterPropagationPolicy" class="headerlink" title="ClusterPropagationPolicy"></a>ClusterPropagationPolicy</h2><p>用来定义Cluster级别资源的发布策略</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterPropagationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">serviceexport-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resourceSelectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">serviceexports.multicluster.x-k8s.io</span></span><br><span class="line">  <span class="attr">placement:</span></span><br><span class="line">    <span class="attr">clusterAffinity:</span></span><br><span class="line">      <span class="attr">clusterNames:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">member2</span></span><br></pre></td></tr></table></figure>
<h2 id="OverridePolicy"><a href="#OverridePolicy" class="headerlink" title="OverridePolicy"></a>OverridePolicy</h2><p>用于修改不同集群内的对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OverridePolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">overriders:</span></span><br><span class="line">    <span class="attr">commandOverrider:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerName:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">remove</span></span><br><span class="line">        <span class="attr">value:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--parameter1=foo</span></span><br></pre></td></tr></table></figure>

<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>karmada提供了三种安装方式：</p>
<ul>
<li>kubectl karmada插件的方式安装，较新的特性，v1.0版本才会提供，当前最新版本为v0.10.1</li>
<li>helm chart方式安装</li>
<li>使用源码安装</li>
</ul>
<h2 id="安装kubectl插件"><a href="#安装kubectl插件" class="headerlink" title="安装kubectl插件"></a>安装kubectl插件</h2><p>karmada提供了一个cli的工具，可以是单独的二进制工具kubectl-karmada，也可以是kubectl的插件karmada，本文以kubectl插件的方式进行安装。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl krew install karmada</span><br></pre></td></tr></table></figure>
<p>接下来就可以执行 kubectl karmada命令了。</p>
<h2 id="helm-chart的方式安装"><a href="#helm-chart的方式安装" class="headerlink" title="helm chart的方式安装"></a>helm chart的方式安装</h2><p>使用kind插件一个k8s集群 host，此处步骤略<br>​</p>
<p>在源码目录下执行如下的命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install karmada <span class="literal">-n</span> karmada<span class="literal">-system</span> <span class="literal">--create-namespace</span> ./charts</span><br></pre></td></tr></table></figure>
<p>会在karmada-system下部署如下管控的组件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl get deployments <span class="literal">-n</span> karmada<span class="literal">-system</span></span><br><span class="line">NAME                              READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">karmada<span class="literal">-apiserver</span>                 <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-controller-manager</span>        <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-kube-controller-manager</span>   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-scheduler</span>                 <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-webhook</span>                   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> kubectl get statefulsets <span class="literal">-n</span> karmada<span class="literal">-system</span></span><br><span class="line">NAME   READY   AGE</span><br><span class="line">etcd   <span class="number">1</span>/<span class="number">1</span>     <span class="number">2</span>m1s</span><br></pre></td></tr></table></figure>

<h2 id="从源码安装一个本地测试集群"><a href="#从源码安装一个本地测试集群" class="headerlink" title="从源码安装一个本地测试集群"></a>从源码安装一个本地测试集群</h2><p>本方式仅用于本地测试，会自动使用kind拉起测试的k8s集群，包括了一个host集群和3个member集群。</p>
<p>执行如下命令，会执行如下的任务：</p>
<ol>
<li>使用kind启动一个新的k8s集群host</li>
<li>构建karmada的控制平面，并部署控制平面到host集群</li>
<li>创建3个member集群并加入到karmada中<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/karmada<span class="literal">-io</span>/karmada</span><br><span class="line"><span class="built_in">cd</span> karmada</span><br><span class="line">hack/local<span class="literal">-up-karmada</span>.sh</span><br></pre></td></tr></table></figure>
local-up-karmada.sh有两个细节问题值得关注。<br>kind创建出来的集群名一定带有“kind-”的前缀，该脚本中为了去掉“kind-”前缀，使用了kubectl config rename-context 命令来rename context。<a target="_blank" rel="noopener" href="https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L375">https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L375</a><br>另外，使用kind创建出来的集群，context中的apiserver地址为类似<a target="_blank" rel="noopener" href="https://127.0.0.1:45195/">https://127.0.0.1:45195</a>这样的本地随机端口，只能在宿主机网络中访问。如果要想在两个k8s集群之间访问是不可行的。脚本中使用kubectl config set-cluster 命令将集群apiserver的地址替换为了docker网段的ip地址，以便于多个k8s集群之间的互访。<a target="_blank" rel="noopener" href="https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L389">https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L389</a><br>​</li>
</ol>
<p>可以看到创建了如下的4个k8s cluster</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kind get clusters</span><br><span class="line">karmada<span class="literal">-host</span></span><br><span class="line">member1</span><br><span class="line">member2</span><br><span class="line">member3</span><br></pre></td></tr></table></figure>

<p>但这四个集群会分为两个kubeconfig文件 ~&#x2F;.kube&#x2F;karmada.config 和 ~&#x2F;.kube&#x2F;members.config。karmada又分为了两个context karmada-apiserver和karmada-host，两者连接同一个k8s集群。karmada-apiserver为跟karmada控制平台交互使用的context，为容器中的karmada-apiserver。karmada-host连接容器的kube-apiserver。<br>​</p>
<p>如果要连接host集群设置环境变量：export KUBECONFIG&#x3D;”$HOME&#x2F;.kube&#x2F;karmada.config”<br>如果要连接member集群设置环境变量：export KUBECONFIG&#x3D;”$HOME&#x2F;.kube&#x2F;members.config”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">export</span> <span class="string">KUBECONFIG=&quot;$HOME/.kube/karmada.config&quot;</span></span><br><span class="line"><span class="comment"># 切换到karmada-host</span></span><br><span class="line"><span class="string">$</span> <span class="string">kctx</span> <span class="string">karmada-host</span></span><br><span class="line"><span class="comment"># 可以看到karmada部署的组件</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-n</span> <span class="string">karmada-system</span>   </span><br><span class="line"><span class="string">NAME</span>                                  <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">karmada-aggregated-apiserver</span>          <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-apiserver</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">18m</span></span><br><span class="line"><span class="string">karmada-controller-manager</span>            <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-kube-controller-manager</span>       <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler</span>                     <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member1</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member2</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member3</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-webhook</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br></pre></td></tr></table></figure>
<p>在host集群中可以看到会创建出如下的pod</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k get pod -n karmada-system </span></span><br><span class="line">NAME                                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">etcd<span class="literal">-0</span>                                                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-aggregated-apiserver-7b88b8df99-95twq</span>          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-apiserver-5746cf97bb-pspfg</span>                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-controller-manager-7d66968445-h4xsc</span>            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-kube-controller-manager-869d9df85-f4bqj</span>        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-8677cdf96d-psnlw</span>                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member1-696b54fd56-jjg6b</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member2-774fb84c5d-fldhd</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member3-5c7d87f4b4-fk4lj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-webhook-79b87f7c5f-lt8ps</span>                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver集群会创建出如下的Cluster，同时可以看到有两个Push模式一个Pull模式的集群。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kctx</span> <span class="string">karmada-apiserver</span></span><br><span class="line"><span class="string">Switched</span> <span class="string">to</span> <span class="string">context</span> <span class="string">&quot;karmada-apiserver&quot;</span><span class="string">.</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">clusters</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">VERSION</span>   <span class="string">MODE</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">member1</span>   <span class="string">v1.22.0</span>   <span class="string">Push</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br><span class="line"><span class="string">member2</span>   <span class="string">v1.22.0</span>   <span class="string">Push</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br><span class="line"><span class="string">member3</span>   <span class="string">v1.22.0</span>   <span class="string">Pull</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br></pre></td></tr></table></figure>
<h1 id="应用发布"><a href="#应用发布" class="headerlink" title="应用发布"></a>应用发布</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karama-concepts.png"></p>
<p>将context切换到karmada-host，在host集群部署应用nginx</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> export KUBECONFIG=<span class="string">&quot;<span class="variable">$HOME</span>/.kube/karmada.config&quot;</span></span><br><span class="line"><span class="variable">$</span> kctx karmada<span class="literal">-apiserver</span></span><br><span class="line"><span class="variable">$</span> kubectl create <span class="operator">-f</span> samples/nginx/propagationpolicy.yaml</span><br><span class="line"><span class="variable">$</span> <span class="built_in">cat</span> samples/nginx/propagationpolicy.yaml</span><br><span class="line">apiVersion: policy.karmada.io/v1alpha1</span><br><span class="line">kind: PropagationPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-propagation</span></span><br><span class="line">spec:</span><br><span class="line">  resourceSelectors:</span><br><span class="line">    - apiVersion: apps/v1</span><br><span class="line">      kind: Deployment</span><br><span class="line">      name: nginx</span><br><span class="line">  placement:</span><br><span class="line">    <span class="comment"># 要提交到子集群1和2</span></span><br><span class="line">    clusterAffinity:</span><br><span class="line">      clusterNames:</span><br><span class="line">        - member1</span><br><span class="line">        - member2</span><br><span class="line">    replicaScheduling:</span><br><span class="line">      replicaDivisionPreference: Weighted</span><br><span class="line">      replicaSchedulingType: Divided</span><br><span class="line">      weightPreference:</span><br><span class="line">        staticWeightList:</span><br><span class="line">          - targetCluster:</span><br><span class="line">              clusterNames:</span><br><span class="line">                - member1</span><br><span class="line">            weight: <span class="number">1</span></span><br><span class="line">          - targetCluster:</span><br><span class="line">              clusterNames:</span><br><span class="line">                - member2</span><br><span class="line">            weight: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver中提交deployment。deployment提交后实际上仅为一个模板，只有PropagationPolicy跟deployment关联后，才会真正部署。deployment中指定的副本数为所有子集群的副本数综合。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">samples/nginx/deployment.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deploy</span> </span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">7m37s</span></span><br><span class="line"><span class="comment"># 可以看到虽然deployment的副本数为2，但在karmada-apiserver集群中实际上并没有pod创建出来</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="literal">No</span> <span class="string">resources</span> <span class="string">found</span> <span class="string">in</span> <span class="string">default</span> <span class="string">namespace.</span></span><br></pre></td></tr></table></figure>
<p>通过karmadactl命令可以查询环境中的所有子集群的pod状态</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">karmadactl</span> <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="string">The</span> <span class="string">karmadactl</span> <span class="string">get</span> <span class="string">command</span> <span class="string">now</span> <span class="string">only</span> <span class="string">supports</span> <span class="string">Push</span> <span class="string">mode,</span> [ <span class="string">member3</span> ] <span class="string">are</span> <span class="string">not</span> <span class="string">push</span> <span class="string">mode</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">CLUSTER</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx-6799fc88d8-4w2gc</span>   <span class="string">member1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m16s</span></span><br><span class="line"><span class="string">nginx-6799fc88d8-j77f5</span>   <span class="string">member2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m16s</span></span><br></pre></td></tr></table></figure>
<h1 id="元集群访问子集群"><a href="#元集群访问子集群" class="headerlink" title="元集群访问子集群"></a>元集群访问子集群</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karmada-aa.png"></p>
<p>可以看到在karmada-apiserver上注册了AA服务，group为cluster.karmada.io</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl --kubeconfig /root/.kube/karmada.config --context karmada-apiserver get  apiservice v1alpha1.cluster.karmada.io -o yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">apiserver:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">karmada-aggregated-apiserver</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1alpha1.cluster.karmada.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">cluster.karmada.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">2000</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">karmada-aggregated-apiserver</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-system</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-02-21T08:27:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">all</span> <span class="string">checks</span> <span class="string">passed</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Passed</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br></pre></td></tr></table></figure>
<p>如果直接使用kubectl访问karmada-apiserver服务，会提示存在权限问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">￥</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/karmada-apiserver.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>   <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="string">users</span> <span class="string">&quot;system:admin&quot;</span> <span class="attr">is forbidden:</span> <span class="string">User</span> <span class="string">&quot;system:serviceaccount:karmada-cluster:karmada-impersonator&quot;</span> <span class="string">cannot</span> <span class="string">impersonate</span> <span class="string">resource</span> <span class="string">&quot;users&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">at</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">scope</span></span><br></pre></td></tr></table></figure>
<p>给karmada-apiserver的Account system:admin授权，创建文件cluster-proxy-rbac.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;cluster.karmada.io&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusters/proxy</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member3</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:admin&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行如下命令即可给karmada-apiserver的Account system:admin 授权可访问AA服务的member1-3</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cluster-proxy-rbac.yaml</span>   </span><br></pre></td></tr></table></figure>
<p>通过url的形式访问AA服务，返回数据格式为json</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/karmada-apiserver.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br></pre></td></tr></table></figure>
<p>如果要想使用 kubectl get node 的形式来访问，则需要在kubeconfig文件中server字段的url地址后追加url <code>/apis/cluster.karmada.io/v1alpha1/clusters/&#123;clustername&#125;/proxy</code> </p>
<h2 id="给特定的账号授权"><a href="#给特定的账号授权" class="headerlink" title="给特定的账号授权"></a>给特定的账号授权</h2><p>在karmada-apiserver中创建账号 tom</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">create</span> <span class="string">serviceaccount</span> <span class="string">tom</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver中提交如下的yaml文件，用来给tom账号增加访问member1集群的权限</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;cluster.karmada.io&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusters/proxy</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="comment"># The token generated by the serviceaccount can parse the group information. Therefore, you need to specify the group information below.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:serviceaccounts&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:serviceaccounts:default&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行如下命令提交</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cluster-proxy-rbac.yaml</span></span><br></pre></td></tr></table></figure>
<p>获取karmada-apiserver集群的tom账号的token信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>  <span class="string">get</span> <span class="string">secret</span> <span class="string">`kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>  <span class="string">get</span> <span class="string">sa</span> <span class="string">tom</span> <span class="string">-oyaml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">token</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span><span class="string">`</span> <span class="string">-oyaml</span> <span class="string">|</span> <span class="attr">grep token:</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> <span class="string">|</span> <span class="string">base64</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure>
<p> 创建~&#x2F;.kube&#x2F;tom.config文件，其中token信息为上一步获取的token，server的地址可以查看 ~&#x2F;.kube&#x2F;karmada-apiserver.config文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">insecure-skip-tls-verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">server:</span> &#123;<span class="string">karmada-apiserver-address</span>&#125; <span class="comment"># Replace &#123;karmada-apiserver-address&#125; with karmada-apiserver-address. You can find it in /root/.kube/karmada.config file.</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">tom</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span> &#123;<span class="string">token</span>&#125; <span class="comment"># Replace &#123;token&#125; with the token obtain above.</span></span><br></pre></td></tr></table></figure>
<p>通过karmada-apiserver的tom用户访问member1集群</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预期可以正常访问</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/apis</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期不可以访问，因为tom在member1集群没有权限</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="attr">nodes is forbidden:</span> <span class="string">User</span> <span class="string">&quot;system:serviceaccount:default:tom&quot;</span> <span class="string">cannot</span> <span class="string">list</span> <span class="string">resource</span> <span class="string">&quot;nodes&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">at</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">scope</span></span><br></pre></td></tr></table></figure>
<p>在member1集群将tom账号绑定权限，创建member1-rbac.yaml文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<p>权限在member1集群生效</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/members.config</span> <span class="string">--context</span> <span class="string">member1</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">member1-rbac.yaml</span> </span><br></pre></td></tr></table></figure>
<p>重新执行命令即可以访问子集群中的数据</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br></pre></td></tr></table></figure>
<h1 id="集群注册"><a href="#集群注册" class="headerlink" title="集群注册"></a>集群注册</h1><p>支持Push和Pull两种模式。<br>​</p>
<p>push模式karmada会直接访问成员集群的kuba-apiserver。</p>
<p>pull模式针对的场景是中心集群无法直接子集群的场景。每个子集群运行karmada-agent组件，一旦karmada-agent部署完成后就会自动向host集群注册，karmada-agent会watch host集群的karmada-es-<cluster name>下的cr，并在本集群部署。<br>​</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/github-kubernetes-sigs-projects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/github-kubernetes-sigs-projects/" class="post-title-link" itemprop="url">Github Kubernetes SIGs组织下的项目（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-14 23:21:37" itemprop="dateCreated datePublished" datetime="2022-02-14T23:21:37+00:00">2022-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="apiserver-builder-alpha"><a href="#apiserver-builder-alpha" class="headerlink" title="apiserver-builder-alpha"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/apiserver-builder-alpha">apiserver-builder-alpha</a></h1><p>k8s提供了aggregated apiserver的方式来扩容api，该项目提供了代码生成器、基础library来供开发AA使用。</p>
<p>该项目的定位跟kubebuilder比较类似，kubebuilder用来生成CRD的框架，该项目用来生成AA的框架。</p>
<p>相关资料：</p>
<ul>
<li>[Set up an Extension API Server](Set up an Extension API Server)</li>
</ul>
<h1 id="cluster-api-provider-nested"><a href="#cluster-api-provider-nested" class="headerlink" title="cluster-api-provider-nested"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster?spm=a2c4g.11186623.0.0.23054a15YVTwkg">cluster-api-provider-nested</a></h1><p>在同一个k8s集群内提供多租户的特性，每个租户具有独立的api-server、controller-manager和scheduler。</p>
<h1 id="cluster-proportional-autoscaler"><a href="#cluster-proportional-autoscaler" class="headerlink" title="cluster-proportional-autoscaler"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-proportional-autoscaler">cluster-proportional-autoscaler</a></h1><p>k8s默认提供了hpa机制，可以根据pod的负载情况来对workload进行自动的扩缩容。同时以单独的autoscaler项目提供了vpa功能的支持。</p>
<p>该项目提供提供了类似pod水平扩容的机制，跟hpa不同的是，pod的数量由集群中的节点规模来自动扩缩容pod。特别适合负载跟集群规模的变化成正比的服务，比如coredns、nginx ingress等服务。</p>
<p>hpa功能k8s提供了CRD来作为hpa的配置，本项目没有单独的CRD来定义配置，而是通过在启动的时候指定参数，或者配置放到ConfigMap的方式。而且一个cluster-proportional-autoscaler实例仅能针对一个workload。</p>
<h1 id="kube-batch"><a href="#kube-batch" class="headerlink" title="kube-batch"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kube-batch">kube-batch</a></h1><p>k8s的调度器扩展，实现了Gang Scheduling特性（一组pod必须同时被调度成功，或者处于pending状态），适用于批处理系统。</p>
<p>由于该组件是以单独调度器的形式存在，会跟k8s默认的kube-scheduler并存，因为两个调度器之间并不能相互感知，在两个调度器并存的情况下会存在一定的冲突。</p>
<h1 id="prometheus-adapter"><a href="#prometheus-adapter" class="headerlink" title="prometheus-adapter"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/prometheus-adapter">prometheus-adapter</a></h1><p>k8s要实现hpa（水平自动扩容）的功能，需要监控指标。k8s的监控指标分为核心指标和自定义指标两大类。其中核心指标由metrics-server组件从kubelet、cadvisor等组件来获取，并通过aggregated apiserver的形式暴露给k8s，aggregated api的group信息为metrics.k8s.io。</p>
<p>自定义监控指标则由group custom.metrics.k8s.io对通过aggregated api暴露。本项目即为自定义监控指标的aggregated apiserver的实现。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics">Horizontal Pod Autoscaling</a></p>
<h1 id="scheduler-plugins"><a href="#scheduler-plugins" class="headerlink" title="scheduler-plugins"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/scheduler-plugins">scheduler-plugins</a></h1><p>k8s从1.16版本开始提供了新的调度框架Kubernetes Schduling Framework机制，用户可以基于此项目来开发自己的插件。该项目可以直接构建出kube-scheduler的新镜像。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766273">进击的Kubernetes调度系统（一）：Scheduling Framework</a></p>
<h1 id="sig-storage-local-static-provisioner"><a href="#sig-storage-local-static-provisioner" class="headerlink" title="sig-storage-local-static-provisioner"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">sig-storage-local-static-provisioner</a></h1><p>k8s提供了local pv功能可以用来给pod挂载本地的数据盘，具体的local pv的定义如下所示，pv中包含了要亲和的节点信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: example-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 100Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: /mnt/disks/ssd1</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - example-node</span><br></pre></td></tr></table></figure>

<p>但要使用local pv功能，必须要事先创建出pv才可以，k8s本身并没有提供动态创建pv的功能。</p>
<p>该工具可以根据配置的规则，自动将机器上符合条件的磁盘创建出local pv以供后续创建出的pod使用。</p>
<p>另外，Rancher提供了一个类似的项目，<a target="_blank" rel="noopener" href="https://github.com/rancher/local-path-provisioner">local-path-provisioner</a>，该项目已经被拉起k8s开发环境的开源项目kind使用。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/178475.html">LocalVolume数据卷</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubernetes-opensource-project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubernetes-opensource-project/" class="post-title-link" itemprop="url">Github Kubernetes组织下开源项目（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-09 20:12:00" itemprop="dateCreated datePublished" datetime="2022-02-09T20:12:00+00:00">2022-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-29 12:29:46" itemprop="dateModified" datetime="2023-11-29T12:29:46+00:00">2023-11-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在k8s官方的Github kubernetes group下除了k8s的核心组件外，还有很多开源项目，本文用来简要分析这些开源项目的用途。</p>
<h1 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/apimachinery">apimachinery</a></h1><p>关于k8s的scheme等的sdk项目，代码跟kubernetes项目的如下路径保持同步：<br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery</a></p>
<h1 id="autoscaler"><a href="#autoscaler" class="headerlink" title="autoscaler"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler">autoscaler</a></h1><p>跟k8s的弹性扩缩容相关的组件，有如下两个功能：</p>
<h2 id="vpa（pod垂直扩缩容）"><a href="#vpa（pod垂直扩缩容）" class="headerlink" title="vpa（pod垂直扩缩容）"></a>vpa（pod垂直扩缩容）</h2><p>k8s的kube-controller-manager默认支持了hpa功能，即水平扩缩容。同时k8s还提供了vpa功能，即垂直扩缩容，会根据pod历史的资源占用，修改pod的request值，并不会修改pod的limit值。之所以k8s没有默认提供vpa功能，原因是因为vpa实现要复杂很多，需要通过webhook的技术来在pod创建的时候修改pod的request值。vpa的功能通常用于大型单体应用。</p>
<p>autoscaler的功能之一即提供了vpa的实现。</p>
<h2 id="Cluster-Autoscaler（node节点自动扩缩容）"><a href="#Cluster-Autoscaler（node节点自动扩缩容）" class="headerlink" title="Cluster Autoscaler（node节点自动扩缩容）"></a>Cluster Autoscaler（node节点自动扩缩容）</h2><p>该功能是为了重新利用k8s node的节点资源，在节点资源不足的时候可以动态创建资源，在节点资源空闲的时候可以自动回收资源。k8s node的创建和释放需要公有云平台的支持，该功能对接了多个公有云厂商的api。</p>
<h1 id="cloud-provider"><a href="#cloud-provider" class="headerlink" title="cloud-provider"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/cloud-provider">cloud-provider</a></h1><p>k8s的cloud provider功能用来跟云厂商对接以实现对k8s的node、LoadBalancer Service管理，比如LoadBalancer Service申请vip需要跟云厂商的LB API进行对接。</p>
<p>在k8s 1.6版本之前，cloud provider的代码完全是耦合在k8s的kube-apiserver、kubelet、kube-contorller-manager的代码中的，如果要支持更多的云厂商，只能修改k8s的代码，扩展性比较差。</p>
<p>从k8s 1.6版本之后，cloud provider作为单独的二进制组件来提供服务，并提供了接口定义。本项目为非二进制项目，仅包含k8s的cloud-provider机制的接口定义，为了让第三方的cloud-provider的实现项目引用接口定义方便，将kubernetes项目中的定义为单独的项目，且代码跟<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/cloud-provider">kubernetes项目</a>中的保持同步。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/a_540yJ1EGVroJ9TpvYtPw">从 K8S 的 Cloud Provider 到 CCM 的演进之路</a></li>
</ul>
<h1 id="Descheduler"><a href="#Descheduler" class="headerlink" title="Descheduler"></a>Descheduler</h1><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/descheduler">https://github.com/kubernetes-sigs/descheduler</a></p>
<p>k8s的pod调度完全动态的，kube-scheduler组件在调度pod的时候会根据当时k8s集群的运行时环境来决定pod可以调度的节点，可以保证pod的调度在当时是最优的。但是随着的推移，比如环境中增加了新的node、创建了一批亲和节点的pod，都有可能会导致如果相同的pod再重新调度会到其他的节点上。但k8s的设计是，一旦pod调度完成后，就不会再重新调度。</p>
<p>Descheduler组件用来解决pod的重新调度问题，可以根据配置的一系列的规则来触发驱逐pod，让pod可以重新调度，从而使k8s集群内的pod尽可能达到最优状态，有点类似于计算机在运行了一段时间后的磁盘脆片整理功能。Descheduler组件可以以job、cronjob或者deployment的方式运行在k8s集群中。</p>
<h1 id="kubernetes-template-project"><a href="#kubernetes-template-project" class="headerlink" title="kubernetes-template-project"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes-template-project">kubernetes-template-project</a></h1><p>用来存放了k8s项目的标准模板，里面包含了一些必要的文件，新建的项目可以fork该项目。</p>
<h1 id="node-problem-detector-npd"><a href="#node-problem-detector-npd" class="headerlink" title="node-problem-detector(npd)"></a>node-problem-detector(npd)</h1><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/node-problem-detector">https://github.com/kubernetes/node-problem-detector</a></p>
<p>k8s的管控组件对于iaas层的node运行状态是完全不感知的，比如节点出现了ntp服务挂掉、硬件告警（cpu、内存、磁盘故障）、内核死锁。node-problem-detector旨在将node节点的问题转换k8s node event，以DaemonSet的方式部署在所有的k8s节点上。</p>
<p>上报故障的方式支持如下两种方式：</p>
<ul>
<li>对于永久性故障，通过修改node status中的condition上报给apiserver</li>
<li>对于临时性故障，通过Event的方式上报</li>
</ul>
<p>node-problem-detector在将节点的故障信息上报给k8s后，通常会配合一些自愈系统搭配使用，比如Draino和Descheduler 。</p>
<h1 id="sample-apiserver"><a href="#sample-apiserver" class="headerlink" title="sample-apiserver"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/sample-apiserver">sample-apiserver</a></h1><p>k8s提供了aggregated apiserver的方式来扩展api，该项目为一个简单的aaggregated apiserver的例子，可以直接编译出二进制文件。要想开发一个AA类型的服务，只需要frok一下该项目，并在项目的基础上进行修改即可完成。</p>
<p>相关资料：</p>
<ul>
<li>[Set up an Extension API Server](Set up an Extension API Server)</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
