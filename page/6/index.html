<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/6/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">237</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubectl-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubectl-command/" class="post-title-link" itemprop="url">kubectl常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 15:10:14" itemprop="dateCreated datePublished" datetime="2022-01-18T15:10:14+00:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文记录常用的kubectl命令，不定期更新。</p>
<h2 id="1-统计k8s-node上的污点信息"><a href="#1-统计k8s-node上的污点信息" class="headerlink" title="1. 统计k8s node上的污点信息"></a>1. 统计k8s node上的污点信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o=custom-columns=NodeName:.metadata.name,TaintKey:.spec.taints[*].key,TaintValue:.spec.taints[*].value,TaintEffect:.spec.taints[*].effect</span><br></pre></td></tr></table></figure>

<h2 id="2-查看不ready的pod"><a href="#2-查看不ready的pod" class="headerlink" title="2. 查看不ready的pod"></a>2. 查看不ready的pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide -w | grep -vE &quot;Com|NAME|Running|1/1|2/2|3/3|4/4&quot;</span><br></pre></td></tr></table></figure>

<h2 id="3-pod按照重启次数排序"><a href="#3-pod按照重启次数排序" class="headerlink" title="3. pod按照重启次数排序"></a>3. pod按照重启次数排序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A  --sort-by=&#x27;.status.containerStatuses[0].restartCount&#x27; | tail</span><br></pre></td></tr></table></figure>

<h2 id="4-kubectl-proxy命令代理k8s-apiserver"><a href="#4-kubectl-proxy命令代理k8s-apiserver" class="headerlink" title="4. kubectl proxy命令代理k8s apiserver"></a>4. kubectl proxy命令代理k8s apiserver</h2><p>该命令经常用在开发的场景下，用来测试k8s api的结果。执行如下命令即可在本地127.0.0.1开启10999端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port=10999</span><br></pre></td></tr></table></figure>

<p>在本地即可通过curl的方式来访问k8s的apiserver，而无需考虑鉴权问题。例如，<code>curl http://127.0.0.1:10999/apis/batch/v1</code>，即可直接返回结果。</p>
<h2 id="5-raw命令"><a href="#5-raw命令" class="headerlink" title="5. --raw命令"></a>5. <code>--raw</code>命令</h2><p>该命令经常用在开发的场景下，用来测试k8s api的结果。执行如下的命令，即可返回json格式的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw /apis/batch/v1</span><br></pre></td></tr></table></figure>

<h2 id="6-查看集群中的pod的request和limit情况"><a href="#6-查看集群中的pod的request和limit情况" class="headerlink" title="6. 查看集群中的pod的request和limit情况"></a>6. 查看集群中的pod的request和limit情况</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system  -o=custom-columns=NAME:.metadata.name,NAMESPACE:.metadata.namespace,PHASE:.status.phase,Request-cpu:.spec.containers\[0\].resources.requests.cpu,Request-memory:.spec.containers\[0\].resources.requests.memory,Limit-cpu:.spec.containers\[0\].resources.limits.cpu,Limit-memory:.spec.containers\[0\].resources.limits.memory</span><br></pre></td></tr></table></figure>

<p>得到的效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                                              NAMESPACE     PHASE       Request-cpu   Request-memory   Limit-cpu   Limit-memory</span><br><span class="line">cleanup-for-np-processor-9pjkm                    kube-system   Succeeded   &lt;none&gt;        &lt;none&gt;           &lt;none&gt;      &lt;none&gt;</span><br><span class="line">coredns-6c6664b94-7rnm8                           kube-system   Running     100m          70Mi             &lt;none&gt;      170Mi</span><br><span class="line">coredns-6c6664b94-djxch                           kube-system   Failed      100m          70Mi             &lt;none&gt;      170Mi</span><br><span class="line">coredns-6c6664b94-khvrb                           kube-system   Running     100m          70Mi             &lt;none&gt;      170Mi</span><br></pre></td></tr></table></figure>

<h2 id="7-修改对象的status"><a href="#7-修改对象的status" class="headerlink" title="7. 修改对象的status"></a>7. 修改对象的status</h2><p>因为status资源实际上为对象的subResource资源，实际上无法通过kubectl来完成，但该操作还是放到了该文档中。</p>
<p>下述命令的需求为修改service的status</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APISERVER=https://kube-cn-nb-nbsjzxpoc-d01-a.intra.nbsjzx.ali.com:6443</span><br><span class="line">TOKEN=eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1jazdkciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjhkZWE4MWQ4LTU2YTgtMTFlYy05MDMyLTgwNjE1ZjA4NDI0YSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.O25G_MSmKRU_pIPO_9tFqDvbZm9SOM_Mix7jCJeFiZHzLiSc7n5RanP3QoEldR1IcFN4AZXzlzI1Rb0GyFQH7XmS1eLESMbKnrTR3N5s3wlRp-D5QT0c_RAVAiLKrP7KsSKNcLjQkIO8-Csf_kmizIh6fP0-b7Mp90cw0J8oSlM-ScEeUEksQyXvyisVN9qvvTIkmbsgh7pX5IFcB4mGbvV9loOUC3-LdiiaCkMJzMisEeSJRaajmLlwpWXtb2BSi9HmBMktUE9IVB8ryZ06wbPRianbjoBwtAhcXuRyj1LaEog3aJHsyMA_DOZJtvjYis60AIRZ1iBnc-gZtEFCxw</span><br><span class="line">obj=nginx-ingress-lb</span><br><span class="line">curl -XPATCH -H &quot;Accept: application/json&quot; -H  &quot;Content-Type: application/merge-patch+json&quot; --header &quot;Authorization: Bearer $TOKEN&quot; --insecure -d &#x27;&#123;&quot;status&quot;: &#123;&quot;loadBalancer&quot;: &#123;&quot;ingress&quot;: [&#123;&quot;ip&quot;: &quot;10.209.97.170&quot;&#125;]&#125;&#125;&#125;&#x27; $APISERVER/api/v1/namespaces/acs-system/services/nginx-ingress-lb/status</span><br></pre></td></tr></table></figure>

<p>APISERVER变量可以通过kubeconfig文件获取到。</p>
<p>TOKEN变量可以直接使用kube-system下的admin账号。</p>
<ol>
<li>执行 <code>kubectl get secrets -n kube-system  | grep admin</code> 获取到sa对应的secret</li>
<li>执行 <code>kubectl get secrets -n kube-system xxxx -o yaml</code> 获取到base64之后的token</li>
<li>执行 <code>echo &quot;xxxx&quot; | base64 -d</code> 即可获取到对应的token</li>
</ol>
<p>obj变量为要修改的service对象名称。</p>
<h2 id="8-查看-secret-内容"><a href="#8-查看-secret-内容" class="headerlink" title="8. 查看 secret 内容"></a>8. 查看 secret 内容</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -n ark-system ark.cmdb.https.origin.tls -o jsonpath=&#x27;&#123;.data.ca\.pem&#125;&#x27; | base64 -d</span><br></pre></td></tr></table></figure>

<h2 id="9-修改-secret-或-cm-的内容"><a href="#9-修改-secret-或-cm-的内容" class="headerlink" title="9. 修改 secret 或 cm 的内容"></a>9. 修改 secret 或 cm 的内容</h2><p>很多场景下使用 <code>kubectl edit</code> 修改不能完全满足需求，比如某个 key 对应的 value 非常长且包含空格，很难直接编辑。可以通过导出 key 对应的 value 到文件，然后再重新 apply 的方式合入。</p>
<p>导出 configmap 中特定的 key：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cm -n kube-system  networkpolicy-config -o jsonpath=&#x27;&#123;.data.config\.yaml&#125;&#x27; -o yaml</span><br></pre></td></tr></table></figure>

<p>修改完成后，将文件重新 apply cm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create --save-config cm  networkpolicy-config -n kube-system --from-file /tmp/config.yaml -o yaml --dry-run | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<h2 id="9-删除所有-pod（或特定状态-pod）"><a href="#9-删除所有-pod（或特定状态-pod）" class="headerlink" title="9. 删除所有 pod（或特定状态 pod）"></a>9. 删除所有 pod（或特定状态 pod）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces -o wide --no-headers | grep -v Running | awk &#x27;&#123;print $1 &quot; &quot; $2&#125;&#x27; | while read AA BB; do kubectl get pod -n $AA $BB --no-headers; done</span><br></pre></td></tr></table></figure>

<h2 id="10-kubectl-debug"><a href="#10-kubectl-debug" class="headerlink" title="10. kubectl debug"></a>10. kubectl debug</h2><p>常用于网络问题排查，其中镜像 netshoot 中包含了丰富的网络命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-statefulset-0 bash</span><br></pre></td></tr></table></figure>

<p>进入到 k8s node 网络，其中 <code>$&#123;node&#125;</code> 为 k8s 的 node 名字。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl debug node/$&#123;node&#125; -it --image=nicolaka/netshoot</span><br></pre></td></tr></table></figure>

<h2 id="11-kubectl-patch"><a href="#11-kubectl-patch" class="headerlink" title="11. kubectl patch"></a>11. kubectl patch</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;filed1&quot;: &quot;value1&quot;&#125;&#125;&#x27; --type=merge xxx -n yyy</span><br></pre></td></tr></table></figure>

<h2 id="12-查询对象的-labels"><a href="#12-查询对象的-labels" class="headerlink" title="12. 查询对象的 labels"></a>12. 查询对象的 labels</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有 k8s 节点及其 label</span><br><span class="line">kubectl get nodes -o=jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&quot;\t&quot;&#125;&#123;.metadata.labels.topology\.kubernetes\.io/zone&#125;&#123;&quot;\n&quot;&#125;&#123;end&#125;&#x27;</span><br><span class="line"># 查看单个 k8s 节点的 label</span><br><span class="line">kubectl  get node c25e04016.cloud.e04.amtest130  -o jsonpath=&quot;&#123;.metadata.labels[&#x27;topology\.kubernetes\.io/zone&#x27;]&#125;&quot;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-dual-stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-dual-stack/" class="post-title-link" itemprop="url">k8s ipv4/ipv6双栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-16 23:41:33" itemprop="dateCreated datePublished" datetime="2022-01-16T23:41:33+00:00">2022-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ipv6在k8s中的支持情况"><a href="#ipv6在k8s中的支持情况" class="headerlink" title="ipv6在k8s中的支持情况"></a>ipv6在k8s中的支持情况</h1><p>ipv6特性在k8s中作为一个特定的feature IPv6DualStack来管理。在1.15版本到1.20版本该feature为alpha版本，默认不开启。从1.21版本开始，该feature为beta版本，默认开启，支持pod和service网络的双栈。1.23版本变为稳定版本。</p>
<h2 id="配置双栈"><a href="#配置双栈" class="headerlink" title="配置双栈"></a>配置双栈</h2><p>alpha版本需要通过kube-apiserver、kube-controller-manager、kubelet和kube-proxy的–feature-gates&#x3D;”IPv6DualStack&#x3D;true”命令来开启该特性，beta版本该特性默认开启。<br />​</p>
<p>kube-apiserver：</p>
<ul>
<li><code>--service-cluster-ip-range=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
</ul>
<p>kube-controller-manager:</p>
<ul>
<li><code>--cluster-cidr=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
<li><code>--service-cluster-ip-range=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
<li><code>--node-cidr-mask-size-ipv4|--node-cidr-mask-size-ipv6</code> 对于 IPv4 默认为 &#x2F;24，对于 IPv6 默认为 &#x2F;64</li>
</ul>
<p>kube-proxy:</p>
<ul>
<li><code>--cluster-cidr=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
</ul>
<h1 id="使用kind创建k8s集群"><a href="#使用kind创建k8s集群" class="headerlink" title="使用kind创建k8s集群"></a>使用kind创建k8s集群</h1><p>由于ipv6的环境并不容易找到，可以使用kind快速在本地拉起一个k8s的单集群环境，同时kind支持ipv6的配置。</p>
<p>检查当前系统是否支持ipv6，如果输出结果为0，说明当前系统支持ipv6.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> sysctl <span class="literal">-a</span> | grep net.ipv6.conf.all.disable_ipv6</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>创建ipv6单栈k8s集群执行如下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; kind<span class="literal">-ipv6</span>.conf &lt;&lt;EOF</span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x<span class="literal">-k8s</span>.io/v1alpha4</span><br><span class="line">name: ipv6<span class="literal">-only</span></span><br><span class="line">networking:</span><br><span class="line">  ipFamily: ipv6</span><br><span class="line"><span class="comment"># networking:</span></span><br><span class="line">  <span class="comment"># apiServerAddress: &quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="comment"># apiServerPort: 6443</span></span><br><span class="line">EOF</span><br><span class="line">kind create cluster <span class="literal">--config</span> kind<span class="literal">-ipv6</span>.conf</span><br></pre></td></tr></table></figure>
<p>创建ipv4&#x2F;ipv6双栈集群执行如下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; kind<span class="literal">-dual-stack</span>.conf &lt;&lt;EOF</span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x<span class="literal">-k8s</span>.io/v1alpha4</span><br><span class="line">name: dual<span class="literal">-stack</span></span><br><span class="line">networking:</span><br><span class="line">  ipFamily: dual</span><br><span class="line"><span class="comment"># networking:</span></span><br><span class="line">  <span class="comment"># apiServerAddress: &quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="comment"># apiServerPort: 6443</span></span><br><span class="line">EOF</span><br><span class="line">kind create cluster <span class="literal">--config</span> kind<span class="literal">-dual-stack</span>.conf</span><br></pre></td></tr></table></figure>
<h1 id="service网络"><a href="#service网络" class="headerlink" title="service网络"></a>service网络</h1><h2 id="spec定义"><a href="#spec定义" class="headerlink" title="spec定义"></a>spec定义</h2><p>k8s的service网络为了支持双栈，新增加了几个字段。</p>
<p>.spec.ipFamilies用来设置地址族，service一旦场景后该值不可认为修改，但可以通过修改.spec.ipFamilyPolicy来简介修改该字段的值。为数组格式，支持如下值：</p>
<ul>
<li>[“IPv4”]</li>
<li>[“IPv6”]</li>
<li>[“IPv4”,”IPv6”] （双栈）</li>
<li>[“IPv6”,”IPv4”] （双栈）</li>
</ul>
<p>上述数组中的第一个元素会决定.spec.ClusterIP中的字段。<br />​</p>
<p>.spec.ClusterIPs：由于.spec.ClusterIP的value为字符串，不支持同时设置ipv4和ipv6两个ip地址。因此又扩展出来了一个.spec.ClusterIPs字段，该字段的value为宿主元祖。在Headless类型的Service情况下，该字段的值为None。<br />​</p>
<p>.spec.ClusterIP：该字段的值跟.spec.ClusterIPs中的第一个元素的值保持一致。<br />​</p>
<p>.spec.ipFamilyPolicy支持如下值：</p>
<ul>
<li>SingleStack：默认值。会使用.spec.ipFamilies数组中配置的第一个协议来分配cluster ip。如果没有指定.spec.ipFamilies，会使用service-cluster-ip-range配置中第一个cidr中来配置地址。</li>
<li>PreferDualStack：如果 .spec.ipFamilies 没有设置，使用 k8s 集群默认的 ipFamily。</li>
<li>RequireDualStack：同时分配ipv4和ipv6地址。.spec.ClusterIP的值会从.spec.ClusterIPs选择第一个元素。</li>
</ul>
<h2 id="service配置场景"><a href="#service配置场景" class="headerlink" title="service配置场景"></a>service配置场景</h2><p>先创建如下的deployment，以便于后面试验的service可以关联到pod。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="未指定任何协议栈信息"><a href="#未指定任何协议栈信息" class="headerlink" title="未指定任何协议栈信息"></a>未指定任何协议栈信息</h3><p>在没有指定协议栈信息的Service，创建出来的service .spec.ipFamilyPolicy为SingleStack。同时会使用service-cluster-ip-range配置中第一个cidr中来配置地址。如果第一个cidr为ipv6，则service分配的clusterip为ipv6地址。创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>会生成如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.80</span><span class="number">.114</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.80</span><span class="number">.114</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定-spec-ipFamilyPolicy为PreferDualStack"><a href="#指定-spec-ipFamilyPolicy为PreferDualStack" class="headerlink" title="指定.spec.ipFamilyPolicy为PreferDualStack"></a>指定.spec.ipFamilyPolicy为PreferDualStack</h3><p>创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>提交到环境后会生成如下的service，可以看到.spec.clusterIPs中的ip地址跟ipFamilies中的顺序一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.221</span><span class="number">.70</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.221</span><span class="number">.70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:96::7d1</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>查看Endpoints，可以看到subsets中的地址为pod的ipv4协议地址。Endpoints中的地址跟service的.spec.ipFamilies数组中的第一个协议的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-vrfps</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16875&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">30a1d787-f799-4250-8c56-c96564ca9239</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-wgz72</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16917&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">8166d43e-2702-45c6-839e-b3005f44f647</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-x4lt5</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16896&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">f9c2968f-ca59-4ba9-a69f-358c202a964b</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>接下来指定.spec.ipFamilies的顺序再看一下执行的结果，创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>在环境中生成的service如下，可以看到.spec.clusterIPs中的顺序第一个为ipv6地址，.spec.clusterIP同样为ipv6地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">fd00:10:96::c306</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:96::c306</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.147</span><span class="number">.82</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>查看Endpoints，可以看到subsets中的地址为pod的ipv6协议地址。Endpoints中的地址跟service的.spec.ipFamilies数组中的第一个协议的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::5</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-vrfps</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16875&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">30a1d787-f799-4250-8c56-c96564ca9239</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::6</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-wgz72</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16917&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">8166d43e-2702-45c6-839e-b3005f44f647</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::7</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-x4lt5</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16896&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">f9c2968f-ca59-4ba9-a69f-358c202a964b</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<h2 id="单栈和双栈之间的切换"><a href="#单栈和双栈之间的切换" class="headerlink" title="单栈和双栈之间的切换"></a>单栈和双栈之间的切换</h2><p>虽然.spec.ipFamilies字段不允许直接修改，但.spec.ipFamilyPolicy字段允许修改，但并不影响单栈和双栈之间的切换。<br />单栈变双栈只需要修改.spec.ipFamilyPolicy从SingleStack变为PreferDualStack或者RequireDualStack即可。<br />双栈同样可以变为单栈，只需要修改.spec.ipFamilyPolicy从PreferDualStack或者RequireDualStack变为SingleStack即可。此时.spec.ipFamilies会自动变更为一个元素，.spec.clusterIPs同样会变更为一个元素。</p>
<h2 id="LoadBalancer类型的Service"><a href="#LoadBalancer类型的Service" class="headerlink" title="LoadBalancer类型的Service"></a>LoadBalancer类型的Service</h2><p>对于LoadBalancer类型的Service，单栈的情况下，会在.status.loadBalancer.ingress设置vip地址。如果是ingress中的ip地址为双栈，此时应该是将双栈的vip地址同时写到.status.loadBalancer.ingress中，并且要保证其顺序跟serivce的.spec.ipFamilies中的顺序一致。</p>
<h1 id="pod网络"><a href="#pod网络" class="headerlink" title="pod网络"></a>pod网络</h1><p>pod网络要支持ipv6，需要容器网络插件的支持。为了支持ipv6特性，新增加了.status.podIPs字段，用来展示pod上分配的ipv4和ipv6的信息。.status.podIP字段的值跟.status.podIPs数组的第一个元素的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">pod-template-hash:</span> <span class="string">558bd4d5db</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns-558bd4d5db-b2zbj</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/coredns/Corefile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/coredns/coredns:v1.8.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9153</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">170Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">70Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-hgxnc</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">2000000000</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">Corefile</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">Corefile</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-hgxnc</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-16T12:51:24Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://6da36ab908291ca1b4141a86d70f8c2bb150a933336d852bcabe2118aa1a3439</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/coredns/coredns:v1.8.0</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">sha256:296a6d5035e2d6919249e02709a488d680ddca91357602bd65e605eac967b899</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-01-16T12:51:27Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::3</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">Burstable</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2022-01-16T12:51:24Z&quot;</span></span><br></pre></td></tr></table></figure>
<p>pod中要想获取到ipv4、ipv6地址，可以通过downward api的形式将.status.podIPs以环境变量的形式传递到容器中，在pod中通过环境变量获取到的格式为: <code>10.244.1.4,a00:100::4</code>。</p>
<h1 id="k8s-node"><a href="#k8s-node" class="headerlink" title="k8s node"></a>k8s node</h1><p>在宿主机上可以通过ip addr show eth0的方式来查看网卡上的ip地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip addr show eth0</span></span><br><span class="line"><span class="attr">23:</span> <span class="string">eth0@if24:</span> <span class="string">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> <span class="string">mtu</span> <span class="number">1500 </span><span class="string">qdisc</span> <span class="string">noqueue</span> <span class="string">state</span> <span class="string">UP</span> <span class="string">group</span> <span class="string">default</span></span><br><span class="line">    <span class="string">link/ether</span> <span class="number">02</span><span class="string">:42:ac:12:00:02</span> <span class="string">brd</span> <span class="string">ff:ff:ff:ff:ff:ff</span> <span class="string">link-netnsid</span> <span class="number">0</span></span><br><span class="line">    <span class="string">inet</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span><span class="string">/16</span> <span class="string">brd</span> <span class="number">172.18</span><span class="number">.255</span><span class="number">.255</span> <span class="string">scope</span> <span class="string">global</span> <span class="string">eth0</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br><span class="line">    <span class="string">inet6</span> <span class="string">fc00:f853:ccd:e793::2/64</span> <span class="string">scope</span> <span class="string">global</span> <span class="string">nodad</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br><span class="line">    <span class="string">inet6</span> <span class="string">fe80::42:acff:fe12:2/64</span> <span class="string">scope</span> <span class="string">link</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br></pre></td></tr></table></figure>
<p>宿主机的网卡上有ipv6地址，k8s node上的.status.addresses中有所体现，type为InternalIP即包含了ipv4地址，又包含了ipv6地址，但此处并没有字段标识当前地址为ipv4，还是ipv6。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.alpha.kubernetes.io/cri-socket:</span> <span class="string">unix:///run/containerd/containerd.sock</span></span><br><span class="line">    <span class="attr">node.alpha.kubernetes.io/ttl:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">volumes.kubernetes.io/controller-managed-attach-detach:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/control-plane:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node.kubernetes.io/exclude-from-external-load-balancers:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">podCIDRs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:244::/64</span></span><br><span class="line">  <span class="attr">providerID:</span> <span class="string">kind://docker/dual-stack/dual-stack-control-plane</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">fc00:f853:ccd:e793::2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Hostname</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">15936568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">15936568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-01-16T15:01:48Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-16T12:50:54Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">memory</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientMemory</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">MemoryPressure</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">daemonEndpoints:</span></span><br><span class="line">    <span class="attr">kubeletEndpoint:</span></span><br><span class="line">      <span class="attr">Port:</span> <span class="number">10250</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s.gcr.io/kube-proxy:v1.21.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132714699</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">nodeInfo:</span></span><br><span class="line">    <span class="attr">architecture:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">bootID:</span> <span class="string">7f95abb9-7731-4a8c-9258-4a91cdcfb2ca</span></span><br><span class="line">    <span class="attr">containerRuntimeVersion:</span> <span class="string">containerd://1.5.2</span></span><br><span class="line">    <span class="attr">kernelVersion:</span> <span class="number">4.18</span><span class="number">.0</span><span class="number">-305.</span><span class="string">an8.x86_64</span></span><br><span class="line">    <span class="attr">kubeProxyVersion:</span> <span class="string">v1.21.1</span></span><br><span class="line">    <span class="attr">kubeletVersion:</span> <span class="string">v1.21.1</span></span><br><span class="line">    <span class="attr">machineID:</span> <span class="string">8f6a98bffc184893ab6bc260e705421b</span></span><br><span class="line">    <span class="attr">operatingSystem:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">osImage:</span> <span class="string">Ubuntu</span> <span class="number">21.04</span></span><br><span class="line">    <span class="attr">systemUUID:</span> <span class="string">f7928fdb-32be-4b6e-8dfd-260b6820f067</span></span><br></pre></td></tr></table></figure>
<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p>Ingress 可以通过开关 <code>disable-ipv6</code> 来控制是否开启 ipv6，默认 ipv6 开启。</p>
<p>在开启 ipv6 的情况下，如果 nginx ingress 的 pod 本身没有ipv6 的 ip地址，则在 nginx 的配置文件中并不会监听 ipv6 的端口号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listen 80  ;</span><br><span class="line">listen 443  ssl http2 ;</span><br></pre></td></tr></table></figure>

<p>如果 nginx ingress 的 pod 本身包含 ipv6 地址，则 nginx 的配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen 80  ;</span><br><span class="line">listen [::]:80  ;</span><br><span class="line">listen 443  ssl http2 ;</span><br><span class="line">listen [::]:443  ssl http2 ;</span><br></pre></td></tr></table></figure>





<p>参考资料：</p>
<ul>
<li>阿里云ACK的Nginx Ingress支持ipv6特性：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/378167.html">https://help.aliyun.com/document_detail/378167.html</a></li>
<li>[Nginx Ingress 支持 ipv6](<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#disable-ipv6">ConfigMap - NGINX Ingress Controller (kubernetes.github.io)</a>)</li>
</ul>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dual-stack/">https://kubernetes.io/docs/concepts/services-networking/dual-stack/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/network/validate-dual-stack/">https://kubernetes.io/docs/tasks/network/validate-dual-stack/</a></li>
<li><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/configuration/">https://kind.sigs.k8s.io/docs/user/configuration/</a></li>
</ul>
<br />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubefedv2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubefedv2/" class="post-title-link" itemprop="url">k8s多集群管理方案 - KubeFed V2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-09 11:33:15" itemprop="dateCreated datePublished" datetime="2022-01-09T11:33:15+00:00">2022-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><h2 id="Federation-V1"><a href="#Federation-V1" class="headerlink" title="Federation V1"></a>Federation V1</h2><p>Federation v1 在 K8s v1.3 左右就已经着手设计（Design Proposal），并在后面几个版本中发布了相关的组件与命令行工具（kubefed），用于帮助使用者快速建立联邦集群，并在 v1.6 时，进入了 Beta 阶段；但 Federation v1 在进入 Beta 后，就没有更进一步的发展，由于灵活性和 API 成熟度的问题，在 K8s v1.11 左右正式被弃用。</p>
<h2 id="Federation-V2架构"><a href="#Federation-V2架构" class="headerlink" title="Federation V2架构"></a>Federation V2架构</h2><p>v2 版本利用 CRD 实现了整体功能，通过定义多种自定义资源（CR），从而省掉了 v1 中的 API Server；v2 版本由两个组件构成：</p>
<ul>
<li>admission-webhook 提供了准入控制</li>
<li>controller-manager 处理自定义资源以及协调不同集群间的状态</li>
</ul>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/kubefedv2-1.png" alt="image"><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/kubefedv2-2.png" alt="image"></p>
<p>代码行数在2万行左右。</p>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><ul>
<li>Host Cluster：主集群&#x2F;父集群</li>
<li>Member Cluster：子集群&#x2F;成员集群</li>
</ul>
<h1 id="CRD扩展"><a href="#CRD扩展" class="headerlink" title="CRD扩展"></a>CRD扩展</h1><h2 id="KubeFedCluster"><a href="#KubeFedCluster" class="headerlink" title="KubeFedCluster"></a>KubeFedCluster</h2><p>子集群抽象，通过kubefedctl join命令创建。后续controller会使用该信息来访问子k8s集群。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kind: KubeFedCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: kind<span class="literal">-cluster1</span></span><br><span class="line">  namespace: kube<span class="literal">-federation-system</span></span><br><span class="line">spec:</span><br><span class="line">  apiEndpoint: https://<span class="number">172.21</span>.<span class="number">115.165</span>:<span class="number">6443</span></span><br><span class="line">  caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1USXlOREUyTlRNME9Wb1hEVE14TVRJeU1qRTJOVE0wT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTmxjCnF3UHd5cHNFc2M0aXB3QnFuRndDN044RXo2Slhqajh3ZzRybnlXTDNSdlZ0cmVua1Nha1VyYlRjZWVIck9lQTUKWGlNUVo2T1FBY25tUGU0Q2NWSkFoL2ZLQzBkeU9uL0ZZeXgyQXppRjBCK1ZNaUFhK2dvME1VMmhMZ1R5eVFGdQpDbWFmUGtsNmJxZUFJNCtCajZJUWRqY3dVMHBjY3lrNGhSTUxnQmhnTUh4NWkzVkpQckQ2Y284dHcwVnllWncyCkdDUlh2ZzlSd0QweUs5eitOVS9LVS83QjBiMTBvekpNRlVJMktPZmI4N1RkQ0h2NmlBdlVRYVdKc1BqQ0M3MzQKcnBma1ZGZXB2S2liKy9lUVBFaDE4VE5qaitveEVGMnl0Vmo2ZWVKeFc3VVZrbit0T3BxdGpEeUtKVDllNnlwdAp6U1VDTnRZWTAzckdhNTlLczBVQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZOTnRQU3hsMlMxUldOb1BCeXNIcHFoRXJONlVNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFDME0vaktCL2dqcWRSNlRLNXJQVktSSFU2cy8xTTh2eTY2WFBiVEx4M0srazdicUFWdAoxVUFzcUZDZmNrVk91WHY3eFQ0ZHIzVzdtMHE1bDYzRGg3ZDJRZDNiQ00zY2FuclpNd01OM0lSMlpmYzR0VlBGCnRTMFFONElTa0hsYnBudXQxb0F3cy9CaXNwaXNRQ0VtbHF3Zy9xbmdPMStlWWRoWm5vRW40SEFDamF4Slc5MS8KNXlOR1pKRXdia2dYQTVCbSs3VEZRL2FiYnp5a1JvOWtTMnl5c29pMnVzcUg0ZnlVS0ZWK2RETnp3Ujh0ck16cgpjWkRBNHpaVFB1WGlYRkVsWlNRa2NJSGIyV0VsYmZNRGpKNjlyVG5wakJCOWNPQ25jaHVmK0xiOXQwN1lJQ01wCmNlK0prNVp2RElRUFlKK3hTeGdRaVJxMTFraWlKcFE4Wm1FWgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">  proxyURL: <span class="string">&quot;&quot;</span></span><br><span class="line">  secretRef:</span><br><span class="line">    name: kind<span class="literal">-cluster1-dbxns</span></span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastProbeTime: <span class="string">&quot;2021-12-24T17:00:47Z&quot;</span></span><br><span class="line">    lastTransitionTime: <span class="string">&quot;2021-12-24T17:00:07Z&quot;</span></span><br><span class="line">    message: /healthz responded with ok</span><br><span class="line">    reason: ClusterReady</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: Ready</span><br></pre></td></tr></table></figure>
<h2 id="Fedrated"><a href="#Fedrated" class="headerlink" title="Fedrated"></a>Fedrated<Kind></h2><p>发布应用到子集群时手工创建。每一个要被联邦管理的资源都会对应一个Fedrated<Kind>类型的资源，比如ConfigMap对应的是FederatedConfigMap。FederatedConfigMap包含了三部分的信息：</p>
<ul>
<li>template：联邦的资源详细spec信息，需要特别注意的是并没有包含metadata部分的信息。</li>
<li>placement：template中的spec信息要部署的k8s子集群信息</li>
<li>overrides：允许对部分k8s的部分资源进行自定义修改<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: types.kubefed.io/v1beta1</span><br><span class="line">kind: FederatedConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test-configmap</span></span><br><span class="line">  namespace: <span class="built_in">test-namespace</span></span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    <span class="keyword">data</span>:</span><br><span class="line">      A: ala ma kota</span><br><span class="line">  placement:</span><br><span class="line">    clusters:</span><br><span class="line">    - name: cluster2</span><br><span class="line">    - name: cluster1</span><br><span class="line">  overrides:</span><br><span class="line">  - clusterName: cluster2</span><br><span class="line">    clusterOverrides:</span><br><span class="line">    - path: /<span class="keyword">data</span></span><br><span class="line">      value:</span><br><span class="line">        foo: bar</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="FederatedTypeConfig"><a href="#FederatedTypeConfig" class="headerlink" title="FederatedTypeConfig"></a>FederatedTypeConfig</h2><p>通过kubefedctl enable <target API type>创建。定义了哪些k8s api资源需要联邦，下面的例子描述了k8s ConfigMap要被联邦资源FederatedConfigMap所管理。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: core.kubefed.io/v1beta1</span><br><span class="line">kind: FederatedTypeConfig</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    meta.helm.sh/release<span class="literal">-name</span>: kubefed</span><br><span class="line">    meta.helm.sh/release<span class="literal">-namespace</span>: kube<span class="literal">-federation-system</span></span><br><span class="line">  finalizers:</span><br><span class="line">  - core.kubefed.io/federated<span class="literal">-type-config</span></span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/managed<span class="literal">-by</span>: Helm</span><br><span class="line">  name: configmaps</span><br><span class="line">  namespace: kube<span class="literal">-federation-system</span></span><br><span class="line">spec:</span><br><span class="line">  federatedType:</span><br><span class="line">    <span class="built_in">group</span>: types.kubefed.io</span><br><span class="line">    kind: FederatedConfigMap</span><br><span class="line">    pluralName: federatedconfigmaps</span><br><span class="line">    scope: Namespaced</span><br><span class="line">    version: v1beta1</span><br><span class="line">  propagation: Enabled <span class="comment"># 是否启用该联邦对象</span></span><br><span class="line">  targetType:</span><br><span class="line">    kind: ConfigMap</span><br><span class="line">    pluralName: configmaps</span><br><span class="line">    scope: Namespaced</span><br><span class="line">    version: v1</span><br><span class="line">status:</span><br><span class="line">  observedGeneration: <span class="number">1</span></span><br><span class="line">  propagationController: Running</span><br><span class="line">  statusController: NotRunning</span><br></pre></td></tr></table></figure>
<h2 id="ReplicaSchedulingPreference"><a href="#ReplicaSchedulingPreference" class="headerlink" title="ReplicaSchedulingPreference"></a>ReplicaSchedulingPreference</h2><p>用来管理相同名字的FederatedDeployment或FederatedReplicaset资源，保证所有子集群的副本数为spec.totalReplicas。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: scheduling.kubefed.io/v1alpha1</span><br><span class="line">kind: ReplicaSchedulingPreference</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test-deployment</span></span><br><span class="line">  namespace: <span class="built_in">test-ns</span></span><br><span class="line">spec:</span><br><span class="line">  targetKind: FederatedDeployment</span><br><span class="line">  totalReplicas: <span class="number">9</span></span><br><span class="line">  clusters:</span><br><span class="line">    A:</span><br><span class="line">      minReplicas: <span class="number">4</span></span><br><span class="line">      maxReplicas: <span class="number">6</span></span><br><span class="line">      weight: <span class="number">1</span></span><br><span class="line">    B:</span><br><span class="line">      minReplicas: <span class="number">4</span></span><br><span class="line">      maxReplicas: <span class="number">8</span></span><br><span class="line">      weight: <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>使用kind来在本机创建多个k8s集群的方式测试。通过kind创建两个k8s集群 kind-cluster1和kind-cluster2。<br>​</p>
<p>安装kubefedctl</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wget</span> https://github.com/kubernetes<span class="literal">-sigs</span>/kubefed/releases/download/v0.<span class="number">9.0</span>/kubefedctl<span class="literal">-0</span>.<span class="number">9.0</span><span class="literal">-linux-amd64</span>.tgz</span><br><span class="line">tar zvxf kubefedctl<span class="literal">-0</span>.<span class="number">9.0</span><span class="literal">-linux-amd64</span>.tgz</span><br><span class="line">chmod u+x kubefedctl</span><br><span class="line"><span class="built_in">mv</span> kubefedctl /usr/local/bin/</span><br></pre></td></tr></table></figure>
<p>在第一个集群安装KubeFed，在第一个集群执行如下的命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> helm repo add kubefed<span class="literal">-charts</span> https://raw.githubusercontent.com/kubernetes<span class="literal">-sigs</span>/kubefed/master/charts</span><br><span class="line"><span class="variable">$</span> helm repo list</span><br><span class="line"><span class="variable">$</span> helm <span class="literal">--namespace</span> kube<span class="literal">-federation-system</span> upgrade <span class="literal">-i</span> kubefed kubefed<span class="literal">-charts</span>/kubefed <span class="literal">--version</span>=<span class="number">0.9</span>.<span class="number">0</span> <span class="literal">--create-namespace</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会安装如下两个deployment，其中一个是controller，另外一个是webhook</span></span><br><span class="line"><span class="variable">$</span> kubectl  get deploy <span class="literal">-n</span> kube<span class="literal">-federation-system</span></span><br><span class="line">NAME                         READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">kubefed<span class="literal">-admission-webhook</span>    <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">7</span>m40s</span><br><span class="line">kubefed<span class="literal">-controller-manager</span>   <span class="number">2</span>/<span class="number">2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="number">7</span>m40s</span><br></pre></td></tr></table></figure>
<h1 id="子集群注册"><a href="#子集群注册" class="headerlink" title="子集群注册"></a>子集群注册</h1><p>将cluster1和cluster2集群加入到cluster1中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubefedctl join kind<span class="literal">-cluster1</span> <span class="literal">--cluster-context</span> kind<span class="literal">-cluster1</span> <span class="literal">--host-cluster-context</span> kind<span class="literal">-cluster1</span> <span class="literal">--v</span>=<span class="number">2</span></span><br><span class="line">kubefedctl join kind<span class="literal">-cluster2</span> <span class="literal">--cluster-context</span> kind<span class="literal">-cluster2</span> <span class="literal">--host-cluster-context</span> kind<span class="literal">-cluster1</span> <span class="literal">--v</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>在第一个集群可以看到在kube-federation-system中创建出了两个新的kubefedcluster对象</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl <span class="literal">-n</span> kube<span class="literal">-federation-system</span> get kubefedcluster</span><br><span class="line">NAME            AGE   READY</span><br><span class="line">kind<span class="literal">-cluster1</span>   <span class="number">17</span>s   True</span><br><span class="line">kind<span class="literal">-cluster2</span>   <span class="number">16</span>s   True</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> apiVersion: core.kubefed.io/v1beta1</span><br><span class="line">kind: KubeFedCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: kind<span class="literal">-cluster1</span></span><br><span class="line">  namespace: kube<span class="literal">-federation-system</span></span><br><span class="line">spec:</span><br><span class="line">  apiEndpoint: https://<span class="number">172.21</span>.<span class="number">115.165</span>:<span class="number">6443</span></span><br><span class="line">  caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1USXlOREUyTlRNME9Wb1hEVE14TVRJeU1qRTJOVE0wT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTmxjCnF3UHd5cHNFc2M0aXB3QnFuRndDN044RXo2Slhqajh3ZzRybnlXTDNSdlZ0cmVua1Nha1VyYlRjZWVIck9lQTUKWGlNUVo2T1FBY25tUGU0Q2NWSkFoL2ZLQzBkeU9uL0ZZeXgyQXppRjBCK1ZNaUFhK2dvME1VMmhMZ1R5eVFGdQpDbWFmUGtsNmJxZUFJNCtCajZJUWRqY3dVMHBjY3lrNGhSTUxnQmhnTUh4NWkzVkpQckQ2Y284dHcwVnllWncyCkdDUlh2ZzlSd0QweUs5eitOVS9LVS83QjBiMTBvekpNRlVJMktPZmI4N1RkQ0h2NmlBdlVRYVdKc1BqQ0M3MzQKcnBma1ZGZXB2S2liKy9lUVBFaDE4VE5qaitveEVGMnl0Vmo2ZWVKeFc3VVZrbit0T3BxdGpEeUtKVDllNnlwdAp6U1VDTnRZWTAzckdhNTlLczBVQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZOTnRQU3hsMlMxUldOb1BCeXNIcHFoRXJONlVNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFDME0vaktCL2dqcWRSNlRLNXJQVktSSFU2cy8xTTh2eTY2WFBiVEx4M0srazdicUFWdAoxVUFzcUZDZmNrVk91WHY3eFQ0ZHIzVzdtMHE1bDYzRGg3ZDJRZDNiQ00zY2FuclpNd01OM0lSMlpmYzR0VlBGCnRTMFFONElTa0hsYnBudXQxb0F3cy9CaXNwaXNRQ0VtbHF3Zy9xbmdPMStlWWRoWm5vRW40SEFDamF4Slc5MS8KNXlOR1pKRXdia2dYQTVCbSs3VEZRL2FiYnp5a1JvOWtTMnl5c29pMnVzcUg0ZnlVS0ZWK2RETnp3Ujh0ck16cgpjWkRBNHpaVFB1WGlYRkVsWlNRa2NJSGIyV0VsYmZNRGpKNjlyVG5wakJCOWNPQ25jaHVmK0xiOXQwN1lJQ01wCmNlK0prNVp2RElRUFlKK3hTeGdRaVJxMTFraWlKcFE4Wm1FWgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">  proxyURL: <span class="string">&quot;&quot;</span></span><br><span class="line">  secretRef:</span><br><span class="line">    name: kind<span class="literal">-cluster1-dbxns</span></span><br><span class="line">status:</span><br><span class="line">  conditions:</span><br><span class="line">  - lastProbeTime: <span class="string">&quot;2021-12-24T17:00:47Z&quot;</span></span><br><span class="line">    lastTransitionTime: <span class="string">&quot;2021-12-24T17:00:07Z&quot;</span></span><br><span class="line">    message: /healthz responded with ok</span><br><span class="line">    reason: ClusterReady</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: Ready</span><br></pre></td></tr></table></figure>
<p>要想将cluster2从主集群中移除，可以执行 kubefedctl unjoin kind-cluster2 –cluster-context kind-cluster2 –host-cluster-context kind-cluster1 –v&#x3D;2</p>
<h1 id="应用发布"><a href="#应用发布" class="headerlink" title="应用发布"></a>应用发布</h1><h2 id="集群联邦API"><a href="#集群联邦API" class="headerlink" title="集群联邦API"></a>集群联邦API</h2><p>kubefed将资源分为普通k8s资源类型和联邦的资源类型。在默认的场景下，kubefed已经内置将很多资源类型做了集群联邦。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> k get FederatedTypeConfig <span class="literal">-n</span> kube<span class="literal">-federation-system</span></span><br><span class="line">NAME                                            AGE</span><br><span class="line">clusterrolebindings.rbac.authorization.k8s.io   <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">clusterroles.rbac.authorization.k8s.io          <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">configmaps                                      <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">deployments.apps                                <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">ingresses.extensions                            <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">jobs.batch                                      <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">namespaces                                      <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">replicasets.apps                                <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">secrets                                         <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">serviceaccounts                                 <span class="number">19</span><span class="built_in">h</span></span><br><span class="line">services                                        <span class="number">19</span><span class="built_in">h</span></span><br></pre></td></tr></table></figure>
<p>将crd资源类型集群联邦，执行 kubefedctl enable 命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubefedctl enable customresourcedefinitions</span><br><span class="line">I1224 <span class="number">20</span>:<span class="number">32</span>:<span class="number">54.537112</span>  <span class="number">687543</span> util.go:<span class="number">141</span>] Api resource found.</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/federatedcustomresourcedefinitions.types.kubefed.io created</span><br><span class="line">federatedtypeconfig.core.kubefed.io/customresourcedefinitions.apiextensions.k8s.io created <span class="keyword">in</span> namespace kube<span class="literal">-federation-system</span></span><br></pre></td></tr></table></figure>
<p>可以看到会多出一个名字为federatedcustomresourcedefinitions.types.kubefed.io 的CRD 资源，同时会新创建一个FederatedTypeConfig类型的资源。当创建了FederatedTypeConfig后，就可以通过创建federatedcustomresourcedefinition类型的实例来向各个子集群发布CRD资源了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> k get crd federatedcustomresourcedefinitions.types.kubefed.io</span><br><span class="line">NAME                                                  CREATED AT</span><br><span class="line">federatedcustomresourcedefinitions.types.kubefed.io   <span class="number">2021</span><span class="literal">-12-24T12</span>:<span class="number">32</span>:<span class="number">54</span>Z</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> k get FederatedTypeConfig <span class="literal">-n</span> kube<span class="literal">-federation-system</span> customresourcedefinitions.apiextensions.k8s.io <span class="literal">-o</span> yaml</span><br><span class="line">apiVersion: core.kubefed.io/v1beta1</span><br><span class="line">kind: FederatedTypeConfig</span><br><span class="line">metadata:</span><br><span class="line">  finalizers:</span><br><span class="line">  - core.kubefed.io/federated<span class="literal">-type-config</span></span><br><span class="line">  name: customresourcedefinitions.apiextensions.k8s.io</span><br><span class="line">  namespace: kube<span class="literal">-federation-system</span></span><br><span class="line">spec:</span><br><span class="line">  federatedType:</span><br><span class="line">    <span class="built_in">group</span>: types.kubefed.io</span><br><span class="line">    kind: FederatedCustomResourceDefinition</span><br><span class="line">    pluralName: federatedcustomresourcedefinitions</span><br><span class="line">    scope: Cluster</span><br><span class="line">    version: v1beta1</span><br><span class="line">  propagation: Enabled</span><br><span class="line">  targetType:</span><br><span class="line">    <span class="built_in">group</span>: apiextensions.k8s.io</span><br><span class="line">    kind: CustomResourceDefinition</span><br><span class="line">    pluralName: customresourcedefinitions</span><br><span class="line">    scope: Cluster</span><br><span class="line">    version: v1</span><br><span class="line">status:</span><br><span class="line">  observedGeneration: <span class="number">1</span></span><br><span class="line">  propagationController: Running</span><br><span class="line">  statusController: NotRunning</span><br></pre></td></tr></table></figure>
<p>在example&#x2F;sample1下包含了很多例子，可以直接参考。接下来使用sample1中的例子进行试验。<br>​</p>
<p>在父集群创建namespace test-namespace</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl create <span class="operator">-f</span> namespace.yaml</span><br><span class="line">namespace/<span class="built_in">test-namespace</span> created</span><br></pre></td></tr></table></figure>
<p>在主集群中创建federatednamespace资源</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> k apply <span class="operator">-f</span> federatednamespace.yaml</span><br><span class="line">federatednamespace.types.kubefed.io/<span class="built_in">test-namespace</span> created</span><br></pre></td></tr></table></figure>
<p>在子集群中即可查询到新创建的namespace资源</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> k get ns <span class="built_in">test-namespace</span></span><br><span class="line">NAME             STATUS   AGE</span><br><span class="line"><span class="built_in">test-namespace</span>   Active   <span class="number">4</span>m49s</span><br></pre></td></tr></table></figure>
<p>其他的对象均可以按照跟上述namespace同样的方式来创建，比较特殊的对象为clusterrulebinding，该对象在默认情况下没有联邦api FederatedClusterRoleBinding，因此需要手工先创建FederatedClusterRoleBinding联邦api类型。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubefedctl enable clusterrolebinding</span><br><span class="line">I1225 <span class="number">01</span>:<span class="number">46</span>:<span class="number">42.779166</span>  <span class="number">818254</span> util.go:<span class="number">141</span>] Api resource found.</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/federatedclusterrolebindings.types.kubefed.io created</span><br><span class="line">federatedtypeconfig.core.kubefed.io/clusterrolebindings.rbac.authorization.k8s.io created <span class="keyword">in</span> namespace kube<span class="literal">-federation-system</span></span><br></pre></td></tr></table></figure>
<p>在创建完成FederatedClusterRoleBinding联邦api类型后，即可以创建出FederatedClusterRoleBinding类型的对象。</p>
<h2 id="子集群的个性化配置"><a href="#子集群的个性化配置" class="headerlink" title="子集群的个性化配置"></a>子集群的个性化配置</h2><p>通过Fedrated<Kind>中的spec.overrides来完成，可以覆盖spec.template中的内容</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: types.kubefed.io/v1beta1</span><br><span class="line">kind: FederatedDeployment</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test-deployment</span></span><br><span class="line">  namespace: <span class="built_in">test-namespace</span></span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      replicas: <span class="number">3</span></span><br><span class="line">      selector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          app: nginx</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          labels:</span><br><span class="line">            app: nginx</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - image: nginx</span><br><span class="line">            name: nginx</span><br><span class="line">  placement:</span><br><span class="line">    clusters:</span><br><span class="line">    - name: cluster2</span><br><span class="line">    - name: cluster1</span><br><span class="line">  overrides:</span><br><span class="line">  - clusterName: cluster2</span><br><span class="line">    clusterOverrides:</span><br><span class="line">    - path: <span class="string">&quot;/spec/replicas&quot;</span></span><br><span class="line">      value: <span class="number">5</span></span><br><span class="line">    - path: <span class="string">&quot;/spec/template/spec/containers/0/image&quot;</span></span><br><span class="line">      value: <span class="string">&quot;nginx:1.17.0-alpine&quot;</span></span><br><span class="line">    - path: <span class="string">&quot;/metadata/annotations&quot;</span></span><br><span class="line">      op: <span class="string">&quot;add&quot;</span></span><br><span class="line">      value:</span><br><span class="line">        foo: bar</span><br><span class="line">    - path: <span class="string">&quot;/metadata/annotations/foo&quot;</span></span><br><span class="line">      op: <span class="string">&quot;remove&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="多集群应用调度"><a href="#多集群应用调度" class="headerlink" title="多集群应用调度"></a>多集群应用调度</h2><h3 id="发布应用到特定的子集群"><a href="#发布应用到特定的子集群" class="headerlink" title="发布应用到特定的子集群"></a>发布应用到特定的子集群</h3><p>在Fedrated<Kind>的spec.placement.clusters中，定义了要发布到哪个子集群的信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">placement:</span><br><span class="line">    clusters:</span><br><span class="line">    - name: cluster2</span><br><span class="line">    - name: cluster1</span><br></pre></td></tr></table></figure>
<p>不过上述方法需要指定特定的集群，为了有更丰富的灵活性，kubefed还提供了label selector的机制，可以提供spec.placement.clusterSelector来指定一组集群。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  placement:</span><br><span class="line">    clusters: []</span><br><span class="line">    clusterSelector:</span><br><span class="line">      matchLabels:</span><br><span class="line">        foo: bar</span><br></pre></td></tr></table></figure>
<p>标签选择器通过跟kubefedclusters对象的label来进行匹配，可以执行下述命令给kubefedclusters来打标签。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label kubefedclusters <span class="literal">-n</span> kube<span class="literal">-federation-system</span> kind<span class="literal">-cluster1</span> foo=bar</span><br></pre></td></tr></table></figure>

<h3 id="子集群差异化调度"><a href="#子集群差异化调度" class="headerlink" title="子集群差异化调度"></a>子集群差异化调度</h3><p>上述调度功能被选择的子集群为平等关系，如果要想子集群能够有所差异，可以使用ReplicaSchedulingPreference来完成，目前仅支持deployment和replicaset两种类型的资源，还不支持statefulset。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: scheduling.kubefed.io/v1alpha1</span><br><span class="line">kind: ReplicaSchedulingPreference</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test-deployment</span></span><br><span class="line">  namespace: <span class="built_in">test-ns</span></span><br><span class="line">spec:</span><br><span class="line">  targetKind: FederatedDeployment</span><br><span class="line">  totalReplicas: <span class="number">9</span></span><br><span class="line">  clusters:</span><br><span class="line">    A:</span><br><span class="line">      minReplicas: <span class="number">4</span></span><br><span class="line">      maxReplicas: <span class="number">6</span></span><br><span class="line">      weight: <span class="number">1</span></span><br><span class="line">    B:</span><br><span class="line">      minReplicas: <span class="number">4</span></span><br><span class="line">      maxReplicas: <span class="number">8</span></span><br><span class="line">      weight: <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>spec.targetKind用来指定管理的类型，仅支持FederatedDeployment和FederatedReplicaset。<br>spec.totalReplicas用来指定所有子集群的副本数总和。优先级要高于FederatedDeployment和FederatedReplicaset的spec.template中指定的副本数。<br>spec.clusters用来指定每个子集群的最大、最小副本数和权重。<br>spec.rebalance自动调整整个集群中的副本数，比如一个集群中的pod挂掉后，可以将pod迁移到另外的集群中。</p>
<h1 id="子集群之间的交互"><a href="#子集群之间的交互" class="headerlink" title="子集群之间的交互"></a>子集群之间的交互</h1><p>无</p>
<h1 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h1><ol>
<li>父集群充当了所有集群的单一控制面</li>
<li>通过联邦CRD来管理资源，无法直接使用k8s原生的资源，集群间维护CRD版本和API版本一致性导致升级比较复杂。</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>官方文档：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubefed/blob/master/docs/userguide.md#using-cluster-selector">https://github.com/kubernetes-sigs/kubefed/blob/master/docs/userguide.md#using-cluster-selector</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/certificate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/certificate/" class="post-title-link" itemprop="url">证书技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-07 10:34:15" itemprop="dateCreated datePublished" datetime="2022-01-07T10:34:15+00:00">2022-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="使用openssl创建自签名证书"><a href="#使用openssl创建自签名证书" class="headerlink" title="使用openssl创建自签名证书"></a>使用openssl创建自签名证书</h1><p>创建CA</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa <span class="literal">-out</span> root.key <span class="number">4096</span></span><br><span class="line">openssl req <span class="literal">-new</span> <span class="literal">-x509</span> <span class="literal">-days</span> <span class="number">1000</span> <span class="literal">-key</span> root.key <span class="literal">-out</span> root.crt</span><br><span class="line">openssl x509 <span class="literal">-text</span> <span class="operator">-in</span> root.crt <span class="literal">-noout</span></span><br></pre></td></tr></table></figure>
<p>创建私钥和公钥文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用来产生私钥文件server.key</span></span><br><span class="line">openssl genrsa <span class="literal">-out</span> server.key <span class="number">2048</span></span><br><span class="line"><span class="comment"># 产生公钥文件</span></span><br><span class="line">openssl rsa <span class="operator">-in</span> server.key <span class="literal">-pubout</span> <span class="literal">-out</span> server.pem</span><br></pre></td></tr></table></figure>
<p>创建签名请求</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl req <span class="literal">-new</span> <span class="literal">-key</span> server.key <span class="literal">-out</span> server.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看创建的签名请求</span></span><br><span class="line">openssl req <span class="literal">-noout</span> <span class="literal">-text</span> <span class="operator">-in</span> server.csr</span><br></pre></td></tr></table></figure>
<p>创建自签名证书<br>新建自签名证书的附加信息server.ext，内容如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[<span class="type">alt_names</span>]</span><br><span class="line">DNS.<span class="number">1</span> = localhost</span><br><span class="line">IP.<span class="number">2</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">IP.<span class="number">3</span> = <span class="number">10.66</span>.<span class="number">3.6</span></span><br></pre></td></tr></table></figure>

<p>使用ca签发ssl证书，此时会产生server.crt文件，即为证书文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 <span class="literal">-req</span> <span class="operator">-in</span> server.csr <span class="literal">-out</span> server.crt <span class="literal">-days</span> <span class="number">3650</span> \</span><br><span class="line">  <span class="literal">-CAcreateserial</span> <span class="literal">-CA</span> root.crt <span class="literal">-CAkey</span> root.key \</span><br><span class="line">  <span class="literal">-CAserial</span> serial <span class="literal">-extfile</span> server.ext</span><br></pre></td></tr></table></figure>

<p>查看证书文件内容</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 <span class="operator">-in</span> server.crt   <span class="literal">-noout</span> <span class="literal">-text</span></span><br></pre></td></tr></table></figure>

<p>使用ca校验证书是否通过</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl verify <span class="literal">-CAfile</span> root.crt server.crt</span><br></pre></td></tr></table></figure>

<h1 id="使用cfssl签发证书"><a href="#使用cfssl签发证书" class="headerlink" title="使用cfssl签发证书"></a>使用cfssl签发证书</h1><p>cfssl是CloudFlare开源的一款tls工具，使用go语言编写，地址：<a target="_blank" rel="noopener" href="https://github.com/cloudflare/cfssl%E3%80%82">https://github.com/cloudflare/cfssl。</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>mac用户：brew install cfssl</p>
<p>linux用户可以直接下载二进制文件：<a target="_blank" rel="noopener" href="https://github.com/cloudflare/cfssl/releases">https://github.com/cloudflare/cfssl/releases</a></p>
<h2 id="签发证书"><a href="#签发证书" class="headerlink" title="签发证书"></a>签发证书</h2><p>待补充</p>
<h1 id="证书格式"><a href="#证书格式" class="headerlink" title="证书格式"></a>证书格式</h1><p>证书按照格式可以分为二进制和文本文件两种格式。</p>
<p>二进制格式分为：</p>
<ol>
<li><em>.der或者</em>.cer：用来存放证书信息，不包含私钥。</li>
</ol>
<p>文本格式分为：</p>
<ol>
<li><em>.pem：存放证书或者私钥。一般是</em>.key文件存放私钥信息。对于pem或者key文件，如果存在<strong>——BEGIN CERTIFICATE——</strong>，则说明这是一个证书文件。如果存在<strong>—–BEGIN RSA PRIVATE KEY—–</strong>，则说明这是一个私钥文件。</li>
<li>*.key：用来存放私钥文件。</li>
<li>*.crt：证书请求文件，格式的开头为：—–BEGIN CERTIFICATE REQUEST—–</li>
</ol>
<h2 id="证书格式的转换"><a href="#证书格式的转换" class="headerlink" title="证书格式的转换"></a>证书格式的转换</h2><p>将cert证书转换为pem格式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa <span class="operator">-in</span> server.key <span class="literal">-text</span> &gt; server<span class="literal">-key</span>.pem</span><br><span class="line">openssl x509 <span class="operator">-in</span> server.crt <span class="literal">-out</span> server.pem</span><br></pre></td></tr></table></figure>
<p>将pem格式转换为cert格式</p>
<h1 id="证书查看"><a href="#证书查看" class="headerlink" title="证书查看"></a>证书查看</h1><p>查看特定域名的证书内容：<code>echo | openssl s_client  -connect www.baidu.com:443 -servername www.baidu.com 2&gt;/dev/null | openssl x509 -noout -text</code></p>
<p>获取特定域名的证书内容：<code>openssl s_client -servername www.baidu.com -connect www.baidu.com:443 &lt;/dev/null | sed -ne &#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</code></p>
<h1 id="证书的使用"><a href="#证书的使用" class="headerlink" title="证书的使用"></a>证书的使用</h1><p>curl命令关于证书的用法：</p>
<ul>
<li>–cacert：指定ca来校验server端的证书合法性</li>
<li>–cert：指定客户端的证书文件，用在双向认证mTLS中</li>
<li>–key：私钥文件名，用在双向认证mTLS中</li>
</ul>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/liuguangw/4d4b87b750be8edb700ff94c783b1dd4">https://gist.github.com/liuguangw/4d4b87b750be8edb700ff94c783b1dd4</a></li>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/21708.html">https://coolshell.cn/articles/21708.html</a></li>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/160093.html">https://help.aliyun.com/document_detail&#x2F;160093.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/clusternet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/clusternet/" class="post-title-link" itemprop="url">k8s多集群管理方案 - clusternet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-12-26 21:44:17" itemprop="dateCreated datePublished" datetime="2021-12-26T21:44:17+00:00">2021-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>腾讯云开源的k8s多集群管理方案，可发布应用到多个k8s集群。<br><a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet">https://github.com/clusternet/clusternet</a><br>GitHub Star：891</p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/clusternet1.png" alt="image.png"><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/clusternet2.png" alt="image.png"><br>包含clusternet-hub和clusternet-agent两个组件。</p>
<p>clusternet-hub部署在父集群，用途：</p>
<ul>
<li>接收子集群的注册请求，并为每个自己群创建namespace、serviceaccount等资源</li>
<li>提供父集群跟各个子集群的长连接</li>
<li>提供restful api来访问各个子集群，同时支持子集群的互访</li>
</ul>
<p>clusternet-agent部署在子集群，用途：</p>
<ul>
<li>自动注册子集群到父集群</li>
<li>心跳报告到中心集群，包括k8s版本、运行平台、健康状态等</li>
<li>通过websocket协议跟父集群通讯</li>
</ul>
<h1 id="CRD抽象"><a href="#CRD抽象" class="headerlink" title="CRD抽象"></a>CRD抽象</h1><h2 id="ClusterRegistrationRequest"><a href="#ClusterRegistrationRequest" class="headerlink" title="ClusterRegistrationRequest"></a>ClusterRegistrationRequest</h2><p>clusternet-agent在父集群中创建的CR，一个k8s集群一个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: clusters.clusternet.io/v1beta1</span><br><span class="line">kind: ClusterRegistrationRequest</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    clusters.clusternet.io/cluster<span class="literal">-id</span>: <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">    clusters.clusternet.io/cluster<span class="literal">-name</span>: clusternet<span class="literal">-cluster-pmlbp</span></span><br><span class="line">    clusters.clusternet.io/registered<span class="literal">-by</span>: clusternet<span class="literal">-agent</span></span><br><span class="line">  name: clusternet<span class="literal">-2bcd48d2-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">spec:</span><br><span class="line">  clusterId: <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">  clusterName: clusternet<span class="literal">-cluster-pmlbp</span> <span class="comment"># 集群名称</span></span><br><span class="line">  clusterType: EdgeCluster <span class="comment"># 集群类型</span></span><br><span class="line">  syncMode: Dual</span><br><span class="line">status:</span><br><span class="line">  caCertificate: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJeE1USXhNekV3TWpjeE5Wb1hEVE14TVRJeE1URXdNamN4TlZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTHVCCmJwdXNaZXM5RXFXaEw1WUVGb2c4eHRJai9jbFh2S1lTMnZYbGR4cUt1MUR3VHV3aUcxZUN4VGlHa2dLQXVXd1IKVFFheEh5aGY3U29lc0hqMG43NnFBKzhQT05lS1VGdERJOWVzejF2WTF5bXFoUHR0QVo0cGhkWmhmbXJjZTJLRQpuMS84MzNWbWlXd0pSZmNWcEJtTU52MjFYMVVwNWp6RGtncS9tY0JOOGN0ZU5PMEpKNkVVeTE2RXZLbjhyWG90ClErTW5PUHE4anFNMzJjRFFqYWVEdGxvM2kveXlRd1NMa2wzNFo4aElwZDZNWWVSTWpXcmhrazF4L0RYZjNJK3IKOGs5S1FBbEsvNWZRMXk5NHYwT25TK0FKZTliczZMT2srYVFWYm5SbExab2E2aVZWbUJNam03UjBjQ2w0Y1hpRwpyekRnN1ZLc3lsY1o3aGFRRTNFQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZPaGwxMHUwNnJvenZJUm9XVmpNYlVPMzFDbERNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBQytqMXpPQVZYVXpNUFJ0U29Kd3JhMU1FSkJOUTNMWitmWnZRYjdIbk53b00zaCthMgoyc25yUitSWTYrOFFDbXVKeis1eU5yYStEZDlnNzQ1Q0hDaFpVZzlsY3RjQTRzZVR5OXZqcUVQNVBNSzEvbi9PCnFEcDQyMUpqTjYvUXJmamIvbVM0elUvZXNGZGowQXRYQ0FLMWJsNmF0ai9jZXVBbzh1bTRPaUVlNnJhanBYTHUKWFlmQ1FVZFV5TWpQdEZHTDMwNytna0RpdlVsdXk3RkQ4aUpURTh2QWpxOVBXOW40SmxFMjdQWXR5QnNocy9XSApCZ2czQjZpTG10SjZlNzJiWnA3ZmptdmJWTC9VdkxzYXZqRXltZDhrMnN1bFFwQUpzeVJrMkEzM1g3NWJpS0RGCk1CU29DaHc3U2JMSkJrN0FNckRzTjd1Q2U3WWVIWGdZemdhRAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br><span class="line">  dedicatedNamespace: clusternet<span class="literal">-sdqrh</span></span><br><span class="line">  managedClusterName: clusternet<span class="literal">-cluster-pmlbp</span></span><br><span class="line">  result: Approved</span><br><span class="line">  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluZFpWMUV6UmxCbFdUUldWa1Y0UmxBeWMzaDJOV3RuUzBabVJsaG9jWG94TkhKM2JtUkxiRTlrYUZVaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpqYkhWemRHVnlibVYwTFhOa2NYSm9JaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbU5zZFhOMFpYSnVaWFF0YmpneWFHc3RkRzlyWlc0dGN6SnpjRFVpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWTJ4MWMzUmxjbTVsZEMxdU9ESm9heUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJamN3TWpRMk1tTTBMV0prTlRFdE5HVXpNeTA1WXpnekxUWmpPV1F6TUdGall6bG1aU0lzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwamJIVnpkR1Z5Ym1WMExYTmtjWEpvT21Oc2RYTjBaWEp1WlhRdGJqZ3lhR3NpZlEuUjJCdEQ1YzQxRm1seC1hTEFKSWQzbGxvOThSY25TakVUak5pSnVuTXg1US1jYXhwc3VkamUxekVtUF9mTHR6TjU4d21Dd3RXcHpoaXhSMWFTUHE5LXJTRlBIYzk3aDlTT3daZGdicC10alFBSjA4dllfYWdiVFRKLU1WN1dpN0xQVzRIcmt1U3RlemUzVHh2RW11NWwySlpzbG5UTXdkR3NGRVlVZzVfeWFoLUQwQ2pnTkZlR1ljUjJ1TlJBWjdkNW00Q1c5VmRkdkNsanNqRE5WX1k0RkFEbGo2cHgzSlh0SDQ4U1ZUd254TS1sNHl0eXBENjZFbG1PYXpUMmRwSWd4eWNSZ0tJSUlacWNQNnZVc0ZOM1Zka21ZZ29ydy1NSUcwc25YdzFaZ1lwRk9SUDJRa3hjd2NOUVVOTjh6VUZqSUZSSmdSSFdjNlo4aXd2eURnZTVn</span><br></pre></td></tr></table></figure>
<h2 id="ClusterRole和Role"><a href="#ClusterRole和Role" class="headerlink" title="ClusterRole和Role"></a>ClusterRole和Role</h2><p>ClusterRegistrationRequest被接收后会创建ClusterRole</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    clusternet.io/autoupdate: <span class="string">&quot;true&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    clusternet.io/created<span class="literal">-by</span>: clusternet<span class="literal">-hub</span></span><br><span class="line">    clusters.clusternet.io/bootstrapping: rbac<span class="literal">-defaults</span></span><br><span class="line">    clusters.clusternet.io/cluster<span class="literal">-id</span>: <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">  name: clusternet<span class="literal">-2bcd48d2-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - clusters.clusternet.io</span><br><span class="line">  resources:</span><br><span class="line">  - clusterregistrationrequests</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - proxies.clusternet.io</span><br><span class="line">  resourceNames:</span><br><span class="line">  - <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">  resources:</span><br><span class="line">  - sockets</span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<p>并会在cluster对应的namespace下创建Role</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    clusternet.io/autoupdate: <span class="string">&quot;true&quot;</span></span><br><span class="line">  labels:</span><br><span class="line">    clusternet.io/created<span class="literal">-by</span>: clusternet<span class="literal">-hub</span></span><br><span class="line">    clusters.clusternet.io/bootstrapping: rbac<span class="literal">-defaults</span></span><br><span class="line">  name: clusternet<span class="literal">-managedcluster-role</span></span><br><span class="line">  namespace: clusternet<span class="literal">-sdqrh</span></span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  resources:</span><br><span class="line">  - <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  verbs:</span><br><span class="line">  - <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="ManagedCluster"><a href="#ManagedCluster" class="headerlink" title="ManagedCluster"></a>ManagedCluster</h2><p>clusternet-hub在接受ClusterRegistrationRequest后，会创建一个ManagedCluster。一个k8s集群一个namespace</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: clusters.clusternet.io/v1beta1</span><br><span class="line">kind: ManagedCluster</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    clusternet.io/created<span class="literal">-by</span>: clusternet<span class="literal">-agent</span></span><br><span class="line">    clusters.clusternet.io/cluster<span class="literal">-id</span>: <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">    clusters.clusternet.io/cluster<span class="literal">-name</span>: clusternet<span class="literal">-cluster-pmlbp</span></span><br><span class="line">  name: clusternet<span class="literal">-cluster-pmlbp</span></span><br><span class="line">  namespace: clusternet<span class="literal">-sdqrh</span></span><br><span class="line">spec:</span><br><span class="line">  clusterId: <span class="number">2</span>bcd48d2<span class="literal">-0ead-45f7-938b-5af6af7da5fd</span></span><br><span class="line">  clusterType: EdgeCluster</span><br><span class="line">  syncMode: Dual</span><br><span class="line">status:</span><br><span class="line">  allocatable:</span><br><span class="line">    cpu: <span class="number">7600</span>m</span><br><span class="line">    memory: <span class="string">&quot;30792789992&quot;</span></span><br><span class="line">  apiserverURL: https://<span class="number">10.233</span>.<span class="number">0.1</span>:<span class="number">443</span> <span class="comment"># default/kubernetes的service clusterip</span></span><br><span class="line">  appPusher: true</span><br><span class="line">  capacity:</span><br><span class="line">    cpu: <span class="string">&quot;8&quot;</span></span><br><span class="line">    memory: <span class="number">32192720</span>Ki</span><br><span class="line">  clusterCIDR: <span class="number">10.233</span>.<span class="number">0.0</span>/<span class="number">18</span></span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: <span class="string">&quot;2021-12-15T07:47:10Z&quot;</span></span><br><span class="line">    message: managed cluster is ready.</span><br><span class="line">    reason: ManagedClusterReady</span><br><span class="line">    status: <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="built_in">type</span>: Ready</span><br><span class="line">  healthz: true</span><br><span class="line">  heartbeatFrequencySeconds: <span class="number">180</span></span><br><span class="line">  k8sVersion: v1.<span class="number">21.5</span></span><br><span class="line">  lastObservedTime: <span class="string">&quot;2021-12-15T07:47:10Z&quot;</span></span><br><span class="line">  livez: true</span><br><span class="line">  nodeStatistics:</span><br><span class="line">    readyNodes: <span class="number">1</span></span><br><span class="line">  parentAPIServerURL: https://<span class="number">172.21</span>.<span class="number">115.160</span>:<span class="number">6443</span>  <span class="comment"># 父集群地址</span></span><br><span class="line">  platform: linux/amd64</span><br><span class="line">  readyz: true</span><br><span class="line">  serviceCIDR: <span class="number">10.233</span>.<span class="number">64.0</span>/<span class="number">18</span></span><br><span class="line">  useSocket: true</span><br></pre></td></tr></table></figure>
<h2 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h2><p>应用发布的抽象，人工提交到环境中。要发布的资源即可以是helm chart，也可以是原生的k8s对象。clusternet在部署的时候会查看部署的优先级，并且支持weight，优先部署cluster级别的资源，这点跟helm部署的逻辑一致。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps.clusternet.io/v1alpha1</span><br><span class="line">kind: Subscription</span><br><span class="line">metadata:</span><br><span class="line">  name: app<span class="literal">-demo</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># 定义应用要发布到哪个k8s集群</span></span><br><span class="line">  subscribers: <span class="comment"># defines the clusters to be distributed to</span></span><br><span class="line">    - clusterAffinity:</span><br><span class="line">        matchLabels:</span><br><span class="line">          clusters.clusternet.io/cluster<span class="literal">-id</span>: dc91021d<span class="literal">-2361-4f6d-a404-7c33b9e01118</span> <span class="comment"># PLEASE UPDATE THIS CLUSTER-ID TO YOURS!!!</span></span><br><span class="line">	<span class="comment"># 定义了要发布哪些资源</span></span><br><span class="line">  feeds: <span class="comment"># defines all the resources to be deployed with</span></span><br><span class="line">    - apiVersion: apps.clusternet.io/v1alpha1</span><br><span class="line">      kind: HelmChart</span><br><span class="line">      name: mysql</span><br><span class="line">      namespace: default</span><br><span class="line">    - apiVersion: v1</span><br><span class="line">      kind: Namespace</span><br><span class="line">      name: foo</span><br><span class="line">    - apiVersion: v1</span><br><span class="line">      kind: Service</span><br><span class="line">      name: my<span class="literal">-nginx-svc</span></span><br><span class="line">      namespace: foo</span><br><span class="line">    - apiVersion: apps/v1</span><br><span class="line">      kind: Deployment</span><br><span class="line">      name: my<span class="literal">-nginx</span></span><br><span class="line">      namespace: foo</span><br></pre></td></tr></table></figure>
<h2 id="HelmChart"><a href="#HelmChart" class="headerlink" title="HelmChart"></a>HelmChart</h2><p>Subscriber发布的一个子资源之一，对应一个helm chart的完整描述</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps.clusternet.io/v1alpha1</span><br><span class="line">kind: HelmChart</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  repo: https://charts.bitnami.com/bitnami</span><br><span class="line">  chart: mysql</span><br><span class="line">  version: <span class="number">8.6</span>.<span class="number">2</span></span><br><span class="line">  targetNamespace: abc</span><br></pre></td></tr></table></figure>
<h2 id="Localization"><a href="#Localization" class="headerlink" title="Localization"></a>Localization</h2><p>差异化不同于其他集群的配置，用来描述namespace级别的差异化配置。</p>
<h2 id="Globalization"><a href="#Globalization" class="headerlink" title="Globalization"></a>Globalization</h2><p>用来描述不同集群的cluster级别的差异化配置。</p>
<h2 id="Base"><a href="#Base" class="headerlink" title="Base"></a>Base</h2><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>跟Base对象根据Localization和Globalization渲染得到的最终要发布到集群中的最终对象。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>本文使用kind进行测试，使用kind创建两个k8s集群host和member1，两个集群的apiserver均监听在宿主机的端口，确保从一个集群可以访问到另外一个集群的apiserver。</p>
<p>在父集群执行如下命令安装clusternet管控组件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add clusternet https://clusternet.github.io/charts</span><br><span class="line">helm install clusternet<span class="literal">-hub</span> <span class="literal">-n</span> clusternet<span class="literal">-system</span> <span class="literal">--create-namespace</span> clusternet/clusternet<span class="literal">-hub</span></span><br><span class="line">kubectl apply <span class="operator">-f</span> https://raw.githubusercontent.com/clusternet/clusternet/main/manifests/samples/cluster_bootstrap_token.yaml</span><br></pre></td></tr></table></figure>
<p>会在clusternet-system namespace下创建deployment clusternet-hub。</p>
<p>最后一条命令，会创建一个secret，其中的token信息为07401b.f395accd246ae52d，在子集群注册的时候需要用到。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># Name MUST be of form &quot;bootstrap-token-&lt;token id&gt;&quot;</span></span><br><span class="line">  name: bootstrap<span class="literal">-token-07401b</span></span><br><span class="line">  namespace: kube<span class="literal">-system</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Type MUST be &#x27;bootstrap.kubernetes.io/token&#x27;</span></span><br><span class="line"><span class="built_in">type</span>: bootstrap.kubernetes.io/token</span><br><span class="line">stringData:</span><br><span class="line">  <span class="comment"># Human readable description. Optional.</span></span><br><span class="line">  description: <span class="string">&quot;The bootstrap token used by clusternet cluster registration.&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Token ID and secret. Required.</span></span><br><span class="line">  token<span class="literal">-id</span>: <span class="number">07401</span>b</span><br><span class="line">  token<span class="literal">-secret</span>: f395accd246ae52d</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Expiration. Optional.</span></span><br><span class="line">  expiration: <span class="number">2025</span><span class="literal">-05-10T03</span>:<span class="number">22</span>:<span class="number">11</span>Z</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Allowed usages.</span></span><br><span class="line">  usage<span class="literal">-bootstrap-authentication</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">  usage<span class="literal">-bootstrap-signing</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Extra groups to authenticate the token as. Must start with &quot;system:bootstrappers:&quot;</span></span><br><span class="line">  auth<span class="literal">-extra-groups</span>: system:bootstrappers:clusternet:<span class="built_in">register-cluster</span><span class="literal">-token</span></span><br></pre></td></tr></table></figure>

<p>在子集群执行如下命令，其中parentURL要修改为父集群的apiserver地址</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm repo add clusternet https://clusternet.github.io/charts</span><br><span class="line">helm install clusternet<span class="literal">-agent</span> <span class="literal">-n</span> clusternet<span class="literal">-system</span> <span class="literal">--create-namespace</span> \</span><br><span class="line">  <span class="literal">--set</span> parentURL=https://<span class="number">10.0</span>.<span class="number">248.96</span>:<span class="number">8443</span> \</span><br><span class="line">  <span class="literal">--set</span> registrationToken=<span class="number">07401</span>b.f395accd246ae52d \</span><br><span class="line">  clusternet/clusternet<span class="literal">-agent</span></span><br></pre></td></tr></table></figure>
<p>其中parentURL为父集群的apiserver地址，registrationToken为父集群注册的token信息。</p>
<h1 id="访问子集群"><a href="#访问子集群" class="headerlink" title="访问子集群"></a>访问子集群</h1><h2 id="kubectl-clusternet命令行方式访问"><a href="#kubectl-clusternet命令行方式访问" class="headerlink" title="kubectl-clusternet命令行方式访问"></a>kubectl-clusternet命令行方式访问</h2><p>安装kubectl krew插件，参考 <a target="_blank" rel="noopener" href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">https://krew.sigs.k8s.io/docs/user-guide/setup/install/</a>，执行如下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum install git <span class="literal">-y</span></span><br><span class="line">(</span><br><span class="line">  <span class="built_in">set</span> <span class="literal">-x</span>; <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$</span>(mktemp -d)&quot;</span> &amp;&amp;</span><br><span class="line">  OS=<span class="string">&quot;<span class="variable">$</span>(uname | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)&quot;</span> &amp;&amp;</span><br><span class="line">  ARCH=<span class="string">&quot;<span class="variable">$</span>(uname -m | sed -e &#x27;s/x86_64/amd64/&#x27; -e &#x27;s/\(arm\)\(64\)\?.*/\1\2/&#x27; -e &#x27;s/aarch64<span class="variable">$</span>/arm64/&#x27;)&quot;</span> &amp;&amp;</span><br><span class="line">  KREW=<span class="string">&quot;krew-<span class="variable">$</span>&#123;OS&#125;_<span class="variable">$</span>&#123;ARCH&#125;&quot;</span> &amp;&amp;</span><br><span class="line">  <span class="built_in">curl</span> <span class="literal">-fsSLO</span> <span class="string">&quot;https://github.com/kubernetes-sigs/krew/releases/latest/download/<span class="variable">$</span>&#123;KREW&#125;.tar.gz&quot;</span> &amp;&amp;</span><br><span class="line">  tar zxvf <span class="string">&quot;<span class="variable">$</span>&#123;KREW&#125;.tar.gz&quot;</span> &amp;&amp;</span><br><span class="line">  ./<span class="string">&quot;<span class="variable">$</span>&#123;KREW&#125;&quot;</span> install krew</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$&#123;PATH&#125;:$&#123;HOME&#125;/.krew/bin&quot;&#x27;</span> &gt;&gt;  ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>安装kubectl插件clusternet：kubectl krew install clusternet</p>
<p>使用kubectl clusternet get可以看到发布的应用，非发布的应用看不到。</p>
<h2 id="代码层面访问子集群"><a href="#代码层面访问子集群" class="headerlink" title="代码层面访问子集群"></a>代码层面访问子集群</h2><p>可以参照例子：<a target="_blank" rel="noopener" href="https://github.com/clusternet/clusternet/blob/main/examples/clientgo/demo.go#L42-L45">https://github.com/clusternet/clusternet/blob/main/examples/clientgo/demo.go#L42-L45</a></p>
<p>改动代码非常小，仅需要获取到对应集群的config信息即可。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">config, err := rest.InClusterConfig()</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		klog.Error(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// This is the ONLY place you need to wrap <span class="keyword">for</span> Clusternet</span><br><span class="line">	config.Wrap(func(rt http.RoundTripper) http.RoundTripper &#123;</span><br><span class="line">		<span class="keyword">return</span> clientgo.NewClusternetTransport(config.Host, rt)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	// now we could create and visit all the resources</span><br><span class="line">	client := kubernetes.NewForConfigOrDie(config)</span><br><span class="line">	_, err = client.CoreV1().Namespaces().Create(context.TODO(), &amp;corev1.Namespace&#123;</span><br><span class="line">		ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">			Name: <span class="string">&quot;demo&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;, metav1.CreateOptions&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="应用发布"><a href="#应用发布" class="headerlink" title="应用发布"></a>应用发布</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/clusternet3.png" alt="image.png"><br>在主集群提交如下的yaml文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps.clusternet.io/v1alpha1</span><br><span class="line">kind: Subscription</span><br><span class="line">metadata:</span><br><span class="line">  name: app<span class="literal">-demo</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  subscribers: <span class="comment"># defines the clusters to be distributed to</span></span><br><span class="line">    - clusterAffinity:</span><br><span class="line">        matchLabels:</span><br><span class="line">          clusters.clusternet.io/cluster<span class="literal">-id</span>: dc91021d<span class="literal">-2361-4f6d-a404-7c33b9e01118</span> <span class="comment"># PLEASE UPDATE THIS CLUSTER-ID TO YOURS!!!</span></span><br><span class="line">  feeds: <span class="comment"># defines all the resources to be deployed with</span></span><br><span class="line">    - apiVersion: apps.clusternet.io/v1alpha1</span><br><span class="line">      kind: HelmChart</span><br><span class="line">      name: mysql</span><br><span class="line">      namespace: default</span><br><span class="line">    - apiVersion: v1</span><br><span class="line">      kind: Namespace</span><br><span class="line">      name: foo</span><br><span class="line">    - apiVersion: apps/v1</span><br><span class="line">      kind: Service</span><br><span class="line">      name: my<span class="literal">-nginx-svc</span></span><br><span class="line">      namespace: foo</span><br><span class="line">    - apiVersion: apps/v1</span><br><span class="line">      kind: Deployment</span><br><span class="line">      name: my<span class="literal">-nginx</span></span><br><span class="line">      namespace: foo</span><br></pre></td></tr></table></figure>

<h1 id="实现分析"><a href="#实现分析" class="headerlink" title="实现分析"></a>实现分析</h1><p>在主集群实现了两个aggregated apiservice</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiregistration.k8s.io/v1</span><br><span class="line">kind: APIService</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    meta.helm.sh/release<span class="literal">-name</span>: clusternet<span class="literal">-hub</span></span><br><span class="line">    meta.helm.sh/release<span class="literal">-namespace</span>: clusternet<span class="literal">-system</span></span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: clusternet<span class="literal">-hub</span></span><br><span class="line">    app.kubernetes.io/managed<span class="literal">-by</span>: Helm</span><br><span class="line">    app.kubernetes.io/name: clusternet<span class="literal">-hub</span></span><br><span class="line">    helm.sh/chart: clusternet<span class="literal">-hub-0</span>.<span class="number">2.1</span></span><br><span class="line">  name: v1alpha1.proxies.clusternet.io</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">group</span>: proxies.clusternet.io</span><br><span class="line">  groupPriorityMinimum: <span class="number">1000</span></span><br><span class="line">  insecureSkipTLSVerify: true</span><br><span class="line">  service:</span><br><span class="line">    name: clusternet<span class="literal">-hub</span></span><br><span class="line">    namespace: clusternet<span class="literal">-system</span></span><br><span class="line">    port: <span class="number">443</span></span><br><span class="line">  version: v1alpha1</span><br><span class="line">  versionPriority: <span class="number">100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiregistration.k8s.io/v1</span><br><span class="line">kind: APIService</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    meta.helm.sh/release<span class="literal">-name</span>: clusternet<span class="literal">-hub</span></span><br><span class="line">    meta.helm.sh/release<span class="literal">-namespace</span>: clusternet<span class="literal">-system</span></span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/instance: clusternet<span class="literal">-hub</span></span><br><span class="line">    app.kubernetes.io/managed<span class="literal">-by</span>: Helm</span><br><span class="line">    app.kubernetes.io/name: clusternet<span class="literal">-hub</span></span><br><span class="line">    helm.sh/chart: clusternet<span class="literal">-hub-0</span>.<span class="number">2.1</span></span><br><span class="line">  name: v1alpha1.shadow</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">group</span>: shadow</span><br><span class="line">  groupPriorityMinimum: <span class="number">1</span></span><br><span class="line">  insecureSkipTLSVerify: true</span><br><span class="line">  service:</span><br><span class="line">    name: clusternet<span class="literal">-hub</span></span><br><span class="line">    namespace: clusternet<span class="literal">-system</span></span><br><span class="line">    port: <span class="number">443</span></span><br><span class="line">  version: v1alpha1</span><br><span class="line">  versionPriority: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BSgb2uoAuHbxQOUvn8fEsA">https://mp.weixin.qq.com/s/BSgb2uoAuHbxQOUvn8fEsA</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/create_test_k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/create_test_k8s/" class="post-title-link" itemprop="url">ecs的Linux主机上快速创建测试k8s集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-12-15 21:32:00" itemprop="dateCreated datePublished" datetime="2021-12-15T21:32:00+00:00">2021-12-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>经常有快速创建一个测试k8s集群的场景，为了能够快速完成，整理了如下的命令，即可在主机上快速启动一个k8s集群。部分命令需要外网访问，推荐直接使用海外的主机。</p>
<h1 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h1><p>下面命令可以安装最新版本的docker-ce</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">yum install vim git make -y</span><br></pre></td></tr></table></figure>
<h2 id="安装特定版本的docker"><a href="#安装特定版本的docker" class="headerlink" title="安装特定版本的docker"></a>安装特定版本的docker</h2><p>如果要安装特定版本的docker-ce，可以使用如下方法。</p>
<p>使用如下命令查询yum源中的docker-ce版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line">Last metadata expiration check: 0:00:27 ago on Sat 09 Apr 2022 12:39:09 AM CST.</span><br><span class="line">docker-ce.x86_64                3:20.10.9-3.el8                 docker-ce-stable</span><br><span class="line">docker-ce.x86_64                3:20.10.8-3.el8                 docker-ce-stable</span><br><span class="line">docker-ce.x86_64                3:20.10.7-3.el8                 docker-ce-stable</span><br><span class="line">docker-ce.x86_64                3:20.10.6-3.el8                 docker-ce-stable</span><br></pre></td></tr></table></figure>

<p>选择特定版本的docker-ce和docker-ce-cli，执行如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io</span><br></pre></td></tr></table></figure>


<h1 id="安装kubectl-kind-helm"><a href="#安装kubectl-kind-helm" class="headerlink" title="安装kubectl kind helm"></a>安装kubectl kind helm</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 安装kubectl</span><br><span class="line">curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span><br><span class="line">chmod +x kubectl</span><br><span class="line">mv kubectl /usr/bin/</span><br><span class="line"># 如果找不到rpm包，可以通过网络安全 rpm -ivh http://mirror.centos.org/centos/7/os/x86_64/Packages/bash-completion-2.1-8.el7.noarch.rpm</span><br><span class="line">yum install -y bash-completion</span><br><span class="line">echo -e &#x27;\n# kubectl&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;source &lt;(kubectl completion bash)&#x27; &gt;&gt;~/.bash_profile</span><br><span class="line">echo &#x27;alias k=kubectl&#x27; &gt;&gt;~/.bash_profile</span><br><span class="line">echo &#x27;complete -F __start_kubectl k&#x27; &gt;&gt;~/.bash_profile</span><br><span class="line">source ~/.bash_profile</span><br><span class="line"></span><br><span class="line"># 安装helm</span><br><span class="line">wget https://get.helm.sh/helm-v3.7.2-linux-amd64.tar.gz</span><br><span class="line">tar zvxf helm-v3.7.2-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/bin/</span><br><span class="line">rm -rf linux-amd64</span><br><span class="line"></span><br><span class="line"># 安装kubectx kubens</span><br><span class="line">git clone https://github.com/ahmetb/kubectx /tmp/kubectx</span><br><span class="line">cp /tmp/kubectx/kubens /usr/bin/kns</span><br><span class="line">cp /tmp/kubectx/kubectx /usr/bin/kctx</span><br><span class="line">wget https://github.com/junegunn/fzf/releases/download/0.29.0/fzf-0.29.0-linux_amd64.tar.gz -P /tmp</span><br><span class="line">tar zvxf /tmp/fzf-0.29.0-llinux_amd64.tar.gz -C /tmp/</span><br><span class="line">mv /tmp/fzf /usr/local/bin/</span><br><span class="line"></span><br><span class="line"># 安装kind</span><br><span class="line">curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.18.0/kind-linux-amd64</span><br><span class="line">chmod +x ./kind</span><br><span class="line">mv ./kind /usr/local/bin/</span><br><span class="line">echo -e &quot;\n# kind&quot; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;source &lt;(kind completion bash)&#x27; &gt;&gt;~/.bash_profile</span><br></pre></td></tr></table></figure>

<h1 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h1><p>其中将apiServerAddress指定为了本机，即创建出来的k8s集群仅允许本集群内访问。如果要是需要多个k8s集群之间的互访场景，由于kind拉起的k8s运行在docker容器中，而docker容器使用的是容器网络，此时如果设置apiserver地址为127.0.0.1，那么集群之间就没法直接通讯了，此时需要指定一个可以在docker容器中访问的宿主机ip地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">if=eth0</span><br><span class="line">ip=`ifconfig $if|grep inet|grep -v 127.0.0.1|grep -v inet6|awk &#x27;&#123;print $2&#125;&#x27;|tr -d &quot;addr:&quot;`</span><br><span class="line">cat &gt; kind.conf &lt;&lt;EOF</span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x-k8s.io/v1alpha4</span><br><span class="line">name: kind</span><br><span class="line">nodes:</span><br><span class="line">- role: control-plane</span><br><span class="line">  # 如果需要 ingress，则需要指定该参数</span><br><span class="line">  kubeadmConfigPatches:</span><br><span class="line">  - |</span><br><span class="line">    kind: InitConfiguration</span><br><span class="line">    nodeRegistration:</span><br><span class="line">      kubeletExtraArgs:</span><br><span class="line">        node-labels: &quot;ingress-ready=true&quot;</span><br><span class="line">  extraPortMappings:</span><br><span class="line">  - containerPort: 80</span><br><span class="line">    hostPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  - containerPort: 443</span><br><span class="line">    hostPort: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">  # 指定 k8s 版本，默认不指定</span><br><span class="line">  # image: kindest/node:v1.23.17</span><br><span class="line">- role: worker</span><br><span class="line">- role: worker</span><br><span class="line">- role: worker</span><br><span class="line">networking:</span><br><span class="line">  apiServerAddress: &quot;$ip&quot;</span><br><span class="line">  apiServerPort: 6443</span><br><span class="line">EOF</span><br><span class="line">kind create cluster --config kind.conf</span><br></pre></td></tr></table></figure>

<p>如果使用 nginx ingress，额外执行命令 <code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml</code></p>
<h1 id="其他周边工具"><a href="#其他周边工具" class="headerlink" title="其他周边工具"></a>其他周边工具</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装kustomize</span><br><span class="line">curl -s &quot;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&quot;  | bash</span><br><span class="line">mv kustomize /usr/local/bin/</span><br><span class="line"></span><br><span class="line"># 安装golang</span><br><span class="line">wget https://go.dev/dl/go1.17.5.linux-amd64.tar.gz -P /opt</span><br><span class="line">tar zvxf /opt/go1.17.5.linux-amd64.tar.gz -C /opt/</span><br><span class="line">mkdir /opt/gopath</span><br><span class="line">echo -e &#x27;\n# golang&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;export GOROOT=/opt/go&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;export GOPATH=/opt/gopath&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;export PATH=$PATH:$GOPATH/bin:$GOROOT/bin&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">source ~/.bash_profile</span><br><span class="line"></span><br><span class="line"># 安装controller-gen，会将controller-gen命令安装到GOPATH/bin目录下</span><br><span class="line">go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest</span><br><span class="line"></span><br><span class="line"># 安装dlv工具</span><br><span class="line">go install github.com/go-delve/delve/cmd/dlv@latest</span><br></pre></td></tr></table></figure>

<h2 id="安装krew"><a href="#安装krew" class="headerlink" title="安装krew"></a>安装krew</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">  set -x; cd &quot;$(mktemp -d)&quot; &amp;&amp;</span><br><span class="line">  OS=&quot;$(uname | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)&quot; &amp;&amp;</span><br><span class="line">  ARCH=&quot;$(uname -m | sed -e &#x27;s/x86_64/amd64/&#x27; -e &#x27;s/\(arm\)\(64\)\?.*/\1\2/&#x27; -e &#x27;s/aarch64$/arm64/&#x27;)&quot; &amp;&amp;</span><br><span class="line">  KREW=&quot;krew-$&#123;OS&#125;_$&#123;ARCH&#125;&quot; &amp;&amp;</span><br><span class="line">  curl -fsSLO &quot;https://github.com/kubernetes-sigs/krew/releases/latest/download/$&#123;KREW&#125;.tar.gz&quot; &amp;&amp;</span><br><span class="line">  tar zxvf &quot;$&#123;KREW&#125;.tar.gz&quot; &amp;&amp;</span><br><span class="line">  ./&quot;$&#123;KREW&#125;&quot; install krew</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">echo -e &#x27;\n# kubectl krew&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">echo &#x27;export PATH=&quot;$&#123;KREW_ROOT:-$HOME/.krew&#125;/bin:$PATH&quot;&#x27; &gt;&gt; ~/.bash_profile</span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/">kind</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/lvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/lvm/" class="post-title-link" itemprop="url">lvm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-28 02:13:14" itemprop="dateCreated datePublished" datetime="2021-11-28T02:13:14+00:00">2021-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/lvm.png"></p>
<ol>
<li>物理卷PV(Physical Volume)：可以是整块物理磁盘或者物理磁盘上的分区</li>
<li>卷组VG(Volume Group)：由一个或多个物理卷PV组成，可在卷组上创建一个或者多个LV，可以动态增加pv到卷组</li>
<li>逻辑卷LV(Logical Volume)：类似于磁盘分区，建立在VG之上，在LV上可以创建文件系统 逻辑卷建立后可以动态的增加或缩小空间</li>
<li>PE(Physical Extent): PV可被划分为PE的基本单元，具有唯一编号的PE是可以被LVM寻址的最小单元。PE的大小是可以配置的，默认为4MB。</li>
<li>LE(Logical Extent): LV可被划分为LE的基本单元，LE跟PE是一对一的关系。</li>
</ol>
<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><p>lvm相关的目录如果没有按照，在centos下使用<code>yum install lvm2</code>进行安装。</p>
<p>初始磁盘状态如下，&#x2F;dev&#x2F;sda上有40g磁盘空间未分配：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1        40G  2.8G   38G   7% /</span><br><span class="line">devtmpfs        236M     0  236M   0% /dev</span><br><span class="line">tmpfs           244M     0  244M   0% /dev/shm</span><br><span class="line">tmpfs           244M  4.5M  240M   2% /run</span><br><span class="line">tmpfs           244M     0  244M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs            49M     0   49M   0% /run/user/1000</span><br><span class="line"></span><br><span class="line"># fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 85.9 GB, 85899345920 bytes, 167772160 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000a05f8</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048    83886079    41942016   83  Linux</span><br></pre></td></tr></table></figure>

<p>对磁盘的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># fdisk /dev/sda</span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line"># 创建主分区2，空间为1g，磁盘格式为lvm</span><br><span class="line">Command (m for help): n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (1 primary, 0 extended, 3 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (2-4, default 2): 2</span><br><span class="line">First sector (83886080-167772159, default 83886080):</span><br><span class="line">Using default value 83886080</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (83886080-167772159, default 167772159): +1G</span><br><span class="line">Partition 2 of type Linux and of size 1 GiB is set</span><br><span class="line"></span><br><span class="line">Command (m for help): t</span><br><span class="line">Partition number (1,2, default 2): 2</span><br><span class="line">Hex code (type L to list all codes): 8e</span><br><span class="line">Changed type of partition &#x27;Linux&#x27; to &#x27;Linux LVM&#x27;</span><br><span class="line"></span><br><span class="line"># 创建主分区3，空间为5g，磁盘格式为lvm</span><br><span class="line">Command (m for help): n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (2 primary, 0 extended, 2 free)</span><br><span class="line">   e   extended</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (3,4, default 3): 3</span><br><span class="line">First sector (85983232-167772159, default 85983232):</span><br><span class="line">Using default value 85983232</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (85983232-167772159, default 167772159): +5G</span><br><span class="line">Partition 3 of type Linux and of size 5 GiB is set</span><br><span class="line"></span><br><span class="line">Command (m for help): t</span><br><span class="line">Partition number (1-3, default 3): 3</span><br><span class="line">Hex code (type L to list all codes): 8e</span><br><span class="line">Changed type of partition &#x27;Linux&#x27; to &#x27;Linux LVM&#x27;</span><br><span class="line"></span><br><span class="line"># 保存上述操作</span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line"></span><br><span class="line">WARNING: Re-reading the partition table failed with error 16: Device or resource busy.</span><br><span class="line">The kernel still uses the old table. The new table will be used at</span><br><span class="line">the next reboot or after you run partprobe(8) or kpartx(8)</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure>

<p>当前磁盘空间状态如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 85.9 GB, 85899345920 bytes, 167772160 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000a05f8</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048    83886079    41942016   83  Linux</span><br><span class="line">/dev/sda2        83886080    85983231     1048576   8e  Linux LVM</span><br><span class="line">/dev/sda3        85983232    96468991     5242880   8e  Linux LVM</span><br></pre></td></tr></table></figure>

<p>将上述两个lvm磁盘分区创建pv，使用<code>pvremove /dev/sda2</code>可以删除pv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># pvcreate /dev/sda2 /dev/sda3</span><br><span class="line">  Physical volume &quot;/dev/sda2&quot; successfully created.</span><br><span class="line">  Physical volume &quot;/dev/sda3&quot; successfully created.</span><br><span class="line">[root@localhost vagrant]# pvdisplay</span><br><span class="line">  &quot;/dev/sda2&quot; is a new physical volume of &quot;1.00 GiB&quot;</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/sda2</span><br><span class="line">  VG Name</span><br><span class="line">  PV Size               1.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0</span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               MgarF2-Ka6D-blDi-8ecd-1SEU-y2GD-JtiK2c</span><br><span class="line"></span><br><span class="line">  &quot;/dev/sda3&quot; is a new physical volume of &quot;5.00 GiB&quot;</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/sda3</span><br><span class="line">  VG Name</span><br><span class="line">  PV Size               5.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0</span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               ToKp2T-30mS-0P8c-ZrcB-2lO4-ayo9-62fuDx</span><br></pre></td></tr></table></figure>

<p>接下来创建vg，vg的名字可以随便定义，并将创建的两个pv都添加到vg中，可以看到vg的空间为两个pv之和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># vgcreate vg1 /dev/sda1</span><br><span class="line"># vgdisplay -v</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               vg1</span><br><span class="line">  System ID</span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        2</span><br><span class="line">  Metadata Sequence No  1</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                0</span><br><span class="line">  Open LV               0</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                2</span><br><span class="line">  Act PV                2</span><br><span class="line">  VG Size               5.99 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              1534</span><br><span class="line">  Alloc PE / Size       0 / 0</span><br><span class="line">  Free  PE / Size       1534 / 5.99 GiB</span><br><span class="line">  VG UUID               XI8Biv-JtUv-tsur-wuvm-IJQz-HLZu-6a2u5G</span><br><span class="line"></span><br><span class="line">  --- Physical volumes ---</span><br><span class="line">  PV Name               /dev/sda2</span><br><span class="line">  PV UUID               MgarF2-Ka6D-blDi-8ecd-1SEU-y2GD-JtiK2c</span><br><span class="line">  PV Status             allocatable</span><br><span class="line">  Total PE / Free PE    255 / 255</span><br><span class="line"></span><br><span class="line">  PV Name               /dev/sda3</span><br><span class="line">  PV UUID               ToKp2T-30mS-0P8c-ZrcB-2lO4-ayo9-62fuDx</span><br><span class="line">  PV Status             allocatable</span><br><span class="line">  Total PE / Free PE    1279 / 1279</span><br></pre></td></tr></table></figure>

<p>接下来创建lv，并从vg1中分配空间2g</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># lvcreate -L 2G -n lv1 vg1</span><br><span class="line">  Logical volume &quot;lv1&quot; created.</span><br><span class="line"></span><br><span class="line"># lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg1/lv1</span><br><span class="line">  LV Name                lv1</span><br><span class="line">  VG Name                vg1</span><br><span class="line">  LV UUID                EesY4i-lSqY-ef1R-599C-XTrZ-IcVL-P7W46Q</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time localhost.localdomain, 2019-06-16 07:29:38 +0000</span><br><span class="line">  LV Status              available</span><br><span class="line">  # open                 0</span><br><span class="line">  LV Size                2.00 GiB</span><br><span class="line">  Current LE             512</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     8192</span><br><span class="line">  Block device           253:0</span><br></pre></td></tr></table></figure>

<p>接下来给lv1格式化磁盘格式为ext4，并将磁盘挂载到&#x2F;tmp&#x2F;lvm目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># mkfs.ext4 /dev/vg1/lv1</span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS type: Linux</span><br><span class="line">Block size=4096 (log=2)</span><br><span class="line">Fragment size=4096 (log=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">131072 inodes, 524288 blocks</span><br><span class="line">26214 blocks (5.00%) reserved for the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=536870912</span><br><span class="line">16 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">	32768, 98304, 163840, 229376, 294912</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (16384 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line"># mkdir /tmp/lvm</span><br><span class="line">[root@localhost vagrant]# mount /dev/vg1/lv1 /tmp/lvm</span><br><span class="line">[root@localhost vagrant]# df -h</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1             40G  2.9G   38G   8% /</span><br><span class="line">devtmpfs             236M     0  236M   0% /dev</span><br><span class="line">tmpfs                244M     0  244M   0% /dev/shm</span><br><span class="line">tmpfs                244M  4.5M  240M   2% /run</span><br><span class="line">tmpfs                244M     0  244M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs                 49M     0   49M   0% /run/user/1000</span><br><span class="line">/dev/mapper/vg1-lv1  2.0G  6.0M  1.8G   1% /tmp/lvm</span><br></pre></td></tr></table></figure>

<p>接下来对lv的空间从2G扩展到3G，此时通过df查看分区空间大小仍然为2g，需要执行<code>resize2fs</code>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># lvextend -L +1G /dev/vg1/lv1</span><br><span class="line">  Size of logical volume vg1/lv1 changed from 2.00 GiB (512 extents) to 3.00 GiB (768 extents).</span><br><span class="line">  Logical volume vg1/lv1 successfully resized.</span><br><span class="line"></span><br><span class="line"># resize2fs /dev/vg1/lv1</span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem at /dev/vg1/lv1 is mounted on /tmp/lvm; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 1</span><br><span class="line">The filesystem on /dev/vg1/lv1 is now 786432 blocks long.</span><br><span class="line"></span><br><span class="line"># df -h</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1             40G  2.9G   38G   8% /</span><br><span class="line">devtmpfs             236M     0  236M   0% /dev</span><br><span class="line">tmpfs                244M     0  244M   0% /dev/shm</span><br><span class="line">tmpfs                244M  4.5M  240M   2% /run</span><br><span class="line">tmpfs                244M     0  244M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs                 49M     0   49M   0% /run/user/1000</span><br><span class="line">/dev/mapper/vg1-lv1  2.9G  6.0M  2.8G   1% /tmp/lvm</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>试验时操作失误，出现了先格式化磁盘，后发现pv找不到对应设备。vg删除不成功。</p>
<p>正常删除vg的方式，此时lv会自动消失</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vgreduce --removemissing vg1</span><br><span class="line">vgremove vg1</span><br></pre></td></tr></table></figure>

<p>lvremove操作执行的时候经常会出现提示“Logical volume xx contains a filesystem in use.”的情况，该问题一般是由于有其他进程在使用该文件系统导致的。网络上经常看到的是通过fuser或者lsof命令来查找使用方，但偶尔该命令会失效，尤其在本机上有容器的场景下。另外一个可行的办法是通过 <code>grep -nr &quot;/data&quot; /proc/*/mount</code> 命令，可以找到挂载该目录的所有进程，简单有效。</p>
<h1 id="三种Logic-Volume"><a href="#三种Logic-Volume" class="headerlink" title="三种Logic Volume"></a>三种Logic Volume</h1><p>LVM的机制可以类比于RAID，RAID一个核心的机制是性能和数据冗余，并提供了多种数据的冗余模块可供配置。lvm在性能和数据冗余方面支持如下三种Logic Volume: 线性逻辑卷、条带化逻辑卷和镜像逻辑卷。上述几种模式是在vg已经创建完成后创建lv的时候指定的模式，会影响到lv中的pe分配。</p>
<p>下面使用如下的机器配置来进行各个模式的介绍和功能测试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">vda    253:0    0   40G  0 disk</span><br><span class="line">└─vda1 253:1    0   40G  0 part /</span><br><span class="line">vdb    253:16   0  100G  0 disk</span><br><span class="line">vdc    253:32   0  200G  0 disk</span><br><span class="line">vdd    253:48   0  300G  0 disk</span><br><span class="line">vde    253:64   0  400G  0 disk</span><br></pre></td></tr></table></figure>

<h2 id="线性逻辑卷-Linear-Logic-Volume"><a href="#线性逻辑卷-Linear-Logic-Volume" class="headerlink" title="线性逻辑卷 Linear Logic Volume"></a>线性逻辑卷 Linear Logic Volume</h2><p>当一个VG中有两个或者多个磁盘的时候，LV分配磁盘容量的时候是按照VG中的PV安装顺序分配的，即一个PV用完后才会分配下一块PV。也可以在创建LV的通过指定PV中的PE段来将数据分散到多个PV上。该模式也是LVM的默认模式。</p>
<p>使用&#x2F;dev&#x2F;vdb和&#x2F;dev&#x2F;vdc两块磁盘来进行测试，先创建对应的PV。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ pvcreate /dev/vdb /dev/vdc</span><br><span class="line">  Physical volume &quot;/dev/vdb&quot; successfully created.</span><br><span class="line">  Physical volume &quot;/dev/vdc&quot; successfully created.</span><br><span class="line"></span><br><span class="line">$ pvdisplay</span><br><span class="line">  &quot;/dev/vdb&quot; is a new physical volume of &quot;100.00 GiB&quot;</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/vdb</span><br><span class="line">  VG Name               </span><br><span class="line">  PV Size               100.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0   </span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               8NnlYc-4f3f-fkeW-a3l3-LXoC-9UEH-fvpb5V</span><br><span class="line"></span><br><span class="line">  &quot;/dev/vdc&quot; is a new physical volume of &quot;200.00 GiB&quot;</span><br><span class="line">  --- NEW Physical volume ---</span><br><span class="line">  PV Name               /dev/vdc</span><br><span class="line">  VG Name               </span><br><span class="line">  PV Size               200.00 GiB</span><br><span class="line">  Allocatable           NO</span><br><span class="line">  PE Size               0   </span><br><span class="line">  Total PE              0</span><br><span class="line">  Free PE               0</span><br><span class="line">  Allocated PE          0</span><br><span class="line">  PV UUID               I9ffpN-c1vc-PQOB-yKyd-MdzO-Ngff-6e116t</span><br></pre></td></tr></table></figure>

<p>创建VG vg1，该容量为上面两个磁盘空间之和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ vgcreate vg1 /dev/vdb /dev/vdc</span><br><span class="line">  Volume group &quot;vg1&quot; successfully created</span><br><span class="line"></span><br><span class="line">$ vgdisplay</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               vg1</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        2</span><br><span class="line">  Metadata Sequence No  1</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                0</span><br><span class="line">  Open LV               0</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                2</span><br><span class="line">  Act PV                2</span><br><span class="line">  VG Size               299.99 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              76798</span><br><span class="line">  Alloc PE / Size       0 / 0   </span><br><span class="line">  Free  PE / Size       76798 / 299.99 GiB</span><br><span class="line">  VG UUID               Gi0bJx-jqY8-YpSo-kB0l-9wdk-ZfCT-GpgFZY</span><br></pre></td></tr></table></figure>

<p>从vg1中创建LV lv1，其大小为vg的全部大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ lvcreate --type linear -l 100%VG -n lv1 vg1</span><br><span class="line">  Logical volume &quot;lv1&quot; created.</span><br><span class="line"></span><br><span class="line">$ lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg1/lv1</span><br><span class="line">  LV Name                lv1</span><br><span class="line">  VG Name                vg1</span><br><span class="line">  LV UUID                JQZ193-dz6A-I0Ue-rTKC-6XrQ-gb1F-Qy9kDl</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time iZt4nd6wiprf8foracovwqZ, 2022-01-08 23:28:45 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  # open                 0</span><br><span class="line">  LV Size                299.99 GiB</span><br><span class="line">  Current LE             76798</span><br><span class="line">  Segments               2</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     256</span><br><span class="line">  Block device           252:0</span><br><span class="line"></span><br><span class="line">$ lvs -o lv_name,lv_attr,lv_size,seg_pe_ranges</span><br><span class="line">  LV   Attr       LSize   PE Ranges       </span><br><span class="line">  lv1  -wi-a----- 299.99g /dev/vdc:0-51198</span><br><span class="line">  lv1  -wi-a----- 299.99g /dev/vdb:0-25598</span><br></pre></td></tr></table></figure>

<h2 id="条带化逻辑卷-Striped-Logic-Volume"><a href="#条带化逻辑卷-Striped-Logic-Volume" class="headerlink" title="条带化逻辑卷 Striped Logic Volume"></a>条带化逻辑卷 Striped Logic Volume</h2><p>类似于raid0模式，在该模式下，多块磁盘均会分配PE给LV。可以通过-i参数来指定可以使用VG中多少个PV。</p>
<p>优点：将数据的读写压力分散到了多个磁盘，可以提升读写性能。<br>缺点：一个磁盘损坏后会导致数据丢失。</p>
<p>但在使用striped模式时，需要注意：</p>
<ol>
<li>如果PV来自于同一个磁盘的不同分区，会导致更多的随机读写，不仅不能提升磁盘性能，反而会导致性能下降。</li>
<li>如果VG中某一个PV过小，则无法将所有的PV平均使用起来，存在木桶效应。</li>
</ol>
<p>使用<code>--type striped</code>来指定为striped模式，<code>--stripes</code>来指定需要使用的pv数量，<code>--stripesize</code>指定写足够数量的数据后再更换为另外一个pv。在下面的创建命令中，可以看到创建出来了12800个LE，PE是平均分配到了两个pv上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ lvcreate --type striped --stripes 2 --stripesize 32k -L 50G -n lv1 vg1</span><br><span class="line">  Logical volume &quot;lv1&quot; created.</span><br><span class="line"></span><br><span class="line">$ lvs -o lv_name,lv_attr,lv_size,seg_pe_ranges                          </span><br><span class="line">  LV   Attr       LSize  PE Ranges                      </span><br><span class="line">  lv1  -wi-a----- 50.00g /dev/vdb:0-6399 /dev/vdc:0-6399</span><br><span class="line"></span><br><span class="line">$ lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/vg1/lv1</span><br><span class="line">  LV Name                lv1</span><br><span class="line">  VG Name                vg1</span><br><span class="line">  LV UUID                FnOmCM-IkuE-3Rvv-fQqk-Cv1Q-lb8S-l5X7O3</span><br><span class="line">  LV Write Access        read/write</span><br><span class="line">  LV Creation host, time iZt4nd6wiprf8foracovwqZ, 2022-01-09 00:07:08 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  # open                 0</span><br><span class="line">  LV Size                50.00 GiB</span><br><span class="line">  Current LE             12800</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently set to     256</span><br><span class="line">  Block device           252:0</span><br></pre></td></tr></table></figure>

<p>如果指定的lv大小为250G，由于分配到两块磁盘上，由于最小的磁盘只有100G，100G * 2无法满足250G的磁盘大小需求，此时会报错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvcreate --type striped --stripes 2 --stripesize 32k -L 250G -n lv1 vg1</span><br><span class="line">  Insufficient suitable allocatable extents for logical volume lv1: 12802 more required</span><br></pre></td></tr></table></figure>

<h2 id="镜像逻辑卷-Mirror-Logic-Volume"><a href="#镜像逻辑卷-Mirror-Logic-Volume" class="headerlink" title="镜像逻辑卷 Mirror Logic Volume"></a>镜像逻辑卷 Mirror Logic Volume</h2><p>类似于raid1。可以解决磁盘的单点问题，一块磁盘挂掉后不至于丢失数据。</p>
<p>通过使用<code>--type mirror</code>来指定为镜像模式，-m参数来指定冗余的数量。</p>
<h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><ul>
<li><a target="_blank" rel="noopener" href="https://linux.cn/article-3218-1.html">Linux LVM简明教程</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/572204">初识LVM及ECS上LVM分区扩容</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xibuhaohao/p/11731699.html">Linux LVM–三种Logic Volume</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/minto-pyramid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/minto-pyramid/" class="post-title-link" itemprop="url">《金字塔原理》总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-18 00:07:17" itemprop="dateCreated datePublished" datetime="2021-05-18T00:07:17+00:00">2021-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/jinzita.jpeg"></p>
<p>《金字塔原理》是一本教你如何清晰的思考问题，表达观点的畅销书籍，但其并非万能的，其层层架构建立在因果关系基础之上。但现实世界中的很多问题并非简单的因果关系，此时金字塔原理就用不上了。</p>
<h1 id="什么是金字塔原理"><a href="#什么是金字塔原理" class="headerlink" title="什么是金字塔原理"></a>什么是金字塔原理</h1><p>定义：任何一件事情都可以归纳出一个中心论点，而这个中心论点由3到7个论据进行支撑。每一个论据它本身又可以拆分成一个论点，该论点同样也可以拆分成3到7个论据，如此重复形状就像金字塔一样。</p>
<p>三个注意点：</p>
<ul>
<li>结论先行</li>
<li>每层结论下面的论据不要超过7个</li>
<li>每一个论点要言之有物，有明确的思想</li>
</ul>
<h1 id="组织思想的方法"><a href="#组织思想的方法" class="headerlink" title="组织思想的方法"></a>组织思想的方法</h1><p>在有了论点之后，论据该怎么拆分呢？可以按照下面四个原则来组织思想：</p>
<ul>
<li>时间顺序</li>
<li>空间顺序</li>
<li>重要性顺序，比如按照老弱优先原则</li>
<li>逻辑演绎顺序。所以的逻辑演绎，就是三大段：大前提、小前提和结论。比如，凡人皆有一死，苏格拉底是人，所以苏格拉底也会死。但不推荐用此方法，因为对于听众的要求比较高，必须能够集中注意力才能听明白。</li>
</ul>
<p>在思考的过程中，如果还没有论点，也可以使用上述方法先得出论据，然后推理出论点。<br>梳理出的论据必须符合MECE法则：每一个论点下的论据，都应该相互独立，但又可以完全穷尽，即论据要做到不遗漏不重叠。</p>
<h1 id="如何让别人对自己的观点感兴趣"><a href="#如何让别人对自己的观点感兴趣" class="headerlink" title="如何让别人对自己的观点感兴趣"></a>如何让别人对自己的观点感兴趣</h1><p>SCQ法则：Situation（设置背景）、Complication（冲突）和Question（疑问）。背景即先介绍大家都认同的背景信息从而引入话题。在SCQ都讲完后，就可以引入自己的论点了。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>得到 - 《金字塔原理》成甲解读</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/review-zhangyiming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/review-zhangyiming/" class="post-title-link" itemprop="url">演讲的思考系列文章 - 张一鸣字节跳动9周年</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-05 18:50:11" itemprop="dateCreated datePublished" datetime="2021-04-05T18:50:11+00:00">2021-04-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近因为《致阿里》的缘故，读了不少阿里内网的热帖，很多都是洋洋洒洒几千字，而且说的有理有据。如果换做是我，很多帖子哪怕我憋上一天都是写不出来的。我一直在思考，我到底比别人差在了哪里。思来想去，其中一个原因是因为平时的思考总结不够，缺少积累。</p>
<p>恰巧看了张一鸣在字节跳动9周年演讲，三观跟我特别合，想以贴为例，一来分享一下我个人的内心想法加深对演讲内容的认识，二来可以依次来锻炼自己的逻辑归纳能力。后续如有特别值得学习的演讲，也会分享一下自己的学习和思考，比如2020年张小龙的微信公开课的演讲就特别值得学习。</p>
<p>文中提到最多的词莫过于“平常心”了，“平常心”是一个佛源词，看来张一鸣没少研究佛学，整篇演讲显得也比较佛系，对于平常心的最直白的解释就是：</p>
<p>| 吃饭的时候好好吃饭，睡觉的时候好好睡觉</p>
<p>要想做到“好好吃饭，好好睡觉”对我来说是挺难的，我举一个简单的例子。平常周末来说，特别想睡一个懒觉，如果在睡觉前自己明确知道因为工作没有完成，第二天早上会有人找我，那么第二天早上一定会醒的比较早，想睡个懒觉都很难，即使第二天上午并不一定有人在我醒之前找到我。说明因为有事情的缘故，已经在无形中影响了睡眠质量。再举个例子，春节假期的睡眠质量明显会高于平常周末的睡眠质量，原因是心里总有各种工作的事情不能完全放下。如果将春节假期的心态为平常心，那么一年中的其他时间对我而言都不是平常心。</p>
<p>每家公司在年初的时候总会定义一些目标，比如全年营收目标为1个亿。一旦有了营收目标后，那么大家的工作重心一定会围绕的着目标展开。因为毕竟公司的资源是有限的，但是为了达成营收的目标，并不能保持一颗“平常心”来工作，焦虑的员工很难打磨出最好的产品，往往其他的地方就不会做的太好，比如用户体验、代码质量等等，一些本来很好的点子因为有营收目标的缘故，也很难展开实施，从而导致一些创新项目的流失。</p>
<p>接下来就是一些平常心的工作原则，总结下来有如下几点：</p>
<ul>
<li>平常心对待自己，平常人做非常事</li>
<li>平常心对待预期，没有预期和标签的束缚会发挥的更好</li>
<li>平常心对待过去和未来，关注当下</li>
<li>平常心对待竞争对手</li>
<li>平常心对待业务</li>
<li>平常心对待成功和失败</li>
</ul>
<p>文中特意提到了互联网八股文的一段话，这里就不再摘出来，我平时也没少见到类似的话术，看完后的感觉就是真牛逼，打死我都写不出来，但转头就忘记讲啥了，也许就是当时压根就看不懂，因为这些话太抽象了。互联网行业本身是一个特别务实接地气的行业，现在也渐渐在内卷严重，抽象的词汇也越来越多，期望下一个风口的到来，或许会将这股邪气吹走一些。</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/eDn4rcdB7to-sD9N-NGySw">张一鸣演讲全文：外部波澜起伏，内心平静如常</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/golang-error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/golang-error/" class="post-title-link" itemprop="url">Golang中的异常处理机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-17 00:24:44" itemprop="dateCreated datePublished" datetime="2021-03-17T00:24:44+00:00">2021-03-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-24 14:38:47" itemprop="dateModified" datetime="2024-02-24T14:38:47+00:00">2024-02-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>异常处理分为error和defer和recover两类，其中error用来处理可预期的异常，recover用来处理意外的异常。</p>
<h2 id="error"><a href="#error" class="headerlink" title="error"></a>error</h2><p>支持多个返回值，可以将业务的返回值和错误的返回值分开，很多都会返回两个值。如果不使用error返回值，可以用_变量来忽略。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parseConfig returns a parsed configuration for an Azure cloudprovider config file</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseConfig</span><span class="params">(configReader io.Reader)</span></span> (*Config, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> config Config</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> configReader == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;config, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	configContents, err := ioutil.ReadAll(configReader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	err = yaml.Unmarshal(configContents, &amp;config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The resource group name may be in different cases from different Azure APIs, hence it is converted to lower here.</span></span><br><span class="line">	<span class="comment">// See more context at https://github.com/kubernetes/kubernetes/issues/71994.</span></span><br><span class="line">	config.ResourceGroup = strings.ToLower(config.ResourceGroup)</span><br><span class="line">	<span class="keyword">return</span> &amp;config, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br />error的几种使用方式：</p>
<table>
<thead>
<tr>
<th>使用error的方式</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>errors.New</td>
<td>简单静态字符串的错误，没有额外的信息</td>
<td>errors.New(“shell not specified”)</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://golang.org/pkg/fmt/#Errorf">fmt.Errorf</a></td>
<td>用于格式化的错误字符串</td>
<td>fmt.Errorf(“failed to start kubernetes.io&#x2F;kube-apiserver-client-kubelet certificate controller: %v”, err)</td>
</tr>
<tr>
<td>实现Error()方法的自定义类型</td>
<td>客户段需要检测并处理该错误时使用该方式</td>
<td>见下文自定义error</td>
</tr>
<tr>
<td>Error wrapping</td>
<td>Go 1.13支持的特性</td>
<td></td>
</tr>
</tbody></table>
<h3 id="errors-New"><a href="#errors-New" class="headerlink" title="errors.New"></a>errors.New</h3><p>原则：</p>
<ul>
<li>不要在客户端判断error中的包含字符串信息。</li>
</ul>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> errors.New(<span class="string">&quot;could not open&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">use</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err := foo.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err.Error() == <span class="string">&quot;could not open&quot;</span> &#123;</span><br><span class="line">      <span class="comment">// handle</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">panic</span>(<span class="string">&quot;unknown error&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ErrCouldNotOpen = errors.New(<span class="string">&quot;could not open&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Open</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ErrCouldNotOpen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := foo.Open(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> errors.Is(err, foo.ErrCouldNotOpen) &#123;</span><br><span class="line">    <span class="comment">// handle</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;unknown error&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td></tr>
</tbody></table>


<p>当然也可以使用自定义error类型，但此时由于要实现自定义error类型，代码量会增加。</p>
<h3 id="自定义error"><a href="#自定义error" class="headerlink" title="自定义error"></a>自定义error</h3><p>error是个接口，可以用来扩展自定义的错误处理。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: k8s.io/kubernetes/pkg/volume/util/nestedpendingoperations/nestedpendingoperations.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewAlreadyExistsError returns a new instance of AlreadyExists error.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAlreadyExistsError</span><span class="params">(operationName <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> alreadyExistsError&#123;operationName&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IsAlreadyExists returns true if an error returned from</span></span><br><span class="line"><span class="comment">// NestedPendingOperations indicates a new operation can not be started because</span></span><br><span class="line"><span class="comment">// an operation with the same operation name is already executing.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsAlreadyExists</span><span class="params">(err <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> err.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> alreadyExistsError:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> alreadyExistsError <span class="keyword">struct</span> &#123;</span><br><span class="line">	operationName <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ <span class="type">error</span> = alreadyExistsError&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(err alreadyExistsError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(</span><br><span class="line">		<span class="string">&quot;Failed to create operation with name %q. An operation with that name is already executing.&quot;</span>,</span><br><span class="line">		err.operationName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以延伸出更复杂一些的树形error体系：<br /></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package net</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Error <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="type">error</span></span><br><span class="line">    Timeout() <span class="type">bool</span>   <span class="comment">// Is the error a timeout?</span></span><br><span class="line">    Temporary() <span class="type">bool</span> <span class="comment">// Is the error temporary?</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UnknownNetworkError <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e UnknownNetworkError)</span></span> Error() <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e UnknownNetworkError)</span></span> Temporary() <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e UnknownNetworkError)</span></span> Timeout() <span class="type">bool</span></span><br></pre></td></tr></table></figure>

<h3 id="Error-Wrapping"><a href="#Error-Wrapping" class="headerlink" title="Error Wrapping"></a>Error Wrapping</h3><p>error类型仅包含一个字符串类型的信息，如果函数的调用栈信息为A -&gt; B -&gt; C，如果函数C返回err，在函数A处打印err信息，那么很难判断出err的真正出错位置，不利于快速定位问题。我们期望的效果是在函数A出打印err，能够精确的找到err的源头。<br /><br><br />为了解决上述问题，需要error类型在函数调用栈之间传递，有如下解决方法：</p>
<ul>
<li>使用fmt.Errorf()函数来增加额外的信息</li>
<li>使用Error Wrapping  <ul>
<li>golang 1.13支持%w</li>
<li><a target="_blank" rel="noopener" href="https://github.com/pkg/errors">https://github.com/pkg/errors</a></li>
</ul>
</li>
</ul>
<p><br />使用fmt.Errorf()来封装error信息，基于已经存在的error再产生一个新的error类型，需要避免error中包含冗余信息。<br /></p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// err: failed to call api: connection refused</span></span><br><span class="line">s, err := store.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="string">&quot;failed to create new store: %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// err: call api: connection refused</span></span><br><span class="line">s, err := store.New()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="string">&quot;new store: %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<tr><td>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">failed to create new store: failed to call api: connection refused</span><br><span class="line">error中会有很多的冗余信息</span><br></pre></td></tr></table></figure>
</td><td>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new store: call api: connection refused</span><br><span class="line">error中没有冗余信息，同时包含了调用栈信息</span><br></pre></td></tr></table></figure>
</td></tr>
</tbody></table>

<p>但使用fmt.Errorf()来全新封装的error信息的缺点也非常明显，丢失了最初的err信息，已经在中间转换为了全新的err。</p>
<h2 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h2><p>类型转换如果类型不正确，会导致程序crash，必须使用类型判断来判断类型的正确性。<br /></p>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t := i.(<span class="type">string</span>)</span><br></pre></td></tr></table></figure>
</td><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t, ok := i.(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">  <span class="comment">// handle the error gracefully</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td></tr>
</tbody></table>

<h2 id="panic"><a href="#panic" class="headerlink" title="panic"></a>panic</h2><p>用于处理运行时的异常情况。<br /><img src="https://intranetproxy.alipay.com/skylark/lark/0/2021/png/220839/1615386682235-b67733ca-036d-40d3-a895-c6b65a58f9d3.png#align=left&display=inline&height=563&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1060&originWidth=887&size=418096&status=done&style=none&width=471" alt="image.png"><br />使用原则</p>
<ul>
<li>不要使用panic，在kubernetes项目中几乎没有使用panic的场景</li>
<li>即使使用panic后，一定要使用recover会捕获异常</li>
<li>在测试用例中可以使用panic</li>
</ul>
<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(args []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;an argument is required&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  run(os.Args[<span class="number">1</span>:])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td><td>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">(args []<span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;an argument is required&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> err := run(os.Args[<span class="number">1</span>:]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Fprintln(os.Stderr, err)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</td></tr>
</tbody></table>

<h2 id="client-go"><a href="#client-go" class="headerlink" title="client-go"></a>client-go</h2><p>client-go利用队列来进行重试<br /><br><br /><a target="_blank" rel="noopener" href="https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go#L93">https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go#L93</a></p>
<h2 id="kube-builder"><a href="#kube-builder" class="headerlink" title="kube-builder"></a>kube-builder</h2><p>kube-builder为client-go的更上次封装，本质上跟client-go利用队列来进行重试的机制完全一致。</p>
<h1 id="发生了错误后该如何处理"><a href="#发生了错误后该如何处理" class="headerlink" title="发生了错误后该如何处理"></a>发生了错误后该如何处理</h1><ul>
<li>打印错误日志</li>
<li>根据业务场景选择忽略或者自动重试</li>
<li>程序自己crash</li>
</ul>
<h1 id="如何避免"><a href="#如何避免" class="headerlink" title="如何避免"></a>如何避免</h1><ul>
<li>在编写代码时增加防御式编程意识，不能靠契约式编程。一个比较简单的判断错误处理情况的方法，看下代码中if语句占用的比例。<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/kubelet_volumes.go">https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/kubelet_volumes.go</a></li>
<li>需求的评估周期中，不仅要考虑到软件开发完成的时间，同时要考虑到单元测试（单元测试用例的编写需要较长的时间）和集成测试的时间</li>
<li>单元测试覆盖率提升，测试场景要考虑到各种异常场景</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"preferred_color_scheme","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
