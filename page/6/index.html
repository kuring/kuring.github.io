<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/6/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">244</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/nandubeigui/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/nandubeigui/" class="post-title-link" itemprop="url">《南渡北归》读后感</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-01 00:48:29" itemprop="dateCreated datePublished" datetime="2022-03-01T00:48:29+00:00">2022-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>自己断断续续花了几个月的时间，终于将《南渡北归》读完了。当我知道这本书的时候，迅速被这本书的内容给吸引住了。早高峰上班的地铁上基本全部花在了该书上，晚上躺在床上后临睡前也在刷该书，困的睁不开眼的时候再倒头就睡。</p>
<p>中学的历史课本上，在讲解中国近现代史的时候实际上带有了比较浓厚的党的特色，过分的强调了自我，而对于当时的国民政府的描述相对较少。受限于篇幅的限制，历史课本对于历史人物提的也比较少一些。知识分子在中国历史上乘井喷状爆发的有两个阶段春秋时期和民国时期，本书以民国时期我们耳熟能详的知识分子们为主角，比如胡适、陈寅恪、梅贻琦、闻一多，讲解了大师们在乱世中颠沛流离的经历，以及错综复杂的人物关系。</p>
<p>《南渡北归》实际分为了《南渡》、《北归》和《离别》三部曲，全书100多万字，四大名著字数最多的《水浒传》也不过才96万字，本书可以算得上一步巨著了。之所以有那么多字数，其中有一部分篇幅是大师们的一些书信资料，真正属于作者的有效字数应该跟《水浒传》不相上下。</p>
<p>《南渡》主要讲解了卢沟桥事变抗日战争爆发后，北平各学府的师生们纷纷南下，先是辗转到长沙成立了长沙临时联合大学。但不久长沙沦陷，又分几路辗转到云南昆明组建西南联合大学，像李政道、杨振宁在这里完成了部分学业。但在昆明好景不长，时常有敌机轰炸，师生们天天”跑警报“。后一部分又逃亡了四川宜宾长江边上的李庄镇，很多大师们在李庄镇度过了非常难忘的一段回忆。比如林徽因、梁思永，很多时候都是在病床上度过，又受限于当地的环境，无药可医。</p>
<p>《北归》发生在了抗日战争结束，国民政府开始组织知识分子纷纷回到北平的旧时学府，回到一别多年的故乡。可是好景不长，国共内战爆发，北平沦陷。紧接着一大批的知识分子们又开始了新一轮的逃亡，很大一部分逃亡了台湾岛，另外一部分留在了大陆。这一不同的选择，直接决定了不同的人生命运。</p>
<p>《离别》是读起来最为伤感的一部，大师们纷纷陨落。逃亡台湾的如傅斯年、胡适、梅贻琦等虽然过得并不富裕，谈不上悲惨，但也算在台湾开辟了一番事业，名扬千古。但逃亡台湾的知识分子，在大陆却成了千古罪人。如大陆掀起了一股非常大的反胡热潮，以至于连胡适的儿子胡思杜都登报公开批判远在海峡对岸的父亲。可惜的是，思想觉悟足够高的儿子仍然在被批斗至自杀身亡。留在大陆的知识分子的命运却大相径庭，政治觉悟高者如郭沫若风生水起。但大部分的知识分子在”三反“、”文革“运动中都遭到了残酷的迫害，被红卫兵逼迫自杀者也不在少数。当年的红卫兵如今也就其八十岁的样子，我特别想采访一番当时他们是在什么情况下怀着怎样的心情什么动力来做出如此伤天害理之事，而且自己还理直气壮。</p>
<p>寒门难出贵子。民国时期但凡叫上名字的大师们大都出生在名门望族，而且往往一家不止出一位大师级人物，甚至有很多家族是世交。随便举几个例子，如周树人、周作人兄弟，虽然后来两兄弟完全走上了不同的人生道路。曾国藩的后人至少五代以内都有各种英才，如在民国时期活跃的曾宝荪、曾约农、曾昭燏、曾昭抡等。梁启超的两个儿子梁思成和梁思永兄弟，分别在建筑学和考古学方向有非常高的建树。不过也正是因为出生在名门望族，因为家庭出身的问题，也往往在后来的迫害中是最惨烈的。 </p>
<p>傅斯年在书中简直被作者推崇之至，甚至可以说是崇拜。关于傅斯年，作者描绘最多的字眼是胖子、高血压蹭蹭往上窜、活跃于政学两界、学术大鳄、气场强大、胡适的打手、思维清晰、擅长处理棘手问题。傅斯年毕业于大学，曾经领导过五四运动，出国留学后曾经担任了多年的史语所所长一职，也曾代理过北京大学校长一职。国共内战爆发后，随史语所一起逃亡台湾，在台湾期间，担任台湾大学校长，1950年突发脑淤血去世，后葬于台湾大学的”傅园“内为后世铭记。</p>
<p>另外一个对外印象比较深刻的人物是陈寅恪。清末著名诗人陈三立之子，同梁启超、王国维、赵元任并称为”清华国学四大导师“。国共内战北平失手后，陈寅恪从北京辗转逃亡岭南大学，后岭南大学跟中山大学合并，任教于中山大学。书中罗列了陈寅恪的多首诗，诗文引经据典，读起来相当晦涩，没点文化底蕴根本无法领会其中奥妙，可见大师功底之深。晚年在双目失明的情况下，完成了80多万字的巨著《柳如是别传》，非常人能所及。</p>
<p>本书描述的这段历史，实际上也就发生了一百年的时间，但却有非常多的历史是无法考证的。读史书其实想了解一个真实的历史，但本书的作者却带有了比较浓厚的个人感情色彩，比如对傅斯年推崇之至，对闻一多的评价却非常差。另外，作者有一丝错误的政治倾向，此书能够在大陆出版也算是一个奇迹了。读此书本着了解历史真相的态度，但却不可全信。</p>
<p>民国时期的知识分子大都有记录日志的好习惯，日记确实是一种非常好的自我反省和自我成长的好方式，可惜这么好的成长方式在现代的社会中却在逐渐消失，更多的会出现在小学生的课后作业中。另一方面，日记作为了非常好的一种史学参考资料，日记不会说谎，是作者的最真实的内心流露。过去发生的事情可以被人遗忘，但文字永存。由于没有长途电话这么高科技的产品，朋友之间的往来很多都是以书信的形式，如林徽因跟美国好友费慰梅就有大量的书信往来，这些书信也成为了非常好的史学资料。书信在当代早已成为了过去时，取而代之的是更为便捷的聊天app，无论身处何地对方永远在线，想聊天几乎没有了任何代价。</p>
<p>如果你有时间，此书值得一读。另外，再推荐一个关于昆明西南联合大学的纪录片《九零后》，针对超过16位超过90岁高龄的专家学者的口述，有助于了解当时那段历史。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/karmada/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/karmada/" class="post-title-link" itemprop="url">k8s多集群管理方案 - karmada</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 20:16:25" itemprop="dateCreated datePublished" datetime="2022-02-22T20:16:25+00:00">2022-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>华为云开源的多云容器编排项目，目前为CNCF沙箱项目。Karmada是基于<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/kubernetes-sigs/kubefed">kubefed v2</a>进行修改的一个项目，因此里面很多概念都是取自kubefed v2。</p>
<p>Karmada相对于kubefed v2的最大优点：<strong>完全兼容k8s的API</strong>。karmada提供了一个一套独立的karmada-apiserver，跟kube-apiserver是兼容的，使用方在调用的时候只需要访问karmada-apiserver就可以了。</p>
<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karmada-arch.png"><br>有三个组件构建：</p>
<ul>
<li>karmada api server，用来给其他的组件提供rest api</li>
<li>karmada controller manager</li>
<li>karmada scheduler</li>
</ul>
<p>karmada会新建一个ETCD，用来存储karmada的API对象。</p>
<p>karmada controller manager内部包含了多个controller的功能，会通过karmada apiserver来watch karmada对象，并通过调用各个子集群的apiserver来创建标准的k8s对象，包含了如下的controller对象：</p>
<ol>
<li>Cluster Controller：用来管理子集群的声明周期</li>
<li>Policy Controller：监听PropagationPolicy对象，通过resourceSelector找到匹配中的资源，并创建ResourceBinding对象。</li>
<li>Binding Controller：监听ResourceBinding对象，并创建每个集群的Work对象。</li>
<li>Execution Controller：监听Work对象，一旦Work对象场景后，会在子集群中创建Work关联的k8s对象。</li>
</ol>
<h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><h2 id="karmada-aggregated-apiserver"><a href="#karmada-aggregated-apiserver" class="headerlink" title="karmada-aggregated-apiserver"></a>karmada-aggregated-apiserver</h2><p>在karmada-apiserver上注册的api信息</p>
<h2 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h2><p>用来存放karmada的元数据信息</p>
<h1 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h1><h2 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h2><p>需要使用kamada-apiserver来查询</p>
<details>
<summary>unfold me to see the yaml</summary>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cluster.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">karmada.io/cluster-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">member1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">apiEndpoint:</span> <span class="string">https://172.18.0.3:6443</span></span><br><span class="line">  <span class="attr">impersonatorSecretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">member1-impersonator</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-cluster</span></span><br><span class="line">  <span class="attr">secretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">member1</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-cluster</span></span><br><span class="line">  <span class="attr">syncMode:</span> <span class="string">Push</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">	<span class="comment"># 支持的api列表</span></span><br><span class="line">  <span class="attr">apiEnablements:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">MutatingWebhookConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mutatingwebhookconfigurations</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">validatingwebhookconfigurations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">customresourcedefinitions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">apiservices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ControllerRevision</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">controllerrevisions</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">daemonsets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">deployments</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">authentication.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">TokenReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">tokenreviews</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">LocalSubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">localsubjectaccessreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SelfSubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">selfsubjectaccessreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SelfSubjectRulesReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">selfsubjectrulesreviews</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">SubjectAccessReview</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">subjectaccessreviews</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">batch/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cronjobs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">jobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">certificates.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CertificateSigningRequest</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">certificatesigningrequests</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">coordination.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Lease</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">leases</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">discovery.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpointslices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">discovery.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpointslices</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">events.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">events.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">flowcontrol.apiserver.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">FlowSchema</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">flowschemas</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PriorityLevelConfiguration</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">prioritylevelconfigurations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">IngressClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingressclasses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">runtimeclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">node.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">runtimeclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">policy/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodSecurityPolicy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">podsecuritypolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">clusterrolebindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">clusterroles</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rolebindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">roles</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">priorityclasses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSIDriver</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csidrivers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSINode</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csinodes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">storageclasses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">VolumeAttachment</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">volumeattachments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">storage.k8s.io/v1beta1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">CSIStorageCapacity</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">csistoragecapacities</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Binding</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">bindings</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ComponentStatus</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">componentstatuses</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Event</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">events</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">limitranges</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nodes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">persistentvolumes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">pods</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">PodTemplate</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">podtemplates</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">replicationcontrollers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">resourcequotas</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">serviceaccounts</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-02-21T08:27:56Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">cluster</span> <span class="string">is</span> <span class="string">healthy</span> <span class="string">and</span> <span class="string">ready</span> <span class="string">to</span> <span class="string">accept</span> <span class="string">workloads</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ClusterReady</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">kubernetesVersion:</span> <span class="string">v1.22.0</span></span><br><span class="line">  <span class="attr">nodeSummary:</span></span><br><span class="line">    <span class="attr">readyNum:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">totalNum:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">resourceSummary:</span></span><br><span class="line">    <span class="attr">allocatable:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">      <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">      <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">      <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">32192720Ki</span></span><br><span class="line">      <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">    <span class="attr">allocated:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">950m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">290Mi</span></span><br><span class="line">      <span class="attr">pods:</span> <span class="string">&quot;9&quot;</span></span><br></pre></td></tr></table></figure>
</details>

<h2 id="PropagationPolicy"><a href="#PropagationPolicy" class="headerlink" title="PropagationPolicy"></a>PropagationPolicy</h2><p>应用发布策略</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: policy.karmada.io/v1alpha1</span><br><span class="line">kind: PropagationPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-propagation</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  placement:</span><br><span class="line">    clusterAffinity:</span><br><span class="line">      clusterNames:</span><br><span class="line">      - member1</span><br><span class="line">      - member2</span><br><span class="line">    replicaScheduling:</span><br><span class="line">      replicaDivisionPreference: Weighted·</span><br><span class="line">      replicaSchedulingType: Divided</span><br><span class="line">      weightPreference:</span><br><span class="line">        staticWeightList:</span><br><span class="line">        - targetCluster:</span><br><span class="line">            clusterNames:</span><br><span class="line">            - member1</span><br><span class="line">          weight: <span class="number">1</span></span><br><span class="line">        - targetCluster:</span><br><span class="line">            clusterNames:</span><br><span class="line">            - member2</span><br><span class="line">          weight: <span class="number">1</span></span><br><span class="line">  resourceSelectors:</span><br><span class="line">  - apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx</span><br><span class="line">    namespace: default</span><br></pre></td></tr></table></figure>
<h2 id="ClusterPropagationPolicy"><a href="#ClusterPropagationPolicy" class="headerlink" title="ClusterPropagationPolicy"></a>ClusterPropagationPolicy</h2><p>用来定义Cluster级别资源的发布策略</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterPropagationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">serviceexport-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resourceSelectors:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">serviceexports.multicluster.x-k8s.io</span></span><br><span class="line">  <span class="attr">placement:</span></span><br><span class="line">    <span class="attr">clusterAffinity:</span></span><br><span class="line">      <span class="attr">clusterNames:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">member2</span></span><br></pre></td></tr></table></figure>
<h2 id="OverridePolicy"><a href="#OverridePolicy" class="headerlink" title="OverridePolicy"></a>OverridePolicy</h2><p>用于修改不同集群内的对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy.karmada.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">OverridePolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">overriders:</span></span><br><span class="line">    <span class="attr">commandOverrider:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerName:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">remove</span></span><br><span class="line">        <span class="attr">value:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--parameter1=foo</span></span><br></pre></td></tr></table></figure>

<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>karmada提供了三种安装方式：</p>
<ul>
<li>kubectl karmada插件的方式安装，较新的特性，v1.0版本才会提供，当前最新版本为v0.10.1</li>
<li>helm chart方式安装</li>
<li>使用源码安装</li>
</ul>
<h2 id="安装kubectl插件"><a href="#安装kubectl插件" class="headerlink" title="安装kubectl插件"></a>安装kubectl插件</h2><p>karmada提供了一个cli的工具，可以是单独的二进制工具kubectl-karmada，也可以是kubectl的插件karmada，本文以kubectl插件的方式进行安装。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl krew install karmada</span><br></pre></td></tr></table></figure>
<p>接下来就可以执行 kubectl karmada命令了。</p>
<h2 id="helm-chart的方式安装"><a href="#helm-chart的方式安装" class="headerlink" title="helm chart的方式安装"></a>helm chart的方式安装</h2><p>使用kind插件一个k8s集群 host，此处步骤略<br>​</p>
<p>在源码目录下执行如下的命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install karmada <span class="literal">-n</span> karmada<span class="literal">-system</span> <span class="literal">--create-namespace</span> ./charts</span><br></pre></td></tr></table></figure>
<p>会在karmada-system下部署如下管控的组件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl get deployments <span class="literal">-n</span> karmada<span class="literal">-system</span></span><br><span class="line">NAME                              READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">karmada<span class="literal">-apiserver</span>                 <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-controller-manager</span>        <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-kube-controller-manager</span>   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-scheduler</span>                 <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line">karmada<span class="literal">-webhook</span>                   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">83</span>s</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> kubectl get statefulsets <span class="literal">-n</span> karmada<span class="literal">-system</span></span><br><span class="line">NAME   READY   AGE</span><br><span class="line">etcd   <span class="number">1</span>/<span class="number">1</span>     <span class="number">2</span>m1s</span><br></pre></td></tr></table></figure>

<h2 id="从源码安装一个本地测试集群"><a href="#从源码安装一个本地测试集群" class="headerlink" title="从源码安装一个本地测试集群"></a>从源码安装一个本地测试集群</h2><p>本方式仅用于本地测试，会自动使用kind拉起测试的k8s集群，包括了一个host集群和3个member集群。</p>
<p>执行如下命令，会执行如下的任务：</p>
<ol>
<li>使用kind启动一个新的k8s集群host</li>
<li>构建karmada的控制平面，并部署控制平面到host集群</li>
<li>创建3个member集群并加入到karmada中<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/karmada<span class="literal">-io</span>/karmada</span><br><span class="line"><span class="built_in">cd</span> karmada</span><br><span class="line">hack/local<span class="literal">-up-karmada</span>.sh</span><br></pre></td></tr></table></figure>
local-up-karmada.sh有两个细节问题值得关注。<br>kind创建出来的集群名一定带有“kind-”的前缀，该脚本中为了去掉“kind-”前缀，使用了kubectl config rename-context 命令来rename context。<a target="_blank" rel="noopener" href="https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L375">https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L375</a><br>另外，使用kind创建出来的集群，context中的apiserver地址为类似<a target="_blank" rel="noopener" href="https://127.0.0.1:45195/">https://127.0.0.1:45195</a>这样的本地随机端口，只能在宿主机网络中访问。如果要想在两个k8s集群之间访问是不可行的。脚本中使用kubectl config set-cluster 命令将集群apiserver的地址替换为了docker网段的ip地址，以便于多个k8s集群之间的互访。<a target="_blank" rel="noopener" href="https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L389">https://github.com/karmada-io/karmada/blob/master/hack/util.sh#L389</a><br>​</li>
</ol>
<p>可以看到创建了如下的4个k8s cluster</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kind get clusters</span><br><span class="line">karmada<span class="literal">-host</span></span><br><span class="line">member1</span><br><span class="line">member2</span><br><span class="line">member3</span><br></pre></td></tr></table></figure>

<p>但这四个集群会分为两个kubeconfig文件 ~&#x2F;.kube&#x2F;karmada.config 和 ~&#x2F;.kube&#x2F;members.config。karmada又分为了两个context karmada-apiserver和karmada-host，两者连接同一个k8s集群。karmada-apiserver为跟karmada控制平台交互使用的context，为容器中的karmada-apiserver。karmada-host连接容器的kube-apiserver。<br>​</p>
<p>如果要连接host集群设置环境变量：export KUBECONFIG&#x3D;”$HOME&#x2F;.kube&#x2F;karmada.config”<br>如果要连接member集群设置环境变量：export KUBECONFIG&#x3D;”$HOME&#x2F;.kube&#x2F;members.config”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">export</span> <span class="string">KUBECONFIG=&quot;$HOME/.kube/karmada.config&quot;</span></span><br><span class="line"><span class="comment"># 切换到karmada-host</span></span><br><span class="line"><span class="string">$</span> <span class="string">kctx</span> <span class="string">karmada-host</span></span><br><span class="line"><span class="comment"># 可以看到karmada部署的组件</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-n</span> <span class="string">karmada-system</span>   </span><br><span class="line"><span class="string">NAME</span>                                  <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">karmada-aggregated-apiserver</span>          <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-apiserver</span>                     <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">18m</span></span><br><span class="line"><span class="string">karmada-controller-manager</span>            <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-kube-controller-manager</span>       <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler</span>                     <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member1</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member2</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-scheduler-estimator-member3</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br><span class="line"><span class="string">karmada-webhook</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">17m</span></span><br></pre></td></tr></table></figure>
<p>在host集群中可以看到会创建出如下的pod</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k get pod -n karmada-system </span></span><br><span class="line">NAME                                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">etcd<span class="literal">-0</span>                                                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-aggregated-apiserver-7b88b8df99-95twq</span>          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-apiserver-5746cf97bb-pspfg</span>                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-controller-manager-7d66968445-h4xsc</span>            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-kube-controller-manager-869d9df85-f4bqj</span>        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-8677cdf96d-psnlw</span>                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member1-696b54fd56-jjg6b</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member2-774fb84c5d-fldhd</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-scheduler-estimator-member3-5c7d87f4b4-fk4lj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br><span class="line">karmada<span class="literal">-webhook-79b87f7c5f-lt8ps</span>                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">18</span><span class="built_in">h</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver集群会创建出如下的Cluster，同时可以看到有两个Push模式一个Pull模式的集群。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kctx</span> <span class="string">karmada-apiserver</span></span><br><span class="line"><span class="string">Switched</span> <span class="string">to</span> <span class="string">context</span> <span class="string">&quot;karmada-apiserver&quot;</span><span class="string">.</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">clusters</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">VERSION</span>   <span class="string">MODE</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">member1</span>   <span class="string">v1.22.0</span>   <span class="string">Push</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br><span class="line"><span class="string">member2</span>   <span class="string">v1.22.0</span>   <span class="string">Push</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br><span class="line"><span class="string">member3</span>   <span class="string">v1.22.0</span>   <span class="string">Pull</span>   <span class="literal">True</span>    <span class="string">61m</span></span><br></pre></td></tr></table></figure>
<h1 id="应用发布"><a href="#应用发布" class="headerlink" title="应用发布"></a>应用发布</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karama-concepts.png"></p>
<p>将context切换到karmada-host，在host集群部署应用nginx</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> export KUBECONFIG=<span class="string">&quot;<span class="variable">$HOME</span>/.kube/karmada.config&quot;</span></span><br><span class="line"><span class="variable">$</span> kctx karmada<span class="literal">-apiserver</span></span><br><span class="line"><span class="variable">$</span> kubectl create <span class="operator">-f</span> samples/nginx/propagationpolicy.yaml</span><br><span class="line"><span class="variable">$</span> <span class="built_in">cat</span> samples/nginx/propagationpolicy.yaml</span><br><span class="line">apiVersion: policy.karmada.io/v1alpha1</span><br><span class="line">kind: PropagationPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx<span class="literal">-propagation</span></span><br><span class="line">spec:</span><br><span class="line">  resourceSelectors:</span><br><span class="line">    - apiVersion: apps/v1</span><br><span class="line">      kind: Deployment</span><br><span class="line">      name: nginx</span><br><span class="line">  placement:</span><br><span class="line">    <span class="comment"># 要提交到子集群1和2</span></span><br><span class="line">    clusterAffinity:</span><br><span class="line">      clusterNames:</span><br><span class="line">        - member1</span><br><span class="line">        - member2</span><br><span class="line">    replicaScheduling:</span><br><span class="line">      replicaDivisionPreference: Weighted</span><br><span class="line">      replicaSchedulingType: Divided</span><br><span class="line">      weightPreference:</span><br><span class="line">        staticWeightList:</span><br><span class="line">          - targetCluster:</span><br><span class="line">              clusterNames:</span><br><span class="line">                - member1</span><br><span class="line">            weight: <span class="number">1</span></span><br><span class="line">          - targetCluster:</span><br><span class="line">              clusterNames:</span><br><span class="line">                - member2</span><br><span class="line">            weight: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver中提交deployment。deployment提交后实际上仅为一个模板，只有PropagationPolicy跟deployment关联后，才会真正部署。deployment中指定的副本数为所有子集群的副本数综合。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">samples/nginx/deployment.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deploy</span> </span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">7m37s</span></span><br><span class="line"><span class="comment"># 可以看到虽然deployment的副本数为2，但在karmada-apiserver集群中实际上并没有pod创建出来</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="literal">No</span> <span class="string">resources</span> <span class="string">found</span> <span class="string">in</span> <span class="string">default</span> <span class="string">namespace.</span></span><br></pre></td></tr></table></figure>
<p>通过karmadactl命令可以查询环境中的所有子集群的pod状态</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">karmadactl</span> <span class="string">get</span> <span class="string">pod</span></span><br><span class="line"><span class="string">The</span> <span class="string">karmadactl</span> <span class="string">get</span> <span class="string">command</span> <span class="string">now</span> <span class="string">only</span> <span class="string">supports</span> <span class="string">Push</span> <span class="string">mode,</span> [ <span class="string">member3</span> ] <span class="string">are</span> <span class="string">not</span> <span class="string">push</span> <span class="string">mode</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">CLUSTER</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx-6799fc88d8-4w2gc</span>   <span class="string">member1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m16s</span></span><br><span class="line"><span class="string">nginx-6799fc88d8-j77f5</span>   <span class="string">member2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m16s</span></span><br></pre></td></tr></table></figure>
<h1 id="元集群访问子集群"><a href="#元集群访问子集群" class="headerlink" title="元集群访问子集群"></a>元集群访问子集群</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/karmada-aa.png"></p>
<p>可以看到在karmada-apiserver上注册了AA服务，group为cluster.karmada.io</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl --kubeconfig /root/.kube/karmada.config --context karmada-apiserver get  apiservice v1alpha1.cluster.karmada.io -o yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">apiserver:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">karmada-aggregated-apiserver</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1alpha1.cluster.karmada.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">cluster.karmada.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">2000</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">karmada-aggregated-apiserver</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">karmada-system</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-02-21T08:27:47Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">all</span> <span class="string">checks</span> <span class="string">passed</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Passed</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br></pre></td></tr></table></figure>
<p>如果直接使用kubectl访问karmada-apiserver服务，会提示存在权限问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">￥</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/karmada-apiserver.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>   <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="string">users</span> <span class="string">&quot;system:admin&quot;</span> <span class="attr">is forbidden:</span> <span class="string">User</span> <span class="string">&quot;system:serviceaccount:karmada-cluster:karmada-impersonator&quot;</span> <span class="string">cannot</span> <span class="string">impersonate</span> <span class="string">resource</span> <span class="string">&quot;users&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">at</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">scope</span></span><br></pre></td></tr></table></figure>
<p>给karmada-apiserver的Account system:admin授权，创建文件cluster-proxy-rbac.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;cluster.karmada.io&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusters/proxy</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member3</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:admin&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行如下命令即可给karmada-apiserver的Account system:admin 授权可访问AA服务的member1-3</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cluster-proxy-rbac.yaml</span>   </span><br></pre></td></tr></table></figure>
<p>通过url的形式访问AA服务，返回数据格式为json</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/karmada-apiserver.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br></pre></td></tr></table></figure>
<p>如果要想使用 kubectl get node 的形式来访问，则需要在kubeconfig文件中server字段的url地址后追加url <code>/apis/cluster.karmada.io/v1alpha1/clusters/&#123;clustername&#125;/proxy</code> </p>
<h2 id="给特定的账号授权"><a href="#给特定的账号授权" class="headerlink" title="给特定的账号授权"></a>给特定的账号授权</h2><p>在karmada-apiserver中创建账号 tom</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">create</span> <span class="string">serviceaccount</span> <span class="string">tom</span></span><br></pre></td></tr></table></figure>
<p>在karmada-apiserver中提交如下的yaml文件，用来给tom账号增加访问member1集群的权限</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;cluster.karmada.io&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clusters/proxy</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">member1</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-proxy-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="comment"># The token generated by the serviceaccount can parse the group information. Therefore, you need to specify the group information below.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:serviceaccounts&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;system:serviceaccounts:default&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行如下命令提交</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">cluster-proxy-rbac.yaml</span></span><br></pre></td></tr></table></figure>
<p>获取karmada-apiserver集群的tom账号的token信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>  <span class="string">get</span> <span class="string">secret</span> <span class="string">`kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/karmada.config</span> <span class="string">--context</span> <span class="string">karmada-apiserver</span>  <span class="string">get</span> <span class="string">sa</span> <span class="string">tom</span> <span class="string">-oyaml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">token</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span><span class="string">`</span> <span class="string">-oyaml</span> <span class="string">|</span> <span class="attr">grep token:</span> <span class="string">|</span> <span class="string">awk</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> <span class="string">|</span> <span class="string">base64</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure>
<p> 创建~&#x2F;.kube&#x2F;tom.config文件，其中token信息为上一步获取的token，server的地址可以查看 ~&#x2F;.kube&#x2F;karmada-apiserver.config文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">insecure-skip-tls-verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">server:</span> &#123;<span class="string">karmada-apiserver-address</span>&#125; <span class="comment"># Replace &#123;karmada-apiserver-address&#125; with karmada-apiserver-address. You can find it in /root/.kube/karmada.config file.</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">tom</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span> &#123;<span class="string">token</span>&#125; <span class="comment"># Replace &#123;token&#125; with the token obtain above.</span></span><br></pre></td></tr></table></figure>
<p>通过karmada-apiserver的tom用户访问member1集群</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预期可以正常访问</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/apis</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期不可以访问，因为tom在member1集群没有权限</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(Forbidden):</span> <span class="attr">nodes is forbidden:</span> <span class="string">User</span> <span class="string">&quot;system:serviceaccount:default:tom&quot;</span> <span class="string">cannot</span> <span class="string">list</span> <span class="string">resource</span> <span class="string">&quot;nodes&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">at</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">scope</span></span><br></pre></td></tr></table></figure>
<p>在member1集群将tom账号绑定权限，创建member1-rbac.yaml文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tom</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<p>权限在member1集群生效</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">/root/.kube/members.config</span> <span class="string">--context</span> <span class="string">member1</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">member1-rbac.yaml</span> </span><br></pre></td></tr></table></figure>
<p>重新执行命令即可以访问子集群中的数据</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">--kubeconfig</span> <span class="string">~/.kube/tom.config</span> <span class="string">get</span> <span class="string">--raw</span> <span class="string">/apis/cluster.karmada.io/v1alpha1/clusters/member1/proxy/api/v1/nodes</span></span><br></pre></td></tr></table></figure>
<h1 id="集群注册"><a href="#集群注册" class="headerlink" title="集群注册"></a>集群注册</h1><p>支持Push和Pull两种模式。<br>​</p>
<p>push模式karmada会直接访问成员集群的kuba-apiserver。</p>
<p>pull模式针对的场景是中心集群无法直接子集群的场景。每个子集群运行karmada-agent组件，一旦karmada-agent部署完成后就会自动向host集群注册，karmada-agent会watch host集群的karmada-es-<cluster name>下的cr，并在本集群部署。<br>​</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/github-kubernetes-sigs-projects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/github-kubernetes-sigs-projects/" class="post-title-link" itemprop="url">Github Kubernetes SIGs组织下的项目（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-14 23:21:37" itemprop="dateCreated datePublished" datetime="2022-02-14T23:21:37+00:00">2022-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="apiserver-builder-alpha"><a href="#apiserver-builder-alpha" class="headerlink" title="apiserver-builder-alpha"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/apiserver-builder-alpha">apiserver-builder-alpha</a></h1><p>k8s提供了aggregated apiserver的方式来扩容api，该项目提供了代码生成器、基础library来供开发AA使用。</p>
<p>该项目的定位跟kubebuilder比较类似，kubebuilder用来生成CRD的框架，该项目用来生成AA的框架。</p>
<p>相关资料：</p>
<ul>
<li>[Set up an Extension API Server](Set up an Extension API Server)</li>
</ul>
<h1 id="cluster-api-provider-nested"><a href="#cluster-api-provider-nested" class="headerlink" title="cluster-api-provider-nested"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster?spm=a2c4g.11186623.0.0.23054a15YVTwkg">cluster-api-provider-nested</a></h1><p>在同一个k8s集群内提供多租户的特性，每个租户具有独立的api-server、controller-manager和scheduler。</p>
<h1 id="cluster-proportional-autoscaler"><a href="#cluster-proportional-autoscaler" class="headerlink" title="cluster-proportional-autoscaler"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-proportional-autoscaler">cluster-proportional-autoscaler</a></h1><p>k8s默认提供了hpa机制，可以根据pod的负载情况来对workload进行自动的扩缩容。同时以单独的autoscaler项目提供了vpa功能的支持。</p>
<p>该项目提供提供了类似pod水平扩容的机制，跟hpa不同的是，pod的数量由集群中的节点规模来自动扩缩容pod。特别适合负载跟集群规模的变化成正比的服务，比如coredns、nginx ingress等服务。</p>
<p>hpa功能k8s提供了CRD来作为hpa的配置，本项目没有单独的CRD来定义配置，而是通过在启动的时候指定参数，或者配置放到ConfigMap的方式。而且一个cluster-proportional-autoscaler实例仅能针对一个workload。</p>
<h1 id="kube-batch"><a href="#kube-batch" class="headerlink" title="kube-batch"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kube-batch">kube-batch</a></h1><p>k8s的调度器扩展，实现了Gang Scheduling特性（一组pod必须同时被调度成功，或者处于pending状态），适用于批处理系统。</p>
<p>由于该组件是以单独调度器的形式存在，会跟k8s默认的kube-scheduler并存，因为两个调度器之间并不能相互感知，在两个调度器并存的情况下会存在一定的冲突。</p>
<h1 id="prometheus-adapter"><a href="#prometheus-adapter" class="headerlink" title="prometheus-adapter"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/prometheus-adapter">prometheus-adapter</a></h1><p>k8s要实现hpa（水平自动扩容）的功能，需要监控指标。k8s的监控指标分为核心指标和自定义指标两大类。其中核心指标由metrics-server组件从kubelet、cadvisor等组件来获取，并通过aggregated apiserver的形式暴露给k8s，aggregated api的group信息为metrics.k8s.io。</p>
<p>自定义监控指标则由group custom.metrics.k8s.io对通过aggregated api暴露。本项目即为自定义监控指标的aggregated apiserver的实现。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics">Horizontal Pod Autoscaling</a></p>
<h1 id="scheduler-plugins"><a href="#scheduler-plugins" class="headerlink" title="scheduler-plugins"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/scheduler-plugins">scheduler-plugins</a></h1><p>k8s从1.16版本开始提供了新的调度框架Kubernetes Schduling Framework机制，用户可以基于此项目来开发自己的插件。该项目可以直接构建出kube-scheduler的新镜像。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/766273">进击的Kubernetes调度系统（一）：Scheduling Framework</a></p>
<h1 id="sig-storage-local-static-provisioner"><a href="#sig-storage-local-static-provisioner" class="headerlink" title="sig-storage-local-static-provisioner"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">sig-storage-local-static-provisioner</a></h1><p>k8s提供了local pv功能可以用来给pod挂载本地的数据盘，具体的local pv的定义如下所示，pv中包含了要亲和的节点信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: example-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 100Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Delete</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: /mnt/disks/ssd1</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - example-node</span><br></pre></td></tr></table></figure>

<p>但要使用local pv功能，必须要事先创建出pv才可以，k8s本身并没有提供动态创建pv的功能。</p>
<p>该工具可以根据配置的规则，自动将机器上符合条件的磁盘创建出local pv以供后续创建出的pod使用。</p>
<p>另外，Rancher提供了一个类似的项目，<a target="_blank" rel="noopener" href="https://github.com/rancher/local-path-provisioner">local-path-provisioner</a>，该项目已经被拉起k8s开发环境的开源项目kind使用。</p>
<p>相关参考：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/178475.html">LocalVolume数据卷</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubernetes-opensource-project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubernetes-opensource-project/" class="post-title-link" itemprop="url">Github Kubernetes组织下开源项目（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-09 20:12:00" itemprop="dateCreated datePublished" datetime="2022-02-09T20:12:00+00:00">2022-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在k8s官方的Github kubernetes group下除了k8s的核心组件外，还有很多开源项目，本文用来简要分析这些开源项目的用途。</p>
<h1 id="apimachinery"><a href="#apimachinery" class="headerlink" title="apimachinery"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/apimachinery">apimachinery</a></h1><p>关于k8s的scheme等的sdk项目，代码跟kubernetes项目的如下路径保持同步：<br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery</a></p>
<h1 id="autoscaler"><a href="#autoscaler" class="headerlink" title="autoscaler"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/autoscaler">autoscaler</a></h1><p>跟k8s的弹性扩缩容相关的组件，有如下两个功能：</p>
<h2 id="vpa（pod垂直扩缩容）"><a href="#vpa（pod垂直扩缩容）" class="headerlink" title="vpa（pod垂直扩缩容）"></a>vpa（pod垂直扩缩容）</h2><p>k8s的kube-controller-manager默认支持了hpa功能，即水平扩缩容。同时k8s还提供了vpa功能，即垂直扩缩容，会根据pod历史的资源占用，修改pod的request值，并不会修改pod的limit值。之所以k8s没有默认提供vpa功能，原因是因为vpa实现要复杂很多，需要通过webhook的技术来在pod创建的时候修改pod的request值。vpa的功能通常用于大型单体应用。</p>
<p>autoscaler的功能之一即提供了vpa的实现。</p>
<h2 id="Cluster-Autoscaler（node节点自动扩缩容）"><a href="#Cluster-Autoscaler（node节点自动扩缩容）" class="headerlink" title="Cluster Autoscaler（node节点自动扩缩容）"></a>Cluster Autoscaler（node节点自动扩缩容）</h2><p>该功能是为了重新利用k8s node的节点资源，在节点资源不足的时候可以动态创建资源，在节点资源空闲的时候可以自动回收资源。k8s node的创建和释放需要公有云平台的支持，该功能对接了多个公有云厂商的api。</p>
<h1 id="cloud-provider"><a href="#cloud-provider" class="headerlink" title="cloud-provider"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/cloud-provider">cloud-provider</a></h1><p>k8s的cloud provider功能用来跟云厂商对接以实现对k8s的node、LoadBalancer Service管理，比如LoadBalancer Service申请vip需要跟云厂商的LB API进行对接。</p>
<p>在k8s 1.6版本之前，cloud provider的代码完全是耦合在k8s的kube-apiserver、kubelet、kube-contorller-manager的代码中的，如果要支持更多的云厂商，只能修改k8s的代码，扩展性比较差。</p>
<p>从k8s 1.6版本之后，cloud provider作为单独的二进制组件来提供服务，并提供了接口定义。本项目为非二进制项目，仅包含k8s的cloud-provider机制的接口定义，为了让第三方的cloud-provider的实现项目引用接口定义方便，将kubernetes项目中的定义为单独的项目，且代码跟<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/staging/src/k8s.io/cloud-provider">kubernetes项目</a>中的保持同步。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/a_540yJ1EGVroJ9TpvYtPw">从 K8S 的 Cloud Provider 到 CCM 的演进之路</a></li>
</ul>
<h1 id="Descheduler"><a href="#Descheduler" class="headerlink" title="Descheduler"></a>Descheduler</h1><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/descheduler">https://github.com/kubernetes-sigs/descheduler</a></p>
<p>k8s的pod调度完全动态的，kube-scheduler组件在调度pod的时候会根据当时k8s集群的运行时环境来决定pod可以调度的节点，可以保证pod的调度在当时是最优的。但是随着的推移，比如环境中增加了新的node、创建了一批亲和节点的pod，都有可能会导致如果相同的pod再重新调度会到其他的节点上。但k8s的设计是，一旦pod调度完成后，就不会再重新调度。</p>
<p>Descheduler组件用来解决pod的重新调度问题，可以根据配置的一系列的规则来触发驱逐pod，让pod可以重新调度，从而使k8s集群内的pod尽可能达到最优状态，有点类似于计算机在运行了一段时间后的磁盘脆片整理功能。Descheduler组件可以以job、cronjob或者deployment的方式运行在k8s集群中。</p>
<h1 id="kubernetes-template-project"><a href="#kubernetes-template-project" class="headerlink" title="kubernetes-template-project"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes-template-project">kubernetes-template-project</a></h1><p>用来存放了k8s项目的标准模板，里面包含了一些必要的文件，新建的项目可以fork该项目。</p>
<h1 id="node-problem-detector-npd"><a href="#node-problem-detector-npd" class="headerlink" title="node-problem-detector(npd)"></a>node-problem-detector(npd)</h1><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/node-problem-detector">https://github.com/kubernetes/node-problem-detector</a></p>
<p>k8s的管控组件对于iaas层的node运行状态是完全不感知的，比如节点出现了ntp服务挂掉、硬件告警（cpu、内存、磁盘故障）、内核死锁。node-problem-detector旨在将node节点的问题转换k8s node event，以DaemonSet的方式部署在所有的k8s节点上。</p>
<p>上报故障的方式支持如下两种方式：</p>
<ul>
<li>对于永久性故障，通过修改node status中的condition上报给apiserver</li>
<li>对于临时性故障，通过Event的方式上报</li>
</ul>
<p>node-problem-detector在将节点的故障信息上报给k8s后，通常会配合一些自愈系统搭配使用，比如Draino和Descheduler 。</p>
<h1 id="sample-apiserver"><a href="#sample-apiserver" class="headerlink" title="sample-apiserver"></a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/sample-apiserver">sample-apiserver</a></h1><p>k8s提供了aggregated apiserver的方式来扩展api，该项目为一个简单的aaggregated apiserver的例子，可以直接编译出二进制文件。要想开发一个AA类型的服务，只需要frok一下该项目，并在项目的基础上进行修改即可完成。</p>
<p>相关资料：</p>
<ul>
<li>[Set up an Extension API Server](Set up an Extension API Server)</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/knowledge-share/knowledge-share-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/knowledge-share/knowledge-share-14/" class="post-title-link" itemprop="url">技术分享第14期</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-09 19:35:26" itemprop="dateCreated datePublished" datetime="2022-02-09T19:35:26+00:00">2022-02-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/zheli.jpg"></p>
<p>题图为一点资讯近期推出的一款定位线上社交的App啫喱，每个人可以给自己订制一个卡通形象，是国内厂商对于线上社交的一次新的尝试。</p>
<p>距离上期技术分享已经约有一年半的时间，这次不定期更新的时间有些久。2022年期望在博客方面增加时间投入，多关注开源技术，预计会大幅度提升更新的频率。</p>
<h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><h2 id="1-Katacoda"><a href="#1-Katacoda" class="headerlink" title="1. Katacoda"></a>1. <a target="_blank" rel="noopener" href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/katacoda.jpg"></p>
<p>可以一键创建一个k8s集群的工具，甚至无需登录，比上期推荐的工具<a href="http://kuring.me/post/knowledage-share-13/">Play with Kubernetes</a>更为方便。</p>
<h2 id="2-OperatorHub"><a href="#2-OperatorHub" class="headerlink" title="2. OperatorHub"></a>2. <a href="operatorhub.io">OperatorHub</a></h2><p>k8s推出了CRD的机制后，大大增强了k8s的扩展能力，可以好不夸张的说，k8s之所以如此成功，跟CRD的扩展机制有很大关系。OperatorHub类似于DockerHub，收集了各种各样的operator实现。</p>
<h2 id="3-lazykube"><a href="#3-lazykube" class="headerlink" title="3. lazykube"></a>3. <a target="_blank" rel="noopener" href="https://github.com/TNK-Studio/lazykube">lazykube</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/lazykube.gif"></p>
<p>一款可以通过命令行终端来展示和管理k8s资源的工具。</p>
<h2 id="4-LazyDocker"><a href="#4-LazyDocker" class="headerlink" title="4. LazyDocker"></a>4. <a target="_blank" rel="noopener" href="https://github.com/jesseduffield/lazydocker">LazyDocker</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/lazydocker.jpg"></p>
<p>同上面的lazykube工具，LazyDocker是一个可以在命令行上查看本机docker的工具，可以查看docker上容器以及运行状态、本地的镜像以及分层信息、volume信息。</p>
<h2 id="5-httpbin"><a href="#5-httpbin" class="headerlink" title="5. httpbin"></a>5. <a target="_blank" rel="noopener" href="http://httpbin.org/">httpbin</a></h2><p>一个非常简单的http服务，可以用来在测试服务的连通性，尤其是可以用curl测试api层面的连通性，再也不用访问curl <a target="_blank" rel="noopener" href="http://www.baidu.com了.比如执行`curl/">http://www.baidu.com了。比如执行`curl</a> <a target="_blank" rel="noopener" href="http://httpbin.org/headers%60%E5%8F%AF%E4%BB%A5%E4%BB%A5json%E7%9A%84%E5%BD%A2%E5%BC%8F%E8%BF%94%E5%9B%9Erequest%E7%9A%84http">http://httpbin.org/headers`可以以json的形式返回request的http</a> header信息，执行<code>curl http://httpbin.org/status/200</code>可以返回状态码为200。</p>
<p>不过，在国内访问该网站连通性并不是太好。还提供了镜像版本，可以直接在本地以docker的方式运行该服务。</p>
<h2 id="6-Flux"><a href="#6-Flux" class="headerlink" title="6. Flux"></a>6. <a target="_blank" rel="noopener" href="https://github.com/fluxcd/flux">Flux</a></h2><p>一款基于k8s的GitOps工具，采用k8s的声明式api基于operator实现。</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/flux-cd-diagram.png" alt="https://github.com/fluxcd/flux/blob/master/docs/_files/flux-cd-diagram.png"></p>
<h2 id="7-OpenTelemetry"><a href="#7-OpenTelemetry" class="headerlink" title="7. OpenTelemetry"></a>7. <a target="_blank" rel="noopener" href="https://opentelemetry.io/">OpenTelemetry</a></h2><p>云原生领域的可观测性工具，用来制定规范、提供sdk和采集agent实现，实现了可观察性中的tracing和metric，并没有实现logging部分。不负责底层的后端存储，可以跟负责metric的prometheus集成，负责tracing的jager集成。</p>
<h2 id="8-kspan"><a href="#8-kspan" class="headerlink" title="8. kspan"></a>8. <a target="_blank" rel="noopener" href="https://github.com/weaveworks-experiments/kspan">kspan</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/kspan.png" alt="https://github.com/weaveworks-experiments/kspan/blob/main/example-2pod.png"></p>
<p>该工具可以将k8s的event使用OpenTelemetry转换成tracing的形式，并将其存储在支持tracing的后端，比如jaeger中。</p>
<h2 id="9-skopeo"><a href="#9-skopeo" class="headerlink" title="9. skopeo"></a>9. <a target="_blank" rel="noopener" href="https://github.com/containers/skopeo">skopeo</a></h2><p>skopeo是一款镜像操作工具，用来解决常用的镜像操作，但这些功能docker命令却不太具备，或者需要调用docker registry的api才可以完成操作。比如镜像从一个镜像仓库迁移到另外一个镜像仓库，从镜像仓库中删除镜像等。</p>
<h2 id="10-KubeOperator"><a href="#10-KubeOperator" class="headerlink" title="10. KubeOperator"></a>10. <a target="_blank" rel="noopener" href="https://fit2cloud.com/kubeoperator/index.html">KubeOperator</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/kube-operator.jpeg" alt="https://camo.githubusercontent.com/1045b27ad1186b915281a6fd77b35979d2038d97e152c34f0431e74ac43d4145/68747470733a2f2f6b7562656f70657261746f722e696f2f696d616765732f73637265656e73686f742f30322e6a7067"></p>
<p>KubeOperator一个开源的轻量级 Kubernetes 发行版，提供可视化的 Web UI，可以用来在IaaS 平台上自动创建主机，通过 Ansible 完成自动化部署和变更操作。</p>
<p>另外，还提供了商业版本，支持更多的企业级特性，这种模式也是类似Redhat的最为常见的开源软件的商业变现方式。</p>
<h2 id="11-Lens"><a href="#11-Lens" class="headerlink" title="11. Lens"></a>11. <a target="_blank" rel="noopener" href="https://k8slens.dev/">Lens</a></h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/lens.png" alt="https://kuring.oss-cn-beijing.aliyuncs.com/knowledge/kube-operator.jpeg"></p>
<p>Kubernetes的客户端工具，非web端工具，可以通过本地访问远程的k8s集群，并且可以获取k8s集群的node、pod等信息，提供了mac、linux、windows三种客户端版本。</p>
<h2 id="12-Caddy"><a href="#12-Caddy" class="headerlink" title="12. Caddy"></a>12. <a target="_blank" rel="noopener" href="https://caddyserver.com/">Caddy</a></h2><p>一款使用Golang编写的七层负载均衡软件，Github上有3万+的star数量，相比与nginx有两个明显的优势：提供了默认的https服务，支持证书的自签发；使用Golang开发，只需要一个二进制配合caddyfile配置文件即可运行，更轻量。</p>
<h2 id="13-LVScare"><a href="#13-LVScare" class="headerlink" title="13. LVScare"></a>13. <a target="_blank" rel="noopener" href="https://github.com/sealyun/lvscare">LVScare</a></h2><p>sealyun开源的一个轻量级的lvs管理工具，可以作为轻量级的负载均衡，基于Golang实现。输入这样一条指令 <code>lvscare care --run-once --vs 10.103.97.12:6443 --rs 192.168.0.2:6443 --rs 192.168.0.3:6443 --rs 192.168.0.4:6443</code> 即可在宿主机上创建对应的ipvs规则。自带了健康检查功能，支持四层和七层的健康检查，是该工具的最大优势。一般lvs会配合着keepalived来进行检查检查，一旦健康检查失败后会将rs的权重调整为0，但keepalived的配置相对复杂，该工具更轻量。</p>
<h2 id="14-HUGO"><a href="#14-HUGO" class="headerlink" title="14. HUGO"></a>14. <a target="_blank" rel="noopener" href="https://gohugo.io/">HUGO</a></h2><p>非常火爆的使用Golang开发的开源博客系统，目前Github上的Star数量已经超过5万+，更老牌的开源博客系统Hexo的Star数量才3万+，基于Vue开发的VuePress Star数量还不到2万。</p>
<h2 id="15-sealer"><a href="#15-sealer" class="headerlink" title="15. sealer"></a>15. <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer">sealer</a></h2><p>阿里巴巴开源的一款云原生的应用发布工具。该工具的设计思路非常先进，提出了集群镜像的概念，可以将k8s集群和应用build成为一个集群镜像，类似于docker镜像，一旦集群镜像构建完成后即可像容器一样运行在不同的硬件上。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/alibaba_opensource_cloudnative/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/alibaba_opensource_cloudnative/" class="post-title-link" itemprop="url">阿里巴巴开源云原生项目分析（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-08 21:33:00" itemprop="dateCreated datePublished" datetime="2022-02-08T21:33:00+00:00">2022-02-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ackdistro"><a href="#ackdistro" class="headerlink" title="ackdistro"></a><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/ackdistro">ackdistro</a></h1><p>阿里云的k8s发行版，跟阿里云的ack采用了相同的源码。该项目采用<a href="#sealer">sealer</a>来部署k8s集群，并通过sealer支持k8s集群的扩容、缩容节点等运维操作。该项目并没有将k8s相关的源码开源，而主要维护了安装k8s集群需要的yaml文件、helm chart。</p>
<p>ack的k8s发行版比较简洁，并没有公有云ack的丰富的组件。除了k8s原生的几个组件外，网络插件集成了<a href="#hybridnet">hybridnet</a>，存储插件集成了<a href="#open-local">open-local</a>。</p>
<h1 id="hybridnet"><a href="#hybridnet" class="headerlink" title="hybridnet"></a><a target="_blank" rel="noopener" href="https://github.com/alibaba/hybridnet">hybridnet</a></h1><p>容器网络插件，支持underlay网络和overlay网络，且可以支持一个k8s集群内的网络同时支持overlay网络和underlay网络。underlay网络模式下，可以支持vlan网络，也可以支持bgp网络。</p>
<h1 id="image-syncer"><a href="#image-syncer" class="headerlink" title="image-syncer"></a><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/image-syncer">image-syncer</a></h1><p>镜像仓库同步工具，用于两个镜像仓库之间的数据同步。在公有云的产品ack one中有所应用。</p>
<h1 id="kube-eventer"><a href="#kube-eventer" class="headerlink" title="kube-eventer"></a><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/kube-eventer">kube-eventer</a></h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/kube-eventer.png" alt="![https://user-images.githubusercontent.com/8912557/117400612-97cf3a00-af35-11eb-90b9-f5dc8e8117b5.png](https://kuring.oss-cn-beijing.aliyuncs.com/common/sealer.png)"></p>
<p>k8s的Event会存放在etcd中，并跟对象关联。Event有一定的有效时常，默认为1小时。业界通常做法是将event存放在单独的etcd集群中，并将event的生命周期设长。对于异常类型的Event，是一种非常理想的告警机制。</p>
<p>kube-eventer组件可以将k8s的event对象收集起来，可以发送到钉钉、kafka等数据sink端。</p>
<h1 id="kubernetes-cronhpa-controller"><a href="#kubernetes-cronhpa-controller" class="headerlink" title="kubernetes-cronhpa-controller"></a><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/kubernetes-cronhpa-controller">kubernetes-cronhpa-controller</a></h1><p>k8s提供了hpa机制，可以针对pod的监控信息对pod进行扩缩容。该组件提供了定期扩缩容的机制，可以定期对pod的数量进行设置。</p>
<p>相关资料：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/151557.htm?spm=a2c4g.11186623.0.0.48b151bb3ZWte9#task-2391975">容器定时伸缩（CronHPA）</a></p>
<h1 id="log-pilot"><a href="#log-pilot" class="headerlink" title="log-pilot"></a><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/log-pilot">log-pilot</a></h1><p>针对容器类型的服务研发的日志收集agent，可以在k8s pod上通过简单配置环境变量的方式即可采集日志，使用起来非常简洁。</p>
<h1 id="open-local"><a href="#open-local" class="headerlink" title="open-local"></a><a target="_blank" rel="noopener" href="https://github.com/alibaba/open-local">open-local</a></h1><p>k8s对于本地磁盘设备的使用相对较弱，提供了emptyDir、hostPath和local pv的能力来使用本地磁盘设备，但这些功能并没有使用到k8s的动态创建pv的功能，即在pod在使用pvc之前，pv必须实现要创建出来。</p>
<p>该项目提供了本地存储设备的动态供给能力，可以将本地的一块完整磁盘作为一个pv来动态创建。也可以将本地的磁盘切分成多块，通过lvm的方式来分配本地的不同pod来使用，以满足磁盘的共享，同时又有完整的磁盘quota能力。</p>
<p>相关资料：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/178476.html">LVM数据卷</a></p>
<h1 id="sealer"><a href="#sealer" class="headerlink" title="sealer"></a><a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer">sealer</a></h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/sealer.png" alt="https://user-images.githubusercontent.com/8912557/117400612-97cf3a00-af35-11eb-90b9-f5dc8e8117b5.png"></p>
<p>当前的应用发布经历了三个阶段：</p>
<ul>
<li>阶段一 裸部署在物理机或者vm上。直接裸部署在机器上的进程，存在操作系统、软件包的依赖问题，比如要部署一个python应用，那么需要机器上必须要包含对应版本的python运行环境以及应用依赖的所有包。</li>
<li>阶段二 通过镜像的方式部署在宿主机上。docker通过镜像的方式将应用以及依赖打包到一起，解决了单个应用的依赖问题。</li>
<li>阶段三 通过k8s的方式来标准化部署。在k8s时代，可以将应用直接部署到k8s集群上，将应用的发布标准化，实现应用的跨机器部署。</li>
</ul>
<p>在阶段三中，应用发布到k8s集群后，应用会对k8s集群有依赖，比如k8s管控组件的配置、使用的网络插件、应用的部署yaml文件，对镜像仓库和dockerd的配置也有所依赖。当前绝大多数应用发布是跟k8s集群部署完全独立的，即先部署k8s集群，然后再部署应用，跟阶段一的发布单机应用模式比较类似，先安装python运行环境，然后再启动应用。</p>
<p>sealer项目是个非常有意思的开源项目，旨在解决k8s集群连同应用发布的自动化问题，可以实现类似docker镜像的方式将整个k8s集群连同应用一起打包成集群镜像，有了集群镜像后既可以标准化的发布到应用到各个地方。sealer深受docker的启发，提出的很多概念跟docker非常类似，支持docker常见的子命令run、inspect、save、load、build、login、push、pull等。</p>
<ul>
<li>Kubefile概念跟Dockerfile非常类似，且可以执行sealer build命令打包成集群镜像，语法也类似于Dockerfile。</li>
<li>CloudImage：集群镜像，将Kubefile打包后的产物，类比与dockerimage。基础集群镜像通常为裸k8s集群，跟docker基础镜像为裸操作系统一致。</li>
<li>Clusterfile：要想运行CloudImage，需要配合Clusterfile文件来启动，类似于Docker Compose。Clusterfile跟Docker Compose一致，并不是必须的，也可以通过sealer run的方式来启动集群镜像。</li>
</ul>
<p>sealer要实现上述功能需要实现将k8s集群中的所有用到镜像全部打包到一个集群镜像中。</p>
<p>相关资料：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0SBslzaMWtqn9H8Q57urNA">集群镜像：实现高效的分布式应用交付</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-support-zone-region/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-support-zone-region/" class="post-title-link" itemprop="url">k8s在region和zone方面的支持情况</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-25 12:33:00" itemprop="dateCreated datePublished" datetime="2022-01-25T12:33:00+00:00">2022-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>k8s虽然已经发展了多个版本，但在多region和多zone的场景下支持还是相对比较弱的，且很多的特性在alpha版本就已经废弃，说明k8s官方对于region和zone方面的支持情况有很大的不确定性。业界支持多reigon和容灾的特性更多是从上层的应用层来解决。本文主要是介绍k8s自身以及社区在region和zone方面的支持情况。</p>
<h1 id="k8s标签"><a href="#k8s标签" class="headerlink" title="k8s标签"></a>k8s标签</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone">https://kubernetes.io/docs/reference/labels-annotations-taints/#topologykubernetesiozone</a><br>官方推荐的跟region和zone有关的标签：</p>
<ul>
<li>failure-domain.beta.kubernetes.io&#x2F;region：1.17版本已经废弃，被topology.kubernetes.io&#x2F;region取代</li>
<li>failure-domain.beta.kubernetes.io&#x2F;zone：1.17版本已经废弃，被topology.kubernetes.io&#x2F;zone取代</li>
<li>topology.kubernetes.io&#x2F;region：1.17版本开始支持</li>
<li>topology.kubernetes.io&#x2F;zone：1.17版本开始支持</li>
</ul>
<h1 id="服务拓扑ServiceTopology"><a href="#服务拓扑ServiceTopology" class="headerlink" title="服务拓扑ServiceTopology"></a>服务拓扑ServiceTopology</h1><p>支持版本：在1.17版本引入，在1.21版本废弃</p>
<p>该特性在Service对象上增加了spec.topologyKeys字段，表示访问该Service的流量优先选用的拓扑域列表。访问Service流量的具体过程如下：</p>
<ol>
<li>当访问该Service时，一定是从某个k8s的node节点上发起，会查看当前node的label topology.kubernetes.io&#x2F;zone对应的value，如果发现有endpoint所在的node的lable topology.kubernetes.io&#x2F;zone对应的value相同，那么会将流量转发到该拓扑域的endpoint上。</li>
<li>如果没有找到topology.kubernetes.io&#x2F;zone相同拓扑域的endpoint，则尝试找topology.kubernetes.io&#x2F;region相同拓扑域的endpoint。</li>
<li>如果没有找到任何拓扑域的endpoint，那么该service会转发失败。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">Name:</span> <span class="string">my-app-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-app</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">topologyKeys:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;topology.kubernetes.io/zone&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;topology.kubernetes.io/region&quot;</span></span><br></pre></td></tr></table></figure>
在底层实现上，使用了1.16版本新引入的alpha版本特性 EndpointSlice，该特性主要是用来解决Endpoints对象过多时带来的性能问题，从而将Endpoints拆分为多个组，Service Topology特性恰好可以借助该特性来实现，本质上也是为了将Endpoints进行拆分。k8s会根据Service的topologyKeys来将Service拆分为多个EndpointSlice对象，kube-proxy根据EndpointSlice会将Service流量进行拆分。</li>
</ol>
<h1 id="拓扑感知提示Topology-Aware-Hints"><a href="#拓扑感知提示Topology-Aware-Hints" class="headerlink" title="拓扑感知提示Topology Aware Hints"></a>拓扑感知提示Topology Aware Hints</h1><p>该特性在1.21版本引入，在1.23版本变为beta版本，用来取代Topology Key功能。<br>该特性会启用两个组件：EndpointSlice控制器和kube-proxy。</p>
<p>在Service Topology功能中，需要给Service来指定topologyKeys字段。该特性会更自动化一些，只需要在Service上增加annotation service.kubernetes.io&#x2F;topology-aware-hints:auto，EndpointSlice控制器会watch到Service，发现开启了拓扑感知功能，会自动向endpoints的hints中增加forZones字段，该字段的value会根据endpoint所在node的topology.kubernetes.io&#x2F;zone来决定。</p>
<p>值得一提的是，当前的hints中并没有包含forRegions的字段。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">discovery.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EndpointSlice</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-hints</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/service-name:</span> <span class="string">example-svc</span></span><br><span class="line"><span class="attr">addressType:</span> <span class="string">IPv4</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;10.1.2.3&quot;</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">pod-1</span></span><br><span class="line">    <span class="attr">zone:</span> <span class="string">zone-a</span></span><br><span class="line">    <span class="attr">hints:</span></span><br><span class="line">      <span class="attr">forZones:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;zone-a&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="">Well-Known Labels, Annotations and Taints</a></li>
<li>Google Ingress for Anthos：<a target="_blank" rel="noopener" href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos#architecture">https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos#architecture</a></li>
<li>阿里云ccm支持多个k8s集群的场景（手工指定lb id和server group方案）：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/335878.html#title-4wt-hc5-p2p">https://help.aliyun.com/document_detail&#x2F;335878.html#title-4wt-hc5-p2p</a></li>
<li><a target="_blank" rel="noopener" href="https://tencentcloudcontainerteam.github.io/2019/11/26/service-topology/">https://tencentcloudcontainerteam.github.io/2019/11/26/service-topology/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/endpoint-slices/">https://kubernetes.io/zh/docs/concepts/services-networking/endpoint-slices/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/245165617">使用 EndpointSlice 扩展 Kubernetes 网络</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/best-practices/multiple-zones/">Running in multiple zones</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/disk-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/disk-command/" class="post-title-link" itemprop="url">Linux下磁盘常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 21:27:07" itemprop="dateCreated datePublished" datetime="2022-01-18T21:27:07+00:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="查看磁盘是否为ssd"><a href="#查看磁盘是否为ssd" class="headerlink" title="查看磁盘是否为ssd"></a>查看磁盘是否为ssd</h1><p>如果其中的rota值为1，说明为hdd磁盘；如果rota值为0，说明为ssd。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># lsblk -o name,size,type,rota,mountpoint</span><br><span class="line">NAME    SIZE TYPE ROTA MOUNTPOINT</span><br><span class="line">vdc      20G disk    1 /var/lib/kubelet/pods/eea3a54c-b211-4ee3-bcbe-70ba3fe84c05/volumes/kubernetes.io~csi/d-t4n36xdqey47v9e0ej8r/mount</span><br><span class="line">vda     120G disk    1</span><br><span class="line">└─vda1  120G part    1 /</span><br></pre></td></tr></table></figure>

<p>但该规则在很多虚拟机的场景下并不成立，即使虚拟机的磁盘为ssd，但rota值仍然为1。可以通过修改rota的值的方式来标记磁盘的类型：echo ‘0’&gt; &#x2F;sys&#x2F;block&#x2F;vdd&#x2F;queue&#x2F;rotational</p>
<h1 id="iostat"><a href="#iostat" class="headerlink" title="iostat"></a>iostat</h1><p>只能观察磁盘整体性能，不能看到进程级别的</p>
<ul>
<li>iops &#x3D; r&#x2F;s+w&#x2F;s</li>
<li>吞吐量 &#x3D; rkB&#x2F;s + wkB&#x2F;s</li>
<li>响应时间 &#x3D; r_await + w_await</li>
</ul>
<p>iostat -xm $interval: interval为秒</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -xm 1</span><br><span class="line">Linux 3.10.0-327.10.1.el7.x86_64 (103-17-52-sh-100-I03.yidian.com)      12/11/2016      _x86_64_        (32 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           4.99    0.00    1.46    0.01    0.00   93.54</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     0.26    0.02    1.62     0.00     0.02    29.31     0.00    0.89    3.37    0.87   0.05   0.01</span><br><span class="line">sdb               0.00     0.81   10.23   67.59     1.19    29.07   796.57     0.01    0.10    0.85    2.85   0.19   1.46</span><br></pre></td></tr></table></figure>

<ul>
<li>r&#x2F;s: 每秒发送给磁盘的读请求数</li>
<li>w&#x2F;s: 每秒发送给磁盘的写请求数</li>
<li>rMB&#x2F;s: 每秒从磁盘读取的数据量</li>
<li>wMB&#x2F;s: 每秒向磁盘写入的数据量</li>
<li>%iowait：cpu等待磁盘时间</li>
<li>%util：表示磁盘使用率，该值较大说明磁盘性能存在问题，io队列不为空的时间。由于存在并行io，100%不代表磁盘io饱和</li>
<li>r_await：读请求处理完成时间，包括队列中的等待时间和设备实际处理时间，单位为毫秒</li>
<li>w_await：写请求处理完成时间，包括队列中的等待时间和设备实际处理时间，单位为毫秒</li>
<li>svctm: 瓶颈每次io操作的时间，单位为毫秒，可以反映出磁盘的瓶颈</li>
<li>avgrq-sz：平均每次请求的数据大小</li>
<li>avgqu-sz：平均请求io队列长度</li>
<li>svctm：处理io请求所需要的平均时间，不包括等待时间，单位为毫秒</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -d -x 1</span><br><span class="line">Linux 3.10.0-327.10.1.el7.x86_64 (103-17-42-sh-100-i08.yidian.com)      01/19/2019      _x86_64_        (24 CPU)</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               0.00     7.58    0.31  266.07     9.54   888.01     6.74     0.03    0.12    8.84    0.11   0.03   0.90</span><br><span class="line">sdb               0.00     0.67    4.39   40.68   386.20  9277.38   428.79     0.03    0.64    3.10    0.37   0.30   1.33</span><br><span class="line">sdd               0.00     0.82    5.08   66.78   451.99 15587.89   446.42     0.02    0.30    3.50    0.05   0.28   2.01</span><br><span class="line">sde               0.00     0.67    4.14   53.77   312.74 12121.84   429.43     0.00    0.03    4.00    1.44   0.30   1.72</span><br><span class="line">sdc               0.00     0.50    0.05   27.47     2.74  6098.56   443.28     0.03    0.95   12.42    0.93   0.21   0.58</span><br><span class="line">sdf               0.00     0.47    1.07   34.58    57.05  7504.68   424.24     0.00    0.05    2.60    2.63   0.25   0.88</span><br><span class="line">sdg               0.00     0.72    0.14   63.87    13.79 14876.74   465.22     0.03    0.42   10.57    0.40   0.19   1.24</span><br><span class="line">sdj               0.00     0.79    1.85   37.81   206.01  7881.89   407.90     0.03    0.67    2.27    0.59   0.36   1.42</span><br><span class="line">sdi               0.00     0.65    0.29   59.54    22.01 13501.71   452.05     0.01    0.25    5.27    0.22   0.19   1.14</span><br><span class="line">sdk               0.00     0.50    0.30   29.46    16.74  6330.68   426.57     0.05    1.58    4.03    1.55   0.24   0.70</span><br><span class="line">sdm               0.00     0.63    0.73   55.70    63.73 13008.16   463.34     0.02    0.35    5.98    0.28   0.23   1.29</span><br><span class="line">sdh               0.00     0.47    0.06   15.68     5.16  2970.09   378.01     0.03    1.82    7.22    1.80   0.27   0.42</span><br><span class="line">sdl               0.00     0.56    1.32   38.14    81.04  8945.16   457.50     0.09    2.22    4.30    2.15   0.19   0.76</span><br></pre></td></tr></table></figure>

<ul>
<li>wrqm: 每秒合并的写请求数</li>
<li>rrqm：每秒合并的读请求数</li>
</ul>
<h1 id="pidstat"><a href="#pidstat" class="headerlink" title="pidstat"></a>pidstat</h1><p>如果要想查看进程级别的磁盘 io 使用情况，可以使用 <code>pidstat -d</code> 指令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ pidstat -d 1</span><br><span class="line">Linux 3.10.0-1160.88.1.el7.x86_64 (izbp1feliilr5yri84y6saz)     05/08/2023      _x86_64_        (16 CPU)</span><br><span class="line"></span><br><span class="line">09:44:24 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command</span><br><span class="line">09:44:25 AM     0       371      0.00    184.91      0.00  jbd2/vda1-8</span><br><span class="line">09:44:25 AM     0      1395      0.00     22.64      7.55  rsyslogd</span><br><span class="line">09:44:25 AM     0     19053      0.00      3.77      0.00  jbd2/dm-0-8</span><br><span class="line">09:44:25 AM  1000     25479      0.00      3.77      0.00  org_start</span><br><span class="line">09:44:25 AM  1000     25754      0.00      3.77      0.00  org_start</span><br><span class="line">09:44:25 AM     0     38784      0.00    505.66      0.00  systemd-journal</span><br><span class="line">09:44:25 AM     0     40474      0.00    143.40      0.00  jbd2/dm-1-8</span><br><span class="line">09:44:25 AM     0     41130      0.00     11.32      0.00  jbd2/dm-2-8</span><br><span class="line">09:44:25 AM  1000     41675      0.00      3.77      0.00  start</span><br><span class="line">09:44:25 AM     0     41730      0.00      3.77      0.00  org_start</span><br></pre></td></tr></table></figure>

<h1 id="iotop"><a href="#iotop" class="headerlink" title="iotop"></a>iotop</h1><p>该命令可以查看所有进程读写 io 情况，该命令通常 os 不会默认安装。在 CentOS 下可以执行 <code>yum install iotop</code> 命令安装。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubectl-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubectl-command/" class="post-title-link" itemprop="url">kubectl常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 15:10:14" itemprop="dateCreated datePublished" datetime="2022-01-18T15:10:14+00:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文记录常用的kubectl命令，不定期更新。</p>
<h2 id="1-统计k8s-node上的污点信息"><a href="#1-统计k8s-node上的污点信息" class="headerlink" title="1. 统计k8s node上的污点信息"></a>1. 统计k8s node上的污点信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o=custom-columns=NodeName:.metadata.name,TaintKey:.spec.taints[*].key,TaintValue:.spec.taints[*].value,TaintEffect:.spec.taints[*].effect</span><br></pre></td></tr></table></figure>

<h2 id="2-查看不ready的pod"><a href="#2-查看不ready的pod" class="headerlink" title="2. 查看不ready的pod"></a>2. 查看不ready的pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide -w | grep -vE &quot;Com|NAME|Running|1/1|2/2|3/3|4/4&quot;</span><br></pre></td></tr></table></figure>

<h2 id="3-pod按照重启次数排序"><a href="#3-pod按照重启次数排序" class="headerlink" title="3. pod按照重启次数排序"></a>3. pod按照重启次数排序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A  --sort-by=&#x27;.status.containerStatuses[0].restartCount&#x27; | tail</span><br></pre></td></tr></table></figure>

<h2 id="4-kubectl-proxy命令代理k8s-apiserver"><a href="#4-kubectl-proxy命令代理k8s-apiserver" class="headerlink" title="4. kubectl proxy命令代理k8s apiserver"></a>4. kubectl proxy命令代理k8s apiserver</h2><p>该命令经常用在开发的场景下，用来测试k8s api的结果。执行如下命令即可在本地127.0.0.1开启10999端口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port=10999</span><br></pre></td></tr></table></figure>

<p>在本地即可通过curl的方式来访问k8s的apiserver，而无需考虑鉴权问题。例如，<code>curl http://127.0.0.1:10999/apis/batch/v1</code>，即可直接返回结果。</p>
<h2 id="5-raw命令"><a href="#5-raw命令" class="headerlink" title="5. --raw命令"></a>5. <code>--raw</code>命令</h2><p>该命令经常用在开发的场景下，用来测试k8s api的结果。执行如下的命令，即可返回json格式的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw /apis/batch/v1</span><br></pre></td></tr></table></figure>

<h2 id="6-查看集群中的pod的request和limit情况"><a href="#6-查看集群中的pod的request和limit情况" class="headerlink" title="6. 查看集群中的pod的request和limit情况"></a>6. 查看集群中的pod的request和limit情况</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system  -o=custom-columns=NAME:.metadata.name,NAMESPACE:.metadata.namespace,PHASE:.status.phase,Request-cpu:.spec.containers\[0\].resources.requests.cpu,Request-memory:.spec.containers\[0\].resources.requests.memory,Limit-cpu:.spec.containers\[0\].resources.limits.cpu,Limit-memory:.spec.containers\[0\].resources.limits.memory</span><br></pre></td></tr></table></figure>

<p>得到的效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAME                                              NAMESPACE     PHASE       Request-cpu   Request-memory   Limit-cpu   Limit-memory</span><br><span class="line">cleanup-for-np-processor-9pjkm                    kube-system   Succeeded   &lt;none&gt;        &lt;none&gt;           &lt;none&gt;      &lt;none&gt;</span><br><span class="line">coredns-6c6664b94-7rnm8                           kube-system   Running     100m          70Mi             &lt;none&gt;      170Mi</span><br><span class="line">coredns-6c6664b94-djxch                           kube-system   Failed      100m          70Mi             &lt;none&gt;      170Mi</span><br><span class="line">coredns-6c6664b94-khvrb                           kube-system   Running     100m          70Mi             &lt;none&gt;      170Mi</span><br></pre></td></tr></table></figure>

<h2 id="7-修改对象的status"><a href="#7-修改对象的status" class="headerlink" title="7. 修改对象的status"></a>7. 修改对象的status</h2><p>因为status资源实际上为对象的subResource资源，实际上无法通过kubectl来完成，但该操作还是放到了该文档中。</p>
<p>下述命令的需求为修改service的status</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APISERVER=https://kube-cn-nb-nbsjzxpoc-d01-a.intra.nbsjzx.ali.com:6443</span><br><span class="line">TOKEN=eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi10b2tlbi1jazdkciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjhkZWE4MWQ4LTU2YTgtMTFlYy05MDMyLTgwNjE1ZjA4NDI0YSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbiJ9.O25G_MSmKRU_pIPO_9tFqDvbZm9SOM_Mix7jCJeFiZHzLiSc7n5RanP3QoEldR1IcFN4AZXzlzI1Rb0GyFQH7XmS1eLESMbKnrTR3N5s3wlRp-D5QT0c_RAVAiLKrP7KsSKNcLjQkIO8-Csf_kmizIh6fP0-b7Mp90cw0J8oSlM-ScEeUEksQyXvyisVN9qvvTIkmbsgh7pX5IFcB4mGbvV9loOUC3-LdiiaCkMJzMisEeSJRaajmLlwpWXtb2BSi9HmBMktUE9IVB8ryZ06wbPRianbjoBwtAhcXuRyj1LaEog3aJHsyMA_DOZJtvjYis60AIRZ1iBnc-gZtEFCxw</span><br><span class="line">obj=nginx-ingress-lb</span><br><span class="line">curl -XPATCH -H &quot;Accept: application/json&quot; -H  &quot;Content-Type: application/merge-patch+json&quot; --header &quot;Authorization: Bearer $TOKEN&quot; --insecure -d &#x27;&#123;&quot;status&quot;: &#123;&quot;loadBalancer&quot;: &#123;&quot;ingress&quot;: [&#123;&quot;ip&quot;: &quot;10.209.97.170&quot;&#125;]&#125;&#125;&#125;&#x27; $APISERVER/api/v1/namespaces/acs-system/services/nginx-ingress-lb/status</span><br></pre></td></tr></table></figure>

<p>APISERVER变量可以通过kubeconfig文件获取到。</p>
<p>TOKEN变量可以直接使用kube-system下的admin账号。</p>
<ol>
<li>执行 <code>kubectl get secrets -n kube-system  | grep admin</code> 获取到sa对应的secret</li>
<li>执行 <code>kubectl get secrets -n kube-system xxxx -o yaml</code> 获取到base64之后的token</li>
<li>执行 <code>echo &quot;xxxx&quot; | base64 -d</code> 即可获取到对应的token</li>
</ol>
<p>obj变量为要修改的service对象名称。</p>
<h2 id="8-查看-secret-内容"><a href="#8-查看-secret-内容" class="headerlink" title="8. 查看 secret 内容"></a>8. 查看 secret 内容</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret -n ark-system ark.cmdb.https.origin.tls -o jsonpath=&#x27;&#123;.data.ca\.pem&#125;&#x27; | base64 -d</span><br></pre></td></tr></table></figure>

<h2 id="9-修改-secret-或-cm-的内容"><a href="#9-修改-secret-或-cm-的内容" class="headerlink" title="9. 修改 secret 或 cm 的内容"></a>9. 修改 secret 或 cm 的内容</h2><p>很多场景下使用 <code>kubectl edit</code> 修改不能完全满足需求，比如某个 key 对应的 value 非常长且包含空格，很难直接编辑。可以通过导出 key 对应的 value 到文件，然后再重新 apply 的方式合入。</p>
<p>导出 configmap 中特定的 key：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cm -n kube-system  networkpolicy-config -o jsonpath=&#x27;&#123;.data.config\.yaml&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>修改完成后，将文件重新 apply cm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create --save-config cm  networkpolicy-config -n kube-system --from-file /tmp/config.yaml -o yaml --dry-run | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<h2 id="9-删除所有-pod（或特定状态-pod）"><a href="#9-删除所有-pod（或特定状态-pod）" class="headerlink" title="9. 删除所有 pod（或特定状态 pod）"></a>9. 删除所有 pod（或特定状态 pod）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces -o wide --no-headers | grep -v Running | awk &#x27;&#123;print $1 &quot; &quot; $2&#125;&#x27; | while read AA BB; do kubectl get pod -n $AA $BB --no-headers; done</span><br></pre></td></tr></table></figure>

<h2 id="10-kubectl-debug"><a href="#10-kubectl-debug" class="headerlink" title="10. kubectl debug"></a>10. kubectl debug</h2><p>常用于网络问题排查，其中镜像 netshoot 中包含了丰富的网络命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it nginx-statefulset-0 bash</span><br></pre></td></tr></table></figure>

<p>进入到 k8s node 网络，其中 <code>$&#123;node&#125;</code> 为 k8s 的 node 名字。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl debug node/$&#123;node&#125; -it --image=nicolaka/netshoot</span><br></pre></td></tr></table></figure>

<h2 id="11-kubectl-patch"><a href="#11-kubectl-patch" class="headerlink" title="11. kubectl patch"></a>11. kubectl patch</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;filed1&quot;: &quot;value1&quot;&#125;&#125;&#x27; --type=merge xxx -n yyy</span><br></pre></td></tr></table></figure>

<h2 id="12-查询对象的-labels"><a href="#12-查询对象的-labels" class="headerlink" title="12. 查询对象的 labels"></a>12. 查询对象的 labels</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有 k8s 节点及其 label</span><br><span class="line">kubectl get nodes -o=jsonpath=&#x27;&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&quot;\t&quot;&#125;&#123;.metadata.labels.topology\.kubernetes\.io/zone&#125;&#123;&quot;\n&quot;&#125;&#123;end&#125;&#x27;</span><br><span class="line"># 查看单个 k8s 节点的 label</span><br><span class="line">kubectl  get node c25e04016.cloud.e04.amtest130  -o jsonpath=&quot;&#123;.metadata.labels[&#x27;topology\.kubernetes\.io/zone&#x27;]&#125;&quot;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-dual-stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-dual-stack/" class="post-title-link" itemprop="url">k8s ipv4/ipv6双栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-16 23:41:33" itemprop="dateCreated datePublished" datetime="2022-01-16T23:41:33+00:00">2022-01-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-08-19 13:59:46" itemprop="dateModified" datetime="2024-08-19T13:59:46+00:00">2024-08-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ipv6在k8s中的支持情况"><a href="#ipv6在k8s中的支持情况" class="headerlink" title="ipv6在k8s中的支持情况"></a>ipv6在k8s中的支持情况</h1><p>ipv6特性在k8s中作为一个特定的feature IPv6DualStack来管理。在1.15版本到1.20版本该feature为alpha版本，默认不开启。从1.21版本开始，该feature为beta版本，默认开启，支持pod和service网络的双栈。1.23版本变为稳定版本。</p>
<h2 id="配置双栈"><a href="#配置双栈" class="headerlink" title="配置双栈"></a>配置双栈</h2><p>alpha版本需要通过kube-apiserver、kube-controller-manager、kubelet和kube-proxy的–feature-gates&#x3D;”IPv6DualStack&#x3D;true”命令来开启该特性，beta版本该特性默认开启。<br />​</p>
<p>kube-apiserver：</p>
<ul>
<li><code>--service-cluster-ip-range=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
</ul>
<p>kube-controller-manager:</p>
<ul>
<li><code>--cluster-cidr=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
<li><code>--service-cluster-ip-range=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
<li><code>--node-cidr-mask-size-ipv4|--node-cidr-mask-size-ipv6</code> 对于 IPv4 默认为 &#x2F;24，对于 IPv6 默认为 &#x2F;64</li>
</ul>
<p>kube-proxy:</p>
<ul>
<li><code>--cluster-cidr=&lt;IPv4 CIDR&gt;,&lt;IPv6 CIDR&gt;</code></li>
</ul>
<h1 id="使用kind创建k8s集群"><a href="#使用kind创建k8s集群" class="headerlink" title="使用kind创建k8s集群"></a>使用kind创建k8s集群</h1><p>由于ipv6的环境并不容易找到，可以使用kind快速在本地拉起一个k8s的单集群环境，同时kind支持ipv6的配置。</p>
<p>检查当前系统是否支持ipv6，如果输出结果为0，说明当前系统支持ipv6.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> sysctl <span class="literal">-a</span> | grep net.ipv6.conf.all.disable_ipv6</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>创建ipv6单栈k8s集群执行如下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; kind<span class="literal">-ipv6</span>.conf &lt;&lt;EOF</span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x<span class="literal">-k8s</span>.io/v1alpha4</span><br><span class="line">name: ipv6<span class="literal">-only</span></span><br><span class="line">networking:</span><br><span class="line">  ipFamily: ipv6</span><br><span class="line"><span class="comment"># networking:</span></span><br><span class="line">  <span class="comment"># apiServerAddress: &quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="comment"># apiServerPort: 6443</span></span><br><span class="line">EOF</span><br><span class="line">kind create cluster <span class="literal">--config</span> kind<span class="literal">-ipv6</span>.conf</span><br></pre></td></tr></table></figure>
<p>创建ipv4&#x2F;ipv6双栈集群执行如下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; kind<span class="literal">-dual-stack</span>.conf &lt;&lt;EOF</span><br><span class="line">kind: Cluster</span><br><span class="line">apiVersion: kind.x<span class="literal">-k8s</span>.io/v1alpha4</span><br><span class="line">name: dual<span class="literal">-stack</span></span><br><span class="line">networking:</span><br><span class="line">  ipFamily: dual</span><br><span class="line"><span class="comment"># networking:</span></span><br><span class="line">  <span class="comment"># apiServerAddress: &quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="comment"># apiServerPort: 6443</span></span><br><span class="line">EOF</span><br><span class="line">kind create cluster <span class="literal">--config</span> kind<span class="literal">-dual-stack</span>.conf</span><br></pre></td></tr></table></figure>
<h1 id="service网络"><a href="#service网络" class="headerlink" title="service网络"></a>service网络</h1><h2 id="spec定义"><a href="#spec定义" class="headerlink" title="spec定义"></a>spec定义</h2><p>k8s的service网络为了支持双栈，新增加了几个字段。</p>
<p>.spec.ipFamilies用来设置地址族，service一旦场景后该值不可认为修改，但可以通过修改.spec.ipFamilyPolicy来简介修改该字段的值。为数组格式，支持如下值：</p>
<ul>
<li>[“IPv4”]</li>
<li>[“IPv6”]</li>
<li>[“IPv4”,”IPv6”] （双栈）</li>
<li>[“IPv6”,”IPv4”] （双栈）</li>
</ul>
<p>上述数组中的第一个元素会决定.spec.ClusterIP中的字段。<br />​</p>
<p>.spec.ClusterIPs：由于.spec.ClusterIP的value为字符串，不支持同时设置ipv4和ipv6两个ip地址。因此又扩展出来了一个.spec.ClusterIPs字段，该字段的value为宿主元祖。在Headless类型的Service情况下，该字段的值为None。<br />​</p>
<p>.spec.ClusterIP：该字段的值跟.spec.ClusterIPs中的第一个元素的值保持一致。<br />​</p>
<p>.spec.ipFamilyPolicy支持如下值：</p>
<ul>
<li>SingleStack：默认值。会使用.spec.ipFamilies数组中配置的第一个协议来分配cluster ip。如果没有指定.spec.ipFamilies，会使用service-cluster-ip-range配置中第一个cidr中来配置地址。</li>
<li>PreferDualStack：如果 .spec.ipFamilies 没有设置，使用 k8s 集群默认的 ipFamily。</li>
<li>RequireDualStack：同时分配ipv4和ipv6地址。.spec.ClusterIP的值会从.spec.ClusterIPs选择第一个元素。</li>
</ul>
<h2 id="service配置场景"><a href="#service配置场景" class="headerlink" title="service配置场景"></a>service配置场景</h2><p>先创建如下的deployment，以便于后面试验的service可以关联到pod。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="未指定任何协议栈信息"><a href="#未指定任何协议栈信息" class="headerlink" title="未指定任何协议栈信息"></a>未指定任何协议栈信息</h3><p>在没有指定协议栈信息的Service，创建出来的service .spec.ipFamilyPolicy为SingleStack。同时会使用service-cluster-ip-range配置中第一个cidr中来配置地址。如果第一个cidr为ipv6，则service分配的clusterip为ipv6地址。创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>会生成如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.80</span><span class="number">.114</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.80</span><span class="number">.114</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定-spec-ipFamilyPolicy为PreferDualStack"><a href="#指定-spec-ipFamilyPolicy为PreferDualStack" class="headerlink" title="指定.spec.ipFamilyPolicy为PreferDualStack"></a>指定.spec.ipFamilyPolicy为PreferDualStack</h3><p>创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>提交到环境后会生成如下的service，可以看到.spec.clusterIPs中的ip地址跟ipFamilies中的顺序一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.221</span><span class="number">.70</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.221</span><span class="number">.70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:96::7d1</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>查看Endpoints，可以看到subsets中的地址为pod的ipv4协议地址。Endpoints中的地址跟service的.spec.ipFamilies数组中的第一个协议的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-vrfps</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16875&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">30a1d787-f799-4250-8c56-c96564ca9239</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-wgz72</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16917&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">8166d43e-2702-45c6-839e-b3005f44f647</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-x4lt5</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16896&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">f9c2968f-ca59-4ba9-a69f-358c202a964b</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>接下来指定.spec.ipFamilies的顺序再看一下执行的结果，创建如下的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>在环境中生成的service如下，可以看到.spec.clusterIPs中的顺序第一个为ipv6地址，.spec.clusterIP同样为ipv6地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">fd00:10:96::c306</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:96::c306</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.147</span><span class="number">.82</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">PreferDualStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>查看Endpoints，可以看到subsets中的地址为pod的ipv6协议地址。Endpoints中的地址跟service的.spec.ipFamilies数组中的第一个协议的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">MyApp</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::5</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-vrfps</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16875&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">30a1d787-f799-4250-8c56-c96564ca9239</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::6</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-wgz72</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16917&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">8166d43e-2702-45c6-839e-b3005f44f647</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::7</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-deployment-65b5dd4c68-x4lt5</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;16896&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">f9c2968f-ca59-4ba9-a69f-358c202a964b</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<h2 id="单栈和双栈之间的切换"><a href="#单栈和双栈之间的切换" class="headerlink" title="单栈和双栈之间的切换"></a>单栈和双栈之间的切换</h2><p>虽然.spec.ipFamilies字段不允许直接修改，但.spec.ipFamilyPolicy字段允许修改，但并不影响单栈和双栈之间的切换。<br />单栈变双栈只需要修改.spec.ipFamilyPolicy从SingleStack变为PreferDualStack或者RequireDualStack即可。<br />双栈同样可以变为单栈，只需要修改.spec.ipFamilyPolicy从PreferDualStack或者RequireDualStack变为SingleStack即可。此时.spec.ipFamilies会自动变更为一个元素，.spec.clusterIPs同样会变更为一个元素。</p>
<h2 id="LoadBalancer类型的Service"><a href="#LoadBalancer类型的Service" class="headerlink" title="LoadBalancer类型的Service"></a>LoadBalancer类型的Service</h2><p>对于LoadBalancer类型的Service，单栈的情况下，会在.status.loadBalancer.ingress设置vip地址。如果是ingress中的ip地址为双栈，此时应该是将双栈的vip地址同时写到.status.loadBalancer.ingress中，并且要保证其顺序跟serivce的.spec.ipFamilies中的顺序一致。</p>
<h1 id="pod网络"><a href="#pod网络" class="headerlink" title="pod网络"></a>pod网络</h1><p>pod网络要支持ipv6，需要容器网络插件的支持。为了支持ipv6特性，新增加了.status.podIPs字段，用来展示pod上分配的ipv4和ipv6的信息。.status.podIP字段的值跟.status.podIPs数组的第一个元素的值保持一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">pod-template-hash:</span> <span class="string">558bd4d5db</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns-558bd4d5db-b2zbj</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/coredns/Corefile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/coredns/coredns:v1.8.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9153</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">170Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">70Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-hgxnc</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">2000000000</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">Corefile</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">Corefile</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-hgxnc</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-16T12:51:24Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://6da36ab908291ca1b4141a86d70f8c2bb150a933336d852bcabe2118aa1a3439</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/coredns/coredns:v1.8.0</span></span><br><span class="line">    <span class="attr">imageID:</span> <span class="string">sha256:296a6d5035e2d6919249e02709a488d680ddca91357602bd65e605eac967b899</span></span><br><span class="line">    <span class="attr">lastState:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">restartCount:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">        <span class="attr">startedAt:</span> <span class="string">&quot;2022-01-16T12:51:27Z&quot;</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">  <span class="attr">podIP:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">  <span class="attr">podIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">fd00:10:244::3</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">Burstable</span></span><br><span class="line">  <span class="attr">startTime:</span> <span class="string">&quot;2022-01-16T12:51:24Z&quot;</span></span><br></pre></td></tr></table></figure>
<p>pod中要想获取到ipv4、ipv6地址，可以通过downward api的形式将.status.podIPs以环境变量的形式传递到容器中，在pod中通过环境变量获取到的格式为: <code>10.244.1.4,a00:100::4</code>。</p>
<h1 id="k8s-node"><a href="#k8s-node" class="headerlink" title="k8s node"></a>k8s node</h1><p>在宿主机上可以通过ip addr show eth0的方式来查看网卡上的ip地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip addr show eth0</span></span><br><span class="line"><span class="attr">23:</span> <span class="string">eth0@if24:</span> <span class="string">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> <span class="string">mtu</span> <span class="number">1500 </span><span class="string">qdisc</span> <span class="string">noqueue</span> <span class="string">state</span> <span class="string">UP</span> <span class="string">group</span> <span class="string">default</span></span><br><span class="line">    <span class="string">link/ether</span> <span class="number">02</span><span class="string">:42:ac:12:00:02</span> <span class="string">brd</span> <span class="string">ff:ff:ff:ff:ff:ff</span> <span class="string">link-netnsid</span> <span class="number">0</span></span><br><span class="line">    <span class="string">inet</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span><span class="string">/16</span> <span class="string">brd</span> <span class="number">172.18</span><span class="number">.255</span><span class="number">.255</span> <span class="string">scope</span> <span class="string">global</span> <span class="string">eth0</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br><span class="line">    <span class="string">inet6</span> <span class="string">fc00:f853:ccd:e793::2/64</span> <span class="string">scope</span> <span class="string">global</span> <span class="string">nodad</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br><span class="line">    <span class="string">inet6</span> <span class="string">fe80::42:acff:fe12:2/64</span> <span class="string">scope</span> <span class="string">link</span></span><br><span class="line">       <span class="string">valid_lft</span> <span class="string">forever</span> <span class="string">preferred_lft</span> <span class="string">forever</span></span><br></pre></td></tr></table></figure>
<p>宿主机的网卡上有ipv6地址，k8s node上的.status.addresses中有所体现，type为InternalIP即包含了ipv4地址，又包含了ipv6地址，但此处并没有字段标识当前地址为ipv4，还是ipv6。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Node</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.alpha.kubernetes.io/cri-socket:</span> <span class="string">unix:///run/containerd/containerd.sock</span></span><br><span class="line">    <span class="attr">node.alpha.kubernetes.io/ttl:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">volumes.kubernetes.io/controller-managed-attach-detach:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">kubernetes.io/arch:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/control-plane:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">node.kubernetes.io/exclude-from-external-load-balancers:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podCIDR:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">podCIDRs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">fd00:10:244::/64</span></span><br><span class="line">  <span class="attr">providerID:</span> <span class="string">kind://docker/dual-stack/dual-stack-control-plane</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">fc00:f853:ccd:e793::2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">InternalIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">dual-stack-control-plane</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Hostname</span></span><br><span class="line">  <span class="attr">allocatable:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">15936568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">ephemeral-storage:</span> <span class="string">41152812Ki</span></span><br><span class="line">    <span class="attr">hugepages-1Gi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">hugepages-2Mi:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">15936568Ki</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;110&quot;</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastHeartbeatTime:</span> <span class="string">&quot;2022-01-16T15:01:48Z&quot;</span></span><br><span class="line">    <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-01-16T12:50:54Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">kubelet</span> <span class="string">has</span> <span class="string">sufficient</span> <span class="string">memory</span> <span class="string">available</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">KubeletHasSufficientMemory</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">MemoryPressure</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">daemonEndpoints:</span></span><br><span class="line">    <span class="attr">kubeletEndpoint:</span></span><br><span class="line">      <span class="attr">Port:</span> <span class="number">10250</span></span><br><span class="line">  <span class="attr">images:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s.gcr.io/kube-proxy:v1.21.1</span></span><br><span class="line">    <span class="attr">sizeBytes:</span> <span class="number">132714699</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">nodeInfo:</span></span><br><span class="line">    <span class="attr">architecture:</span> <span class="string">amd64</span></span><br><span class="line">    <span class="attr">bootID:</span> <span class="string">7f95abb9-7731-4a8c-9258-4a91cdcfb2ca</span></span><br><span class="line">    <span class="attr">containerRuntimeVersion:</span> <span class="string">containerd://1.5.2</span></span><br><span class="line">    <span class="attr">kernelVersion:</span> <span class="number">4.18</span><span class="number">.0</span><span class="number">-305.</span><span class="string">an8.x86_64</span></span><br><span class="line">    <span class="attr">kubeProxyVersion:</span> <span class="string">v1.21.1</span></span><br><span class="line">    <span class="attr">kubeletVersion:</span> <span class="string">v1.21.1</span></span><br><span class="line">    <span class="attr">machineID:</span> <span class="string">8f6a98bffc184893ab6bc260e705421b</span></span><br><span class="line">    <span class="attr">operatingSystem:</span> <span class="string">linux</span></span><br><span class="line">    <span class="attr">osImage:</span> <span class="string">Ubuntu</span> <span class="number">21.04</span></span><br><span class="line">    <span class="attr">systemUUID:</span> <span class="string">f7928fdb-32be-4b6e-8dfd-260b6820f067</span></span><br></pre></td></tr></table></figure>
<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p>Ingress 可以通过开关 <code>disable-ipv6</code> 来控制是否开启 ipv6，默认 ipv6 开启。</p>
<p>在开启 ipv6 的情况下，如果 nginx ingress 的 pod 本身没有ipv6 的 ip地址，则在 nginx 的配置文件中并不会监听 ipv6 的端口号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listen 80  ;</span><br><span class="line">listen 443  ssl http2 ;</span><br></pre></td></tr></table></figure>

<p>如果 nginx ingress 的 pod 本身包含 ipv6 地址，则 nginx 的配置文件如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen 80  ;</span><br><span class="line">listen [::]:80  ;</span><br><span class="line">listen 443  ssl http2 ;</span><br><span class="line">listen [::]:443  ssl http2 ;</span><br></pre></td></tr></table></figure>





<p>参考资料：</p>
<ul>
<li>阿里云ACK的Nginx Ingress支持ipv6特性：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/378167.html">https://help.aliyun.com/document_detail/378167.html</a></li>
<li>[Nginx Ingress 支持 ipv6](<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#disable-ipv6">ConfigMap - NGINX Ingress Controller (kubernetes.github.io)</a>)</li>
</ul>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/dual-stack/">https://kubernetes.io/docs/concepts/services-networking/dual-stack/</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/network/validate-dual-stack/">https://kubernetes.io/docs/tasks/network/validate-dual-stack/</a></li>
<li><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/configuration/">https://kind.sigs.k8s.io/docs/user/configuration/</a></li>
</ul>
<br />

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
