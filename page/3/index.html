<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/3/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">256</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/watch-tv-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/watch-tv-2/" class="post-title-link" itemprop="url">将树莓派 5 打造成 Android TV 电视盒子折腾记 （2）- 遥控器的配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-24 00:41:46" itemprop="dateCreated datePublished" datetime="2024-02-24T00:41:46+00:00">2024-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在前序文章中，实现了将树莓派 5 刷成了 Android TV 电视盒子，基本的功能已经完备，本文将来介绍如何使用遥控器来控制 Android TV。</p>
<ul>
<li><a href="http://kuring.me/post/watch-tv/">我要看电视 - 投影仪和电视盒子选型</a></li>
<li><a href="http://kuring.me/post/pi5-1/">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a></li>
</ul>
<p>树莓派的定位是用作小型计算机使用，而作为电视盒子却必须要具备遥控器来控制的功能。要想通过遥控器来控制树莓派有多种方式可供选择，下面列一下我自己尝试过的方案。</p>
<h1 id="使用手机遥控-Android-TV"><a href="#使用手机遥控-Android-TV" class="headerlink" title="使用手机遥控 Android TV"></a>使用手机遥控 Android TV</h1><p>这是最简单成本最低的纯软方案，只要在手机上安装软件就可以来控制 Android TV 了，手机跟 Android TV 在同一个局域网下即可。我使用到了 IOS 上的 App <code>Remote TV</code>，软件免费，但有广告。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-1.png" alt="IMG_2890.PNG"><br />使用上功能完备，比如开关 Android TV 的功能也是完备的。Android TV 的关系操作并非真正的关机，实际上还是在低功耗运行，网络还是可以连接的。也就意味着通过 App 实际上是可以开机的。<br />不方便的地方在于，每次操作需要额外拿起手机打开 App 后才能操作，没有硬件的遥控器来的方便。</p>
<h1 id="使用投影仪的遥控器"><a href="#使用投影仪的遥控器" class="headerlink" title="使用投影仪的遥控器"></a>使用投影仪的遥控器</h1><p>我使用了爱普生的 TZ2800 投影仪作为播放设备，投影仪的 HDMI 已经支持了 HDMI CEC 功能。这里吐槽下传统企业爱普生，在<a target="_blank" rel="noopener" href="https://www.epson.com.cn/Apps/tech_support/SupportProduct.aspx?p=32158">官方产品页面</a>中很难找到关于该款投影仪的 HDMI 是否支持 CEC 的介绍，或者存在某个地方，但总归我找不到。</p>
<p>HDMI CEC（Consumer Electronics Control） 功能可以实现通过 HDMI 连接让多个设备之间相互控制，可以实现同一个遥控器来控制投影仪和 Android TV 的功能：</p>
<ol>
<li>当关闭投影仪的时候也可以关闭 Android TV。</li>
<li>当打开投影仪的时候可以打开 Android TV。</li>
</ol>
<p>要想使用 HDMI CEC 功能，需要在 Android TV 系统中开启相关的功能。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-2.png" alt="IMG_2893.HEIC"><br />下面的界面用来选择 HDMI CEC 的支持接口，只能支持一个 HDMI 接口。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-3.png" alt="IMG_2894.HEIC"></p>
<p>由于跟投影仪共用一个遥控器，功能上还是有所受限。比如音量的大小功能，只能操作投影仪，而不能再设置 Android TV 的音量大小。但绝大多数的功能已经具备。</p>
<h1 id="使用蓝牙遥控器"><a href="#使用蓝牙遥控器" class="headerlink" title="使用蓝牙遥控器"></a>使用蓝牙遥控器</h1><p>家里正巧有个办移动宽带送的电视盒子，该遥控器为蓝牙遥控器。在遥控器的背面正巧有蓝牙配对的方法。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-4.png" alt="IMG_2891.HEIC"><br /><br>打开 Android Tv 系统中的 <code>设置</code> -&gt; <code>系统</code> -&gt; <code>遥控器和手柄</code> 功能。同时按住菜单键和返回键即可蓝牙配对。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-5.png" alt="IMG_2892.HEIC"><br /><br>蓝牙配对成功后，使用过程中功能正常。但发现个致命的缺点：蓝牙会自动断开，而且无法自动连接，下次只能重新配对。我不太确定是否为遥控器的问题，但单这一点已经否定了我使用蓝牙遥控器的方案。</p>
<h1 id="使树莓派设备支持遥控器控制"><a href="#使树莓派设备支持遥控器控制" class="headerlink" title="使树莓派设备支持遥控器控制"></a>使树莓派设备支持遥控器控制</h1><p>树莓派通过 24 个 GPIO 引脚提供了强大的扩展性，可以接入外部硬件设备来接收遥控器的信号。<br />我们来了解下常见的遥控器的实现原理：</p>
<ol>
<li>红外遥控器：最为普遍的遥控器，使用红外线发射信号，接收端需要有对应的红外接收模块。在发射信号时需要对准接收端。</li>
<li>无线遥控器：通常采用了 2.4 GHz 无线频段作为传输介质，接收端需要有可以匹配的设备接收信号，比如很多无线鼠标提供了一个很小的 USB 接收端。</li>
<li>蓝牙遥控器：使用蓝牙技术通讯，而蓝牙技术同样采用了 2.4 GHz 的无线频段，但好处在于很多的设备都支持蓝牙协议，不需要接收端再有一个定制化的硬件。</li>
</ol>
<h2 id="接收红外信号"><a href="#接收红外信号" class="headerlink" title="接收红外信号"></a>接收红外信号</h2><p>我家里正巧有几个废弃的红外遥控器，因此可以作为树莓派的遥控器来使用。剩下的事情首先需要树莓派通过 GPIO 引脚接收到红外信号。<br />在万能的淘宝上，花了几块钱买到了红外接收器和杜邦线（用来连接红外接收头和 GPIO 引脚），杜邦线需要注意为母对母规格。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-6.png" alt="image.png"><br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-7.png" alt="image.png"></p>
<h2 id="红外接收器连接到树莓派"><a href="#红外接收器连接到树莓派" class="headerlink" title="红外接收器连接到树莓派"></a>红外接收器连接到树莓派</h2><p>在默认情况下，树莓派 GPIO 引脚的功能并未开启。打开 Android TV 系统中的 <code>Raspberry Pi settings</code> -&gt; <code>IR</code> -&gt; <code>Infrared remote</code>开关。可以看到接收信号的为 GPIO 18 引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-8.png" alt="IMG_2887.HEIC"><br /></p>
<p>在红外接收器上包含了三个引脚，依次为：OUT（输出信号）、GND（接地信号）、VCC（工作电压），其中红外接收器的 OUT 引脚对应的 GPIO 18 引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-9.png" alt="image.png"><br /><br>树莓派提供了 3.3V 和 5V 两种工作电压，查看红外信号接收器的工作电压在 2.7V ~ 5.5V 之间，我直接使用了 GPIO 的 5V 的引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-10.png" alt="image.png"><br />查看树莓派的各个引脚线路图：<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-11.png" alt="来源：https://pinout.vvzero.com/" title="来源：https://pinout.vvzero.com/"><br />即可得到红外信号接收器跟 GPIO 引脚的对应关系：</p>
<table>
<thead>
<tr>
<th>红外信号接收器引脚</th>
<th>GPIO 引脚</th>
</tr>
</thead>
<tbody><tr>
<td>OUT</td>
<td>18</td>
</tr>
<tr>
<td>GND</td>
<td>9（就近原则）</td>
</tr>
<tr>
<td>VCC</td>
<td>2（4 和 6 被风扇电源占用）</td>
</tr>
</tbody></table>
<p>在将硬件连接好后就可以启动树莓派了。</p>
<h2 id="遥控器编码配对"><a href="#遥控器编码配对" class="headerlink" title="遥控器编码配对"></a>遥控器编码配对</h2><p>家里可能有多个红外遥控器，那么为什么红外遥控器之间不会出现相互冲突，本来想打开电视，却打开了空调的情况呢？原因是红外遥控器上的每个按键都对应了一个编码，而不同设备的遥控器对应的编码是不同的。电视遥控器发出的开机信号虽然被空调接收到了，但是并不会对该按键的编码做处理，空调也就不会被开机。<br />我从家里随便找了一个红外遥控器也就不可能直接用来控制 Android TV 了，因此需要让 Android TV 可以识别到我的红外遥控器对应的按键编码。<br />要想识别到红外遥控器的编码，需要使用到 Android TV 系统中命令行工具 <code>ir-keytable</code>，需要以 ssh 的方式连接 Android TV。Android TV 的连接方式可以参考我之前文章《<a href="http://kuring.me/post/pi5-1/">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a>》中的 SSH 章节部分。</p>
<p>在命令行执行 <code>ir-keytable -p all -t</code>，并按下遥控器的按键，在命令行中可以获取到类似如下的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">991.988018: lirc protocol(necx): scancode = 0x835590</span><br><span class="line">991.988023: event type EV_MSC(0x04): scancode = 0x835590</span><br><span class="line">991.988023: event type EV_SYN(0x00).</span><br><span class="line"></span><br><span class="line">992.104019: lirc protocol(necx): scancode = 0x835590</span><br><span class="line">992.104025: event type EV_MSC(0x04): scancode = 0x835590</span><br><span class="line">992.104025: event type EV_SYN(0x00).</span><br></pre></td></tr></table></figure>
<p>其中 916.968014 表示的事件发生的时间戳。necx 表示使用的为 NEC 扩展协议，NEC 为一种常见的红外编码协议。而 scancode 字段即为我们需要获取的按键编码。EV_SYN 表示一组时间的结束。<br />在上面的命令中，按下遥控器的按键一次，发送出了两个相同信号，也就打印出了两个相同日志块。</p>
<p>打开 Github 项目：<a target="_blank" rel="noopener" href="https://github.com/lineage-rpi/android_external_ir-keytable/tree/lineage-18.1/rc_keymaps">https://github.com/lineage-rpi/android_external_ir-keytable&#x2F;tree&#x2F;lineage-18.1&#x2F;rc_keymaps</a>，可以看到里面有很多编码跟对应键之间的映射关系，因为我的红外遥控器没有数字键，我挑选了一个跟遥控器键比较相似的文件进行重新修改，将其中的编码修改我遥控器对应的编码，并保存到本地文件 rc_keymap.txt 中。我的文件类似如下，其中 KEY_PREVIOUSSONG 和 KEY_PLAYPAUSE 两个按键我的遥控器上没有，我这里未做修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># table allwinner_ba10_tv_box, type: NEC</span><br><span class="line">0x646dca KEY_UP</span><br><span class="line">0x646d81 KEY_VOLUMEDOWN</span><br><span class="line">0x217 KEY_NEXTSONG</span><br><span class="line">0x646ddc KEY_POWER</span><br><span class="line">0x646dc5 KEY_BACK</span><br><span class="line">0x646dce KEY_OK</span><br><span class="line">0x646dd2 KEY_DOWN</span><br><span class="line">0x646d80 KEY_VOLUMEUP</span><br><span class="line">0x254 KEY_PREVIOUSSONG</span><br><span class="line">0x255 KEY_PLAYPAUSE</span><br><span class="line">0x646d82 KEY_MENU</span><br><span class="line">0x646d88 KEY_HOMEPAGE</span><br><span class="line">0x646dc1 KEY_RIGHT</span><br><span class="line">0x646d99 KEY_LEFT</span><br></pre></td></tr></table></figure>
<p>需要注意的是，第一行看似是个注释，实际不是，不要删掉，保留原文件中的格式不变。</p>
<h2 id="Android-TV-系统开机时加载配置"><a href="#Android-TV-系统开机时加载配置" class="headerlink" title="Android TV 系统开机时加载配置"></a>Android TV 系统开机时加载配置</h2><p>有了遥控器按键和编码之间的映射关系后，需要将其放到 Android TV 系统的 <code>/boot/rc_keymap.txt</code> 文件中，让 Android TV 开启自动加载该配置。该文件默认情况下不存在需要创建。</p>
<p>分区 &#x2F;boot 默认为只读模式，不允许在其中增加文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127|:/boot # echo &quot;123&quot; &gt; aa</span><br><span class="line">sh: can&#x27;t create aa: Read-only file system</span><br></pre></td></tr></table></figure>

<p>将 &#x2F;boot 目录重新 mount 为读写模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mount  | grep &#x27;/boot &#x27;</span><br><span class="line">/dev/block/mmcblk0p1 on /boot type vfat (ro,relatime,fmask=0000,dmask=0000,allow_utime=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro)</span><br><span class="line"></span><br><span class="line">$ mount -o remount,rw /boot</span><br><span class="line"></span><br><span class="line">$ mount  | grep &#x27;/boot &#x27;</span><br><span class="line">/dev/block/mmcblk0p1 on /boot type vfat (rw,relatime,fmask=0000,dmask=0000,allow_utime=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro)</span><br></pre></td></tr></table></figure>

<p>创建并将配置写入到文件 &#x2F;boot&#x2F;rc_keymap.txt 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /boot/rc_keymap.txt</span><br><span class="line"># table allwinner_ba10_tv_box, type: NEC</span><br><span class="line">0x646dca KEY_UP</span><br><span class="line">0x646d81 KEY_VOLUMEDOWN</span><br><span class="line">0x217 KEY_NEXTSONG</span><br><span class="line">0x646ddc KEY_POWER</span><br><span class="line">0x646dc5 KEY_BACK</span><br><span class="line">0x646dce KEY_OK</span><br><span class="line">0x646dd2 KEY_DOWN</span><br><span class="line">0x646d80 KEY_VOLUMEUP</span><br><span class="line">0x254 KEY_PREVIOUSSONG</span><br><span class="line">0x255 KEY_PLAYPAUSE</span><br><span class="line">0x646d82 KEY_MENU</span><br><span class="line">0x646d88 KEY_HOMEPAGE</span><br><span class="line">0x646dc1 KEY_RIGHT</span><br><span class="line">0x646d99 KEY_LEFT</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>重新将 &#x2F;boot 分区挂载为只读模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount,ro /boot</span><br></pre></td></tr></table></figure>

<p>在执行完后，重新启动系统。在顺利的情况下，即可以通过红外遥控器直接操作 Android TV 系统。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到目前为止，我主要在使用的方式为红外遥控器模式，毕竟一个电视盒子还是应该有属于自己的遥控器。Good Luck！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/numa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/numa/" class="post-title-link" itemprop="url">numa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-21 18:04:26" itemprop="dateCreated datePublished" datetime="2024-02-21T18:04:26+00:00">2024-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>随着处理器数量的增加，所有的处理器均通过同一个北桥来访问内存，导致内存访问延迟增加，内存带宽成为瓶颈。</p>
<p>NUMA（Non-Uniform Memory Access）非统一内存访问，是一种针对多处理器系统的组织结构。处理器被分配到不同的节点，每个节点有自己的本地内存，处理器可以访问本地内存和其他节点的内存，但访问本地内存的速度要远远快于访问其他节点的内存。</p>
<p>几个概念：</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/numa.jpg"></p>
<ol>
<li>Socket：一颗物理 CPU。</li>
<li>Numa Node：逻辑概念，对 CPU 分组的抽象，一个 Node 即为一个分组，一个分组下可以包含多个 CPU。每个 Node 都有自己的本地资源，包括内存和 IO。Numa Node 之间不共享 L3 cache。一个 Numa Node 内的不同 core 之间共享 L3.</li>
<li>Core：一颗物理 CPU 的物理核，每个 Core 有独立的 L1 和 L2，Core 之间共享 L3。</li>
<li>Thread&#x2F;Processor：一颗物理 CPU 的逻辑核，用超线程的方式模拟出两个逻辑核。Processor 之间共享 L1 和 L2 cache，在开启超线程后单核的性能会下降一些。</li>
</ol>
<p>一个 NUMA Node 可以有一个 Socket，每个 Socket 包含一个或者多个物理 Core。</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p>查看物理核数 Socket：<code>lscpu | grep Socket</code><br>每个 Socket 包含的物理核 Core：<code>lscpu  | grep &#39;Core(s) per socket&#39;</code><br>每个 Socket 包含的 Thead&#x2F;Processor 数量：<code>lscpu  | grep &#39;Thread(s) per core&#39;</code><br>查看所有的 Processor 数量：<code>cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numactl</span> <span class="string">--hardware</span></span><br><span class="line"><span class="attr">available:</span> <span class="number">4</span> <span class="string">nodes</span> <span class="string">(0-3)</span></span><br><span class="line"><span class="attr">node 0 cpus:</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span></span><br><span class="line"><span class="attr">node 0 size:</span> <span class="number">128470</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 0 free:</span> <span class="number">88204</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 1 cpus:</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">40</span> <span class="number">41</span> <span class="number">42</span> <span class="number">43</span> <span class="number">44</span> <span class="number">45</span> <span class="number">46</span> <span class="number">47</span></span><br><span class="line"><span class="attr">node 1 size:</span> <span class="number">129019</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 1 free:</span> <span class="number">67982</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 2 cpus:</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">48</span> <span class="number">49</span> <span class="number">50</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span> <span class="number">54</span> <span class="number">55</span></span><br><span class="line"><span class="attr">node 2 size:</span> <span class="number">129019</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 2 free:</span> <span class="number">38304</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 3 cpus:</span> <span class="number">24</span> <span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span> <span class="number">31</span> <span class="number">56</span> <span class="number">57</span> <span class="number">58</span> <span class="number">59</span> <span class="number">60</span> <span class="number">61</span> <span class="number">62</span> <span class="number">63</span></span><br><span class="line"><span class="attr">node 3 size:</span> <span class="number">128965</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 3 free:</span> <span class="number">45689</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node distances:</span></span><br><span class="line"><span class="string">node</span>   <span class="number">0</span>   <span class="number">1</span>   <span class="number">2</span>   <span class="number">3</span></span><br><span class="line">  <span class="attr">0:</span>  <span class="number">10</span>  <span class="number">16</span>  <span class="number">28</span>  <span class="number">22</span></span><br><span class="line">  <span class="attr">1:</span>  <span class="number">16</span>  <span class="number">10</span>  <span class="number">22</span>  <span class="number">28</span></span><br><span class="line">  <span class="attr">2:</span>  <span class="number">28</span>  <span class="number">22</span>  <span class="number">10</span>  <span class="number">16</span></span><br><span class="line">  <span class="attr">3:</span>  <span class="number">22</span>  <span class="number">28</span>  <span class="number">16</span>  <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>如果没有开启 numa，默认只会看到一个 node，类似如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numactl</span> <span class="string">--hardware</span></span><br><span class="line"><span class="attr">available:</span> <span class="number">1</span> <span class="string">nodes</span> <span class="string">(0)</span></span><br><span class="line"><span class="attr">node 0 cpus:</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">24</span> <span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">40</span> <span class="number">41</span> <span class="number">42</span> <span class="number">43</span> <span class="number">44</span> <span class="number">45</span> <span class="number">46</span> <span class="number">47</span> <span class="number">48</span> <span class="number">49</span> <span class="number">50</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span> <span class="number">54</span> <span class="number">55</span> <span class="number">56</span> <span class="number">57</span> <span class="number">58</span> <span class="number">59</span> <span class="number">60</span> <span class="number">61</span> <span class="number">62</span> <span class="number">63</span></span><br><span class="line"><span class="attr">node 0 size:</span> <span class="number">772904</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 0 free:</span> <span class="number">510590</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node distances:</span></span><br><span class="line"><span class="string">node</span>   <span class="number">0</span></span><br><span class="line">  <span class="attr">0:</span>  <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>通过 numastat 命令可以看到 numa 的 miss 等情况，对于排查性能问题非常有帮助。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numastat</span></span><br><span class="line">                           <span class="string">node0</span>           <span class="string">node1</span>           <span class="string">node2</span>           <span class="string">node3</span></span><br><span class="line"><span class="string">numa_hit</span>              <span class="number">6010986094</span>      <span class="number">3863188690</span>      <span class="number">7861549559</span>      <span class="number">9798877648</span></span><br><span class="line"><span class="string">numa_miss</span>                      <span class="number">0</span>               <span class="number">0</span>       <span class="number">113102530</span>               <span class="number">0</span></span><br><span class="line"><span class="string">numa_foreign</span>                   <span class="number">0</span>               <span class="number">0</span>               <span class="number">0</span>       <span class="number">113102530</span></span><br><span class="line"><span class="string">interleave_hit</span>             <span class="number">17976</span>           <span class="number">17846</span>           <span class="number">17965</span>           <span class="number">17839</span></span><br><span class="line"><span class="string">local_node</span>            <span class="number">6010748681</span>      <span class="number">3862984578</span>      <span class="number">7861301902</span>      <span class="number">9798751537</span></span><br><span class="line"><span class="string">other_node</span>                <span class="number">237411</span>          <span class="number">204112</span>       <span class="number">113350178</span>          <span class="number">126111</span></span><br></pre></td></tr></table></figure>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://ctimbai.github.io/2018/05/03/tech/linux/cpu/CPU%E6%8B%93%E6%89%91%E4%BB%8ESMP%E8%B0%88%E5%88%B0NUMA%EF%BC%88%E7%90%86%E8%AE%BA%E7%AF%87%EF%BC%89/">CPU 拓扑：从 SMP 谈到 NUMA （理论篇）</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/pi5-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/pi5-1/" class="post-title-link" itemprop="url">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-17 11:23:07" itemprop="dateCreated datePublished" datetime="2024-02-17T11:23:07+00:00">2024-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在上一篇文章 《<a href="/post/watch-tv/">我要看电视 - 投影仪和电视盒子选型</a>》中，提到了用树莓派 5 来作为电视盒子，需要刷 Android TV 系统，本文将详细介绍折腾经历。<br>在这之前我并没有接触过树莓派，Android 系统倒是曾经刷过机，但也了解不深。文中如有不正确的地方，欢迎指正。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>要想折腾树莓派，还是需要一点点设备，我使用到的设备清单如下：</p>
<ol>
<li>一台 Mac 笔记本电脑：用来下载镜像、烧录景象、远程连接电视盒子等。其他操作系统的电脑均可。</li>
<li>一个 32G SD 卡：用来作为树莓派的存储系统 RAM。</li>
<li>一个 SD 读卡器：用来读取 SD 卡，供电脑烧录系统使用。</li>
<li>一个 U 盘：该 U 盘并非树莓派的 SD 卡，而是作为树莓派的额外存储，用来向树莓派中复制文件。</li>
<li>一台显示器：用来显示树莓派的内容，也可以是电视或者投影仪等设备。</li>
<li>一个 USB 键盘：用来连接树莓派进行操作。</li>
<li>一个 USB 鼠标：用来连接树莓派进行操作。</li>
<li>一个蓝牙遥控器：用来连接树莓派的 Android TV 系统。我直接使用了家里办宽带送的移动电视盒子的遥控器。</li>
<li>一根 HDMI 数据线：其中一头为 Micro HDMI，用来连接树莓派，另外一头为标准 HDMI 口，用来连接显示器。</li>
</ol>
<p>另外：</p>
<ol>
<li>网络需要能够访问 Google 等网站。</li>
</ol>
<h1 id="寻找-Android-TV-系统"><a href="#寻找-Android-TV-系统" class="headerlink" title="寻找 Android TV 系统"></a>寻找 Android TV 系统</h1><p>找到树莓派对应的 Android TV 镜像是非常重要的前提，找到合适的 ROM 永远是 Android 系统刷机中非常重要的一环，一般每个设备总有那么几个大神在提供各类 ROM。<br>查找一个设备的资源最快的方式就是去 github.com 上查找 awesome，树莓派的项目地址为：<a target="_blank" rel="noopener" href="https://github.com/thibmaek/awesome-raspberry-pi">awesome-raspberry-pi</a>。在 OS Images 章节中包含了支持树莓派的多种 OS，单纯搜索 Android TV 并不能找到对应的 OS，但实际上 <a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi4/">KonstaKANG</a> 对应就是 Android 镜像，这是文档不好的地方，并没有将简介写清楚。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-1.png" alt="image.png"></p>
<p><a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi4/">KonstaKANG</a> 并非一个系统，而是一个网站，包含了多种设备的 OS 镜像。对应的 <a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/">Raspberry 5</a> 的页面包含了 AOSP 和 LineageOS 两种 OS 镜像，AOSP 和 LineageOS 均为 android 的发型版。但只提供了 LineageOS 20 一个 Android TV 的版本，剩下的两个为 Android 版本。Android TV 和 Android 并非同一个系统，Android TV 是针对电视使用的系统，而 Android 是针对智能手机和平板使用的系统，用户体验上还是有较大区别。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-2.png" alt="image.png"><br>因此，<a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/LineageOS20-ATV/">LineageOS 20 Android TV (Android 13) </a>即变为了目前唯一一个可以在树莓派 5 上使用 Android TV 系统，除此之外，别无他选。无论该系统是否完善，这就是目前的唯一选择了。在文章中介绍了非常多的系统方面的支持，建议精读一遍，包括文章后面的评论。<br>文中的两个镜像，一个是原始镜像，另外一个是 ota 补丁包，两个均需要安装。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-3.png" alt="image.png"></p>
<h1 id="用到的文件"><a href="#用到的文件" class="headerlink" title="用到的文件"></a>用到的文件</h1><p>由于在国内下载非常不稳定，通常需要魔法下载，我将需要用到的文件上传到云盘供下载使用。我对部分软件的用途一知半解，但我知道安装了应该没有坏处，选择全部安装。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1pgGB_h2bUhq9iUXHrosW9w?pwd=rgad">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv.zip</a> 提取码：rgad</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/15RAKHM2q6pOGSt0a8jfJUg?pwd=3t4m">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv-ota.zip</a> 提取码: 3t4m</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1HWv0P22uAH2eavIycuaf1A?pwd=33wj">MindTheGapps-13.0.0-arm64-ATV-full-20240104_210039.zip</a> 提取码：33wj</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1z0NcAlssVKPwav7RZTIUNg?pwd=c6ja">lineage-20.0-rpi-resize.zip</a> 提取码：c6ja</li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=14871746926876846664#google_vignette">lineage-20.0-rpi-magisk-v25.2.zip</a></li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=11701882489785033173">lineage-20.0-rpi-widevine.zip</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk/releases/tag/v25.2">Magisk-v25.2.apk</a></li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=11701882489785033172">lineage-20.0-rpi-gsfaid.zip</a></li>
</ul>
<h1 id="刷-LineageOS-到树莓派"><a href="#刷-LineageOS-到树莓派" class="headerlink" title="刷 LineageOS 到树莓派"></a>刷 LineageOS 到树莓派</h1><p>树莓派官方提供了镜像烧录工具 <a target="_blank" rel="noopener" href="https://www.raspberrypi.com/software/">Imager</a>，支持 Windows、Ubuntu、Mac，刷机非常方便。<img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/imager.png" alt="image.png"><br>将树莓派的 SD 插入到电脑，在 <code>Raspberry Pi Device</code> 中选择 <code>RASPBERRY PI 5</code>，在<code>请选择需要写入的操作系统</code>中使用 <code>Use custom</code> 选项选择已经下载好的文件 lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv.zip，选择对应的 SD 卡，再点击 <code>Next</code> 即可开始将镜像写入到SD 卡中。<br>值得一提的是，对于树莓派其他的系统，都不需要事先下载，选择系统后，该工具可以自动下载最新版本，这个功能还是非常值得👍。</p>
<h1 id="LineageOS-初步体验及初步设置"><a href="#LineageOS-初步体验及初步设置" class="headerlink" title="LineageOS 初步体验及初步设置"></a>LineageOS 初步体验及初步设置</h1><p>在将系统刷入 SD 卡后，即可将 SD 卡放到树莓派 5 中，在树莓派中连接好键盘和鼠标。<br>下面步骤中可能会用到键盘的一些快捷键：F1 &#x3D; Home, F2 &#x3D; Back, F3 &#x3D; Multi-tasking, F4 &#x3D; Menu, F5 &#x3D; Power, F11 &#x3D; Volume down, and F12 &#x3D; Volume up<br>开机后即可看到 LineageOS 的开机动画。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-1.png" alt="image.png"></p>
<p>接下来就会看到查找蓝牙设备的界面，这里可以选择等待一会后自动跳过。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-2.png" alt="image.png"></p>
<p>接下来就来到了 Welcome 的界面，点击 <code>Start</code>。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-3.png" alt="image.png"></p>
<p>接下来会进入到选择语言、连接 WIFI 等操作，完成后即可进入到操作系统界面。操作系统界面可谓简洁到不能再精简，只有一个文件的应用。左上角的语音和搜索功能均不能使用。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-4.png" alt="image.png"></p>
<p>但设置功能作为 Android 系统的核心，这部分功能一点都不会少。在设置中连接  Wifi 后发现会持续断开，不知道是否为系统的问题。</p>
<p>打开 Recovery 模式：设置 -&gt; 系统 -&gt; Buttons，打开右侧的 Advanced restart。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-5.png" alt="image.png"></p>
<p>打开开发者模式：设置 -&gt; 系统 -&gt; 关于 -&gt; Android TV 操作系统版本，连续点击键盘的回车键，会提示开发者模式已打开。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-6.png" alt="image.png"></p>
<p>打开 Rooted debug：设置 -&gt; 系统 -&gt; 开发者选项 -&gt; 打开 <code>USB 调试</code>、<code>Rooted debugging</code>、<code>ADB over network</code> 三个选项。</p>
<p>打开树莓派的 SSH 服务：设置 -&gt; 系统 -&gt; Raspberry Pi Settings 中将 SSH 服务打开。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-7.png" alt="image.png"></p>
<h1 id="刷入-ota-包"><a href="#刷入-ota-包" class="headerlink" title="刷入 ota 包"></a>刷入 ota 包</h1><p>接下来选择刷入 OTA 包 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/15RAKHM2q6pOGSt0a8jfJUg?pwd=3t4m">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv-ota.zip</a>，ota 包不会用到树莓派镜像烧录器，而是要通过Android Recovery 模式刷入。需要事先准备好 OTA 包，并将其复制到 U 盘中，并将 U 盘插入到树莓派中。</p>
<p>在 Android 系统设置 -&gt; 系统 -&gt; 重新启动中选择 Recovery，此时系统会重启进入到 Recovery 模式。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-1.png" alt="image.png"></p>
<p>点击 <code>Install</code>，并选择右下角的 <code>Select Storage</code> 按钮，选择 USB 存储，即刚插入的 U 盘。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-2.png" alt="image.png"></p>
<p>在 U 盘中选择要刷入的 ota 补丁，取消 <code>Zip signature verification</code>。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-3.png" alt="image.png"></p>
<p>在 <code>Swipe to confirm Flash</code>处向右滑动鼠标，即可进入到安装 ota 补丁的界面。ota 补丁安装完成后，即可自动重启进入到 Android TV 系统中。重新进入系统后，发现系统的界面没有任何变化，不知道该 ota 补丁的具体影响功能。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-4.png" alt="image.png"></p>
<h1 id="系统存储空间设置"><a href="#系统存储空间设置" class="headerlink" title="系统存储空间设置"></a>系统存储空间设置</h1><p>在默认的情况下，打开设置 -&gt; 存储空间，可以看到内部共享存储空间仅为 4.7 GB，这里的存储空间为 &#x2F;data 目录挂载的设备，并没有将 U 盘的空间全部使用起来，U 盘剩余的磁盘空间处于未分配状态。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-8.png" alt="image.png"></p>
<p>这里使用 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1z0NcAlssVKPwav7RZTIUNg?pwd=c6ja">lineage-20.0-rpi-resize.zip</a> 工具来修改存储空间，按照刷入 ota 包相同的方式，进入 Recovery 模式下刷入该包，重新进入系统后即发现存储空间已经变大。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-9.png" alt="image.png"></p>
<h1 id="安装-adb-工具"><a href="#安装-adb-工具" class="headerlink" title="安装 adb 工具"></a>安装 adb 工具</h1><p>前置条件：开发者选项中的 ADB over network 必须为开启状态。</p>
<p>adb 命令需要安装到电脑上，在 mac 下使用 <code>brew install android-platform-tools</code>即可安装完成。</p>
<p>在 android tv 上查看当前的 ip 地址，我这里为 192.168.31.167。执行 <code>adb connect 192.168.31.167</code> 后即可获取到 USB 调试信息，并选中<code>一律允许使用这台计算机进行调试处</code>后点击允许。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-10.png" alt="image.png"><br>此时在终端中即可显示出连接成功的信息：<code>already connected to 192.168.31.167:5555</code>。</p>
<p>在安装完 adb 工具后，即可以通过 adb 命令来远程访问 Android TV 系统了。例如：</p>
<ul>
<li><code>adb install</code> 可以安装 apk 包。</li>
<li><code>adb shell settings list global</code> 命令来查看 Android 系统的所有global 配置。</li>
<li><code>adb logcat</code> 查看 android 的日志。</li>
</ul>
<h1 id="远程-ssh-连接"><a href="#远程-ssh-连接" class="headerlink" title="远程 ssh 连接"></a>远程 ssh 连接</h1><p>前置条件：</p>
<ol>
<li>ssh 连接需要首先在 <code>Raspberry Pi Settings</code> 中的 <code>Remote access</code> 中打开 SSH。</li>
<li><code>adb connect</code> 可以连接到 Android TV。</li>
</ol>
<p>在开启 SSH 服务后，ssh 连接需要使用对应的私钥信息，而私钥信息需要通过 adb 命令获取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb connect 192.168.31.166</span><br><span class="line">adb root</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可查看 /data/ssh 目录下的 ssh 秘钥信息</span></span><br><span class="line">adb shell ls /data/ssh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将秘钥信息放到本地</span></span><br><span class="line">adb pull /data/ssh/ssh_host_ed25519_key ~/.ssh/android_tv.key</span><br><span class="line">chmod 600 ~/.ssh/android_tv.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">成功 ssh 连接</span></span><br><span class="line">ssh -i ~/.ssh/android_tv.key root@192.168.31.166</span><br></pre></td></tr></table></figure>


<h1 id="安装-Google-Apps"><a href="#安装-Google-Apps" class="headerlink" title="安装 Google Apps"></a>安装 Google Apps</h1><blockquote>
<p>注意：此处要求网络具备魔法，可以访问 Google</p>
</blockquote>
<h2 id="刷入-Google-Apps-包"><a href="#刷入-Google-Apps-包" class="headerlink" title="刷入 Google Apps 包"></a>刷入 Google Apps 包</h2><p>Google Apps 包为必须用到的包，通过 Recovery 模式刷入包 <code>MindTheGapps-13.0.0-arm64-ATV-full-20240104_210039.zip</code>。包安装完成后，重新进入系统发现界面发生了变化，多出了应用 Google Play Store，左上角的语音和搜索功能虽然不可以用，但是点击后提示信息已经发生了变化。</p>
<blockquote>
<p>原来的文件应用在这里消失不见了，实际上在所有应用中还可以找到。</p>
</blockquote>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-11.png" alt="image.png"><br>在系统中使用 Google 账号登录 Google Play Store，即使在可以访问 Google 的网络下，发现也一直会失败。</p>
<h2 id="查询并注册-Android-ID"><a href="#查询并注册-Android-ID" class="headerlink" title="查询并注册 Android ID"></a>查询并注册 Android ID</h2><p>因为该 Android TV 设备并不被信任，需要将 Android ID 在 Android 网站注册。如果不注册，那么 Google 账号登录不成功。<br>将树莓派的 SD 卡插入到笔记本，查看 SD 卡中的文件 gsf-android_id.txt，该文件对应的内容即为 Android ID。<br>还有另外一种办法可以获取到 Android ID，在笔记本上通过 adb 命令查询到当前设备的 Android ID。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adb root</span><br><span class="line"># 找到 google service 的 sqlite3 数据库文件</span><br><span class="line">adb shell &#x27;find /data -name &quot;gservices.db&quot;&#x27;</span><br><span class="line"></span><br><span class="line"># 通过数据库查询到 android id</span><br><span class="line"># 其中 sqlite3 命令后的为上面步骤查询出的文件路径，如果查询出多个，可以任选一个</span><br><span class="line">adb shell &#x27;sqlite3 /data/data/com.google.android.gsf/databases/gservices.db &quot;select * from main where name = \&quot;android_id\&quot;;&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>将上述 Android ID 在网站进行注册，网址：<a target="_blank" rel="noopener" href="https://www.google.com/android/uncertified/">https://www.google.com/android/uncertified/</a><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-12.png" alt="image.png"></p>
<h2 id="使用-Google-账号登录"><a href="#使用-Google-账号登录" class="headerlink" title="使用 Google 账号登录"></a>使用 Google 账号登录</h2><p>重新进入 Recovery 模式，点击 Wipe -&gt; Factory reset，此时机器会进行重启。该操作会清空系统中的 &#x2F;data&#x2F;media 下的内容。(还不太清楚该步骤是否为必须操作)<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-13.png" alt="image.png"></p>
<p>机器重新后会重新进入一遍系统的初始化，但现在的初始化界面跟最初的 LineageOS 的初始化有所不同，进入到了 GMS 的开机引导，该步骤中必须要登录到 Google 账号，而且无法跳过。如果 Android ID 没有注册，此时登录 Google 账号一直会失败，导致无法进入到系统中。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-14.png" alt="image.png"></p>
<p>登录完成后在首页可以看到了更多的一些信息：<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-15.png" alt="image.png"></p>
<h1 id="通过-Recovery-刷入其他包"><a href="#通过-Recovery-刷入其他包" class="headerlink" title="通过 Recovery 刷入其他包"></a>通过 Recovery 刷入其他包</h1><p>widevine 是在 Android 生态下跟数字版权相关的包，通过 Recovery 模式刷入包 lineage-20.0-rpi-widevine.zip。</p>
<p>通过 Recovery 模式刷入包 lineage-20.0-rpi-magisk-v25.2.zip，进入到 Android TV 系统后通过文件工具安装包 Magisk-v25.2.apk。</p>
<h1 id="解决网络连接受限"><a href="#解决网络连接受限" class="headerlink" title="解决网络连接受限"></a>解决网络连接受限</h1><p>如果本地的网络无法访问 Google，默认情况下，网络会提示<code>网络连接受限</code>，原因主要还是跟访问不了 Google 的域名有关，以至于 Android TV 系统不能识别出可以连接互联网。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-16.png" alt="image.png"></p>
<p>网络连接受限状态的 WIFI，经测试机器重启后无法自动连接，需要每次都手工连接 WIFI。</p>
<p>执行如下的命令来系统进行设置：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">adb connect <span class="number">192.168</span>.<span class="number">31.166</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时间服务器</span></span><br><span class="line">adb shell settings put global ntp_server ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该值默认为 0</span></span><br><span class="line">adb shell settings put global captive_portal_detection_enabled <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认没有这两个值</span></span><br><span class="line">adb shell settings put global captive_portal_https_url https://connect.rom.miui.com/generate_204</span><br></pre></td></tr></table></figure>
<p>设置完成后重启系统，即可看到网络的连接受限已经消除，并且 WIFI 已经可以自动连接了。</p>
<h1 id="常用-apk-软件安装"><a href="#常用-apk-软件安装" class="headerlink" title="常用 apk 软件安装"></a>常用 apk 软件安装</h1><p>我这里使用了 <a target="_blank" rel="noopener" href="https://kxsw.gitbook.io/tv/">https://kxsw.gitbook.io/tv/</a> 中的方法安装了 File Commands 和 Clash 软件。File Commands  可以用来管理本地的文件，甚至可以提供 HTTP Server，供远程来下载或者上传文件。<br>国内的常见应用在 Google Play Store 中并不存在，而且通过 Google Play Store 直接安装应用很可能会失败，跟使用的网络有很大关系。国内的应用我直接使用了当贝市场来安装电视应用即可。</p>
<h1 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h1><h2 id="听不到声音"><a href="#听不到声音" class="headerlink" title="听不到声音"></a>听不到声音</h2><p>在播放视频时发现听不到声音，原因是因为默认情况下使用了 hdmi0 接口来输入声音，通过 hdmi1 只能输出视频信号，没有声音。将 hdmi 线切换到 hdmi0 口后并重启系统后，声音即正常。</p>
<h1 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h1><p>到目前为止，树莓派已经具备了完整的 Android TV 系统的功能，而且使用起来还比较稳定，这一点超出了我的预期，毕竟树莓派 5 比较新，该系统出来的时间比较短。<br>后面我计划使用新的文章来记录使用体验，以及新的折腾经历，比如：如何通过遥控器实现正常的开关机。<br>敬请期待。。。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013120422/article/details/132107317">https://blog.csdn.net/u013120422/article/details/132107317</a></li>
<li><a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/LineageOS20-ATV/">https://konstakang.com/devices/rpi5/LineageOS20-ATV/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/watch-tv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/watch-tv/" class="post-title-link" itemprop="url">我要看电视 - 投影仪和电视盒子选型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-17 11:20:50" itemprop="dateCreated datePublished" datetime="2024-02-17T11:20:50+00:00">2024-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>去年装修的时候预留了投影仪和幕布的位置，搬家已经有几个月的时间了，最近开始考虑安装投影仪。作为技术男，已经有多年不看电视，在决策前自然要考察下市场，了解下当前的技术，综合考虑多种技术因素。</p>
<h1 id="投影仪的选型"><a href="#投影仪的选型" class="headerlink" title="投影仪的选型"></a>投影仪的选型</h1><p>家装投影仪分为了两大阵营：</p>
<ol>
<li>以传统厂商为代表的 3LCD 阵营。典型的厂家为爱普生、明基。优点为清晰度高、对比度高。缺点为噪音大、灯泡寿命短、个头偏大。</li>
<li>以国产新势力厂商为代表的 DLP 阵营。典型厂家为极米、当贝、坚果，无论其市场分布，还是技术形态，都像极了新能源领域的新势力”蔚小理“。优点为自带 android 系统、更加人性化、寿命长。缺点为亮度低。</li>
</ol>
<p>我的需求优先级依次如下：</p>
<ol>
<li>亮度高，抛开亮度和对比度谈体验就本末倒置了，电视的最基本需求就是看得见，看得清楚。</li>
<li>最好不要带 android 系统，时间长了肯定会卡，不希望跟 android 系统绑定。</li>
<li>开机不要有广告。</li>
</ol>
<p>经过对比后，选择了爱普生的 3LCD 投影仪，亮度完全满足需求，即使在白天不拉窗帘的情况下，清晰度也完全足够。选择了其优点，自然要忍受其缺点，噪音大也并没有大到不能忍受，一般播放片源后就可以将风扇的声音盖住，在投影仪旁实测噪音在 40 分贝左右。灯泡寿命短的缺点暂时忽略，毕竟官方说明灯泡的寿命在三年到六年之间，而且更换灯泡的费用并不高。</p>
<h1 id="电视盒子的选型"><a href="#电视盒子的选型" class="headerlink" title="电视盒子的选型"></a>电视盒子的选型</h1><p>有了投影仪后，还缺一个电视盒子用于提供视频源，电视盒子的选择比投影仪更加丰富。</p>
<h2 id="Apple-TV"><a href="#Apple-TV" class="headerlink" title="Apple TV"></a>Apple TV</h2><p>第一优先级考虑为地表最强电视盒子 Apple TV，无论其流畅度、清晰度、用户体验都堪称完美。主要的优点：</p>
<ol>
<li>强大的 Infuse 软件用来查看蓝光光源、杜比视界，绝对不是 1080P 的片源可以比的。</li>
<li>苹果一如既往丝滑般的体验。无论是操作系统，还是遥控器，其用户体验都能吊打一众安卓盒子。</li>
<li>可在 Netflix、Disney+、Apple TV+ 追剧。要想在设备上播放 Netflix，是需要授权的，国内的电视盒子一概不支持。</li>
<li>无广告。</li>
</ol>
<p>虽然想体验一把最好的看电视体验，但存在如下两个问题导致我最终放弃了 Apple TV：</p>
<ol>
<li>无法看国内的”爱优腾“。投影仪的主要使用方并非我自己，而更多的是家人，没有国内的”爱优腾“，查看片源过于复杂，使用体验将大打折扣。</li>
<li>Netflix 和 Disney+ 并非强需求。Apple TV 用来追剧非常方便，但我个人并没有太多的时间用来追剧，而且还需要魔法，追剧还需要付费，使用成本整体并不低。</li>
</ol>
<h2 id="国产电视盒子"><a href="#国产电视盒子" class="headerlink" title="国产电视盒子"></a>国产电视盒子</h2><p>网上可以买到各式各样的电视盒子，当贝、小米、腾讯极光等，整体特点：</p>
<ol>
<li>均基于 Android TV 系统，又叠加了自己的桌面应用。</li>
<li>厂商均不靠硬件赚钱，而是靠 VIP 会员赚钱，因此所有的电视盒子均需要充值 VIP，没有了 VIP 也就剩下一个盒子了，基本上看不了多少片源。</li>
<li>各种开机广告、开屏广告满天飞。</li>
</ol>
<p>下单销量排名靠前的当贝盒子后，体验一番后，大失所望。虽然如宣传的一般没有了开机广告，但进入系统后没有 VIP 寸步难行，每个视频右下角都会带一个灰色的 VIP logo。我的选择逻辑，既然”爱优腾“的会员在所难免，毕竟还有手机端 app 看视频的需求，再买一个盒子 VIP 的意义何在。如果盒子 VIP 不买，那盒子自身系统提供的片源很多就是个摆设。实在无法容忍，遂退之。</p>
<p>国产的电视盒子没有一个能打的，整个产品的定位全跑偏了。如果能有一个干净、用户体验好的电视盒子可以给到用户，哪怕卖得贵一点（毕竟就要靠卖硬件赚钱了），我相信也是有市场的。</p>
<h2 id="树莓派"><a href="#树莓派" class="headerlink" title="树莓派"></a>树莓派</h2><p>看了下 Android TV 的原生系统后，更加符合自己的需求，干净清爽，而且还可以刷 Google 服务包，用来安装 Google 全家桶应用。所以就开始考虑自己刷机使用 Android TV。要想刷机必须先有盒子，盒子的选型有如下几个：</p>
<ol>
<li>国产电视盒子。可在国产电视盒子的硬件上刷 Android TV 系统。</li>
<li>其他 Arm 架构的盒子。比如非常流行的斐讯 N1 盒子，曾经用于挖矿，现在却在软路由领域焕发出了新的生机。</li>
<li>开发版。最为流行的树莓派，还有友善 NanoPi 开发版、Banana Pi，均为基于 ARM 架构。</li>
</ol>
<p>我最终选择了树莓派 5 作为电视盒子，主要考虑如下：</p>
<ol>
<li>性能强大，用来作为电视盒子性能是过剩的。</li>
<li>可玩性强。即使作为电视盒子翻车了，还可以用来作为小型服务器，跑 Home Assiant、TeslaMate 等应用，甚至可以作为 NAS 使用。</li>
<li>用户基数大。自己踩到的坑更容易找到解决方案。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>投影仪完成后，且电视盒子也选好了，接下来将另起一篇文章讲解下我的树莓派刷 Android TV 系统的折腾经历，自己选择的路线，查再多的资料，刷再多的机，也要折腾成功。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ax6000-clash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ax6000-clash/" class="post-title-link" itemprop="url">红米路由器 AX6000 科学上网</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-11 01:12:10" itemprop="dateCreated datePublished" datetime="2024-02-11T01:12:10+00:00">2024-02-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在上篇文章《红米路由器 AX6000 解锁 SSH》中，解锁了红米路由器 AX6000 的 SSH 功能，本文在此基础上安装 clash，用来科学上网。</p>
<h1 id="安装-clash"><a href="#安装-clash" class="headerlink" title="安装 clash"></a>安装 clash</h1><p>通过 ssh 命令连接到红米路由器，执行如下 shell 命令，即可下载并安装 clash 软件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/openclash &amp;&amp; cd /data/openclash</span><br><span class="line">export url=&#x27;https://raw.fastgit.org/juewuy/ShellClash/master&#x27;</span><br><span class="line">curl -kfsSl $url/install.sh &gt; install.sh</span><br><span class="line">sh install.sh</span><br></pre></td></tr></table></figure>

<p>会出现如下的提示：<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-1.png" alt="image.png"><br>install.sh 会将 ShellCrash 安装到 &#x2F;data&#x2F;ShellCrash 目录下。</p>
<h1 id="clash-配置"><a href="#clash-配置" class="headerlink" title="clash 配置"></a>clash 配置</h1><p>在安装完 clash 后，输入 clash 命令即可对 clash 进行管理，该操作有点类似于打客户电话的操作。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-2.png" alt="image.png"></p>
<h1 id="clash-UI"><a href="#clash-UI" class="headerlink" title="clash UI"></a>clash UI</h1><p>通过上述 clash 命令可以安装 clash UI，可以通过网址 <a target="_blank" rel="noopener" href="http://192.168.31.1:9999/ui">http://192.168.31.1:9999/ui</a> 访问。UI 的功能较 clash 的客户端更为简单，但也可以弥补上述 clash 命令的很多不足之处。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/clash-ui.png" alt="image.png"></p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=e90UWDpAlxA">https://www.youtube.com/watch?v=e90UWDpAlxA</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/ax6000-ssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/ax6000-ssh/" class="post-title-link" itemprop="url">红米路由器 AX6000 解锁 SSH</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-11 00:20:15" itemprop="dateCreated datePublished" datetime="2024-02-11T00:20:15+00:00">2024-02-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>半年前购买了红米路由器 AX6000，用起来一直非常稳定。因为最近在折腾树莓派，准备将红米路由器上开启 SSH 的功能。最早是准备将路由器刷成 <a target="_blank" rel="noopener" href="https://openwrt.org/toh/xiaomi/redmi_ax6000">OpenWRT 系统</a>，当一旦路由器能够开启 SSH 功能后，刷 OpenWRT 系统的必要性就不是太大了。</p>
<blockquote>
<p>声明：本文下面操作步骤均为从网络上获取的现有操作步骤。</p>
</blockquote>
<p>在电脑的浏览器上登录红米路由器的管理页面，红米路由器管理页面为：<a target="_blank" rel="noopener" href="https://miwifi.com/">https://miwifi.com/</a>，或者 <a target="_blank" rel="noopener" href="http://192.168.31.1/">http://192.168.31.1/</a>。如果本地设置过其他的 DNS 服务器，需要使用 ip 地址的形式访问。<br>登录后可以获取到当前红米路由器的版本，我的已经是最新的 1.0.67，该版本的固件可以支持开启 SSH 协议。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/ax6000/ax6000-version.png" alt="image.png"><br>在登录红米路由器管理页面后，查看浏览器的地址栏，<code>https://miwifi.com/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/web/home#router</code>，可以看到参数 stok <code>5e55c58e949d5419c001bce8288e5a27</code> 即我们需要用到该值。需要注意的是参数 stok 在每次登录时均会发生改变。</p>
<p>用浏览器打开下面的网址，其中 stok 为上面步骤获取到的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/api/misystem/set_sys_time?timezone=%20%27%20%3B%20zz%3D%24%28dd%20if%3D%2Fdev%2Fzero%20bs%3D1%20count%3D2%202%3E%2Fdev%2Fnull%29%20%3B%20printf%20%27%A5%5A%25c%25c%27%20%24zz%20%24zz%20%7C%20mtd%20write%20-%20crash%20%3B%20</span><br></pre></td></tr></table></figure>
<p>浏览器如果返回<code>&#123;&quot;code&quot;:0&#125;</code>，说明该步骤执行成功。</p>
<p>在浏览器执行路由器重启操作，返回 <code>&#123;&quot;code&quot;:0&#125;</code>，说明该步骤执行成功，此时路由器会发生重启。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=5e55c58e949d5419c001bce8288e5a27/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20</span><br></pre></td></tr></table></figure>

<p>重新登录红米路由器，获取到新的 stok 值 221bcd3ba09b3e4597b0308cc1df18a2。<br>在浏览器继续访问如下的地址，用来开启 telnet，成功后仍然返回 <code>&#123;&quot;code&quot;:0&#125;</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=221bcd3ba09b3e4597b0308cc1df18a2/api/misystem/set_sys_time?timezone=%20%27%20%3B%20bdata%20set%20telnet_en%3D1%20%3B%20bdata%20set%20ssh_en%3D1%20%3B%20bdata%20set%20uart_en%3D1%20%3B%20bdata%20commit%20%3B%20</span><br></pre></td></tr></table></figure>

<p>再继续执行重启命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.31.1/cgi-bin/luci/;stok=221bcd3ba09b3e4597b0308cc1df18a2/api/misystem/set_sys_time?timezone=%20%27%20%3b%20reboot%20%3b%20</span><br></pre></td></tr></table></figure>

<p>在重启完成后，路由器的 telnet 服务已经开启。在终端中执行 <code>telnet 192.168.31.1</code> 即可远程连接到小米路由器，而且不需要密码。</p>
<p>在终端中执行如下的命令，用来设置 root 密码，开启并固化 ssh 服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 修改 root 密码</span><br><span class="line">echo -e &#x27;wangss19881.\nwangss19881.&#x27; | passwd root</span><br><span class="line"></span><br><span class="line"># 开启 ssh 服务</span><br><span class="line">nvram set ssh_en=1</span><br><span class="line">nvram set telnet_en=1</span><br><span class="line">nvram set uart_en=1</span><br><span class="line">nvram set boot_wait=on</span><br><span class="line">nvram commit</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s/channel=.*/channel=&quot;debug&quot;/g&#x27; /etc/init.d/dropbear</span><br><span class="line">/etc/init.d/dropbear restart</span><br><span class="line"></span><br><span class="line"># 设置 ssh 服务开机自启动</span><br><span class="line">mkdir /data/auto_ssh</span><br><span class="line">cd /data/auto_ssh</span><br><span class="line">curl -O https://fastly.jsdelivr.net/gh/lemoeo/AX6S@main/auto_ssh.sh</span><br><span class="line">chmod +x auto_ssh.sh</span><br><span class="line">uci set firewall.auto_ssh=include</span><br><span class="line">uci set firewall.auto_ssh.type=&#x27;script&#x27;</span><br><span class="line">uci set firewall.auto_ssh.path=&#x27;/data/auto_ssh/auto_ssh.sh&#x27;</span><br><span class="line">uci set firewall.auto_ssh.enabled=&#x27;1&#x27;</span><br><span class="line">uci commit firewall</span><br><span class="line"></span><br><span class="line"># 设置时区</span><br><span class="line">uci set system.@system[0].timezone=&#x27;CST-8&#x27;</span><br><span class="line">uci set system.@system[0].webtimezone=&#x27;CST-8&#x27;</span><br><span class="line">uci set system.@system[0].timezoneindex=&#x27;2.84&#x27;</span><br><span class="line">uci commit</span><br><span class="line"></span><br><span class="line"># 关闭开发模式</span><br><span class="line">mtd erase crash</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>在终端中执行 <code>ssh -o HostkeyAlgorithms=+ssh-rsa -o PubkeyAcceptedKeyTypes=+ssh-rsa  root@192.168.31.1</code>即可 ssh 连接到路由器。</p>
<p>进入到系统后我们可以看到系统为基于 Linux 5.4 内核版本的 XiaoQiang 系统，至于名字为什么叫 XiaoQiang 我还不得而知。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# uname -a</span><br><span class="line">Linux XiaoQiang 5.4.150 #0 SMP Mon Jan 30 09:23:25 2023 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p>整个磁盘分区的使用情况如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">/dev/root                15.5M     15.5M         0 100% /</span><br><span class="line">tmpfs                   240.0M      9.9M    230.1M   4% /tmp</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /data</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /userdisk</span><br><span class="line">/dev/root                15.5M     15.5M         0 100% /userdisk/data</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/config</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/datacenterconfig</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/smartcontroller</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/parentalctl</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/smartvpn</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/ppp</span><br><span class="line">ubi1_0                   40.4M      7.6M     30.7M  20% /etc/crontabs</span><br><span class="line">tmpfs                   512.0K     12.0K    500.0K   2% /dev</span><br></pre></td></tr></table></figure>

<p>使用 top 命令查看整体的系统负载情况，cpu 利用率还是非常低。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mem: 325692K used, 165808K free, 11208K shrd, 12652K buff, 76388K cached</span><br><span class="line">CPU:  0.3% usr  1.3% sys  0.0% nic 97.8% idle  0.0% io  0.0% irq  0.4% sirq</span><br><span class="line">Load average: 1.05 1.06 1.12 2/147 28107</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=u5Qg4zqj_V0">https://www.youtube.com/watch?v=u5Qg4zqj_V0</a><br><a target="_blank" rel="noopener" href="https://uzbox.com/tech/openwrt/ax6000.html">https://uzbox.com/tech/openwrt/ax6000.html</a><br><a target="_blank" rel="noopener" href="https://github.com/kjfx/AX6000/releases/tag/RedmiAX6000">https://github.com/kjfx/AX6000/releases/tag/RedmiAX6000</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/vcluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/vcluster/" class="post-title-link" itemprop="url">k8s virtual cluster 方案 - vCluster</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-29 20:23:05" itemprop="dateCreated datePublished" datetime="2023-11-29T20:23:05+00:00">2023-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h1><ul>
<li>host cluster：virtual cluster 中的宿主 k8s 集群，承载了所有的计算资源。也会被叫做 super cluster。</li>
<li>virtual cluster：virtual cluster 中的租户 k8s 集群，通常简写 vc。也会被叫做 tenant cluster。</li>
<li>vCluster：k8s virtual cluster 的实现之一，即本文中要介绍的方案。</li>
</ul>
<h1 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h1><h2 id="k8s-的多租功能"><a href="#k8s-的多租功能" class="headerlink" title="k8s 的多租功能"></a>k8s 的多租功能</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-compare.png" alt="image.png"><br>k8s 自身在多租的能力上支持较差，提供了 namespace 级别的隔离，不同的租户使用不同的 namespace，但该隔离功能较弱。很多组件部署在同一个 workload 会存在诸多问题：</p>
<ol>
<li>使用全局对象存在冲突，比如 CRD。</li>
<li>存在诸多安全性问题，比如多个租户之间的 pod 完全可以互访，没有任何隔离机制。</li>
<li>不同组件对于 k8s 的版本不统一。</li>
</ol>
<p>为了解决多租的问题，最简单的思路就是使用多 k8s 集群，业界的 KubeFed v2、karmada、clusternet、OCM 等均为多 k8s 集群的实现。但多 k8s 集群因为存在独立的控制面和计算资源，存在资源消耗过多的问题。</p>
<p>还有一个中间思路为仅做 k8s 的控制面隔离，计算资源仍然共享，即 pod 也可以解决很多的多租隔离问题。k8s 的控制面隔离又存在两个主要方案：</p>
<ol>
<li>独立的 kube-apiserver 和 etcd、kube-controller-manager， kube-scheduler 共享 host cluster。该方案中有独立的 kube-apiserver 组件，这里的 etcd 可以被 sqllite、mysql 等存储取代。该方案统称为 virtual cluster，简称为 vc。</li>
<li>独立的 proxy apiserver，kube-apiserver、kube-controller-manager、kube-scheduler 共享 host cluster。访问 k8s 的请求先到 proxy apiserver，proxy apiserver 转发到 host cluster 的 kube-apiserver。可以在 proxy apiserver 中提供独立的 RBAC 机制，实现一定程度的隔离。该方案在开源中未看到具体的实现。</li>
</ol>
<h2 id="vCluster-介绍"><a href="#vCluster-介绍" class="headerlink" title="vCluster 介绍"></a>vCluster 介绍</h2><p><a target="_blank" rel="noopener" href="https://github.com/loft-sh/vcluster">vCluster</a> 为 virtual cluster 的开源实现之一，由 Loft Labs 提供，Github Star 3.7K，代码行数 4 万行。除了开源版本外，还提供了商业版本 vCluster PRO。</p>
<p>vCluster 设计原则：</p>
<ol>
<li>最小化资源占用。在实现上使用了单 pod 的 k3s 作为 k8s 的控制面。</li>
<li>复用 host cluster 的计算、存储和网络资源。</li>
<li>降低对 host cluster 的请求。</li>
<li>简单灵活。</li>
<li>不需要 host cluster 的管理员权限。</li>
<li>vCluster 多个 namespace 下的对象映射到 host cluster 的同一个 namespace 下。同时也可以支持 vCluster 的一个 namespace 对应 host cluster 的一个 namespace。</li>
<li>易清理。</li>
</ol>
<h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><h2 id="k8s-集群准备"><a href="#k8s-集群准备" class="headerlink" title="k8s 集群准备"></a>k8s 集群准备</h2><p>k8s 集群这里使用了 kind 方案，kind 配置 kind.conf 如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">vcluster</span></span><br><span class="line"><span class="attr">nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="comment"># 如果需要 ingress，则需要指定该参数</span></span><br><span class="line">  <span class="attr">kubeadmConfigPatches:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">    kind: InitConfiguration</span></span><br><span class="line"><span class="string">    nodeRegistration:</span></span><br><span class="line"><span class="string">      kubeletExtraArgs:</span></span><br><span class="line"><span class="string">        node-labels: &quot;ingress-ready=true&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">extraPortMappings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="comment"># 指定 k8s 版本，默认不指定</span></span><br><span class="line">  <span class="comment"># image: kindest/node:v1.23.17</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">role:</span> <span class="string">worker</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">apiServerPort:</span> <span class="number">6443</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>kind create cluster --config kind.conf</code> 即可创建 k8s 集群，包含了一个 control-plane 节点，三个 worker 节点。</p>
<h2 id="安装-vcluster"><a href="#安装-vcluster" class="headerlink" title="安装 vcluster"></a>安装 vcluster</h2><p>vCluster 提供了使用 vcluster cli、helm 和 kubectl 三种安装方式，使用 vcluster cli 最为简单，其底层同样采用 helm chart 的方式部署，下面采用 vcluster cli 的方式进行安装。<br>安装 vcluster cli 工具：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-L</span> <span class="string">-o</span> <span class="string">vcluster</span> <span class="string">&quot;https://github.com/loft-sh/vcluster/releases/latest/download/vcluster-darwin-arm64&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">sudo</span> <span class="string">install</span> <span class="string">-c</span> <span class="string">-m</span> <span class="number">0755 </span><span class="string">vcluster</span> <span class="string">/usr/local/bin</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">vcluster</span></span><br></pre></td></tr></table></figure>
<p>或者执行 <code>brew install vcluster</code>安装 vcluster 命令行工具。</p>
<p>执行命令 <code>vcluster create my-vcluster</code> 创建 virtual cluster。会在 host cluster 上创建 namespace <code>vcluster-my-vcluster</code>，该 namespace 下创建如下对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                                                       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">pod/coredns-68559449b6-l5whx-x-kube-system-x-my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span> <span class="string">(5m45s</span> <span class="string">ago)</span>   <span class="string">3d</span></span><br><span class="line"><span class="string">pod/my-vcluster-0</span>                                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span> <span class="string">(5m45s</span> <span class="string">ago)</span>   <span class="string">3d</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                                              <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                         <span class="string">AGE</span></span><br><span class="line"><span class="string">service/kube-dns-x-kube-system-x-my-vcluster</span>      <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.67</span><span class="number">.119</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>          <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster</span>                               <span class="string">NodePort</span>    <span class="number">10.96</span><span class="number">.214</span><span class="number">.58</span>   <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">:30540/TCP,10250:31621/TCP</span>   <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster-headless</span>                      <span class="string">ClusterIP</span>   <span class="string">None</span>           <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                         <span class="string">3d</span></span><br><span class="line"><span class="string">service/my-vcluster-node-vcluster-control-plane</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.69</span><span class="number">.115</span>   <span class="string">&lt;none&gt;</span>        <span class="number">10250</span><span class="string">/TCP</span>                       <span class="string">3d</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">statefulset.apps/my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">3d</span></span><br></pre></td></tr></table></figure>
<p>可以看到在该 namespace 下创建了 coredns 和 StatefulSet my-vcluster。每个租户有独立的 coredns 组件，用来做域名解析。my-vcluster 为 vCluster 的管控面组件，包括了 k8s controller plane 和 syncer 组件。</p>
<p>执行  <code>vcluster connect my-vcluster</code> 后会在本地启动代理，并自动切换本地的 kubeconfig context，将 context 切换到 virtual cluster。执行 kubectl 命令即可连接到对应的 k8s 集群。virtual cluster 集群中的信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">all</span> <span class="string">-A</span></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">pod/coredns-68559449b6-jg2bs</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(20m</span> <span class="string">ago)</span>   <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                 <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                  <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">service/kube-dns</span>     <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.120</span><span class="number">.59</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>   <span class="string">51m</span></span><br><span class="line"><span class="string">default</span>       <span class="string">service/kubernetes</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.35</span><span class="number">.53</span>    <span class="string">&lt;none&gt;</span>        <span class="number">443</span><span class="string">/TCP</span>                  <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">deployment.apps/coredns</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">51m</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAMESPACE</span>     <span class="string">NAME</span>                                 <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-system</span>   <span class="string">replicaset.apps/coredns-68559449b6</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="string">51m</span></span><br></pre></td></tr></table></figure>
<p>在 virtual cluster 可以看到仅包含了 coredns 组件。</p>
<p>在 virtual cluster 和在 host cluster 中的 node 信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">STATUS</span>   <span class="string">ROLES</span>    <span class="string">AGE</span>   <span class="string">VERSION</span>   <span class="string">INTERNAL-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">OS-IMAGE</span>                         <span class="string">KERNEL-VERSION</span>     <span class="string">CONTAINER-RUNTIME</span></span><br><span class="line"><span class="string">vcluster-worker3</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">51m</span>   <span class="string">v1.27.3</span>   <span class="number">10.96</span><span class="number">.118</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">STATUS</span>   <span class="string">ROLES</span>           <span class="string">AGE</span>   <span class="string">VERSION</span>   <span class="string">INTERNAL-IP</span>   <span class="string">EXTERNAL-IP</span>   <span class="string">OS-IMAGE</span>                         <span class="string">KERNEL-VERSION</span>     <span class="string">CONTAINER-RUNTIME</span></span><br><span class="line"><span class="string">vcluster-control-plane</span>   <span class="string">Ready</span>    <span class="string">control-plane</span>   <span class="string">86m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.3</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker</span>          <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.2</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker2</span>         <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.5</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br><span class="line"><span class="string">vcluster-worker3</span>         <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>          <span class="string">85m</span>   <span class="string">v1.27.3</span>   <span class="number">172.19</span><span class="number">.0</span><span class="number">.4</span>    <span class="string">&lt;none&gt;</span>        <span class="string">Debian</span> <span class="string">GNU/Linux</span> <span class="number">11</span> <span class="string">(bullseye)</span>   <span class="number">5.10</span><span class="number">.76</span><span class="string">-linuxkit</span>   <span class="string">containerd://1.7.1</span></span><br></pre></td></tr></table></figure>
<p>可以看到在 virtual cluster 和 host cluster 中的 node 名字相同，这是因为 node 在 vCluster 中并没有做隔离，而是从 host cluster 中做了同步。但 virtual cluster 中的 node 节点仅包含 pod 在 host cluster 中已经使用的 node 节点，未使用的节点并不会在 virtual cluster 上。<br>同时可以看到 vc 和 host cluster 中的 node ip 地址并不相同，vc 中的 node ip 地址跟 host cluster 中的对应 service clusterip 相同，在 host cluster 中的对应 service 名字为 <code>$vClusterName-node-$hostClusterNodeName</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">my-vcluster-node-vcluster-worker3</span></span><br><span class="line"><span class="string">NAME</span>                                <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>     <span class="string">AGE</span></span><br><span class="line"><span class="string">my-vcluster-node-vcluster-worker3</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.118</span><span class="number">.228</span>   <span class="string">&lt;none&gt;</span>        <span class="number">10250</span><span class="string">/TCP</span>   <span class="string">3h54m</span></span><br></pre></td></tr></table></figure>

<p>在 virtual cluster 中创建 k8s 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 virtual cluster 创建 namespace</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">namespace/demo-nginx</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Deployment</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">deployment</span> <span class="string">nginx-deployment</span> <span class="string">-n</span> <span class="string">demo-nginx</span> <span class="string">--image=nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 virtual cluster 上创建出了 pod</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">demo-nginx</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">NAME</span>                                <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                     <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">nginx-deployment-66fb7f764c-dn59g</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">11m</span>   <span class="number">10.244</span><span class="number">.0</span><span class="number">.7</span>   <span class="string">vcluster-control-plane</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于 pod 调度了 host cluster 新节点，在 virtual cluster 中可以看到新的 k8s node，k8s node 为刚刚创建</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span></span><br><span class="line"><span class="string">NAME</span>               <span class="string">STATUS</span>   <span class="string">ROLES</span>    <span class="string">AGE</span>     <span class="string">VERSION</span></span><br><span class="line"><span class="string">vcluster-worker2</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">2m45s</span>   <span class="string">v1.27.3</span></span><br><span class="line"><span class="string">vcluster-worker3</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">57m</span>     <span class="string">v1.27.3</span></span><br></pre></td></tr></table></figure>
<p>在 host cluster 中看到如下对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 host cluster 上并没有对应的 namespace demo-nginx</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">ns</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">Error</span> <span class="string">from</span> <span class="string">server</span> <span class="string">(NotFound):</span> <span class="string">namespaces</span> <span class="string">&quot;demo-nginx&quot;</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 host cluster 上并没有对应的 deployment nginx-deployment</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-A</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAMESPACE</span>            <span class="string">NAME</span>                       <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">ingress-nginx</span>        <span class="string">ingress-nginx-controller</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">90m</span></span><br><span class="line"><span class="string">kube-system</span>          <span class="string">coredns</span>                    <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">91m</span></span><br><span class="line"><span class="string">local-path-storage</span>   <span class="string">local-path-provisioner</span>     <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">91m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但在 host cluster 上却看到了对应的 pod，位于 vcluster 统一的 namespace vcluster-my-vcluster 之下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">--context</span> <span class="string">kind-vcluster</span></span><br><span class="line"><span class="string">NAME</span>                                                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>      <span class="string">AGE</span></span><br><span class="line"><span class="string">coredns-68559449b6-jg2bs-x-kube-system-x-my-vcluster</span>           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(26m</span> <span class="string">ago)</span>   <span class="string">57m</span></span><br><span class="line"><span class="string">my-vcluster-0</span>                                                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span> <span class="string">(26m</span> <span class="string">ago)</span>   <span class="string">86m</span></span><br><span class="line"><span class="string">nginx-deployment-66fb7f764c-sffqt-x-demo-nginx-x-my-vcluster</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>             <span class="string">2m22s</span></span><br></pre></td></tr></table></figure>
<p>可以看到仅 pod 在 host cluster 中同步存在，而 namespace、deployment 这些对象仅存在于 virtual cluster 中。在 virtual cluster 中创建的多个不同 namespace pod 仅会存在于 host cluster 的同一个 namespace 下。</p>
<h2 id="验证-service"><a href="#验证-service" class="headerlink" title="验证 service"></a>验证 service</h2><p>在 virtual cluster 中创建 service 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>
<p>在 virtual cluster 中包含如下的 Service 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">-n</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nginx</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">2m11s</span></span><br></pre></td></tr></table></figure>
<p>在 host cluster 中会同步创建如下的 Service 对象，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-uid:</span> <span class="string">5ab7aa9c-90b6-46f9-a162-9ea9ca9826f3</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-28T09:32:22Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-d9125f8911:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">463a503e-d889-49a7-94e0-0cba5299dd47</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;12344&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">fc9ea383-996e-471c-9c27-ee1c22fec7a3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.239</span><span class="number">.53</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 host cluster 中的 service 的 ClusterIP 跟 virutal cluster 一致，但 spec.selector 字段已经被 syncer 修改，以便可以匹配到正确的 pod。</p>
<h2 id="验证-Ingress"><a href="#验证-Ingress" class="headerlink" title="验证 Ingress"></a>验证 Ingress</h2><p>默认情况下 Ingress 不会同步到 host cluster，需要通过开关的方式启动。创建文件 values.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sync:</span></span><br><span class="line">  <span class="attr">ingresses:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>vcluster create my-vcluster --upgrade -f values.yaml</code> 即可修改现在 vcluster 集群配置。</p>
<p>在 virtual cluster 中创建如下的 Ingress 对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.aa.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br></pre></td></tr></table></figure>
<p>查看 host cluster 中的 Ingress 信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">ingress</span> <span class="string">--context</span> <span class="string">kind-vcluster</span> <span class="string">-n</span> <span class="string">vcluster-my-vcluster</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/object-uid:</span> <span class="string">4b8034a6-1513-4ccd-b80a-66807d862b4e</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-28T10:07:52Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/label-my-vcluster-x-a172cedcae:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/managed-by:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">vcluster.loft.sh/namespace:</span> <span class="string">demo-nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">vcluster-my-vcluster</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">my-vcluster</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">463a503e-d889-49a7-94e0-0cba5299dd47</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;16292&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1d0de02b-5aad-4858-a8cf-2caa345ca85b</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.aa.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx-x-demo-nginx-x-my-vcluster</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hostname:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>
<p>可以看到 Ingress 中对应的 Service 名字已经修改了 host cluster 中对应的 Service 名字。</p>
<h2 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h2><p>在使用完成后执行如下命令即可销毁 virtual cluster：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换本地的 context</span></span><br><span class="line">vcluster disconnect</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 vcluster</span></span><br><span class="line">vcluster delete my-vcluster</span><br></pre></td></tr></table></figure>

<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-arch.png" alt="image.png"></p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>整个架构中，有两大核心组件：k8s Control Plane 和 syncer。其中 StatefulSet my-vcluster 中容器 syncer，默认情况下在该容器中同时启动了 k3s 容器作为 vCluster 控制平面和 vCluster 的 syncer 进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it --context kind-vcluster -n vcluster-my-vcluster my-vcluster-0 -- ps -ef</span></span><br><span class="line">Defaulted container &quot;syncer&quot; out of: syncer, vcluster (init)</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      2:57 /vcluster start --name=my-vcluster --kube-config=/data/k3s</span><br><span class="line">   17 root     18:35 /k3s-binary/k3s server</span><br><span class="line">   46 root      0:00 ps -ef</span><br></pre></td></tr></table></figure>

<h3 id="controller-plane"><a href="#controller-plane" class="headerlink" title="controller plane"></a>controller plane</h3><p>控制平面默认使用 k3s，存储使用 sqllite，也可以使用 etcd、mysql、postgresql。k8s 发行版也可以使用 k0s、Vanilla（标准 k8s）、第三方镜像等。控制平面由如下几个组件组成：</p>
<ol>
<li>k8s apiserver。</li>
<li>数据存储，比如 sqllite、etcd 等。</li>
<li>kube-controller-manager</li>
<li>kube-scheduler：可选组件，默认使用 host cluster 调度器。</li>
</ol>
<blockquote>
<p>在 Pro 版本中，允许控制面跟 pod 部署在不同的 host cluster。</p>
</blockquote>
<h3 id="syncer"><a href="#syncer" class="headerlink" title="syncer"></a>syncer</h3><p>virtual cluster 中并不包含实际的计算、存储和网络资源，syncer 的职责为将对象从 virtual cluster 同步到 host cluster，也有少部分对象需要从 host cluster 同步到 virtual cluster。<br>vCluster 将 k8s 对象划分为 low level 和 high level，其中 high level 的对象仅存在于 virtual cluster 中，比如 Deployment、CRD 等对象。low level 的对象会通过 syncer 模块同步到 host cluster 上，包括 Pod、ConfigMap、Secret 等。low level 的对象在 virutal cluster 为多个 namespace，但均会映射到 host cluster 的一个 namespace 下。另外，vCluster 也支持将 virtual cluster 的多个 namespace 映射到 host cluster 的多个 namespace，该特性目前处于 alpha 状态。<br>vCluster 可以通过<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/syncer/other_resources/config_syntax">配置的方式</a>来定制资源的同步，更复杂的同步规则提供了<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/advanced-topics/plugins-overview">插件机制</a>实现。<br>vCluster 默认支持的同步资源列表：<a target="_blank" rel="noopener" href="https://www.vcluster.com/docs/syncer/core_resources">https://www.vcluster.com/docs/syncer/core_resources</a>。</p>
<p>已经创建完成的 syncer 配置，可以通过 <code>vcluster create my-vcluster --upgrade -f values.yaml</code> 的方式修改，该命令会调用 helm update，helm update 命令最终会修改 StatefulSet syncer 的配置，并触发 pod 的重启。</p>
<h4 id="k8s-node-同步"><a href="#k8s-node-同步" class="headerlink" title="k8s node 同步"></a>k8s node 同步</h4><p>支持多种 node 的同步行为，通过修改 syncer 的启动参数：</p>
<ol>
<li>Fake Node：默认行为。根据 pod 中的 spec.nodeName 创建 Fake Node。Fake Node 为 syncer 服务自动创建。如果没有 pod 调度到 Fake Node 上，则 Fake Node 会自动删除。</li>
<li>Real Node：根据 pod 中的 spec.nodeName 创建 Real Node，Real Node 的信息从 host cluster 同步。如果没有 pod 调度到 Real Node 上，则 Real Node 会自动删除。</li>
<li>Real Node All：同步 host cluster 的所有 node 到 virtual cluster。如果要使用 DaemonSet，需要使用该模式。</li>
<li>Real Nodes Label Selector：仅同步 label selector 匹配的 host node 到 virtual cluster 中。</li>
<li>Real Nodes + Label Selector：仅同步包含在 pod spec.nodeName 且 Label selector 可以选中的 host cluster node 到 virtual cluster 中。</li>
</ol>
<h2 id="pod-调度"><a href="#pod-调度" class="headerlink" title="pod 调度"></a>pod 调度</h2><p>默认情况下，virtual cluster 中的 pod 调度会使用 host cluster 的调度，但存在如下的问题：</p>
<ol>
<li>在 virtual cluster node 上的 label 对于 pod 调度不会生效。</li>
<li>drait、trait 命令对于 virtual cluster 上的 pod 没有影响。</li>
<li>virtual cluster 中使用自定义调度器不生效。</li>
</ol>
<p>基于上述限制，vCluster 支持如下两种方案：</p>
<ol>
<li>支持在 virtual cluster 中使用独立的调度器。可以给 virtual cluster 上的 node 增加标签、污点等信息，pod 的调度在 virtual cluster 中的调度器实现，syncer 组件仅将已经调度完成的 pod 同步到 host cluster。</li>
<li>仍然复用 host cluster 调度器，但做了部分功能的增强：在 syncer 服务中指定仅同步部分 host node 到 virtual cluster 中，这样 pod 就仅会调度到 host cluster 的特定 node 上。</li>
</ol>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>virutal cluster 中无独立的 pod 网络和 service 网络，完全复用 host cluster 的网络。</p>
<h3 id="Service-网络"><a href="#Service-网络" class="headerlink" title="Service 网络"></a>Service 网络</h3><ol>
<li>会从 virtual cluster 同步到 host cluster，两者的 clusterip 一致。</li>
<li>允许将一些 host cluster 中的 service 同步到 virtual cluster 中，同时指定service 的名字。</li>
<li>允许将 virtual cluster 中的 service 同步到 host cluster 中，同时指定service 的名字。</li>
</ol>
<h3 id="Ingress-网络"><a href="#Ingress-网络" class="headerlink" title="Ingress 网络"></a>Ingress 网络</h3><p>允许将 virtual cluster 中的 Ingress 同步到 host cluster，以便复用 host cluster 中的 Ingress Controller。</p>
<h3 id="DNS-解析"><a href="#DNS-解析" class="headerlink" title="DNS 解析"></a>DNS 解析</h3><p>在 virtual cluster 中部署了单独的 coredns 组件，默认情况下，在 vritual cluster 中的域名仅能解析内部的域名，不能解析 host cluster 上的域名。可以通过开关的方式，将 virtual cluster 中的域名解析转发到 host cluster 的 coredns。</p>
<blockquote>
<p>在 PRO 版本中，coredns 组件可以集成到 syncer 组件内部，以便节省资源。</p>
</blockquote>
<h3 id="NetworkPolicy"><a href="#NetworkPolicy" class="headerlink" title="NetworkPolicy"></a>NetworkPolicy</h3><p>默认情况下，vcluster 中会忽略 virtual cluster 中的 NetworkPolicy 资源。可以通过开关的方式打开该配置，即可将 NetworkPolicy 规则同步到 host cluster。</p>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vcluster-pv.png" alt="image.png"><br>默认情况下，host StorageClass 不会同步到 vc，可以通过开关的方式打开同步。<br>默认情况下，pv 不会从 vc 同步到 host cluster，可以通过开关的方式打开。</p>
<h2 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h2><h3 id="monitoring"><a href="#monitoring" class="headerlink" title="monitoring"></a>monitoring</h3><p>metrics-server 用来监控 k8s 的 Deployment、StatefulSet 等对象，metrics-server 可以复用 host cluster 中的，但需要启用 metrics server proxy 功能。也可以在 vc 中单独部署一套 metrics server。<br>在 vc 集群中，由于每个 k8s node 的 ip 地址为 host cluster 中的 service clusterip，在 vc 中网络是可达的，可以获取到对应的监控信息。</p>
<h3 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h3><p>需要用到Hostpath Mapper组件，该组件为 DaemonSet 的形式。后续即可以部署 loki 等组件。</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h3 id="隔离模式"><a href="#隔离模式" class="headerlink" title="隔离模式"></a>隔离模式</h3><p>在启动的时候指定<code>--isolate</code>，在该模式下对 workload 做了多种限制。</p>
<ol>
<li>对 vcluster pod 的 Pod Security 做限制，不符合规范的 pod 不会同步到 host cluster。</li>
<li>可以对 vc 中 pod 的总资源量做限制。</li>
<li>在 host cluster 上通过 NetworkPolicy 做隔离。</li>
</ol>
<h2 id="virtual-cluster-集群的创建"><a href="#virtual-cluster-集群的创建" class="headerlink" title="virtual cluster 集群的创建"></a>virtual cluster 集群的创建</h2><p>目前仅能通过 vcluster cli、helm 的方式来创建，底层均为 helm chart 的方式来管理，缺少服务化功能。</p>
<h2 id="virtual-cluster-集群对外暴露方法"><a href="#virtual-cluster-集群对外暴露方法" class="headerlink" title="virtual cluster 集群对外暴露方法"></a>virtual cluster 集群对外暴露方法</h2><h3 id="获取-kubeconfig"><a href="#获取-kubeconfig" class="headerlink" title="获取 kubeconfig"></a>获取 kubeconfig</h3><h4 id="vcluster-connect-命令"><a href="#vcluster-connect-命令" class="headerlink" title="vcluster connect 命令"></a>vcluster connect 命令</h4><p>该命令可以修改本地的 kubeconfig 文件，并将 context 切换为 virtual cluster context。默认为 virutual cluster 的管理员权限，可以指定使用特定的 ServiceAccount。</p>
<h4 id="host-cluster-secret-中获取到-kubeconfig"><a href="#host-cluster-secret-中获取到-kubeconfig" class="headerlink" title="host cluster secret 中获取到 kubeconfig"></a>host cluster secret 中获取到 kubeconfig</h4><p>在 host cluster 中，在 vc 的 namespace 下，存在一个以 <code>vc-</code> 开头的 Secret，该 Secret 中保存了 kubeconfig 完整信息。</p>
<h3 id="vc-集群中的-apiserver-的暴露地址"><a href="#vc-集群中的-apiserver-的暴露地址" class="headerlink" title="vc 集群中的 apiserver 的暴露地址"></a>vc 集群中的 apiserver 的暴露地址</h3><p>可以在 syncer 启动的时候指定获取的 kubeconfig 中的 endpoint 地址。endpoint 地址即为 vc 集群中的 kube-apiserver 的地址，该 kube-apiserver 的地址可以通过 host cluster 中的 Ingress、LoadBalancer Service、NodePort Service 等方式对外暴露。</p>
<h2 id="高可用设计"><a href="#高可用设计" class="headerlink" title="高可用设计"></a>高可用设计</h2><h3 id="control-plane-高可用"><a href="#control-plane-高可用" class="headerlink" title="control plane 高可用"></a>control plane 高可用</h3><p>k3s 可以支持高可用架构，在创建 vc 的时候通过指定的副本的方式来设置高可用。其他的 k8s 发行版同样类似的实现。</p>
<h3 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h3><p>vCluster 本身并没有提供对于 vc 集群的数据备份与恢复功能，可以通过通用的 velero 方式实现备份与恢复功能。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>未做网络隔离，容器网络和 service 网络仍然在同一个平面，要想相互隔离，必须使用 NetworkPolicy。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ol>
<li>获取 helm chart 到本地</li>
</ol>
<pre><code class="shell">helm repo add lofts https://charts.loft.sh/
helm fetch lofts/vcluster
``
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-CSI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-CSI/" class="post-title-link" itemprop="url">k8s CSI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-11-23 22:56:40" itemprop="dateCreated datePublished" datetime="2023-11-23T22:56:40+00:00">2023-11-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI</a>：Container Storage Interface (CSI)</p>
<p>Volume 的三个阶段：</p>
<ol>
<li>Provision and Delete：负责卷的创建以及销毁。</li>
<li>Attaching and Detaching：将卷设备挂载到本地或者从本地卸载。</li>
<li>Mount and Umount：将 Attaching 的块设备以目录形式挂载到 pod中，或者从 pod 中卸载块设备。</li>
</ol>
<h1 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h1><p>CSI 插件分为三个部分：</p>
<ol>
<li>CSI Identity：用来获取 CSI 的身份信息</li>
<li>CSI Controller</li>
<li>CSI Node</li>
</ol>
<p>参考 k8s 官方的 hostpath 项目：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/csi-driver-host-path">https://github.com/kubernetes-csi/csi-driver-host-path</a></p>
<p>为了方便开发，在每个阶段 k8s 官方均实现了对应的 SideCarSet 容器。要想研发，仅需要实现 grpc server，又 SideCarSet 容器调用自研的容器。</p>
<p>自研的容器需要实现如下的接口即可。</p>
<h2 id="CSI-Identity"><a href="#CSI-Identity" class="headerlink" title="CSI Identity"></a>CSI Identity</h2><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Identity</span> &#123;</span><br><span class="line">  <span class="comment">// 返回插件名字以及版本号</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginInfo(GetPluginInfoRequest) <span class="keyword">returns</span> (GetPluginInfoResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回插件的包含的功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetPluginCapabilities(GetPluginCapabilitiesRequest) <span class="keyword">returns</span> (GetPluginCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Probe (ProbeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ProbeResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>External provisioner 会调用该接口。</p>
<h2 id="CSI-Controller"><a href="#CSI-Controller" class="headerlink" title="CSI Controller"></a>CSI Controller</h2><p>实现 Volume 中的 Provisioning and Deleting 和 Attaching and Detaching 两个阶段的功能。只有块存储 CSI 插件才需要 Attach 功能。<br>该部分以中心化组件的方式部署，比如 Deployment。Provision 功能对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-provisioner">external-provisioner</a>，Attach 对应的 SidecarSet 为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/external-attacher">external-attacher</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Controller</span> &#123;</span><br><span class="line">  <span class="comment">// Provisioning， External provisioner调用</span></span><br><span class="line">  <span class="comment">// hostPath 实现中会调用 fallocate 实现</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateVolume (CreateVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Deleting， External provisioner调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteVolume (DeleteVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Attaching, 只有块设备才需要实现，比如云盘，由External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerPublishVolume (ControllerPublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerPublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Detaching，External attach 调用</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ValidateVolumeCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListVolumes (ListVolumesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListVolumesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetCapacity (GetCapacityRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (GetCapacityResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetCapabilities (ControllerGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateSnapshot (CreateSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (CreateSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除快照功能</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> DeleteSnapshot (DeleteSnapshotRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (DeleteSnapshotResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ListSnapshots (ListSnapshotsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ListSnapshotsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerExpandVolume (ControllerExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerGetVolume (ControllerGetVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerGetVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> ControllerModifyVolume (ControllerModifyVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (ControllerModifyVolumeResponse) </span>&#123;</span><br><span class="line">        <span class="keyword">option</span> (alpha_method) = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CSI-Node"><a href="#CSI-Node" class="headerlink" title="CSI Node"></a>CSI Node</h2><p>实现 Volume 中的Mount 和 Umount 阶段，由 kubelet 负责调用。<br>该部分以 DaemonSet 的形式部署在每个 k8s node 上，对应的 SidecarSet 容器为 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-csi/node-driver-registrar">node-driver-registrer</a>。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="comment">// 针对块存储类型，将块设备格式化后先挂载到一个临时全局目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeStageVolume (NodeStageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeStageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnstageVolume (NodeUnstageVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnstageVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是块存储设备，在执行完 NodeStageVolume 后，使用 linux 的 bind mount 技术将全局目录挂载到pod 中的对应目录</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodePublishVolume (NodePublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodePublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeUnpublishVolume (NodeUnpublishVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeUnpublishVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetVolumeStats (NodeGetVolumeStatsRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetVolumeStatsResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeExpandVolume(NodeExpandVolumeRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeExpandVolumeResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetCapabilities (NodeGetCapabilitiesRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetCapabilitiesResponse) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> NodeGetInfo (NodeGetInfoRequest)</span></span><br><span class="line"><span class="function">    <span class="keyword">returns</span> (NodeGetInfoResponse) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>协议：<a target="_blank" rel="noopener" href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/PXE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/PXE/" class="post-title-link" itemprop="url">PXE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-12 20:12:55" itemprop="dateCreated datePublished" datetime="2023-10-12T20:12:55+00:00">2023-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>重装过电脑操作系统的同学大概知道操作系统的安装流程如下：</p>
<ol>
<li>在 BIOS 中将系统设置为光驱&#x2F;USB开机优先模式</li>
<li>以DVD或者 U 盘中的操作系统开机，进入到装机界面</li>
<li>完成一系列的装机初始化，比如磁盘分区、语言选择等</li>
<li>重启进入新安装的操作系统</li>
</ol>
<p>以上过程必须要手工才能完成，安装一台电脑还可以，但如果要大批量安装一批机器就不适用了。为此，Intel 公司研发了 PXE(Pre-boot Execution Environment) 技术，可以通过网络的方式批量安装操作系统。</p>
<p>PXE 基于 C&#x2F;S 架构，分为PXE client 和PXE server，其中 PXE client 为要安装操作系统的机器，PXE server 用来提供安装操作系统必须的镜像等信息。要想实现从网络上安装操作系统，必须要解决如下几个问题：</p>
<ol>
<li>因为还没有安装操作系统，此时并不存在 ip 地址，在装机之前必须要获取到一个 ip 地址。</li>
<li>安装操作系统需要的 boot loader 和操作系统镜像如何获取。</li>
</ol>
<p>为了解决 PXE client 的 ip 地址问题，PXE 中采用了 DHCP 协议来给 client 分配 ip 地址，这就要求 PXE server 必须要运行 dhcp server。为了解决 PXE server 可以提供 boot loader 和操作系统基线，PXE server 通过 tftp 协议的方式对 client 提供服务。</p>
<p>client 端需要 DHCP client 和 tftp client 的功能，为此 PXE 协议中将该功能以硬件的方式内置在网卡 ROM 中。当启动时，BIOS 会加载内置在网卡中的 ROM，从而该机器具备了 DHCP client 和 tftp client 的功能。</p>
<p>优点：</p>
<ol>
<li>规模化：可以批量实现多台服务器的安装</li>
<li>自动化：可以自动化安装</li>
<li>远程实现：不用本地的光盘来安装 OS</li>
</ol>
<p>客户机的前提条件：</p>
<ol>
<li>网络必须要支持 PXE 协议</li>
<li>主板支持网络引导，一般在 BIOS 中可以配置</li>
</ol>
<p>服务端：</p>
<ol>
<li>DHCP 服务，用来给客户机分配 ip 地址</li>
<li>TFTP 服务：用来提供操作系统文件的下载</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/tcp-fast-open/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/tcp-fast-open/" class="post-title-link" itemprop="url">TCP Fast Open</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-09-30 23:46:40" itemprop="dateCreated datePublished" datetime="2023-09-30T23:46:40+00:00">2023-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-08 12:45:01" itemprop="dateModified" datetime="2025-06-08T12:45:01+00:00">2025-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/tcp_fast_open.webp"></p>
<p>TCP Fast Open（TFO）是一种TCP协议的扩展，旨在加快建立TCP连接的速度和降低延迟。传统的TCP连接需要进行三次握手（SYN-SYN&#x2F;ACK-ACK）才能建立连接，而TFO允许在第一个数据包中携带连接建立的请求。</p>
<p>TFO的工作原理如下：</p>
<ol>
<li>客户端在首次建立TCP连接时，在发送的SYN包中插入一个加密的Cookie。这个Cookie由服务器生成并发送给客户端。</li>
<li>当客户端发送带有TFO Cookie的SYN包到服务器时，服务器会验证Cookie的有效性。</li>
<li>如果Cookie有效，服务器会立即发送带有SYN+ACK标志的数据包，这样客户端就可以立即发送数据而无需等待ACK响应。</li>
<li>客户端收到带有SYN+ACK标志的数据包后，发送带有ACK标志的数据包，建立完整的TCP连接。</li>
</ol>
<h1 id="相关内核参数"><a href="#相关内核参数" class="headerlink" title="相关内核参数"></a>相关内核参数</h1><h2 id="net-ipv4-tcp-fastopen"><a href="#net-ipv4-tcp-fastopen" class="headerlink" title="net.ipv4.tcp_fastopen"></a><code>net.ipv4.tcp_fastopen</code></h2><p>支持如下值：</p>
<ul>
<li>0：关闭</li>
<li>1: 作为客户端可以使用 TFO 功能</li>
<li>2: 作为服务端可以使用 TFO 功能</li>
<li>3: 作为客户端和服务端均可使用 TFO</li>
</ul>
<h2 id="net-ipv4-tcp-fastopen-key"><a href="#net-ipv4-tcp-fastopen-key" class="headerlink" title="net.ipv4.tcp_fastopen_key"></a><code>net.ipv4.tcp_fastopen_key</code></h2><p>用来产生 TFO 的 Cookie。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
