<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/page/3/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">235</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/flux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/flux/" class="post-title-link" itemprop="url">Flux（学习笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-06 23:42:46" itemprop="dateCreated datePublished" datetime="2022-05-06T23:42:46+00:00">2022-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h1><p>Flux为一款GitOPS的发布工具，应用信息全部放到git仓库中，一旦git仓库中应用信息有新的提交，Flux即可在k8s中发布新的部署。支持kustomize和helm chart形式的应用。目前该项目为CNCF的孵化项目。</p>
<h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2><ol>
<li>已经存在k8s集群</li>
<li>可以获取到Github的个人token</li>
</ol>
<h2 id="安装flux-cli"><a href="#安装flux-cli" class="headerlink" title="安装flux cli"></a>安装flux cli</h2><p>执行如下命令安装flux cli</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">https://fluxcd.io/install.sh</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">bash</span></span><br></pre></td></tr></table></figure>
<p>将如下内容追到到文件~&#x2F;.bash_profile</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.</span> <span class="string">&lt;(flux</span> <span class="string">completion</span> <span class="string">bash)</span></span><br></pre></td></tr></table></figure>
<h2 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h2><p>bootstrap操作会在k8s集群中安装flux到flux-system下，并且会通过git的方式来管理其自身。这里直接采用github，首先要获取到token，并设置为环境变量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">export</span> <span class="string">GITHUB_TOKEN=xxx</span></span><br></pre></td></tr></table></figure>
<p>并执行如下命令开始bootstrap</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">flux</span> <span class="string">bootstrap</span> <span class="string">github</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--owner=kuring</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--repository=flux-learn</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--path=clusters/my-cluster</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--personal</span></span><br></pre></td></tr></table></figure>
<p>会自动创建github repo，并且会在main分支的clusters&#x2F;my-cluster&#x2F;flux-system下创建三个文件：</p>
<ul>
<li>gotk-components.yaml：flux的组件yaml</li>
<li>gotk-sync.yaml</li>
<li>kustomization.yaml：使用kustomization来个性化flux组件</li>
</ul>
<p>会安装如下组件到k8s中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deployment</span> <span class="string">-n</span> <span class="string">flux-system</span> </span><br><span class="line"><span class="string">NAME</span>                      <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">helm-controller</span>           <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">27m</span></span><br><span class="line"><span class="string">kustomize-controller</span>      <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">27m</span></span><br><span class="line"><span class="string">notification-controller</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">27m</span></span><br><span class="line"><span class="string">source-controller</span>         <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">27m</span></span><br></pre></td></tr></table></figure>
<p>也可以使用更简单的方式<code>flux install</code>来安装flux，该命令不会将flux的安装信息存放到git仓库中，而是会直接安装。</p>
<h2 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h2><p>将上述的github项目copy到本地，需要特别注意的是github不允许使用密码来认证，需要在输入密码的地方输入token。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/kuring/flux-learn</span></span><br><span class="line"><span class="string">cd</span> <span class="string">fleet-infra</span></span><br></pre></td></tr></table></figure>
<p>使用如下命令在git仓库中创建podinfo-source.yaml文件和kustomization文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">flux</span> <span class="string">create</span> <span class="string">source</span> <span class="string">git</span> <span class="string">podinfo</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--url=https://github.com/stefanprodan/podinfo</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--branch=master</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--interval=30s</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--export</span> <span class="string">&gt;</span> <span class="string">./clusters/my-cluster/podinfo-source.yaml</span></span><br><span class="line">  </span><br><span class="line"><span class="string">flux</span> <span class="string">create</span> <span class="string">kustomization</span> <span class="string">podinfo</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--target-namespace=default</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--source=podinfo</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--path=&quot;./kustomize&quot;</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--prune=true</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--interval=5m</span> <span class="string">\</span></span><br><span class="line">  <span class="string">--export</span> <span class="string">&gt;</span> <span class="string">./clusters/my-cluster/podinfo-kustomization.yaml</span></span><br></pre></td></tr></table></figure>
<p>podinfo-source.yaml文件内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">source.toolkit.fluxcd.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">GitRepository</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flux-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">ref:</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://github.com/stefanprodan/podinfo</span></span><br></pre></td></tr></table></figure>
<p>podinfo-kustomization.yaml文件内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.toolkit.fluxcd.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flux-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">5m0s</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">./kustomize</span></span><br><span class="line">  <span class="attr">prune:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sourceRef:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">GitRepository</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">targetNamespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<p>执行如下命令将文件提供到git仓库</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">git</span> <span class="string">add</span> <span class="string">-A</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-m</span> <span class="string">&quot;Add podinfo GitRepository&quot;</span></span><br><span class="line"><span class="string">git</span> <span class="string">push</span></span><br></pre></td></tr></table></figure>
<p>查看podinfo的部署状态，说明已经自动部署成功。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">flux</span> <span class="string">get</span> <span class="string">kustomizations</span> <span class="string">--watch</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">REVISION</span>        <span class="string">SUSPENDED</span>       <span class="string">READY</span>   <span class="string">MESSAGE</span>                          </span><br><span class="line"><span class="attr">podinfo master/bf09377  False           True    Applied revision:</span> <span class="string">master/bf09377</span></span><br><span class="line"><span class="attr">flux-system     main/81f2115    False   True    Applied revision:</span> <span class="string">main/81f2115</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改podinfo-kustomization.yaml文件内容如下，并重新提交到git仓库</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.toolkit.fluxcd.io/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flux-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">5m0s</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">./kustomize</span></span><br><span class="line">  <span class="attr">prune:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sourceRef:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">GitRepository</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">targetNamespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">patches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">patch:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        apiVersion: autoscaling/v2beta2</span></span><br><span class="line"><span class="string">        kind: HorizontalPodAutoscaler</span></span><br><span class="line"><span class="string">        metadata:</span></span><br><span class="line"><span class="string">          name: podinfo</span></span><br><span class="line"><span class="string">        spec:</span></span><br><span class="line"><span class="string">          minReplicas: 3             </span></span><br><span class="line"><span class="string"></span>      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">        <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br></pre></td></tr></table></figure>
<p>过会可以看到环境中的hpa最小副本数已经变更为3.</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://fluxcd.io/">https://fluxcd.io/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/get_pod_by_pid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/get_pod_by_pid/" class="post-title-link" itemprop="url">根据pid获取到pod名称</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-06 14:45:20" itemprop="dateCreated datePublished" datetime="2022-05-06T14:45:20+00:00">2022-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在k8s的运维过程中，经常会有根据pid获取到pod名称的需求。比如某个pid占用cpu特别高，想知道是哪个pod里面的进程。</p>
<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><p>查看进程的cgroup信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/5760/cgroup </span><br><span class="line">11:rdma:/</span><br><span class="line">10:hugetlb:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">9:freezer:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">8:pids:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">7:perf_event:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">6:blkio:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">5:devices:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">4:memory:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">3:cpuset,cpu,cpuacct:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">2:net_cls,net_prio:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line">1:name=systemd:/apsara_k8s/kubepods/burstable/podf87c35b4-c170-4e1c-a726-d839e2fe6bea/17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中的 <code>17e15f78a43b2ddc7caff93bcc03d5ca7f5249fbee4c2ade5c3c96a7279af0a3</code> 即为容器的id，可以如下的命令直接获取到容器的pid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CID=$(cat /proc/5760/cgroup | awk -F &#x27;/&#x27; &#x27;&#123;print $6&#125;&#x27;)</span><br><span class="line">echo $&#123;CID:0:8&#125;</span><br></pre></td></tr></table></figure>

<p>继续执行如下命令查看docker的label</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker  inspect 17e15f --format &quot;&#123;&#123;json .Config.Labels&#125;&#125;&quot; </span><br></pre></td></tr></table></figure>

<p>其中io.kubernetes.pod.namespace为pod所在的namespace，io.kubernetes.pod.name为pod的name。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://icloudnative.io/posts/find-kubernetes-pod-info-from-process-id/">Kubernetes 教程：根据 PID 获取 Pod 名称</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/cuelang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/cuelang/" class="post-title-link" itemprop="url">cue语言（个人笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-04 23:24:34" itemprop="dateCreated datePublished" datetime="2022-05-04T23:24:34+00:00">2022-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>cue为使用golang编写的一款配置语言。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>mac用户执行：<code>brew install cue-lang/tap/cue</code>，其他操作系统用户可以直接使用源码安装：<code>go install cuelang.org/go/cmd/cue@latest</code></p>
<h1 id="命令行使用"><a href="#命令行使用" class="headerlink" title="命令行使用"></a>命令行使用</h1><p>创建如下文件first.cue</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a: 1.5</span><br><span class="line">a: float</span><br><span class="line">b: 1</span><br><span class="line">b: int</span><br><span class="line">d: [1, 2, 3]</span><br><span class="line">g: &#123;</span><br><span class="line">    h: &quot;abc&quot;</span><br><span class="line">&#125;</span><br><span class="line">e: string</span><br></pre></td></tr></table></figure>

<ul>
<li>cue fmt first.cue：对代码进行格式化</li>
<li>cue vet first.cue：校验语法的正确性</li>
<li>cue eval first.cue：获得渲染结果</li>
<li>cue export first.cue：将渲染结果以json格式的形式导出，如果指定参数–out yaml，则可以以yaml方式导出。如果要导出某个变量，可以使用-e参数来指定变量。</li>
</ul>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="基础数据类型"><a href="#基础数据类型" class="headerlink" title="基础数据类型"></a>基础数据类型</h2><p>支持的数据类型包括：float、int、string、array、bool、struct、null、自定义数据类型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">float</span></span><br><span class="line"><span class="attr">a:</span> <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">int</span></span><br><span class="line"><span class="attr">b:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">string</span></span><br><span class="line"><span class="attr">c:</span> <span class="string">&quot;blahblahblah&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">array</span></span><br><span class="line"><span class="attr">d:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">bool</span></span><br><span class="line"><span class="attr">e:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">struct</span></span><br><span class="line"><span class="attr">f:</span> &#123;</span><br><span class="line">    <span class="attr">a:</span> <span class="number">1.5</span></span><br><span class="line">    <span class="attr">b:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">d:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">    <span class="attr">g:</span> &#123;</span><br><span class="line">        <span class="attr">h:</span> <span class="string">&quot;abc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">j:</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">表示两种类型的值，即可以是string，也可以是int</span></span><br><span class="line"><span class="attr">h:</span> <span class="string">string</span> <span class="string">|</span> <span class="string">int</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">表示k的默认值为1，且类型为int</span></span><br><span class="line"><span class="attr">k:</span> <span class="string">*1</span> <span class="string">|</span> <span class="string">int</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">自定义数据类型</span></span><br><span class="line"><span class="comment">#abc: string</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>更复杂的自定义数据类型如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#abc: &#123;</span></span><br><span class="line">  <span class="attr">x:</span> <span class="string">int</span></span><br><span class="line">  <span class="attr">y:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">z:</span> &#123;</span><br><span class="line">    <span class="attr">a:</span> <span class="string">float</span></span><br><span class="line">    <span class="attr">b:</span> <span class="string">bool</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="定义cue模板"><a href="#定义cue模板" class="headerlink" title="定义cue模板"></a>定义cue模板</h2><p>文件deployment.cue定义如下内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">自定义结构体类型</span></span><br><span class="line"><span class="comment">#parameter: &#123;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">string</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">template:</span> &#123;</span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">&quot;apps/v1&quot;</span></span><br><span class="line">    <span class="attr">kind:</span>       <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">    <span class="attr">spec:</span> &#123;</span><br><span class="line">        <span class="attr">selector: matchLabels:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;app.oam.dev/component&quot;:</span> <span class="string">parameter.name</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attr">template:</span> &#123;</span><br><span class="line">            <span class="attr">metadata: labels:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;app.oam.dev/component&quot;:</span> <span class="string">parameter.name</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attr">spec:</span> &#123;</span><br><span class="line">                <span class="attr">containers:</span> [&#123;</span><br><span class="line">                    <span class="attr">name:</span>  <span class="string">parameter.name</span>  <span class="string">//</span> <span class="string">引用自定义结构体变量parameter</span></span><br><span class="line">                    <span class="attr">image:</span> <span class="string">parameter.image</span></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">parameter:&#123;</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">&quot;mytest&quot;</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">&quot;nginx:v1&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行 cue export deployment.cue -e template –out yaml 可获取到渲染结果。</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://cuelang.org/docs/install/">Getting Started</a></li>
<li><a target="_blank" rel="noopener" href="https://kubevela.io/zh/docs/platform-engineers/cue/basic">CUE语言基础入门</a></li>
<li><a target="_blank" rel="noopener" href="https://cuetorials.com/zh/introduction/">Cuetorials</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/tekton/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/tekton/" class="post-title-link" itemprop="url">tekton（个人笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-16 22:56:52" itemprop="dateCreated datePublished" datetime="2022-04-16T22:56:52+00:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>从<a target="_blank" rel="noopener" href="https://github.com/tektoncd/cli/releases">https://github.com/tektoncd/cli/releases</a>下载tkn工具，该工具为tekton的命令行工具。</p>
<p>执行如下命令安装dashboard</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">--filename</span> <span class="string">https://github.com/tektoncd/dashboard/releases/latest/download/tekton-dashboard-release.yaml</span></span><br></pre></td></tr></table></figure>
<p>dashboard安装完成后仅申请了ClusterIP类型的Service，可以在本地通过kubectl端口转发的方式来对外提供服务，既可以通过ip:9097的方式来对外提供服务了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="literal">--namespace</span> tekton<span class="literal">-pipelines</span> port<span class="literal">-forward</span> svc/tekton<span class="literal">-dashboard</span> <span class="number">9097</span>:<span class="number">9097</span> <span class="literal">--address</span> <span class="number">0.0</span>.<span class="number">0.0</span> </span><br></pre></td></tr></table></figure>
<p>执行如下命令，在k8s中提交yaml</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply <span class="literal">--filename</span> \ https://storage.googleapis.com/tekton<span class="literal">-releases</span>/pipeline/latest/release.yaml</span><br></pre></td></tr></table></figure>
<p>会在k8s中提交如下两个deployment，此时tekton即安装完毕。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl  get deploy <span class="literal">-n</span> tekton<span class="literal">-pipelines</span> </span><br><span class="line">NAME                          READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">tekton<span class="literal">-pipelines-controller</span>   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">4</span>m</span><br><span class="line">tekton<span class="literal">-pipelines-webhook</span>      <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">4</span>m</span><br></pre></td></tr></table></figure>
<h2 id="创建task"><a href="#创建task" class="headerlink" title="创建task"></a>创建task</h2><p>创建如下yaml，提交一个任务定义，提交完成后任务并不会被执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: tekton.dev/v1beta1</span><br><span class="line">kind: Task</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  steps:</span><br><span class="line">    - name: <span class="built_in">echo</span></span><br><span class="line">      image: alpine</span><br><span class="line">      script: |</span><br><span class="line">        <span class="comment">#!/bin/sh</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span>  </span><br></pre></td></tr></table></figure>
<p>继续提交如下的yaml，提交一次任务运行实例</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: tekton.dev/v1beta1</span><br><span class="line">kind: TaskRun</span><br><span class="line">metadata:</span><br><span class="line">  name: hello<span class="literal">-task-run</span></span><br><span class="line">spec:</span><br><span class="line">  taskRef:</span><br><span class="line">    name: hello</span><br></pre></td></tr></table></figure>
<p>查看任务执行情况</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> kubectl get taskrun hello<span class="literal">-task-run</span></span><br><span class="line">NAME             SUCCEEDED   REASON      STARTTIME   COMPLETIONTIME</span><br><span class="line">hello<span class="literal">-task-run</span>   True        Succeeded   <span class="number">45</span>s         <span class="number">22</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到创建出了任务执行的pod</span></span><br><span class="line"><span class="variable">$</span> kubectl  get pod </span><br><span class="line">NAME                 READY   STATUS      RESTARTS   AGE</span><br><span class="line">hello<span class="literal">-task-run-pod</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">2</span>m10s</span><br></pre></td></tr></table></figure>
<h2 id="创建流水线任务pipeline"><a href="#创建流水线任务pipeline" class="headerlink" title="创建流水线任务pipeline"></a>创建流水线任务pipeline</h2><p>创建新的task goodye</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Task</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goodbye</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goodbye</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line">      <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        #!/bin/bash</span></span><br><span class="line"><span class="string">        echo &quot;Goodbye World!&quot;</span></span><br></pre></td></tr></table></figure>
<p>提交如下yaml，创建pipeline定义</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: tekton.dev/v1beta1</span><br><span class="line">kind: Pipeline</span><br><span class="line">metadata:</span><br><span class="line">  name: hello<span class="literal">-goodbye</span></span><br><span class="line">spec:</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello</span><br><span class="line">      taskRef:</span><br><span class="line">        name: hello</span><br><span class="line">    - name: goodbye</span><br><span class="line">      runAfter:</span><br><span class="line">        - hello</span><br><span class="line">      taskRef:</span><br><span class="line">        name: goodbye</span><br></pre></td></tr></table></figure>
<p>提交如下yaml，创建pipeline实例。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: tekton.dev/v1beta1</span><br><span class="line">kind: PipelineRun</span><br><span class="line">metadata:</span><br><span class="line">  name: hello<span class="literal">-goodbye-run</span></span><br><span class="line">spec:</span><br><span class="line">  pipelineRef:</span><br><span class="line">    name: hello<span class="literal">-goodbye</span></span><br></pre></td></tr></table></figure>
<p>可以使用tkn来查看pipeline拉起的pod日志，该工具会将pod的日志合并到一起。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">tkn</span> <span class="string">pipelinerun</span> <span class="string">logs</span> <span class="string">hello-goodbye-run</span> <span class="string">-f</span> <span class="string">-n</span> <span class="string">default</span></span><br><span class="line">[<span class="attr">hello :</span> <span class="string">echo</span>] <span class="string">Hello</span> <span class="string">World</span></span><br><span class="line"></span><br><span class="line">[<span class="attr">goodbye :</span> <span class="string">goodbye</span>] <span class="string">Goodbye</span> <span class="string">World!</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/pod-memory-stats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/pod-memory-stats/" class="post-title-link" itemprop="url">内存使用分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-14 20:33:17" itemprop="dateCreated datePublished" datetime="2022-04-14T20:33:17+00:00">2022-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="操作系统级别"><a href="#操作系统级别" class="headerlink" title="操作系统级别"></a>操作系统级别</h2><h3 id="x2F-proc-x2F-meminfo"><a href="#x2F-proc-x2F-meminfo" class="headerlink" title="&#x2F;proc&#x2F;meminfo"></a>&#x2F;proc&#x2F;meminfo</h3><p>其中的Buffers和Cached的迷惑性非常大，非常难理解。Buffers是指的磁盘数据的缓存，Cached是指对文件数据的缓存.</p>
<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><p>该命令实际上是通过读取&#x2F;proc&#x2F;meminfo文件得到的如下输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            30G         22G        412M         47M        7.6G        7.3G</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure>

<p>具体列含义：</p>
<ul>
<li>total: 总内存大小</li>
<li>used：已经使用的内存大小，包含共享内存</li>
<li>free：未使用的内存大小</li>
<li>shared：共享内存大小</li>
<li>buff&#x2F;cache：缓存和缓冲区的大小</li>
<li>available：新进程可用的内存大小</li>
</ul>
<h3 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vmstat 1</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 4  0      0 1091484 1142360 34545436    0    0   146   265    0    0  8  5 86  1  0</span><br></pre></td></tr></table></figure>

<h2 id="容器级别"><a href="#容器级别" class="headerlink" title="容器级别"></a>容器级别</h2><h3 id="通过kubectl命令来查看内存使用"><a href="#通过kubectl命令来查看内存使用" class="headerlink" title="通过kubectl命令来查看内存使用"></a>通过kubectl命令来查看内存使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top pod nginx-ingress-controller-85cd6c7b5d-md6vc</span><br><span class="line">NAME                                        CPU(cores)   MEMORY(bytes)</span><br><span class="line">nginx-ingress-controller-85cd6c7b5d-md6vc   22m          502Mi</span><br></pre></td></tr></table></figure>

<h3 id="通过docker-stats命令来查看容器"><a href="#通过docker-stats命令来查看容器" class="headerlink" title="通过docker stats命令来查看容器"></a>通过docker stats命令来查看容器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker stats $container_id</span><br><span class="line">CONTAINER ID  NAME                CPU %   MEM USAGE / LIMIT   MEM %  NET I/O   BLOCK I/O           PIDS</span><br><span class="line">97d8bff3f89f  k8s_nginx-ingress   6.33%   180.3MiB / 512MiB   35.21% 0B / 0B   0B / 0B             119</span><br></pre></td></tr></table></figure>

<p>docker通过cgroup的统计数据来获取的内存值</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stats/">https://docs.docker.com/engine/reference/commandline/stats/</a></p>
<h2 id="进程级别"><a href="#进程级别" class="headerlink" title="进程级别"></a>进程级别</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/vm-1.png"></p>
<p>具体的含义可以通过下文的&#x2F;proc&#x2F;$pid&#x2F;status来查看，其他进程的内存含义</p>
<h3 id="cat-x2F-proc-x2F-pid-x2F-status"><a href="#cat-x2F-proc-x2F-pid-x2F-status" class="headerlink" title="cat &#x2F;proc&#x2F;$pid&#x2F;status"></a>cat &#x2F;proc&#x2F;$pid&#x2F;status</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat status</span><br><span class="line">Name:   nginx</span><br><span class="line">Umask:  0022</span><br><span class="line">State:  S (sleeping)</span><br><span class="line">Tgid:   46787</span><br><span class="line">Ngid:   0</span><br><span class="line">Pid:    46787</span><br><span class="line">PPid:   33</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    1000    1000    1000    1000</span><br><span class="line">Gid:    19062   19062   19062   19062</span><br><span class="line">FDSize: 128</span><br><span class="line">Groups:</span><br><span class="line">VmPeak:   559768 kB</span><br><span class="line">VmSize:   559120 kB</span><br><span class="line">VmLck:         0 kB</span><br><span class="line">VmPin:         0 kB</span><br><span class="line">VmHWM:    285240 kB</span><br><span class="line">VmRSS:    284752 kB</span><br><span class="line">RssAnon:          279016 kB</span><br><span class="line">RssFile:            3420 kB</span><br><span class="line">RssShmem:           2316 kB</span><br><span class="line">VmData:   371784 kB</span><br><span class="line">VmStk:       136 kB</span><br><span class="line">VmExe:      4716 kB</span><br><span class="line">VmLib:      6828 kB</span><br><span class="line">VmPTE:       900 kB</span><br><span class="line">VmSwap:        0 kB</span><br><span class="line">Threads:        33</span><br><span class="line">SigQ:   1/123857</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000000000</span><br><span class="line">SigIgn: 0000000040001000</span><br><span class="line">SigCgt: 0000000198016eef</span><br><span class="line">CapInh: 0000001fffffffff</span><br><span class="line">CapPrm: 0000000000000400</span><br><span class="line">CapEff: 0000000000000400</span><br><span class="line">CapBnd: 0000001fffffffff</span><br><span class="line">CapAmb: 0000000000000000</span><br><span class="line">NoNewPrivs:     0</span><br><span class="line">Seccomp:        0</span><br><span class="line">Speculation_Store_Bypass:       vulnerable</span><br><span class="line">Cpus_allowed:   0001</span><br><span class="line">Cpus_allowed_list:      0</span><br><span class="line">Mems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001</span><br><span class="line">Mems_allowed_list:      0</span><br><span class="line">voluntary_ctxt_switches:        343464</span><br><span class="line">nonvoluntary_ctxt_switches:     35061</span><br></pre></td></tr></table></figure>

<p>具体字段含义可以查看man文档：<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man5/proc.5.html%EF%BC%8C%E8%B7%9F%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AD%97%E6%AE%B5%E5%A6%82%E4%B8%8B%EF%BC%9A">https://man7.org/linux/man-pages/man5/proc.5.html，跟内存相关的字段如下：</a></p>
<ul>
<li>VmRSS：虚拟内存驻留在物理内存中的部分大小</li>
<li>VmHWM：使用物理内存的峰值</li>
<li>VmData：进程占用的数据段大小</li>
</ul>
<h3 id="top命令查看"><a href="#top命令查看" class="headerlink" title="top命令查看"></a>top命令查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ top -p $pid</span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">  46787 www-data  20   0  559120 286544   5740 S   1.3  0.9   2:43.64 nginx</span><br></pre></td></tr></table></figure>

<p>具体列含义如下：</p>
<ul>
<li>VIRT：进程使用虚拟内存总大小，即使没有占用物理内存，包括了进程代码段、数据段、共享内存、已经申请的堆内存和已经换到swap空间的内存等</li>
<li>RES: 进程实际使用的物理内存大小，不包括swap和共享内存</li>
<li>SHR：与其他进程的共享内存、加载的动态链接库、程序代码段的大小</li>
<li>MEM：进程使用的物理内存占系统总内存的百分比</li>
</ul>
<h3 id="ps命令查看"><a href="#ps命令查看" class="headerlink" title="ps命令查看"></a>ps命令查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ps aux</span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">www-data       1  0.0  0.0    212     8 ?        Ss   Apr09   0:00 /usr/bin/dumb-init -- /nginx-ingress-controller</span><br><span class="line">www-data       6  0.9  0.3 813500 99644 ?        Ssl  Apr09  67:32 /nginx-ingress-controller</span><br><span class="line">www-data      33  0.0  0.7 458064 242252 ?       S    Apr09   0:53 nginx: master process /usr/local/nginx/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">www-data   46786  0.0  0.7 459976 239996 ?       S    17:57   0:00 rollback logs/eagleeye.log interval=60 adjust=600</span><br><span class="line">www-data   46787  1.3  0.8 559120 284452 ?       Sl   17:57   2:22 nginx: worker process</span><br><span class="line">www-data   46788  1.0  0.8 558992 285168 ?       Sl   17:57   1:51 nginx: worker process</span><br><span class="line">www-data   46789  0.0  0.7 452012 237152 ?       S    17:57   0:01 nginx: cache manager process</span><br><span class="line">www-data   46790  0.0  0.8 490832 267600 ?       S    17:57   0:00 nginx: x</span><br><span class="line">www-data   47533  0.0  0.0  60052  1832 pts/2    R+   20:50   0:00 ps aux</span><br></pre></td></tr></table></figure>

<ul>
<li>RSS：虚拟内存中的常驻内存，即实际占用的物理内存，包括所有已经分配的堆内存、栈内存、共享内存，由于共享内存非独占，实际上进程独占的物理内存要少于RSS</li>
</ul>
<h3 id="pmap"><a href="#pmap" class="headerlink" title="pmap"></a>pmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"># pmap -x 452021</span><br><span class="line">452021:   nginx: worker process</span><br><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">0000000000400000    4716    1540       0 r-x-- tengine</span><br><span class="line">0000000000a9a000      20      16       4 r---- tengine</span><br><span class="line">0000000000a9f000     212     196     176 rw--- tengine</span><br><span class="line">0000000000ad4000     248      60      60 rw---   [ anon ]</span><br><span class="line">00002b0da6cb0000     136       4       0 r-x-- ld-2.17.so</span><br><span class="line">00002b0da6cd2000       4       4       4 rw---   [ anon ]</span><br><span class="line">00002b0da6cd3000       4       4       4 rw-s- zero (deleted)</span><br><span class="line">00002b0da6cd7000      28      24      24 rw---   [ anon ]</span><br><span class="line">00002b0da6cde000      64       8       8 rwx--   [ anon ]</span><br><span class="line">00002b0da6ed1000       4       4       4 r---- ld-2.17.so</span><br><span class="line">00002b0da6ed2000       4       4       4 rw--- ld-2.17.so</span><br><span class="line">00002b0da6ed3000       4       4       4 rw---   [ anon ]</span><br><span class="line">00002b0da6ed4000       8       0       0 r-x-- libdl-2.17.so</span><br><span class="line">00002b0da70d8000      92      32       0 r-x-- libpthread-2.17.so</span><br><span class="line">00002b0da72f0000      16       4       4 rw---   [ anon ]</span><br><span class="line">00002b0da72f4000      32       0       0 r-x-- libcrypt-2.17.so</span><br><span class="line">00002b0da72fc000    2044       0       0 ----- libcrypt-2.17.so</span><br><span class="line">00002b0da74fb000       4       4       4 r---- libcrypt-2.17.so</span><br><span class="line">00002b0da74fc000       4       4       4 rw--- libcrypt-2.17.so</span><br><span class="line">00002b0da74fd000     184       0       0 rw---   [ anon ]</span><br><span class="line">00002b0da752b000    1028       8       0 r-x-- libm-2.17.so</span><br><span class="line">00002b0da7a35000     760     372       0 r-x-- libssl.so.1.1</span><br><span class="line">00002b0da7d03000    2812    1124       0 r-x-- libcrypto.so.1.1</span><br><span class="line">00002b0da7fc2000    2044       0       0 ----- libcrypto.so.1.1</span><br><span class="line">00002b0da81c1000     172     172     172 r---- libcrypto.so.1.1</span><br><span class="line">00002b0da81ec000      12      12      12 rw--- libcrypto.so.1.1</span><br><span class="line">00002b0da81ef000      16       8       8 rw---   [ anon ]</span><br><span class="line">00002b0da81f3000      84      40       0 r-x-- libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">00002b0da8409000    1808     316       0 r-x-- libc-2.17.so</span><br><span class="line">00002b0da85cd000    2044       0       0 ----- libc-2.17.so</span><br><span class="line">00002b0da87cc000      16      16      16 r---- libc-2.17.so</span><br><span class="line">00002b0da87d0000       8       8       8 rw--- libc-2.17.so</span><br><span class="line">00002b0da87d2000      20      12      12 rw---   [ anon ]</span><br><span class="line">00002b0da87d7000       8       0       0 r-x-- libfreebl3.so</span><br><span class="line">00002b0da87d9000    2044       0       0 ----- libfreebl3.so</span><br><span class="line">00002b0da89d8000       4       4       4 r---- libfreebl3.so</span><br><span class="line">00002b0da89d9000       4       4       4 rw--- libfreebl3.so</span><br><span class="line">00002b0da8a00000   24576   21936   21936 rw---   [ anon ]</span><br><span class="line">00002b0daa200000    8192    8180    8180 rw---   [ anon ]</span><br><span class="line">00002b0daaa00000    8192    8192    8192 rw---   [ anon ]</span><br><span class="line">00002b0dab200000    8192    8192    8192 rw---   [ anon ]</span><br><span class="line">00002b0daba00000    8192    8172    8172 rw---   [ anon ]</span><br><span class="line">00002b0dac200000    4096    4096    4096 rw---   [ anon ]</span><br><span class="line">00002b0dac600000    4096    4096    4096 rw---   [ anon ]</span><br><span class="line">00002b0daca00000    4096      12      12 rw-s- zero (deleted)</span><br><span class="line">00002b0dace00000    1024       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0dacf00000    1024       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0dad000000   16384   16384   16384 rw---   [ anon ]</span><br><span class="line">00002b0dae000000   10240       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0db3f00000      24      16       0 r-x-- cjson.so</span><br><span class="line">00002b0db3f06000    2048       0       0 ----- cjson.so</span><br><span class="line">00002b0db4106000       4       4       4 r---- cjson.so</span><br><span class="line">00002b0db4107000       4       4       4 rw--- cjson.so</span><br><span class="line">00002b0db4108000       8       0       0 r-x-- librestychash.so</span><br><span class="line">00002b0db410a000    2044       0       0 ----- librestychash.so</span><br><span class="line">00002b0db4309000       4       4       4 r---- librestychash.so</span><br><span class="line">00002b0db430a000       4       4       4 rw--- librestychash.so</span><br><span class="line">00002b0db430b000   10240    1784    1784 rw-s- zero (deleted)</span><br><span class="line">00002b0db4d0b000   10240       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0db5800000    6144    6144    6144 rw---   [ anon ]</span><br><span class="line">00002b0db5e00000    6144    6144    6144 rw---   [ anon ]</span><br><span class="line">00002b0db6400000    8192    8192    8192 rw---   [ anon ]</span><br><span class="line">00002b0db6c0b000    5120       8       8 rw-s- zero (deleted)</span><br><span class="line">00002b0db7200000    8192    8192    8192 rw---   [ anon ]</span><br><span class="line">00002b0dc2800000    1024       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0dc2900000   10240       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0dc3300000   10240       0       0 rw-s- zero (deleted)</span><br><span class="line">00002b0dc861f000    2048       8       8 rw---   [ anon ]</span><br><span class="line">00002b0dc881f000       4       0       0 -----   [ anon ]</span><br><span class="line">00002b0dc8820000    2048       8       8 rw---   [ anon ]</span><br><span class="line">00007fff60f6c000     136      44      44 rw---   [ stack ]</span><br><span class="line">00007fff60fdd000       8       4       0 r-x--   [ anon ]</span><br><span class="line">ffffffffff600000       4       0       0 r-x--   [ anon ]</span><br><span class="line">---------------- ------- ------- -------</span><br><span class="line">total kB          558996  289376  285888</span><br></pre></td></tr></table></figure>

<ul>
<li>Mapping: 支持如下值<ul>
<li>[anon]：分配的内存</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/knative/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/knative/" class="post-title-link" itemprop="url">knative（个人笔记）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-01 21:16:00" itemprop="dateCreated datePublished" datetime="2022-04-01T21:16:00+00:00">2022-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h1><p>待补充</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>下载kind命令，但不需要创建一个k8s集群。</p>
<p>执行如下命令下载kn 二进制文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">wget</span> <span class="string">https://github.com/knative/client/releases/download/knative-v1.2.0/kn-linux-amd64</span></span><br><span class="line"><span class="string">mv</span> <span class="string">kn-linux-amd64</span> <span class="string">/usr/local/bin/kn</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/kn</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动补全</span></span><br><span class="line"><span class="string">echo</span> <span class="string">-e</span> <span class="string">&quot;\n# kn&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">~/.bash_profile</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&#x27;source &lt;(kn completion bash)&#x27;</span> <span class="string">&gt;&gt;~/.bash_profile</span></span><br></pre></td></tr></table></figure>
<p>下载quickstart二进制文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">wget</span> <span class="string">https://github.com/knative-sandbox/kn-plugin-quickstart/releases/download/knative-v1.2.0/kn-quickstart-linux-amd64</span></span><br><span class="line"><span class="string">mv</span> <span class="string">kn-quickstart-linux-amd64</span> <span class="string">/usr/local/bin/kn-quickstart</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/kn-quickstart</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 如下两条命令可以得到相同的输出结果</span></span><br><span class="line"><span class="string">kn</span> <span class="string">quickstart</span> <span class="string">--help</span></span><br><span class="line"><span class="string">kn-quickstart</span> <span class="string">--help</span></span><br></pre></td></tr></table></figure>
<p>执行 kn quickstart kind 命令即可创建出一个knative的k8s集群。</p>
<h1 id="knative-serving"><a href="#knative-serving" class="headerlink" title="knative serving"></a>knative serving</h1><p>serving的核心功能为提供弹性扩缩容能力。</p>
<h2 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h2><p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/220839/1647100343983-06e5baa7-13fb-4c21-a2d3-ce5dc7a1a50c.png#clientId=uf314a495-0864-4&from=paste&height=424&id=ud95a644c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=424&originWidth=540&originalType=binary&ratio=1&size=23832&status=done&style=none&taskId=u80bb136a-1106-43dc-8c93-f62a6fbbe2a&width=540" alt="image.png"><br>Service：用来管理整个应用的生命周期。<br>Route：用来将流量分发到不同的Revision<br>Configuration：<br>Revision：</p>
<p>kpa功能</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="最简单service"><a href="#最简单service" class="headerlink" title="最简单service"></a>最简单service</h3><p>创建hello.yaml文件，内容如下，并执行 kubectl apply -f hello.yaml。其中service的名字为hello，revision的名字为world。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># This is the name of our new &quot;Revision,&quot; it must follow the convention &#123;service-name&#125;-&#123;revision-name&#125;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/knative-samples/helloworld-go</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TARGET</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;World&quot;</span></span><br></pre></td></tr></table></figure>
<p>通过kn命令可以看到创建了一个service hello，并且有一个可以访问的url地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kn service list</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">URL</span>                                       <span class="string">LATEST</span>        <span class="string">AGE</span>    <span class="string">CONDITIONS</span>   <span class="string">READY</span>   <span class="string">REASON</span></span><br><span class="line"><span class="string">hello</span>   <span class="string">http://hello.default.127.0.0.1.sslip.io</span>   <span class="string">hello-world</span>   <span class="string">154m</span>   <span class="number">3</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">3</span>     <span class="literal">True</span>  </span><br></pre></td></tr></table></figure>
<p>knative抽象了Revision来标识该service对应的版本信息，可以使用kubectl命令，也可以使用kn命令来查看revision信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">revisions.serving.knative.dev</span> </span><br><span class="line"><span class="string">NAME</span>          <span class="string">CONFIG</span> <span class="string">NAME</span>   <span class="string">K8S</span> <span class="string">SERVICE</span> <span class="string">NAME</span>   <span class="string">GENERATION</span>   <span class="string">READY</span>   <span class="string">REASON</span>   <span class="string">ACTUAL</span> <span class="string">REPLICAS</span>   <span class="string">DESIRED</span> <span class="string">REPLICAS</span></span><br><span class="line"><span class="string">hello-world</span>   <span class="string">hello</span>                            <span class="number">1</span>            <span class="literal">True</span>             <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line"><span class="string">$</span> <span class="string">kn</span> <span class="string">revision</span> <span class="string">list</span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">SERVICE</span>   <span class="string">TRAFFIC</span>   <span class="string">TAGS</span>   <span class="string">GENERATION</span>   <span class="string">AGE</span>     <span class="string">CONDITIONS</span>   <span class="string">READY</span>   <span class="string">REASON</span></span><br><span class="line"><span class="string">hello-world</span>   <span class="string">hello</span>     <span class="number">100</span><span class="string">%</span>             <span class="number">1</span>            <span class="string">6m33s</span>   <span class="number">3</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">4</span>     <span class="literal">True</span>  </span><br></pre></td></tr></table></figure>

<p>在宿主机上执行 curl <a target="_blank" rel="noopener" href="http://hello.default.127.0.0.1.sslip.io/">http://hello.default.127.0.0.1.sslip.io</a> 接口访问刚才创建的service。这里比较有意思的是为什么域名可以在宿主机上解析，该域名实际上是通过公网来解析的，域名服务器sslip.io负责该域名的解析。<br>本机的127.0.0.1的80端口实际是指向的是kind容器的31080端口，而31080为kourier-ingress对外暴露的服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl  get svc -A | grep 31080</span></span><br><span class="line"><span class="string">kourier-system</span>     <span class="string">kourier-ingress</span>   <span class="string">NodePort</span>       <span class="number">10.96</span><span class="number">.252</span><span class="number">.144</span>   <span class="string">&lt;none&gt;</span>    <span class="number">80</span><span class="string">:31080/TCP</span>     <span class="string">3h16m</span></span><br></pre></td></tr></table></figure>
<p>kourier-ingress为knative使用的ingress服务，该ingress并非k8s原生的ingress对象，而是自定义的ingress networking.internal.knative.dev&#x2F;v1alpha1。service hello在创建的时候会同步创建一个ingress对象。在该ingress对象中可以看到刚才访问的域名hello.default.127.0.0.1.sslip.io，同时可以看到该ingress将域名指向到了k8s的service hello-world.default。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span>  <span class="string">get</span>  <span class="string">ingresses.networking.internal.knative.dev</span> <span class="string">hello</span> <span class="string">-o</span> <span class="string">yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.internal.knative.dev/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">networking.internal.knative.dev/rollout:</span> <span class="string">&#x27;&#123;&quot;configurations&quot;:[&#123;&quot;configurationName&quot;:&quot;hello&quot;,&quot;percent&quot;:100,&quot;revisions&quot;:[&#123;&quot;revisionName&quot;:&quot;hello-world&quot;,&quot;percent&quot;:100&#125;],&quot;stepParams&quot;:&#123;&#125;&#125;]&#125;&#x27;</span></span><br><span class="line">    <span class="attr">networking.knative.dev/ingress.class:</span> <span class="string">kourier.ingress.networking.knative.dev</span></span><br><span class="line">    <span class="attr">serving.knative.dev/creator:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">    <span class="attr">serving.knative.dev/lastModifier:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">finalizers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses.networking.internal.knative.dev</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">serving.knative.dev/route:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">serving.knative.dev/routeNamespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">serving.knative.dev/service:</span> <span class="string">hello</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Route</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">4c58e77b-4871-42cc-bfa0-aa9fda9646ed</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">httpOption:</span> <span class="string">Enabled</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hello.default</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hello.default.svc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hello.default.svc.cluster.local</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">splits:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">appendHeaders:</span></span><br><span class="line">            <span class="attr">Knative-Serving-Namespace:</span> <span class="string">default</span></span><br><span class="line">            <span class="attr">Knative-Serving-Revision:</span> <span class="string">hello-world</span></span><br><span class="line">          <span class="attr">percent:</span> <span class="number">100</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">hello-world</span></span><br><span class="line">          <span class="attr">serviceNamespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">visibility:</span> <span class="string">ClusterLocal</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hello.default.127.0.0.1.sslip.io</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">splits:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">appendHeaders:</span></span><br><span class="line">            <span class="attr">Knative-Serving-Namespace:</span> <span class="string">default</span></span><br><span class="line">            <span class="attr">Knative-Serving-Revision:</span> <span class="string">hello-world</span></span><br><span class="line">          <span class="attr">percent:</span> <span class="number">100</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">hello-world</span></span><br><span class="line">          <span class="attr">serviceNamespace:</span> <span class="string">default</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">visibility:</span> <span class="string">ExternalIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:47:26Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">LoadBalancerReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:47:26Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">NetworkConfigured</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:47:26Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">privateLoadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">domainInternal:</span> <span class="string">kourier-internal.kourier-system.svc.cluster.local</span></span><br><span class="line">  <span class="attr">publicLoadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">domainInternal:</span> <span class="string">kourier.kourier-system.svc.cluster.local</span></span><br></pre></td></tr></table></figure>
<p>在default namespace下可以看到有三个service，其中hello-world的ingress转发的service。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k get svc | grep hello</span></span><br><span class="line"><span class="string">hello</span>                                   <span class="string">ExternalName</span>   <span class="string">&lt;none&gt;</span>         <span class="string">kourier-internal.kourier-system.svc.cluster.local</span>   <span class="number">80</span><span class="string">/TCP</span>                                       <span class="string">155m</span></span><br><span class="line"><span class="string">hello-world</span>                             <span class="string">ClusterIP</span>      <span class="number">10.96</span><span class="number">.58</span><span class="number">.149</span>   <span class="string">&lt;none&gt;</span>                                              <span class="number">80</span><span class="string">/TCP</span>                                       <span class="string">155m</span></span><br><span class="line"><span class="string">hello-world-private</span>                     <span class="string">ClusterIP</span>      <span class="number">10.96</span><span class="number">.54</span><span class="number">.163</span>   <span class="string">&lt;none&gt;</span>                                              <span class="number">80</span><span class="string">/TCP,9090/TCP,9091/TCP,8022/TCP,8012/TCP</span>   <span class="string">155m</span></span><br></pre></td></tr></table></figure>
<p>通过查看该serivce的yaml，并未定义serivce的selector。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">autoscaling.knative.dev/class:</span> <span class="string">kpa.autoscaling.knative.dev</span></span><br><span class="line">    <span class="attr">serving.knative.dev/creator:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">networking.internal.knative.dev/serverlessservice:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">networking.internal.knative.dev/serviceType:</span> <span class="string">Public</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configuration:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configurationGeneration:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configurationUID:</span> <span class="string">13138d0f-ee5f-4631-94a5-6928546e504c</span></span><br><span class="line">    <span class="attr">serving.knative.dev/revision:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">serving.knative.dev/revisionUID:</span> <span class="string">f3aaae74-6b79-4785-b60d-5607c0ab3bcf</span></span><br><span class="line">    <span class="attr">serving.knative.dev/service:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">serving.knative.dev/serviceUID:</span> <span class="number">79907029</span><span class="string">-32df-4f21-b14b-ed7d24e1a10e</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">networking.internal.knative.dev/v1alpha1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ServerlessService</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">3a6326c5-32b0-4074-bec2-4d3eed293b71</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.58</span><span class="number">.149</span></span><br><span class="line">  <span class="attr">clusterIPs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.96</span><span class="number">.58</span><span class="number">.149</span></span><br><span class="line">  <span class="attr">internalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ipFamilies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IPv4</span></span><br><span class="line">  <span class="attr">ipFamilyPolicy:</span> <span class="string">SingleStack</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8012</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>查看Service对应的Endpoint对象，可以看到Endpoint对象实际上指向到了knative-serving下的pod activator-85bd4ddcbb-6ms7n。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">autoscaling.knative.dev/class:</span> <span class="string">kpa.autoscaling.knative.dev</span></span><br><span class="line">    <span class="attr">serving.knative.dev/creator:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">networking.internal.knative.dev/serverlessservice:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">networking.internal.knative.dev/serviceType:</span> <span class="string">Public</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configuration:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configurationGeneration:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">serving.knative.dev/configurationUID:</span> <span class="string">13138d0f-ee5f-4631-94a5-6928546e504c</span></span><br><span class="line">    <span class="attr">serving.knative.dev/revision:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">serving.knative.dev/revisionUID:</span> <span class="string">f3aaae74-6b79-4785-b60d-5607c0ab3bcf</span></span><br><span class="line">    <span class="attr">serving.knative.dev/service:</span> <span class="string">hello</span></span><br><span class="line">    <span class="attr">serving.knative.dev/serviceUID:</span> <span class="number">79907029</span><span class="string">-32df-4f21-b14b-ed7d24e1a10e</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">networking.internal.knative.dev/v1alpha1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ServerlessService</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">3a6326c5-32b0-4074-bec2-4d3eed293b71</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">knative-control-plane</span></span><br><span class="line">    <span class="attr">targetRef:</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">activator-85bd4ddcbb-6ms7n</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">knative-serving</span></span><br><span class="line">      <span class="attr">resourceVersion:</span> <span class="string">&quot;809&quot;</span></span><br><span class="line">      <span class="attr">uid:</span> <span class="string">df916ac6-3161-4bc6-bf8c-47bb7c83cc4a</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8012</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>进一步查看knative-serving下有一个knative的组件activator。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">k</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">-n</span> <span class="string">knative-serving</span> <span class="string">activator</span> </span><br><span class="line"><span class="string">NAME</span>        <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">activator</span>   <span class="number">1</span><span class="string">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="string">3h35m</span></span><br></pre></td></tr></table></figure>
<p>打开终端，执行一下 kubectl get pod -l serving.knative.dev&#x2F;service&#x3D;hello -w，重新执行 curl <a target="_blank" rel="noopener" href="http://hello.default.127.0.0.1.sslip.io/">http://hello.default.127.0.0.1.sslip.io</a> 发起新的请求，可以看到会有pod产生，且pod为通过deployment拉起。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-l</span> <span class="string">serving.knative.dev/service=hello</span> <span class="string">-w</span></span><br><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">0</span><span class="string">/2</span>     <span class="string">Pending</span>       <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">0</span><span class="string">/2</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">0s</span></span><br><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">1</span><span class="string">/2</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">1s</span></span><br></pre></td></tr></table></figure>
<p>过一段时间没有新的请求后，pod会自动被删除，同时可以看到deployment的副本数缩成0。该namespace下并没有对应的hpa产生，说明deployment副本数的调整并非使用k8s原生的hpa机制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">63s</span></span><br><span class="line"><span class="string">hello-world-deployment-7ff4bdb7fd-rqg96</span>   <span class="number">0</span><span class="string">/2</span>     <span class="string">Terminating</span>         <span class="number">0</span>          <span class="string">93s</span></span><br><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">deployments.apps</span> </span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">hello-world-deployment</span>   <span class="number">0</span><span class="string">/0</span>     <span class="number">0</span>            <span class="number">0</span>           <span class="string">21h</span></span><br></pre></td></tr></table></figure>
<h3 id="service的流量切分"><a href="#service的流量切分" class="headerlink" title="service的流量切分"></a>service的流量切分</h3><p>重新提交如下的yaml文件，将service对应的revision更新为knative。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hello-knative</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/knative-samples/helloworld-go</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TARGET</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;Knative&quot;</span></span><br></pre></td></tr></table></figure>
<p>重新查看revision，可以看到revision已经变更为了knative，同时可以看到老的revision world并没有被删除，只是没有了流量转发。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kn</span> <span class="string">revision</span> <span class="string">list</span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">SERVICE</span>   <span class="string">TRAFFIC</span>   <span class="string">TAGS</span>   <span class="string">GENERATION</span>   <span class="string">AGE</span>   <span class="string">CONDITIONS</span>   <span class="string">READY</span>   <span class="string">REASON</span></span><br><span class="line"><span class="string">hello-knative</span>   <span class="string">hello</span>     <span class="number">100</span><span class="string">%</span>             <span class="number">2</span>            <span class="string">49s</span>   <span class="number">4</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">4</span>     <span class="literal">True</span>    </span><br><span class="line"><span class="string">hello-world</span>     <span class="string">hello</span>                      <span class="number">1</span>            <span class="string">10m</span>   <span class="number">3</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">4</span>     <span class="literal">True</span>    </span><br></pre></td></tr></table></figure>
<p>重新apply新的Service，将流量切分为hello-world和hello-knative两份，重新执行curl请求，可以看到结果会随机返回。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hello-knative</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">gcr.io/knative-samples/helloworld-go</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TARGET</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;Knative&quot;</span></span><br><span class="line">  <span class="attr">traffic:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">latestRevision:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">percent:</span> <span class="number">50</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">revisionName:</span> <span class="string">hello-world</span></span><br><span class="line">    <span class="attr">percent:</span> <span class="number">50</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看revision的信息，可以看到流量已经是50%的切分了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kn revision list              </span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">SERVICE</span>   <span class="string">TRAFFIC</span>   <span class="string">TAGS</span>   <span class="string">GENERATION</span>   <span class="string">AGE</span>   <span class="string">CONDITIONS</span>   <span class="string">READY</span>   <span class="string">REASON</span></span><br><span class="line"><span class="string">hello-knative</span>   <span class="string">hello</span>     <span class="number">50</span><span class="string">%</span>              <span class="number">2</span>            <span class="string">11m</span>   <span class="number">3</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">4</span>     <span class="literal">True</span>    </span><br><span class="line"><span class="string">hello-world</span>     <span class="string">hello</span>     <span class="number">50</span><span class="string">%</span>              <span class="number">1</span>            <span class="string">21m</span>   <span class="number">3</span> <span class="string">OK</span> <span class="string">/</span> <span class="number">4</span>     <span class="literal">True</span>    </span><br></pre></td></tr></table></figure>
<h1 id="knative-eventing"><a href="#knative-eventing" class="headerlink" title="knative eventing"></a>knative eventing</h1><p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2022/png/220839/1647084177641-8d961050-347c-4f45-8a9c-dfa3b0d05dce.png#clientId=uf314a495-0864-4&from=paste&height=471&id=ud6d39aae&margin=%5Bobject%20Object%5D&name=image.png&originHeight=471&originWidth=1288&originalType=binary&ratio=1&size=46263&status=done&style=none&taskId=ub29b3700-7520-4a9a-bc3f-6118fd56695&width=1288" alt="image.png"><br>Source：k8s的CR对象，产生Event<br>Broker：用来分发Event<br>Trigger：Event触发器<br>Sink：Event输出结果</p>
<p>其中包含业务逻辑的可编程的部分在于Trigger部分，由于trigger实际上是无状态的服务，对于一些有状态的消息knative很难满足。比如同一类型的特定字段的event转发到特定的trigger上，broker实际上不具备可编程性，因此无法完成。</p>
<p>kn quickstart 命令会安装一个broker到环境中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">k</span> <span class="string">get</span> <span class="string">brokers.eventing.knative.dev</span> <span class="string">example-broker</span> <span class="string">-o</span> <span class="string">yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">eventing.knative.dev/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Broker</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">eventing.knative.dev/broker.class:</span> <span class="string">MTChannelBasedBroker</span></span><br><span class="line">    <span class="attr">eventing.knative.dev/creator:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">    <span class="attr">eventing.knative.dev/lastModifier:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-broker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-br-default-channel</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">knative-eventing</span></span><br><span class="line">  <span class="attr">delivery:</span></span><br><span class="line">    <span class="attr">backoffDelay:</span> <span class="string">PT0.2S</span></span><br><span class="line">    <span class="attr">backoffPolicy:</span> <span class="string">exponential</span></span><br><span class="line">    <span class="attr">retry:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://broker-ingress.knative-eventing.svc.cluster.local/default/example-broker</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">knative.dev/channelAPIVersion:</span> <span class="string">messaging.knative.dev/v1</span></span><br><span class="line">    <span class="attr">knative.dev/channelAddress:</span> <span class="string">http://example-broker-kne-trigger-kn-channel.default.svc.cluster.local</span></span><br><span class="line">    <span class="attr">knative.dev/channelKind:</span> <span class="string">InMemoryChannel</span></span><br><span class="line">    <span class="attr">knative.dev/channelName:</span> <span class="string">example-broker-kne-trigger</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Addressable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="literal">No</span> <span class="string">dead</span> <span class="string">letter</span> <span class="string">sink</span> <span class="string">is</span> <span class="string">configured.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">DeadLetterSinkNotConfigured</span></span><br><span class="line">    <span class="attr">severity:</span> <span class="string">Info</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">DeadLetterSinkResolved</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">FilterReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">IngressReady</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-03-11T12:32:43Z&quot;</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">TriggerChannelReady</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>创建如下的Service，该service通过环境变量 BROKER_URL 作为broker地址，可以看到其地址为 quickstart工具默认安装的example-broker。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudevents-player</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">autoscaling.knative.dev/min-scale:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">ruromero/cloudevents-player:latest</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">BROKER_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">http://broker-ingress.knative-eventing.svc.cluster.local/default/example-broker</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>访问service页面 <a target="_blank" rel="noopener" href="http://cloudevents-player.default.127.0.0.1.sslip.io/">http://cloudevents-player.default.127.0.0.1.sslip.io/</a> 可以在界面上创建Event后，产生如下的Event内容，格式完全遵循社区的CloudEvent规范。点击发送，即可以将消息发送给broker，但由于borker没有配置任何的Trigger，消息在发送到broker后会被直接丢弃。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;root&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datacontenttype&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mediaType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;manual&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;specversion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test-type&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello CloudEvents!&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们继续来给broker增加触发器，创建如下的yaml。该触发器定义了broker为example-broker，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion<span class="punctuation">:</span> eventing.knative.dev/v1</span><br><span class="line">kind<span class="punctuation">:</span> Trigger</span><br><span class="line">metadata<span class="punctuation">:</span></span><br><span class="line">  name<span class="punctuation">:</span> cloudevents-trigger</span><br><span class="line">  annotations<span class="punctuation">:</span></span><br><span class="line">    knative-eventing-injection<span class="punctuation">:</span> enabled</span><br><span class="line">spec<span class="punctuation">:</span></span><br><span class="line">  broker<span class="punctuation">:</span> example-broker</span><br><span class="line">  subscriber<span class="punctuation">:</span></span><br><span class="line">    ref<span class="punctuation">:</span></span><br><span class="line">      apiVersion<span class="punctuation">:</span> serving.knative.dev/v1</span><br><span class="line">      kind<span class="punctuation">:</span> Service</span><br><span class="line">      name<span class="punctuation">:</span> cloudevents-player</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>重新在页面上发送event，可以看到消息的状态为接收。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4HijmNvhQAXyEHSBlMHyVw">即学即会Serverless</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/linux-kernel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/linux-kernel/" class="post-title-link" itemprop="url">Linux内核参数（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-01 14:31:38" itemprop="dateCreated datePublished" datetime="2022-04-01T14:31:38+00:00">2022-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内核参数项"><a href="#内核参数项" class="headerlink" title="内核参数项"></a>内核参数项</h1><p>以CentOS7 系统为例，可以看到有1088个内核参数项。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux iZbp17o12gcsq2d87y7x1hZ <span class="number">3.10</span><span class="number">.0</span><span class="number">-1160.36</span><span class="number">.2</span>.el7.x86_64 #<span class="number">1</span> SMP Wed Jul <span class="number">21</span> <span class="number">11</span><span class="punctuation">:</span><span class="number">57</span><span class="punctuation">:</span><span class="number">15</span> UTC <span class="number">2021</span> x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">$ sysctl -a <span class="number">2</span>&gt;/dev/<span class="literal"><span class="keyword">null</span></span> | wc -l</span><br><span class="line"><span class="number">1088</span></span><br></pre></td></tr></table></figure>
<p>Linux的内核参数均位于&#x2F;proc&#x2F;sys目录下，涉及到如下几个目录：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>abi</td>
<td></td>
</tr>
<tr>
<td>crypto</td>
<td></td>
</tr>
<tr>
<td>debug</td>
<td></td>
</tr>
<tr>
<td>dev</td>
<td>用来配置特定设备，比如raid、scsi设备</td>
</tr>
<tr>
<td>fs</td>
<td>文件子系统</td>
</tr>
<tr>
<td>kernel</td>
<td>内核子系统</td>
</tr>
<tr>
<td>net</td>
<td>网络子系统</td>
</tr>
<tr>
<td>user</td>
<td></td>
</tr>
<tr>
<td>vm</td>
<td>内存子系统</td>
</tr>
</tbody></table>
<h2 id="kernel子系统"><a href="#kernel子系统" class="headerlink" title="kernel子系统"></a>kernel子系统</h2><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>kernel.panic</td>
<td>内核出现panic，重新引导前需要等待的时间，单位为秒。如果该值为0，，说明内核禁止自动引导</td>
</tr>
<tr>
<td>kernel.core_pattern</td>
<td>core文件的存放路径</td>
</tr>
</tbody></table>
<h2 id="vm子系统"><a href="#vm子系统" class="headerlink" title="vm子系统"></a>vm子系统</h2><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>vm.min_free_kbytes</td>
<td>系统所保留空闲内存的最小值。该值通过公式计算，跟当前机器的物理内存相关。</td>
</tr>
<tr>
<td>vm.swappiness</td>
<td>用来控制虚拟内存，支持如下值：<br> 0：关闭虚拟内存 <br> 1：允许开启虚拟内存设置的最小值 <br> 10：剩余内存少于10%时开启虚拟内存 <br> 100：完全适用虚拟内存。<br><br> 该参数可以通过swapon 命令开启，swapoff关闭。<br>参考链接：<a target="_blank" rel="noopener" href="https://linuxhint.com/understanding_vm_swappiness/">https://linuxhint.com/understanding_vm_swappiness&#x2F;</a></td>
</tr>
</tbody></table>
<h2 id="net子系统"><a href="#net子系统" class="headerlink" title="net子系统"></a>net子系统</h2><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>net.ipv4.ip_local_reserved_ports</td>
<td>随机端口的黑名单列表，系统在发起连接时，不使用该内核参数内的端口号</td>
</tr>
<tr>
<td>net.ipv4.ip_local_port_range</td>
<td>随机端口的白名单范围，网络连接可以作为源端口的最小和最大端口限制</td>
</tr>
<tr>
<td>net.ipv4.rp_filter</td>
<td>是否开启对数据包源地址的校验, 收到包后根据source ip到route表中检查是否否和最佳路由，否的话扔掉这个包。这次如下值：<br>1. 不开启源地址校验<br> 2. 开启严格的反向路径校验。对每个进来的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该数据包。<br> 3. 开启松散的反向路径校验。对每个进来的数据包，校验其源地址是否可达，即反向路径是否能通（通过任意网口），如果反向路径不通，则直接丢弃该数据包。该内核参数 net.ipv4.conf.all.log_martians 可以来控制是否打开日志，日志打开后可以在&#x2F;var&#x2F;log&#x2F;message中观察到。</td>
</tr>
</tbody></table>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>tcp 相关内核参数可以使用 <code>man 7 tcp</code> 查看。</p>
<h4 id="建连相关"><a href="#建连相关" class="headerlink" title="建连相关"></a>建连相关</h4><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/tcp_connect.webp"></p>
<p>syn 队列又称为半连接队列。服务端在接收到客户端的 SYN 包后，服务端向客户端发送 SYN + ACK 报文，此时会进入到半连接队列。</p>
<p>相关文章：<a href="/post/linux-backlog">Linux TCP backlog</a></p>
<h4 id="断开连接相关"><a href="#断开连接相关" class="headerlink" title="断开连接相关"></a>断开连接相关</h4><p><a href="/post/time-wait">TCP TIME_WAIT</a></p>
<h2 id="文件子系统"><a href="#文件子系统" class="headerlink" title="文件子系统"></a>文件子系统</h2><h3 id="fs-mount-max"><a href="#fs-mount-max" class="headerlink" title="fs.mount-max"></a>fs.mount-max</h3><blockquote>
<p>The value in this file specifies the maximum number of mounts that may exist in a mount namespace. The default value in this file is 100,000.</p>
</blockquote>
<p>Linux 4.19 内核引入。当 mount namespace 中加载的文件数超过该值后，会报错 “No space left on device”。</p>
<h2 id="内核参数在k8s的支持情况"><a href="#内核参数在k8s的支持情况" class="headerlink" title="内核参数在k8s的支持情况"></a>内核参数在k8s的支持情况</h2><table>
<thead>
<tr>
<th>大类</th>
<th>子类</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>namespace内核参数</td>
<td>安全的内核参数</td>
<td>k8s默认支持的内核参数非常少，仅支持如下的内核参数：<br> 1. kernel.shm_rmid_forced<br> 2. net.ipv4.ip_local_port_range<br> 3. net.ipv4.tcp_syncookies（在内核4.4之前为非namespace化）<br> 4. net.ipv4.ping_group_range （从 Kubernetes 1.18 开始）<br> 5. net.ipv4.ip_unprivileged_port_start （从 Kubernetes 1.22 开始）</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>namespace内核参数</td>
<td>非安全内核参数</td>
<td>默认禁用，pod可以调度成功，但会报错SysctlForbidden。修改kubelet参数开启 <code>kubelet --allowed-unsafe-sysctls &#39;kernel.msg*,net.core.somaxconn&#39;</code></td>
</tr>
<tr>
<td>非namespace内核参数</td>
<td>在容器中没有的内核参数</td>
<td>如：<br>net.core.netdev_max_backlog &#x3D; 10000<br>net.core.rmem_max &#x3D; 2097152<br>net.core.wmem_max &#x3D; 2097152</td>
</tr>
<tr>
<td>非namespace隔离参数</td>
<td>直接修改宿主机的内核参数</td>
<td>在容器中需要开启特权容器来设置，如：<br>vm.overcommit_memory &#x3D; 2 <br>vm.overcommit_ratio &#x3D; 95</td>
</tr>
</tbody></table>
<p>操作系统的namespace化的内核参数仅支持：</p>
<ul>
<li>kernel.shm*,</li>
<li>kernel.msg*,</li>
<li>kernel.sem,</li>
<li>fs.mqueue.*,</li>
<li>net.*（内核中可以在容器命名空间里被更改的网络配置项相关参数）。然而也有一些特例 （例如，net.netfilter.nf_conntrack_max 和 net.netfilter.nf_conntrack_expect_max 可以在容器命名空间里被更改，但它们是非命名空间的）。</li>
</ul>
<p>k8s在pod中声明内核参数的方式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span>   </span><br><span class="line">  <span class="attr">name:</span> <span class="string">sysctl-example</span></span><br><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">  <span class="attr">securityContext:</span>     </span><br><span class="line">    <span class="attr">sysctls:</span>     </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span></span><br><span class="line">      <span class="string">kernel.shm_rmid_forced</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;0&quot;</span></span><br></pre></td></tr></table></figure>


<h1 id="业界解决方案"><a href="#业界解决方案" class="headerlink" title="业界解决方案"></a>业界解决方案</h1><h2 id="ACK-安全沙箱容器"><a href="#ACK-安全沙箱容器" class="headerlink" title="ACK - 安全沙箱容器"></a>ACK - 安全沙箱容器</h2><p>阿里云ACK服务的安全沙箱容器，底层实现为runV，pod拥有独立的内核参数，相互之间不受影响。通过扩展pod的annotation来完成内核参数的修改：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotations<span class="punctuation">:</span></span><br><span class="line">  securecontainer.alibabacloud.com/sysctls<span class="punctuation">:</span> <span class="string">&quot;net.bridge.bridge-nf-call-ip6tables=1,net.bridge.bridge-nf-call-iptables=1,net.ipv4.ip_forward=1&quot;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/198645.html">阿里云ACK - 配置安全沙箱Pod内核参数</a></p>
<h2 id="弹性容器实例"><a href="#弹性容器实例" class="headerlink" title="弹性容器实例"></a>弹性容器实例</h2><p>完全利用k8s的功能，有限内核参数修改。<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/163023.html">https://help.aliyun.com/document_detail&#x2F;163023.html</a></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/163023.html">ASI 配置Security Context</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/firewalld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/firewalld/" class="post-title-link" itemprop="url">firewalld</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-29 19:24:27" itemprop="dateCreated datePublished" datetime="2022-03-29T19:24:27+00:00">2022-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在RHEL7系统中，firewalld和iptabels两个防火墙的服务并存，firewalld通过调用iptables命令来实现，firewalld和iptables均用来维护系统的netfilter规则，底层实现为内核的netfilter模块。</p>
<p>firewalld为systemd项目的一部分，为python语言实现，跟iptables相比，使用上更加人性化，提供了更高层次的抽象，用户不用关心netfilter的链和表的概念。</p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/firewalld-structure.png"></p>
<p>最上层为用户界面层，提供了firewall-cmd和firewall-offline-cmd两个命令行工具，其中firewall-cmd为最主要的命令行工具。firewall-config为GUI工具。用户界面层通过firewalld提供的D-Bus接口进行通讯。</p>
<p>firewalld为daemon进程，其中zone、service、ipset等为firewalld抽象的概念。在接收到用户界面层的命令后，一方面需要将操作保存到本地文件，另外还需要调用更底层的如iptables、ipset、ebtables等命令来产生规则，最终在内核层的netfilter模块生效。</p>
<h2 id="firewalld的管理"><a href="#firewalld的管理" class="headerlink" title="firewalld的管理"></a>firewalld的管理</h2><p>在RHEL7系统下，firewalld作为systemd家族的一员会默认安装。其service文件定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/lib/systemd/system/firewalld.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=firewalld - dynamic firewall daemon</span><br><span class="line">Before=network-pre.target</span><br><span class="line">Wants=network-pre.target</span><br><span class="line">After=dbus.service</span><br><span class="line">After=polkit.service</span><br><span class="line">Conflicts=iptables.service ip6tables.service ebtables.service ipset.service</span><br><span class="line">Documentation=man:firewalld(1)</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/firewalld</span><br><span class="line">ExecStart=/usr/sbin/firewalld --nofork --nopid $FIREWALLD_ARGS</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line"># supress to log debug and error output also to /var/log/messages</span><br><span class="line">StandardOutput=null</span><br><span class="line">StandardError=null</span><br><span class="line">Type=dbus</span><br><span class="line">BusName=org.fedoraproject.FirewallD1</span><br><span class="line">KillMode=mixed</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=dbus-org.fedoraproject.FirewallD1.service</span><br></pre></td></tr></table></figure>

<p>查看firewall-cmd的运行状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --state</span><br><span class="line">not running</span><br></pre></td></tr></table></figure>

<p>在安装完firewalld后，会在&#x2F;usr&#x2F;lib&#x2F;firewalld&#x2F;目录下产生默认的配置，该部分配置不可修改。同时会在&#x2F;etc&#x2F;firewalld目录下产生firewalld的配置，该部分配置会覆盖&#x2F;usr&#x2F;lib&#x2F;firewalld&#x2F;下的配置。&#x2F;etc&#x2F;firewalld目录下的文件内容如下，其中firewalld.conf文件为最主要的配置文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls </span><br><span class="line">firewalld.conf  helpers  icmptypes  ipsets  lockdown-whitelist.xml  services  zones</span><br></pre></td></tr></table></figure>

<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>firewalld抽象了zone、service、ipset、helper、icmptypes几个概念。</p>
<h3 id="zone"><a href="#zone" class="headerlink" title="zone"></a>zone</h3><p>firewalld 将网络按照安全等级划分了不同的zone，zone的定义位于&#x2F;usr&#x2F;lib&#x2F;firewalld&#x2F;zones&#x2F;目录下，文件格式为xml，包括了如下的zone。</p>
<ol>
<li>drop：只允许出向，任何入向的网络数据包被丢弃，不会回复icmp报文。</li>
<li>block：任何入向的网络数据包均会被拒绝，会回复icmp报文。</li>
<li>public：公共区域网络流量。不信任网络上的流量，选择接收入向的网络流量。</li>
<li>external：不信任网络上的流量，选择接收入向的网络流量。</li>
<li>DMZ：隔离区域，内网和外网增加的一层网络，起到缓冲作用。选择接收入向的网络连接。</li>
<li>work：办公网络，信任网络流量，选择接收入向的网络流量。</li>
<li>home：家庭网络，信任网络流量，选择接收入向的网络流量。</li>
<li>internal：内部网络，信任网络流量，选择接收入向的网络流量。</li>
<li>trusted：信任区域。所有网络连接可接受。</li>
</ol>
<p>firewalld的默认zone为public，zone目录下的public.xml的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;zone&gt;</span><br><span class="line">  &lt;short&gt;Public&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.&lt;/description&gt;</span><br><span class="line">  &lt;service name=&quot;ssh&quot;/&gt;</span><br><span class="line">  &lt;service name=&quot;dhcpv6-client&quot;/&gt;</span><br><span class="line">  &lt;service name=&quot;cockpit&quot;/&gt;</span><br><span class="line">&lt;/zone&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到Public zone关联了三个service对象 ssh、dhcpv6-client、cockpit。没有匹配到该zone的流量，默认情况下会被拒绝。</p>
<p>在配置文件&#x2F;etc&#x2F;firewalld&#x2F;firewalld.conf中，通过DefaultZone字段指定的默认zone为public。即如果开启了firewalld规则，那么默认仅会放行访问上述三个服务的流量。执行 iptables-save 命令实际上并为看到任何的iptables规则，说明firewalld是直接调用内核的netfilter来实现的。</p>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>service为firewalld对运行在宿主机上的进程的抽象，并在zone文件中跟zone进行绑定。比如ssh.xml的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;service&gt;</span><br><span class="line">  &lt;short&gt;SSH&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;Secure Shell (SSH) is a protocol for logging into and executing commands on remote machines. It provides secure encrypted communications. If you plan on accessing your machine remotely via SSH over a firewalled interface, enable this option. You need the openssh-server package installed for this option to be useful.&lt;/description&gt;</span><br><span class="line">  &lt;port protocol=&quot;tcp&quot; port=&quot;22&quot;/&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="向某个zone内增加端口号"><a href="#向某个zone内增加端口号" class="headerlink" title="向某个zone内增加端口号"></a>向某个zone内增加端口号</h3><p>执行 <code>firewall-cmd --permanent --zone=public --add-port=80/tcp</code> 即可向public zone内增加80端口号。同时可以在 &#x2F;etc&#x2F;firewalld&#x2F;zones&#x2F;public.xml 文件中看到新增加了80端口号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat public.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;zone&gt;</span><br><span class="line">  &lt;short&gt;Public&lt;/short&gt;</span><br><span class="line">  &lt;description&gt;For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.&lt;/description&gt;</span><br><span class="line">  &lt;service name=&quot;ssh&quot;/&gt;</span><br><span class="line">  &lt;service name=&quot;dhcpv6-client&quot;/&gt;</span><br><span class="line">  &lt;service name=&quot;cockpit&quot;/&gt;</span><br><span class="line">  &lt;port port=&quot;80&quot; protocol=&quot;tcp&quot;/&gt;</span><br><span class="line">&lt;/zone&gt;</span><br></pre></td></tr></table></figure>

<p>参数 <code>--permanent</code> 为固化到文件中，如果不增加该参数重启firewalld进程后配置会失效。</p>
<h3 id="获取当前zone信息"><a href="#获取当前zone信息" class="headerlink" title="获取当前zone信息"></a>获取当前zone信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-active-zones</span><br><span class="line">public</span><br><span class="line">  interfaces: eth0</span><br></pre></td></tr></table></figure>

<p>每个网络设备可以属于不同的zone，可以根据网络设备名来查询所属的zone</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --get-zone-of-interface=eth0</span><br><span class="line">public</span><br></pre></td></tr></table></figure>

<h3 id="设置当前默认zone"><a href="#设置当前默认zone" class="headerlink" title="设置当前默认zone"></a>设置当前默认zone</h3><p>该命令会自动修改&#x2F;etc&#x2F;firewalld&#x2F;firewalld.conf配置文件中的DefaultZone字段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --set-default-zone=trusted</span><br></pre></td></tr></table></figure>

<h3 id="查看当前配置规则"><a href="#查看当前配置规则" class="headerlink" title="查看当前配置规则"></a>查看当前配置规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0</span><br><span class="line">  sources: </span><br><span class="line">  services: cockpit dhcpv6-client ssh</span><br><span class="line">  ports: 80/tcp</span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://firewalld.org/">firewalld官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.certdepot.net/rhel7-get-started-firewalld/">RHEL7: How to get started with Firewalld</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/linux-auditd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/linux-auditd/" class="post-title-link" itemprop="url">linux auditd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-28 11:57:28" itemprop="dateCreated datePublished" datetime="2022-03-28T11:57:28+00:00">2022-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="audit简介"><a href="#audit简介" class="headerlink" title="audit简介"></a>audit简介</h2><p>audit为linux内核安全体系的重要组成部分，用来记录内核的系统调用，文件修改等事件，用于审计目的。</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/common/linux_audit.png"></p>
<ul>
<li>auditctl: 面向用户的工具，类似于iptables命令</li>
<li>auditd: 负责将审计信息写入到&#x2F;var&#x2F;</li>
</ul>
<h2 id="启动auditd服务"><a href="#启动auditd服务" class="headerlink" title="启动auditd服务"></a>启动auditd服务</h2><p>auditd作为单独的服务运行在系统上，Redhat系统使用<code>systemctl start auditd</code>启动服务，启动后通过 <code>ps -ef | grep auditd</code>查看进程是否启动成功。</p>
<h2 id="auditctl"><a href="#auditctl" class="headerlink" title="auditctl"></a>auditctl</h2><p>查看auditd的运行状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -s</span><br><span class="line">enabled 1</span><br><span class="line">failure 1</span><br><span class="line">pid 638</span><br><span class="line">rate_limit 0</span><br><span class="line">backlog_limit 8192</span><br><span class="line">lost 0</span><br><span class="line">backlog 0</span><br><span class="line">loginuid_immutable 0 unlocked</span><br></pre></td></tr></table></figure>

<p>查看当前环境规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -l</span><br><span class="line">-w /tmp/hosts -p rwxa</span><br><span class="line">-w /proc/sys/net/ipv4/tcp_retries1 -p rwxa</span><br><span class="line">-w /proc/sys/net/ipv4/tcp_retries2 -p rwxa</span><br><span class="line">-w /proc/sys/net/ipv4/tcp_retries2 -p wa</span><br></pre></td></tr></table></figure>

<p>删除所有的audit规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -D</span><br><span class="line">No rules</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="监控文件变化"><a href="#监控文件变化" class="headerlink" title="监控文件变化"></a>监控文件变化</h3><ol>
<li>执行 auditctl -w $file -p wa 来监控文件，比如监控内核参数 auditctl -w &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_retries2 -p wa，其中-p指定了监控文件的行为，支持rwxa。</li>
<li>查看文件 cat &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_retries2。</li>
<li>使用vim打开文件 vim &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_retries2。</li>
<li>执行 ausearch -f &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_retries2 命令查看，可以看到如下的日志</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ausearch -f /proc/sys/net/ipv4/tcp_retries1</span><br><span class="line">----</span><br><span class="line">time-&gt;Mon Mar 28 12:44:48 2022</span><br><span class="line">type=PROCTITLE msg=audit(1648442688.159:6232591): proctitle=76696D002F70726F632F7379732F6E65742F697076342F7463705F7265747269657331</span><br><span class="line">type=PATH msg=audit(1648442688.159:6232591): item=1 name=&quot;/proc/sys/net/ipv4/tcp_retries1&quot; inode=46629229 dev=00:03 mode=0100644 ouid=0 ogid=0 rdev=00:00 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0</span><br><span class="line">type=PATH msg=audit(1648442688.159:6232591): item=0 name=&quot;/proc/sys/net/ipv4/&quot; inode=8588 dev=00:03 mode=040555 ouid=0 ogid=0 rdev=00:00 objtype=PARENT cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0</span><br><span class="line">type=CWD msg=audit(1648442688.159:6232591):  cwd=&quot;/root&quot;</span><br><span class="line">type=SYSCALL msg=audit(1648442688.159:6232591): arch=c000003e syscall=2 success=yes exit=3 a0=11687a0 a1=241 a2=1a4 a3=7ffe33dc14e0 items=2 ppid=8375 pid=8629 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts1 ses=250225 comm=&quot;vim&quot; exe=&quot;/usr/bin/vim&quot; key=(null)</span><br></pre></td></tr></table></figure>

<h3 id="监控文件夹变化"><a href="#监控文件夹变化" class="headerlink" title="监控文件夹变化"></a>监控文件夹变化</h3><p>监控文件夹同样采用跟上述文件相同的方式，但有个问题是如果文件夹下内容较多，会一起监控，从而导致audit的log内容过多。</p>
<h3 id="监控系统定期reboot"><a href="#监控系统定期reboot" class="headerlink" title="监控系统定期reboot"></a>监控系统定期reboot</h3><p>执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auditctl -w /bin/systemctl -p rwxa -k systemd_call</span><br><span class="line">auditctl -a always,exit -F arch=b64 -S reboot -k reboot_call</span><br></pre></td></tr></table></figure>

<p>待系统重启后执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ausearch -f reboot</span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/chap-system_auditing">RedHat auditd文档</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/shell-often/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/shell-often/" class="post-title-link" itemprop="url">常用shell命令（持续更新）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-03-28 11:20:03" itemprop="dateCreated datePublished" datetime="2022-03-28T11:20:03+00:00">2022-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-17 04:21:26" itemprop="dateModified" datetime="2024-02-17T04:21:26+00:00">2024-02-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h2><ul>
<li>–local-port：指定源端口号</li>
<li>–proxy：指定本地代理，例如：<a target="_blank" rel="noopener" href="http://127.0.0.1:52114/">http://127.0.0.1:52114</a></li>
<li>-d：指定body，如果body比较小，可以直接指定<code>-d &#39;login=emma＆password=123&#39;</code>，也可以通过指定文件的方式 <code>-d &#39;@data.txt&#39;</code></li>
</ul>
<h2 id="history"><a href="#history" class="headerlink" title="history"></a>history</h2><p>bash会将历史命令记录到文件.bash_history中，通过history命令可以查看到历史执行的命令。但history在默认情况下，仅会显示命令，不会展示出执行命令的时间。history命令可以根据环境变量HISTTIMEFORMAT来显示时间，要想显示时间可以执行如下的命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HISTTIMEFORMAT=&#x27;%F %T &#x27; history</span><br></pre></td></tr></table></figure>

<h2 id="lrzsz"><a href="#lrzsz" class="headerlink" title="lrzsz"></a>lrzsz</h2><p>CentOS rpm包地址：<a target="_blank" rel="noopener" href="https://rpmfind.net/linux/centos/7.9.2009/os/x86_64/Packages/lrzsz-0.12.20-36.el7.x86_64.rpm">https://rpmfind.net/linux/centos/7.9.2009/os/x86_64/Packages/lrzsz-0.12.20-36.el7.x86_64.rpm</a></p>
<h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><p>最常用的为<code>ps -ef</code>和<code>ps aux</code>命令，两者的输出结果差不多，其中<code>ps -ef</code>为System V Style风格，<code>ps aux</code>为BSD风格，现在ps命令两者均支持。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ps aux</span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">www-data       1  0.0  0.0    212     8 ?        Ss   Apr09   0:00 /usr/bin/dumb-init -- /nginx-ingress-controller</span><br><span class="line">www-data       6  0.9  0.3 813500 100456 ?       Ssl  Apr09  67:20 /nginx-ingress-controller --publish-service</span><br><span class="line">www-data      33  0.0  0.7 458064 242252 ?       S    Apr09   0:53 nginx: master process /usr/local/nginx/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">www-data   46786  0.0  0.7 459976 239996 ?       S    17:57   0:00 rollback logs/eagleeye.log interval=60 adjust=600</span><br><span class="line">www-data   46787  1.4  0.8 559120 283328 ?       Sl   17:57   2:07 nginx: worker process</span><br><span class="line">www-data   46788  1.1  0.8 558992 284772 ?       Sl   17:57   1:38 nginx: worker process</span><br><span class="line">www-data   46789  0.0  0.7 452012 237152 ?       S    17:57   0:01 nginx: cache manager process</span><br><span class="line">www-data   46790  0.0  0.8 490832 267600 ?       S    17:57   0:00 nginx: x</span><br><span class="line">www-data   47357  0.0  0.0  60052  1832 pts/2    R+   20:21   0:00 ps aux</span><br></pre></td></tr></table></figure>

<p>每个列的值如下：</p>
<ul>
<li>%MEM：占用内存百分比</li>
<li>VSZ: 进程使用的虚拟内存量（KB）</li>
<li>RSS：进程占用的固定内存量，驻留在页中的（KB）</li>
<li>STAT：进程的状态</li>
<li>TIME：进程实际使用的cpu运行时间</li>
</ul>
<h2 id="pssh"><a href="#pssh" class="headerlink" title="pssh"></a>pssh</h2><p>该工具的定位是在多台主机上批量执行pssh命令。</p>
<ol>
<li>将文件存放到文件中 &#x2F;tmp&#x2F;hosts 中，文件格式如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.1</span><br><span class="line">192.168.1.2</span><br></pre></td></tr></table></figure></li>
<li>批量执行shell命令：pssh -h &#x2F;tmp&#x2F;hosts -A -i ‘uptime’。</li>
</ol>
<p>具体参数说明如下：</p>
<ul>
<li>-A: 手工输入密码模式，如果未打通ssh免密，可以在执行pssh命令的时候手工输入主机密码，但要求所有主机密码必须保持一致</li>
</ul>
<h2 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h2><p>常用命令：</p>
<ol>
<li><code>rsync -avz -e &#39;ssh -p 50023&#39; ~/git/arkctl root@100.67.27.224:/tm</code></li>
</ol>
<p>常用参数：</p>
<ul>
<li><code>--delete</code>: 本地文件删除时，同步删除远程文件</li>
<li><code>-e &#39;ssh -p 50023&#39;</code>: 指定 ssh 端口号</li>
<li><code>--exclude=.git</code>: 忽略同步本地的 git 目录</li>
</ul>
<h2 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h2><ul>
<li>-P：指定端口号</li>
</ul>
<h2 id="strace"><a href="#strace" class="headerlink" title="strace"></a>strace</h2><p>跟踪进程的系统调用</p>
<ul>
<li>-p：指定进程</li>
<li>-s：指定输出的字符串的最大大小</li>
<li>-f：跟踪由fork调用产生的子进程</li>
</ul>
<h2 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h2><ul>
<li>-P: 当下载文件时，可以指定本地的下载的目录</li>
</ul>
<h2 id="split"><a href="#split" class="headerlink" title="split"></a>split</h2><p>split [-bl] file [prefix]</p>
<ul>
<li><p>-b, –bytes&#x3D;SIZE：对file进行切分，每个小文件大小为SIZE。可以指定单位b,k,m。</p>
</li>
<li><p>-C,–bytes&#x3D;SIZE：与-b选项类似，但是，切割时尽量维持每行的完整性。</p>
</li>
<li><p>prefix：分割后产生的文件名前缀。</p>
</li>
</ul>
<p>拆分文件：split -b 200m ip_config.gzip ip_config.gzip</p>
<p>文件合并：cat ip_config.gzip* &gt; ip_config.gzip</p>
<h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><p>快速开启一个http server <code>python -m SimpleHTTPServer 8080</code>。</p>
<p>在python3环境下该命令变更为：<code>python3 -m http.server 8080</code></p>
<p>格式化 json: <code>cat 1.json | python -m json.tool</code></p>
<h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><p>按照,打印出一每一列 <code>awk -F, &#39;&#123;for(i=1;i&lt;=NF;i++)&#123;print $i;&#125;&#125;&#39;</code></p>
<h2 id="docker-registry"><a href="#docker-registry" class="headerlink" title="docker registry"></a>docker registry</h2><ul>
<li>列出镜像：<code>curl http://127.0.0.1:5000/v2/_catalog?n=1000</code></li>
<li>查询镜像的tag: <code>curl http://127.0.0.1:5000/v2/nginx/tags/list</code>，如果遇到镜像名类似<code>aa/bb</code>的情况，需要转移一下 <code>curl http://127.0.0.1:5000/v2/aa\/bb/tags/list</code></li>
</ul>
<h2 id="socat"><a href="#socat" class="headerlink" title="socat"></a>socat</h2><ul>
<li>向本地的 socket 文件发送数据：<code>echo &quot;test&quot; | socat - unix-connect:/tmp/unix.sock</code></li>
<li>通过交互的方式输入命令：<code>socat - UNIX-CONNECT:/var/lib/kubelet/pod-resources/kubelet.sock</code></li>
</ul>
<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><ul>
<li>删除远程分支 <code>git push origin --delete xxx</code></li>
<li>强制更新远程分支：<code>git push --force-with-lease origin feature/statefulset</code></li>
<li>删除本地分支：<code>git branch -D local-branch</code></li>
<li>拉取远程分支并切换分支：<code>git checkout -b develop origin/remote-branch</code> develop为本地分支，origin&#x2F;remote-branch为远程分支</li>
</ul>
<h2 id="rpm"><a href="#rpm" class="headerlink" title="rpm"></a>rpm</h2><ul>
<li><code>rpm -ivh xx.rpm</code>：用来安装一个 rpm 包</li>
<li><code>rpm -qa</code>：查看已经安装的包</li>
<li><code>rpm -ql</code>: 查看已经安装的 rpm 的文件内容</li>
<li><code>rpm -qpR *.rpm</code>: 查看rpm包的依赖</li>
<li><code>rpm -e *</code>：要删除的rpm包</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
