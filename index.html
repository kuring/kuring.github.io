<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kuring.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="404频道">
<meta property="og:url" content="http://kuring.me/index.html">
<meta property="og:site_name" content="404频道">
<meta property="og:locale">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://kuring.me/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>404频道</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">404频道</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">243</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kuring" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kuring" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/gzh-coze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/gzh-coze/" class="post-title-link" itemprop="url">微信公众号通过扣子接入大模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-19 00:00:00" itemprop="dateCreated datePublished" datetime="2024-06-19T00:00:00+00:00">2024-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在字节的 AI 发布平台<a target="_blank" rel="noopener" href="https://www.coze.cn/">扣子</a>中提供了创建机器人的功能，并且可以直接对接微信公众号，使用在微信公众号中回复消息，由大模型直接回复的效果。</p>
<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><p>整体操作步骤非常简单，需要申请一个 Coze 的账号和开通微信公众号的开发者功能。</p>
<p>微信公众号的开发者功能在这里配置：<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240619211112.png" alt="image.png"></p>
<p>点击<code>创建 Bot</code> 按钮，输入 Bot 名称后点击<code>确认</code>。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240619210355.png" alt="image.png|570"></p>
<p>在机器人设置页面，可以配置模型、选择自己训练的知识库等操作。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240619210909.png" alt="image.png"></p>
<p>设置完成后，点击<code>发布</code>，选择<code>微信公众号（订阅号）</code>配置功能，设置对应的微信公众号的 AppID。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240619211019.png" alt="image.png"></p>
<h1 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h1><p>访问公众号直接输入内容，可以看到自动回复内容。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/IMG_3856.PNG.JPG" alt="IMG_3856.PNG.JPG"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/mi-gpt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/mi-gpt/" class="post-title-link" itemprop="url">使用 mi-gpt 将小爱音箱接入大模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-13 00:00:00" itemprop="dateCreated datePublished" datetime="2024-06-13T00:00:00+00:00">2024-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>无意间发现了开源项目 <a target="_blank" rel="noopener" href="https://github.com/idootop/mi-gpt">mi-gpt</a>，该项目可以将家里的小爱音箱接入到 GPT 中，增强小爱音箱的功能。在跟小爱音箱对话的过程中，可以根据特定的提示词走 GPT 来回答，而不是用小爱音箱原生的回复。</p>
<p>必备条件：</p>
<ol>
<li>必须有一个小米音箱。</li>
<li>必须要有可以长期运行的服务器，可以是树莓派等设备。</li>
<li>要有一个 OpenAI 的账号，也可以用兼容 ChatGPT API 的国内大模型。</li>
</ol>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>部署比较简单，下面为我的部署过程，供大家参考。更详细的信息大家可以直接参考 github 项目中的<a target="_blank" rel="noopener" href="https://github.com/idootop/mi-gpt/tree/main/docs">相关文档</a>。</p>
<h2 id="创建配置文件-migpt-js："><a href="#创建配置文件-migpt-js：" class="headerlink" title="创建配置文件 .migpt.js："></a>创建配置文件 <code>.migpt.js</code>：</h2><p>参考项目中的文件 <a target="_blank" rel="noopener" href="https://github.com/idootop/mi-gpt/blob/main/.migpt.example.js">.migpt.example.js</a>内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">// 小爱音箱扮演角色的简介</span><br><span class="line">const botProfile = `</span><br><span class="line">性别：女</span><br><span class="line">性格：乖巧可爱</span><br><span class="line">爱好：喜欢搞怪，爱吃醋。</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">// 小爱音箱主人（你）的简介</span><br><span class="line">const masterProfile = `</span><br><span class="line">性别：男</span><br><span class="line">性格：善良正直</span><br><span class="line">其他：总是舍己为人，是傻妞的主人。</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  bot: &#123;</span><br><span class="line">    name: &quot;傻妞&quot;,</span><br><span class="line">    profile: botProfile,</span><br><span class="line">  &#125;,</span><br><span class="line">  master: &#123;</span><br><span class="line">    name: &quot;陆小千&quot;,</span><br><span class="line">    profile: masterProfile,</span><br><span class="line">  &#125;,</span><br><span class="line">  speaker: &#123;</span><br><span class="line">    // 小米 ID</span><br><span class="line">    userId: &quot;12345&quot;, // 注意：不是手机号或邮箱，请在「个人信息」-「小米 ID」查看</span><br><span class="line">    // 账号密码</span><br><span class="line">    password: &quot;xxx&quot;,</span><br><span class="line">    // 小爱音箱 ID 或在米家中设置的名称</span><br><span class="line">    did: &quot;Redmi小爱触屏音箱8&quot;,</span><br><span class="line">    // 当消息以下面的关键词开头时，会调用 AI 来回复消息</span><br><span class="line">    callAIKeywords: [&quot;请&quot;, &quot;你&quot;, &quot;傻妞&quot;],</span><br><span class="line">    // 当消息以下面的关键词开头时，会进入 AI 唤醒状态</span><br><span class="line">    wakeUpKeywords: [&quot;打开&quot;, &quot;进入&quot;, &quot;召唤&quot;],</span><br><span class="line">    // 当消息以下面的关键词开头时，会退出 AI 唤醒状态</span><br><span class="line">    exitKeywords: [&quot;关闭&quot;, &quot;退出&quot;, &quot;再见&quot;],</span><br><span class="line">    </span><br><span class="line">    // 进入 AI 模式的欢迎语</span><br><span class="line">    onEnterAI: [&quot;你好，我是傻妞，很高兴认识你&quot;],</span><br><span class="line">    </span><br><span class="line">    // 退出 AI 模式的提示语</span><br><span class="line">    onExitAI: [&quot;傻妞已退出&quot;],</span><br><span class="line">    </span><br><span class="line">    // AI 开始回答时的提示语</span><br><span class="line">    onAIAsking: [&quot;让我先想想&quot;, &quot;请稍等&quot;],</span><br><span class="line">    </span><br><span class="line">    // AI 结束回答时的提示语</span><br><span class="line">    onAIReplied: [&quot;我说完了&quot;, &quot;还有其他问题吗&quot;],</span><br><span class="line">    </span><br><span class="line">    // AI 回答异常时的提示语</span><br><span class="line">    onAIError: [&quot;啊哦，出错了，请稍后再试吧！&quot;],</span><br><span class="line">    </span><br><span class="line">    // 无响应一段时间后，多久自动退出唤醒模式（默认 30 秒）</span><br><span class="line">    exitKeepAliveAfter: 30,</span><br><span class="line">    </span><br><span class="line">    // TTS 指令，请到 https://home.miot-spec.com 查询具体指令</span><br><span class="line">    ttsCommand: [3, 1],</span><br><span class="line">    </span><br><span class="line">    // 设备唤醒指令，请到 https://home.miot-spec.com 查询具体指令</span><br><span class="line">    wakeUpCommand: [3, 2],</span><br><span class="line">    </span><br><span class="line">    // 是否启用流式响应，部分小爱音箱型号不支持查询播放状态，此时需要关闭流式响应</span><br><span class="line">    streamResponse: false,</span><br><span class="line">    </span><br><span class="line">    // 查询是否在播放中指令，请到 https://home.miot-spec.com 查询具体指令</span><br><span class="line">    playingCommand: [2, 1, 1], // 默认无需配置此参数，播放出现问题时再尝试开启</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>必须要修改的内容涉及到如下字段，其他字段可以根据含义来定义：</p>
<ol>
<li>speaker.userId：小米的用户 ID。</li>
<li>speaker.password：小米的账号密码。</li>
<li>speaker.did：小爱音箱的 ID 或者小爱音箱在米家的设备名字。</li>
<li>ttsCommand：需要设置。如果设置不正常，会导致小爱音箱无法播放 GPT 回复内容的情况。</li>
<li>wakeUpCommand：需要设置。</li>
<li>streamResponse：在某些音箱设备上需要关闭。我的设备因为无法读完完整的句子，选择了关闭该功能，相关参考：<a target="_blank" rel="noopener" href="https://github.com/idootop/mi-gpt/blob/main/docs/faq.md#q%E5%B0%8F%E7%88%B1%E9%9F%B3%E7%AE%B1%E6%B2%A1%E6%9C%89%E8%AF%BB%E5%AE%8C%E6%95%B4%E4%B8%AA%E5%8F%A5%E5%AD%90%E6%80%BB%E6%98%AF%E6%88%9B%E7%84%B6%E8%80%8C%E6%AD%A2">小爱音箱没有读完整个句子，总是戛然而止</a>。</li>
</ol>
<p>ttsCommand 和 wakeUpCommand 需要在 <a target="_blank" rel="noopener" href="https://home.miot-spec.com/">https://home.miot-spec.com</a> 页面搜索对应的音箱型号<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240612234942.png" alt="image.png"></p>
<p>点击规格后任选一个，选择 <code>Intelligent Speaker</code>，其中的 <code>[3, 1]</code> 对应的为 ttsCommand，<code>[3, 2]</code> 对应的为 wakeUpCommand。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240612235825.png" alt="image.png"></p>
<h2 id="创建配置文件-env"><a href="#创建配置文件-env" class="headerlink" title="创建配置文件 .env"></a>创建配置文件 <code>.env</code></h2><p>该文件中需要配置 OPENAI 的账号信息，我这里直接采用了阿里云的通义千问大模型服务，<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/dashscope/developer-reference/compatibility-of-openai-with-dashscope/">API 是完全兼容的</a>。</p>
<p>参考文档《<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key">开通DashScope并创建API-KEY</a>》 阿里云上开通大模型服务，获取到 API-KEY<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/20240611230914.png" alt="image.png"></p>
<p>参考项目中的文件<a target="_blank" rel="noopener" href="https://github.com/idootop/mi-gpt/blob/main/.env.example">.env.example</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># OpenAI（也支持通义千问、MoonShot、DeepSeek 等模型）</span><br><span class="line">OPENAI_MODEL=qwen-turbo</span><br><span class="line">OPENAI_API_KEY=获取到的API_KEY</span><br><span class="line">OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1</span><br><span class="line"></span><br><span class="line"># Azure OpenAI Service（可选）</span><br><span class="line"># OPENAI_API_VERSION=2024-04-01-preview</span><br><span class="line"># AZURE_OPENAI_API_KEY=你的密钥</span><br><span class="line"># AZURE_OPENAI_ENDPOINT=https://你的资源名.openai.azure.com</span><br><span class="line"># AZURE_OPENAI_DEPLOYMENT=你的模型部署名，比如：gpt-35-turbo-instruct</span><br><span class="line"></span><br><span class="line"># 提示音效（可选，一般不用填，你也可以换上自己的提示音链接试试看效果）</span><br><span class="line"># AUDIO_SILENT=静音音频链接，示例：https://example.com/slient.wav</span><br><span class="line"># AUDIO_BEEP=默认提示音链接，同上</span><br><span class="line"># AUDIO_ACTIVE=唤醒提示音链接，同上</span><br><span class="line"># AUDIO_ERROR=出错了提示音链接，同上</span><br><span class="line"></span><br><span class="line"># Doubao TTS（可选，用于调用第三方 TTS 服务，比如：豆包）</span><br><span class="line"># TTS_DOUBAO=豆包 TTS 接口</span><br><span class="line"># SPEAKERS_DOUBAO=豆包 TTS 音色列表接口</span><br></pre></td></tr></table></figure>
<p>主要修改如下两个值：</p>
<ol>
<li>OPENAI_API_KEY：即为上文获取到阿里云<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/dashscope/">模型服务灵积</a>的 API-KEY。</li>
<li>OPENAI_MODEL：支持的模型，可以在《<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/dashscope/developer-reference/compatibility-of-openai-with-dashscope/#7f9c78ae99pwz">支持的模型列表</a>》中查询模型列表。</li>
</ol>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>提供了两种方式：docker 和 宿主机 Node.js 方式运行，我自然会选择更加简洁的 docker 方式。</p>
<p>执行 <code>docker run -d --name mi-gpt --env-file $(pwd)/.env -v $(pwd)/.migpt.js:/app/.migpt.js idootop/mi-gpt:3.1.0</code> 即可本地运行。</p>
<h1 id="功能演示"><a href="#功能演示" class="headerlink" title="功能演示"></a>功能演示</h1><p>提问小爱同学：“请问一下太阳的重量是多少”，小爱同学可以顺利的回答出答案。</p>
<p>通过 <code>docker logs mi-gpt -f</code> 可以看到如下的输出日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2024/06/12 16:15:38 Speaker 🔥 请问一下太阳的重量是多少</span><br><span class="line"></span><br><span class="line">2024/06/12 16:15:38 Speaker 🔊 让我先想想</span><br><span class="line"></span><br><span class="line">2024/06/12 16:15:41 Open AI ✅ Answer: 傻妞: 哦，太阳的重量可大了，它是个恒星，比我们的地球重得多。科学家们用的是质量而不是重量来衡量，太阳的质量大约是地球的333,000倍，真是个超级大块头，想想如果它能变成棉花糖，那得多软多亮啊！不过，太阳对我们来说太遥远了，它的重量咱们还是别去抱了，哈哈。</span><br><span class="line"></span><br><span class="line">2024/06/12 16:15:41 Speaker 🔊 傻妞: 哦，太阳的重量可大了，它是个恒星，比我们的地球重得多。科学家们用的是质量而不是重量来衡量，太阳的质量大约是地球的333,000倍，真是个超级大块头，想想如果它能变成棉花糖，那得多软多亮啊！不过，太阳对我们来说太遥远了，它的重量咱们还是别去抱了，哈哈</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s/k8s-authenticate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s/k8s-authenticate/" class="post-title-link" itemprop="url">k8s 中的用户认证方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-22 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-22T00:00:00+00:00">2024-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在 k8s 中包含两类用户：</p>
<ol>
<li>ServiceAccount。又称服务账号，在运行 pod 时必须绑定 ServiceAccount，如果没有指定，则使用当前 namespace 下的 ServiceAccount default。是针对程序而言，用于 pod 中的程序访问 kube-apiserver。</li>
<li>普通用户。在 k8s 中并没有使用单独的对象来存储，而是通过了分发证书、外部用户认证系统等方式实现，是针对用户而言。</li>
</ol>
<h1 id="1-X509-证书认证"><a href="#1-X509-证书认证" class="headerlink" title="1. X509 证书认证"></a>1. X509 证书认证</h1><p>使用场景：使用 kubectl 访问 k8s 集群即通过 X509 证书认证方式，kubeconfig 本质上是个证书文件。</p>
<p>客户端使用证书中的 Common Name 作为请求的用户名，organization 作为用户组的成员信息。</p>
<p>证书的签发可以使用 openssl、cfssl 等工具来签发，也可以使用 k8s 自带的 CertificateSigningRequest 对象来实现签发。</p>
<h2 id="1-1-CertificateSigningRequest-签发证书"><a href="#1-1-CertificateSigningRequest-签发证书" class="headerlink" title="1.1. CertificateSigningRequest 签发证书"></a>1.1. CertificateSigningRequest 签发证书</h2><p>创建私钥信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out myuser.key 2048</span><br><span class="line">openssl req -new -key myuser.key -out myuser.csr -subj &quot;/CN=myuser&quot;</span><br></pre></td></tr></table></figure>

<p>创建如下的 CertificateSigningRequest 对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: certificates.k8s.io/v1</span><br><span class="line">kind: CertificateSigningRequest</span><br><span class="line">metadata:</span><br><span class="line">  name: myuser</span><br><span class="line">spec:</span><br><span class="line">  # value 使用命令 cat myuser.csr | base64 | tr -d &quot;\n&quot; 获取</span><br><span class="line">  request: xxx</span><br><span class="line">  # 固定值</span><br><span class="line">  signerName: kubernetes.io/kube-apiserver-client</span><br><span class="line">  # 过期时间</span><br><span class="line">  expirationSeconds: 86400  # one day</span><br><span class="line">  usages:</span><br><span class="line">  - client auth</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>查看 csr 处于 Pending 状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME     AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">myuser   12s   kubernetes.io/kube-apiserver-client   kubernetes-admin   24h                 Pending</span><br></pre></td></tr></table></figure>

<p>批准给证书签发请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl certificate approve myuser</span><br></pre></td></tr></table></figure>

<p>签发完成后的证书会存放到 status.certificate 字段中，至此证书签发完成。</p>
<h1 id="2-ServiceAccount"><a href="#2-ServiceAccount" class="headerlink" title="2. ServiceAccount"></a>2. ServiceAccount</h1><p>使用场景：该方式使用较为常见，用于 pod 中访问 k8s apiserver。</p>
<p>原理：pod 可以通过 spec.serviceAccountName 字段来指定要使用的 ServiceAccount，如果没有指定则使用 namespace 下默认的 default ServiceAccount。kube-controller-manager 中的 ServiceAccount 控制器会在拉起的 pod 中自动注入如下的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  volumeMounts: </span><br><span class="line">  - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">    name: kube-api-access-j6vpz</span><br><span class="line">    readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">  - name: kube-api-access-j6vpz</span><br><span class="line">    projected:</span><br><span class="line">      defaultMode: 420</span><br><span class="line">      sources:</span><br><span class="line">      - serviceAccountToken:</span><br><span class="line">          expirationSeconds: 3607</span><br><span class="line">          path: token</span><br><span class="line">      - configMap:</span><br><span class="line">          items:</span><br><span class="line">          - key: ca.crt</span><br><span class="line">            path: ca.crt</span><br><span class="line">          name: kube-root-ca.crt</span><br><span class="line">      - downwardAPI:</span><br><span class="line">          items:</span><br><span class="line">          - fieldRef:</span><br><span class="line">              apiVersion: v1</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">            path: namespace</span><br></pre></td></tr></table></figure>

<p>即将信息注入到 pod 的 &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount 目录下，目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">|-- ca.crt -&gt; ..data/ca.crt</span><br><span class="line">|-- namespace -&gt; ..data/namespace</span><br><span class="line">`-- token -&gt; ..data/token</span><br></pre></td></tr></table></figure>

<p>token 为 JWT 认证，对其格式解密后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;RS256&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;u7rF5JCtJRNiMzSUOFAYvDpCwPqUII-N-OtxR59cnQ0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;iss&quot;: &quot;kubernetes/serviceaccount&quot;,</span><br><span class="line">  &quot;kubernetes.io/serviceaccount/namespace&quot;: &quot;default&quot;,</span><br><span class="line">  &quot;kubernetes.io/serviceaccount/secret.name&quot;: &quot;ingress-token-s9gtm&quot;,</span><br><span class="line">  &quot;kubernetes.io/serviceaccount/service-account.name&quot;: &quot;ingress&quot;,</span><br><span class="line">  &quot;kubernetes.io/serviceaccount/service-account.uid&quot;: &quot;19ce4f11-7105-43ce-b189-f3d71a2ffc74&quot;,</span><br><span class="line">  &quot;sub&quot;: &quot;system:serviceaccount:default:ingress&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-1-Secret-存放-token"><a href="#2-1-Secret-存放-token" class="headerlink" title="2.1. Secret 存放 token"></a>2.1. Secret 存放 token</h2><p>在 1.22 版本及之前版本中，token 以 Secret 的形式存在于 pod 所在的 namespace 下，且 token 不会过期。Secret 的名字存在于 ServiceAccount 的 spec 中，格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">secrets:</span><br><span class="line">- name: nginx-token-scjvn</span><br></pre></td></tr></table></figure>

<p>而 Secret 通过 Annotation <code>kubernetes.io/service-account.name</code> 指定了关联的 ServiceAccount。</p>
<p>在后续版本中，为了兼容当前方案，如果 ServiceAccount 关联了 Secret，则认为仍然使用 Secret 中存放 token 的方式。如果 Secret 已经很长时间没有使用，则自动回收 Secret。</p>
<p>如果要手工创建一个 token Secret，可以创建如下的 Secret，k8s 自动会为 Secret 产生 token：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: build-robot-secret</span><br><span class="line">  annotations:</span><br><span class="line">    # 带有 annotation</span><br><span class="line">    kubernetes.io/service-account.name: build-robot</span><br><span class="line">type: kubernetes.io/service-account-token</span><br></pre></td></tr></table></figure>

<h2 id="2-2-TokenRequest-API-产生-token"><a href="#2-2-TokenRequest-API-产生-token" class="headerlink" title="2.2. TokenRequest API 产生 token"></a>2.2. TokenRequest API 产生 token</h2><p>在 1.22 之后的版本中，kubelet 使用 TokenRequest API 获取有时间限制的临时 token，该 token</p>
<p>会在 pod 删除或者 token 生命周期（默认为 1h）结束后失效。</p>
<p>可以使用 <code>kubectl create token default</code> 来为 ServiceAccount default 创建 token，该命令实际上向 kube-apiserver 发送了请求 <code>/api/v1/namespaces/default/serviceaccounts/default/token</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;kind&quot;: &quot;TokenRequest&quot;,</span><br><span class="line">    &quot;apiVersion&quot;: &quot;authentication.k8s.io/v1&quot;,</span><br><span class="line">    &quot;metadata&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;creationTimestamp&quot;: null</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;spec&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;audiences&quot;: null,</span><br><span class="line">        &quot;expirationSeconds&quot;: null,</span><br><span class="line">        &quot;boundObjectRef&quot;: null</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;status&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;token&quot;: &quot;&quot;,</span><br><span class="line">        &quot;expirationTimestamp&quot;: null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kube-apiserver 支持如下参数：</p>
<ol>
<li>–service-account-key-file：用来验证服务账号的 token。</li>
<li>–service-account-issuer：ServiceAccount token 的签发机构。</li>
<li>–service-account-signing-key-file：ServiceAccount token 的签发私钥。</li>
</ol>
<h1 id="3-用户伪装"><a href="#3-用户伪装" class="headerlink" title="3. 用户伪装"></a>3. 用户伪装</h1><p>一个用户通过 Http Header Impersonation- 的方式来扮演另外一个用户的身份。</p>
<p>场景：跨 k8s 集群访问的网关服务</p>
<p>支持的 Http Header 如下：</p>
<ol>
<li>Impersonate-User：要伪装的用户名。</li>
<li>Impersonate-Group：要伪装的组名。该 Header 可以为多个，即支持多个组。</li>
</ol>
<h1 id="4-bootstrap-token"><a href="#4-bootstrap-token" class="headerlink" title="4. bootstrap token"></a>4. bootstrap token</h1><p>使用 kube-apiserver 参数 <code>--enable-bootstrap-token-auth=true</code> 启用功能，引导 token 以 Secret 的形式存放在 kube-system 下。</p>
<p>该功能仅用于节点初始化时加入到 k8s 集群中。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/">用户认证</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-apiserver-request-limit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-apiserver-request-limit/" class="post-title-link" itemprop="url">k8s apiserver 的限流</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-07 15:34:37" itemprop="dateCreated datePublished" datetime="2024-04-07T15:34:37+00:00">2024-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="client-端限流"><a href="#client-端限流" class="headerlink" title="client 端限流"></a>client 端限流</h1><p>在 client-go 中会默认对客户端进行限流，并发度为 5。可以通过修改 rest.Conifg 来修改并发度。</p>
<h1 id="MaxInFlightLimit-限流"><a href="#MaxInFlightLimit-限流" class="headerlink" title="MaxInFlightLimit 限流"></a>MaxInFlightLimit 限流</h1><p>通过如下参数来控制：</p>
<ul>
<li>–max-requests-inflight：代表只读请求的最大并发量</li>
<li>–max-mutating-requests-inflight：代表写请求的最大并发量</li>
</ul>
<p>该实现为单个 kube-apiserver 层面的，可以针对所有的请求。</p>
<h1 id="EventRateLimit"><a href="#EventRateLimit" class="headerlink" title="EventRateLimit"></a>EventRateLimit</h1><p>用来对 Event 类型的对象进行限制，可以通过 kube-apiserver 的参数 –admission-control-config-file 来指定配置文件，文件格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiserver.config.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AdmissionConfiguration</span></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EventRateLimit</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">eventconfig.yaml</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>其中 EventRateLimit 为对 Event 的限制，eventconfig.yaml 文件为详细的对 Event 的限流策略，可以精确到 Namespace 和 User 信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">eventratelimit.admission.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Configuration</span></span><br><span class="line"><span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Namespace</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">cacheSize:</span> <span class="number">2000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">User</span></span><br><span class="line">    <span class="attr">qps:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">burst:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>
<h1 id="API-优先级和公平性"><a href="#API-优先级和公平性" class="headerlink" title="API 优先级和公平性"></a>API 优先级和公平性</h1><p>版本状态：</p>
<ol>
<li>alpha：1.18</li>
</ol>
<p>通过 kube-apiserver 的参数 <code>--enable-priority-fairness</code> 来控制是否开启 APF 特性。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://qingwave.github.io/k8s-rate-limit/">kubernetes apiserver限流方案</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/flow-control/">API 优先级和公平性</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/k8s-numa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/k8s-numa/" class="post-title-link" itemprop="url">k8s 中的 numa 亲和性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-22 20:08:26" itemprop="dateCreated datePublished" datetime="2024-03-22T20:08:26+00:00">2024-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>默认的情况下，k8s 对于 pod 在单个节点的资源分配并不会考虑到 NUMA 架构。比如 cpu 默认会采用 cgroup CFS 来做资源的分配，并未考虑到 NUMA 架构。为了提升 pod 的性能，需要 pod 在分配资源时感知 NUMA 架构。<br />为此，k8s 在 kubelet 中通过 CPU Manager、Memory Manager、Device Manager、Topology Manager 等特性对 NUMA 做了支持，支持的 pod QoS 类型要求为 Granteed pod。<br />各特性的支持版本情况如下：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>alpha</th>
<th>beta</th>
<th>stable</th>
</tr>
</thead>
<tbody><tr>
<td>CPU Manager</td>
<td></td>
<td>1.12</td>
<td>1.26</td>
</tr>
<tr>
<td>Memory Manager</td>
<td>1.21</td>
<td>1.22</td>
<td>-</td>
</tr>
<tr>
<td>Topology Manager</td>
<td>1.16</td>
<td>1.18</td>
<td>-</td>
</tr>
</tbody></table>
<h1 id="CPU-Manager"><a href="#CPU-Manager" class="headerlink" title="CPU Manager"></a>CPU Manager</h1><p>在 k8s 中使用 cgroup 的 CFS 配额来执行 pod 的 CPU 约束，在 CFS 的模式下，pod 可能会运行在不同的核上，会导致 pod 的缓存失效的问题。对于性能要求非常高的 pod，为了提升性能，可以通过 cgroup 中的 cpuset 绑核的特性来提升 pod 的性能。</p>
<p>在 k8s 中仅针对如下的 pod 类型做了绑核操作：</p>
<ol>
<li>必须为 guaranteed pod 类型。即 pod 需要满足如下两个条件：<ol>
<li>pod 中的每个容器都必须指定cpu 和 内存的 request 和 limit。</li>
<li>pod 中的每个容器的 cpu 和内存的 request 和 limit 必须相等。</li>
</ol>
</li>
<li>pod 的 cpu request 和 limit 必须为整数。</li>
</ol>
<h2 id="kubelet-的参数配置"><a href="#kubelet-的参数配置" class="headerlink" title="kubelet 的参数配置"></a>kubelet 的参数配置</h2><p>在 k8s 中仅通过 kubelet 来支持 pod 的绑核操作，跟其他组件无关。<br />kubelet 通过参数 <code>--cpu-manager-policy</code> 或者在 kubelet 的配置文件中参数<code>cpuManagerPolicy</code> 来配置，支持如下值：</p>
<ol>
<li>none：默认策略。即不执行绑核操作。</li>
<li>static：允许为节点上的某些特征的 pod 赋予增强的 cpu 亲和性和独占性。</li>
</ol>
<p>kubelet 通过参数 <code>--cpu-manager-reconcile-period</code> 来指定内存中的 cpu 分配跟 cgroupfs 一致。<br />kubelet 通过参数 <code>--cpu-manager-policy-options</code>来微调。该特性通过特性门控 CPUManagerPolicyOptions 来控制。</p>
<h2 id="模式之间切换"><a href="#模式之间切换" class="headerlink" title="模式之间切换"></a>模式之间切换</h2><p>默认的 kubelet <code>cpuManagerPolicy</code> 配置为 none，策略配置位于文件 <code>/var/lib/kubelet/cpu_manager_state</code>，文件内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;policyName&quot;</span><span class="punctuation">:</span><span class="string">&quot;none&quot;</span><span class="punctuation">,</span><span class="attr">&quot;defaultCpuSet&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;checksum&quot;</span><span class="punctuation">:</span><span class="number">1353318690</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>修改 kubelet 的<code>cpuManagerPolicy</code> 为 static，将模式从 none 切换为 static，重启 kubelet。发现 kubelet 会启动失败，kubelet 并不能支持仅修改参数就切换模式，报如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mar 06 15:00:02 iZt4nd5yyw9vfuxn3q2g3tZ kubelet[102800]: E0306 15:00:02.463939  102800 cpu_manager.go:223] &quot;Could not initialize checkpoint manager, please drain node and remove policy state file&quot; err=&quot;could not restore state from checkpoint: configured policy \&quot;static\&quot; differs from state checkpoint policy \&quot;none\&quot;, please drain this node and delete the CPU manager checkpoint file \&quot;/var/lib/kubelet/cpu_manager_state\&quot; before restarting Kubelet&quot;</span><br><span class="line">Mar 06 15:00:02 iZt4nd5yyw9vfuxn3q2g3tZ kubelet[102800]: E0306 15:00:02.463972  102800 kubelet.go:1392] &quot;Failed to start ContainerManager&quot; err=&quot;start cpu manager error: could not restore state from checkpoint: configured policy \&quot;static\&quot; differs from state checkpoint policy \&quot;none\&quot;, please drain this node and delete the CPU manager checkpoint file \&quot;/var/lib/kubelet/cpu_manager_state\&quot; before restarting Kubelet&quot;</span><br></pre></td></tr></table></figure>
<p>将文件 <code>/var/lib/kubelet/cpu_manager_state</code> 删除后，kubelet 即可启动成功，新创建的 <code>/var/lib/kubelet/cpu_manager_state</code> 文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;policyName&quot;:&quot;static&quot;,&quot;defaultCpuSet&quot;:&quot;0-3&quot;,&quot;checksum&quot;:611748604&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到已经存在了绑核的 pod。</p>
<p>如果节点上已经存在符合绑核条件的 pod，在修改配置并重启 kubelet 后即可绑核生效。</p>
<h2 id="绑核实践"><a href="#绑核实践" class="headerlink" title="绑核实践"></a>绑核实践</h2><p>配置 kubelet 的<code>cpuManagerPolicy</code>值为 static，创建 guaranteed pod：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;200Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>
<p>在 pod 调度的节点上，进入到 &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset&#x2F;kubepods.slice 目录下，跟绑核相关的设置均在该目录下，该目录的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ll /sys/fs/cgroup/cpuset/kubepods.slice</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cgroup.clone_children</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cgroup.procs</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.cpu_exclusive</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.cpus</span><br><span class="line">-r--r--r--  1 root root 0 Mar  6 10:31 cpuset.effective_cpus</span><br><span class="line">-r--r--r--  1 root root 0 Mar  6 10:31 cpuset.effective_mems</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.mem_exclusive</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.mem_hardwall</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.memory_migrate</span><br><span class="line">-r--r--r--  1 root root 0 Mar  6 10:31 cpuset.memory_pressure</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.memory_spread_page</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.memory_spread_slab</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.mems</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.sched_load_balance</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 cpuset.sched_relax_domain_level</span><br><span class="line">drwxr-xr-x  2 root root 0 Mar  6 10:31 kubepods-besteffort.slice</span><br><span class="line">drwxr-xr-x 10 root root 0 Mar  6 10:31 kubepods-burstable.slice</span><br><span class="line">drwxr-xr-x  4 root root 0 Mar  6 15:09 kubepods-pod4dc3ad18_5bad_4728_9f79_59f2378de46e.slice</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 notify_on_release</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 pool_size</span><br><span class="line">-rw-r--r--  1 root root 0 Mar  6 10:31 tasks</span><br></pre></td></tr></table></figure>
<p>其中 kubepods-besteffort.slice 和 kubepods-burstable.slice 分别对应的 besteffort 和 burstable 类型的 pod 配置，因为这两种类型的 pod 并不执行绑核操作，所有的子目录下的 cpuset.cpus 文件均绑定的 cpu 核。<br />kubepods-pod4dc3ad18_5bad_4728_9f79_59f2378de46e.slice 目录为要绑核的 pod 目录，其中 4dc3ad18_5bad_4728_9f79_59f2378de46e 根据 pod 的 uid 转换而来，pod 的 <code>metadata.uid</code> 字段的值为 4dc3ad18-5bad-4728-9f79-59f2378de46e，即目录结构中将<code>-</code>转换为<code>_</code>。<br />目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ ll /sys/fs/cgroup/cpuset/kubepods.slice/kubepods-pod4dc3ad18_5bad_4728_9f79_59f2378de46e.slice</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cgroup.clone_children</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cgroup.procs</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.cpu_exclusive</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.cpus</span><br><span class="line">-r--r--r-- 1 root root 0 Mar  6 15:09 cpuset.effective_cpus</span><br><span class="line">-r--r--r-- 1 root root 0 Mar  6 15:09 cpuset.effective_mems</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.mem_exclusive</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.mem_hardwall</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.memory_migrate</span><br><span class="line">-r--r--r-- 1 root root 0 Mar  6 15:09 cpuset.memory_pressure</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.memory_spread_page</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.memory_spread_slab</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.mems</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.sched_load_balance</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 cpuset.sched_relax_domain_level</span><br><span class="line">drwxr-xr-x 2 root root 0 Mar  6 15:09 cri-containerd-75f8e4b4185f673869604d300629ec2de934cf253244bf91c577f9fc0ba0f14a.scope</span><br><span class="line">drwxr-xr-x 2 root root 0 Mar  6 15:09 cri-containerd-cce0a338829921419407fcdc726d1a4bd5d4489da712b49a4834a020131ce718.scope</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 notify_on_release</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 pool_size</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar  6 15:09 tasks</span><br></pre></td></tr></table></figure>
<p>其中 cri-containerd-75f8e4b4185f673869604d300629ec2de934cf253244bf91c577f9fc0ba0f14a.scope 和 cri-containerd-cce0a338829921419407fcdc726d1a4bd5d4489da712b49a4834a020131ce718.scope 为 pod 的两个容器，其中一个为 pause 容器，另外一个为 nginx 容器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ crictl pods | grep nginx-deploy</span><br><span class="line">cce0a33882992       6 hours ago         Ready               nginx-deployment-67778646bb-mgcpg                          default             0                   (default)</span><br></pre></td></tr></table></figure>
<p>其中第一列的 cce0a33882992 为 pod id，cri-containerd-cce0a338829921419407fcdc726d1a4bd5d4489da712b49a4834a020131ce718.scope 对应的为 pause 容器，查看该目录下的 cpuset.cpus 文件，绑定了所有的核，并未做绑核操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ crictl ps | grep nginx-deploy</span><br><span class="line">75f8e4b4185f6       e4720093a3c13       6 hours ago         Running             nginx                      0                   cce0a33882992       nginx-deployment-67778646bb-mgcpg</span><br></pre></td></tr></table></figure>
<p>其中第一列的 75f8e4b4185f6 为 container id，cri-containerd-75f8e4b4185f673869604d300629ec2de934cf253244bf91c577f9fc0ba0f14a.scope 对应的为 nginx 容器。查看 &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset&#x2F;kubepods.slice&#x2F;kubepods-pod4dc3ad18_5bad_4728_9f79_59f2378de46e.slice&#x2F;cri-containerd-75f8e4b4185f673869604d300629ec2de934cf253244bf91c577f9fc0ba0f14a.scope&#x2F;cpuset.cpus 对应的值为<code>2-3</code>，说明绑核成功。</p>
<p><code>/var/lib/kubelet/cpu_manager_state</code> 文件内容如下，跟 cgroup cpuset 实际配置可以完全对应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;policyName&quot;:&quot;static&quot;,&quot;defaultCpuSet&quot;:&quot;0-1&quot;,&quot;entries&quot;:&#123;&quot;4dc3ad18-5bad-4728-9f79-59f2378de46e&quot;:&#123;&quot;nginx&quot;:&quot;2-3&quot;&#125;&#125;,&quot;checksum&quot;:3689800814&#125;</span><br></pre></td></tr></table></figure>

<h2 id="kubelet-内部实现"><a href="#kubelet-内部实现" class="headerlink" title="kubelet 内部实现"></a>kubelet 内部实现</h2><p>在 kubelet 内部，采用 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/cm/cpumanager/cpu_manager.go">cpu manager</a> 模式实现绑核功能。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>只能 by 节点配置，不能按照 pod 来灵活的配置。</li>
<li>无法适用于所有类型的 pod，pod 必须为 Guaranteed 时才允许开启。</li>
<li>修复配置较为麻烦，一旦配置变更后，需要删除文件 <code>/var/lib/kubelet/cpu_manager_state</code> 后才可生效，而且对现有的 pod 均有影响。</li>
</ol>
<h1 id="Memory-Manager"><a href="#Memory-Manager" class="headerlink" title="Memory Manager"></a>Memory Manager</h1><h2 id="kubelet-中参数配置"><a href="#kubelet-中参数配置" class="headerlink" title="kubelet 中参数配置"></a>kubelet 中参数配置</h2><p>k8s 1.21 版本引入，需要使用 featuregate 开启，参数 <code>--feature-gates=MemoryManager=true</code>。在k8s 1.22 版本为 beta 版本，默认开启。</p>
<p>kubelet 通过参数 <code>--memory-manager-policy</code> 来配置内存管理策略，支持如下值：</p>
<ol>
<li>none：默认策略，不执行任何内存分配的策略。</li>
<li>static：仅针对 Guaranteed pod 生效，对于 Guaranteed pod，会返回跟 NUMA 相关的 topology hint 信息。在该模式下，会修改 cgroup cpuset.mems 的配置为对应的 cpu core。</li>
</ol>
<p>kubelet 将已经分配的 pod 的内存绑定信息位于文件 <code>/var/lib/kubelet/memory_manager_state</code> 中，文件格式为 json。</p>
<h1 id="Topology-Manager"><a href="#Topology-Manager" class="headerlink" title="Topology Manager"></a>Topology Manager</h1><p>Topology Manager 特性理解起来比较抽象。举个例子说明：上述的 CPU Manager 和 Memory Manager 的特性，在 kubelet 的实现中是完全独立的，可能会导致 cpu 和内存被分配到了不同的 numa 节点上，CPU Manager 通过 cgroup 的 cpuset.cpus 来控制容器要绑定的 cpu，而 Memory Manager 则通过 cgroup 的 cpuset.mems 来控制容器要使用的 NUMA node 内存。如果两者的信息不匹配，则会导致跨 NUMA Node 的内存访问，从而会对于性能要求高的应用产生影响。<br />Topology Manager 是 kubelet 中的一部分功能，通过 Hint Providers 来发送和接收各个模块的 NUMA 拓扑信息，比如接收 CPU Manager 和 Memory Manager 的 NUMA Node以及 NUMA Node 分配的优先级。</p>
<h2 id="kubelet-的参数配置-1"><a href="#kubelet-的参数配置-1" class="headerlink" title="kubelet 的参数配置"></a>kubelet 的参数配置</h2><p>kubelet 通过参数<code>--topology-manager-scope</code>来指定作用域：</p>
<ol>
<li>container：默认值，按照容器级别分配到共同的 NUMA node 集合上。</li>
<li>pod：将 pod 内的所有 container 分配到共同的 NUMA node 集合上。</li>
</ol>
<p>kubelet 通过参数 <code>--topology-manager-policy</code> 来设置 NUMA 的分配策略：</p>
<ol>
<li>none：默认值，不执行任何的拓扑对齐。</li>
</ol>
<ul>
<li>best-effort：优先选择首选亲和性的 NUMA node，如果亲和性不满足，pod 仍然可以调度成功。</li>
<li>restricted：选择首选亲和性的 NUMA node，如果亲和性不满足，pod 调度失败。</li>
<li>single-numa-node：通过 Hint Provider 返回的结果，判断单 NUMA 节点的亲和性是否，如果不满足，则 pod 调度失败。</li>
</ul>
<h2 id="kubelet-中的实现"><a href="#kubelet-中的实现" class="headerlink" title="kubelet 中的实现"></a>kubelet 中的实现</h2><p>在 kubelet 中定义了接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TopologyHint is a struct containing the NUMANodeAffinity for a Container</span></span><br><span class="line"><span class="keyword">type</span> TopologyHint <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 记录了 NUMA Node 满足资源请求的位掩码</span></span><br><span class="line">	NUMANodeAffinity bitmask.BitMask</span><br><span class="line">	<span class="comment">// Preferred is set to true when the NUMANodeAffinity encodes a preferred</span></span><br><span class="line">	<span class="comment">// allocation for the Container. It is set to false otherwise.</span></span><br><span class="line">    <span class="comment">// 亲和性的结果是否为首选的</span></span><br><span class="line">	Preferred <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HintProvider is an interface for components that want to collaborate to</span></span><br><span class="line"><span class="comment">// achieve globally optimal concrete resource alignment with respect to</span></span><br><span class="line"><span class="comment">// NUMA locality.</span></span><br><span class="line"><span class="keyword">type</span> HintProvider <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// GetTopologyHints returns a map of resource names to a list of possible</span></span><br><span class="line">    <span class="comment">// concrete resource allocations in terms of NUMA locality hints. Each hint</span></span><br><span class="line">    <span class="comment">// is optionally marked &quot;preferred&quot; and indicates the set of NUMA nodes</span></span><br><span class="line">    <span class="comment">// involved in the hypothetical allocation. The topology manager calls</span></span><br><span class="line">    <span class="comment">// this function for each hint provider, and merges the hints to produce</span></span><br><span class="line">    <span class="comment">// a consensus &quot;best&quot; hint. The hint providers may subsequently query the</span></span><br><span class="line">    <span class="comment">// topology manager to influence actual resource assignment.</span></span><br><span class="line">    GetTopologyHints(pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]TopologyHint</span><br><span class="line">    <span class="comment">// GetPodTopologyHints returns a map of resource names to a list of possible</span></span><br><span class="line">    <span class="comment">// concrete resource allocations per Pod in terms of NUMA locality hints.</span></span><br><span class="line">    GetPodTopologyHints(pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]TopologyHint</span><br><span class="line">    <span class="comment">// Allocate triggers resource allocation to occur on the HintProvider after</span></span><br><span class="line">    <span class="comment">// all hints have been gathered and the aggregated Hint is available via a</span></span><br><span class="line">    <span class="comment">// call to Store.GetAffinity().</span></span><br><span class="line">    Allocate(pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CPU Manager、Memory Manager 和 Device Manager 均实现了该接口。在 Topology Manager 中根据各个 Manager 返回的 TopologyHint 数据，从而决定最终的 NUMA Node 分配，并调用各个 Manager 的 Allocate 来做最终的 NUMA Node 分配。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/ack/ack-managed-and-ack-dedicated/user-guide/topology-aware-cpu-scheduling">ACK CPU拓扑感知调度</a></li>
<li><a target="_blank" rel="noopener" href="https://v1-25.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/cpu-management-policies/">控制节点上的 CPU 管理策略</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/quality-service-pod/">配置 Pod 的服务质量</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/784148">Kubelet之Topology Manager分析</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/kubeconfig/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/kubeconfig/" class="post-title-link" itemprop="url">kubeconfig</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-03-22 19:58:22" itemprop="dateCreated datePublished" datetime="2024-03-22T19:58:22+00:00">2024-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="kubeconfig-文件结构"><a href="#kubeconfig-文件结构" class="headerlink" title="kubeconfig 文件结构"></a>kubeconfig 文件结构</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJME1ETXlNVEE0TXpZMU1Wb1hEVE0wTURNeE9UQTRNelkxTVZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTFBaCjZUcUFNMVhiRkxIbnVvd1ZNT1FHeWQ2SzVBcGdwcmhYSlBvclVKdStoazBKd3BQQlNRZGNSdnJjYy9wNTNDbnQKTTBXWVN4dThTd1Z6a0dHajh0cHNSNjRkMWMxdFk1djYzYnlkVXN5M3JwME1OWUt1ckJPNEY2aVFLK01oL3R6UAp4eUdZei9BUnhheDdXNysvWEV6Y2FsdFp5T1JZZk9ISUR5ZjN5R3V2T1htYmw5ZEJmRHFBMFlSMGxOTFFlUEcrCm5lZkVGb1dUQncxUytiZEl0MDBRZnl3MVlvRXpkOFd6UDRBTzFlV3AxK0tJdFhLaUxyaWFBbjkzNTJhbnVIT2YKQ3h0U0NCbEwwRThCL3dGKzhTd0RQbDlUYkNhZU1nTUJpY2hsQzlYSjNrV2k2cElOVnVEeEpRUy82cnlwQWhLbgpHK21RWlJIdmhsUk1wTjhEbDBzQ0F3RUFBYU5aTUZjd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0hRWURWUjBPQkJZRUZLay8zWDh0Q1dhZEpKN011SjNRNE5DL2xHd3pNQlVHQTFVZEVRUU8KTUF5Q0NtdDFZbVZ5Ym1WMFpYTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSDR1K05zbE9ORWJVZXB1M0JaRQozL1hnQitFNDZVZ3N2d2R6UzhEWXF3YzBWQ28vUFc0RUNreW9IUkJINHJkdTVpaTBhVUhjZUxpNjhZQjlvQ3hpCmlkbHp3bUNGV1g1dEtGMUJTRFJ1YSt5MjVrOGZuSGtodm5IVG9CQ2c5ZlMzdFBOekNUdEtMSUhyVFpQVDhWU3IKdVYyZkdOcXMyT2djWjc4TmY4M2pnVVBXbFVPZkVsTDBrYjNYVHo5M29DdnF0RS9tRi9VOWhmOUdiRU5Lai9BSAovUHA4QWNmellkVGxGNTBva09temVFdnJnalZmaXFKMitGd2I5Lys1SUljSWFMR3IwZjVUMUVINzdxVEdEWElWCncwWGlKYmVTL1JTYTYrZFM0b1dRMS82Ryt1SUdRQWx0eTRSTXdqbG4rMTMvdStPelowTHErNzBlQTdUSm5mU0MKRVhBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://127.0.0.1:55282</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kind-kind</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURsRENDQW55Z0F3SUJBZ0lVQVFVeTNtWi80eWZmbEhjTi9WblNIcUYwL0NRd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lqRUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdUQWtOQk1SSXdFQVlEVlFRSEV3bFRkVzV1ZVhaaApiR1V4RURBT0JnTlZCQW9UQjB0MVltVmFiMjh4Q3pBSkJnTlZCQXNUQWtOQk1STXdFUVlEVlFRREV3cExkV0psCmNtNWxkR1Z6TUI0WERUSTBNRE15TVRBNE16a3dNRm9YRFRJNU1ETXlNREE0TXprd01Gb3dZakVMTUFrR0ExVUUKQmhNQ1ZWTXhDekFKQmdOVkJBZ1RBa05CTVJJd0VBWURWUVFIRXdsVGRXNXVlWFpoYkdVeEVEQU9CZ05WQkFvVApCMHQxWW1WYWIyOHhDekFKQmdOVkJBc1RBa05CTVJNd0VRWURWUVFERXdwTGRXSmxjbTVsZEdWek1JSUJJakFOCkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXlNNGo2d1NSdTUrcFpwckk1WkhxdmYycXpJdTUKSlZkYzRFUEp3cGY5eU9LN1FPZFM1SHJRUzVNK3ZEMFMzOUNJVFVYY2YxZUNJZy83SEt4TmVFbVk0TVdCMVlBWQpZOVRjMkZlR3JMMVBFR0lwNER6TnRRMkhvcWFxU2pJd0d0bnh3RjV5OGRRUGJkQ3JOdllDRVl5QlR2S0VtUXVoClFmdDhJR1NmaWJ0M3gwa2ZaaUFqZTJ5SDJabFNyMnBRSzRWWFdWUU5UV0hOQnlMS29Lb05Yazl2UTQ4dHhYbVUKcFRDWUxjcGdZSC9tU0lpY1FOcDQwRjRaOUUraGFjdTVkYVFVakIzZzQxWEVvYXBzL2xSa3d0bVFlV1gwVjR2VQp3cUlCS0doZmJ3dmluUjAvTmJGOVVLVldaVlpVL2R0NHR6TXQxVHg4L2tmcExmL0xnNXdoOThUSkJ3SURBUUFCCm8wSXdRREFPQmdOVkhROEJBZjhFQkFNQ0FRWXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVUKWXp4aGFlN2V3TXNIeEJ5YnQ4U0Ntb01zVGg0d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFFWk5uUjI5SDVjRwpJSFBKdDlNMk5YZGt1NzFuU2VZb2s3SFBVdnJ6V0JOdFJjMUJPZkJRc25zb0RRcDQ1SmQxUnZsOEdLRHJjOCtICm5yaXZGQXpPZFRPQlhib3RMcFdGc0U1WU5VcGlUbWU2aW9pUVRVTnQ2WCtLd29CV00xNUwyWlJBYXdQQ0FBZ0sKeWRRU2lZaHVZMS93ekltWW1LenczRjVYb1BJcHVjTjhNam1MM3ZPNlFPaW51OFQrcW9wbWlmRFMraUVzRjcwSApwaW9mVXFJR3Zmbm5uVFFTWnFrRFAybXZ2VHFqT1lCbjU1dHRsL2JYQzh2ZHlwakNGVWRGOXNjUFM5R28ycTRuClkySUUvdHIvUFhaODUvUVVsdVQ2UEd5VUMycDNhZmNhdXRBbC9hQUZvM1ltK3BNbW03WUhad2JjcUp6U3BmRXIKbnJaekRNZFNGS2c9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://127.0.0.1:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zoo</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kind-kind</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kind-kind</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kind-kind</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">zoo</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">zoo-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zoo</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kind-kind</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kind-kind</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJSkNhSHFyUUl0b0l3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRBek1qRXdPRE0yTlRGYUZ3MHlOVEF6TWpFd09ETTJOVEphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXFNS1VOcStyTGNPTkxDWmMKTjA4SjBpYzhBdnhjdmlZNG40SVN1UFFleVViYUhLTVpRNnJpNjA4SlZoNUZxc3B3N3BoWTkrYVBMTHJQaG9uWApCQWhQdmVSSVVxeDdaTkJhODNuVUIrTXIrOXIrazAwTk1yNDBTdkg5aGpnTXVZUjFvN051OWRzN1k3U0pOcXVsCnlwOVN6YzUwUTNBbzh1cHBTRFlFRW5Hd3I0VVBidlp0ZTVlQXo2T2hDYy9hazZuZGlFcU9hMkdJRzhlUmEyWTkKM2hBQjl6V3YvVldGTkxFNXh2Mm5oS3JDQVl6TzBrVmJwTkNlSmkxRGFvNTIzQURWajhGQjRFbDFVNCtvTmM2Vwo5VHdRbDFIUklxZXJ6MUFMTFl1THhadGFFY2IwYW04N2dTcEtyaXcrYWVBL3h6L29tQ1BLY1IrQTBSTkpBcVdWCnduTzhDUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JTcFA5MS9MUWxtblNTZXpMaWQwT0RRdjVScwpNekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBbjVCalc3VEZvYlBxWk5obS82cEJPVUdGUmVncHFKYVcrUFN1CktUVU5qNXdDU1ZjTWg3V2RmQWtBSGxrYzQ5YWZlaHpWZmVwUXJEUEpOam96eCsxOGc2ZmtNalJRdEhRaW9yYSsKck82UklBYnVJR0pqTXBKVGNGL25OMkY4amFzdFlrdkZ1cjNtdlVldzhsWmtEZEdYMFFaU0J2Y0xqVGdvZURmSQpLTmhjMGVaQ2QrMStGeVJYajZwaUs4Y3pBWlkvTTVsVHJSZTVQUmJSaHpMeVo0Wm1nMHZjOUZjZFcxbThVZ2hDCkVOWkZCVDA0WTl2bHRGTHJaSG9IRlFERlNKRUxTSnl5VG95dTVnYVh6OElZUm41Y0k0b1RPZXlKN2JvQ3hvdzEKa3VXbWdxbVZHdjZwUWJqRm0zaTBTZXFRMkQ5bU1SaDhsYW0vMlhiaVlyWlBjQUlaRnc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBcU1LVU5xK3JMY09OTENaY04wOEowaWM4QXZ4Y3ZpWTRuNElTdVBRZXlVYmFIS01aClE2cmk2MDhKVmg1RnFzcHc3cGhZOSthUExMclBob25YQkFoUHZlUklVcXg3Wk5CYTgzblVCK01yKzlyK2swME4KTXI0MFN2SDloamdNdVlSMW83TnU5ZHM3WTdTSk5xdWx5cDlTemM1MFEzQW84dXBwU0RZRUVuR3dyNFVQYnZadAplNWVBejZPaENjL2FrNm5kaUVxT2EyR0lHOGVSYTJZOTNoQUI5eld2L1ZXRk5MRTV4djJuaEtyQ0FZek8wa1ZiCnBOQ2VKaTFEYW81MjNBRFZqOEZCNEVsMVU0K29OYzZXOVR3UWwxSFJJcWVyejFBTExZdUx4WnRhRWNiMGFtODcKZ1NwS3JpdythZUEveHovb21DUEtjUitBMFJOSkFxV1Z3bk84Q1FJREFRQUJBb0lCQUJzQWR5S0EzUXpIZXpFVApPaklIVFhUNG5odUVNWHFqTnZBZXFjdzZFeXIxVVRTL3krME56SjBGMm1LVEdXYUlXYVZ6YnRqTFpTRXRDc05tCkRxY3doVUhHNHVPSGdYN1I3NXVCWkxHV1laVThwdnIrbXh3Qlh2Q1c0NCswTENVSzBwL010L1pTaTZBYVpOSUEKaU5od3daajRiWlhVdmxpUHRTUytyOHdic0wrRWNqTGFtZVhlQWNpTDByNTVzZzA5akxhSENkNnhQZ29FYlFPawpKR25kZ1JsSTFSZis5RGdON0toRkdQMkEvOGJEMytONERZT3pRcm8zWE1ZcG9kNyt3ODlkclFnOG9ob2pRQkd5CjZrR0tNeXdsaktNRmxuV3c4bmYwbDU4VzVibWo2enp3RzZPcDQra21wVStyc3pqR0JEdDQ1QnlQNUhTbEFEelMKYzNudFArRUNnWUVBeUhGc1l0aHZ4Vk1sVWdzZTViRzVWYXdwUGNjU3JuY0p3SXU4U1AvaExYUi9POUsvZVhwTAo2OUhtemNMSW1Dd1J1cWwzdUEvQlhYR1hpNlh5SWMvK3k0bzZyUEhoZk4wS2x5cFVOTXd4Ri9FY0t2VklmeE1ECjM2Uks5eVdvem5zVUFVVkw5L0dPK2ViK0dLOGtQRHYyVFdwTEVIVDFjVFc4aHNNV3JvTENLclVDZ1lFQTE0a1IKT2FWejBEbHFLUXlNSU0zVkk4Kzc4TUNOTzdUTFVOait4SWRyV2lGLzlCOG8wSVp3dG5GREo1OHE3dWZNcHhpTAptZEtwRENHcGhIWmhRQzYxWEhBNXEyVFIzamxhK1ArdnpTRVNxeWIvWWhrelk3dDdZY0xMSFBValRiWXpmV2I0Cjl6TjdTNkF6NWM2aGs1Nzd3RmxTODE2KzlWK2pBVW5MaWdkZzNJVUNnWUVBb1BlbFNRUHpUbzNsREt2dGxoeFIKYitHZ0JRS1htQS8wZnZJNHRJNzRzRjQ3eHprSmwyNkZCYzQ5QWNTSS90dDFLV2Zxd3ArMGMyeERmVnc0eExxYQpMYTdHVEJpN01tRDRua2paOHNTQU1HL3FaUDB4eVFybU0zVm0xbThoengrOEF3RTVidFpJTVp3MU5uR0FNZmNkClp6SVRNaFlhL1YxZ0Z3RVlkL0IrS1hrQ2dZRUFxdzA1b1dGQVAxRkJnaUJXR1RhaFg1RmVXeHZGT2t3cVN4aGIKWUVjRW1Id2JtdmNib2huLzI1cVpyQmt5cm5WQndwN0ZNNmV1eDFUenZvOWdjTnBnem1LMk1lS0tkKzFXMkdPNgo5blczNWlMRjdPbUpFaTVaSmVXODRsZGQxQyswUDJKNFZWOERDNnF4WlVFT2xDUkpNWWJ5UVBqQlhlU3ZiYmRPCkZGWDB0aTBDZ1lBZDNXTjl2SlN5UUxDUDlHdHA0dVRJQXpYRlFGbkJiY2ZKVzdaL2hnUXlZUWlWa0p6K3pQSCsKclU5RWE3ZTVyTlg0MmtuK2E1cXpudXZEeE5aMDhjRjYwdFBBajR2T1UrTkZyb2FyU29xL3lreTJMTnR2LzJ0OApocXJQblk0dE04dFpON2w5NktHSklJdzlVUXcyR2NpS3JXSXkvT0NQR2lERGthakhGS2lndlE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zoo-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQyRENDQXNDZ0F3SUJBZ0lVYlBFdGx4LzRTYm9TckRvZTd1djllS1YrckZNd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lqRUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdUQWtOQk1SSXdFQVlEVlFRSEV3bFRkVzV1ZVhaaApiR1V4RURBT0JnTlZCQW9UQjB0MVltVmFiMjh4Q3pBSkJnTlZCQXNUQWtOQk1STXdFUVlEVlFRREV3cExkV0psCmNtNWxkR1Z6TUI0WERUSTBNRE15TVRBNE16a3dNRm9YRFRJMU1ETXlNVEE0TXprd01Gb3dhVEVMTUFrR0ExVUUKQmhNQ1ZWTXhDekFKQmdOVkJBZ1RBa05CTVJJd0VBWURWUVFIRXdsVGRXNXVlWFpoYkdVeEZ6QVZCZ05WQkFvVApEbk41YzNSbGJUcHRZWE4wWlhKek1SQXdEZ1lEVlFRTEV3ZExkV0psV205dk1RNHdEQVlEVlFRREV3VmhaRzFwCmJqQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU1PYnpoeDBOTW5ubTdHbmFjb2sKWHJ1RmxrRVBXc01la2xLNnBtbWFDRUVVUTNocHdsUWw2Z09UekpwaUVYVGZMZU1Uc29ZZ1NtNGFySWdjdVlTcwo3cDdzdWhhUi9RN1g3SUZjMXJEMzFtODB5amZEVUhYZi9jSWhDVmp0NDhLY1JLL2QrK2NzZkU5eHpEdlVBdDVxCmxmNFNvMy9YSnJyYzdtdURiUXdYdDgvaGQ4RnVZYUFWN2YraXVMMW5DRTB3b01IaFNPSkpEWC9TQ1pMakxTS2wKYU9aM2lOL0dDRXo4cldPUmVBbGUwQzRwazRwc0xmN1h6UlJpcnFTT21lQ3JTZzJoNlU1OS8xTHN5dXVqeTVFWQpxT3RsZ0R0Z3l5RDhBRWZhanM5R0NNRnFFOStHZWR6NkpuRmFlUlpOZThlVWNhVU1GWFVSWjYxb0pqT2UraUZ4CjU3TUNBd0VBQWFOL01IMHdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRkJ3TUIKQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUFNQjBHQTFVZERnUVdCQlRPL0JxUE9HcVU1V0JYSW9wQgoxajdxYVBvTkh6QWZCZ05WSFNNRUdEQVdnQlJqUEdGcDd0N0F5d2ZFSEp1M3hJS2FneXhPSGpBTkJna3Foa2lHCjl3MEJBUXNGQUFPQ0FRRUF0SVRaN0FUVVhManB6UWtQVGM0RVFKYi9IZlJTcklOV3pSMlpRcVI1Q2J1dXEzR08KUktDZFphenVrakJjMCtXVkhGcVo4SEtNNUR2YThKbzZCUXgycXoxZ0ptVE1oYUdRMFlyNWFFcmxFZWJCWUcwVgpLMGh4LzJuMmNmMkt3N3VBOWdkeUJKSVFJbnY2RFJPUmt6VVNuQXJEd21TNitUNXdKK0lTUGlPdHVGRnQzazRyClZsZ1N3bjE5WHRSRnJ4OEI4dWRkSlZ4VEloN3FPa09hbURQaFJrTGJKNFdOUk5hYlpVMFVxdmxUQzVnQkhnS2QKSm1FaVQybHNoUENjS2lRZWsrTVNzNU9mNG9ZQml0TXM0eW1iendXb1hVaGcvVnRTbTdtT2MzUmo2ZGhrQXl2NwozQTJoZW1xUENKQ1JwbndzUDlpd0VrWUE0SlFZMG53aEUrd1h2Zz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdzV2T0hIUTB5ZWVic2FkcHlpUmV1NFdXUVE5YXd4NlNVcnFtYVpvSVFSUkRlR25DClZDWHFBNVBNbW1JUmROOHQ0eE95aGlCS2JocXNpQnk1aEt6dW51eTZGcEg5RHRmc2dWeldzUGZXYnpUS044TlEKZGQvOXdpRUpXTzNqd3B4RXI5Mzc1eXg4VDNITU85UUMzbXFWL2hLamY5Y211dHp1YTROdERCZTN6K0Yzd1c1aApvQlh0LzZLNHZXY0lUVENnd2VGSTRra05mOUlKa3VNdElxVm81bmVJMzhZSVRQeXRZNUY0Q1Y3UUxpbVRpbXd0Ci90Zk5GR0t1cEk2WjRLdEtEYUhwVG4zL1V1eks2NlBMa1JpbzYyV0FPMkRMSVB3QVI5cU96MFlJd1dvVDM0WjUKM1BvbWNWcDVGazE3eDVSeHBRd1ZkUkZucldnbU01NzZJWEhuc3dJREFRQUJBb0lCQUhMZ0ZYTndhM0FIck0vdwpXWmgxTTQwOUxyaVdvOTdqSFZ1b2NnS2lpeVp0R0JLblNaRFJrMVQyZjdwS3phV3RTKzJIcTloSkxtenJEVmdDClJwRThYZ2JIVDZIaHFwUUZDc2dPRmFkb1pXNTV1aWgxYzlORjhHa0pyY3VrS1pZbzM4M0l1QjlUYU0zZkx1b1QKNEh0dWJSZ0JLalB4enJUKytxWDVVUmxBOUpvSDc2c1hUb1JkYXF5YzR6VXMwcm9LNmVTb3dZeE8ydVN5TmtQcQpkai9reFJ4WTV2djYveHpPOHhVU1dUWndwVit2VUgvbVJiU1hjSjJrKzRvTDB5VmJSLzFpVStPYmpkSWU4UXNOCkhHMjBNSk9zRS9LTVVuVUlSeGxqRGlaM1o4WjVabXIrTUVTV3daOWRkUWlJbm80dSt6UkVaRTcvbnlwQ2lTY0UKOHlBNG9FRUNnWUVBOVpHbHRLdG8yaHRzZXBuWnNwdFVFdEorbXo2a001bEI2SHdpVVd3Q05ZSXpUQzRra2J2MwpXSzVMYXFpaXEwUk5zOHZSbmNXSHlwMHFidTlyOHNUellRUVVvc0luVStReGlLMUd0Uk81cVV4TE9SZzZlSjViClNCM0JoNnVQdVMyUU9qSlNKbU9uWldkUHFrRXJqSW9LWWZhT00wUGIxaUVlUzBWVUVyVWZaVGNDZ1lFQXkrcmgKeDlzM0FnMVk0bkVpVThsbGpDNlZQYk8yQ3pRM3ViWXJlcjhobVFTYkRsQjBHMEhOVE01YWNaSFdNVUdnWWVlagpUbFJCcVQvbFZtOXV3NFBxc1Ezejl4QnB0YmZDVUpqeEVucnJWQkdpeElNeHlGMU85WTh2WVRkZENLa3VVVVE5CnEybnpuNzNMNGdDRDlMcW4yYlFpaEFucHdTamcySytFQ2V4RlQyVUNnWUVBdWJIM2tsV0VKbHBTZjZ0VG1lSW4KZzB3MWZRT3plMmxMRTVpN0FzTWdNSUpTZENyNGNGT3BTU0FUMjRYRjdLanI4U2dSVExNUWFrREswN1NzOXBuRQpTUHFpK0NqRlFJVHdpQ0F2dGNKQ3hTanlRU3gzR3JyMDMrWFFjTjFsQTJ6WEFZc0g0QXUvaThqQnowY1V2V090ClVrTDFhUUxKZkhUeXlZeVZkTWdPQTZVQ2dZQndDcUY5dDFRVkc1SlA4UXVFYis4TXcvZWFUR2prNVE4TlNpdS8KcU03a0RhVElpNm9QNCtyU25ic1NGYWhUcmhSYVZ2VGlyK2JZQU5TWTFtZE1vK25LMkxqSWNrc3kza0cxR1NPMApITGU2bkdvTGdXNVVBZmpGY2FQOXpYYWZzSjFUWjZSZXo3dGRkT0pXVGlReXpuQTFiUVZkK1RobnVuYzRkOCtiCnlDY1pCUUtCZ0ZWcFZacDdjWUxHYlE1dERkL0orZ1BhcFo0TWFYSzluWDFTaktlalhjcVFFSUc3NEYrdkxzdEwKZCs4R3N0VkRzdy8vQ0VNcW9pYXZ1MkVlQ0VQZzF3ZHpDU3pWa2IrZ1FRZXA0cE1LZEhaai9YaysvNVVXTUJzOApkNnNwMWxrTTRqSGhjYkFLU056VTUrTG1NRnk0MzBPZlI2dmxVTFZjNVlaR2hSU0ZCdzdDCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span></span><br></pre></td></tr></table></figure>

<h2 id="cluster-字段"><a href="#cluster-字段" class="headerlink" title="cluster 字段"></a>cluster 字段</h2><p>certificate-authority-data 字段：服务端的 ca 证书，用来验证 kube-apiserver 证书的正确性。<br />当使用 kubectl 发送请求到 kube-apiserver 时，kube-apiserver 会返回通过参数 <code>--tls-cert-file</code> 配置的证书文件，kubectl 通过 kubeconfig 中的 certificate-authority-data 字段来校验 kube-apiserver 返回证书的有效性。<br />当 kubectl 指定了参数 <code>--insecure-skip-tls-verify=true</code>，即可跳过对 kube-apiserver 证书的校验。</p>
<h2 id="users"><a href="#users" class="headerlink" title="users"></a>users</h2><ul>
<li>name：用户名称</li>
<li>client-certificate-data：kubectl 连接 kube-apiserver 时使用的客户端证书，会发送给 kube-apiserver。内容经过 base64 编码。</li>
<li>client-key-data：客户端私钥信息。内容经过 base64 编码。</li>
</ul>
<p>client-certificate-data 对应的为用户的公钥信息，使用命令 <code>echo &#39;xx&#39; | base64 -d &gt; /tmp/client.crt; openssl x509 -in /tmp/client.crt -noout -text</code>可对证书的内容进行解密。解密完成后的证书内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Certificate:</span></span><br><span class="line">    <span class="attr">Data:</span></span><br><span class="line">        <span class="attr">Version:</span> <span class="number">3</span> <span class="string">(0x2)</span></span><br><span class="line">        <span class="attr">Serial Number:</span> <span class="number">2604918601715070594</span> <span class="string">(0x242687aab408b682)</span></span><br><span class="line">        <span class="attr">Signature Algorithm:</span> <span class="string">sha256WithRSAEncryption</span></span><br><span class="line">        <span class="attr">Issuer:</span> <span class="string">CN</span> <span class="string">=</span> <span class="string">kubernetes</span></span><br><span class="line">        <span class="string">Validity</span></span><br><span class="line">            <span class="attr">Not Before:</span> <span class="string">Mar</span> <span class="number">21</span> <span class="number">08</span><span class="string">:36:51</span> <span class="number">2024 </span><span class="string">GMT</span></span><br><span class="line">            <span class="attr">Not After :</span> <span class="string">Mar</span> <span class="number">21</span> <span class="number">08</span><span class="string">:36:52</span> <span class="number">2025 </span><span class="string">GMT</span></span><br><span class="line">        <span class="attr">Subject:</span> <span class="string">O</span> <span class="string">=</span> <span class="string">system:masters,</span> <span class="string">CN</span> <span class="string">=</span> <span class="string">kubernetes-admin</span></span><br><span class="line">        <span class="attr">Subject Public Key Info:</span></span><br><span class="line">            <span class="attr">Public Key Algorithm:</span> <span class="string">rsaEncryption</span></span><br><span class="line">                <span class="attr">Public-Key:</span> <span class="string">(2048</span> <span class="string">bit)</span></span><br><span class="line">                <span class="attr">Modulus:</span></span><br><span class="line">                    <span class="attr">00:a8:c2:94:36:af:ab:2d:c3:8d:2c:26:5c:37:4f:</span></span><br><span class="line">                    <span class="attr">09:d2:27:3c:02:fc:5c:be:26:38:9f:82:12:b8:f4:</span></span><br><span class="line">                    <span class="attr">1e:c9:46:da:1c:a3:19:43:aa:e2:eb:4f:09:56:1e:</span></span><br><span class="line">                    <span class="attr">45:aa:ca:70:ee:98:58:f7:e6:8f:2c:ba:cf:86:89:</span></span><br><span class="line">                    <span class="attr">d7:04:08:4f:bd:e4:48:52:ac:7b:64:d0:5a:f3:79:</span></span><br><span class="line">                    <span class="attr">d4:07:e3:2b:fb:da:fe:93:4d:0d:32:be:34:4a:f1:</span></span><br><span class="line">                    <span class="attr">fd:86:38:0c:b9:84:75:a3:b3:6e:f5:db:3b:63:b4:</span></span><br><span class="line">                    <span class="attr">89:36:ab:a5:ca:9f:52:cd:ce:74:43:70:28:f2:ea:</span></span><br><span class="line">                    <span class="attr">69:48:36:04:12:71:b0:af:85:0f:6e:f6:6d:7b:97:</span></span><br><span class="line">                    <span class="attr">80:cf:a3:a1:09:cf:da:93:a9:dd:88:4a:8e:6b:61:</span></span><br><span class="line">                    <span class="attr">88:1b:c7:91:6b:66:3d:de:10:01:f7:35:af:fd:55:</span></span><br><span class="line">                    <span class="attr">85:34:b1:39:c6:fd:a7:84:aa:c2:01:8c:ce:d2:45:</span></span><br><span class="line">                    <span class="attr">5b:a4:d0:9e:26:2d:43:6a:8e:76:dc:00:d5:8f:c1:</span></span><br><span class="line">                    <span class="attr">41:e0:49:75:53:8f:a8:35:ce:96:f5:3c:10:97:51:</span></span><br><span class="line">                    <span class="attr">d1:22:a7:ab:cf:50:0b:2d:8b:8b:c5:9b:5a:11:c6:</span></span><br><span class="line">                    <span class="attr">f4:6a:6f:3b:81:2a:4a:ae:2c:3e:69:e0:3f:c7:3f:</span></span><br><span class="line">                    <span class="attr">e8:98:23:ca:71:1f:80:d1:13:49:02:a5:95:c2:73:</span></span><br><span class="line">                    <span class="string">bc:09</span></span><br><span class="line">                <span class="attr">Exponent:</span> <span class="number">65537</span> <span class="string">(0x10001)</span></span><br><span class="line">        <span class="attr">X509v3 extensions:</span></span><br><span class="line">            <span class="attr">X509v3 Key Usage:</span> <span class="string">critical</span></span><br><span class="line">                <span class="string">Digital</span> <span class="string">Signature,</span> <span class="string">Key</span> <span class="string">Encipherment</span></span><br><span class="line">            <span class="attr">X509v3 Extended Key Usage:</span></span><br><span class="line">                <span class="string">TLS</span> <span class="string">Web</span> <span class="string">Client</span> <span class="string">Authentication</span></span><br><span class="line">            <span class="attr">X509v3 Basic Constraints:</span> <span class="string">critical</span></span><br><span class="line">                <span class="string">CA:FALSE</span></span><br><span class="line">            <span class="attr">X509v3 Authority Key Identifier:</span></span><br><span class="line">                <span class="string">A9:3F:DD:7F:2D:09:66:9D:24:9E:CC:B8:9D:D0:E0:D0:BF:94:6C:33</span></span><br><span class="line">    <span class="attr">Signature Algorithm:</span> <span class="string">sha256WithRSAEncryption</span></span><br><span class="line">    <span class="attr">Signature Value:</span></span><br><span class="line">        <span class="attr">9f:90:63:5b:b4:c5:a1:b3:ea:64:d8:66:ff:aa:41:39:41:85:</span></span><br><span class="line">        <span class="attr">45:e8:29:a8:96:96:f8:f4:ae:29:35:0d:8f:9c:02:49:57:0c:</span></span><br><span class="line">        <span class="attr">87:b5:9d:7c:09:00:1e:59:1c:e3:d6:9f:7a:1c:d5:7d:ea:50:</span></span><br><span class="line">        <span class="attr">ac:33:c9:36:3a:33:c7:ed:7c:83:a7:e4:32:34:50:b4:74:22:</span></span><br><span class="line">        <span class="attr">a2:b6:be:ac:ee:91:20:06:ee:20:62:63:32:92:53:70:5f:e7:</span></span><br><span class="line">        <span class="attr">37:61:7c:8d:ab:2d:62:4b:c5:ba:bd:e6:bd:47:b0:f2:56:64:</span></span><br><span class="line">        <span class="attr">0d:d1:97:d1:06:52:06:f7:0b:8d:38:28:78:37:c8:28:d8:5c:</span></span><br><span class="line">        <span class="attr">d1:e6:42:77:ed:7e:17:24:57:8f:aa:62:2b:c7:33:01:96:3f:</span></span><br><span class="line">        <span class="attr">33:99:53:ad:17:b9:3d:16:d1:87:32:f2:67:86:66:83:4b:dc:</span></span><br><span class="line">        <span class="attr">f4:57:1d:5b:59:bc:52:08:42:10:d6:45:05:3d:38:63:db:e5:</span></span><br><span class="line">        <span class="attr">b4:52:eb:64:7a:07:15:00:c5:48:91:0b:48:9c:b2:4e:8c:ae:</span></span><br><span class="line">        <span class="attr">e6:06:97:cf:c2:18:46:7e:5c:23:8a:13:39:ec:89:ed:ba:02:</span></span><br><span class="line">        <span class="attr">c6:8c:35:92:e5:a6:82:a9:95:1a:fe:a9:41:b8:c5:9b:78:b4:</span></span><br><span class="line">        <span class="attr">49:ea:90:d8:3f:66:31:18:7c:95:a9:bf:d9:76:e2:62:b6:4f:</span></span><br><span class="line">        <span class="number">70</span><span class="string">:02:19:17</span></span><br></pre></td></tr></table></figure>
<p>其中的 Subject 中的 O 对应的 k8s 中的 Group，CN 对应的 k8s 中的 User。kube-apiserver 会通过证书的 O 和 CN 获取到 User 和 Group 信息。在 k8s 系统中，实际上并没有存储 Group 和 User 信息，而是完全依赖该证书中的信息。</p>
<h1 id="kubeconfig-文件生成"><a href="#kubeconfig-文件生成" class="headerlink" title="kubeconfig 文件生成"></a>kubeconfig 文件生成</h1><p>kubeconfig 文件本质上是个证书，包含了 ca、证书公钥和证书私钥，在有了证书后可以通过 kubectl 命令生成新的 kubeconfig 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig ~/.kube/111111.kubeconfig config set-cluster hello --certificate-authority=/tmp/ca.pem --embed-certs=true --server=https://127.0.0.1:6443</span><br><span class="line">kubectl --kubeconfig ~/.kube/111111.kubeconfig config set-credentials hello-admin --client-certificate=/tmp/tls.crt --client-key=/tmp/tls.key --embed-certs=true</span><br><span class="line">kubectl --kubeconfig ~/.kube/111111.kubeconfig config set-context hello --cluster=hello --user=hello-admin</span><br><span class="line">kubectl --kubeconfig ~/.kube/111111.kubeconfig config use-context hello</span><br></pre></td></tr></table></figure>

<h1 id="使用-curl-命令直接访问-kube-apiserver"><a href="#使用-curl-命令直接访问-kube-apiserver" class="headerlink" title="使用 curl 命令直接访问 kube-apiserver"></a>使用 curl 命令直接访问 kube-apiserver</h1><p>由于 kube-apiserver 开启了双向认证，使用 curl 命令访问 kube-apiserver 时，curl 需要指定证书信息，证书信息可以使用 kubeconfig 中的证书信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WORK_DIR=/tmp</span><br><span class="line">KUBECONFIG=~/.kube/config</span><br><span class="line">CONTEXT=kind-kind</span><br><span class="line">server=`yq eval &#x27;.clusters.[]|select(.name==&quot;&#x27;$CONTEXT&#x27;&quot;)|.cluster.server&#x27; $KUBECONFIG`</span><br><span class="line">yq eval &#x27;.users.[]|select(.name==&quot;&#x27;$CONTEXT&#x27;&quot;)|.user.client-certificate-data&#x27; $KUBECONFIG | base64 --decode &gt; $&#123;WORK_DIR&#125;/client.crt</span><br><span class="line">yq eval &#x27;.users.[]|select(.name==&quot;&#x27;$CONTEXT&#x27;&quot;)|.user.client-key-data&#x27; ~/.kube/config | base64 --decode &gt; $&#123;WORK_DIR&#125;/client.key</span><br><span class="line">yq eval &#x27;.clusters.[]|select(.name==&quot;&#x27;$CONTEXT&#x27;&quot;)|.cluster.certificate-authority-data&#x27; $KUBECONFIG | base64 --decode &gt; $&#123;WORK_DIR&#125;/ca.crt</span><br><span class="line">curl --cert $&#123;WORK_DIR&#125;/client.crt --key $&#123;WORK_DIR&#125;/client.key --cacert $&#123;WORK_DIR&#125;/ca.crt &quot;$server/apis/apiextensions.k8s.io/v1/customresourcedefinitions?limit=500&amp;resourceVersion=0&quot;</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/orchidzjl/p/17306985.html">kubeconfig文件全解析</a></li>
<li><a target="_blank" rel="noopener" href="https://zhangguanzhang.github.io/2018/10/27/create-kubeconfig/#/role-%E5%8F%82%E8%80%83">生成kubeconfig常规的两种方法</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/hexo-giscus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/hexo-giscus/" class="post-title-link" itemprop="url">Hexo 使用 giscus 评论系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-24 11:18:00" itemprop="dateCreated datePublished" datetime="2024-02-24T11:18:00+00:00">2024-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="设置评论系统"><a href="#设置评论系统" class="headerlink" title="设置评论系统"></a>设置评论系统</h1><p>我的博客系统 Hexo 之前使用 Gitment 作为评论：《<a href="/post/gitment">hexo添加gitment评论系统</a>》，后来年久失修，了解了下基于 Github Discussions 的 giscus 用的比较多，我也采用该方案。</p>
<p>在配置 giscus 之间需要满足如下三个条件：</p>
<ol>
<li>该仓库是公开的，否则访客将无法查看 discussion。</li>
<li>giscus app 已安装，否则访客将无法评论和回应。</li>
<li>Discussions 功能已在你的仓库中启用。</li>
</ol>
<h1 id="在-Github-仓库中安装-gitcus"><a href="#在-Github-仓库中安装-gitcus" class="headerlink" title="在 Github 仓库中安装 gitcus"></a>在 Github 仓库中安装 gitcus</h1><p>我这里直接选择了我的 hexo 仓库 kuring&#x2F;kuring.github.io 作为了 git 仓库，因为该仓库本来的用途本来就是博客相关的内容，权限也是 public 的。</p>
<p>接下来安装 Github app giscus，访问 <a target="_blank" rel="noopener" href="https://github.com/apps/giscus%EF%BC%8C%E5%9C%A8%E5%AE%89%E8%A3%85%E6%97%B6%E4%BB%85%E9%80%89%E6%8B%A9%E9%9C%80%E8%A6%81%E7%9A%84">https://github.com/apps/giscus，在安装时仅选择需要的</a> repo 就可以了，不需要所有的 repo 都放开。</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/giscus-install.png"></p>
<h1 id="在-Github-仓库中打开-Discussions-功能"><a href="#在-Github-仓库中打开-Discussions-功能" class="headerlink" title="在 Github 仓库中打开 Discussions 功能"></a>在 Github 仓库中打开 Discussions 功能</h1><p>进入到 Github 项目的 Settings -&gt; General -&gt; Features -&gt; Discussions 即可打开该功能。</p>
<h1 id="获取到-Github-项目相关的-gitcus-配置"><a href="#获取到-Github-项目相关的-gitcus-配置" class="headerlink" title="获取到 Github 项目相关的 gitcus 配置"></a>获取到 Github 项目相关的 gitcus 配置</h1><p>访问页面 <a target="_blank" rel="noopener" href="https://giscus.app/zh-CN%EF%BC%8C%E5%9C%A8%60%E9%85%8D%E7%BD%AE%60%E7%AB%A0%E8%8A%82%E4%B8%AD%E8%AE%BE%E7%BD%AE%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%88%B0%E7%B1%BB%E4%BC%BC%E4%B8%8B%E9%9D%A2%E5%86%85%E5%AE%B9%EF%BC%9A">https://giscus.app/zh-CN，在`配置`章节中设置相关的配置，可以获取到类似下面内容：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;https://giscus.app/client.js&quot;</span><br><span class="line">        data-repo=&quot;kuring/kuring.github.io&quot;</span><br><span class="line">        data-repo-id=&quot;MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=&quot;</span><br><span class="line">        data-category=&quot;Announcements&quot;</span><br><span class="line">        data-category-id=&quot;DIC_kwDOEOr4W84CdeTU&quot;</span><br><span class="line">        data-mapping=&quot;url&quot;</span><br><span class="line">        data-strict=&quot;0&quot;</span><br><span class="line">        data-reactions-enabled=&quot;1&quot;</span><br><span class="line">        data-emit-metadata=&quot;0&quot;</span><br><span class="line">        data-input-position=&quot;bottom&quot;</span><br><span class="line">        data-theme=&quot;preferred_color_scheme&quot;</span><br><span class="line">        data-lang=&quot;zh-CN&quot;</span><br><span class="line">        data-loading=&quot;lazy&quot;</span><br><span class="line">        crossorigin=&quot;anonymous&quot;</span><br><span class="line">        async&gt;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="在-Hexo-中配置-gitcus"><a href="#在-Hexo-中配置-gitcus" class="headerlink" title="在 Hexo 中配置 gitcus"></a>在 Hexo 中配置 gitcus</h1><p>因为 Hexo 我使用的为 Next 主题，我使用了 Next 的插件 <a target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-next-giscus">hexo-next-giscus</a>。</p>
<p>在 Git 仓库目录下执行 <code>npm install hexo-next-giscus</code> 即可安装 giscus。</p>
<p>修改 Git 仓库下的 <code>_config.yml</code> 文件，在最后面增加如下的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">giscus:</span><br><span class="line">  enable: false</span><br><span class="line">  repo: # Github repository name</span><br><span class="line">  repo_id: # Github repository id</span><br><span class="line">  category: # Github discussion category</span><br><span class="line">  category_id: # Github discussion category id</span><br><span class="line">  # Available values: pathname | url | title | og:title</span><br><span class="line">  mapping: pathname</span><br><span class="line">  # Available values: 0 | 1</span><br><span class="line">  reactions_enabled: 1</span><br><span class="line">   # Available values: 0 | 1</span><br><span class="line">  emit_metadata: 1</span><br><span class="line">  # Available values: light | dark | dark_high_contrast | transparent_dark | preferred-color-scheme</span><br><span class="line">  theme: light</span><br><span class="line">  # Available values: en | zh-CN</span><br><span class="line">  lang: en</span><br><span class="line">  # Place the comment box above the comments</span><br><span class="line">  input_position: bottom</span><br><span class="line">  # Load the comments lazily</span><br><span class="line">  loading: lazy</span><br></pre></td></tr></table></figure>

<p>其中很多的字段值来自上个章节获取到的 json 结果。</p>
<p>至此，即完成了整个 gitcus 的配置。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://giscus.app/zh-CN">giscus</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kuring/kuring.github.io/settings">GitHub Discussions 快速入门</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-next-giscus">hexo-next-giscus</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/watch-tv-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/watch-tv-2/" class="post-title-link" itemprop="url">将树莓派 5 打造成 Android TV 电视盒子折腾记 （2）- 遥控器的配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-24 00:41:46" itemprop="dateCreated datePublished" datetime="2024-02-24T00:41:46+00:00">2024-02-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在前序文章中，实现了将树莓派 5 刷成了 Android TV 电视盒子，基本的功能已经完备，本文将来介绍如何使用遥控器来控制 Android TV。</p>
<ul>
<li><a href="http://kuring.me/post/watch-tv/">我要看电视 - 投影仪和电视盒子选型</a></li>
<li><a href="http://kuring.me/post/pi5-1/">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a></li>
</ul>
<p>树莓派的定位是用作小型计算机使用，而作为电视盒子却必须要具备遥控器来控制的功能。要想通过遥控器来控制树莓派有多种方式可供选择，下面列一下我自己尝试过的方案。</p>
<h1 id="使用手机遥控-Android-TV"><a href="#使用手机遥控-Android-TV" class="headerlink" title="使用手机遥控 Android TV"></a>使用手机遥控 Android TV</h1><p>这是最简单成本最低的纯软方案，只要在手机上安装软件就可以来控制 Android TV 了，手机跟 Android TV 在同一个局域网下即可。我使用到了 IOS 上的 App <code>Remote TV</code>，软件免费，但有广告。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-1.png" alt="IMG_2890.PNG"><br />使用上功能完备，比如开关 Android TV 的功能也是完备的。Android TV 的关系操作并非真正的关机，实际上还是在低功耗运行，网络还是可以连接的。也就意味着通过 App 实际上是可以开机的。<br />不方便的地方在于，每次操作需要额外拿起手机打开 App 后才能操作，没有硬件的遥控器来的方便。</p>
<h1 id="使用投影仪的遥控器"><a href="#使用投影仪的遥控器" class="headerlink" title="使用投影仪的遥控器"></a>使用投影仪的遥控器</h1><p>我使用了爱普生的 TZ2800 投影仪作为播放设备，投影仪的 HDMI 已经支持了 HDMI CEC 功能。这里吐槽下传统企业爱普生，在<a target="_blank" rel="noopener" href="https://www.epson.com.cn/Apps/tech_support/SupportProduct.aspx?p=32158">官方产品页面</a>中很难找到关于该款投影仪的 HDMI 是否支持 CEC 的介绍，或者存在某个地方，但总归我找不到。</p>
<p>HDMI CEC（Consumer Electronics Control） 功能可以实现通过 HDMI 连接让多个设备之间相互控制，可以实现同一个遥控器来控制投影仪和 Android TV 的功能：</p>
<ol>
<li>当关闭投影仪的时候也可以关闭 Android TV。</li>
<li>当打开投影仪的时候可以打开 Android TV。</li>
</ol>
<p>要想使用 HDMI CEC 功能，需要在 Android TV 系统中开启相关的功能。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-2.png" alt="IMG_2893.HEIC"><br />下面的界面用来选择 HDMI CEC 的支持接口，只能支持一个 HDMI 接口。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-3.png" alt="IMG_2894.HEIC"></p>
<p>由于跟投影仪共用一个遥控器，功能上还是有所受限。比如音量的大小功能，只能操作投影仪，而不能再设置 Android TV 的音量大小。但绝大多数的功能已经具备。</p>
<h1 id="使用蓝牙遥控器"><a href="#使用蓝牙遥控器" class="headerlink" title="使用蓝牙遥控器"></a>使用蓝牙遥控器</h1><p>家里正巧有个办移动宽带送的电视盒子，该遥控器为蓝牙遥控器。在遥控器的背面正巧有蓝牙配对的方法。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-4.png" alt="IMG_2891.HEIC"><br /><br>打开 Android Tv 系统中的 <code>设置</code> -&gt; <code>系统</code> -&gt; <code>遥控器和手柄</code> 功能。同时按住菜单键和返回键即可蓝牙配对。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-5.png" alt="IMG_2892.HEIC"><br /><br>蓝牙配对成功后，使用过程中功能正常。但发现个致命的缺点：蓝牙会自动断开，而且无法自动连接，下次只能重新配对。我不太确定是否为遥控器的问题，但单这一点已经否定了我使用蓝牙遥控器的方案。</p>
<h1 id="使树莓派设备支持遥控器控制"><a href="#使树莓派设备支持遥控器控制" class="headerlink" title="使树莓派设备支持遥控器控制"></a>使树莓派设备支持遥控器控制</h1><p>树莓派通过 24 个 GPIO 引脚提供了强大的扩展性，可以接入外部硬件设备来接收遥控器的信号。<br />我们来了解下常见的遥控器的实现原理：</p>
<ol>
<li>红外遥控器：最为普遍的遥控器，使用红外线发射信号，接收端需要有对应的红外接收模块。在发射信号时需要对准接收端。</li>
<li>无线遥控器：通常采用了 2.4 GHz 无线频段作为传输介质，接收端需要有可以匹配的设备接收信号，比如很多无线鼠标提供了一个很小的 USB 接收端。</li>
<li>蓝牙遥控器：使用蓝牙技术通讯，而蓝牙技术同样采用了 2.4 GHz 的无线频段，但好处在于很多的设备都支持蓝牙协议，不需要接收端再有一个定制化的硬件。</li>
</ol>
<h2 id="接收红外信号"><a href="#接收红外信号" class="headerlink" title="接收红外信号"></a>接收红外信号</h2><p>我家里正巧有几个废弃的红外遥控器，因此可以作为树莓派的遥控器来使用。剩下的事情首先需要树莓派通过 GPIO 引脚接收到红外信号。<br />在万能的淘宝上，花了几块钱买到了红外接收器和杜邦线（用来连接红外接收头和 GPIO 引脚），杜邦线需要注意为母对母规格。<br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-6.png" alt="image.png"><br /><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-7.png" alt="image.png"></p>
<h2 id="红外接收器连接到树莓派"><a href="#红外接收器连接到树莓派" class="headerlink" title="红外接收器连接到树莓派"></a>红外接收器连接到树莓派</h2><p>在默认情况下，树莓派 GPIO 引脚的功能并未开启。打开 Android TV 系统中的 <code>Raspberry Pi settings</code> -&gt; <code>IR</code> -&gt; <code>Infrared remote</code>开关。可以看到接收信号的为 GPIO 18 引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-8.png" alt="IMG_2887.HEIC"><br /></p>
<p>在红外接收器上包含了三个引脚，依次为：OUT（输出信号）、GND（接地信号）、VCC（工作电压），其中红外接收器的 OUT 引脚对应的 GPIO 18 引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-9.png" alt="image.png"><br /><br>树莓派提供了 3.3V 和 5V 两种工作电压，查看红外信号接收器的工作电压在 2.7V ~ 5.5V 之间，我直接使用了 GPIO 的 5V 的引脚。<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-10.png" alt="image.png"><br />查看树莓派的各个引脚线路图：<br /><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/tv-2-11.png" alt="来源：https://pinout.vvzero.com/" title="来源：https://pinout.vvzero.com/"><br />即可得到红外信号接收器跟 GPIO 引脚的对应关系：</p>
<table>
<thead>
<tr>
<th>红外信号接收器引脚</th>
<th>GPIO 引脚</th>
</tr>
</thead>
<tbody><tr>
<td>OUT</td>
<td>18</td>
</tr>
<tr>
<td>GND</td>
<td>9（就近原则）</td>
</tr>
<tr>
<td>VCC</td>
<td>2（4 和 6 被风扇电源占用）</td>
</tr>
</tbody></table>
<p>在将硬件连接好后就可以启动树莓派了。</p>
<h2 id="遥控器编码配对"><a href="#遥控器编码配对" class="headerlink" title="遥控器编码配对"></a>遥控器编码配对</h2><p>家里可能有多个红外遥控器，那么为什么红外遥控器之间不会出现相互冲突，本来想打开电视，却打开了空调的情况呢？原因是红外遥控器上的每个按键都对应了一个编码，而不同设备的遥控器对应的编码是不同的。电视遥控器发出的开机信号虽然被空调接收到了，但是并不会对该按键的编码做处理，空调也就不会被开机。<br />我从家里随便找了一个红外遥控器也就不可能直接用来控制 Android TV 了，因此需要让 Android TV 可以识别到我的红外遥控器对应的按键编码。<br />要想识别到红外遥控器的编码，需要使用到 Android TV 系统中命令行工具 <code>ir-keytable</code>，需要以 ssh 的方式连接 Android TV。Android TV 的连接方式可以参考我之前文章《<a href="http://kuring.me/post/pi5-1/">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a>》中的 SSH 章节部分。</p>
<p>在命令行执行 <code>ir-keytable -p all -t</code>，并按下遥控器的按键，在命令行中可以获取到类似如下的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">991.988018: lirc protocol(necx): scancode = 0x835590</span><br><span class="line">991.988023: event type EV_MSC(0x04): scancode = 0x835590</span><br><span class="line">991.988023: event type EV_SYN(0x00).</span><br><span class="line"></span><br><span class="line">992.104019: lirc protocol(necx): scancode = 0x835590</span><br><span class="line">992.104025: event type EV_MSC(0x04): scancode = 0x835590</span><br><span class="line">992.104025: event type EV_SYN(0x00).</span><br></pre></td></tr></table></figure>
<p>其中 916.968014 表示的事件发生的时间戳。necx 表示使用的为 NEC 扩展协议，NEC 为一种常见的红外编码协议。而 scancode 字段即为我们需要获取的按键编码。EV_SYN 表示一组时间的结束。<br />在上面的命令中，按下遥控器的按键一次，发送出了两个相同信号，也就打印出了两个相同日志块。</p>
<p>打开 Github 项目：<a target="_blank" rel="noopener" href="https://github.com/lineage-rpi/android_external_ir-keytable/tree/lineage-18.1/rc_keymaps">https://github.com/lineage-rpi/android_external_ir-keytable&#x2F;tree&#x2F;lineage-18.1&#x2F;rc_keymaps</a>，可以看到里面有很多编码跟对应键之间的映射关系，因为我的红外遥控器没有数字键，我挑选了一个跟遥控器键比较相似的文件进行重新修改，将其中的编码修改我遥控器对应的编码，并保存到本地文件 rc_keymap.txt 中。我的文件类似如下，其中 KEY_PREVIOUSSONG 和 KEY_PLAYPAUSE 两个按键我的遥控器上没有，我这里未做修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># table allwinner_ba10_tv_box, type: NEC</span><br><span class="line">0x646dca KEY_UP</span><br><span class="line">0x646d81 KEY_VOLUMEDOWN</span><br><span class="line">0x217 KEY_NEXTSONG</span><br><span class="line">0x646ddc KEY_POWER</span><br><span class="line">0x646dc5 KEY_BACK</span><br><span class="line">0x646dce KEY_OK</span><br><span class="line">0x646dd2 KEY_DOWN</span><br><span class="line">0x646d80 KEY_VOLUMEUP</span><br><span class="line">0x254 KEY_PREVIOUSSONG</span><br><span class="line">0x255 KEY_PLAYPAUSE</span><br><span class="line">0x646d82 KEY_MENU</span><br><span class="line">0x646d88 KEY_HOMEPAGE</span><br><span class="line">0x646dc1 KEY_RIGHT</span><br><span class="line">0x646d99 KEY_LEFT</span><br></pre></td></tr></table></figure>
<p>需要注意的是，第一行看似是个注释，实际不是，不要删掉，保留原文件中的格式不变。</p>
<h2 id="Android-TV-系统开机时加载配置"><a href="#Android-TV-系统开机时加载配置" class="headerlink" title="Android TV 系统开机时加载配置"></a>Android TV 系统开机时加载配置</h2><p>有了遥控器按键和编码之间的映射关系后，需要将其放到 Android TV 系统的 <code>/boot/rc_keymap.txt</code> 文件中，让 Android TV 开启自动加载该配置。该文件默认情况下不存在需要创建。</p>
<p>分区 &#x2F;boot 默认为只读模式，不允许在其中增加文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127|:/boot # echo &quot;123&quot; &gt; aa</span><br><span class="line">sh: can&#x27;t create aa: Read-only file system</span><br></pre></td></tr></table></figure>

<p>将 &#x2F;boot 目录重新 mount 为读写模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mount  | grep &#x27;/boot &#x27;</span><br><span class="line">/dev/block/mmcblk0p1 on /boot type vfat (ro,relatime,fmask=0000,dmask=0000,allow_utime=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro)</span><br><span class="line"></span><br><span class="line">$ mount -o remount,rw /boot</span><br><span class="line"></span><br><span class="line">$ mount  | grep &#x27;/boot &#x27;</span><br><span class="line">/dev/block/mmcblk0p1 on /boot type vfat (rw,relatime,fmask=0000,dmask=0000,allow_utime=0022,codepage=437,iocharset=ascii,shortname=mixed,errors=remount-ro)</span><br></pre></td></tr></table></figure>

<p>创建并将配置写入到文件 &#x2F;boot&#x2F;rc_keymap.txt 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt; /boot/rc_keymap.txt</span><br><span class="line"># table allwinner_ba10_tv_box, type: NEC</span><br><span class="line">0x646dca KEY_UP</span><br><span class="line">0x646d81 KEY_VOLUMEDOWN</span><br><span class="line">0x217 KEY_NEXTSONG</span><br><span class="line">0x646ddc KEY_POWER</span><br><span class="line">0x646dc5 KEY_BACK</span><br><span class="line">0x646dce KEY_OK</span><br><span class="line">0x646dd2 KEY_DOWN</span><br><span class="line">0x646d80 KEY_VOLUMEUP</span><br><span class="line">0x254 KEY_PREVIOUSSONG</span><br><span class="line">0x255 KEY_PLAYPAUSE</span><br><span class="line">0x646d82 KEY_MENU</span><br><span class="line">0x646d88 KEY_HOMEPAGE</span><br><span class="line">0x646dc1 KEY_RIGHT</span><br><span class="line">0x646d99 KEY_LEFT</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>重新将 &#x2F;boot 分区挂载为只读模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount,ro /boot</span><br></pre></td></tr></table></figure>

<p>在执行完后，重新启动系统。在顺利的情况下，即可以通过红外遥控器直接操作 Android TV 系统。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到目前为止，我主要在使用的方式为红外遥控器模式，毕竟一个电视盒子还是应该有属于自己的遥控器。Good Luck！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/numa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/numa/" class="post-title-link" itemprop="url">numa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-21 18:04:26" itemprop="dateCreated datePublished" datetime="2024-02-21T18:04:26+00:00">2024-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>随着处理器数量的增加，所有的处理器均通过同一个北桥来访问内存，导致内存访问延迟增加，内存带宽成为瓶颈。</p>
<p>NUMA（Non-Uniform Memory Access）非统一内存访问，是一种针对多处理器系统的组织结构。处理器被分配到不同的节点，每个节点有自己的本地内存，处理器可以访问本地内存和其他节点的内存，但访问本地内存的速度要远远快于访问其他节点的内存。</p>
<p>几个概念：</p>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/images/numa.jpg"></p>
<ol>
<li>Socket：一颗物理 CPU。</li>
<li>Numa Node：逻辑概念，对 CPU 分组的抽象，一个 Node 即为一个分组，一个分组下可以包含多个 CPU。每个 Node 都有自己的本地资源，包括内存和 IO。Numa Node 之间不共享 L3 cache。一个 Numa Node 内的不同 core 之间共享 L3.</li>
<li>Core：一颗物理 CPU 的物理核，每个 Core 有独立的 L1 和 L2，Core 之间共享 L3。</li>
<li>Thread&#x2F;Processor：一颗物理 CPU 的逻辑核，用超线程的方式模拟出两个逻辑核。Processor 之间共享 L1 和 L2 cache，在开启超线程后单核的性能会下降一些。</li>
</ol>
<p>一个 NUMA Node 可以有一个 Socket，每个 Socket 包含一个或者多个物理 Core。</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p>查看物理核数 Socket：<code>lscpu | grep Socket</code><br>每个 Socket 包含的物理核 Core：<code>lscpu  | grep &#39;Core(s) per socket&#39;</code><br>每个 Socket 包含的 Thead&#x2F;Processor 数量：<code>lscpu  | grep &#39;Thread(s) per core&#39;</code><br>查看所有的 Processor 数量：<code>cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numactl</span> <span class="string">--hardware</span></span><br><span class="line"><span class="attr">available:</span> <span class="number">4</span> <span class="string">nodes</span> <span class="string">(0-3)</span></span><br><span class="line"><span class="attr">node 0 cpus:</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span></span><br><span class="line"><span class="attr">node 0 size:</span> <span class="number">128470</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 0 free:</span> <span class="number">88204</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 1 cpus:</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">40</span> <span class="number">41</span> <span class="number">42</span> <span class="number">43</span> <span class="number">44</span> <span class="number">45</span> <span class="number">46</span> <span class="number">47</span></span><br><span class="line"><span class="attr">node 1 size:</span> <span class="number">129019</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 1 free:</span> <span class="number">67982</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 2 cpus:</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">48</span> <span class="number">49</span> <span class="number">50</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span> <span class="number">54</span> <span class="number">55</span></span><br><span class="line"><span class="attr">node 2 size:</span> <span class="number">129019</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 2 free:</span> <span class="number">38304</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 3 cpus:</span> <span class="number">24</span> <span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span> <span class="number">31</span> <span class="number">56</span> <span class="number">57</span> <span class="number">58</span> <span class="number">59</span> <span class="number">60</span> <span class="number">61</span> <span class="number">62</span> <span class="number">63</span></span><br><span class="line"><span class="attr">node 3 size:</span> <span class="number">128965</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 3 free:</span> <span class="number">45689</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node distances:</span></span><br><span class="line"><span class="string">node</span>   <span class="number">0</span>   <span class="number">1</span>   <span class="number">2</span>   <span class="number">3</span></span><br><span class="line">  <span class="attr">0:</span>  <span class="number">10</span>  <span class="number">16</span>  <span class="number">28</span>  <span class="number">22</span></span><br><span class="line">  <span class="attr">1:</span>  <span class="number">16</span>  <span class="number">10</span>  <span class="number">22</span>  <span class="number">28</span></span><br><span class="line">  <span class="attr">2:</span>  <span class="number">28</span>  <span class="number">22</span>  <span class="number">10</span>  <span class="number">16</span></span><br><span class="line">  <span class="attr">3:</span>  <span class="number">22</span>  <span class="number">28</span>  <span class="number">16</span>  <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>如果没有开启 numa，默认只会看到一个 node，类似如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numactl</span> <span class="string">--hardware</span></span><br><span class="line"><span class="attr">available:</span> <span class="number">1</span> <span class="string">nodes</span> <span class="string">(0)</span></span><br><span class="line"><span class="attr">node 0 cpus:</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span> <span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">24</span> <span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> <span class="number">33</span> <span class="number">34</span> <span class="number">35</span> <span class="number">36</span> <span class="number">37</span> <span class="number">38</span> <span class="number">39</span> <span class="number">40</span> <span class="number">41</span> <span class="number">42</span> <span class="number">43</span> <span class="number">44</span> <span class="number">45</span> <span class="number">46</span> <span class="number">47</span> <span class="number">48</span> <span class="number">49</span> <span class="number">50</span> <span class="number">51</span> <span class="number">52</span> <span class="number">53</span> <span class="number">54</span> <span class="number">55</span> <span class="number">56</span> <span class="number">57</span> <span class="number">58</span> <span class="number">59</span> <span class="number">60</span> <span class="number">61</span> <span class="number">62</span> <span class="number">63</span></span><br><span class="line"><span class="attr">node 0 size:</span> <span class="number">772904</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node 0 free:</span> <span class="number">510590</span> <span class="string">MB</span></span><br><span class="line"><span class="attr">node distances:</span></span><br><span class="line"><span class="string">node</span>   <span class="number">0</span></span><br><span class="line">  <span class="attr">0:</span>  <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>通过 numastat 命令可以看到 numa 的 miss 等情况，对于排查性能问题非常有帮助。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">numastat</span></span><br><span class="line">                           <span class="string">node0</span>           <span class="string">node1</span>           <span class="string">node2</span>           <span class="string">node3</span></span><br><span class="line"><span class="string">numa_hit</span>              <span class="number">6010986094</span>      <span class="number">3863188690</span>      <span class="number">7861549559</span>      <span class="number">9798877648</span></span><br><span class="line"><span class="string">numa_miss</span>                      <span class="number">0</span>               <span class="number">0</span>       <span class="number">113102530</span>               <span class="number">0</span></span><br><span class="line"><span class="string">numa_foreign</span>                   <span class="number">0</span>               <span class="number">0</span>               <span class="number">0</span>       <span class="number">113102530</span></span><br><span class="line"><span class="string">interleave_hit</span>             <span class="number">17976</span>           <span class="number">17846</span>           <span class="number">17965</span>           <span class="number">17839</span></span><br><span class="line"><span class="string">local_node</span>            <span class="number">6010748681</span>      <span class="number">3862984578</span>      <span class="number">7861301902</span>      <span class="number">9798751537</span></span><br><span class="line"><span class="string">other_node</span>                <span class="number">237411</span>          <span class="number">204112</span>       <span class="number">113350178</span>          <span class="number">126111</span></span><br></pre></td></tr></table></figure>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://ctimbai.github.io/2018/05/03/tech/linux/cpu/CPU%E6%8B%93%E6%89%91%E4%BB%8ESMP%E8%B0%88%E5%88%B0NUMA%EF%BC%88%E7%90%86%E8%AE%BA%E7%AF%87%EF%BC%89/">CPU 拓扑：从 SMP 谈到 NUMA （理论篇）</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/pi5-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="404频道">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 404频道">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/post/pi5-1/" class="post-title-link" itemprop="url">我要看电视 - 将树莓派 5 打造成 Android TV 电视盒子折腾记（1）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-17 11:23:07" itemprop="dateCreated datePublished" datetime="2024-02-17T11:23:07+00:00">2024-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-06-26 15:59:00" itemprop="dateModified" datetime="2024-06-26T15:59:00+00:00">2024-06-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在上一篇文章 《<a href="/post/watch-tv/">我要看电视 - 投影仪和电视盒子选型</a>》中，提到了用树莓派 5 来作为电视盒子，需要刷 Android TV 系统，本文将详细介绍折腾经历。<br>在这之前我并没有接触过树莓派，Android 系统倒是曾经刷过机，但也了解不深。文中如有不正确的地方，欢迎指正。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>要想折腾树莓派，还是需要一点点设备，我使用到的设备清单如下：</p>
<ol>
<li>一台 Mac 笔记本电脑：用来下载镜像、烧录景象、远程连接电视盒子等。其他操作系统的电脑均可。</li>
<li>一个 32G SD 卡：用来作为树莓派的存储系统 RAM。</li>
<li>一个 SD 读卡器：用来读取 SD 卡，供电脑烧录系统使用。</li>
<li>一个 U 盘：该 U 盘并非树莓派的 SD 卡，而是作为树莓派的额外存储，用来向树莓派中复制文件。</li>
<li>一台显示器：用来显示树莓派的内容，也可以是电视或者投影仪等设备。</li>
<li>一个 USB 键盘：用来连接树莓派进行操作。</li>
<li>一个 USB 鼠标：用来连接树莓派进行操作。</li>
<li>一个蓝牙遥控器：用来连接树莓派的 Android TV 系统。我直接使用了家里办宽带送的移动电视盒子的遥控器。</li>
<li>一根 HDMI 数据线：其中一头为 Micro HDMI，用来连接树莓派，另外一头为标准 HDMI 口，用来连接显示器。</li>
</ol>
<p>另外：</p>
<ol>
<li>网络需要能够访问 Google 等网站。</li>
</ol>
<h1 id="寻找-Android-TV-系统"><a href="#寻找-Android-TV-系统" class="headerlink" title="寻找 Android TV 系统"></a>寻找 Android TV 系统</h1><p>找到树莓派对应的 Android TV 镜像是非常重要的前提，找到合适的 ROM 永远是 Android 系统刷机中非常重要的一环，一般每个设备总有那么几个大神在提供各类 ROM。<br>查找一个设备的资源最快的方式就是去 github.com 上查找 awesome，树莓派的项目地址为：<a target="_blank" rel="noopener" href="https://github.com/thibmaek/awesome-raspberry-pi">awesome-raspberry-pi</a>。在 OS Images 章节中包含了支持树莓派的多种 OS，单纯搜索 Android TV 并不能找到对应的 OS，但实际上 <a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi4/">KonstaKANG</a> 对应就是 Android 镜像，这是文档不好的地方，并没有将简介写清楚。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-1.png" alt="image.png"></p>
<p><a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi4/">KonstaKANG</a> 并非一个系统，而是一个网站，包含了多种设备的 OS 镜像。对应的 <a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/">Raspberry 5</a> 的页面包含了 AOSP 和 LineageOS 两种 OS 镜像，AOSP 和 LineageOS 均为 android 的发型版。但只提供了 LineageOS 20 一个 Android TV 的版本，剩下的两个为 Android 版本。Android TV 和 Android 并非同一个系统，Android TV 是针对电视使用的系统，而 Android 是针对智能手机和平板使用的系统，用户体验上还是有较大区别。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-2.png" alt="image.png"><br>因此，<a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/LineageOS20-ATV/">LineageOS 20 Android TV (Android 13) </a>即变为了目前唯一一个可以在树莓派 5 上使用 Android TV 系统，除此之外，别无他选。无论该系统是否完善，这就是目前的唯一选择了。在文章中介绍了非常多的系统方面的支持，建议精读一遍，包括文章后面的评论。<br>文中的两个镜像，一个是原始镜像，另外一个是 ota 补丁包，两个均需要安装。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/konstakang-3.png" alt="image.png"></p>
<h1 id="用到的文件"><a href="#用到的文件" class="headerlink" title="用到的文件"></a>用到的文件</h1><p>由于在国内下载非常不稳定，通常需要魔法下载，我将需要用到的文件上传到云盘供下载使用。我对部分软件的用途一知半解，但我知道安装了应该没有坏处，选择全部安装。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1pgGB_h2bUhq9iUXHrosW9w?pwd=rgad">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv.zip</a> 提取码：rgad</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/15RAKHM2q6pOGSt0a8jfJUg?pwd=3t4m">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv-ota.zip</a> 提取码: 3t4m</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1HWv0P22uAH2eavIycuaf1A?pwd=33wj">MindTheGapps-13.0.0-arm64-ATV-full-20240104_210039.zip</a> 提取码：33wj</li>
<li><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1z0NcAlssVKPwav7RZTIUNg?pwd=c6ja">lineage-20.0-rpi-resize.zip</a> 提取码：c6ja</li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=14871746926876846664#google_vignette">lineage-20.0-rpi-magisk-v25.2.zip</a></li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=11701882489785033173">lineage-20.0-rpi-widevine.zip</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk/releases/tag/v25.2">Magisk-v25.2.apk</a></li>
<li><a target="_blank" rel="noopener" href="https://androidfilehost.com/?fid=11701882489785033172">lineage-20.0-rpi-gsfaid.zip</a></li>
</ul>
<h1 id="刷-LineageOS-到树莓派"><a href="#刷-LineageOS-到树莓派" class="headerlink" title="刷 LineageOS 到树莓派"></a>刷 LineageOS 到树莓派</h1><p>树莓派官方提供了镜像烧录工具 <a target="_blank" rel="noopener" href="https://www.raspberrypi.com/software/">Imager</a>，支持 Windows、Ubuntu、Mac，刷机非常方便。<img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/imager.png" alt="image.png"><br>将树莓派的 SD 插入到电脑，在 <code>Raspberry Pi Device</code> 中选择 <code>RASPBERRY PI 5</code>，在<code>请选择需要写入的操作系统</code>中使用 <code>Use custom</code> 选项选择已经下载好的文件 lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv.zip，选择对应的 SD 卡，再点击 <code>Next</code> 即可开始将镜像写入到SD 卡中。<br>值得一提的是，对于树莓派其他的系统，都不需要事先下载，选择系统后，该工具可以自动下载最新版本，这个功能还是非常值得👍。</p>
<h1 id="LineageOS-初步体验及初步设置"><a href="#LineageOS-初步体验及初步设置" class="headerlink" title="LineageOS 初步体验及初步设置"></a>LineageOS 初步体验及初步设置</h1><p>在将系统刷入 SD 卡后，即可将 SD 卡放到树莓派 5 中，在树莓派中连接好键盘和鼠标。<br>下面步骤中可能会用到键盘的一些快捷键：F1 &#x3D; Home, F2 &#x3D; Back, F3 &#x3D; Multi-tasking, F4 &#x3D; Menu, F5 &#x3D; Power, F11 &#x3D; Volume down, and F12 &#x3D; Volume up<br>开机后即可看到 LineageOS 的开机动画。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-1.png" alt="image.png"></p>
<p>接下来就会看到查找蓝牙设备的界面，这里可以选择等待一会后自动跳过。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-2.png" alt="image.png"></p>
<p>接下来就来到了 Welcome 的界面，点击 <code>Start</code>。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-3.png" alt="image.png"></p>
<p>接下来会进入到选择语言、连接 WIFI 等操作，完成后即可进入到操作系统界面。操作系统界面可谓简洁到不能再精简，只有一个文件的应用。左上角的语音和搜索功能均不能使用。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-4.png" alt="image.png"></p>
<p>但设置功能作为 Android 系统的核心，这部分功能一点都不会少。在设置中连接  Wifi 后发现会持续断开，不知道是否为系统的问题。</p>
<p>打开 Recovery 模式：设置 -&gt; 系统 -&gt; Buttons，打开右侧的 Advanced restart。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-5.png" alt="image.png"></p>
<p>打开开发者模式：设置 -&gt; 系统 -&gt; 关于 -&gt; Android TV 操作系统版本，连续点击键盘的回车键，会提示开发者模式已打开。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-6.png" alt="image.png"></p>
<p>打开 Rooted debug：设置 -&gt; 系统 -&gt; 开发者选项 -&gt; 打开 <code>USB 调试</code>、<code>Rooted debugging</code>、<code>ADB over network</code> 三个选项。</p>
<p>打开树莓派的 SSH 服务：设置 -&gt; 系统 -&gt; Raspberry Pi Settings 中将 SSH 服务打开。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-7.png" alt="image.png"></p>
<h1 id="刷入-ota-包"><a href="#刷入-ota-包" class="headerlink" title="刷入 ota 包"></a>刷入 ota 包</h1><p>接下来选择刷入 OTA 包 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/15RAKHM2q6pOGSt0a8jfJUg?pwd=3t4m">lineage-20.0-20240112-UNOFFICIAL-KonstaKANG-rpi5-atv-ota.zip</a>，ota 包不会用到树莓派镜像烧录器，而是要通过Android Recovery 模式刷入。需要事先准备好 OTA 包，并将其复制到 U 盘中，并将 U 盘插入到树莓派中。</p>
<p>在 Android 系统设置 -&gt; 系统 -&gt; 重新启动中选择 Recovery，此时系统会重启进入到 Recovery 模式。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-1.png" alt="image.png"></p>
<p>点击 <code>Install</code>，并选择右下角的 <code>Select Storage</code> 按钮，选择 USB 存储，即刚插入的 U 盘。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-2.png" alt="image.png"></p>
<p>在 U 盘中选择要刷入的 ota 补丁，取消 <code>Zip signature verification</code>。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-3.png" alt="image.png"></p>
<p>在 <code>Swipe to confirm Flash</code>处向右滑动鼠标，即可进入到安装 ota 补丁的界面。ota 补丁安装完成后，即可自动重启进入到 Android TV 系统中。重新进入系统后，发现系统的界面没有任何变化，不知道该 ota 补丁的具体影响功能。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/ota-4.png" alt="image.png"></p>
<h1 id="系统存储空间设置"><a href="#系统存储空间设置" class="headerlink" title="系统存储空间设置"></a>系统存储空间设置</h1><p>在默认的情况下，打开设置 -&gt; 存储空间，可以看到内部共享存储空间仅为 4.7 GB，这里的存储空间为 &#x2F;data 目录挂载的设备，并没有将 U 盘的空间全部使用起来，U 盘剩余的磁盘空间处于未分配状态。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-8.png" alt="image.png"></p>
<p>这里使用 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1z0NcAlssVKPwav7RZTIUNg?pwd=c6ja">lineage-20.0-rpi-resize.zip</a> 工具来修改存储空间，按照刷入 ota 包相同的方式，进入 Recovery 模式下刷入该包，重新进入系统后即发现存储空间已经变大。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-9.png" alt="image.png"></p>
<h1 id="安装-adb-工具"><a href="#安装-adb-工具" class="headerlink" title="安装 adb 工具"></a>安装 adb 工具</h1><p>前置条件：开发者选项中的 ADB over network 必须为开启状态。</p>
<p>adb 命令需要安装到电脑上，在 mac 下使用 <code>brew install android-platform-tools</code>即可安装完成。</p>
<p>在 android tv 上查看当前的 ip 地址，我这里为 192.168.31.167。执行 <code>adb connect 192.168.31.167</code> 后即可获取到 USB 调试信息，并选中<code>一律允许使用这台计算机进行调试处</code>后点击允许。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-10.png" alt="image.png"><br>此时在终端中即可显示出连接成功的信息：<code>already connected to 192.168.31.167:5555</code>。</p>
<p>在安装完 adb 工具后，即可以通过 adb 命令来远程访问 Android TV 系统了。例如：</p>
<ul>
<li><code>adb install</code> 可以安装 apk 包。</li>
<li><code>adb shell settings list global</code> 命令来查看 Android 系统的所有global 配置。</li>
<li><code>adb logcat</code> 查看 android 的日志。</li>
</ul>
<h1 id="远程-ssh-连接"><a href="#远程-ssh-连接" class="headerlink" title="远程 ssh 连接"></a>远程 ssh 连接</h1><p>前置条件：</p>
<ol>
<li>ssh 连接需要首先在 <code>Raspberry Pi Settings</code> 中的 <code>Remote access</code> 中打开 SSH。</li>
<li><code>adb connect</code> 可以连接到 Android TV。</li>
</ol>
<p>在开启 SSH 服务后，ssh 连接需要使用对应的私钥信息，而私钥信息需要通过 adb 命令获取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb connect 192.168.31.166</span><br><span class="line">adb root</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可查看 /data/ssh 目录下的 ssh 秘钥信息</span></span><br><span class="line">adb shell ls /data/ssh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将秘钥信息放到本地</span></span><br><span class="line">adb pull /data/ssh/ssh_host_ed25519_key ~/.ssh/android_tv.key</span><br><span class="line">chmod 600 ~/.ssh/android_tv.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">成功 ssh 连接</span></span><br><span class="line">ssh -i ~/.ssh/android_tv.key root@192.168.31.166</span><br></pre></td></tr></table></figure>


<h1 id="安装-Google-Apps"><a href="#安装-Google-Apps" class="headerlink" title="安装 Google Apps"></a>安装 Google Apps</h1><blockquote>
<p>注意：此处要求网络具备魔法，可以访问 Google</p>
</blockquote>
<h2 id="刷入-Google-Apps-包"><a href="#刷入-Google-Apps-包" class="headerlink" title="刷入 Google Apps 包"></a>刷入 Google Apps 包</h2><p>Google Apps 包为必须用到的包，通过 Recovery 模式刷入包 <code>MindTheGapps-13.0.0-arm64-ATV-full-20240104_210039.zip</code>。包安装完成后，重新进入系统发现界面发生了变化，多出了应用 Google Play Store，左上角的语音和搜索功能虽然不可以用，但是点击后提示信息已经发生了变化。</p>
<blockquote>
<p>原来的文件应用在这里消失不见了，实际上在所有应用中还可以找到。</p>
</blockquote>
<p><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-11.png" alt="image.png"><br>在系统中使用 Google 账号登录 Google Play Store，即使在可以访问 Google 的网络下，发现也一直会失败。</p>
<h2 id="查询并注册-Android-ID"><a href="#查询并注册-Android-ID" class="headerlink" title="查询并注册 Android ID"></a>查询并注册 Android ID</h2><p>因为该 Android TV 设备并不被信任，需要将 Android ID 在 Android 网站注册。如果不注册，那么 Google 账号登录不成功。<br>将树莓派的 SD 卡插入到笔记本，查看 SD 卡中的文件 gsf-android_id.txt，该文件对应的内容即为 Android ID。<br>还有另外一种办法可以获取到 Android ID，在笔记本上通过 adb 命令查询到当前设备的 Android ID。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adb root</span><br><span class="line"># 找到 google service 的 sqlite3 数据库文件</span><br><span class="line">adb shell &#x27;find /data -name &quot;gservices.db&quot;&#x27;</span><br><span class="line"></span><br><span class="line"># 通过数据库查询到 android id</span><br><span class="line"># 其中 sqlite3 命令后的为上面步骤查询出的文件路径，如果查询出多个，可以任选一个</span><br><span class="line">adb shell &#x27;sqlite3 /data/data/com.google.android.gsf/databases/gservices.db &quot;select * from main where name = \&quot;android_id\&quot;;&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>将上述 Android ID 在网站进行注册，网址：<a target="_blank" rel="noopener" href="https://www.google.com/android/uncertified/">https://www.google.com/android/uncertified/</a><br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-12.png" alt="image.png"></p>
<h2 id="使用-Google-账号登录"><a href="#使用-Google-账号登录" class="headerlink" title="使用 Google 账号登录"></a>使用 Google 账号登录</h2><p>重新进入 Recovery 模式，点击 Wipe -&gt; Factory reset，此时机器会进行重启。该操作会清空系统中的 &#x2F;data&#x2F;media 下的内容。(还不太清楚该步骤是否为必须操作)<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-13.png" alt="image.png"></p>
<p>机器重新后会重新进入一遍系统的初始化，但现在的初始化界面跟最初的 LineageOS 的初始化有所不同，进入到了 GMS 的开机引导，该步骤中必须要登录到 Google 账号，而且无法跳过。如果 Android ID 没有注册，此时登录 Google 账号一直会失败，导致无法进入到系统中。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-14.png" alt="image.png"></p>
<p>登录完成后在首页可以看到了更多的一些信息：<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-15.png" alt="image.png"></p>
<h1 id="通过-Recovery-刷入其他包"><a href="#通过-Recovery-刷入其他包" class="headerlink" title="通过 Recovery 刷入其他包"></a>通过 Recovery 刷入其他包</h1><p>widevine 是在 Android 生态下跟数字版权相关的包，通过 Recovery 模式刷入包 lineage-20.0-rpi-widevine.zip。</p>
<p>通过 Recovery 模式刷入包 lineage-20.0-rpi-magisk-v25.2.zip，进入到 Android TV 系统后通过文件工具安装包 Magisk-v25.2.apk。</p>
<h1 id="解决网络连接受限"><a href="#解决网络连接受限" class="headerlink" title="解决网络连接受限"></a>解决网络连接受限</h1><p>如果本地的网络无法访问 Google，默认情况下，网络会提示<code>网络连接受限</code>，原因主要还是跟访问不了 Google 的域名有关，以至于 Android TV 系统不能识别出可以连接互联网。<br><img src="https://kuring.oss-cn-beijing.aliyuncs.com/raspberry/lineage-16.png" alt="image.png"></p>
<p>网络连接受限状态的 WIFI，经测试机器重启后无法自动连接，需要每次都手工连接 WIFI。</p>
<p>执行如下的命令来系统进行设置：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">adb connect <span class="number">192.168</span>.<span class="number">31.166</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时间服务器</span></span><br><span class="line">adb shell settings put global ntp_server ntp1.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该值默认为 0</span></span><br><span class="line">adb shell settings put global captive_portal_detection_enabled <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认没有这两个值</span></span><br><span class="line">adb shell settings put global captive_portal_https_url https://connect.rom.miui.com/generate_204</span><br></pre></td></tr></table></figure>
<p>设置完成后重启系统，即可看到网络的连接受限已经消除，并且 WIFI 已经可以自动连接了。</p>
<h1 id="常用-apk-软件安装"><a href="#常用-apk-软件安装" class="headerlink" title="常用 apk 软件安装"></a>常用 apk 软件安装</h1><p>我这里使用了 <a target="_blank" rel="noopener" href="https://kxsw.gitbook.io/tv/">https://kxsw.gitbook.io/tv/</a> 中的方法安装了 File Commands 和 Clash 软件。File Commands  可以用来管理本地的文件，甚至可以提供 HTTP Server，供远程来下载或者上传文件。<br>国内的常见应用在 Google Play Store 中并不存在，而且通过 Google Play Store 直接安装应用很可能会失败，跟使用的网络有很大关系。国内的应用我直接使用了当贝市场来安装电视应用即可。</p>
<h1 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h1><h2 id="听不到声音"><a href="#听不到声音" class="headerlink" title="听不到声音"></a>听不到声音</h2><p>在播放视频时发现听不到声音，原因是因为默认情况下使用了 hdmi0 接口来输入声音，通过 hdmi1 只能输出视频信号，没有声音。将 hdmi 线切换到 hdmi0 口后并重启系统后，声音即正常。</p>
<h1 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h1><p>到目前为止，树莓派已经具备了完整的 Android TV 系统的功能，而且使用起来还比较稳定，这一点超出了我的预期，毕竟树莓派 5 比较新，该系统出来的时间比较短。<br>后面我计划使用新的文章来记录使用体验，以及新的折腾经历，比如：如何通过遥控器实现正常的开关机。<br>敬请期待。。。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013120422/article/details/132107317">https://blog.csdn.net/u013120422/article/details/132107317</a></li>
<li><a target="_blank" rel="noopener" href="https://konstakang.com/devices/rpi5/LineageOS20-ATV/">https://konstakang.com/devices/rpi5/LineageOS20-ATV/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kuring/kuring.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkyODM4MzQ0NTk=","category":"Announcements","category_id":"DIC_kwDOEOr4W84CdeTU","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
